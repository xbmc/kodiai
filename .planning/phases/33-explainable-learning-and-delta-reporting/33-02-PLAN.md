---
phase: 33-explainable-learning-and-delta-reporting
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "formatReviewDetailsSummary accepts optional delta and provenance parameters and renders them when present"
    - "Delta summary section shows new, resolved, and still-open counts with resolved finding list"
    - "Provenance section lists retrieved memories with relevance labels inside a collapsible details block"
    - "buildRetrievalContextSection includes a provenance citation instruction when retrieval context is non-empty"
    - "Existing Review Details format is preserved when delta and provenance are not provided (backward compatible)"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Extended formatReviewDetailsSummary with delta summary and provenance sections"
      contains: "Delta Summary"
    - path: "src/execution/review-prompt.ts"
      provides: "Enhanced buildRetrievalContextSection with provenance citation instruction"
      contains: "Prior pattern"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for provenance citation instruction in retrieval context section"
      min_lines: 10
  key_links:
    - from: "src/handlers/review.ts"
      to: "formatReviewDetailsSummary"
      via: "optional deltaSummary and provenanceSummary params"
      pattern: "deltaSummary|provenanceSummary"
---

<objective>
Extend the Review Details format to include delta summary and learning provenance sections, and enhance the retrieval context prompt with provenance citation instructions.

Purpose: Builds the formatting layer that renders delta status and provenance data into user-visible Review Details output. Also enriches the LLM prompt to encourage citing prior patterns. This plan modifies the formatting functions (signature extensions) that Plan 33-03 will call with real data from the handler.

Output: Extended `formatReviewDetailsSummary` in review.ts, enhanced `buildRetrievalContextSection` in review-prompt.ts, tests for the prompt enhancement.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-explainable-learning-and-delta-reporting/33-RESEARCH.md
@src/handlers/review.ts
@src/execution/review-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend formatReviewDetailsSummary with delta and provenance sections</name>
  <files>src/handlers/review.ts</files>
  <action>
Extend the `formatReviewDetailsSummary` function in `src/handlers/review.ts` to accept two new OPTIONAL parameters:

1. **`deltaSummary`** (optional):
   ```typescript
   deltaSummary?: {
     counts: { new: number; resolved: number; stillOpen: number };
     resolved: Array<{ filePath: string; title: string; severity: string; category: string }>;
     suppressedStillOpen: number; // dedup-suppressed findings counted as still-open
   };
   ```

2. **`provenanceSummary`** (optional):
   ```typescript
   provenanceSummary?: {
     findings: Array<{
       findingText: string;
       severity: string;
       category: string;
       outcome: string;
       distance: number;
       sourceRepo: string;
     }>;
   };
   ```

**Delta Summary section** (inserted after the existing metrics, before `</details>`):
- Only render when `deltaSummary` is provided.
- Format:
  ```

  ### Delta Summary

  - **New findings:** N
  - **Resolved findings:** N
  - **Still open:** N (M suppressed to avoid duplicate comments)

  Resolved findings were present in the prior review but not flagged in the current run.

  Resolved:
  - [severity/category] title (filePath)
  - ...
  ```
- Cap the resolved list at 10 entries. If more, add `- ...(N more resolved findings omitted)`.
- If `suppressedStillOpen` is 0, omit the parenthetical from "Still open: N".
- If resolved list is empty, omit the "Resolved:" section and the disclaimer line.

**Provenance section** (inserted as a new collapsible `<details>` block after the main Review Details block, before the low-confidence block):
- Only render when `provenanceSummary` is provided and has findings.
- Format:
  ```

  <details>
  <summary>Learning Provenance</summary>

  This review was informed by N prior pattern(s):

  - [severity/category] "findingText" (source: sourceRepo, outcome: outcome, relevanceLabel)
  - ...

  </details>
  ```
- Relevance label: distance <= 0.15 = "high relevance", <= 0.25 = "moderate relevance", else "low relevance".
- Truncate `findingText` to 100 characters (append "..." if truncated).
- Cap entries at the number provided (bounded by retrieval topK which is already 5 max).

**Backward compatibility:** When neither parameter is provided, the output MUST be identical to the current format. No changes to existing test expectations.
  </action>
  <verify>
`bunx tsc --noEmit` -- no type errors.
`bun test` -- all existing tests pass (backward compatible).
  </verify>
  <done>
formatReviewDetailsSummary accepts optional delta and provenance params, renders delta summary and provenance sections when provided, and produces identical output when omitted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance buildRetrievalContextSection with provenance citation instruction</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
Modify `buildRetrievalContextSection` in `src/execution/review-prompt.ts` to add a provenance citation instruction paragraph after the existing introduction paragraph.

Add these lines after the "Do NOT copy prior findings" instruction:

```
"",
"When a finding in your review directly relates to one of these prior patterns,",
"append a brief provenance note at the end of your comment:",
"`(Prior pattern: [brief description of the similar prior finding])`",
```

This instruction is advisory (not enforced). The deterministic provenance in Review Details is the authoritative source.

**Tests** in `src/execution/review-prompt.test.ts`:
- Add a test: "buildRetrievalContextSection includes provenance citation instruction when findings present"
  - Call with one finding, assert output contains "Prior pattern:" text.
- Add a test: "buildRetrievalContextSection returns empty string when no findings" (may already exist, verify).

Ensure the maxChars budget accounts for the added instruction text. The instruction text is part of the header lines before the per-finding loop, so it should be included in the `currentLength` calculation.
  </action>
  <verify>
`bun test src/execution/review-prompt.test.ts` -- all tests pass including new ones.
`bunx tsc --noEmit` -- no type errors.
  </verify>
  <done>
buildRetrievalContextSection includes provenance citation instruction. Tests verify the instruction is present when findings exist and absent when no findings.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes all tests (existing + new)
- `bunx tsc --noEmit` compiles without errors
- formatReviewDetailsSummary backward compatible (existing callers without new params produce same output)
- Delta summary renders with correct counts and resolved list
- Provenance section renders with relevance labels and truncated finding text
- buildRetrievalContextSection includes "Prior pattern:" citation instruction
</verification>

<success_criteria>
- Review Details comment includes delta summary section when delta data provided
- Review Details comment includes provenance section when retrieval data provided
- Both sections omitted when data not provided (backward compatible)
- LLM prompt includes provenance citation instruction
- All existing tests unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/33-explainable-learning-and-delta-reporting/33-02-SUMMARY.md`
</output>
