---
phase: 93-language-aware-retrieval-boosting
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/knowledge/wiki-chunker.ts
  - src/knowledge/wiki-chunker.test.ts
  - src/knowledge/wiki-types.ts
  - src/knowledge/wiki-store.ts
  - src/knowledge/wiki-store.test.ts
autonomous: true
requirements: [LANG-05]

must_haves:
  truths:
    - "Wiki page chunks carry language affinity tags determined by content analysis"
    - "Non-code wiki pages are tagged as 'general'"
    - "Pages with multiple code languages get multiple tags"
    - "Language tags are re-analyzed on every re-ingest via replacePageChunks"
  artifacts:
    - path: "src/knowledge/wiki-chunker.ts"
      provides: "Language affinity detection from wiki content"
      contains: "detectLanguageTags"
    - path: "src/knowledge/wiki-types.ts"
      provides: "languageTags field on WikiPageChunk and WikiPageRecord"
      contains: "languageTags"
    - path: "src/knowledge/wiki-store.ts"
      provides: "Read/write language_tags column"
      contains: "language_tags"
  key_links:
    - from: "src/knowledge/wiki-chunker.ts"
      to: "src/knowledge/wiki-types.ts"
      via: "WikiPageChunk type"
      pattern: "languageTags"
    - from: "src/knowledge/wiki-store.ts"
      to: "wiki_pages table"
      via: "SQL INSERT"
      pattern: "language_tags"
---

<objective>
Add language affinity tag detection to wiki page chunking and wire it through the wiki store for persistence.

Purpose: Wiki pages carry language metadata so language-filtered retrieval spans all three corpora (LANG-05).
Output: detectLanguageTags function, updated WikiPageChunk/WikiPageRecord types, wiki-store writes language_tags.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
@/home/keith/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/93-language-aware-retrieval-boosting/93-CONTEXT.md
@.planning/phases/93-language-aware-retrieval-boosting/93-RESEARCH.md

@src/knowledge/wiki-types.ts
@src/knowledge/wiki-chunker.ts
@src/knowledge/wiki-store.ts

<interfaces>
<!-- Key types the executor needs -->

From src/knowledge/wiki-types.ts:
```typescript
export type WikiPageChunk = {
  pageId: number;
  pageTitle: string;
  namespace: string;
  pageUrl: string;
  sectionHeading?: string | null;
  sectionAnchor?: string | null;
  sectionLevel?: number | null;
  chunkIndex: number;
  chunkText: string;
  rawText: string;
  tokenCount: number;
  lastModified?: Date | null;
  revisionId?: number | null;
  embedding?: Float32Array | null;
};

export type WikiPageRecord = {
  id: number;
  createdAt: string;
  pageId: number;
  pageTitle: string;
  namespace: string;
  pageUrl: string;
  sectionHeading: string | null;
  sectionAnchor: string | null;
  sectionLevel: number | null;
  chunkIndex: number;
  chunkText: string;
  rawText: string;
  tokenCount: number;
  embedding: unknown;
  embeddingModel: string | null;
  stale: boolean;
  lastModified: string | null;
  revisionId: number | null;
  deleted: boolean;
};

export type WikiPageStore = {
  writeChunks(chunks: WikiPageChunk[]): Promise<void>;
  replacePageChunks(pageId: number, chunks: WikiPageChunk[]): Promise<void>;
  // ...
};
```

From src/knowledge/wiki-chunker.ts:
```typescript
// Exports chunkWikiPage(input: WikiPageInput): WikiPageChunk[]
// Converts HTML to sections, splits into token-bounded chunks
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language tag detection to wiki chunker</name>
  <files>src/knowledge/wiki-chunker.ts, src/knowledge/wiki-chunker.test.ts</files>
  <action>
TDD approach — write tests first, then implement.

**Tests to add in wiki-chunker.test.ts:**

1. `detectLanguageTags` returns `["python"]` for content containing ` ```python\ncode\n``` `
2. `detectLanguageTags` returns `["cpp", "c"]` for content with both ` ```c\n ` and ` ```cpp\n `
3. `detectLanguageTags` returns `["general"]` for content with no code blocks or language references
4. `detectLanguageTags` returns `["typescript"]` for content mentioning "TypeScript API" or "TypeScript implementation" without code blocks
5. `detectLanguageTags` returns `["python", "javascript"]` for content with both ` ```python ` and ` ```javascript ` code blocks
6. `detectLanguageTags` normalizes fenced code block language names: `py` -> `python`, `js` -> `javascript`, `ts` -> `typescript`
7. `chunkWikiPage` output includes `languageTags` field on each chunk (all chunks from same page get same tags, since tags are page-level)

**Implementation:**

1. Export `detectLanguageTags(rawText: string): string[]`:

```typescript
const CODE_BLOCK_LANG_ALIASES: Record<string, string> = {
  py: "python", python: "python", python3: "python",
  js: "javascript", javascript: "javascript", node: "javascript",
  ts: "typescript", typescript: "typescript",
  cpp: "cpp", "c++": "cpp", cxx: "cpp",
  c: "c",
  rb: "ruby", ruby: "ruby",
  rs: "rust", rust: "rust",
  go: "go", golang: "go",
  java: "java",
  kt: "kotlin", kotlin: "kotlin",
  swift: "swift",
  cs: "csharp", csharp: "csharp",
  php: "php",
  sh: "shell", bash: "shell", zsh: "shell",
  sql: "sql",
  lua: "lua",
  dart: "dart",
  ex: "elixir", elixir: "elixir",
  zig: "zig",
  scala: "scala",
  r: "r",
  // Add more as needed
};
```

Detection strategy:
a. Scan for fenced code blocks: match ` ```(\w+) ` patterns, map via CODE_BLOCK_LANG_ALIASES
b. Scan for explicit language mentions: patterns like "Python API", "C++ implementation", "TypeScript code", "written in Rust" (case-insensitive). Use a curated list of language names to match against.
c. If no languages detected, return `["general"]`
d. Return sorted, deduplicated array of lowercase language names

2. Update `chunkWikiPage` to call `detectLanguageTags` on the full rawText of the page (before chunking) and set `languageTags` on each chunk.

**IMPORTANT:** Language tags are determined at the PAGE level (entire content), not per-chunk. All chunks from the same page get the same tags. This is because a wiki page about "Python API reference" should tag all chunks as Python, even if some chunks don't contain code blocks.
  </action>
  <verify>
    <automated>npx vitest run src/knowledge/wiki-chunker.test.ts --reporter=verbose 2>&1 | tail -20</automated>
  </verify>
  <done>detectLanguageTags function exported, correctly identifies languages from code blocks and mentions, returns ["general"] for non-code content, chunkWikiPage sets languageTags on all chunks, all tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Add languageTags to wiki types and store</name>
  <files>src/knowledge/wiki-types.ts, src/knowledge/wiki-store.ts, src/knowledge/wiki-store.test.ts</files>
  <action>
1. In `src/knowledge/wiki-types.ts`:
   - Add `languageTags?: string[]` to `WikiPageChunk` type
   - Add `languageTags: string[]` to `WikiPageRecord` type

2. In `src/knowledge/wiki-store.ts`:
   - Add `language_tags` to `WikiRow` type as `string[]`
   - Update `rowToRecord` to include `languageTags: row.language_tags ?? []`
   - Update `writeChunks` INSERT to include `language_tags` column: `${chunk.languageTags ?? ['general']}`
   - Update `replacePageChunks` INSERT to include `language_tags` column
   - PostgreSQL array syntax: use `${sql.array(chunk.languageTags ?? ['general'])}` or postgres.js array handling

3. Update `wiki-store.test.ts`:
   - Add test that writeChunks stores language_tags
   - Add test that searchByEmbedding returns language_tags in results
   - Add test that replacePageChunks replaces language_tags

**Note on postgres.js array handling:** The postgres.js library handles JavaScript arrays natively for PostgreSQL array columns. Use `${chunk.languageTags ?? []}` directly in the template literal — it will be converted to `'{tag1,tag2}'` format automatically. If this doesn't work, use `sql.array()`.
  </action>
  <verify>
    <automated>npx vitest run src/knowledge/wiki-store.test.ts --reporter=verbose 2>&1 | tail -20</automated>
  </verify>
  <done>WikiPageChunk and WikiPageRecord include languageTags, wiki-store reads/writes language_tags column, replacePageChunks updates tags on re-ingest, all tests pass</done>
</task>

</tasks>

<verification>
- detectLanguageTags returns correct tags for code-block content
- detectLanguageTags returns ["general"] for non-code content
- All wiki chunks from chunkWikiPage have languageTags populated
- wiki-store persists and retrieves language_tags from database
- replacePageChunks re-analyzes tags (new tags stored, old tags replaced)
</verification>

<success_criteria>
- Wiki pages are tagged with language affinity at ingest time
- Non-code pages explicitly tagged as "general"
- Multiple language tags per page supported
- Tags re-analyzed on re-ingest
- All existing wiki tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/93-language-aware-retrieval-boosting/93-02-SUMMARY.md`
</output>
