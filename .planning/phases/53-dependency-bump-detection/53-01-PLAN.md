---
phase: 53-dependency-bump-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/dep-bump-detector.ts
  - src/lib/dep-bump-detector.test.ts
autonomous: true

must_haves:
  truths:
    - "detectDepBump returns non-null for Dependabot PRs with title + bot sender signals"
    - "detectDepBump returns non-null for Renovate PRs with title + branch prefix signals"
    - "detectDepBump returns null for human PRs with bump-like titles but no second signal"
    - "extractDepBumpDetails extracts package name, old version, new version, and ecosystem from title + branch"
    - "extractDepBumpDetails marks group bumps as isGroup: true without per-package extraction"
    - "classifyDepBump returns major/minor/patch for valid semver pairs and unknown for unparseable versions"
    - "Non-dependency PRs produce null from detectDepBump with negligible overhead"
  artifacts:
    - path: "src/lib/dep-bump-detector.ts"
      provides: "Three-stage pipeline: detectDepBump, extractDepBumpDetails, classifyDepBump"
      exports: ["detectDepBump", "extractDepBumpDetails", "classifyDepBump"]
    - path: "src/lib/dep-bump-detector.test.ts"
      provides: "Comprehensive tests covering all three stages"
      min_lines: 200
  key_links:
    - from: "src/lib/dep-bump-detector.ts"
      to: "detectDepBump"
      via: "Two-signal requirement (title + bot/label/branch)"
      pattern: "signals\\.length >= 2"
---

<objective>
Implement the dependency bump detection pipeline as a pure-function module with three stages: detect (DEP-01), extract (DEP-02), and classify (DEP-03).

Purpose: Enable Kodiai to identify, parse, and classify dependency bump PRs from Dependabot/Renovate so downstream review prompts can provide dependency-aware feedback.
Output: `src/lib/dep-bump-detector.ts` with three exported functions + comprehensive test file.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/53-dependency-bump-detection/53-RESEARCH.md
@src/lib/pr-intent-parser.ts
</context>

<feature>
  <name>Dependency Bump Detection Pipeline</name>
  <files>src/lib/dep-bump-detector.ts, src/lib/dep-bump-detector.test.ts</files>
  <behavior>
    **Stage 1: detectDepBump (DEP-01)**
    Determines if a PR is a dependency bump using two-signal requirement to avoid false positives.

    Signals (need at least 2):
    - Title matches Dependabot pattern: `/^(?:chore\([^)]*\):\s*)?bump\s+\S+\s+from\s+/i`
    - Title matches Renovate pattern: `/^(?:chore\([^)]*\):\s*)?update\s+(?:dependency\s+)?\S+\s+/i`
    - Sender is known bot: `dependabot[bot]`, `renovate[bot]`
    - Branch starts with: `dependabot/` or `renovate/`
    - Labels include: `dependencies`, `renovate`, `security`

    Returns: `{ source: "dependabot" | "renovate" | "unknown", signals: string[] }` or `null`.

    Cases:
    - `("Bump lodash from 4.17.20 to 4.17.21", [], "dependabot/npm_and_yarn/lodash-4.17.21", "dependabot[bot]")` -> `{ source: "dependabot", signals: ["title", "branch", "sender"] }`
    - `("Update dependency typescript to v5.4.0", ["renovate"], "renovate/typescript-5.x", "renovate[bot]")` -> `{ source: "renovate", signals: ["title", "label", "branch", "sender"] }`
    - `("Bump minimum Node version to 20", [], "feature/node-20", "someuser")` -> `null` (only 1 signal: title)
    - `("Fix typo in readme", [], "main", "someuser")` -> `null` (0 signals)
    - `("Bump the react group with 3 updates", ["dependencies"], "dependabot/npm_and_yarn/react-group", "dependabot[bot]")` -> detected (group bump)

    **Stage 2: extractDepBumpDetails (DEP-02)**
    Extracts package name, old version, new version, and ecosystem.

    Inputs: detection result, prTitle, prBody, changedFiles.

    Extraction strategy:
    1. Parse package name + versions from title regex captures
    2. Detect ecosystem from Dependabot branch segment (`dependabot/{ecosystem}/...`) or manifest file names in changedFiles
    3. For group bumps (title contains "group" or "monorepo"): set `isGroup: true`, extract ecosystem only, no per-package detail

    Returns: `{ packageName: string | null, oldVersion: string | null, newVersion: string | null, ecosystem: string | null, isGroup: boolean }`

    Cases:
    - Dependabot title "Bump lodash from 4.17.20 to 4.17.21" + branch "dependabot/npm_and_yarn/lodash-4.17.21" -> `{ packageName: "lodash", oldVersion: "4.17.20", newVersion: "4.17.21", ecosystem: "npm", isGroup: false }`
    - Renovate title "Update dependency typescript to v5.4.0" + changedFiles: ["package.json"] -> `{ packageName: "typescript", oldVersion: null, newVersion: "5.4.0", ecosystem: "npm", isGroup: false }`
    - Renovate title with range "Update dependency typescript from 5.3.0 to v5.4.0" -> `{ packageName: "typescript", oldVersion: "5.3.0", newVersion: "5.4.0", ... }`
    - Group title "Bump the react group with 3 updates" + branch "dependabot/npm_and_yarn/react-group" -> `{ packageName: null, oldVersion: null, newVersion: null, ecosystem: "npm", isGroup: true }`
    - Dependabot branch "dependabot/pip/requests-2.28.0" -> ecosystem: "python"
    - Dependabot branch "dependabot/go_modules/golang.org/x/net-0.10.0" -> ecosystem: "go"

    Ecosystem map from branch segments: `npm_and_yarn`->"npm", `pip`->"python", `go_modules`->"go", `cargo`->"rust", `composer`->"php", `maven`->"java", `gradle`->"java", `nuget`->"dotnet", `bundler`->"ruby", `github_actions`->"github-actions", `docker`->"docker", `terraform`->"terraform"

    Manifest file fallback map: `package.json`/`package-lock.json`/`yarn.lock`/`pnpm-lock.yaml`->"npm", `go.mod`/`go.sum`->"go", `Cargo.toml`/`Cargo.lock`->"rust", `requirements.txt`/`Pipfile`/`pyproject.toml`->"python", `Gemfile`->"ruby", `pom.xml`/`build.gradle`->"java", `composer.json`->"php"

    **Stage 3: classifyDepBump (DEP-03)**
    Classifies version bump as major/minor/patch using hand-rolled semver comparison.

    `parseSemver(version)`:
    - Strip leading `v` (case-insensitive)
    - Strip pre-release/build metadata (split at `-` or `+`, take first part)
    - Split on `.`, parse first 3 parts as integers
    - Return `{ major, minor, patch }` or `null` if unparseable

    `classifyDepBump({ oldVersion, newVersion })`:
    - Returns `{ bumpType: "major" | "minor" | "patch" | "unknown", isBreaking: boolean }`
    - `isBreaking` is `true` only when `bumpType === "major"`
    - If either version is null or unparseable, return `{ bumpType: "unknown", isBreaking: false }`

    Cases:
    - `("1.0.0", "2.0.0")` -> `{ bumpType: "major", isBreaking: true }`
    - `("1.0.0", "1.1.0")` -> `{ bumpType: "minor", isBreaking: false }`
    - `("1.0.0", "1.0.1")` -> `{ bumpType: "patch", isBreaking: false }`
    - `("v1.0.0", "v2.0.0")` -> `{ bumpType: "major", isBreaking: true }` (strips v prefix)
    - `("1.0.0-beta.1", "1.0.0")` -> `{ bumpType: "unknown", isBreaking: false }` (same base)
    - `(null, "1.0.0")` -> `{ bumpType: "unknown", isBreaking: false }`
    - `("not-a-version", "1.0.0")` -> `{ bumpType: "unknown", isBreaking: false }`
    - `("2024.01.15", "2024.02.01")` -> `{ bumpType: "minor", isBreaking: false }` (calver treated as semver)
  </behavior>
  <implementation>
    Create `src/lib/dep-bump-detector.ts` with:

    1. Type definitions at top: `DepBumpDetection`, `DepBumpDetails`, `DepBumpClassification`, `DepBumpContext` (composite of all three)
    2. Constants: `DEPENDABOT_TITLE_RE`, `RENOVATE_TITLE_RE`, `RENOVATE_RANGE_TITLE_RE`, `GROUP_TITLE_RE`, `DEP_BRANCH_PREFIXES`, `DEP_BOT_LOGINS`, `DEP_LABELS`, `DEPENDABOT_ECOSYSTEM_MAP`, `MANIFEST_ECOSYSTEM_MAP`
    3. `detectDepBump(params)` — collect signals, require >= 2, determine source
    4. `extractDepBumpDetails(params)` — parse title with regex, resolve ecosystem from branch then manifest fallback, detect group bumps
    5. `parseSemver(version)` — exported for testing, hand-rolled ~15 lines
    6. `classifyDepBump(params)` — compare parsed semver parts, set isBreaking for major

    Follow the existing code style in `src/lib/pr-intent-parser.ts` — pure functions, comprehensive JSDoc, named exports.

    RED-GREEN-REFACTOR cycle:
    - RED: Write all test cases first covering the cases listed in behavior. Tests MUST fail.
    - GREEN: Implement the three functions to make all tests pass.
    - REFACTOR: Clean up, ensure consistent naming, add JSDoc.
  </implementation>
</feature>

<verification>
- `bun test src/lib/dep-bump-detector.test.ts` passes all tests
- Tests cover: Dependabot title (default + conventional), Renovate title (with/without range), group bumps, false positive rejection (human PR with bump-like title), ecosystem detection from branch and manifest files, semver parsing (clean, v-prefix, pre-release, calver, invalid), classification (major/minor/patch/unknown), null inputs
- No new dependencies added to package.json
</verification>

<success_criteria>
- All three pipeline functions exported and tested
- Two-signal detection prevents false positives on human PRs
- Group bumps detected and marked without per-package extraction
- Semver parser handles v-prefix, pre-release stripping, and unparseable versions gracefully
- Zero impact on non-dependency PRs (null return from detectDepBump)
</success_criteria>

<output>
After completion, create `.planning/phases/53-dependency-bump-detection/53-01-SUMMARY.md`
</output>
