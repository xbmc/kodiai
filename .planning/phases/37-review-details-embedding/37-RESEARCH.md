# Phase 37: Review Details Embedding - Research

**Researched:** 2026-02-13
**Domain:** Review output restructuring / deterministic comment composition / GitHub Markdown rendering
**Confidence:** HIGH

## Summary

Phase 37 moves the "Review Details" section from a standalone GitHub comment into the summary comment as a collapsible `<details>` appendix at the bottom. Currently, the review handler produces two separate comments on every PR: (1) a Claude-generated "Kodiai Review Summary" comment posted via the MCP comment server, and (2) a deterministic "Review Details" comment produced by `formatReviewDetailsSummary()` in `review.ts` and posted via `upsertReviewDetailsComment()`. Phase 37 merges these into a single comment, removes the time-saved metric, and simplifies the Review Details content to four factual lines: files reviewed, lines changed (+/-), findings by severity, and review timestamp.

The implementation touches three areas: (1) `review.ts` -- refactor `formatReviewDetailsSummary()` to produce the new minimal format per FORMAT-13, then change the posting flow so the Review Details block is appended to the summary comment body instead of being posted as a standalone comment; (2) the prompt in `review-prompt.ts` -- remove the `buildMetricsInstructions()` section that currently tells Claude to include a "Review Details" section (since it will be appended deterministically, not generated by Claude); and (3) `comment-server.ts` -- update the sanitizer to accept or ignore the appended Review Details block at the bottom of the summary comment. Additionally, the `upsertReviewDetailsComment()` function and its caller must be changed so that when a summary comment exists, Review Details is embedded within it, and when no summary comment is posted (clean review / auto-approve), Review Details is still posted as a standalone comment to maintain metrics visibility.

**Primary recommendation:** Refactor `formatReviewDetailsSummary()` to produce a minimal 4-line block per FORMAT-13 (no time-saved metric), then modify the review handler to append this block to the summary comment body before posting. Remove the standalone `upsertReviewDetailsComment()` call when a summary comment is posted. Keep the standalone path as a fallback for when no summary comment is created (clean reviews). Remove `buildMetricsInstructions()` from the prompt since Review Details is now deterministic-only.

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| (none new) | -- | -- | All existing deps are sufficient |

This phase requires zero new dependencies. The implementation modifies:

- `src/handlers/review.ts` -- `formatReviewDetailsSummary()`, `upsertReviewDetailsComment()`, and the review handler's post-execution flow
- `src/execution/review-prompt.ts` -- remove `buildMetricsInstructions()` and its invocation
- `src/execution/mcp/comment-server.ts` -- sanitizer adjustment to allow the appended `<details>` block

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| bun:test | existing | Test framework | For all new and updated tests |

### Alternatives Considered

None -- this phase is purely about restructuring the comment posting flow and simplifying the format. No new libraries or architectural patterns are needed.

## Architecture Patterns

### Current Two-Comment Output Model (Must Understand)

The review handler currently produces TWO separate GitHub comments:

```
1. SUMMARY COMMENT (Claude-generated, conditional):
   - Built by Claude following prompt instructions in buildReviewPrompt()
   - Posted via mcp__github_comment__create_comment tool
   - Validated by sanitizeKodiaiReviewSummary() in comment-server.ts
   - Contains: What Changed, Strengths, Observations, Suggestions, Verdict
   - Only posted when issues are found (no summary on clean reviews)
   - Wrapped in <details><summary>Kodiai Review Summary</summary>...</details>

2. REVIEW DETAILS COMMENT (deterministic, always posted when execution succeeds):
   - Built by formatReviewDetailsSummary() in review.ts
   - Posted via upsertReviewDetailsComment() after execution completes
   - Contains: files reviewed, lines analyzed, lines changed, severity counts,
     suppressions, estimated time saved, time-saved formula, delta summary,
     learning provenance, low-confidence findings
   - Uses its own marker: <!-- kodiai:review-details:{key} -->
   - Posted as its own <details> block with sub-<details> for provenance
     and low-confidence findings
```

### Target Single-Comment Model (Phase 37)

```
1. SUMMARY COMMENT with embedded Review Details (when issues found):
   - Claude generates the five-section template as before
   - AFTER Claude's content, the handler appends a deterministic Review Details block
   - The appended block is a <details> section at the very bottom, inside </details>
     of the outer summary, or after it
   - Review Details marker is included in the combined comment

2. STANDALONE REVIEW DETAILS (when NO issues found / auto-approve path):
   - On clean reviews, no summary comment is posted
   - Review Details is still posted as a standalone comment (preserving metrics visibility)
   - This maintains the current behavior for the auto-approve path
```

### Pattern 1: Post-Processing Injection in Comment Server

**What:** The Review Details block is appended to the summary comment body AFTER Claude generates it but BEFORE it is posted to GitHub. This happens in the `create_comment` handler of `comment-server.ts`.

**Why this approach:** The Review Details content (files reviewed, lines changed, finding counts, timestamp) is computed deterministically by the handler, not by Claude. It should NOT be in the prompt as instructions for Claude to generate. Instead, the handler pre-computes the Review Details block and the comment server appends it when posting the summary comment.

**Implementation approach:**

The `createCommentServer()` function already receives contextual data (owner, repo, reviewOutputKey, prNumber). It needs an additional parameter: the pre-computed Review Details block to append.

```
createCommentServer(
  getOctokit, owner, repo, reviewOutputKey, onPublish, prNumber,
  reviewDetailsBlock?  // NEW: optional pre-computed <details> block
)
```

When `reviewDetailsBlock` is provided and the comment body contains `<summary>Kodiai Review Summary</summary>`, the `create_comment` handler appends the block after sanitization but before posting.

**Alternative approach (simpler):** Instead of passing the block through the comment server, the handler can intercept the summary comment AFTER Claude posts it and UPDATE it with the Review Details appended. This uses `upsertReviewDetailsComment()` modified to find the summary comment (by its marker) and append Review Details to it.

**Recommended approach:** The simpler alternative -- modify `upsertReviewDetailsComment()` to:
1. Find the summary comment (by the review output marker that `maybeStampMarker()` already adds)
2. Append the Review Details `<details>` block to the summary comment body
3. Update the comment via the Octokit REST API

This avoids changing the comment server interface and keeps the Review Details logic entirely in `review.ts`.

### Pattern 2: Simplified Review Details Format (FORMAT-13)

**What:** The Review Details block is reduced to four factual lines plus a timestamp.

**Current format (to be replaced):**
```markdown
<details>
<summary>Review Details</summary>

- Files reviewed: 12
- Lines analyzed: 450
- Lines changed: 450
- Severity counts: critical 1, major 2, medium 0, minor 1
- Suppressions applied: 0
- Estimated review time saved: ~12.5 minutes
- Time-saved formula: (3 min x actionable findings) + (1 min x low-confidence findings) + (0.25 min x files reviewed)

### Delta Summary
...
</details>

<details>
<summary>Learning Provenance</summary>
...
</details>

<details>
<summary>Low Confidence Findings (threshold: 60)</summary>
...
</details>
```

**New format (FORMAT-13):**
```markdown
<details>
<summary>Review Details</summary>

- Files reviewed: 12
- Lines changed: +320 -130
- Findings: 1 critical, 2 major, 0 medium, 1 minor
- Review completed: 2026-02-13T14:30:00Z

</details>
```

**What is removed (FORMAT-12):**
- `Lines analyzed` line (redundant with Lines changed)
- `Suppressions applied` line (internal detail, not useful to PR reviewers)
- `Estimated review time saved` line and calculation
- `Time-saved formula` line
- Delta Summary sub-section (this is Phase 38's concern -- FORMAT-14/15/16)
- Learning Provenance sub-section (internal implementation detail)
- Low Confidence Findings sub-section (internal detail)

**What is changed (FORMAT-13):**
- `Lines changed: 450` becomes `Lines changed: +320 -130` (separate additions/deletions)
- `Severity counts: critical 1, major 2, medium 0, minor 1` becomes `Findings: 1 critical, 2 major, 0 medium, 1 minor`
- New line: `Review completed: [ISO-8601 timestamp]`

**Data sources for new format:**
- Files reviewed: `diffAnalysis.metrics.totalFiles` (already available)
- Lines changed +/-: `diffAnalysis.metrics.totalLinesAdded` and `diffAnalysis.metrics.totalLinesRemoved` (already available)
- Findings by severity: `findingCounts` object (already computed)
- Review completed: `new Date().toISOString()` (trivial)

### Pattern 3: Appending to Existing Summary Comment

**What:** After Claude's execution completes and the summary comment is posted, the handler updates the comment to append Review Details.

**Flow:**

```
1. Claude executes review, posts summary comment via create_comment
2. Handler extracts findings, computes finding counts
3. Handler builds the new minimal Review Details block
4. Handler finds the summary comment (by review output marker)
5. Handler appends Review Details block to the comment body
6. Handler updates the comment via Octokit REST API
```

**Finding the summary comment:** The review output marker (`<!-- kodiai:review-output-key:... -->`) is already stamped on the summary comment by `maybeStampMarker()` in the comment server. The handler can search for comments containing this marker (same pattern as `ensureReviewOutputNotPublished()`).

**Why not embed during Claude's execution:** Claude generates the summary comment content. The Review Details content is computed AFTER Claude finishes (finding counts require extracting and processing findings from Claude's inline comments). The data is not available until after execution.

**Edge case -- no summary comment posted:** When the review is clean (no issues), Claude does not post a summary comment. In this case, the handler posts Review Details as a standalone comment (existing `upsertReviewDetailsComment()` behavior). This maintains metrics visibility on all reviewed PRs.

### Pattern 4: Sanitizer Tolerance for Appended Content

**What:** The sanitizer (`sanitizeKodiaiReviewSummary()`) currently validates the five-section template. The Review Details block is appended AFTER sanitization (since the handler appends it post-hoc by updating the comment). The sanitizer does NOT need to be modified for the append path.

However, if the comment is later updated (e.g., via `update_comment` tool), the sanitizer will see the combined body. The sanitizer should tolerate the `<details><summary>Review Details</summary>...</details>` block after the `</details>` closing tag of the main summary.

**Implementation:** The sanitizer can simply ignore content after the final `</details>` tag of the "Kodiai Review Summary" wrapper. This is already implicitly the case since the sanitizer looks for `## ` headings within the stripped content -- the Review Details block uses `<details>` tags without `## ` headings, so it won't trigger the "unexpected section" error.

**Validation point:** The sanitizer parses the content between `<details>` and `</details>` of the main summary. Content appended after the closing `</details>` is outside the sanitizer's scope. Verify this by testing with a summary comment that has Review Details appended.

### Pattern 5: Prompt Cleanup -- Remove buildMetricsInstructions()

**What:** The current prompt includes a "Review Metrics" section (via `buildMetricsInstructions()`) that tells Claude to include a collapsible "Review Details" section with quantitative metrics. Since Review Details is now deterministic and appended by the handler, this prompt section must be removed.

**Current prompt section (lines 367-378 in review-prompt.ts):**
```
## Review Metrics

Categorize findings consistently by severity so review metrics can be computed from files reviewed, lines changed, and finding counts.
Your response MUST include a collapsible `Review Details` section with quantitative metrics.
The `Review Details` section MUST include:
- Files reviewed (count and key paths)
- Lines analyzed/changed (+/- totals)
- Issue counts grouped by severity (CRITICAL/MAJOR/MEDIUM/MINOR)
```

**Action:** Delete `buildMetricsInstructions()` and remove the `lines.push("", buildMetricsInstructions());` call at line 956. Claude should NOT be instructed to generate Review Details at all.

**Related test cleanup:** Tests that assert on `buildMetricsInstructions` output (review-prompt.test.ts lines 193, 203) must be removed or updated.

### Anti-Patterns to Avoid

- **Anti-pattern: Having Claude generate the Review Details content.** Review Details is deterministic (files, lines, counts, timestamp). It must NOT be generated by Claude -- the handler computes and appends it. Remove all prompt instructions telling Claude to produce metrics.

- **Anti-pattern: Embedding Review Details inside the `<details>` wrapper of the summary.** The summary comment is wrapped in `<details><summary>Kodiai Review Summary</summary>...</details>`. The Review Details `<details>` block should be placed AFTER this closing `</details>` tag (i.e., as a sibling block in the comment body), not nested inside it. Nesting `<details>` inside `<details>` works in GitHub Markdown, but separating them makes the structure cleaner and avoids confusing the sanitizer.

- **Anti-pattern: Removing standalone Review Details posting entirely.** When no summary comment is posted (clean review / auto-approve), Review Details must still be posted as a standalone comment. The embedding only applies when a summary comment exists.

- **Anti-pattern: Including delta summary, provenance, or low-confidence findings in the new format.** FORMAT-13 specifies exactly four data points: files reviewed, lines changed, findings by severity, and timestamp. Delta formatting is Phase 38's scope. Provenance and low-confidence findings are internal implementation details that should not appear in the user-facing Review Details.

- **Anti-pattern: Modifying the comment server's create_comment tool.** The simpler approach is to have the handler update the summary comment after Claude posts it. This avoids threading Review Details data through the MCP server interface and keeps the logic in one place (`review.ts`).

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Finding the summary comment | Custom comment search logic | Reuse pattern from `upsertReviewDetailsComment()` which already searches by marker | Already has the marker-search pattern |
| ISO-8601 timestamp | Custom date formatting | `new Date().toISOString()` | Standard JS, zero dependencies |
| Lines changed +/- format | Parse diff output again | `diffAnalysis.metrics.totalLinesAdded` and `totalLinesRemoved` | Already computed by `analyzeDiff()` |
| Comment update | Custom GitHub API wrapper | `octokit.rest.issues.updateComment()` | Already used throughout the handler |

**Key insight:** All the data needed for the new Review Details format is already computed by the handler. The only new logic is: (a) formatting 4 lines of text, (b) appending them to an existing comment, and (c) choosing between embed-in-summary vs standalone-comment based on whether a summary exists.

## Common Pitfalls

### Pitfall 1: Review Details Not Appearing When No Summary Comment Exists

**What goes wrong:** On clean reviews (no issues found), the summary comment is never posted, so there's nothing to embed Review Details into. If the standalone posting path is removed, Review Details disappears entirely for clean PRs.
**Why it happens:** Over-eagerly removing the standalone posting code.
**How to avoid:** Maintain two code paths: (a) when summary comment was posted (result.published === true), find the summary comment and append Review Details; (b) when no summary was posted, post Review Details as a standalone comment (existing behavior).
**Warning signs:** Clean PRs having no Review Details comment at all.

### Pitfall 2: Race Condition Between Summary Comment and Review Details Append

**What goes wrong:** The handler tries to find and update the summary comment, but the GitHub API hasn't propagated the comment yet (eventual consistency).
**Why it happens:** The summary comment is posted by Claude during execution via the MCP tool. The handler's post-execution code runs immediately after. GitHub's API may have a brief propagation delay.
**How to avoid:** The `upsertReviewDetailsComment()` function already handles this by listing recent comments and searching by marker. If the marker is found, update the comment. If not found, create a new standalone comment. This fallback behavior naturally handles the race condition -- if the summary comment isn't found, Review Details is posted standalone. This is acceptable because the next re-review will find and update properly.
**Warning signs:** Intermittent standalone Review Details comments appearing alongside summary comments. Monitor for this pattern but don't over-engineer a solution unless it becomes frequent.

### Pitfall 3: Sanitizer Rejecting Updated Comment with Appended Review Details

**What goes wrong:** If the summary comment is later updated (e.g., via `update_comment` tool in a mention flow), the sanitizer sees the combined body (summary + Review Details) and rejects it because of unexpected content.
**Why it happens:** The sanitizer validates the five-section template. Review Details appended after `</details>` introduces content the sanitizer didn't expect.
**How to avoid:** Verify that the sanitizer only examines content within the `<summary>Kodiai Review Summary</summary>` scope. Content after the closing `</details>` should be ignored. The sanitizer currently checks for `## ` headings in the full body -- verify this doesn't trigger on Review Details content (it shouldn't, since Review Details uses `<details>` without `## ` headings).
**Warning signs:** Sanitizer errors mentioning "unexpected section" on comments with appended Review Details.

### Pitfall 4: GitHub Markdown Rendering Issues with Sibling Details Blocks

**What goes wrong:** Two consecutive `<details>` blocks in the same comment don't render properly -- one or both collapse incorrectly, or there's missing spacing.
**Why it happens:** GitHub's Markdown renderer requires blank lines between adjacent HTML blocks for proper rendering.
**How to avoid:** Ensure there are two blank lines between the closing `</details>` of the Kodiai Review Summary and the opening `<details>` of Review Details. Test the rendering on a real GitHub PR.
**Warning signs:** Review Details section not appearing as a collapsible block, or appearing inline with the summary text.

### Pitfall 5: Breaking Existing Test Assertions

**What goes wrong:** Existing tests assert that `detailsCommentBody` contains specific content (e.g., "Estimated review time saved:", "Lines analyzed:"). These will fail when the format changes.
**Why it happens:** Tests check for the old format strings.
**How to avoid:** Update all test assertions in `review.test.ts` to match the new format: "Lines changed: +N -N" instead of "Lines analyzed:" and "Lines changed:", remove assertions for "Estimated review time saved:" and "Suppressions applied:", add assertion for "Review completed:".
**Warning signs:** Test failures in `review.test.ts` on Review Details content checks.

### Pitfall 6: Prompt Still Instructing Claude to Generate Review Details

**What goes wrong:** Even after embedding Review Details deterministically, the prompt still tells Claude to include a "Review Details" section. Claude generates a duplicate Review Details that conflicts with the handler-appended one.
**Why it happens:** Forgetting to remove `buildMetricsInstructions()` from the prompt.
**How to avoid:** Remove `buildMetricsInstructions()` entirely and remove the `lines.push("", buildMetricsInstructions())` call. Remove related test assertions.
**Warning signs:** Summary comments containing two Review Details sections -- one Claude-generated and one handler-appended.

## Code Examples

### Example 1: New formatReviewDetailsSummary() (Simplified FORMAT-13)

```typescript
function formatReviewDetailsSummary(params: {
  reviewOutputKey: string;
  filesReviewed: number;
  linesAdded: number;
  linesRemoved: number;
  findingCounts: {
    critical: number;
    major: number;
    medium: number;
    minor: number;
  };
}): string {
  const { reviewOutputKey, filesReviewed, linesAdded, linesRemoved, findingCounts } = params;
  const timestamp = new Date().toISOString();

  const sections = [
    "<details>",
    "<summary>Review Details</summary>",
    "",
    `- Files reviewed: ${filesReviewed}`,
    `- Lines changed: +${linesAdded} -${linesRemoved}`,
    `- Findings: ${findingCounts.critical} critical, ${findingCounts.major} major, ${findingCounts.medium} medium, ${findingCounts.minor} minor`,
    `- Review completed: ${timestamp}`,
    "",
    "</details>",
    "",
    buildReviewDetailsMarker(reviewOutputKey),
  ];

  return sections.join("\n");
}
```

### Example 2: Modified Handler Flow -- Embed or Standalone

```typescript
// After Claude execution completes and findings are processed:

if (shouldProcessReviewOutput) {
  const reviewDetailsBlock = formatReviewDetailsSummary({
    reviewOutputKey,
    filesReviewed: diffAnalysis?.metrics.totalFiles ?? changedFiles.length,
    linesAdded: diffAnalysis?.metrics.totalLinesAdded ?? 0,
    linesRemoved: diffAnalysis?.metrics.totalLinesRemoved ?? 0,
    findingCounts,
  });

  if (result.published) {
    // Summary comment was posted -- append Review Details to it
    try {
      await appendReviewDetailsToSummary({
        octokit: extractionOctokit,
        owner: apiOwner,
        repo: apiRepo,
        prNumber: pr.number,
        reviewOutputKey,
        reviewDetailsBlock,
      });
    } catch (err) {
      // Fallback: post standalone if append fails
      logger.warn({ ...baseLog, err }, "Failed to append Review Details to summary; posting standalone");
      await upsertReviewDetailsComment({ ... });
    }
  } else {
    // No summary comment -- post standalone Review Details
    await upsertReviewDetailsComment({
      octokit: extractionOctokit,
      owner: apiOwner,
      repo: apiRepo,
      prNumber: pr.number,
      reviewOutputKey,
      body: reviewDetailsBlock,
    });
  }
}
```

### Example 3: appendReviewDetailsToSummary() Function

```typescript
async function appendReviewDetailsToSummary(params: {
  octokit: Awaited<ReturnType<GitHubApp["getInstallationOctokit"]>>;
  owner: string;
  repo: string;
  prNumber: number;
  reviewOutputKey: string;
  reviewDetailsBlock: string;
}): Promise<void> {
  const { octokit, owner, repo, prNumber, reviewOutputKey, reviewDetailsBlock } = params;
  const marker = buildReviewOutputMarker(reviewOutputKey);

  // Find the summary comment by its marker
  const commentsResponse = await octokit.rest.issues.listComments({
    owner,
    repo,
    issue_number: prNumber,
    per_page: 100,
    sort: "created",
    direction: "desc",
  });

  const summaryComment = commentsResponse.data.find((comment) =>
    typeof comment.body === "string" && comment.body.includes(marker)
  );

  if (!summaryComment) {
    throw new Error("Summary comment not found for marker");
  }

  // Append Review Details block after the summary comment body
  const updatedBody = `${summaryComment.body}\n\n${reviewDetailsBlock}`;

  await octokit.rest.issues.updateComment({
    owner,
    repo,
    comment_id: summaryComment.id,
    body: updatedBody,
  });
}
```

### Example 4: Remove buildMetricsInstructions()

```typescript
// DELETE this function entirely from review-prompt.ts:
// export function buildMetricsInstructions(): string { ... }

// DELETE this line from buildReviewPrompt():
// lines.push("", buildMetricsInstructions());
```

### Example 5: Rendered Output (Summary Comment with Embedded Review Details)

```markdown
<details>
<summary>Kodiai Review Summary</summary>

## What Changed
Add retry logic to API client for transient failures.

Reviewed: core logic, tests

## Strengths
- :white_check_mark: Exponential backoff with jitter prevents thundering herd
- :white_check_mark: Test coverage for all retry scenarios

## Observations

### Impact

[MAJOR] src/api/client.ts (45-52): Unbounded retry loop when timeout is zero
Causes infinite retry loop when `config.timeout` is set to 0, consuming resources indefinitely.

### Preference

[MINOR] src/api/client.ts (80): Magic number for max retries
Optional: Extract `3` to a named constant for readability.

## Suggestions
- Optional: Add jitter variance configuration option
- Future consideration: Circuit breaker pattern for sustained failures

## Verdict
:red_circle: **Address before merging** -- 1 blocking issue found (MAJOR)

</details>

<!-- kodiai:review-output-key:abc123 -->

<details>
<summary>Review Details</summary>

- Files reviewed: 5
- Lines changed: +120 -30
- Findings: 0 critical, 1 major, 0 medium, 1 minor
- Review completed: 2026-02-13T14:30:00Z

</details>

<!-- kodiai:review-details:abc123 -->
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| No Review Details | Standalone Review Details comment with metrics | Phase 26 (v0.5) | Quantitative transparency |
| Time-saved estimate | `(3 min x actionable) + (1 min x low-confidence) + (0.25 min x files)` | Phase 26 (v0.5) | User-facing metric (to be removed) |
| Separate comment surfaces | Summary + Review Details as separate comments | Phase 34 (current) | Two comments per review |
| Prompt-generated metrics | `buildMetricsInstructions()` tells Claude to generate Review Details | Phase 34 (current) | Duplicate: both Claude and handler generate Review Details |

**What changes with Phase 37:**
- Review Details moves from standalone comment to appendix in summary comment
- Time-saved metric and formula removed entirely (FORMAT-12)
- Review Details simplified to 4 factual lines (FORMAT-13)
- Prompt no longer instructs Claude to generate metrics (removes duplication)
- Clean reviews (no issues) still get standalone Review Details
- One fewer comment on PRs with issues (reduced noise)

## Open Questions

1. **Should the Review Details marker be preserved in the combined comment?**
   - What we know: Currently, `formatReviewDetailsSummary()` appends `buildReviewDetailsMarker(reviewOutputKey)` at the end. The summary comment already has the review output marker from `maybeStampMarker()`. Having both markers in one comment is redundant but harmless.
   - What's unclear: Whether the review details marker is used for upsert logic that would break if it's in the same comment as the output marker.
   - Recommendation: Keep both markers. The review details marker is used by `upsertReviewDetailsComment()` to find and update the Review Details on re-review. If both are in the same comment, the upsert logic will find and update the combined comment, which is correct behavior.

2. **What happens to delta summary, provenance, and low-confidence findings?**
   - What we know: FORMAT-13 specifies only four data points. The current `formatReviewDetailsSummary()` also includes delta summary (Phase 31/33), learning provenance (Phase 28), and low-confidence findings (Phase 26).
   - What's unclear: Whether these sections should be removed entirely or moved elsewhere.
   - Recommendation: For Phase 37, remove them from the Review Details block. Delta summary formatting is Phase 38's scope (FORMAT-14/15/16). Low-confidence findings and provenance are internal details that don't belong in user-facing output. The data is still recorded in the knowledge store for internal use.

3. **Should the handler update the comment immediately or use a dedicated function?**
   - What we know: The handler already has the Octokit client and the review output key. It can find and update the summary comment directly.
   - What's unclear: Whether this should be a separate exported function for testability.
   - Recommendation: Create `appendReviewDetailsToSummary()` as a separate function (like `upsertReviewDetailsComment()`) for testability and clear separation of concerns. The handler calls it when `result.published === true`.

4. **How should the sanitizer handle the appended Review Details on comment updates?**
   - What we know: The sanitizer validates the five-section template. Content after the closing `</details>` of the summary is outside its scope.
   - What's unclear: Whether `update_comment` tool calls (e.g., from mention flow) would re-sanitize the combined body.
   - Recommendation: Verify the sanitizer's scope is limited to content within the `<summary>Kodiai Review Summary</summary>` wrapper. The appended Review Details uses `<details>` tags without `## ` headings, so it should not trigger section validation. Add a test case for this scenario.

## Sources

### Primary (HIGH confidence)
- Source code: `src/handlers/review.ts` -- `formatReviewDetailsSummary()` (lines 98-252), `upsertReviewDetailsComment()` (lines 254-294), post-execution flow (lines 1457-1512), `buildReviewDetailsMarker()` (lines 94-96)
- Source code: `src/execution/review-prompt.ts` -- `buildMetricsInstructions()` (lines 367-378), invocation at line 956
- Source code: `src/execution/mcp/comment-server.ts` -- `sanitizeKodiaiReviewSummary()` (lines 100-368), `maybeStampMarker()` (lines 370-374), `create_comment` handler (lines 417-480)
- Source code: `src/execution/diff-analysis.ts` -- `DiffAnalysis.metrics` interface (lines 78-84): `totalLinesAdded`, `totalLinesRemoved`, `totalFiles`
- Source code: `src/handlers/review.test.ts` -- Review Details assertions (lines 2416-2424, 2604-2609)
- Source code: `src/lib/formatting.ts` -- `wrapInDetails()` utility (lines 22-27)

### Secondary (MEDIUM confidence)
- Phase 34 research and verification: `.planning/phases/34-structured-review-template/34-RESEARCH.md`, `34-VERIFICATION.md` -- established the summary comment five-section template, sanitizer validation, and two-comment output model
- Phase 35 research: `.planning/phases/35-findings-organization-and-tone/35-RESEARCH.md` -- Impact/Preference structure within Observations
- Phase 36 research: `.planning/phases/36-verdict-and-merge-confidence/36-RESEARCH.md` -- verdict labels and blocker-driven logic, sanitizer cross-checks
- Requirements: `.planning/REQUIREMENTS.md` -- FORMAT-11, FORMAT-12, FORMAT-13 definitions (lines 70-84)

### Tertiary (LOW confidence)
- None -- all findings are from direct source code analysis

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH -- no new dependencies needed, all changes are in existing files
- Architecture: HIGH -- the two-comment output model is thoroughly understood from source code analysis; the merge into one comment is a straightforward refactoring of existing posting logic
- Pitfalls: HIGH -- identified from direct analysis of the sanitizer scope, comment search logic, and the dual posting flow
- Code examples: HIGH -- based on actual current code structure, function signatures, and data availability

**Research date:** 2026-02-13
**Valid until:** 2026-03-15 (stable -- no external dependencies to go stale)
