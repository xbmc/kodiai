---
phase: 37-review-details-embedding
plan: 02
type: execute
wave: 2
depends_on: ["37-01"]
files_modified:
  - src/handlers/review.test.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Review Details test assertions match the new FORMAT-13 output (Lines changed: +N -N, Findings:, Review completed:)"
    - "No test asserts on removed fields (Lines analyzed, Suppressions applied, Estimated review time saved, Low Confidence Findings)"
    - "Sanitizer tolerates a summary comment with Review Details appended after the closing </details> tag"
  artifacts:
    - path: "src/handlers/review.test.ts"
      provides: "Updated Review Details assertions matching FORMAT-13"
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Sanitizer tolerance test for appended Review Details block"
  key_links:
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/review.ts"
      via: "Test assertions on formatReviewDetailsSummary output"
      pattern: "Review Details"
    - from: "src/execution/mcp/comment-server.test.ts"
      to: "src/execution/mcp/comment-server.ts"
      via: "Sanitizer validation on combined body"
      pattern: "sanitize.*Review Details"
---

<objective>
Update all test assertions to match the new FORMAT-13 Review Details format and add a sanitizer tolerance test confirming the sanitizer accepts summary comments with an appended Review Details block.

Purpose: After Plan 01 changes the production code, existing tests will fail because they assert on the old format. This plan fixes all test assertions and adds coverage for the sanitizer's behavior with the combined comment body.
Output: All tests pass with the new format; sanitizer tolerance verified.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-review-details-embedding/37-RESEARCH.md
@.planning/phases/37-review-details-embedding/37-01-SUMMARY.md
@src/handlers/review.test.ts
@src/execution/mcp/comment-server.test.ts
@src/execution/mcp/comment-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Review Details assertions in review.test.ts</name>
  <files>src/handlers/review.test.ts</files>
  <action>
Update the two test blocks that assert on Review Details content:

**Block 1** (around lines 2416-2424 in the "publishes deterministic Review Details" test):

Replace the old assertions:
```typescript
expect(detailsCommentBody).toContain("<summary>Review Details</summary>");
expect(detailsCommentBody).toContain("Files reviewed:");
expect(detailsCommentBody).toContain("Lines analyzed:");
expect(detailsCommentBody).toContain("Lines changed:");
expect(detailsCommentBody).toContain("Suppressions applied: 1");
expect(detailsCommentBody).toContain("Estimated review time saved:");
expect(detailsCommentBody).toContain("<summary>Low Confidence Findings");
expect(detailsCommentBody).toContain("src/ui/button.ts:12 [minor] Formatting consistency issue (confidence: 45)");
expect(detailsCommentBody).not.toContain("Legacy shim cleanup candidate");
```

With new FORMAT-13 assertions:
```typescript
expect(detailsCommentBody).toContain("<summary>Review Details</summary>");
expect(detailsCommentBody).toContain("Files reviewed:");
expect(detailsCommentBody).toMatch(/Lines changed: \+\d+ -\d+/);
expect(detailsCommentBody).toMatch(/Findings: \d+ critical, \d+ major, \d+ medium, \d+ minor/);
expect(detailsCommentBody).toMatch(/Review completed: \d{4}-\d{2}-\d{2}T/);
expect(detailsCommentBody).not.toContain("Lines analyzed:");
expect(detailsCommentBody).not.toContain("Suppressions applied:");
expect(detailsCommentBody).not.toContain("Estimated review time saved:");
expect(detailsCommentBody).not.toContain("Low Confidence Findings");
```

**Block 2** (around lines 2604-2609 in the "publishes Review Details even when execution reports published false" test):

Replace the old assertions:
```typescript
expect(detailsCommentBody).toContain("<summary>Review Details</summary>");
expect(detailsCommentBody).toContain("Files reviewed:");
expect(detailsCommentBody).toContain("Suppressions applied: 1");
expect(detailsCommentBody).toContain("<summary>Low Confidence Findings");
expect(detailsCommentBody).toContain("src/ui/button.ts:12 [minor] Formatting consistency issue (confidence: 45)");
expect(detailsCommentBody).not.toContain("Legacy shim cleanup candidate");
```

With new FORMAT-13 assertions:
```typescript
expect(detailsCommentBody).toContain("<summary>Review Details</summary>");
expect(detailsCommentBody).toContain("Files reviewed:");
expect(detailsCommentBody).toMatch(/Lines changed: \+\d+ -\d+/);
expect(detailsCommentBody).toMatch(/Findings: \d+ critical, \d+ major, \d+ medium, \d+ minor/);
expect(detailsCommentBody).toMatch(/Review completed: \d{4}-\d{2}-\d{2}T/);
expect(detailsCommentBody).not.toContain("Suppressions applied:");
expect(detailsCommentBody).not.toContain("Estimated review time saved:");
expect(detailsCommentBody).not.toContain("Low Confidence Findings");
```

NOTE: The test mock for `upsertReviewDetailsComment` captures the body via `createComment`. Since the "published false" test has `result.published = false`, the handler will still use the standalone `upsertReviewDetailsComment` path, so the existing mock capture pattern still works. Verify that the mock setup remains compatible.
  </action>
  <verify>Run `bun test src/handlers/review.test.ts` -- all tests pass including the updated Review Details assertions.</verify>
  <done>Both Review Details test blocks assert on FORMAT-13 output; no test references removed fields (Lines analyzed, Suppressions, time saved, Low Confidence Findings)</done>
</task>

<task type="auto">
  <name>Task 2: Add sanitizer tolerance test for appended Review Details</name>
  <files>src/execution/mcp/comment-server.test.ts</files>
  <action>
Add a test case in the `sanitizeKodiaiReviewSummary` describe block that verifies the sanitizer accepts a summary comment body with a Review Details `<details>` block appended after the closing `</details>` tag.

Use the existing `buildTestSummary()` helper (established in Phase 34-02) to construct a valid five-section summary body. Then append a Review Details block after it:

```typescript
test("tolerates appended Review Details block after closing details tag", () => {
  const summaryBody = buildTestSummary({
    // Use defaults or minimal valid content
  });

  const reviewDetailsBlock = [
    "<details>",
    "<summary>Review Details</summary>",
    "",
    "- Files reviewed: 5",
    "- Lines changed: +120 -30",
    "- Findings: 0 critical, 1 major, 0 medium, 1 minor",
    "- Review completed: 2026-02-13T14:30:00Z",
    "",
    "</details>",
    "",
    "<!-- kodiai:review-details:test-key -->",
  ].join("\n");

  const combinedBody = `${summaryBody}\n\n${reviewDetailsBlock}`;

  // Should NOT throw -- the sanitizer should tolerate content after the summary's </details>
  const result = sanitizer(combinedBody);
  expect(result).toContain("<summary>Kodiai Review Summary</summary>");
  expect(result).toContain("<summary>Review Details</summary>");
});
```

To call the sanitizer directly, check how existing tests invoke it. The `sanitizeKodiaiReviewSummary` function is internal to `createCommentServer()`. Existing tests likely create a server instance or extract the sanitizer. Follow the established test pattern.

IMPORTANT: The sanitizer uses `headingRe = /^## .+$/gm` on the full `stripped` body. The Review Details block has no `## ` headings (it uses `<details>` and list items only), so it should pass. This test confirms that behavior.
  </action>
  <verify>Run `bun test src/execution/mcp/comment-server.test.ts` -- the new test passes along with all existing tests.</verify>
  <done>Sanitizer tolerance test exists and passes; confirms the sanitizer does not reject summary comments with appended Review Details</done>
</task>

</tasks>

<verification>
1. `bun test src/handlers/review.test.ts` -- all tests pass
2. `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass including new tolerance test
3. `bun test` -- full test suite passes
4. No test file contains assertions on "Lines analyzed:", "Suppressions applied:", or "Estimated review time saved:"
</verification>

<success_criteria>
- All review.test.ts Review Details assertions match FORMAT-13 format
- No test asserts on removed fields (Lines analyzed, Suppressions, time-saved, Low Confidence Findings)
- Sanitizer tolerance test proves the sanitizer accepts combined summary + Review Details body
- Full test suite passes with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/37-review-details-embedding/37-02-SUMMARY.md`
</output>
