---
phase: 37-review-details-embedding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "formatReviewDetailsSummary() produces exactly four data lines: files reviewed, lines changed (+/-), findings by severity, and review timestamp"
    - "No 'Estimated review time saved' or time-saved formula appears in the Review Details output"
    - "buildMetricsInstructions() no longer exists in review-prompt.ts and is not invoked"
    - "When a summary comment was published, Review Details is appended to it instead of posted standalone (FORMAT-11 compliance)"
    - "When no summary comment exists (clean review), Review Details is posted as a standalone comment (FORMAT-11 exemption: clean reviews have no summary to embed into, standalone preserves metrics visibility)"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Minimal formatReviewDetailsSummary, appendReviewDetailsToSummary, updated handler flow"
      contains: "Lines changed: \\+"
    - path: "src/execution/review-prompt.ts"
      provides: "Prompt without buildMetricsInstructions"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests without buildMetricsInstructions assertions"
  key_links:
    - from: "src/handlers/review.ts"
      to: "review-idempotency.ts"
      via: "buildReviewOutputMarker import for finding summary comment"
      pattern: "buildReviewOutputMarker"
---

<objective>
Rewrite formatReviewDetailsSummary() to produce the minimal FORMAT-13 output (4 factual lines), remove buildMetricsInstructions() from the prompt, and modify the handler flow to embed Review Details into the summary comment when one exists.

Purpose: FORMAT-11 requires Review Details inside the summary comment, FORMAT-12 removes time-saved metrics, FORMAT-13 defines the minimal factual format. This plan implements all three requirements in the production code. FORMAT-11 interpretation: "Never create standalone comment with just Review Details" applies when a summary comment exists. Clean reviews (no findings, no summary posted) are exempted -- standalone Review Details is retained for metrics visibility because there is no summary to embed into.
Output: Updated review.ts with new format + embed/standalone logic, cleaned review-prompt.ts, updated prompt tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-review-details-embedding/37-RESEARCH.md
@src/handlers/review.ts
@src/handlers/review-idempotency.ts
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/execution/diff-analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite formatReviewDetailsSummary and remove buildMetricsInstructions</name>
  <files>src/handlers/review.ts, src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
In `src/handlers/review.ts`:

1. Rewrite `formatReviewDetailsSummary()` (lines 98-252) to accept a simplified parameter object and produce the FORMAT-13 output:
   - New params: `{ reviewOutputKey, filesReviewed, linesAdded, linesRemoved, findingCounts: { critical, major, medium, minor } }`
   - Remove all old params: `linesAnalyzed`, `linesChanged`, `suppressionsApplied`, `minConfidence`, `visibleFindings`, `lowConfidenceFindings`, `deltaSummary`, `provenanceSummary`
   - Output exactly this structure:
     ```
     <details>
     <summary>Review Details</summary>

     - Files reviewed: {N}
     - Lines changed: +{added} -{removed}
     - Findings: {critical} critical, {major} major, {medium} medium, {minor} minor
     - Review completed: {ISO-8601 timestamp}

     </details>

     {buildReviewDetailsMarker(reviewOutputKey)}
     ```
   - Use `new Date().toISOString()` for the timestamp

2. Create `appendReviewDetailsToSummary()` as an async function (after `upsertReviewDetailsComment`):
   - Params: `{ octokit, owner, repo, prNumber, reviewOutputKey, reviewDetailsBlock }`
   - Use `buildReviewOutputMarker(reviewOutputKey)` to find the summary comment (import already exists at line 28)
   - List comments via `octokit.rest.issues.listComments()` with `per_page: 100, sort: "created", direction: "desc"`
   - Find comment whose body includes the review output marker
   - If not found, throw an Error so the caller can fall back to standalone
   - Append `reviewDetailsBlock` to the found comment body with `\n\n` separator
   - Update via `octokit.rest.issues.updateComment()`

In `src/execution/review-prompt.ts`:

3. Delete the `buildMetricsInstructions()` function (lines 367-378)
4. Remove the invocation at line 956: `lines.push("", buildMetricsInstructions());`
5. Remove `buildMetricsInstructions` from the exports

In `src/execution/review-prompt.test.ts`:

6. Remove the import of `buildMetricsInstructions` from line 7
7. Delete the test "buildMetricsInstructions returns metrics section" (lines 188-196)
8. Delete the test "standard mode includes quantitative review details contract" (lines 198-206)
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all remaining tests pass. Run `bunx tsc --noEmit` -- no type errors. Grep for `buildMetricsInstructions` in src/ -- zero matches.</verify>
  <done>formatReviewDetailsSummary produces exactly 4 data lines per FORMAT-13; buildMetricsInstructions is fully removed from codebase; appendReviewDetailsToSummary exists as an exported async function</done>
</task>

<task type="auto">
  <name>Task 2: Update handler flow to embed-or-standalone Review Details</name>
  <files>src/handlers/review.ts</files>
  <action>
Modify the post-execution block in the review handler (lines 1457-1512) to:

1. Simplify the `formatReviewDetailsSummary()` call site (around line 1473) to match the new signature:
   ```typescript
   const reviewDetailsBody = formatReviewDetailsSummary({
     reviewOutputKey,
     filesReviewed: diffAnalysis?.metrics.totalFiles ?? changedFiles.length,
     linesAdded: diffAnalysis?.metrics.totalLinesAdded ?? 0,
     linesRemoved: diffAnalysis?.metrics.totalLinesRemoved ?? 0,
     findingCounts,
   });
   ```

2. Replace the unconditional `upsertReviewDetailsComment()` call (line 1492) with conditional logic:
   ```typescript
   if (result.published) {
     // Summary comment was posted -- append Review Details to it
     try {
       await appendReviewDetailsToSummary({
         octokit: extractionOctokit,
         owner: apiOwner,
         repo: apiRepo,
         prNumber: pr.number,
         reviewOutputKey,
         reviewDetailsBlock: reviewDetailsBody,
       });
     } catch (appendErr) {
       // Fallback: post standalone if append fails (e.g., summary comment not found yet)
       logger.warn(
         { ...baseLog, gate: "review-details-output", gateResult: "append-fallback", err: appendErr },
         "Failed to append Review Details to summary comment; posting standalone",
       );
       await upsertReviewDetailsComment({
         octokit: extractionOctokit,
         owner: apiOwner,
         repo: apiRepo,
         prNumber: pr.number,
         reviewOutputKey,
         body: reviewDetailsBody,
       });
     }
   } else {
     // No summary comment (clean review) -- post standalone Review Details
     // FORMAT-11 exemption: no summary exists to embed into; standalone preserves metrics visibility
     await upsertReviewDetailsComment({
       octokit: extractionOctokit,
       owner: apiOwner,
       repo: apiRepo,
       prNumber: pr.number,
       reviewOutputKey,
       body: reviewDetailsBody,
     });
   }
   ```

3. The outer try/catch around the entire block (line 1500) stays unchanged -- it handles failures from either path.

NOTE: `result.published` is already available in scope (used at lines 1787 and 1827). It indicates whether Claude posted a summary comment during execution.
  </action>
  <verify>Run `bunx tsc --noEmit` -- no type errors. Verify the conditional logic by reading the modified handler block and confirming: (a) `result.published === true` triggers appendReviewDetailsToSummary with fallback, (b) `result.published === false/undefined` triggers standalone upsertReviewDetailsComment.</verify>
  <done>Handler embeds Review Details in summary comment when one was published (FORMAT-11); falls back to standalone comment when no summary exists (clean review exemption) or append fails</done>
</task>

</tasks>

<verification>
1. `bun test src/execution/review-prompt.test.ts` passes with no buildMetricsInstructions references
2. `bunx tsc --noEmit` succeeds with zero type errors
3. `grep -r "buildMetricsInstructions" src/` returns zero matches
4. `grep -r "Estimated review time saved" src/` returns zero matches
5. `grep -r "Lines analyzed" src/handlers/review.ts` returns zero matches
6. `grep "appendReviewDetailsToSummary" src/handlers/review.ts` returns at least 2 matches (definition + call)
</verification>

<success_criteria>
- formatReviewDetailsSummary() output contains exactly: "Files reviewed:", "Lines changed: +N -N", "Findings: N critical, N major, N medium, N minor", "Review completed:" -- nothing else
- buildMetricsInstructions() fully deleted from review-prompt.ts and tests
- Handler flow branches on result.published: embed when true (FORMAT-11), standalone when false (clean review exemption -- no summary to embed into)
- appendReviewDetailsToSummary() finds summary comment by review output marker and appends
- All existing tests in review-prompt.test.ts pass (minus the 2 deleted tests)
</success_criteria>

<output>
After completion, create `.planning/phases/37-review-details-embedding/37-01-SUMMARY.md`
</output>
