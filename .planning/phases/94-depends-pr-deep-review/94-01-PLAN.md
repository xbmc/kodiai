---
phase: 94-depends-pr-deep-review
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/depends-bump-detector.ts
  - src/lib/depends-bump-detector.test.ts
autonomous: true
requirements: [DEPS-01, DEPS-02]

must_haves:
  truths:
    - "A PR titled '[depends] Bump zlib 1.3.2' is detected as a depends bump"
    - "A PR titled '[Windows] Refresh fstrcmp 0.7' is detected as a depends bump"
    - "A Dependabot PR titled 'Bump lodash from 4.17.20 to 4.17.21' is NOT detected as a depends bump"
    - "Multi-dependency titles like '[depends] Bump openssl to 3.0.19 / python3 to 3.14.3' extract both packages"
    - "Detection returns null for non-matching titles, enabling Dependabot fallback"
  artifacts:
    - path: "src/lib/depends-bump-detector.ts"
      provides: "detectDependsBump() function and DependsBumpContext type"
      exports: ["detectDependsBump", "DependsBumpContext", "DependsBumpInfo"]
    - path: "src/lib/depends-bump-detector.test.ts"
      provides: "Comprehensive test suite for detection and extraction"
      min_lines: 100
  key_links:
    - from: "src/lib/depends-bump-detector.ts"
      to: "src/lib/dep-bump-detector.ts"
      via: "mutual exclusion â€” detectDependsBump() runs first; if matched, detectDepBump() is skipped"
      pattern: "detectDependsBump"
---

<objective>
Create the `[depends]` PR title detection module with comprehensive test coverage.

Purpose: Enable Kodiai to identify Kodi-convention dependency bump PRs by title pattern, strictly mutually exclusive with the existing Dependabot/Renovate detector. This is the routing gate that determines whether a PR enters the deep-review pipeline.

Output: `src/lib/depends-bump-detector.ts` with exported `detectDependsBump()` function and types, plus test suite.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/94-depends-pr-deep-review/94-RESEARCH.md
@src/lib/dep-bump-detector.ts
</context>

<interfaces>
<!-- Existing types from dep-bump-detector.ts that this module must NOT conflict with -->

From src/lib/dep-bump-detector.ts:
```typescript
export type DepBumpSource = "dependabot" | "renovate" | "unknown";
export type DepBumpDetection = { matched: boolean; source: DepBumpSource; signals: string[] };
export type DepBumpDetails = { packageName: string | null; oldVersion: string | null; newVersion: string | null; isGroup: boolean; ecosystem: string | null; };
export type DepBumpContext = { detection: DepBumpDetection; details: DepBumpDetails; classification: DepBumpClassification; security?: ...; changelog?: ...; mergeConfidence?: ...; usageEvidence?: ...; scopeGroups?: ...; };
export function detectDepBump(params: { prTitle: string; prLabels: string[]; headBranch: string; }): DepBumpDetection;
```

<!-- The new module provides a DIFFERENT type (DependsBumpContext) for the [depends] pipeline -->
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for [depends] title detection and extraction</name>
  <files>src/lib/depends-bump-detector.test.ts</files>
  <action>
Create test file `src/lib/depends-bump-detector.test.ts` with tests for `detectDependsBump()`. Import the function (it won't exist yet -- RED phase).

Test cases for detection (returns non-null when matched, null when not):

**Positive matches (real xbmc/xbmc PR titles):**
- `[depends] Bump zlib 1.3.2` -- standard depends bump
- `[depends] Bump TagLib to 2.2` -- "to" separator
- `[depends][target] Bump libcdio to 2.3.0` -- nested brackets
- `[depends] Bump openssl to 3.0.19 / python3 to 3.14.3` -- multi-package
- `[Depends] Bump mariadb-c-connector 3.4.8` -- capitalized
- `[Windows] Refresh fstrcmp 0.7` -- Windows platform, "Refresh" verb
- `[Windows] Bump libaacs to 0.11.1` -- Windows + Bump
- `[Windows] Bump Detours to 9764ceb` -- commit hash version
- `[Windows] Bump Python to 3.14.3 / OpenSSL to 3.0.19` -- Windows multi-package
- `[depends][target] Bump font libraries` -- group bump (no version)
- `[Depends] Update Harfbuzz to v12.3.0` -- "Update" verb, v-prefix
- `[Windows] Bump dnssd to 2881.60.4` -- unusual version format
- `[android] Bump curl to 8.5.0` -- android platform
- `[ios] Update ffmpeg to 6.1` -- iOS platform
- `[osx] Refresh libpng 1.6.40` -- macOS platform
- `[linux] Bump gnutls to 3.8.3` -- Linux platform
- `target/depends: Update libxkbcommon to v1.13.1` -- target/depends prefix (no brackets)

**Negative matches (must NOT trigger):**
- `Bump lodash from 4.17.20 to 4.17.21` -- Dependabot (no bracket prefix)
- `Update dependency @types/node to v20` -- Renovate (no bracket prefix)
- `chore(deps): bump axios from 1.6.0 to 1.6.2` -- Renovate (no bracket prefix)
- `Fix memory leak in video player` -- Regular PR
- `[Feature] Add new codec support` -- Bracket prefix but not depends/platform
- `Depends on upstream fix for #1234` -- Contains "depends" but not a bump

**Extraction tests (verify extracted fields):**
- `[depends] Bump zlib 1.3.2` -> packages: [{name: "zlib", newVersion: "1.3.2", oldVersion: null}]
- `[depends] Bump openssl to 3.0.19 / python3 to 3.14.3` -> packages: [{name: "openssl", newVersion: "3.0.19"}, {name: "python3", newVersion: "3.14.3"}]
- `[depends][target] Bump font libraries` -> packages: [{name: "font libraries", newVersion: null}], isGroup: true
- `[Windows] Refresh fstrcmp 0.7` -> packages: [{name: "fstrcmp", newVersion: "0.7"}], platform: "windows"
- `target/depends: Update libxkbcommon to v1.13.1` -> packages: [{name: "libxkbcommon", newVersion: "1.13.1"}] (v-prefix stripped)

Run tests -- they MUST fail (RED).
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/lib/depends-bump-detector.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>Test file exists with 20+ test cases, all failing because the module doesn't exist yet</done>
</task>

<task type="auto">
  <name>Task 2: Implement detectDependsBump() to pass all tests</name>
  <files>src/lib/depends-bump-detector.ts</files>
  <action>
Create `src/lib/depends-bump-detector.ts` implementing:

**Types:**
```typescript
export type DependsBumpPackage = {
  name: string;
  newVersion: string | null;  // null for group bumps like "Bump font libraries"
  oldVersion: string | null;  // null when title only has new version
};

export type DependsBumpInfo = {
  packages: DependsBumpPackage[];
  platform: string | null;  // "windows", "android", "ios", "osx", "linux", or null for generic [depends]
  isGroup: boolean;         // true when title has no individual package version
  rawTitle: string;
};

export type DependsBumpContext = {
  info: DependsBumpInfo;
  // Enrichment fields populated by later pipeline stages:
  changelog?: Record<string, unknown> | null;
  hashVerification?: Record<string, unknown> | null;
  impactAssessment?: Record<string, unknown> | null;
  transitiveCheck?: Record<string, unknown> | null;
  retrievalContext?: Record<string, unknown> | null;
  hasSourceChanges?: boolean;  // true if PR touches code beyond build configs
};
```

**Detection logic:**
1. Two regex patterns (from research):
   - `DEPENDS_TITLE_RE = /^\[(?:depends|windows|android|ios|osx|linux)[^\]]*\]/i` -- bracketed prefix
   - `TARGET_DEPENDS_PREFIX_RE = /^(?:target\/depends|tools\/depends):\s/i` -- path prefix
2. If neither matches, return `null` (allows Dependabot fallback).
3. Extract platform from bracket content (case-insensitive): `[Windows]` -> "windows", `[depends]` -> null.

**Extraction logic:**
1. Strip the bracket prefix (or `target/depends:` prefix) to get the action part.
2. Match verb: `bump|refresh|update|upgrade` (case-insensitive).
3. After the verb, split on ` / ` for multi-package support.
4. For each segment, extract `name` and optional `version` (strip `to ` prefix and `v` prefix).
5. `isGroup = true` when no package has a version AND name looks like a category ("font libraries", "build tools").

**Edge cases:**
- Nested brackets like `[depends][target]` -- strip all bracket groups.
- Commit hash versions like `9764ceb` -- treat as valid version string.
- Version with dots like `2881.60.4` -- already handled by generic version pattern.

Run tests -- they MUST all pass (GREEN).
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/lib/depends-bump-detector.test.ts 2>&1 | tail -10</automated>
  </verify>
  <done>All test cases pass, detectDependsBump() correctly identifies [depends] PRs and rejects Dependabot/Renovate PRs</done>
</task>

</tasks>

<verification>
- `bun test src/lib/depends-bump-detector.test.ts` -- all tests pass
- Positive titles return non-null `DependsBumpInfo` with correct extracted packages
- Negative titles return `null`
- Multi-package titles extract all packages
- Platform is correctly extracted from bracket prefix
- No overlap with Dependabot titles (no bracketed prefix = no match)
</verification>

<success_criteria>
1. `detectDependsBump()` matches all Kodi-convention dependency bump title patterns
2. Returns `null` for Dependabot/Renovate titles (no bracket prefix)
3. Extracts package names, versions, and platform correctly
4. Handles multi-dependency titles with `/` separator
5. Handles group bumps without individual versions
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/94-depends-pr-deep-review/94-01-SUMMARY.md`
</output>
