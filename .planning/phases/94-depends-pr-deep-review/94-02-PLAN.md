---
phase: 94-depends-pr-deep-review
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/depends-bump-enrichment.ts
  - src/lib/depends-bump-enrichment.test.ts
autonomous: true
requirements: [DEPS-03, DEPS-04, DEPS-06]

must_haves:
  truths:
    - "VERSION file diffs are parsed into old/new version, hash, and archive fields"
    - "Upstream changelog is fetched from GitHub Releases API with C/C++ library-to-repo resolution"
    - "When changelog fetch fails, enrichment falls back to PR diff analysis (synthesizing highlights from version/hash/URL changes) before degrading to unavailable"
    - "SHA512 hash from VERSION file can be verified against upstream tarball"
    - "Patch file additions/removals are detected from PR diff"
  artifacts:
    - path: "src/lib/depends-bump-enrichment.ts"
      provides: "VERSION file parsing, changelog fetching, hash verification, upstream repo resolution"
      exports: ["parseVersionFileDiff", "fetchDependsChangelog", "verifyHash", "resolveUpstreamRepo", "detectPatchChanges", "KODI_LIB_REPO_MAP"]
    - path: "src/lib/depends-bump-enrichment.test.ts"
      provides: "Test suite for enrichment functions"
      min_lines: 150
  key_links:
    - from: "src/lib/depends-bump-enrichment.ts"
      to: "Octokit (GitHub Releases API)"
      via: "octokit.rest.repos.listReleases() for upstream changelog"
      pattern: "listReleases"
    - from: "src/lib/depends-bump-enrichment.ts"
      to: "node:crypto"
      via: "createHash('sha512') for tarball hash verification"
      pattern: "createHash"
---

<objective>
Build the enrichment module for [depends] dependency bumps: VERSION file diff parsing, upstream changelog fetching, hash verification, and patch detection.

Purpose: Provide the factual data layer that powers the deep-review comment. Each enrichment function is deterministic and fail-open, producing structured data or graceful degradation notes.

Output: `src/lib/depends-bump-enrichment.ts` with exported enrichment functions, plus test suite.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/94-depends-pr-deep-review/94-RESEARCH.md
@src/lib/dep-bump-enrichment.ts
</context>

<interfaces>
<!-- Existing enrichment patterns from dep-bump-enrichment.ts to follow -->

From src/lib/dep-bump-enrichment.ts:
```typescript
export type RepoCoords = { owner: string; repo: string };
export type ChangelogContext = { source: string; highlights: string[]; breakingChanges: string[]; url: string | null; };
export function extractBreakingChanges(text: string): string[];
// fetchChangelog and fetchSecurityAdvisories use octokit + timeoutMs pattern
```

<!-- New types for this module -->
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for VERSION file parsing, changelog fetching, and hash verification</name>
  <files>src/lib/depends-bump-enrichment.test.ts</files>
  <action>
Create test file `src/lib/depends-bump-enrichment.test.ts` with tests for the enrichment functions.

**parseVersionFileDiff() tests:**
Test with real unified diff format from xbmc/xbmc VERSION files:

1. Standard version bump diff:
```
-VERSION=1.3.1
+VERSION=1.3.2
-SHA512=1e8e70b362d64a233...
+SHA512=cf3d49fbabddc57cca...
```
Expected: `{oldVersion: "1.3.1", newVersion: "1.3.2", oldSha512: "1e8e70b362d64a233...", newSha512: "cf3d49fbabddc57cca..."}`

2. Diff with ARCHIVE and BASE_URL changes too
3. Diff with only VERSION change (no hash change)
4. Diff with only hash change (typo fix, no version change)
5. Empty diff -> all nulls
6. Diff with Makefile-style variable expansion: `ARCHIVE=$(LIBNAME)-$(VERSION).tar.xz`

**parseVersionFileContent() tests:**
1. Full VERSION file content with LIBNAME, VERSION, ARCHIVE, SHA512, BASE_URL
2. Variable expansion: `$(LIBNAME)` and `$(VERSION)` resolve correctly
3. File with comments or empty lines

**resolveUpstreamRepo() tests:**
1. Known library from map: "zlib" -> {owner: "madler", repo: "zlib"}
2. Known library: "openssl" -> {owner: "openssl", repo: "openssl"}
3. Unknown library: "obscure-lib" -> null
4. Case-insensitive lookup: "FFmpeg" and "ffmpeg" both resolve

**fetchDependsChangelog() tests (mocked Octokit):**
1. GitHub releases found -> returns filtered changelog
2. No releases found -> returns degradation note
3. API timeout -> returns degradation note (fail-open)
4. Filtering: only breaking changes, API changes, security fixes, build changes returned
5. No releases found + versionFileDiff provided -> returns `source: "diff-analysis"` with synthesized highlights from diff (version change, hash change, URL change)
6. No releases found + no versionFileDiff -> returns `source: "unavailable"` with empty highlights

**verifyHash() tests:**
1. Matching hash -> {status: "verified", detail: "SHA512 matches upstream"}
2. Mismatched hash -> {status: "mismatch", detail: "..."}
3. Fetch failure -> {status: "unavailable", detail: "Could not fetch upstream tarball"}
4. No hash in VERSION file -> {status: "skipped", detail: "No hash to verify"}

**detectPatchChanges() tests:**
1. Patch file added in diff -> detected as addition
2. Patch file removed -> detected as removal
3. No patch changes -> empty array
4. Multiple patch changes

Run tests -- they MUST fail (RED).
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/lib/depends-bump-enrichment.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>Test file exists with 20+ test cases covering all enrichment functions, all failing</done>
</task>

<task type="auto">
  <name>Task 2: Implement enrichment functions to pass all tests</name>
  <files>src/lib/depends-bump-enrichment.ts</files>
  <action>
Create `src/lib/depends-bump-enrichment.ts` implementing:

**Types:**
```typescript
export type VersionFileDiff = {
  oldVersion: string | null;
  newVersion: string | null;
  oldSha512: string | null;
  newSha512: string | null;
  oldArchive: string | null;
  newArchive: string | null;
  oldBaseUrl: string | null;
  newBaseUrl: string | null;
};

export type VersionFileData = {
  libName: string | null;
  version: string | null;
  archive: string | null;  // expanded (variables resolved)
  sha512: string | null;
  baseUrl: string | null;  // expanded
};

export type HashVerificationResult = {
  status: "verified" | "mismatch" | "unavailable" | "skipped";
  detail: string;
  expectedHash?: string;
  actualHash?: string;
};

export type DependsChangelogContext = {
  source: string;  // "github-releases", "diff-analysis", "unavailable"
  highlights: string[];  // Kodi-relevant entries only
  breakingChanges: string[];
  url: string | null;  // link to full changelog
  degradationNote: string | null;  // set when changelog unavailable
};

export type PatchChange = {
  file: string;
  action: "added" | "removed" | "modified";
};
```

**KODI_LIB_REPO_MAP** -- hardcoded map of ~30 common Kodi dependencies to upstream GitHub repos:
```typescript
export const KODI_LIB_REPO_MAP: Record<string, { owner: string; repo: string }> = {
  zlib: { owner: "madler", repo: "zlib" },
  openssl: { owner: "openssl", repo: "openssl" },
  ffmpeg: { owner: "FFmpeg", repo: "FFmpeg" },
  harfbuzz: { owner: "harfbuzz", repo: "harfbuzz" },
  freetype: { owner: "freetype", repo: "freetype" },
  freetype2: { owner: "freetype", repo: "freetype" },
  curl: { owner: "curl", repo: "curl" },
  libpng: { owner: "pnggroup", repo: "libpng" },
  libjpeg: { owner: "libjpeg-turbo", repo: "libjpeg-turbo" },
  gnutls: { owner: "gnutls", repo: "gnutls" },
  sqlite: { owner: "nicenightcc", repo: "sqlite" },
  taglib: { owner: "taglib", repo: "taglib" },
  tinyxml2: { owner: "leethomason", repo: "tinyxml2" },
  libxml2: { owner: "GNOME", repo: "libxml2" },
  libxslt: { owner: "GNOME", repo: "libxslt" },
  libudfread: { owner: "nicenightcc", repo: "libudfread" },
  libaacs: { owner: "nicenightcc", repo: "libaacs" },
  libbluray: { owner: "nicenightcc", repo: "libbluray" },
  libass: { owner: "libass", repo: "libass" },
  libcdio: { owner: "rocky", repo: "libcdio" },
  libmicrohttpd: { owner: "nicenightcc", repo: "libmicrohttpd" },
  python3: { owner: "python", repo: "cpython" },
  dav1d: { owner: "nicenightcc", repo: "dav1d" },
  libwebp: { owner: "nicenightcc", repo: "libwebp" },
  spdlog: { owner: "gabime", repo: "spdlog" },
  fmt: { owner: "fmtlib", repo: "fmt" },
  flatbuffers: { owner: "google", repo: "flatbuffers" },
  crossguid: { owner: "nicenightcc", repo: "crossguid" },
  rapidjson: { owner: "Tencent", repo: "rapidjson" },
  pcre2: { owner: "PCRE2Project", repo: "pcre2" },
};
```
NOTE: This map is best-effort. Unknown libraries degrade gracefully.

**parseVersionFileDiff(patch: string): VersionFileDiff** -- Parse unified diff lines for `-`/`+` prefixed `VERSION=`, `SHA512=`, `ARCHIVE=`, `BASE_URL=` lines. Same approach as research code example.

**parseVersionFileContent(content: string): VersionFileData** -- Parse a full VERSION file. Collect raw key=value pairs, then expand `$(VAR)` references in ARCHIVE and BASE_URL fields using collected variables.

**resolveUpstreamRepo(libraryName: string): { owner: string; repo: string } | null** -- Case-insensitive lookup in `KODI_LIB_REPO_MAP`. Return null for unknown libraries.

**fetchDependsChangelog(params)** -- Accept `{libraryName, oldVersion, newVersion, octokit, timeoutMs, versionFileDiff?}`. The optional `versionFileDiff` parameter (type `VersionFileDiff | null`) provides parsed PR diff data as a fallback context source. Use `resolveUpstreamRepo()` to find the GitHub repo. Call `octokit.rest.repos.listReleases()` with `per_page: 20`. Filter releases between old and new version. Extract Kodi-relevant entries using `extractBreakingChanges()` from existing `dep-bump-enrichment.ts` (import it).

When changelog is unavailable (no releases found, API failure, or unknown repo): instead of returning empty highlights, check if `versionFileDiff` was provided. If so, synthesize a minimal changelog substitute in `highlights` from the parsed diff data:
- "Version: {oldVersion} → {newVersion}" (if both present)
- "SHA512 hash changed" (if old/new hashes differ)
- "Archive URL changed: {oldBaseUrl} → {newBaseUrl}" (if base URL changed)
- "Archive format changed: {oldArchive} → {newArchive}" (if archive changed)

Return `{source: "diff-analysis", highlights: [synthesized entries], breakingChanges: [], url: upstreamUrl, degradationNote: "Changelog unavailable — analysis derived from PR diff. Check [upstream](URL) for full release notes."}`.

If `versionFileDiff` is null/not provided AND changelog is unavailable, return `{source: "unavailable", highlights: [], breakingChanges: [], url: upstreamUrl, degradationNote: "Changelog unavailable -- check [upstream](URL) manually"}`.

**verifyHash(params)** -- Accept `{url, expectedSha512, timeoutMs}`. If no expectedSha512, return `{status: "skipped"}`. Fetch the URL with timeout, compute SHA512 using `node:crypto`. Compare. On fetch failure, return `{status: "unavailable"}`.

**detectPatchChanges(files: {filename: string; status: string}[])** -- Filter PR changed files for `*.patch` or `*.diff` files within `tools/depends/` paths. Map status to action.

All functions are fail-open: catch errors, return degradation results, never throw.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/lib/depends-bump-enrichment.test.ts 2>&1 | tail -10</automated>
  </verify>
  <done>All enrichment tests pass. VERSION file parsing, changelog fetching, hash verification, and patch detection all work correctly with graceful degradation.</done>
</task>

</tasks>

<verification>
- `bun test src/lib/depends-bump-enrichment.test.ts` -- all tests pass
- `parseVersionFileDiff()` correctly extracts old/new values from unified diffs
- `parseVersionFileContent()` resolves `$(VAR)` references
- `resolveUpstreamRepo()` finds known libraries, returns null for unknown
- `fetchDependsChangelog()` degrades gracefully on API failure
- `verifyHash()` handles all four status cases
- `detectPatchChanges()` identifies patch additions/removals
</verification>

<success_criteria>
1. VERSION file diffs parsed into structured old/new values
2. Upstream changelog fetched and filtered to Kodi-relevant entries
3. Hash verification works with SHA512 comparison
4. All functions fail-open with degradation notes
5. Patch file changes detected from PR diff
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/94-depends-pr-deep-review/94-02-SUMMARY.md`
</output>
