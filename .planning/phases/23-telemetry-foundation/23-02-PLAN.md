---
phase: 23-telemetry-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/types.ts
  - src/execution/executor.ts
autonomous: true

must_haves:
  truths:
    - "ExecutionResult includes model, inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens, and stopReason fields"
    - "On successful execution, token counts are summed from SDKResultMessage.modelUsage across all model entries"
    - "On error/timeout execution, token fields are undefined and model falls back to 'unknown'"
    - "Existing handler code that reads ExecutionResult (conclusion, costUsd, published, etc.) is unaffected"
  artifacts:
    - path: "src/execution/types.ts"
      provides: "ExecutionResult with TELEM-01 token fields"
      contains: "inputTokens"
    - path: "src/execution/executor.ts"
      provides: "SDK modelUsage extraction into ExecutionResult"
      contains: "modelUsage"
  key_links:
    - from: "src/execution/executor.ts"
      to: "SDKResultMessage.modelUsage"
      via: "Object.entries reduction"
      pattern: "modelUsage"
    - from: "src/execution/executor.ts"
      to: "src/execution/types.ts"
      via: "ExecutionResult return type"
      pattern: "ExecutionResult"
---

<objective>
Enrich ExecutionResult with per-model token data (inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens), model name, and stopReason extracted from the Claude Agent SDK's SDKResultMessage.

Purpose: TELEM-01 requires ExecutionResult to include full SDK data so handlers can pass it to the telemetry store. This plan adds the fields and extraction logic without changing any handler code.
Output: Updated ExecutionResult type and executor that populates the new fields.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-telemetry-foundation/23-RESEARCH.md
@src/execution/types.ts
@src/execution/executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add token fields to ExecutionResult type</name>
  <files>src/execution/types.ts</files>
  <action>
    Add the following optional fields to the ExecutionResult type:

    ```typescript
    /** Primary model used for execution (from SDK modelUsage keys) */
    model: string | undefined;
    /** Total input tokens across all models */
    inputTokens: number | undefined;
    /** Total output tokens across all models */
    outputTokens: number | undefined;
    /** Total cache read input tokens across all models */
    cacheReadTokens: number | undefined;
    /** Total cache creation input tokens across all models */
    cacheCreationTokens: number | undefined;
    /** SDK stop reason (e.g., "end_turn", "max_tokens") */
    stopReason: string | undefined;
    ```

    All new fields are `| undefined` to maintain backward compatibility -- existing code destructuring ExecutionResult will simply get undefined for these fields until handlers are updated.
  </action>
  <verify>`bunx tsc --noEmit` passes with no type errors. Existing tests still pass: `bun test`.</verify>
  <done>ExecutionResult type has all six TELEM-01 fields as optional properties.</done>
</task>

<task type="auto">
  <name>Task 2: Extract SDK modelUsage into ExecutionResult in executor</name>
  <files>src/execution/executor.ts</files>
  <action>
    In the executor's `execute()` method, update the two return paths that have a `resultMessage`:

    **Success path (line ~162, where `resultMessage` exists):**
    After `const durationMs = Date.now() - startTime;` and before the return statement, add token extraction:

    ```typescript
    // Extract token usage from SDK result (TELEM-01)
    const modelEntries = Object.entries(resultMessage.modelUsage ?? {});
    const primaryModel = modelEntries[0]?.[0] ?? "unknown";
    const totalInput = modelEntries.reduce((sum, [, u]) => sum + u.inputTokens, 0);
    const totalOutput = modelEntries.reduce((sum, [, u]) => sum + u.outputTokens, 0);
    const totalCacheRead = modelEntries.reduce((sum, [, u]) => sum + u.cacheReadInputTokens, 0);
    const totalCacheCreation = modelEntries.reduce((sum, [, u]) => sum + u.cacheCreationInputTokens, 0);
    ```

    Then update the return object to include:
    ```typescript
    model: primaryModel,
    inputTokens: totalInput,
    outputTokens: totalOutput,
    cacheReadTokens: totalCacheRead,
    cacheCreationTokens: totalCacheCreation,
    stopReason: resultMessage.stop_reason ?? undefined,
    ```

    **No-resultMessage path (line ~152):** Add `model: undefined, inputTokens: undefined, outputTokens: undefined, cacheReadTokens: undefined, cacheCreationTokens: undefined, stopReason: undefined` to the return.

    **Error/timeout catch paths (line ~178 and ~196):** Add same undefined fields. These paths already return `costUsd: undefined` etc., so add the new fields as `undefined` consistently.

    NOTE: The `ModelUsage` type from the SDK has `inputTokens`, `outputTokens`, `cacheReadInputTokens`, `cacheCreationInputTokens` (not camelCase cache*). Verify against the SDK types at `node_modules/@anthropic-ai/claude-agent-sdk/sdk.d.ts` line 418-427 if needed. The type is: `{ inputTokens: number, outputTokens: number, cacheReadInputTokens: number, cacheCreationInputTokens: number, webSearchRequests: number, costUSD: number, contextWindow: number, maxOutputTokens: number }`.
  </action>
  <verify>`bunx tsc --noEmit` passes. `bun test` passes (all existing tests). Check that the executor return paths all include the new fields by grepping: `grep -n "model:" src/execution/executor.ts` should show 3-4 occurrences (success, no-result, timeout, error).</verify>
  <done>All executor return paths populate the six TELEM-01 fields. Success path sums tokens from modelUsage. Error paths return undefined. No handler code changed.</done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` compiles cleanly
- `bun test` -- all existing tests pass (no regressions)
- `grep -c "model:" src/execution/executor.ts` shows the new field in all return paths
- ExecutionResult type in types.ts includes all six new fields
</verification>

<success_criteria>
- ExecutionResult has model, inputTokens, outputTokens, cacheReadTokens, cacheCreationTokens, stopReason
- Executor extracts real values from SDKResultMessage on success, undefined on error
- Zero handler changes -- fully backward compatible
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/23-telemetry-foundation/23-02-SUMMARY.md`
</output>
