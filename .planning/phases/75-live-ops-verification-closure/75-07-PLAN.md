---
phase: 75-live-ops-verification-closure
plan: 07
type: execute
wave: 7
depends_on: [75-06]
files_modified:
  - scripts/phase75-live-ops-verification-closure.ts
  - docs/runbooks/review-requested-debug.md
autonomous: true
gap_closure: true
requirements: [OPS-04, OPS-05]

must_haves:
  truths:
    - "OPS75-CACHE-02 check is removed or rescoped because the mention handler does not use Search API cache and never emits rate_limit_events rows"
    - "OPS75 verifier accepts review-only cache evidence without requiring mention-lane rate_limit_events rows that the codebase never produces"
    - "Operator runbook documents exact steps to trigger cache-hit and degraded review runs for fresh OPS75 evidence capture"
  artifacts:
    - path: "scripts/phase75-live-ops-verification-closure.ts"
      provides: "Verifier with mention-lane cache check removed since mention handler has no Search cache codepath"
      contains: "OPS75-CACHE-01"
    - path: "docs/runbooks/review-requested-debug.md"
      provides: "Operator trigger procedure for cache-hit and degraded production runs"
      contains: "Cache-Hit Trigger"
  key_links:
    - from: "scripts/phase75-live-ops-verification-closure.ts"
      to: "src/handlers/review.ts"
      via: "Verifier cache checks are scoped to review_requested surface only, matching where Search cache telemetry is emitted"
      pattern: "OPS75-CACHE-01"
    - from: "docs/runbooks/review-requested-debug.md"
      to: "scripts/phase75-live-ops-verification-closure.ts"
      via: "Trigger procedure feeds identities into verifier arguments"
      pattern: "--review|--degraded"
---

<objective>
Fix OPS75 verifier scope mismatch and provide operator trigger procedure for remaining production evidence gaps.

Purpose: OPS75-CACHE-02 checks mention-lane rate_limit_events rows, but the mention handler (`src/handlers/mention.ts`) does not use Search API author classification and never calls `recordRateLimitEvent`. This is a verifier scope error, not a production data gap. Removing this invalid check and simplifying the matrix to review-only cache evidence unblocks closure. Additionally, the operator needs a documented procedure to trigger cache-hit and degraded review runs.

Output: Corrected verifier script and operator trigger runbook enabling fresh evidence capture.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/75-live-ops-verification-closure/75-06-SUMMARY.md
@scripts/phase75-live-ops-verification-closure.ts
@src/handlers/review.ts (lines 1628-1700, rate_limit_events emission)
@src/handlers/mention.ts (confirm: no recordRateLimitEvent calls)
@docs/runbooks/review-requested-debug.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove OPS75-CACHE-02 mention-lane cache check and simplify verifier to review-only cache evidence</name>
  <files>scripts/phase75-live-ops-verification-closure.ts</files>
  <action>
The mention handler (`src/handlers/mention.ts`) does not call `recordRateLimitEvent` and has no Search API cache codepath. The verifier's OPS75-CACHE-02 check requires mention-lane rate_limit_events rows that the codebase never produces. Fix by:

1. Remove the `--mention` CLI argument requirement and the mention lane from `buildDeterministicMatrix`. The `--mention` flag should be removed from `parseArgs`, `asOutcomeRecord` call for mention, `printUsage`, and the matrix builder.
2. Remove the `kodiai_mention` surface from the cache check loop in `evaluateClosureVerification`. Only `review_requested` cache checks (OPS75-CACHE-01) should remain.
3. Update `validateDeterministicMatrix` to only validate `review_requested` surface ordering (remove `kodiai_mention` from the surfaces array).
4. Update `MatrixStep` types and `buildDeterministicMatrix` to only produce review-lane steps.
5. Remove `--mention-event-type` CLI option since it's no longer needed.
6. Update the `printUsage` help text to remove mention-related flags and explain that cache checks are scoped to the review handler which is where Search API cache telemetry is emitted.
7. Keep all other check families unchanged: OPS75-PREFLIGHT-01, OPS75-ONCE-01, OPS75-ONCE-02, OPS75-FAILOPEN-01, OPS75-FAILOPEN-02.

Do NOT rename OPS75-CACHE-01 -- it keeps its existing ID. Simply remove OPS75-CACHE-02 entirely.

Verify the verifier still compiles and the exported types/functions remain valid for test imports.
  </action>
  <verify>
Run `bun run scripts/phase75-live-ops-verification-closure.ts --help` and confirm: no `--mention` flag, no `--mention-event-type`, OPS75-CACHE-02 not listed, OPS75-CACHE-01 still listed. Run existing tests if any: `bun test scripts/phase75-live-ops-verification-closure.test.ts` (may not exist).
  </verify>
  <done>
Verifier accepts review-only cache evidence with no mention-lane cache check. OPS75-CACHE-02 is removed. Remaining checks: OPS75-PREFLIGHT-01, OPS75-CACHE-01, OPS75-ONCE-01, OPS75-ONCE-02, OPS75-FAILOPEN-01, OPS75-FAILOPEN-02.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add operator trigger procedure for cache-hit and degraded review runs to runbook</name>
  <files>docs/runbooks/review-requested-debug.md</files>
  <action>
Add a new section to the runbook documenting how an operator triggers the production runs needed for OPS75 closure evidence:

**Cache-Hit Trigger Procedure:**
1. Find a PR with an existing `review_requested` telemetry row (review prime run).
2. Re-request review on the same PR for the same author within the Search cache TTL window. This produces a second delivery_id where `searchCacheHit=true` (cache_hit_rate=1).
3. Record both delivery_ids: prime (cache_hit_rate=0) and hit (cache_hit_rate=1).
4. For the changed-query-miss lane, re-request review on a different PR by a different author so the Search query differs.

**Degraded Run Trigger Procedure:**
1. Use the existing `scripts/phase73-trigger-degraded-review.ts` script to trigger rapid Search API requests that exhaust the 30/min rate limit.
2. Record the delivery_id of the review that runs under degradation (degradation_path != "none").
3. Verify the row exists in rate_limit_events before feeding it to the verifier.

**Updated Verifier Command (no --mention flags):**
Document the new simplified verifier invocation without `--mention` arguments:
```
bun run scripts/phase75-live-ops-verification-closure.ts \
  --review <prime> --review <hit> --review <changed> \
  --review-accepted <prime> --review-accepted <hit> --review-accepted <changed> \
  --degraded <delivery:event-type> \
  --failopen <delivery:event-type>
```

Update the preflight SQL section to remove mention-lane identity queries. Keep review-lane, degraded, and fail-open identity selection SQL unchanged.

Remove references to OPS75-CACHE-02 from the runbook. Update the check-ID reference table.
  </action>
  <verify>
Read the updated runbook and confirm: no mention-lane identity queries, cache-hit trigger procedure documented, degraded trigger procedure documented, verifier command has no --mention flags, OPS75-CACHE-02 not referenced.
  </verify>
  <done>
Runbook provides complete operator trigger procedure for producing cache-hit and degraded production evidence needed by the simplified OPS75 verifier.
  </done>
</task>

</tasks>

<verification>
- `bun run scripts/phase75-live-ops-verification-closure.ts --help` shows no mention flags and no OPS75-CACHE-02.
- Verifier script compiles without errors: `bun build scripts/phase75-live-ops-verification-closure.ts --no-bundle`.
- Runbook contains cache-hit and degraded trigger procedures with exact steps.
- All remaining check IDs (PREFLIGHT-01, CACHE-01, ONCE-01, ONCE-02, FAILOPEN-01, FAILOPEN-02) are documented.
</verification>

<success_criteria>
OPS75 verifier no longer requires mention-lane rate_limit_events that the codebase never produces, and operator has a documented procedure to trigger the remaining production evidence (cache-hit and degraded review runs).
</success_criteria>

<output>
After completion, create `.planning/phases/75-live-ops-verification-closure/75-07-SUMMARY.md`
</output>
