---
phase: 75-live-ops-verification-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telemetry/types.ts
  - src/telemetry/store.ts
  - src/telemetry/store.test.ts
  - src/index.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "Operators can deterministically trigger telemetry write-failure behavior for selected degraded execution identities without changing normal production behavior"
    - "A degraded execution still reaches normal completion output when rate-limit telemetry persistence fails"
    - "Failure-injected degraded runs still attempt one telemetry emission identity and do not create duplicate telemetry rows"
    - "No auto re-review on push and no unsolicited-response behavior is introduced while adding verification controls"
  artifacts:
    - path: "src/telemetry/store.ts"
      provides: "Deterministic, phase-scoped failure injection path for rate-limit telemetry writes keyed by execution identity"
      contains: "recordRateLimitEvent"
    - path: "src/handlers/review.ts"
      provides: "Fail-open degraded completion behavior when telemetry writes throw"
      contains: "recordRateLimitEvent"
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage proving completion still succeeds under telemetry write failure and duplicate emission is prevented"
      contains: "degraded"
  key_links:
    - from: "src/index.ts"
      to: "src/telemetry/store.ts"
      via: "runtime wiring exposes deterministic verification-only failure controls"
      pattern: "telemetry|failure|delivery"
    - from: "src/handlers/review.ts"
      to: "src/telemetry/store.ts"
      via: "single degraded emission call remains fail-open when persistence throws"
      pattern: "recordRateLimitEvent|catch"
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/review.ts"
      via: "tests assert one-emission identity and completion despite injected store failure"
      pattern: "degraded|telemetry|complete"
---

<objective>
Add deterministic runtime hooks and regressions that let operators reproduce OPS-05 fail-open telemetry-write failure behavior with execution-identity precision.

Purpose: Phase 75 requires live evidence for exactly-once degraded telemetry and non-blocking completion under persistence faults, not only code-level confidence.
Output: Verification-safe telemetry failure-injection controls plus regression coverage proving degraded executions complete without duplicate telemetry writes.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/72-telemetry-follow-through/72-02-SUMMARY.md
@.planning/phases/72-telemetry-follow-through/72-VERIFICATION.md
@.planning/phases/74-reliability-regression-gate/74-02-SUMMARY.md
@src/telemetry/store.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic telemetry failure-injection controls for live degraded verification identities</name>
  <files>src/telemetry/types.ts, src/telemetry/store.ts, src/index.ts, src/handlers/review.ts</files>
  <action>
Implement a verification-only failure-injection path for rate-limit telemetry persistence that is deterministic and identity-scoped:

- Add a typed telemetry-store option sourced from runtime environment/config that accepts an explicit allow-list of execution identities (delivery IDs or equivalent deterministic run IDs) that should force `recordRateLimitEvent` to fail.
- Keep default behavior unchanged when the allow-list is empty/unset; this must remain opt-in and safe for regular production operation.
- Ensure forced failures happen at the telemetry persistence boundary only (do not alter degraded detection logic, review trigger conditions, or publish path behavior).
- Preserve existing fail-open handler semantics so review completion/publish continues even when telemetry write fails.
- Emit structured warning logs with identity context for operator evidence capture, but do not add noisy or ambiguous wording.
- Keep user policies intact: no auto re-review on push and no unsolicited responses.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bun test src/telemetry/store.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Operators have a deterministic, identity-scoped way to force telemetry write failures during degraded runs, and normal runtime behavior stays unchanged when failure injection is disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Lock regression coverage for exactly-once degraded telemetry emission and fail-open completion under injected failures</name>
  <files>src/telemetry/store.test.ts, src/handlers/review.test.ts</files>
  <action>
Add regression tests that prove OPS-05 closure behavior under injected telemetry persistence failures:

- Verify forced telemetry failure does not block degraded execution completion/publish.
- Verify degraded flow emits one telemetry event identity per execution even when persistence fails (no duplicate retry writes for the same identity).
- Verify duplicate identity replays remain idempotent via existing composite uniqueness behavior.
- Verify warning/evidence logging contains deterministic identity fields needed by live verification scripts.
- Keep tests focused on degraded search-rate-limit paths so unrelated review flows are unchanged.
  </action>
  <verify>
Run `bun test src/telemetry/store.test.ts --timeout 30000`.
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bun test`.
  </verify>
  <done>
Automated regressions fail on any reintroduction of duplicate degraded telemetry writes, blocked completion during telemetry persistence failure, or loss of identity-scoped evidence signals.
  </done>
</task>

</tasks>

<verification>
- `bun test src/telemetry/store.test.ts --timeout 30000` passes with forced-failure and idempotency assertions.
- `bun test src/handlers/review.test.ts --timeout 30000` passes with degraded completion-under-failure assertions.
- `bunx tsc --noEmit` passes.
- Existing trigger behavior remains unchanged (no unsolicited responses, no auto re-review on push).
</verification>

<success_criteria>
Phase 75 execution has deterministic runtime controls and tests proving that degraded telemetry persistence failures are reproducible by identity, emitted telemetry stays exactly-once per degraded execution identity, and user-visible completion remains fail-open.
</success_criteria>

<output>
After completion, create `.planning/phases/75-live-ops-verification-closure/75-01-SUMMARY.md`
</output>
