---
phase: 38-delta-re-review-formatting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Re-reviews with prior findings produce a delta template instead of the five-section template"
    - "The delta template has sections: Re-review header, What Changed, New Findings, Resolved Findings, Still Open, Verdict Update"
    - "Prior findings are listed in the prompt so Claude can classify findings as new/resolved/still-open"
    - "Delta verdict describes transition (New blockers found / Blockers resolved / Still ready), not absolute state"
    - "Initial reviews are unaffected -- still use the five-section template"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "DeltaReviewContext type, buildDeltaReviewContext(), buildDeltaVerdictLogicSection(), conditional delta template in buildReviewPrompt()"
      exports: ["DeltaReviewContext", "buildDeltaReviewContext", "buildDeltaVerdictLogicSection"]
    - path: "src/handlers/review.ts"
      provides: "Hoisted priorFindings variable, deltaContext passed to buildReviewPrompt()"
      contains: "deltaContext:"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for delta template path and initial review unchanged"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "deltaContext parameter in buildReviewPrompt() call"
      pattern: "deltaContext:"
    - from: "src/execution/review-prompt.ts"
      to: "buildDeltaReviewContext"
      via: "called when deltaContext is present"
      pattern: "buildDeltaReviewContext"
---

<objective>
Add a delta-focused re-review template to the prompt builder that replaces the standard five-section template when incremental re-review data is available, and thread the delta context from review.ts to the prompt builder.

Purpose: Re-reviews currently use the same five-section template as initial reviews, repeating all findings even when most are unchanged. This plan adds a distinct delta template (What Changed, New Findings, Resolved Findings, Still Open, Verdict Update) that focuses maintainer attention on what actually changed.

Output: `buildReviewPrompt()` conditionally produces the delta template when `deltaContext` is provided; `review.ts` passes hoisted prior findings to the prompt builder; new tests verify both paths.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-delta-re-review-formatting/38-RESEARCH.md
@src/execution/review-prompt.ts
@src/handlers/review.ts
@src/knowledge/types.ts
@src/lib/delta-classifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delta template types, helpers, and conditional template in buildReviewPrompt</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
Add the following to `src/execution/review-prompt.ts`:

1. **DeltaReviewContext type** (export, near the top with other types):
```typescript
export type DeltaReviewContext = {
  lastReviewedHeadSha: string;
  changedFilesSinceLastReview: string[];
  priorFindings: Array<{
    filePath: string;
    title: string;
    severity: string;
    category: string;
  }>;
};
```

2. **buildDeltaReviewContext() helper** (exported, near buildIncrementalReviewSection):
- Accepts `params: { lastReviewedHeadSha: string; changedFilesSinceLastReview: string[]; priorFindings: DeltaReviewContext['priorFindings'] }`
- Returns a string with "## Delta Review Context" section containing:
  - Statement that this is a re-review with prior SHA (7-char)
  - Changed files list (capped at 50)
  - Prior findings list (capped at 30) with instruction to classify each as NEW/RESOLVED/STILL OPEN
- See research Pattern 2 for exact format

3. **buildDeltaVerdictLogicSection() helper** (exported):
- Returns "## Verdict Update Logic" section with these rules:
  - Count new CRITICAL/MAJOR findings in New Findings
  - New blockers > 0: `:yellow_circle:` **New blockers found** -- Address [N] new issue(s)
  - New blockers == 0 AND prior blockers resolved (Resolved Findings has CRITICAL/MAJOR): `:green_circle:` **Blockers resolved** -- Ready to merge
  - New blockers == 0 AND no prior blockers resolved: `:large_blue_circle:` **Still ready** -- No new issues
  - Explain the emoji meaning: green = improved, blue = unchanged (still good), yellow = worsened

4. **Add `deltaContext` parameter** to `buildReviewPrompt()` context type:
```typescript
deltaContext?: DeltaReviewContext | null;
```

5. **Conditional delta template** in the summary comment section (around line 944-1026). The `if (mode === "enhanced")` branch stays unchanged. In the `else` (standard mode) branch, add an outer check: if `context.deltaContext` is present, use the delta template; otherwise use the existing five-section template unchanged.

The delta template branch should:
- Call `buildDeltaReviewContext(context.deltaContext)` and push it to lines BEFORE the summary comment section
- Push the delta summary comment template with `<summary>Kodiai Re-Review Summary</summary>` (NOT "Kodiai Review Summary")
- Include sections: `## Re-review -- Changes since {sha7}`, `## What Changed`, `## New Findings` (with `:new:` badge examples), `## Resolved Findings` (with `:white_check_mark:` badge examples), `## Still Open` (count + expandable details list), `## Verdict Update` (three states)
- Push `buildDeltaVerdictLogicSection()` after the template
- Push delta-specific hard requirements:
  - Use `<summary>Kodiai Re-Review Summary</summary>` (NOT 'Kodiai Review Summary')
  - `## Re-review` header REQUIRED with prior SHA reference
  - `## What Changed` REQUIRED
  - `## Verdict Update` REQUIRED
  - `## New Findings`, `## Resolved Findings`, `## Still Open` each OPTIONAL but at least one must be present
  - Omit empty sections entirely (do NOT write empty section placeholders)
  - Do NOT repeat still-open findings in `## New Findings`
  - Still-open findings appear ONLY in `## Still Open` as count + expandable `<details>` list
  - New findings use `:new:` badge before severity tag
  - Resolved findings use `:white_check_mark:` badge and append " -- resolved"
  - Still-open findings show severity and file path but NOT line numbers (stale)
- The "After review" section for delta mode should say: "If you found changes to report (new, resolved, or still-open findings): post the delta summary (wrapped in `<details>`) first, then post inline comments ONLY for new findings. If the delta produces nothing to report: do nothing."

CRITICAL: The existing five-section template code must remain COMPLETELY unchanged -- only wrap it in the else branch of the deltaContext check. All existing tests for the five-section template must continue passing.
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all existing tests must pass (zero regressions in five-section template path)</verify>
  <done>buildReviewPrompt() with deltaContext=null produces identical output to before; buildReviewPrompt() with deltaContext produces a delta template with Re-Review Summary header, delta sections, and delta verdict logic</done>
</task>

<task type="auto">
  <name>Task 2: Thread deltaContext from review.ts and add prompt tests</name>
  <files>src/handlers/review.ts, src/execution/review-prompt.test.ts</files>
  <action>
**In `src/handlers/review.ts`:**

1. Hoist the `priorFindings` variable. Currently (around line 1097), `const priorFindings = knowledgeStore.getPriorReviewFindings(...)` is scoped inside the `if (knowledgeStore && incrementalResult?.mode === "incremental")` block. Change this to:
   - Declare `let priorFindings: PriorFinding[] = [];` BEFORE the block (at the same scope level as `priorFindingCtx` on line 1094)
   - Inside the block, change `const priorFindings =` to just `priorFindings =`
   - This makes `priorFindings` available at the `buildReviewPrompt()` call site

2. Add `deltaContext` to the `buildReviewPrompt()` call (around line 1191-1225). After the `prLabels` parameter, add:
```typescript
// Delta re-review context (FORMAT-14/15/16)
deltaContext: incrementalResult?.mode === "incremental" && priorFindings.length > 0
  ? {
      lastReviewedHeadSha: incrementalResult.lastReviewedHeadSha!,
      changedFilesSinceLastReview: incrementalResult.changedFilesSinceLastReview,
      priorFindings: priorFindings.map(f => ({
        filePath: f.filePath,
        title: f.title,
        severity: f.severity,
        category: f.category,
      })),
    }
  : null,
```

Import `DeltaReviewContext` from review-prompt.ts if needed (the type inference from the inline object should suffice, but add explicit import if TypeScript requires it).

**In `src/execution/review-prompt.test.ts`:**

Add a new `describe("Phase 38: Delta Re-Review Formatting")` block with these tests:

1. "buildDeltaReviewContext includes prior findings and changed files" -- call the helper with sample data, verify output contains "## Delta Review Context", the SHA snippet, file list, prior findings list with severity tags
2. "buildDeltaVerdictLogicSection includes three delta verdict states" -- verify output contains "Verdict Update Logic", `:green_circle:`, `:yellow_circle:`, `:large_blue_circle:`, "New blockers found", "Blockers resolved", "Still ready"
3. "buildReviewPrompt with deltaContext produces delta template" -- call buildReviewPrompt with a valid deltaContext, verify output contains "Kodiai Re-Review Summary", "## Re-review", "## What Changed", "## Verdict Update", `:new:`, `:white_check_mark:`, and does NOT contain "Kodiai Review Summary" (without "Re-")
4. "buildReviewPrompt without deltaContext produces standard template" -- call buildReviewPrompt without deltaContext (null), verify output contains "Kodiai Review Summary" and does NOT contain "Kodiai Re-Review Summary"
5. "delta template hard requirements include section rules" -- verify deltaContext output contains "## New Findings" in hard requirements, "## Resolved Findings", "## Still Open", "at least one must be present"
6. "delta template omits Impact/Preference subsections" -- verify deltaContext output does NOT contain "### Impact" or "### Preference" in the hard requirements section
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all tests pass including new Phase 38 tests. Run `bun test src/handlers/review.test.ts` -- all existing tests pass (priorFindings hoist is backward compatible).</verify>
  <done>review.ts passes deltaContext to buildReviewPrompt when incremental mode with prior findings; 6 new tests verify delta template generation, helpers, and non-regression of standard template</done>
</task>

</tasks>

<verification>
1. `bun test src/execution/review-prompt.test.ts` -- all tests pass including Phase 38 block
2. `bun test src/handlers/review.test.ts` -- all existing tests pass (no regression from priorFindings hoist)
3. `bun test` -- full test suite passes
4. Verify buildReviewPrompt with deltaContext=null produces identical output to before (standard five-section template)
5. Verify buildReviewPrompt with deltaContext produces delta template with Re-Review Summary, delta sections, delta verdict logic
</verification>

<success_criteria>
- buildReviewPrompt() conditionally produces delta or standard template based on deltaContext presence
- DeltaReviewContext type, buildDeltaReviewContext, buildDeltaVerdictLogicSection are exported
- review.ts threads priorFindings and deltaContext to prompt builder
- All existing tests pass (zero regressions)
- 6+ new tests cover delta template path
</success_criteria>

<output>
After completion, create `.planning/phases/38-delta-re-review-formatting/38-01-SUMMARY.md`
</output>
