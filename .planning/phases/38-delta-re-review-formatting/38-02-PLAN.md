---
phase: 38-delta-re-review-formatting
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Delta re-review summaries are validated by a dedicated sanitizer that checks delta template structure"
    - "Initial review summaries continue to be validated by the existing five-section sanitizer"
    - "The sanitizer discriminates between initial and delta templates using the <summary> tag content"
    - "Delta sanitizer requires Re-review header, What Changed, and Verdict Update; at least one of New Findings/Resolved Findings/Still Open"
    - "Delta verdict format is validated as ':emoji: **Label** -- explanation' with delta-specific emojis"
  artifacts:
    - path: "src/execution/mcp/comment-server.ts"
      provides: "sanitizeKodiaiReReviewSummary() function with delta template validation"
      contains: "sanitizeKodiaiReReviewSummary"
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Tests for delta sanitizer validation paths"
  key_links:
    - from: "src/execution/mcp/comment-server.ts"
      to: "sanitizeKodiaiReReviewSummary"
      via: "discriminator branch on <summary> tag content"
      pattern: "Kodiai Re-Review Summary"
---

<objective>
Add a delta re-review sanitizer that validates the delta template structure (distinct from the initial review five-section sanitizer), with discriminator routing based on the summary tag content.

Purpose: The delta template has different required sections, different verdict format, and no Impact/Preference subsections. The sanitizer must validate these constraints without breaking the existing five-section validator for initial reviews.

Output: `sanitizeKodiaiReReviewSummary()` validates delta template structure; the existing `sanitizeKodiaiReviewSummary()` call chain routes to the correct validator based on `<summary>` tag content; comprehensive tests cover both happy and error paths.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-delta-re-review-formatting/38-RESEARCH.md
@.planning/phases/38-delta-re-review-formatting/38-01-SUMMARY.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/comment-server.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanitizeKodiaiReReviewSummary and wire discriminator routing</name>
  <files>src/execution/mcp/comment-server.ts</files>
  <action>
Add a `sanitizeKodiaiReReviewSummary()` function in `comment-server.ts`, placed near the existing `sanitizeKodiaiReviewSummary()` function.

**sanitizeKodiaiReReviewSummary(body: string): string**

1. **Early exit:** If `body` does not contain `<summary>Kodiai Re-Review Summary</summary>`, return body unchanged.

2. **Required sections validation:**
   - `## Re-review` -- REQUIRED (the header with SHA reference)
   - `## What Changed` -- REQUIRED
   - `## Verdict Update` -- REQUIRED
   - Throw descriptive errors if any are missing: `"Invalid Kodiai re-review summary: missing required section '## X'"`

3. **Delta sections validation:**
   - At least one of: `## New Findings`, `## Resolved Findings`, `## Still Open`
   - Throw if none present: `"Invalid Kodiai re-review summary: must contain at least one of: New Findings, Resolved Findings, Still Open"`

4. **No forbidden sections:**
   - Must NOT contain `## Observations`, `## Strengths`, `## Suggestions`, `## Verdict` (without "Update")
   - Check: if body contains `## Verdict` but NOT `## Verdict Update`, throw error (to catch the initial review verdict section leaking in)
   - If body contains `## Observations`, throw: `"Invalid Kodiai re-review summary: unexpected section '## Observations'. Delta template uses New Findings/Resolved Findings/Still Open"`
   - If body contains `## Strengths` or `## Suggestions`, throw similarly

5. **Verdict Update format validation:**
   - Find the `## Verdict Update` section content
   - Validate that a line matches: `/^:(green_circle|yellow_circle|large_blue_circle): \*\*[^*]+\*\* -- .+$/m`
   - Throw if no match: `"Invalid Kodiai re-review summary: Verdict Update must use format ':emoji: **Label** -- explanation' with delta verdict emojis (green_circle, yellow_circle, large_blue_circle)"`

6. **No extra top-level headings:**
   - Allowed `##` headings: `## Re-review`, `## What Changed`, `## New Findings`, `## Resolved Findings`, `## Still Open`, `## Verdict Update`
   - Any other `## X` heading triggers: `"Invalid Kodiai re-review summary: unexpected section '## X'. Only use: Re-review, What Changed, New Findings, Resolved Findings, Still Open, Verdict Update"`
   - Note: `## Re-review` matches with regex `^## Re-review` to handle the full header like `## Re-review -- Changes since abc1234`

Return the validated body unchanged (no stripping needed for delta template -- no legacy content patterns).

**Wire discriminator routing:**

Update the two places where `sanitizeKodiaiReviewSummary()` is called (in `update_comment` and `create_comment` tool handlers). The call chain currently is:
```
sanitizeKodiaiReviewSummary(sanitizeKodiaiDecisionResponse(body))
```

Change to:
```
sanitizeKodiaiReReviewSummary(sanitizeKodiaiReviewSummary(sanitizeKodiaiDecisionResponse(body)))
```

This works because:
- `sanitizeKodiaiDecisionResponse` only acts on decision responses (passes through others)
- `sanitizeKodiaiReviewSummary` only acts on initial review summaries (checks for `Kodiai Review Summary`, passes through others including re-reviews)
- `sanitizeKodiaiReReviewSummary` only acts on re-review summaries (checks for `Kodiai Re-Review Summary`, passes through others)

The discriminators are mutually exclusive: `Kodiai Review Summary` vs `Kodiai Re-Review Summary`. A body can only match one.

CRITICAL: Do NOT modify the existing `sanitizeKodiaiReviewSummary()` function. It must remain exactly as is for initial review validation.
  </action>
  <verify>Run `bun test src/execution/mcp/comment-server.test.ts` -- all existing tests pass (zero regressions). Run `bun test` to verify no type errors.</verify>
  <done>sanitizeKodiaiReReviewSummary validates delta template structure; discriminator chain routes correctly; existing initial review sanitizer is unchanged</done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive delta sanitizer tests</name>
  <files>src/execution/mcp/comment-server.test.ts</files>
  <action>
Add a new `describe("Phase 38: Delta Re-Review Sanitizer")` block in `comment-server.test.ts`.

Create a `buildTestReReviewSummary()` helper (similar to the existing `buildTestSummary()` for initial reviews) that builds a valid delta re-review body:
```
<details>
<summary>Kodiai Re-Review Summary</summary>

## Re-review -- Changes since abc1234

## What Changed
Fixed the authentication bug and updated error handling.

## New Findings
:new: [MAJOR] src/auth.ts (42): SQL injection in login query
Parameterized queries should be used instead of string concatenation.

## Resolved Findings
:white_check_mark: [CRITICAL] src/auth.ts: Hardcoded secret key -- resolved

## Still Open
1 finding(s) from the previous review remain open.

<details>
<summary>View still-open findings</summary>

- [MEDIUM] src/utils.ts: Missing null check

</details>

## Verdict Update
:yellow_circle: **New blockers found** -- Address 1 new issue(s)

</details>
```

Allow the helper to accept optional overrides (e.g., omit certain sections, change verdict, etc.) for flexible test construction.

**Tests to add:**

**Happy paths:**
1. "valid delta re-review summary passes through unchanged" -- full valid body passes sanitizer
2. "valid delta with only New Findings (no Resolved/Still Open) passes" -- omit Resolved and Still Open sections
3. "valid delta with only Resolved Findings passes" -- omit New Findings and Still Open
4. "valid delta with only Still Open passes" -- omit New Findings and Resolved Findings
5. "delta with green verdict (Blockers resolved) passes" -- `:green_circle: **Blockers resolved** -- Ready to merge`
6. "delta with blue verdict (Still ready) passes" -- `:large_blue_circle: **Still ready** -- No new issues`
7. "non-re-review body passes through unchanged" -- a regular comment body is returned as-is

**Error paths:**
8. "rejects delta missing ## Re-review header" -- remove `## Re-review` line
9. "rejects delta missing ## What Changed" -- remove `## What Changed` section
10. "rejects delta missing ## Verdict Update" -- remove `## Verdict Update` section
11. "rejects delta with no delta sections" -- remove all three of New Findings, Resolved Findings, Still Open
12. "rejects delta with initial review ## Observations section" -- add `## Observations` heading
13. "rejects delta with initial review ## Strengths section" -- add `## Strengths` heading
14. "rejects delta with initial review ## Verdict (without Update)" -- add `## Verdict` heading (not `## Verdict Update`)
15. "rejects delta with invalid verdict emoji" -- use `:red_circle:` instead of the allowed delta emojis
16. "rejects delta with unexpected ## heading" -- add an unknown heading like `## Summary`

**Discrimination:**
17. "initial review summary still validated by five-section sanitizer (not delta)" -- a valid initial review body with `Kodiai Review Summary` passes the initial sanitizer and also passes through the delta sanitizer (no interference)
18. "delta body does not trigger initial review sanitizer" -- a valid delta body passes through the initial sanitizer unchanged (the initial sanitizer's early exit returns it)

Each test should use the MCP server's create_comment or update_comment tool through the test harness to exercise the full sanitizer chain, OR test the sanitizer function directly if it's accessible. Follow the existing test patterns in the file.
  </action>
  <verify>Run `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass including Phase 38 tests. Run `bun test` -- full suite passes.</verify>
  <done>18+ tests cover delta sanitizer happy paths, error paths, and discrimination between initial and delta templates; all existing tests pass</done>
</task>

</tasks>

<verification>
1. `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass including Phase 38 block
2. `bun test src/execution/review-prompt.test.ts` -- all tests pass (no regression)
3. `bun test src/handlers/review.test.ts` -- all tests pass (no regression)
4. `bun test` -- full test suite passes
5. Verify that a valid initial review body is not affected by the delta sanitizer
6. Verify that a valid delta body is not affected by the initial review sanitizer
</verification>

<success_criteria>
- sanitizeKodiaiReReviewSummary() validates delta template structure
- Discriminator chain correctly routes initial vs delta templates
- Delta sanitizer checks: required sections, at least one delta section, no forbidden sections, verdict format
- Existing initial review sanitizer is completely unchanged
- 18+ tests cover all validation paths
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/38-delta-re-review-formatting/38-02-SUMMARY.md`
</output>
