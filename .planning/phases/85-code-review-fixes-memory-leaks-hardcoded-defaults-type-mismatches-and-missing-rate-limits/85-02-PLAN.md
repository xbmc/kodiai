---
phase: 85-code-review-fixes-memory-leaks-hardcoded-defaults-type-mismatches-and-missing-rate-limits
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/repo-context.ts
  - src/slack/repo-context.test.ts
  - src/config.ts
  - src/enforcement/tooling-detection.ts
  - src/enforcement/index.ts
  - src/lib/dep-bump-enrichment.ts
  - src/telemetry/store.ts
  - src/slack/client.ts
  - src/routes/slack-events.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "Slack repo context default is loaded from config, not hardcoded"
    - "Tooling detection uses structured logger instead of console.warn"
    - "Dep-bump-enrichment has typed Octokit calls instead of any casts"
    - "Telemetry purge uses DELETE with COUNT instead of RETURNING"
    - "Slack client has configurable request timeout"
    - "Slack event processing has basic rate limiting"
  artifacts:
    - path: "src/slack/repo-context.ts"
      provides: "Config-driven default repo"
      contains: "defaultRepo"
    - path: "src/enforcement/tooling-detection.ts"
      provides: "Structured logger usage"
      contains: "logger.warn"
    - path: "src/telemetry/store.ts"
      provides: "Optimized purge queries"
      contains: "changes()"
  key_links:
    - from: "src/slack/repo-context.ts"
      to: "src/config.ts"
      via: "defaultRepo config parameter"
      pattern: "defaultRepo"
---

<objective>
Fix critical hardcoded default repo, replace console.warn with structured logging, eliminate unsafe `any` casts, optimize telemetry purge queries, add Slack client timeout, and add basic Slack event rate limiting. Addresses C-1, H-4, H-5, H-8, H-10, M-2.

Purpose: Eliminate production bugs (wrong repo), improve observability (structured logs), strengthen type safety, and add operational guardrails.
Output: 6 files fixed with targeted surgical changes.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/slack/repo-context.ts
@src/enforcement/tooling-detection.ts
@src/lib/dep-bump-enrichment.ts
@src/telemetry/store.ts
@src/slack/client.ts
@src/routes/slack-events.ts
@src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix hardcoded default repo and structured logging (C-1, H-4)</name>
  <files>
    src/slack/repo-context.ts
    src/slack/repo-context.test.ts
    src/config.ts
    src/enforcement/tooling-detection.ts
  </files>
  <action>
**C-1: Remove hardcoded DEFAULT_REPO** (`src/slack/repo-context.ts`)
- Remove the hardcoded `const DEFAULT_REPO = "xbmc/xbmc"` line
- Change `resolveSlackRepoContext` signature to accept a second parameter `defaultRepo: string`
- All comparisons and returns that reference `DEFAULT_REPO` now use the `defaultRepo` parameter
- In `src/config.ts`, add `slackDefaultRepo: string` to the config schema with env var `SLACK_DEFAULT_REPO` and default `"xbmc/xbmc"` (same default, but now configurable)
- Update all callers of `resolveSlackRepoContext` to pass `config.slackDefaultRepo` (grep for usage sites)
- Update existing tests in `src/slack/repo-context.test.ts` to pass the default repo explicitly

**H-4: Replace console.warn with structured logger** (`src/enforcement/tooling-detection.ts`)
- Add `logger: Logger` parameter to `detectRepoTooling` function signature (from `pino`)
- Replace `console.warn("[enforcement] Tooling detection failed, skipping:", ...)` with `logger.warn({ err: error }, "Tooling detection failed, skipping")`
- Update all callers to pass the logger (grep for `detectRepoTooling` calls)
- If there are tests that mock console.warn, update them to use the logger instead
  </action>
  <verify>Run `bun test src/slack/repo-context.test.ts src/enforcement/` — all tests pass. Run `grep -r "console\\.warn" src/enforcement/tooling-detection.ts` — no hits. Run `grep -r "DEFAULT_REPO" src/slack/repo-context.ts` — no hits for the hardcoded constant.</verify>
  <done>Default repo is configurable via SLACK_DEFAULT_REPO env var. No console.warn calls remain in tooling-detection.</done>
</task>

<task type="auto">
  <name>Task 2: Fix type safety, telemetry purge, Slack timeout, and rate limiting (H-5, H-8, H-10, M-2)</name>
  <files>
    src/lib/dep-bump-enrichment.ts
    src/telemetry/store.ts
    src/slack/client.ts
    src/routes/slack-events.ts
  </files>
  <action>
**H-5: Eliminate `any` casts in dep-bump-enrichment** (`src/lib/dep-bump-enrichment.ts`)
- Lines 161-184: The `queryAdvisories` function casts Octokit response as `any`. The GitHub Advisory API types are not fully typed in `@octokit/rest`. Create a local type for the advisory response shape:
  ```typescript
  type GitHubAdvisoryResponse = {
    type: string;
    ghsa_id: string;
    cve_id: string | null;
    severity: string;
    summary: string;
    html_url: string;
    vulnerabilities?: Array<{
      package?: { name: string; ecosystem: string };
      vulnerable_version_range?: string;
      first_patched_version?: { identifier: string } | null;
    }>;
  };
  ```
- Cast `octokit.rest.securityAdvisories` only once at the call site with a focused type (not `any`), or use `as unknown as` pattern for the untyped method
- Replace `(data as any[])` with proper typing using the local type
- Lines 219 (`extractGitHubCoords`): The `data: any` parameter receives JSON from registry APIs. Add a narrow type or use explicit property checks instead of `any`

**H-8: Optimize telemetry purge** (`src/telemetry/store.ts`)
- In `purgeOlderThan()` (lines 436-454), change each `DELETE ... RETURNING id` to just `DELETE ...` and use `db.run()` instead of `db.query().all()`. Get the count via `changes()` on the Database object or SQLite's `changes()` function
- Specifically: use `db.run("DELETE FROM executions WHERE created_at < datetime('now', $modifier)", { $modifier: modifier })` and read `db.query("SELECT changes() as cnt").get()` for the count
- Or simpler: use `db.prepare(...).run(...)` and check the returned RunResult's `changes` property (Bun's SQLite returns `{ changes: number }` from `.run()`)

**M-2: Add timeout to Slack client** (`src/slack/client.ts`)
- Add an optional `timeoutMs` to `CreateSlackClientInput` defaulting to `10_000` (10 seconds)
- Add `signal: AbortSignal.timeout(timeoutMs)` to every `fetchImpl()` call in the client
- This prevents Slack API hangs from blocking the event loop indefinitely

**H-10: Basic rate limiting on Slack event processing** (`src/routes/slack-events.ts`)
- Add a simple per-channel sliding window rate limiter inline (no external dependency)
- Track `Map<string, number[]>` of recent event timestamps per channel
- Limit: 30 events per 60 seconds per channel
- When rate limited, log a warning and return `200 { ok: true }` (don't retry)
- Clean old timestamps from the map lazily (on each check)
- Apply the rate limit check AFTER signature verification but BEFORE async processing dispatch
  </action>
  <verify>Run `bun test src/lib/dep-bump-enrichment.test.ts src/telemetry/ src/slack/client src/routes/slack-events` — all tests pass. Run `grep -rn "as any" src/lib/dep-bump-enrichment.ts` — count reduced (some may remain for truly untyped Octokit methods, but data processing should be typed). Run `grep "RETURNING" src/telemetry/store.ts` — no hits in purge function.</verify>
  <done>Type safety improved in dep-bump-enrichment. Telemetry purge is optimized. Slack client has 10s timeout. Slack events have per-channel rate limiting.</done>
</task>

</tasks>

<verification>
- `bun test` — full test suite passes
- `grep -r "console\\.warn" src/enforcement/` — no hits
- `grep -r "DEFAULT_REPO.*xbmc" src/slack/repo-context.ts` — no hardcoded constant
- `grep "RETURNING" src/telemetry/store.ts` — no hits in purge queries
- Slack client has AbortSignal.timeout in all fetch calls
</verification>

<success_criteria>
- C-1: Default repo is config-driven, not hardcoded
- H-4: All console.warn replaced with structured logger
- H-5: `any` casts reduced to minimum necessary
- H-8: Purge uses efficient DELETE without RETURNING
- H-10: Slack events rate-limited per channel
- M-2: Slack client has request timeouts
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/85-code-review-fixes-memory-leaks-hardcoded-defaults-type-mismatches-and-missing-rate-limits/85-02-SUMMARY.md`
</output>
