---
phase: 26-review-mode-severity-control
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
autonomous: true

must_haves:
  truths:
    - "Setting review.mode to 'enhanced' or 'standard' is accepted by config parser with 'standard' as default"
    - "Setting review.severity.minLevel to any of critical/major/medium/minor is accepted with 'minor' as default"
    - "Setting review.focusAreas and review.ignoredAreas accepts arrays of category enums with empty arrays as defaults"
    - "Setting review.maxComments accepts a number 1-25 with default 7"
    - "Old configs without new fields parse identically to current behavior (zero migration)"
    - "Invalid new field values cause section-level fallback with warnings, not crashes"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Extended reviewSchema with mode, severity, focusAreas, ignoredAreas, maxComments"
      contains: "mode.*enum.*standard.*enhanced"
    - path: "src/execution/config.test.ts"
      provides: "Tests for new review config fields"
      contains: "review.mode"
  key_links:
    - from: "src/execution/config.ts"
      to: "src/execution/config.test.ts"
      via: "loadRepoConfig imports in tests"
      pattern: "loadRepoConfig"
---

<objective>
Extend the `.kodiai.yml` review config schema with new fields for review mode, severity filtering, focus areas, and comment cap.

Purpose: Enable users to configure review behavior via `.kodiai.yml` without any code changes in their repos. These config values will drive prompt enrichment in Plan 26-02.
Output: Updated `reviewSchema` Zod definition with new optional fields and comprehensive tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/execution/config.ts
@src/execution/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend reviewSchema with mode, severity, focusAreas, ignoredAreas, maxComments</name>
  <files>src/execution/config.ts</files>
  <action>
Add the following new optional fields inside the existing `reviewSchema` z.object() definition, AFTER the existing `skipPaths` field:

```typescript
/** Review mode: standard preserves current behavior, enhanced adds structured YAML metadata per comment. */
mode: z.enum(["standard", "enhanced"]).default("standard"),
/** Severity filtering: only report findings at or above this level. */
severity: z
  .object({
    minLevel: z.enum(["critical", "major", "medium", "minor"]).default("minor"),
  })
  .default({ minLevel: "minor" }),
/** Focus area targeting: concentrate review on these categories. Empty = all categories. */
focusAreas: z
  .array(z.enum(["security", "correctness", "performance", "style", "documentation"]))
  .default([]),
/** Explicit exclude list: skip these categories unless finding is CRITICAL. */
ignoredAreas: z
  .array(z.enum(["security", "correctness", "performance", "style", "documentation"]))
  .default([]),
/** Maximum inline comments per review. Range 1-25, default 7. */
maxComments: z.number().min(1).max(25).default(7),
```

Also update the `.default({...})` block on the `reviewSchema` to include the new fields with their default values:
- `mode: "standard"`
- `severity: { minLevel: "minor" }`
- `focusAreas: []`
- `ignoredAreas: []`
- `maxComments: 7`

This ensures zero-config (no `.kodiai.yml`) still works identically.

Important: Do NOT change any existing fields. The new fields are purely additive. The section-level fallback in `loadRepoConfig()` already handles the review section as a unit, so no changes needed there.
  </action>
  <verify>Run `bun test src/execution/config.test.ts` — all existing tests must pass (backward compatibility). Verify the `RepoConfig` type now includes `review.mode`, `review.severity.minLevel`, `review.focusAreas`, `review.ignoredAreas`, `review.maxComments`.</verify>
  <done>reviewSchema has 5 new fields with correct types, defaults, and constraints. All existing config tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add config tests for new review fields</name>
  <files>src/execution/config.test.ts</files>
  <action>
Add the following test cases to `src/execution/config.test.ts`:

1. **Defaults for new fields when no .kodiai.yml exists** — Extend the existing "returns defaults when no .kodiai.yml exists" test to also verify:
   - `config.review.mode` === `"standard"`
   - `config.review.severity.minLevel` === `"minor"`
   - `config.review.focusAreas` deep equals `[]`
   - `config.review.ignoredAreas` deep equals `[]`
   - `config.review.maxComments` === `7`

2. **New test: "parses review.mode: enhanced from YAML"** — Write `.kodiai.yml` with `review:\n  mode: enhanced\n`, verify `config.review.mode === "enhanced"`.

3. **New test: "parses review.severity.minLevel from YAML"** — Write `.kodiai.yml` with `review:\n  severity:\n    minLevel: major\n`, verify `config.review.severity.minLevel === "major"`.

4. **New test: "parses review.focusAreas from YAML"** — Write `.kodiai.yml` with `review:\n  focusAreas:\n    - security\n    - correctness\n`, verify `config.review.focusAreas` deep equals `["security", "correctness"]`.

5. **New test: "parses review.ignoredAreas from YAML"** — Write `.kodiai.yml` with `review:\n  ignoredAreas:\n    - style\n    - documentation\n`, verify `config.review.ignoredAreas` deep equals `["style", "documentation"]`.

6. **New test: "parses review.maxComments from YAML"** — Write `.kodiai.yml` with `review:\n  maxComments: 15\n`, verify `config.review.maxComments === 15`.

7. **New test: "rejects invalid review.maxComments (out of range)"** — Write `.kodiai.yml` with `review:\n  maxComments: 50\n`, verify the review section falls back to defaults with a warning (since 50 exceeds max 25).

8. **New test: "rejects invalid review.mode value"** — Write `.kodiai.yml` with `review:\n  mode: turbo\n`, verify section-level fallback with warning.

9. **New test: "new review fields coexist with existing fields"** — Write `.kodiai.yml` with both old and new fields (`review:\n  enabled: true\n  autoApprove: false\n  mode: enhanced\n  maxComments: 10\n`), verify all fields parse correctly together.

Follow the existing test pattern: create temp dir, write `.kodiai.yml`, call `loadRepoConfig(dir)`, assert, clean up in finally block.
  </action>
  <verify>Run `bun test src/execution/config.test.ts` — all tests pass including new ones.</verify>
  <done>9 new or extended test cases cover all new config fields, defaults, valid values, invalid values, and coexistence with existing fields.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes all tests (old + new)
- `loadRepoConfig()` on an empty dir returns new field defaults
- `loadRepoConfig()` on a YAML with new fields parses them correctly
- `loadRepoConfig()` on a YAML with invalid new field values produces warnings and falls back to defaults
- Existing tests unchanged and passing
</verification>

<success_criteria>
- reviewSchema has mode, severity, focusAreas, ignoredAreas, maxComments fields with correct types and defaults
- RepoConfig TypeScript type exports these new fields
- All 9 new/extended test cases pass
- Zero breaking changes to existing behavior
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-mode-severity-control/26-01-SUMMARY.md`
</output>
