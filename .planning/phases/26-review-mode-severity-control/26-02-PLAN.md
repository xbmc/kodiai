---
phase: 26-review-mode-severity-control
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/execution/review-prompt.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Standard mode review prompt includes [SEVERITY] prefix instructions and severity classification guidelines"
    - "Enhanced mode review prompt includes YAML code block format instructions with severity/category/suggested_action metadata"
    - "Review prompt includes noise suppression rules that unconditionally suppress style-only, trivial renaming, and cosmetic issues"
    - "Review prompt includes severity classification guidelines with deterministic rules and path-aware adjustments"
    - "Review prompt includes focus area instructions when focusAreas is configured, with critical-exception for non-focus categories"
    - "Review prompt includes comment cap instruction based on maxComments config value"
    - "Review prompt includes minLevel filtering instructions when severity.minLevel is above 'minor'"
    - "Enhanced mode prompt instructs Claude NOT to post a summary comment"
    - "Standard mode prompt preserves existing summary comment behavior"
    - "Handler passes new config fields to buildReviewPrompt()"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Mode-aware prompt builder with severity, focus, noise, cap sections"
      contains: "buildModeInstructions"
    - path: "src/handlers/review.ts"
      provides: "Handler passes review config to prompt builder"
      contains: "config.review.mode"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "buildReviewPrompt() call with new config fields"
      pattern: "buildReviewPrompt.*mode"
    - from: "src/execution/review-prompt.ts"
      to: "src/execution/config.ts"
      via: "RepoConfig type for review fields"
      pattern: "mode.*standard.*enhanced"
---

<objective>
Enrich the review prompt builder with mode-aware instructions for severity classification, focus areas, noise suppression, and comment caps. Wire the new config fields from the handler to the prompt builder.

Purpose: Transform config values into Claude prompt instructions that control review behavior -- all review intelligence lives in the prompt, not in post-processing code.
Output: Updated `buildReviewPrompt()` with conditional prompt sections and updated handler call site.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-review-mode-severity-control/26-01-SUMMARY.md

@src/execution/review-prompt.ts
@src/execution/config.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode-aware prompt sections to buildReviewPrompt()</name>
  <files>src/execution/review-prompt.ts, src/handlers/review.ts</files>
  <action>
**1. Extend `buildReviewPrompt()` context parameter** with new fields:

```typescript
export function buildReviewPrompt(context: {
  // ... existing fields unchanged ...
  customInstructions?: string;
  // NEW fields from review config:
  mode?: "standard" | "enhanced";
  severityMinLevel?: "critical" | "major" | "medium" | "minor";
  focusAreas?: string[];
  ignoredAreas?: string[];
  maxComments?: number;
}): string {
```

All new fields are optional with sensible in-function defaults (standard, minor, [], [], 7) so existing callers don't break.

**2. Add helper functions** (private, inside review-prompt.ts):

`buildSeverityClassificationGuidelines()` — Returns a constant string with the severity classification rules from the CONTEXT.md decisions. Always included in both modes. Content:
- CRITICAL: SQL injection, XSS, auth bypass, secrets exposure, critical NPE, infinite loops, data corruption
- MAJOR: Unhandled exceptions, missing error handling on external calls, race conditions, resource leaks, incorrect business logic
- MEDIUM: Edge case handling gaps, missing input validation (non-security), suboptimal error messages, moderate performance issues
- MINOR: Unused variables/imports (production code only), duplicate code, magic numbers, missing JSDoc
- PATH CONTEXT: Test files downgrade by one level; config files only CRITICAL; documentation only factual errors

`buildModeInstructions(mode)` — Returns mode-specific comment format instructions:
- Standard mode: Each inline comment MUST begin with a severity prefix in square brackets: `[CRITICAL]`, `[MAJOR]`, `[MEDIUM]`, or `[MINOR]`. After the prefix, include finding details and suggestion blocks as normal.
- Enhanced mode: Each inline comment MUST start with a fenced YAML code block (` ```yaml `) containing `severity`, `category`, `suggested_action` fields, optionally `related_docs_url`. After the code block, a blank line, then a bold finding title, then 1-3 sentences explaining the issue. Include suggestion blocks when a concrete fix exists.

`buildNoiseSuppressionRules()` — Returns a constant string that is always included:
- NEVER flag: style-only issues, trivial renamings, cosmetic preferences (import ordering, trailing commas, semicolons, bracket placement), "consider using X instead of Y" when both work, documentation wording nits, test file organization preferences.
- Focus exclusively on: correctness, security, performance, error handling, resource management, concurrency safety.

`buildCommentCapInstructions(maxComments)` — Returns instructions:
- "Post at most {N} inline comments for this PR review."
- "Prioritize by severity: CRITICAL first, then MAJOR, MEDIUM, MINOR."
- "If more issues exist than the limit allows, add a note at the end of your final inline comment: 'Note: N additional lower-severity issues were found but omitted. Increase review.maxComments in .kodiai.yml to see more.'"
- "Do NOT waste comment slots on low-severity findings when higher-severity issues exist."

`buildSeverityFilterInstructions(minLevel)` — Returns instructions when minLevel is above "minor":
- Compute active levels: slice ["critical", "major", "medium", "minor"] up to and including minLevel.
- "Only report findings at these severity levels: {activeLevels}. Do NOT generate findings below {minLevel} severity."
- If minLevel is "minor" (default), return empty string (no filtering).

`buildFocusAreaInstructions(focusAreas, ignoredAreas)` — Returns instructions:
- If focusAreas non-empty: "Concentrate your review on these categories: {focusAreas}. For categories NOT in this list, only report CRITICAL severity findings."
- If ignoredAreas non-empty: "Explicitly SKIP these categories unless the finding is CRITICAL: {ignoredAreas}."
- If both empty, return empty string.

**3. Integrate into prompt assembly** — In the main `buildReviewPrompt()` function body, add new sections AFTER the existing "## Rules" section and BEFORE "## Summary comment":

```
// --- Severity classification ---
lines.push("", buildSeverityClassificationGuidelines());

// --- Review mode format ---
lines.push("", buildModeInstructions(context.mode ?? "standard"));

// --- Noise suppression ---
lines.push("", buildNoiseSuppressionRules());

// --- Comment cap ---
lines.push("", buildCommentCapInstructions(context.maxComments ?? 7));

// --- Severity filter ---
const severityFilter = buildSeverityFilterInstructions(context.severityMinLevel ?? "minor");
if (severityFilter) lines.push("", severityFilter);

// --- Focus areas ---
const focusInstructions = buildFocusAreaInstructions(
  context.focusAreas ?? [],
  context.ignoredAreas ?? [],
);
if (focusInstructions) lines.push("", focusInstructions);
```

**4. Update Summary Comment section for enhanced mode:**

Wrap the existing "## Summary comment" section in a condition:
- If `context.mode === "enhanced"`: replace the entire summary comment section with: "## Summary comment\n\nDo NOT post a top-level summary comment. Each inline comment stands alone with its own severity and category metadata. If NO issues found: do nothing."
- If standard mode (or unset): keep the existing summary comment section unchanged.

Similarly update the "## After review" section:
- Enhanced mode: "If you found issues: post inline comments only (no summary comment). If NO issues found: do nothing."
- Standard mode: keep existing text.

**5. Custom instructions precedence:**

Move the existing custom instructions block to be the LAST section in the prompt (it should already be last). Add a note: "If custom instructions below conflict with the noise suppression rules above, follow the custom instructions." This ensures user-specified `review.prompt` can override noise suppression per CONTEXT.md pitfall #6.

**6. Update handler call site** in `src/handlers/review.ts`:

Change the `buildReviewPrompt()` call (around line 449) to pass the new config fields:

```typescript
const reviewPrompt = buildReviewPrompt({
  owner: apiOwner,
  repo: apiRepo,
  prNumber: pr.number,
  prTitle: pr.title,
  prBody: pr.body ?? "",
  prAuthor: pr.user.login,
  baseBranch: pr.base.ref,
  headBranch: pr.head.ref,
  changedFiles,
  customInstructions: config.review.prompt,
  // NEW: review mode & severity control
  mode: config.review.mode,
  severityMinLevel: config.review.severity.minLevel,
  focusAreas: config.review.focusAreas,
  ignoredAreas: config.review.ignoredAreas,
  maxComments: config.review.maxComments,
});
```

**Important implementation notes:**
- All new prompt sections are string constants or simple string builders — no complex logic.
- Do NOT change the executor, MCP servers, or job pipeline. All behavior is prompt-driven.
- Keep backward compatibility: if no new fields are provided, the prompt should look essentially the same as before (standard mode, all severities, no focus filter) plus the always-on severity guidelines and noise suppression rules.
- The noise suppression rules and severity guidelines are always included regardless of mode — they improve review quality even in standard mode.
  </action>
  <verify>
Run `bun test` to verify all existing tests still pass. Manually verify by reading the updated `buildReviewPrompt()` output for:
1. Default config (standard mode) — should include severity guidelines, noise suppression, comment cap of 7, standard mode format instructions, and existing summary comment section.
2. Enhanced mode config — should include YAML code block format instructions and "do NOT post summary" instruction.
3. With focusAreas: ["security"] — should include focus area filtering instruction.
4. With severityMinLevel: "major" — should include "only report critical/major" instruction.
  </verify>
  <done>
buildReviewPrompt() generates mode-aware prompts with severity classification, noise suppression, comment cap, focus areas, and severity filtering. Handler passes all new config fields. Standard mode backward compatible. Enhanced mode produces structured format instructions with no summary comment.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for review prompt enrichment</name>
  <files>src/execution/review-prompt.test.ts</files>
  <action>
Create a new test file `src/execution/review-prompt.test.ts` with the following test cases:

```typescript
import { test, expect } from "bun:test";
import { buildReviewPrompt } from "./review-prompt.ts";
```

**Base context helper** — Create a helper that returns a minimal valid context object:
```typescript
function baseContext(overrides: Record<string, unknown> = {}) {
  return {
    owner: "acme",
    repo: "app",
    prNumber: 42,
    prTitle: "Fix bug",
    prBody: "Fixes a critical bug",
    prAuthor: "alice",
    baseBranch: "main",
    headBranch: "fix/bug",
    changedFiles: ["src/index.ts"],
    ...overrides,
  };
}
```

**Test cases:**

1. **"default config includes severity classification guidelines"** — Call `buildReviewPrompt(baseContext())`, verify output contains "Severity Classification" and "CRITICAL" and "MAJOR" and "MEDIUM" and "MINOR".

2. **"default config includes noise suppression rules"** — Verify output contains "Noise Suppression" and "NEVER flag" and "style-only".

3. **"default config includes comment cap of 7"** — Verify output contains "at most 7 inline comments".

4. **"default config uses standard mode format"** — Verify output contains "[CRITICAL]" or "[MAJOR]" (standard prefix format). Verify output does NOT contain "```yaml" (enhanced format).

5. **"default config preserves summary comment section"** — Verify output contains "Kodiai Review Summary" and "summary comment".

6. **"enhanced mode includes YAML code block format"** — Call with `mode: "enhanced"`, verify output contains "```yaml" and "severity:" and "category:" and "suggested_action:".

7. **"enhanced mode suppresses summary comment"** — Call with `mode: "enhanced"`, verify output contains "Do NOT post a top-level summary comment" or similar. Verify output does NOT contain "Kodiai Review Summary".

8. **"severityMinLevel major filters out medium and minor"** — Call with `severityMinLevel: "major"`, verify output contains "critical" and "major" in the active levels, and contains instruction not to report below major.

9. **"severityMinLevel minor (default) does not add filter"** — Call with `severityMinLevel: "minor"`, verify output does NOT contain "Do NOT generate findings below".

10. **"focusAreas filters by category"** — Call with `focusAreas: ["security", "correctness"]`, verify output contains "Concentrate your review on these categories: security, correctness" and "only report CRITICAL".

11. **"ignoredAreas excludes categories"** — Call with `ignoredAreas: ["style"]`, verify output contains "SKIP these categories" and "style".

12. **"maxComments overrides default"** — Call with `maxComments: 3`, verify output contains "at most 3 inline comments".

13. **"custom instructions appear after noise suppression"** — Call with `customInstructions: "Check for SQL injection"`, verify output contains "Custom instructions" AFTER "Noise Suppression" (check index positions).

14. **"path context severity rules included"** — Verify output contains "Test files" and "downgrade" (path-aware severity adjustment).

Each test calls `buildReviewPrompt()` and uses `expect(prompt).toContain(...)` or `expect(prompt).not.toContain(...)` to verify prompt content.
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` — all 14 tests pass.</verify>
  <done>14 test cases cover all prompt enrichment features: severity classification, noise suppression, comment cap, mode-specific format, summary comment behavior, severity filtering, focus area targeting, ignored areas, maxComments override, custom instruction ordering, and path context rules.</done>
</task>

</tasks>

<verification>
- `bun test` passes all tests (config, prompt, comment-server, and all existing tests)
- Standard mode prompt includes severity guidelines, noise suppression, comment cap, and standard format instructions
- Enhanced mode prompt includes YAML code block format and no-summary instruction
- Focus area and severity filtering instructions are conditionally included
- Handler correctly passes new config fields to prompt builder
- No changes to executor, MCP servers, or job pipeline
</verification>

<success_criteria>
- buildReviewPrompt() generates complete mode-aware prompts for standard and enhanced modes
- All 6 requirements (FOUND-01 through FOUND-06) are satisfied via prompt instructions:
  - FOUND-01: mode field controls standard/enhanced behavior
  - FOUND-02: severityMinLevel filters findings via prompt instruction
  - FOUND-03: focusAreas/ignoredAreas target specific categories
  - FOUND-04: Every comment tagged with severity and category (via mode instructions)
  - FOUND-05: maxComments enforces cap via prompt instruction
  - FOUND-06: Noise suppression rules always active
- All 5 success criteria from the phase are achievable via the prompt instructions
- 14 prompt tests and all existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/26-review-mode-severity-control/26-02-SUMMARY.md`
</output>
