---
phase: 05-mention-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mcp/comment-server.ts
  - src/execution/mention-prompt.ts
  - src/handlers/mention-types.ts
autonomous: true

must_haves:
  truths:
    - "MCP comment server exposes create_comment tool alongside existing update_comment"
    - "MentionEvent type normalizes all four comment surfaces into a single shape"
    - "Mention prompt includes conversation context, PR metadata when applicable, and the user question"
    - "Conversation context builder fetches recent issue/PR comments and PR details"
  artifacts:
    - path: "src/execution/mcp/comment-server.ts"
      provides: "create_comment MCP tool for posting new comments"
      contains: "create_comment"
    - path: "src/handlers/mention-types.ts"
      provides: "MentionEvent interface and normalizer functions for all surfaces"
      exports: ["MentionEvent", "normalizeIssueComment", "normalizeReviewComment", "normalizeReviewBody", "containsMention"]
    - path: "src/execution/mention-prompt.ts"
      provides: "buildMentionPrompt and buildConversationContext functions"
      exports: ["buildMentionPrompt", "buildConversationContext"]
  key_links:
    - from: "src/handlers/mention-types.ts"
      to: "@octokit/webhooks-types"
      via: "imports IssueCommentCreatedEvent, PullRequestReviewCommentCreatedEvent, PullRequestReviewSubmittedEvent"
      pattern: "import.*octokit/webhooks-types"
    - from: "src/execution/mention-prompt.ts"
      to: "src/handlers/mention-types.ts"
      via: "imports MentionEvent type"
      pattern: "import.*MentionEvent"
---

<objective>
Create the building blocks for mention handling: MCP write tool extension, MentionEvent types with normalizers for all four comment surfaces, conversation context builder, and mention-specific prompt.

Purpose: Provides the types, tools, and prompt generation that the mention handler (Plan 02) will orchestrate. Follows the same foundation-first pattern as Phase 4 (04-01 built config+prompt, 04-02 built the handler).

Output: Three source files providing types, MCP tooling, and prompt generation for mentions.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mention-handling/05-RESEARCH.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/index.ts
@src/execution/types.ts
@src/execution/review-prompt.ts
@src/handlers/review.ts
@src/auth/github-app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP write tool and MentionEvent types</name>
  <files>src/execution/mcp/comment-server.ts, src/handlers/mention-types.ts</files>
  <action>
**1. Extend comment-server.ts with create_comment tool:**

Add a `create_comment` tool to the existing `createCommentServer()` tools array, alongside the existing `update_comment` tool. This fulfills the Phase 3 decision [03-03] that "Phase 5 adds write tools for mentions."

The tool takes `issueNumber` (z.number()) and `body` (z.string()) parameters. Implementation calls `octokit.rest.issues.createComment({ owner, repo, issue_number: issueNumber, body })` and returns `{ success: true, comment_id: data.id }`. Error handling follows the same pattern as `update_comment` (catch, return isError: true with message).

**2. Create src/handlers/mention-types.ts:**

Define the `MentionEvent` interface that normalizes all four comment surfaces into a single shape:

```typescript
interface MentionEvent {
  surface: "issue_comment" | "pr_comment" | "pr_review_comment" | "pr_review_body";
  owner: string;
  repo: string;
  issueNumber: number;         // Issue or PR number
  prNumber: number | undefined; // Set only for PR surfaces
  commentId: number;            // The triggering comment ID
  commentBody: string;          // Comment text containing @kodiai
  commentAuthor: string;        // Who triggered it
  commentCreatedAt: string;     // ISO timestamp (for Phase 6 TOCTOU)
  headRef: string | undefined;  // PR head branch (needs fetch for issue_comment on PR)
  baseRef: string | undefined;  // PR base branch
  headRepoOwner: string | undefined; // Fork owner
  headRepoName: string | undefined;  // Fork repo name
  diffHunk: string | undefined; // Only for pr_review_comment surface
}
```

Create three normalizer functions matching the three webhook event types:

- `normalizeIssueComment(payload: IssueCommentCreatedEvent): MentionEvent` -- Checks `payload.issue.pull_request` to set surface to "pr_comment" vs "issue_comment". Sets prNumber when it's a PR comment. headRef/baseRef/headRepoOwner/headRepoName are left undefined (must be fetched via pulls.get later by the handler). diffHunk is undefined.

- `normalizeReviewComment(payload: PullRequestReviewCommentCreatedEvent): MentionEvent` -- Surface is always "pr_review_comment". Sets prNumber from `payload.pull_request.number`. Sets headRef/baseRef/headRepoOwner/headRepoName from the pull_request payload. Sets diffHunk from `payload.comment.diff_hunk`.

- `normalizeReviewBody(payload: PullRequestReviewSubmittedEvent): MentionEvent` -- Surface is always "pr_review_body". The commentId is `payload.review.id`. The commentBody is `payload.review.body` (null-checked by caller). Sets PR details from the pull_request payload. diffHunk is undefined.

Create a `containsMention(body: string | null | undefined, appSlug: string): boolean` helper that does case-insensitive `@appSlug` matching. Returns false if body is null/undefined/empty.

Create a `stripMention(body: string, appSlug: string): string` helper that removes the `@appSlug` prefix (case-insensitive) and trims whitespace. This gives Claude the user's actual question without the mention text.

Import types from `@octokit/webhooks-types`: `IssueCommentCreatedEvent`, `PullRequestReviewCommentCreatedEvent`, `PullRequestReviewSubmittedEvent`.

Export everything: `MentionEvent`, all three normalizers, `containsMention`, `stripMention`.
  </action>
  <verify>
Run `bun build --no-bundle src/execution/mcp/comment-server.ts` and `bun build --no-bundle src/handlers/mention-types.ts` -- both must compile without errors.
  </verify>
  <done>
comment-server.ts has both `update_comment` and `create_comment` tools. mention-types.ts exports MentionEvent interface, three normalizer functions, containsMention, and stripMention. All type-check cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conversation context builder and mention prompt</name>
  <files>src/execution/mention-prompt.ts</files>
  <action>
Create `src/execution/mention-prompt.ts` with two exported functions.

**1. buildConversationContext(octokit, mention: MentionEvent): Promise&lt;string&gt;**

Fetches conversation context appropriate to the mention surface:

- Always fetch recent issue/PR comments via `octokit.rest.issues.listComments({ owner, repo, issue_number: issueNumber, per_page: 30 })`. These are the general discussion comments. Format each as `### @{login} ({created_at}):\n{body}` under a `## Conversation History` heading. Skip comments where body starts with `"> **Kodiai**"` (tracking comments from the bot).

- If `mention.prNumber` is defined (any PR surface), fetch PR details via `octokit.rest.pulls.get()`. Add a `## Pull Request Context` section with title, author, branches (head -> base), and description (if non-empty).

- If surface is `"pr_review_comment"` and `mention.diffHunk` is defined, add a `## Code Context` section containing the diff hunk that the triggering comment is attached to.

- Return the assembled string with all sections joined by newlines.

**2. buildMentionPrompt(params): string**

Takes `{ mention: MentionEvent, conversationContext: string, userQuestion: string, customInstructions?: string }`.

Build the prompt:

```
You are assisting with a question in {owner}/{repo}.
{if prNumber: "This is about Pull Request #{prNumber}."}
{if surface is issue_comment: "This is about Issue #{issueNumber}."}

{conversationContext}

## User's Question

@{commentAuthor} asked:
{userQuestion}

## How to respond

Write your response by updating the tracking comment using the `mcp__github_comment__update_comment` tool. The tracking comment ID will be provided in the system context.

Your response should be:
- Direct and helpful -- answer the question with specific code references where possible
- Aware of the conversation context above -- don't repeat what's already been discussed
- Formatted in GitHub-flavored markdown
- When listing items, use (1), (2), (3) format -- NEVER #1, #2, #3 (GitHub treats those as issue links)

{if customInstructions: "## Custom Instructions\n\n{customInstructions}"}
```

Import `MentionEvent` from `../handlers/mention-types.ts`. Import `Octokit` type from `@octokit/rest`.
  </action>
  <verify>
Run `bun build --no-bundle src/execution/mention-prompt.ts` -- must compile without errors.
  </verify>
  <done>
mention-prompt.ts exports buildConversationContext (async, fetches comments + PR data) and buildMentionPrompt (sync, assembles prompt with context, question, and instructions). Both type-check cleanly against MentionEvent and Octokit types.
  </done>
</task>

</tasks>

<verification>
- `bun build --no-bundle src/execution/mcp/comment-server.ts` compiles
- `bun build --no-bundle src/handlers/mention-types.ts` compiles
- `bun build --no-bundle src/execution/mention-prompt.ts` compiles
- `bun build --no-bundle src/index.ts` still compiles (no breaking changes)
- comment-server.ts exports both `update_comment` and `create_comment` tools
- mention-types.ts exports MentionEvent, three normalizers, containsMention, stripMention
- mention-prompt.ts exports buildConversationContext and buildMentionPrompt
</verification>

<success_criteria>
- MCP comment server has a create_comment tool that can post new issue/PR comments
- MentionEvent type covers all four surfaces with proper field population
- Normalizers correctly map each webhook payload to MentionEvent (including PR detection in issue_comment)
- Conversation context builder fetches comments and PR metadata
- Mention prompt includes conversation history, PR context, user question, and response instructions
- All files compile cleanly with existing codebase
</success_criteria>

<output>
After completion, create `.planning/phases/05-mention-handling/05-01-SUMMARY.md`
</output>
