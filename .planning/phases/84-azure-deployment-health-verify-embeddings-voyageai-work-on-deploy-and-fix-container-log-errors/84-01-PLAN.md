---
phase: 84-azure-deployment-health-verify-embeddings-voyageai-work-on-deploy-and-fix-container-log-errors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.ts
  - deploy.sh
autonomous: true
requirements: []
must_haves:
  truths:
    - "Embeddings smoke test runs automatically on container boot and logs pass/fail"
    - "Smoke test failure does not prevent the server from starting (non-fatal)"
    - "deploy.sh passes VOYAGE_API_KEY and Slack env vars to Azure Container Apps"
  artifacts:
    - path: "src/index.ts"
      provides: "Embeddings smoke test on startup"
      contains: "smoke"
    - path: "deploy.sh"
      provides: "Complete env var passthrough for all required secrets"
      contains: "voyage-api-key"
  key_links:
    - from: "src/index.ts"
      to: "src/learning/embedding-provider.ts"
      via: "embeddingProvider.generate() call during smoke test"
      pattern: "embeddingProvider.*generate"
    - from: "deploy.sh"
      to: "src/config.ts"
      via: "env var names matching config schema"
      pattern: "VOYAGE_API_KEY|SLACK_SIGNING_SECRET|SLACK_BOT_TOKEN"
---

<objective>
Add an embeddings startup smoke test and fix deploy.sh to pass all required environment variables.

Purpose: The deployed container needs VOYAGE_API_KEY and Slack secrets passed through, and needs a smoke test that confirms embeddings work on each boot so operators know immediately if VoyageAI is functional.

Output: Updated src/index.ts with smoke test, updated deploy.sh with complete env var passthrough.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/index.ts
@src/learning/embedding-provider.ts
@src/config.ts
@deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add embeddings startup smoke test to src/index.ts</name>
  <files>src/index.ts</files>
  <action>
After the embedding provider initialization block (around line 117 where the embeddingProvider is set up), add an async smoke test that runs on startup. The smoke test should:

1. Only run if embeddingProvider is NOT the no-op provider (check if model !== "none")
2. Call `embeddingProvider.generate("kodiai smoke test", "query")` with a short test string
3. If the result is non-null: log at INFO level: `"Embeddings smoke test passed"` with `{ model, dimensions, latencyMs }` (measure elapsed time)
4. If the result is null: log at WARN level: `"Embeddings smoke test failed -- VoyageAI returned null (embeddings degraded)"` with `{ model }`
5. If an exception is thrown: log at WARN level: `"Embeddings smoke test failed -- error connecting to VoyageAI (embeddings degraded)"` with `{ err, model }`

Use `void Promise.resolve().then(async () => { ... }).catch(...)` pattern (same as the Slack scope preflight on line 148) so it does NOT block server startup. The smoke test runs concurrently with server boot.

Do NOT make the smoke test blocking -- the server must start even if embeddings are broken. The embedding provider already has fail-open semantics internally, but the smoke test provides explicit operator visibility at boot time.
  </action>
  <verify>Run `bun run src/index.ts` locally (will fail on missing config but verify no syntax errors) OR run `bun build --target=bun src/index.ts` to confirm no TypeScript errors. Grep for "smoke" in src/index.ts to confirm the test is present.</verify>
  <done>src/index.ts contains a non-blocking embeddings smoke test that runs on startup, logs pass/fail at appropriate levels, and does not prevent server startup on failure.</done>
</task>

<task type="auto">
  <name>Task 2: Update deploy.sh to pass all missing environment variables</name>
  <files>deploy.sh</files>
  <action>
The deploy.sh currently only passes 4 secrets (GITHUB_APP_ID, GITHUB_PRIVATE_KEY, GITHUB_WEBHOOK_SECRET, CLAUDE_CODE_OAUTH_TOKEN) but the app requires additional env vars:

**Secrets to add** (these contain sensitive values):
- `VOYAGE_API_KEY` -- required for embeddings to work
- `SLACK_BOT_TOKEN` -- required for Slack integration
- `SLACK_SIGNING_SECRET` -- required for Slack webhook verification

**Plain env vars to add** (non-secret config):
- `SLACK_BOT_USER_ID` -- Slack bot user ID
- `SLACK_KODIAI_CHANNEL_ID` -- Slack channel ID

Changes needed:

1. **Validation section** (line 46-59): Add `VOYAGE_API_KEY`, `SLACK_BOT_TOKEN`, and `SLACK_SIGNING_SECRET` to the required env var check. Also validate `SLACK_BOT_USER_ID` and `SLACK_KODIAI_CHANNEL_ID` are set.

2. **Secret set commands** (both the `az containerapp secret set` on line 153-161 and the `az containerapp create --secrets` on line 192-196): Add:
   - `voyage-api-key="$VOYAGE_API_KEY"`
   - `slack-bot-token="$SLACK_BOT_TOKEN"`
   - `slack-signing-secret="$SLACK_SIGNING_SECRET"`

3. **Env var set commands** (both the `az containerapp update --set-env-vars` on line 168-177 and the `az containerapp create --env-vars` on line 197-205): Add:
   - `VOYAGE_API_KEY=secretref:voyage-api-key`
   - `SLACK_BOT_TOKEN=secretref:slack-bot-token`
   - `SLACK_SIGNING_SECRET=secretref:slack-signing-secret`
   - `SLACK_BOT_USER_ID="$SLACK_BOT_USER_ID"`
   - `SLACK_KODIAI_CHANNEL_ID="$SLACK_KODIAI_CHANNEL_ID"`

4. **YAML probe template** (line 210-251): Add the new env vars to the container env section so they persist across YAML-based updates:
   - `VOYAGE_API_KEY` with secretRef: voyage-api-key
   - `SLACK_BOT_TOKEN` with secretRef: slack-bot-token
   - `SLACK_SIGNING_SECRET` with secretRef: slack-signing-secret
   - `SLACK_BOT_USER_ID` with plain value
   - `SLACK_KODIAI_CHANNEL_ID` with plain value

Also update the script header comment (line 16-19) to include the new required env vars.
  </action>
  <verify>Run `bash -n deploy.sh` to verify no syntax errors. Grep for "VOYAGE_API_KEY" and "SLACK_BOT_TOKEN" in deploy.sh to confirm they appear in validation, secrets, and env-vars sections.</verify>
  <done>deploy.sh validates and passes all required environment variables (GitHub, Claude, VoyageAI, Slack) to Azure Container Apps in both create and update paths.</done>
</task>

</tasks>

<verification>
1. `bun build --target=bun src/index.ts` succeeds (no TypeScript/import errors)
2. `bash -n deploy.sh` succeeds (no bash syntax errors)
3. Smoke test code in src/index.ts is non-blocking (uses void Promise pattern)
4. deploy.sh contains VOYAGE_API_KEY in validation, secrets, and env-vars sections
5. deploy.sh contains SLACK_BOT_TOKEN, SLACK_SIGNING_SECRET in secrets and env-vars
6. deploy.sh contains SLACK_BOT_USER_ID, SLACK_KODIAI_CHANNEL_ID in env-vars
</verification>

<success_criteria>
- Embeddings smoke test runs on every container boot and logs pass/fail
- deploy.sh passes all environment variables needed for full app functionality
- No blocking behavior -- server starts regardless of smoke test result
</success_criteria>

<output>
After completion, create `.planning/phases/84-azure-deployment-health-verify-embeddings-voyageai-work-on-deploy-and-fix-container-log-errors/84-01-SUMMARY.md`
</output>
