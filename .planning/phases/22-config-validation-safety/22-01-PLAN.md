---
phase: 22-config-validation-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/handlers/review.ts
  - src/handlers/mention.ts
  - src/execution/executor.ts
autonomous: true

must_haves:
  truths:
    - "A .kodiai.yml with unknown keys (e.g. futureFeature: true) is accepted without error and unknown keys are silently ignored"
    - "A .kodiai.yml with a valid review section but invalid write section loads the valid review config and falls back to defaults for write, with a warning logged"
    - "A repo with no .kodiai.yml works with all defaults (zero-config preserved)"
    - "When a section falls back to defaults due to validation error, a warning is returned identifying which section failed and why"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Forward-compatible config parsing with section-level graceful degradation"
      contains: "safeParse"
      exports: ["loadRepoConfig", "RepoConfig", "ConfigWarning", "LoadConfigResult"]
    - path: "src/execution/config.test.ts"
      provides: "Tests for forward-compat, graceful degradation, and warning output"
      contains: "strips unknown keys"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/config.ts"
      via: "loadRepoConfig returning LoadConfigResult"
      pattern: "const \\{ config, warnings \\}"
    - from: "src/handlers/mention.ts"
      to: "src/execution/config.ts"
      via: "loadRepoConfig returning LoadConfigResult"
      pattern: "const \\{ config, warnings \\}"
    - from: "src/execution/executor.ts"
      to: "src/execution/config.ts"
      via: "loadRepoConfig returning LoadConfigResult"
      pattern: "const \\{ config, warnings \\}"
---

<objective>
Make .kodiai.yml parsing forward-compatible and failure-resilient by removing `.strict()` from all sub-schemas and implementing section-level graceful degradation with structured warnings.

Purpose: Repos should never break when Kodiai adds new config capabilities. A typo in one config section should not prevent the rest from working.
Output: Updated `config.ts` with two-pass safeParse, updated return type `LoadConfigResult`, updated call sites in 3 handlers, updated and expanded test suite.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-config-validation-safety/22-RESEARCH.md
@src/execution/config.ts
@src/execution/config.test.ts
@src/handlers/review.ts
@src/handlers/mention.ts
@src/execution/executor.ts
@src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove .strict() and implement two-pass safeParse with LoadConfigResult return type</name>
  <files>
    src/execution/config.ts
    src/handlers/review.ts
    src/handlers/mention.ts
    src/execution/executor.ts
  </files>
  <action>
  In `src/execution/config.ts`:

  1. **Remove all 4 `.strict()` calls** -- these are the only changes needed for CONFIG-01:
     - Line 41: Remove `.strict()` from `secretScan` sub-schema (keep `.default({ enabled: true })`)
     - Line 44: Remove `.strict()` from `write` sub-schema (keep `.default({...})`)
     - Line 82: Remove `.strict()` from `review.triggers` sub-schema (keep `.default({...})`)
     - Line 111: Remove `.strict()` from `mention` sub-schema (keep `.default({...})`)
     Do NOT add `.strict()` anywhere else. The root schema and `review` sub-object already do not have it.

  2. **Add ConfigWarning and LoadConfigResult types** after the `RepoConfig` type export:
     ```typescript
     export interface ConfigWarning {
       section: string;
       issues: string[];
     }

     export interface LoadConfigResult {
       config: RepoConfig;
       warnings: ConfigWarning[];
     }
     ```

  3. **Extract section schemas** as named constants before the `repoConfigSchema` definition so they can be referenced independently in the two-pass fallback. Extract:
     - `writeSecretScanSchema` (the `secretScan` z.object)
     - `writeSchema` (the `write` z.object)
     - `reviewTriggersSchema` (the `triggers` z.object)
     - `reviewSchema` (the `review` z.object)
     - `mentionSchema` (the `mention` z.object)
     Then reference these named schemas inside `repoConfigSchema` so the schema definition stays DRY. The parsed output type (`RepoConfig`) must not change.

  4. **Rewrite `loadRepoConfig()`** to return `Promise<LoadConfigResult>`:
     - Keep the file-exists check and YAML parse as-is (no change)
     - **Pass 1 (fast path):** `repoConfigSchema.safeParse(parsed)`. If success, return `{ config: result.data, warnings: [] }`
     - **Pass 2 (section fallback):** If full parse fails, parse each section independently with `safeParse()`:
       - For `model`: `z.string().default("claude-sonnet-4-5-20250929").safeParse(parsed?.model)` -- if fails, use default, add warning
       - For `maxTurns`: `z.number().min(1).max(100).default(25).safeParse(parsed?.maxTurns)` -- if fails, use default, add warning
       - For `timeoutSeconds`: `z.number().min(30).max(1800).default(600).safeParse(parsed?.timeoutSeconds)` -- if fails, use default, add warning
       - For `systemPromptAppend`: `z.string().optional().safeParse(parsed?.systemPromptAppend)` -- if fails, use undefined, add warning
       - For `review`: `reviewSchema.safeParse(parsed?.review)` -- if fails, use `reviewSchema.parse({})`, add warning
       - For `write`: `writeSchema.safeParse(parsed?.write)` -- if fails, use `writeSchema.parse({})`, add warning
       - For `mention`: `mentionSchema.safeParse(parsed?.mention)` -- if fails, use `mentionSchema.parse({})`, add warning
     - Format warning issues from ZodError: `error.issues.map(i => \`${i.path.join(".")}: ${i.message}\`)`
     - Construct and return `{ config: { model, maxTurns, timeoutSeconds, systemPromptAppend, review, write, mention }, warnings }`
     - YAML parse errors still throw (malformed YAML is not recoverable)
     - The old catch block that threw `new Error("Invalid .kodiai.yml: ...")` is replaced by the two-pass logic. Config validation errors no longer throw -- they produce warnings and defaults.

  5. **Handle `parsed` type for section access:** After `yaml.load(raw)`, cast/check `parsed` to access sections. Use: `const obj = (typeof parsed === "object" && parsed !== null) ? parsed as Record<string, unknown> : {};` This handles the case where the entire YAML is a scalar or null.

  In `src/handlers/review.ts` (line 282):
  - Change `const config = await loadRepoConfig(workspace.dir);` to `const { config, warnings } = await loadRepoConfig(workspace.dir);`
  - After the destructure, add warning logging: `for (const w of warnings) { logger.warn({ section: w.section, issues: w.issues }, "Config section invalid, using defaults"); }`
  - Update the import to also import `LoadConfigResult` if needed (though destructuring the return is sufficient)

  In `src/handlers/mention.ts` (line 319):
  - Same pattern: `const { config, warnings } = await loadRepoConfig(workspace.dir);`
  - Add warning logging loop after destructure, using the handler's existing `logger`

  In `src/execution/executor.ts` (line 27):
  - Same pattern: `const { config, warnings } = await loadRepoConfig(workspace.dir);`
  - Add warning logging loop after destructure, using the executor's existing `logger`

  **Important:** Do NOT add `.strict()` to the root schema. Do NOT use `.passthrough()`. Do NOT use `.catch()` on individual fields. Use `safeParse()` only.
  </action>
  <verify>
  Run `bunx tsc --noEmit` -- no TypeScript errors.
  Run `bun test src/execution/config.test.ts` -- existing tests for defaults, valid config, YAML errors pass. The 3 strict-rejection tests (lines 120, 155, 284) will fail because they expect throws on unknown keys -- that is expected and will be fixed in Task 2.
  </verify>
  <done>
  - All 4 `.strict()` calls removed from config.ts
  - `loadRepoConfig()` returns `{ config, warnings }` with two-pass safeParse
  - All 3 call sites destructure the new return type and log warnings
  - TypeScript compiles without errors
  - Existing tests pass except the 3 strict-rejection tests (expected -- fixed in Task 2)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update strict-rejection tests and add forward-compat and graceful degradation tests</name>
  <files>
    src/execution/config.test.ts
  </files>
  <action>
  In `src/execution/config.test.ts`:

  1. **Update import** to destructure the new return type:
     - Change `import { loadRepoConfig } from "./config.ts";` to `import { loadRepoConfig, type ConfigWarning } from "./config.ts";`

  2. **Update ALL existing tests** to destructure `{ config, warnings }` (or just `{ config }`) from `loadRepoConfig()` instead of receiving `config` directly. Every test that calls `loadRepoConfig(dir)` and assigns to `config` must change from `const config = await loadRepoConfig(dir)` to `const { config } = await loadRepoConfig(dir)`.

  3. **Update 3 strict-rejection tests** to assert the OPPOSITE behavior (unknown keys stripped, no error):

     a. **"rejects unsupported write keys"** (line 120) -- Rename to "strips unknown write keys without error". Write `write:\n  enabled: false\n  mode: all\n`. Assert it does NOT throw. Assert `config.write.enabled` is `false`. Assert `config.write` does not have a `mode` property. Assert `warnings` is empty (the valid fields parse fine; unknown keys are just stripped).

     b. **"rejects unsupported mention keys"** (line 155) -- Rename to "strips unknown mention keys without error". Write `mention:\n  acceptClaudeAlias: true\n  acceptClaudeAliass: true\n`. Assert no throw. Assert `config.mention.acceptClaudeAlias` is `true`. Assert `warnings` is empty.

     c. **"rejects unsupported review.triggers keys"** (line 284) -- Rename to "strips unknown review.triggers keys without error". Write the same YAML with `onSynchronize: true`. Assert no throw. Assert triggers still have correct values. Assert `warnings` is empty.

  4. **Add new forward-compatibility tests:**

     a. Test: "strips unknown top-level keys without error" -- Write `.kodiai.yml` with `futureFeature: true\nmodel: claude-sonnet-4-5-20250929\n`. Assert no throw, `config.model` correct, no warnings.

     b. Test: "strips unknown nested keys in review section" -- Write `review:\n  enabled: true\n  futureField: hello\n`. Assert no throw, `config.review.enabled` is true, no warnings.

     c. Test: "strips unknown keys in write.secretScan" -- Write `write:\n  enabled: true\n  secretScan:\n    enabled: true\n    extraField: 42\n`. Assert no throw, `config.write.secretScan.enabled` is true, no warnings.

  5. **Add graceful degradation tests:**

     a. Test: "falls back to review defaults when review section is invalid, preserves valid write" -- Write `review:\n  enabled: notaboolean\nwrite:\n  enabled: true\n`. Assert no throw. Assert `config.review.enabled` is `true` (default). Assert `config.write.enabled` is `true` (preserved). Assert `warnings` has length 1 with `section: "review"`.

     b. Test: "falls back to write defaults when write section is invalid, preserves valid review" -- Write `write:\n  enabled: notaboolean\nreview:\n  autoApprove: false\n`. Assert no throw. Assert `config.write.enabled` is `false` (default). Assert `config.review.autoApprove` is `false` (preserved). Assert `warnings` has length 1 with `section: "write"`.

     c. Test: "falls back to mention defaults when mention section is invalid" -- Write `mention:\n  enabled: 42\n`. Assert no throw. Assert `config.mention.enabled` is `true` (default). Assert `warnings` has length 1 with `section: "mention"`.

     d. Test: "falls back to defaults for individual top-level scalars" -- Write `maxTurns: 999\nmodel: claude-opus-4-20250514\n`. Assert no throw. Assert `config.maxTurns` is `25` (default -- 999 exceeds max 100). Assert `config.model` is `"claude-opus-4-20250514"` (preserved). Assert `warnings` has length 1 with `section: "maxTurns"`.

     e. Test: "multiple sections invalid produces multiple warnings" -- Write `write:\n  enabled: notaboolean\nmention:\n  enabled: 42\n`. Assert no throw. Assert both sections fell back to defaults. Assert `warnings.length` is 2.

     f. Test: "completely invalid config (not an object) falls back to all defaults" -- Write `justAString` as the YAML content. This parses to a string, not an object. Assert no throw. Assert all defaults. Assert warnings present.

  6. **Ensure the "rejects invalid YAML" test still passes** -- malformed YAML (e.g. `{{invalid yaml`) should still throw because YAML parse errors are not recoverable. This test should not change.

  7. **Ensure the "rejects invalid values" test is updated** -- The test at line 178 writes `maxTurns: 999` and expects a throw. After the change, this should NOT throw -- it should fall back to defaults with a warning. Update to: assert no throw, `config.maxTurns` is 25 (default), `warnings` has length 1.
  </action>
  <verify>
  Run `bun test src/execution/config.test.ts` -- ALL tests pass (0 failures).
  Run `bunx tsc --noEmit` -- no TypeScript errors.
  </verify>
  <done>
  - All existing tests updated to use `{ config }` or `{ config, warnings }` destructuring
  - 3 former strict-rejection tests now verify unknown keys are stripped without error
  - 1 former "rejects invalid values" test now verifies graceful fallback
  - 6+ new tests cover forward-compatibility (unknown keys at all levels) and graceful degradation (invalid sections fall back to defaults with warnings)
  - All tests pass, TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `bunx tsc --noEmit` passes with zero errors
2. `bun test src/execution/config.test.ts` passes with zero failures
3. `bun test` (full suite) passes with zero failures
4. Manual check: The `loadRepoConfig` function in config.ts has no `.strict()` calls
5. Manual check: The `loadRepoConfig` function returns `{ config, warnings }` not a bare `RepoConfig`
6. Manual check: All 3 call sites (review.ts, mention.ts, executor.ts) destructure `{ config, warnings }` and log warnings
</verification>

<success_criteria>
- CONFIG-01 satisfied: `.kodiai.yml` with unknown keys is accepted without error (unknown keys silently stripped)
- CONFIG-02 satisfied: A valid review section + invalid write section loads review correctly and falls back to write defaults, with a warning identifying the failed section
- Zero-config preserved: No `.kodiai.yml` produces all defaults with no warnings
- All tests pass, TypeScript compiles, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/22-config-validation-safety/22-01-SUMMARY.md`
</output>
