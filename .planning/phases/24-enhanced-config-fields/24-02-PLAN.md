---
phase: 24-enhanced-config-fields
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Setting telemetry.enabled: false causes Kodiai to skip telemetry recording for that repo"
    - "Setting telemetry.costWarningUsd: 2.0 causes a warning comment when execution cost exceeds $2.00"
    - "When telemetry.enabled is false, cost warnings are also suppressed"
    - "Default telemetry config (enabled: true, costWarningUsd: 0) preserves existing behavior with no warnings"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "telemetrySchema section in repoConfigSchema"
      contains: "telemetrySchema"
    - path: "src/handlers/review.ts"
      provides: "Conditional telemetry recording and cost warning"
      contains: "config.telemetry.enabled"
    - path: "src/handlers/mention.ts"
      provides: "Conditional telemetry recording and cost warning"
      contains: "config.telemetry.enabled"
  key_links:
    - from: "src/execution/config.ts"
      to: "src/handlers/review.ts"
      via: "config.telemetry.enabled and config.telemetry.costWarningUsd"
      pattern: "config\\.telemetry\\."
    - from: "src/execution/config.ts"
      to: "src/handlers/mention.ts"
      via: "config.telemetry.enabled and config.telemetry.costWarningUsd"
      pattern: "config\\.telemetry\\."
---

<objective>
Add telemetry config section with opt-out control and cost warning threshold.

Purpose: CONFIG-10 (telemetry opt-out) and CONFIG-11 (cost warning) give repo owners control over telemetry collection and cost visibility.
Output: New telemetry schema section, conditional telemetry recording in both handlers, cost warning comment logic.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-enhanced-config-fields/24-RESEARCH.md
@src/execution/config.ts
@src/handlers/review.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add telemetry schema section to config and wire into Pass 2 fallback</name>
  <files>
    src/execution/config.ts
    src/execution/config.test.ts
  </files>
  <action>
**In `src/execution/config.ts`:**

1. Define `telemetrySchema` (place it after `mentionSchema`, before `repoConfigSchema`):
```typescript
const telemetrySchema = z
  .object({
    /** If false, skip telemetry recording for this repo. Default: true. */
    enabled: z.boolean().default(true),
    /** If set and > 0, warn when execution cost exceeds this USD threshold. 0 = no warning. */
    costWarningUsd: z.number().min(0).default(0),
  })
  .default({ enabled: true, costWarningUsd: 0 });
```

2. Add `telemetry: telemetrySchema` to `repoConfigSchema`:
```typescript
const repoConfigSchema = z.object({
  model: z.string().default("claude-sonnet-4-5-20250929"),
  maxTurns: z.number().min(1).max(100).default(25),
  timeoutSeconds: z.number().min(30).max(1800).default(600),
  systemPromptAppend: z.string().optional(),
  write: writeSchema,
  review: reviewSchema,
  mention: mentionSchema,
  telemetry: telemetrySchema,  // NEW
});
```

3. Add the telemetry section fallback in Pass 2 (after the `mention` section fallback block, before the final `config` assembly):
```typescript
// telemetry
const telemetryResult = telemetrySchema.safeParse(obj.telemetry);
let telemetry: z.infer<typeof telemetrySchema>;
if (telemetryResult.success) {
  telemetry = telemetryResult.data;
} else {
  telemetry = telemetrySchema.parse({});
  warnings.push({
    section: "telemetry",
    issues: telemetryResult.error.issues.map(
      (i) => `${i.path.join(".")}: ${i.message}`,
    ),
  });
}
```

4. Add `telemetry` to the assembled config object:
```typescript
const config: RepoConfig = {
  model,
  maxTurns,
  timeoutSeconds,
  systemPromptAppend,
  review,
  write,
  mention,
  telemetry,  // NEW
};
```

**In `src/execution/config.test.ts`:**

5. Update the "returns defaults when no .kodiai.yml exists" test to verify telemetry defaults:
```typescript
expect(config.telemetry.enabled).toBe(true);
expect(config.telemetry.costWarningUsd).toBe(0);
```

6. Add a test for telemetry field parsing from YAML:
```typescript
test("reads telemetry config from YAML", async () => {
  // write .kodiai.yml with telemetry: { enabled: false, costWarningUsd: 2.5 }
  // expect config.telemetry.enabled to be false
  // expect config.telemetry.costWarningUsd to be 2.5
});
```

7. Add a test for Pass 2 graceful degradation of telemetry section:
```typescript
test("falls back to telemetry defaults when telemetry section is invalid", async () => {
  // write .kodiai.yml with telemetry: { enabled: "notaboolean" } and a valid review section
  // expect config.telemetry.enabled to be true (default)
  // expect config.telemetry.costWarningUsd to be 0 (default)
  // expect config.review to be parsed correctly (not affected by bad telemetry)
  // expect warnings to contain telemetry section
});
```
  </action>
  <verify>
Run `bun test src/execution/config.test.ts` -- all tests pass including new telemetry tests.
  </verify>
  <done>
telemetrySchema exists with `enabled` (default true) and `costWarningUsd` (default 0). The schema is wired into `repoConfigSchema` and has Pass 2 section-level fallback. Config tests verify defaults, YAML parsing, and graceful degradation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire telemetry opt-out and cost warning into both handlers</name>
  <files>
    src/handlers/review.ts
    src/handlers/review.test.ts
    src/handlers/mention.ts
    src/handlers/mention.test.ts
  </files>
  <action>
**In `src/handlers/review.ts`:**

1. Wrap the existing telemetry capture block (~lines 483-504) in a `config.telemetry.enabled` check:
```typescript
// Fire-and-forget telemetry capture (TELEM-03, TELEM-05, CONFIG-10)
if (config.telemetry.enabled) {
  try {
    telemetryStore.record({
      // ... existing fields unchanged ...
    });
  } catch (err) {
    logger.warn({ err }, "Telemetry write failed (non-blocking)");
  }
}
```

2. Add cost warning logic AFTER the telemetry capture block (and still inside the `config.telemetry.enabled` check). The warning should: (a) always log via logger.warn, (b) post a GitHub comment on the PR:
```typescript
// Cost warning (CONFIG-11)
if (
  config.telemetry.costWarningUsd > 0 &&
  result.costUsd !== undefined &&
  result.costUsd > config.telemetry.costWarningUsd
) {
  logger.warn(
    {
      costUsd: result.costUsd,
      threshold: config.telemetry.costWarningUsd,
      repo: `${apiOwner}/${apiRepo}`,
      prNumber: pr.number,
    },
    "Execution cost exceeded warning threshold",
  );
  try {
    const warnOctokit = await githubApp.getInstallationOctokit(event.installationId);
    await warnOctokit.rest.issues.createComment({
      owner: apiOwner,
      repo: apiRepo,
      issue_number: pr.number,
      body: `> **Kodiai cost warning:** This execution cost \$${result.costUsd.toFixed(4)} USD, exceeding the configured threshold of \$${config.telemetry.costWarningUsd.toFixed(2)} USD.\n>\n> Configure in \`.kodiai.yml\`:\n> \`\`\`yml\n> telemetry:\n>   costWarningUsd: 5.0  # or 0 to disable\n> \`\`\``,
    });
  } catch (err) {
    logger.warn({ err }, "Failed to post cost warning comment (non-blocking)");
  }
}
```

IMPORTANT: The cost warning is INSIDE the `if (config.telemetry.enabled)` block. When telemetry is disabled, both recording AND cost warnings are suppressed (per Pitfall 2 from research).

**In `src/handlers/mention.ts`:**

3. Apply the same pattern: wrap existing telemetry capture (~lines 696-717) in `config.telemetry.enabled` check.

4. Add the same cost warning logic after telemetry capture (still inside the `config.telemetry.enabled` block). For mention handler, the comment target uses `mention.issueNumber ?? mention.prNumber` for the issue_number, and `mention.owner`/`mention.repo` for owner/repo.

**In `src/handlers/review.test.ts`:**

5. Add tests for CONFIG-10 telemetry opt-out in review handler:
- Test: `telemetry.enabled: false` causes telemetryStore.record NOT to be called after review execution
- Test: `telemetry.enabled: true` (default) causes telemetryStore.record to be called (existing behavior)

6. Add tests for CONFIG-11 cost warning in review handler:
- Test: when costWarningUsd is set and result.costUsd exceeds it, a cost warning comment is posted
- Test: when costWarningUsd is 0 (default), no cost warning comment is posted even if costUsd is high
- Test: when telemetry.enabled is false, no cost warning comment is posted (even if threshold exceeded)

**In `src/handlers/mention.test.ts`:**

7. Add equivalent tests for CONFIG-10 and CONFIG-11 in mention handler:
- Test: `telemetry.enabled: false` suppresses telemetry recording for mentions
- Test: cost warning comment posted when threshold exceeded
- Test: no cost warning when telemetry disabled

For mock setup: the telemetryStore in existing test fixtures is a mock with a `record` method. Add assertion tracking (e.g. `recordCalls` counter or spy) to verify calls/non-calls.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts src/handlers/mention.test.ts` -- all tests pass including new telemetry opt-out and cost warning tests.
  </verify>
  <done>
Both handlers conditionally skip telemetry recording when `config.telemetry.enabled` is false. Both handlers post a cost warning GitHub comment when `config.telemetry.costWarningUsd > 0` and execution cost exceeds the threshold. Cost warnings are suppressed when telemetry is disabled. All behaviors verified by tests.
  </done>
</task>

</tasks>

<verification>
1. `bun test` -- all tests pass
2. Verify telemetry defaults: `config.telemetry.enabled === true`, `config.telemetry.costWarningUsd === 0`
3. Verify telemetry opt-out: setting `telemetry.enabled: false` suppresses both recording and cost warnings
4. Verify cost warning fires: when threshold > 0 and costUsd > threshold, comment is posted
5. Verify cost warning does NOT fire: when threshold is 0 (default), or when telemetry disabled
6. Verify Pass 2 graceful degradation: invalid telemetry section falls back to defaults without affecting other sections
</verification>

<success_criteria>
- telemetrySchema exists in config.ts with enabled + costWarningUsd fields
- Both handlers wrap telemetry recording in config.telemetry.enabled check
- Both handlers post cost warning comment when threshold exceeded
- Cost warnings suppressed when telemetry disabled (Pitfall 2 avoided)
- Pass 2 section fallback handles invalid telemetry gracefully
- All existing tests pass, new tests cover CONFIG-10 and CONFIG-11
</success_criteria>

<output>
After completion, create `.planning/phases/24-enhanced-config-fields/24-02-SUMMARY.md`
</output>
