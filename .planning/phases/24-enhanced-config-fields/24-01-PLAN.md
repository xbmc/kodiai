---
phase: 24-enhanced-config-fields
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "Setting mentions.allowedUsers: ['alice'] causes Kodiai to respond only to alice's mentions and ignore everyone else's"
    - "Empty allowedUsers (default) allows all users to trigger mentions"
    - "Setting review.skipPaths: ['docs/**'] skips review when all changed files match the glob pattern"
    - "skipPaths patterns like '*.md' match nested paths (backward-compatible with old behavior)"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "mentionSchema with allowedUsers field"
      contains: "allowedUsers"
    - path: "src/handlers/mention.ts"
      provides: "allowedUsers enforcement gate"
      contains: "mention-allowed-users"
    - path: "src/handlers/review.ts"
      provides: "picomatch-based skipPaths matching"
      contains: "picomatch"
  key_links:
    - from: "src/execution/config.ts"
      to: "src/handlers/mention.ts"
      via: "config.mention.allowedUsers"
      pattern: "config\\.mention\\.allowedUsers"
    - from: "src/handlers/review.ts"
      to: "picomatch"
      via: "import and glob matching for skipPaths"
      pattern: "picomatch"
---

<objective>
Add `allowedUsers` field to mention config and upgrade `skipPaths` matching to picomatch globs.

Purpose: CONFIG-07 (mention allowlist) and CONFIG-04 upgrade (picomatch glob matching) complete the user-facing review/mention controls.
Output: Updated config schema, mention handler with user gating, review handler with picomatch skipPaths.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-enhanced-config-fields/24-RESEARCH.md
@src/execution/config.ts
@src/handlers/mention.ts
@src/handlers/review.ts
@src/jobs/workspace.ts (reference for normalizeGlobPattern and picomatch usage pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allowedUsers to mention config schema and enforce in handler</name>
  <files>
    src/execution/config.ts
    src/handlers/mention.ts
  </files>
  <action>
**In `src/execution/config.ts`:**

1. Add `allowedUsers` field to `mentionSchema`:
```typescript
const mentionSchema = z
  .object({
    enabled: z.boolean().default(true),
    acceptClaudeAlias: z.boolean().default(true),
    /** If non-empty, only these GitHub users can trigger @kodiai mentions. Empty = all users allowed. */
    allowedUsers: z.array(z.string()).default([]),
    prompt: z.string().optional(),
  })
  .default({ enabled: true, acceptClaudeAlias: true, allowedUsers: [] });
```

2. No changes needed to `loadRepoConfig()` Pass 2 -- the mention section already has a fallback block, and the new field has a `.default([])` so it'll parse correctly.

**In `src/handlers/mention.ts`:**

3. Add allowedUsers enforcement gate AFTER the `mention.enabled` check and BEFORE the alias/handle matching. Insert after line ~336 (after the `if (!config.mention.enabled)` block):
```typescript
// Check mention.allowedUsers (CONFIG-07)
if (config.mention.allowedUsers.length > 0) {
  const normalizedAuthor = mention.commentAuthor.toLowerCase();
  const allowed = config.mention.allowedUsers.map((u) => u.toLowerCase());
  if (!allowed.includes(normalizedAuthor)) {
    logger.info(
      {
        owner: mention.owner,
        repo: mention.repo,
        commentAuthor: mention.commentAuthor,
        gate: "mention-allowed-users",
        gateResult: "skipped",
        skipReason: "user-not-allowlisted",
      },
      "Mention author not in allowedUsers, skipping",
    );
    return;
  }
}
```

Key semantics:
- Empty `allowedUsers` (default) = all users allowed (no gating)
- Non-empty = only listed users pass; matching is case-insensitive
- Uses the established gate logging pattern (gate name, gateResult, skipReason)
  </action>
  <verify>
Run `bun test src/execution/config.test.ts` and `bun test src/handlers/mention.test.ts` -- all existing tests pass (new field has safe default).
  </verify>
  <done>
mentionSchema includes `allowedUsers: z.array(z.string()).default([])`. Mention handler has a guard that skips execution when the comment author is not in the non-empty allowedUsers list. Default config (no `.kodiai.yml`) has empty allowedUsers, preserving the all-users-allowed behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade review skipPaths to picomatch and add comprehensive tests</name>
  <files>
    src/handlers/review.ts
    src/handlers/review.test.ts
    src/execution/config.test.ts
    src/handlers/mention.test.ts
  </files>
  <action>
**In `src/handlers/review.ts`:**

1. Add `import picomatch from "picomatch";` at the top of the file (picomatch is already a project dependency).

2. Add a `normalizeSkipPattern` helper near the top of the file (or inline). This is needed to maintain backward compatibility with the current basic matching patterns:
```typescript
function normalizeSkipPattern(pattern: string): string {
  const p = pattern.trim();
  if (p.endsWith("/")) return `${p}**`;        // "docs/" -> "docs/**"
  if (p.startsWith("*.")) return `**/${p}`;     // "*.md" -> "**/*.md"
  return p;
}
```

Note: workspace.ts has `normalizeGlobPattern` that only handles the `dir/` case. The review handler also needs the `*.ext` -> `**/*.ext` normalization for backward compat, so a separate (slightly extended) function is appropriate here.

3. Replace the basic string matching block (~lines 418-431) with picomatch-based matching:
```typescript
const skipMatchers = config.review.skipPaths
  .map(normalizeSkipPattern)
  .filter((p) => p.length > 0)
  .map((p) => picomatch(p, { dot: true }));

const changedFiles = allChangedFiles.filter((file) => {
  return !skipMatchers.some((m) => m(file));
});
```

**In `src/execution/config.test.ts`:**

4. Add a test for the new `allowedUsers` field defaults:
```typescript
test("mention.allowedUsers defaults to empty array", async () => {
  // verify via loadRepoConfig with no .kodiai.yml
  // expect config.mention.allowedUsers to equal []
});
```

5. Add a test for allowedUsers parsing when provided in YAML:
```typescript
test("reads mention.allowedUsers from YAML", async () => {
  // write .kodiai.yml with mention: { allowedUsers: ["alice", "bob"] }
  // expect config.mention.allowedUsers to equal ["alice", "bob"]
});
```

**In `src/handlers/mention.test.ts`:**

6. Add tests for CONFIG-07 allowedUsers enforcement:
- Test: mention from allowed user proceeds (executor called)
- Test: mention from non-allowed user is skipped (executor NOT called)
- Test: empty allowedUsers allows all users (existing behavior preserved)

**In `src/handlers/review.test.ts`:**

7. Add tests for CONFIG-04 picomatch skipPaths:
- Test: `skipPaths: ["docs/**"]` skips review when all files are under docs/
- Test: `skipPaths: ["*.md"]` skips review when all files are .md (including nested like `src/README.md`)
- Test: files not matching skipPaths still get reviewed
  </action>
  <verify>
Run `bun test src/execution/config.test.ts src/handlers/review.test.ts src/handlers/mention.test.ts` -- all tests pass including new ones.
  </verify>
  <done>
Review handler skipPaths uses picomatch with backward-compatible pattern normalization. `*.md` matches nested .md files. `docs/**` matches all files under docs/. Config tests verify allowedUsers schema parsing. Handler tests verify allowedUsers enforcement and picomatch skipPaths behavior.
  </done>
</task>

</tasks>

<verification>
1. `bun test` -- all tests pass
2. Verify `config.mention.allowedUsers` defaults to `[]` (no breakage for repos without the field)
3. Verify `skipPaths: ["docs/**"]` skips review when all changed files are under docs/
4. Verify `skipPaths: ["*.md"]` skips review for nested .md files (backward compat via normalization)
5. Verify allowedUsers enforcement: non-listed user skipped, listed user proceeds
</verification>

<success_criteria>
- mentionSchema has allowedUsers field with safe default
- Mention handler gates on allowedUsers when non-empty, allows all when empty
- Review handler uses picomatch for skipPaths with backward-compatible normalization
- All existing tests pass, new tests cover CONFIG-07 and CONFIG-04 upgrade
</success_criteria>

<output>
After completion, create `.planning/phases/24-enhanced-config-fields/24-01-SUMMARY.md`
</output>
