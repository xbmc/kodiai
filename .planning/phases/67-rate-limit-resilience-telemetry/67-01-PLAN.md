---
phase: 67-rate-limit-resilience-telemetry
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "When GitHub Search API responds with a rate-limit error, review enrichment retries exactly once with bounded backoff"
    - "If retry still fails due to rate limits, review execution continues in degraded mode instead of failing hard"
    - "Published review output clearly states that analysis is partial due to Search API limits when degradation occurs"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Rate-limit-aware bounded retry and degrade-to-partial control flow for Search enrichment"
      contains: "retryAttempts"
    - path: "src/execution/review-prompt.ts"
      provides: "Prompt section that injects a partial-analysis disclaimer when rate-limit degradation is active"
      contains: "partial due to API limits"
    - path: "src/handlers/review.test.ts"
      provides: "Regression tests for single retry, fail-open degradation, and partial-output messaging"
      contains: "rate limit"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "degradation state passed into review prompt generation"
      pattern: "buildReviewPrompt"
    - from: "src/handlers/review.ts"
      to: "src/handlers/review.test.ts"
      via: "tests assert one retry and degraded completion on repeated rate-limit responses"
      pattern: "retry|partial"
---

<objective>
Add Search API rate-limit resilience so review enrichment performs a single bounded retry, then fails open into a clearly communicated partial-analysis path.

Purpose: Deliver OPS-02 behavior in the live review flow by preventing hard failures during Search API throttling while making degraded outcomes explicit to users.
Output: Updated review handler and review prompt contracts with deterministic regressions for bounded retry and degraded messaging.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-search-cache-foundation/66-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add bounded Search API retry and degrade-to-partial path</name>
  <files>src/handlers/review.ts</files>
  <action>
Implement a rate-limit-aware wrapper around Search API enrichment in `resolveAuthorTier` and propagate outcome metadata to the main review flow:

1) Detect Search API rate-limit responses (primary and secondary) using response status/error payload/headers.
   - Handle common GitHub limit indicators (403/429 plus rate-limit message markers).
   - Keep detection centralized in helper logic so tests can assert behavior deterministically.

2) Apply bounded retry exactly once.
   - On the first detected rate-limit error, compute bounded backoff from `retry-after`/reset hints when present, clamped to a short max wait (do not block indefinitely).
   - Retry one time only, then stop retrying regardless of result.

3) If retry still rate-limited, degrade gracefully.
   - Continue review execution with reduced enrichment context (no hard failure, no thrown error path).
   - Return structured degradation metadata (e.g., `degraded`, `retryAttempts`, `skippedQueries`, `degradationPath`) alongside author-tier result for downstream messaging/telemetry.

Do not change existing non-rate-limit fail-open behavior; other Search API errors should still warn and continue without new retry loops.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000` after adding targeted regressions.
  </verify>
  <done>
Rate-limited Search enrichment retries once with bounded delay and then completes review in explicit degraded mode instead of failing the run.
  </done>
</task>

<task type="auto">
  <name>Task 2: Surface degraded-rate-limit messaging in published review output</name>
  <files>src/handlers/review.ts, src/execution/review-prompt.ts, src/execution/review-prompt.test.ts, src/handlers/review.test.ts</files>
  <action>
Wire degradation metadata into review output contract so users see a clear partial-analysis disclaimer when Search limits force fallback:

- Extend `buildReviewPrompt` inputs with a minimal rate-limit degradation context object.
- Add prompt instructions that require a short, explicit note that analysis is partial due to Search API limits when degradation is active.
- Ensure normal (non-degraded) reviews remain unchanged and do not emit the disclaimer.
- Add regressions proving degraded runs include the disclaimer and non-degraded runs do not.

Keep wording stable and deterministic so telemetry/UAT can assert on known phrasing.
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts --timeout 30000`.
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
When rate-limit degradation occurs, published review output consistently states the review is partial due to API limits; standard outputs remain unchanged otherwise.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts --timeout 30000` passes with bounded-retry and degraded-path assertions.
- `bun test src/execution/review-prompt.test.ts --timeout 30000` passes with degraded messaging assertions.
- `bunx tsc --noEmit` passes.
- No new infinite or multi-retry behavior exists (single retry cap is enforced in tests).
</verification>

<success_criteria>
OPS-02 is satisfied for Search enrichment behavior: rate-limit responses trigger one bounded retry, then deterministic fail-open degradation with explicit user-facing partial-analysis messaging.
</success_criteria>

<output>
After completion, create `.planning/phases/67-rate-limit-resilience-telemetry/67-01-SUMMARY.md`
</output>
