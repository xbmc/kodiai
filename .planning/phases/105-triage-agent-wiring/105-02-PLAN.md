---
phase: 105-triage-agent-wiring
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/triage/triage-agent.ts
  - src/triage/triage-agent.test.ts
autonomous: true
requirements: [TRIA-02]

must_haves:
  truths:
    - "validateIssue() fetches templates from workspace .github/ISSUE_TEMPLATE/ directory"
    - "validateIssue() matches issue body against the best-fit template"
    - "generateGuidanceComment() produces a friendly bulleted list of missing sections with hints"
    - "generateLabelRecommendation() returns needs-info:{template_slug} convention-based label"
    - "No label recommended when issue passes validation"
    - "Generic nudge returned when no template matches the issue"
    - "Comment only shows what is missing, not a full pass/fail breakdown"
  artifacts:
    - path: "src/triage/triage-agent.ts"
      provides: "Triage validation agent"
      exports: ["validateIssue", "generateGuidanceComment", "generateLabelRecommendation"]
    - path: "src/triage/triage-agent.test.ts"
      provides: "Unit tests for triage agent"
      min_lines: 120
  key_links:
    - from: "src/triage/triage-agent.ts"
      to: "src/triage/template-parser.ts"
      via: "imports parseTemplate, diffAgainstTemplate"
      pattern: "import"
    - from: "src/triage/triage-agent.ts"
      to: "src/triage/types.ts"
      via: "imports TriageValidationResult, TemplateDefinition"
      pattern: "import"
---

<objective>
Implement the triage validation agent using TDD.

Purpose: Validate an issue body against repo templates, generate structured guidance comments and label recommendations.
Output: `triage-agent.ts` and `triage-agent.test.ts` in `src/triage/`
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
@/home/keith/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/105-triage-agent-wiring/105-CONTEXT.md
@.planning/phases/105-triage-agent-wiring/105-RESEARCH.md

<interfaces>
<!-- Types from Plan 01 that this plan depends on -->

From src/triage/types.ts:
```typescript
export type TemplateSection = {
  heading: string;
  required: boolean;
  hint: string | null;
};

export type TemplateDefinition = {
  slug: string;
  name: string;
  labels: string[];
  sections: TemplateSection[];
};

export type SectionStatus = "present" | "missing" | "empty";

export type SectionResult = {
  heading: string;
  status: SectionStatus;
  hint: string | null;
  required: boolean;
};

export type TriageValidationResult = {
  templateSlug: string;
  templateName: string;
  sections: SectionResult[];
  valid: boolean;
};
```

From src/triage/template-parser.ts:
```typescript
export function parseTemplate(slug: string, content: string): TemplateDefinition;
export function diffAgainstTemplate(template: TemplateDefinition, issueBody: string): TriageValidationResult;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement triage validation agent with TDD</name>
  <files>src/triage/triage-agent.ts, src/triage/triage-agent.test.ts</files>
  <action>
Create `src/triage/triage-agent.ts` with these functions:

**`validateIssue(params: { workspaceDir: string; issueBody: string | null }): Promise<TriageValidationResult | null>`**
- Read `.github/ISSUE_TEMPLATE/` directory from `workspaceDir` using `readdir` + `readFile` (fs/promises)
- Filter for `.md` files only
- For each template file: parse with `parseTemplate(slug, content)` where slug = filename without `.md`
- Best-fit template matching strategy:
  1. Parse issue body headings
  2. For each template, count how many of its required section headings appear in the issue body (case-insensitive heading comparison)
  3. Pick the template with the highest match count (at least 1 match required)
  4. If no template has any matches: return null (no template matched)
- Run `diffAgainstTemplate(bestTemplate, issueBody)` and return the result
- If issueBody is null or empty string: return null
- If `.github/ISSUE_TEMPLATE/` directory does not exist: return null

**`generateGuidanceComment(result: TriageValidationResult): string`**
- Tone: "Thanks for filing! A few details would help us help you faster..."
- Bulleted list of missing/empty required sections only
- For each missing section: `- **{heading}**: {hint text or generic guidance}`
  - If section status is "missing": say "This section is missing"
  - If section status is "empty": say "This section looks empty"
  - Append the hint from the template if available
- Only show what is missing -- do NOT include present sections
- Keep it short and actionable
- If no required sections are missing (valid = true): return empty string

**`generateLabelRecommendation(params: { result: TriageValidationResult; labelAllowlist: string[] }): string | null`**
- Derive label: `needs-info:${result.templateSlug}`
- If `labelAllowlist` is non-empty: check if derived label matches any pattern in the allowlist (simple string prefix or exact match)
- If allowlist check fails: return null
- If `result.valid` is true (no missing sections): return null (no label needed)
- Return the derived label string

**`generateGenericNudge(): string`**
- Returns a friendly one-sentence message suggesting the user pick an issue template
- Example: "It looks like this issue wasn't filed using one of our templates. Using a template helps us understand and prioritize your request faster -- check out the available templates when creating a new issue."

Write TDD tests in `src/triage/triage-agent.test.ts`:

**validateIssue tests:**
- Mock filesystem with a `.github/ISSUE_TEMPLATE/bug-report.md` template
- Issue body matching bug-report template with all sections -- returns valid result
- Issue body missing required sections -- returns invalid result with section details
- Issue body matching no template -- returns null
- Null/empty issue body -- returns null
- No `.github/ISSUE_TEMPLATE/` directory -- returns null
- Multiple templates, best-fit selection picks the template with most heading matches

**generateGuidanceComment tests:**
- Result with missing sections -- produces bulleted list
- Result with empty sections -- produces bulleted list with "looks empty" wording
- Result with all present (valid) -- returns empty string
- Hints from template included in bullets

**generateLabelRecommendation tests:**
- Invalid result + empty allowlist -- returns `needs-info:bug-report`
- Invalid result + allowlist that includes the label -- returns label
- Invalid result + allowlist that excludes the label -- returns null
- Valid result (no missing) -- returns null regardless of allowlist

**generateGenericNudge tests:**
- Returns non-empty string
- Does not mention specific template names

For filesystem mocking in tests: use `mkdtemp` + write actual files to temp dir, then clean up. This avoids mocking fs modules and tests real file I/O.
  </action>
  <verify>
    <automated>bun test src/triage/triage-agent.test.ts</automated>
  </verify>
  <done>
    - validateIssue correctly matches issues against templates and returns validation results
    - generateGuidanceComment produces friendly, actionable missing-field guidance
    - generateLabelRecommendation derives convention-based labels with allowlist gating
    - All tests pass with bun test
  </done>
</task>

</tasks>

<verification>
- `bun test src/triage/triage-agent.test.ts` passes all tests
- Functions are importable from `src/triage/triage-agent.ts`
- Comment output matches CONTEXT.md tone: "friendly helper, warm and encouraging"
</verification>

<success_criteria>
- Triage agent validates issues against filesystem templates
- Guidance comments are short, bulleted, show only missing fields
- Label recommendation follows `needs-info:{slug}` convention
- Generic nudge covers the no-template-match case
- At least 10 test cases covering documented scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/105-triage-agent-wiring/105-02-SUMMARY.md`
</output>
