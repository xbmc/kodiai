---
phase: 105-triage-agent-wiring
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - src/execution/config.ts
  - src/execution/executor.ts
  - src/execution/mention-prompt.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true
requirements: [TRIA-03]

must_haves:
  truths:
    - "Triage config schema includes labelAllowlist and cooldownMinutes fields"
    - "Executor passes enableIssueTools and triageConfig to buildMcpServers when issue mention + triage.enabled"
    - "Mention handler runs triage validation for issue_comment surface when triage.enabled"
    - "Triage nudge appended as single sentence to mention prompt when fields are missing"
    - "Per-issue cooldown prevents repeated triage nudges within cooldownMinutes"
    - "Cooldown resets when issue body hash changes (edit detection)"
    - "Label recommendation included in triage context for agent to apply via MCP tool"
    - "No triage nudge when all template fields are present"
    - "Generic nudge when issue doesn't match any template"
    - "Label allowlist from .kodiai.yml triage config is respected"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Extended triage config schema"
    - path: "src/execution/executor.ts"
      provides: "Issue tool wiring for triage"
    - path: "src/execution/mention-prompt.ts"
      provides: "Triage context injection in mention prompt"
    - path: "src/handlers/mention.ts"
      provides: "Triage integration in mention flow"
    - path: "src/handlers/mention.test.ts"
      provides: "Integration tests for triage wiring"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/triage/triage-agent.ts"
      via: "imports validateIssue, generateGuidanceComment, generateLabelRecommendation, generateGenericNudge"
      pattern: "import"
    - from: "src/execution/executor.ts"
      to: "src/execution/mcp/index.ts"
      via: "passes enableIssueTools + triageConfig to buildMcpServers"
      pattern: "enableIssueTools"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "passes triageContext to buildMentionPrompt"
      pattern: "triageContext"
---

<objective>
Wire triage validation into the @kodiai mention path for issues.

Purpose: Connect the template parser and triage agent to the existing mention handler, executor, and prompt builder so that when @kodiai is mentioned on an issue, the bot answers the question AND appends a triage nudge if template fields are missing.
Output: Modified config, executor, mention handler, and mention prompt files with integration tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/105-triage-agent-wiring/105-CONTEXT.md
@.planning/phases/105-triage-agent-wiring/105-RESEARCH.md
@.planning/phases/105-triage-agent-wiring/105-01-SUMMARY.md
@.planning/phases/105-triage-agent-wiring/105-02-SUMMARY.md

<interfaces>
<!-- Existing interfaces that will be modified -->

From src/execution/config.ts (triage schema, line 460-479):
```typescript
const triageSchema = z.object({
  enabled: z.boolean().default(false),
  label: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
  comment: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
}).default({ enabled: false, label: { enabled: true }, comment: { enabled: true } });
```

From src/execution/executor.ts (buildMcpServers call, line 101-125):
```typescript
const mcpServers = buildMcpServers({
  getOctokit, owner, repo, prNumber, commentId, botHandles,
  reviewOutputKey, deliveryId, logger, onPublish, onPublishEvent,
  enableInlineTools, enableCommentTools, knowledgeStore, totalFiles,
  enableCheckpointTool,
  // NOTE: enableIssueTools and triageConfig NOT passed yet
});
```

From src/execution/mcp/index.ts (buildMcpServers signature):
```typescript
export function buildMcpServers(deps: {
  // ...existing params...
  enableIssueTools?: boolean;
  triageConfig?: TriageConfig;
}): Record<string, McpServerConfig>;
```

From src/execution/mention-prompt.ts (buildMentionPrompt params):
```typescript
export function buildMentionPrompt(params: {
  mention: MentionEvent;
  mentionContext: string;
  retrievalContext?: {...};
  userQuestion: string;
  findingContext?: {...};
  customInstructions?: string;
  outputLanguage?: string;
  unifiedResults?: UnifiedRetrievalChunk[];
  contextWindow?: string;
}): string;
```

From src/triage/triage-agent.ts (Plan 01+02 outputs):
```typescript
export function validateIssue(params: { workspaceDir: string; issueBody: string | null }): Promise<TriageValidationResult | null>;
export function generateGuidanceComment(result: TriageValidationResult): string;
export function generateLabelRecommendation(params: { result: TriageValidationResult; labelAllowlist: string[] }): string | null;
export function generateGenericNudge(): string;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend triage config schema and wire executor</name>
  <files>src/execution/config.ts, src/execution/executor.ts</files>
  <action>
**In `src/execution/config.ts`:**

Extend the `triageSchema` to add two new fields:

```typescript
const triageSchema = z.object({
  enabled: z.boolean().default(false),
  label: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
  comment: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
  // NEW:
  labelAllowlist: z.array(z.string()).default([]),
  cooldownMinutes: z.number().min(0).max(1440).default(30),
}).default({
  enabled: false,
  label: { enabled: true },
  comment: { enabled: true },
  labelAllowlist: [],
  cooldownMinutes: 30,
});
```

Update the default fallback in `loadRepoConfig()` where `triageSchema.parse({})` is called -- ensure the new fields are included in the default object.

**In `src/execution/executor.ts`:**

After the existing `buildMcpServers()` call (around line 101), add conditional issue tool wiring:

1. Detect issue mentions: check if `context.eventType === "issue_comment.created"` AND `context.prNumber === undefined`
2. When it's an issue mention AND `config.triage.enabled` is true:
   - Pass `enableIssueTools: true` to `buildMcpServers()`
   - Pass `triageConfig: { enabled: config.triage.enabled, label: config.triage.label, comment: config.triage.comment }` to `buildMcpServers()`
3. When triage is disabled or it's not an issue mention: don't pass these params (existing behavior)

The executor already loads `config` via `loadRepoConfig()` at line 33. Use that parsed config.
  </action>
  <verify>
    <automated>bun test src/execution/config.test.ts</automated>
  </verify>
  <done>
    - triageSchema accepts labelAllowlist (string[]) and cooldownMinutes (number, default 30)
    - Executor passes enableIssueTools and triageConfig when triage.enabled + issue mention
    - Existing config tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate triage into mention handler and prompt</name>
  <files>src/execution/mention-prompt.ts, src/handlers/mention.ts, src/handlers/mention.test.ts</files>
  <action>
**In `src/execution/mention-prompt.ts`:**

Add an optional `triageContext` parameter to `buildMentionPrompt()`:

```typescript
export function buildMentionPrompt(params: {
  // ...existing params...
  triageContext?: string;  // NEW
}): string;
```

In the function body, if `triageContext` is non-empty, append it near the end of the prompt (after the main instructions, before output language). Format:

```
## Issue Template Compliance

{triageContext}

When responding, answer the user's question first (this is your PRIMARY goal). Then, if the triage context above indicates missing fields, append a brief one-sentence nudge at the end of your response mentioning what's missing. Keep the nudge concise -- one sentence, not a full breakdown.

If a label recommendation is provided above, use the github_issue_label tool to apply it. If the label doesn't exist on the repo, skip labeling and mention it briefly.
```

**In `src/handlers/mention.ts`:**

Add triage integration in the `isIssueThreadComment` section (around line 1091, after the issue code context block):

1. Add imports at the top:
```typescript
import { validateIssue, generateGuidanceComment, generateLabelRecommendation, generateGenericNudge } from "../triage/triage-agent.ts";
import { createHash } from "node:crypto";  // already imported
```

2. Add an in-memory cooldown map near the existing rate limiter maps (around line 148):
```typescript
const triageCooldowns = new Map<string, { lastTriagedAt: number; bodyHash: string }>();
```

3. After the issue code context block (after line 1113), add triage validation:

```typescript
let triageContext = "";
if (isIssueThreadComment && config.triage.enabled) {
  const issueBody = /* extract from the webhook payload -- it's available on the issue_comment event */;
  const cooldownKey = `${mention.owner}/${mention.repo}#${mention.issueNumber}`;
  const bodyHash = createHash("sha256").update(issueBody ?? "").digest("hex").slice(0, 16);
  const cooldownEntry = triageCooldowns.get(cooldownKey);
  const cooldownMs = config.triage.cooldownMinutes * 60 * 1000;
  const now = Date.now();

  const withinCooldown = cooldownEntry
    && cooldownEntry.bodyHash === bodyHash
    && (now - cooldownEntry.lastTriagedAt) < cooldownMs;

  if (!withinCooldown) {
    try {
      const validationResult = await validateIssue({
        workspaceDir: workspace.dir,
        issueBody,
      });

      if (validationResult === null) {
        // No template matched
        triageContext = generateGenericNudge();
      } else if (!validationResult.valid) {
        const guidance = generateGuidanceComment(validationResult);
        const labelRec = generateLabelRecommendation({
          result: validationResult,
          labelAllowlist: config.triage.labelAllowlist ?? [],
        });

        triageContext = guidance;
        if (labelRec) {
          triageContext += `\n\nRecommended label: \`${labelRec}\``;
        }
      }
      // If valid, triageContext stays empty -- no nudge needed

      // Update cooldown
      triageCooldowns.set(cooldownKey, { lastTriagedAt: now, bodyHash });
    } catch (err) {
      logger.warn({ err, issueNumber: mention.issueNumber }, "Triage validation failed (fail-open)");
    }
  }
}
```

4. Pass `triageContext` to `buildMentionPrompt()`:
```typescript
const mentionPrompt = buildMentionPrompt({
  // ...existing params...
  triageContext,  // NEW
});
```

5. The issue body is available from the webhook payload. For `issue_comment.created` events, the issue body is at `event.payload.issue.body`. You need to thread this through -- the `MentionEvent` type doesn't currently carry the issue body. Add it:
   - In `src/handlers/mention-types.ts`: add `issueBody: string | null` to the `MentionEvent` interface
   - In `normalizeIssueComment()`: set `issueBody: payload.issue.body ?? null`
   - In `normalizeReviewComment()` and `normalizeReviewBody()`: set `issueBody: null` (not relevant for PR surfaces)

6. Add cooldown pruning: add a `pruneTriageCooldowns(now)` function similar to the existing `pruneRateLimiter` and `pruneConversationTurns` patterns. Call it before the cooldown check. TTL: 24 hours, hard cap: 1000 entries.

**In `src/handlers/mention.test.ts`:**

Add integration tests for the triage wiring. The existing test file is large (~200KB) and uses extensive mocking. Add a new `describe("triage integration")` block with these tests:

- Issue mention with triage enabled + missing fields: triageContext is non-empty and passed to prompt
- Issue mention with triage enabled + all fields present: triageContext is empty
- Issue mention with triage disabled: no triage validation runs
- PR mention: no triage validation (isIssueThreadComment is false)
- Cooldown: second mention within cooldown skips triage
- Cooldown reset: mention after body edit (different hash) runs triage again

NOTE: The existing test infrastructure mocks the executor, octokit, and workspace. Follow the existing test patterns for mocking. For triage-specific mocking, mock the `validateIssue` import.
  </action>
  <verify>
    <automated>bun test src/handlers/mention.test.ts --timeout 60000</automated>
  </verify>
  <done>
    - Triage context injected into mention prompt for issue mentions when triage.enabled
    - Per-issue cooldown with body-hash reset working
    - MentionEvent carries issueBody field
    - Cooldown map pruning prevents unbounded growth
    - All existing mention tests still pass
    - New triage integration tests pass
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes (config schema)
- `bun test src/handlers/mention.test.ts --timeout 60000` passes (mention + triage)
- `bun test src/triage/` passes (all triage unit tests)
- End-to-end: issue_comment.created event with triage.enabled config -> executor gets issue MCP tools -> mention prompt includes triage context
</verification>

<success_criteria>
- @kodiai mention on an issue triggers triage validation when triage.enabled in .kodiai.yml
- Triage nudge is a brief sentence appended to the primary response
- Label recommendation passed to agent for MCP tool application
- Cooldown prevents comment spam (30 min default, reset on body edit)
- Label allowlist from config is respected
- Generic nudge for no-template-match issues
- Fail-open: triage errors don't block the primary mention response
</success_criteria>

<output>
After completion, create `.planning/phases/105-triage-agent-wiring/105-03-SUMMARY.md`
</output>
