---
phase: 105-triage-agent-wiring
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/triage/template-parser.ts
  - src/triage/template-parser.test.ts
  - src/triage/types.ts
autonomous: true
requirements: [TRIA-01]

must_haves:
  truths:
    - "Parser reads .md template files and extracts YAML frontmatter (name, labels, assignees)"
    - "Parser extracts ## section headers as required fields from template body"
    - "Sections marked with <!-- optional --> comment are flagged as optional"
    - "diffAgainstTemplate() identifies absent headings in issue body"
    - "diffAgainstTemplate() identifies headings with empty/placeholder content"
    - "Missing vs empty sections are distinguished in the result"
    - "Templates without YAML frontmatter fall back to header-only parsing"
    - "parseTemplate() returns structured TemplateDefinition with sections array"
  artifacts:
    - path: "src/triage/types.ts"
      provides: "Triage type definitions"
      exports: ["TemplateDefinition", "TemplateSection", "TriageValidationResult", "SectionStatus"]
    - path: "src/triage/template-parser.ts"
      provides: "Issue template parser"
      exports: ["parseTemplate", "diffAgainstTemplate"]
    - path: "src/triage/template-parser.test.ts"
      provides: "Unit tests for template parser"
      min_lines: 150
  key_links:
    - from: "src/triage/template-parser.ts"
      to: "src/triage/types.ts"
      via: "imports TemplateDefinition, TemplateSection"
      pattern: "import"
---

<objective>
Implement the issue template parser using TDD.

Purpose: Parse `.md` issue templates from `.github/ISSUE_TEMPLATE/`, extract required sections, and diff against an issue body to identify missing/empty fields.
Output: `types.ts`, `template-parser.ts`, and `template-parser.test.ts` in `src/triage/`
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
@/home/keith/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/105-triage-agent-wiring/105-CONTEXT.md
@.planning/phases/105-triage-agent-wiring/105-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define triage types and implement template parser with TDD</name>
  <files>src/triage/types.ts, src/triage/template-parser.ts, src/triage/template-parser.test.ts</files>
  <action>
Create `src/triage/types.ts` with these types:

```typescript
export type TemplateSection = {
  heading: string;       // e.g., "Description"
  required: boolean;     // true unless <!-- optional --> marker found
  hint: string | null;   // HTML comment content below heading (e.g., "A clear description of the bug")
};

export type TemplateDefinition = {
  slug: string;          // Filename without extension (e.g., "bug-report")
  name: string;          // From YAML frontmatter `name` field, or slug if no frontmatter
  labels: string[];      // From YAML frontmatter `labels` field
  sections: TemplateSection[];
};

export type SectionStatus = "present" | "missing" | "empty";

export type SectionResult = {
  heading: string;
  status: SectionStatus;
  hint: string | null;   // From template, for guidance comment
  required: boolean;
};

export type TriageValidationResult = {
  templateSlug: string;
  templateName: string;
  sections: SectionResult[];
  /** True if all required sections are present and non-empty */
  valid: boolean;
};
```

Create `src/triage/template-parser.ts` with two functions:

**`parseTemplate(slug: string, content: string): TemplateDefinition`**
- Parse YAML frontmatter between `---` delimiters using a simple regex (do NOT add a YAML parsing dependency -- the frontmatter fields are simple key-value strings/arrays)
- Extract `name` (string), `labels` (comma-separated string or YAML array), `assignees` from frontmatter
- If no frontmatter (no opening `---`), set name = slug, labels = []
- Scan body for `## ` headings. For each heading:
  - Check if a `<!-- optional -->` comment appears in the content between this heading and the next heading (case-insensitive)
  - Extract hint text from HTML comments (`<!-- hint text -->`) below the heading, excluding the optional marker
  - Build a TemplateSection with heading name, required flag, and hint
- Return TemplateDefinition

**`diffAgainstTemplate(template: TemplateDefinition, issueBody: string): TriageValidationResult`**
- Parse `## ` headings from issue body
- For each required/optional section in template:
  - If heading is absent in issue body: status = "missing"
  - If heading is present but content below it (until next heading or EOF) is empty or contains only placeholder text: status = "empty"
  - Otherwise: status = "present"
- Placeholder detection: content matches common patterns like "N/A", "n/a", "None", just whitespace, or content that exactly matches the template's hint text
- Set `valid = true` only if all required sections have status "present"
- Return TriageValidationResult

Write comprehensive TDD tests in `src/triage/template-parser.test.ts`:

**parseTemplate tests:**
- Template with full YAML frontmatter (name, labels, assignees) -- verify all fields extracted
- Template with labels as comma-separated string vs YAML array
- Template without YAML frontmatter -- name falls back to slug
- Template with ## headings -- each becomes a section
- Template with `<!-- optional -->` marker -- section.required = false
- Template with hint comments -- hint extracted correctly
- Template with no sections (edge case) -- empty sections array

**diffAgainstTemplate tests:**
- Issue body with all required sections present and non-empty -- valid = true
- Issue body missing one required section -- valid = false, that section status = "missing"
- Issue body with required section present but empty -- valid = false, status = "empty"
- Issue body with placeholder text ("N/A") -- status = "empty"
- Issue body with optional section missing -- valid = true (optional doesn't affect validity)
- Issue body with extra sections not in template -- no error, just ignored
- Issue body matching hint text exactly -- status = "empty" (placeholder)
- Empty issue body -- all sections "missing"

Use `bun test` runner with `describe`/`it`/`expect` patterns matching existing test files in the project.
  </action>
  <verify>
    <automated>bun test src/triage/template-parser.test.ts</automated>
  </verify>
  <done>
    - parseTemplate correctly extracts frontmatter and sections from .md templates
    - diffAgainstTemplate identifies missing, empty, and present sections
    - All tests pass with bun test
    - Types exported from src/triage/types.ts
  </done>
</task>

</tasks>

<verification>
- `bun test src/triage/template-parser.test.ts` passes all tests
- Types are importable: `import { TemplateDefinition, TriageValidationResult } from './triage/types.ts'`
- No new dependencies added to package.json (pure string/regex parsing)
</verification>

<success_criteria>
- Template parser handles both YAML-frontmatter and plain-header .md templates
- Diff function correctly identifies missing vs empty vs present sections
- At least 8 test cases covering the documented scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/105-triage-agent-wiring/105-01-SUMMARY.md`
</output>
