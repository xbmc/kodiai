---
phase: 06-content-safety
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/execution/mention-prompt.ts
  - src/execution/review-prompt.ts
  - src/execution/prompt.ts
autonomous: true

must_haves:
  truths:
    - "Invisible unicode characters, HTML comments, and embedded tokens are stripped from all user content before it reaches the LLM"
    - "Only comments that existed at or before the trigger timestamp are included in conversation context"
  artifacts:
    - path: "src/execution/mention-prompt.ts"
      provides: "Sanitized conversation context with TOCTOU filtering"
      contains: "sanitizeContent"
    - path: "src/execution/review-prompt.ts"
      provides: "Sanitized PR title and body in review prompt"
      contains: "sanitizeContent"
    - path: "src/execution/prompt.ts"
      provides: "Sanitized triggerBody in generic prompt"
      contains: "sanitizeContent"
  key_links:
    - from: "src/execution/mention-prompt.ts"
      to: "src/lib/sanitizer.ts"
      via: "import sanitizeContent, filterCommentsToTriggerTime"
      pattern: "import.*sanitizeContent.*from.*lib/sanitizer"
    - from: "src/execution/review-prompt.ts"
      to: "src/lib/sanitizer.ts"
      via: "import sanitizeContent"
      pattern: "import.*sanitizeContent.*from.*lib/sanitizer"
    - from: "src/execution/prompt.ts"
      to: "src/lib/sanitizer.ts"
      via: "import sanitizeContent"
      pattern: "import.*sanitizeContent.*from.*lib/sanitizer"
---

<objective>
Integrate content sanitization and TOCTOU filtering into all prompt builders.

Purpose: Wires the sanitizer module (from Plan 01) into every location where user-generated content enters the LLM prompt, closing both MENTION-06 (sanitization) and MENTION-07 (TOCTOU) requirements.
Output: All three prompt builder files modified to sanitize user content at the boundary.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-content-safety/06-RESEARCH.md
@.planning/phases/06-content-safety/06-01-SUMMARY.md
@src/execution/mention-prompt.ts
@src/execution/review-prompt.ts
@src/execution/prompt.ts
@src/handlers/mention-types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate sanitization and TOCTOU filtering into mention-prompt.ts</name>
  <files>src/execution/mention-prompt.ts</files>
  <action>
Modify `src/execution/mention-prompt.ts` to import and apply both `sanitizeContent` and `filterCommentsToTriggerTime` from `../lib/sanitizer.ts`.

**In `buildConversationContext()`:**

1. Add import: `import { sanitizeContent, filterCommentsToTriggerTime } from "../lib/sanitizer.ts";`

2. After fetching comments (the `octokit.rest.issues.listComments` call on line 18-23), apply TOCTOU filter BEFORE the loop:
   ```typescript
   const safeComments = filterCommentsToTriggerTime(comments, mention.commentCreatedAt);
   ```
   Then iterate over `safeComments` instead of `comments`.

3. Inside the loop, sanitize each comment body when adding to lines:
   ```typescript
   lines.push(sanitizeContent(comment.body ?? "(empty)"));
   ```
   (Replace the existing `lines.push(comment.body ?? "(empty)");` on line 30)

4. After fetching PR metadata (the `octokit.rest.pulls.get` call around line 36-39), sanitize `pr.title` and `pr.body`:
   ```typescript
   lines.push(`Title: ${sanitizeContent(pr.title)}`);
   ```
   And for the body:
   ```typescript
   lines.push(`Description: ${sanitizeContent(pr.body)}`);
   ```

5. Do NOT sanitize `mention.diffHunk` (line 57) -- diff hunks are git-generated code, not user input (per research Pitfall 5).

**In `buildMentionPrompt()`:**

6. Sanitize the `userQuestion` parameter when inserting it into the prompt:
   ```typescript
   lines.push(sanitizeContent(userQuestion));
   ```
   (Replace the existing `lines.push(userQuestion);` on line 96)

7. Do NOT sanitize `conversationContext` -- it is already sanitized in `buildConversationContext()`.

8. Do NOT sanitize `customInstructions` -- these come from `.kodiai.yml` which is controlled by the repo owner, not user input.
  </action>
  <verify>
`bun build --no-bundle src/execution/mention-prompt.ts` compiles without errors. Verify the import is present and `sanitizeContent` is called on comment bodies, PR title, PR body, and userQuestion. Verify `filterCommentsToTriggerTime` is called on the comments array with `mention.commentCreatedAt`.
  </verify>
  <done>
`buildConversationContext` filters comments by trigger timestamp and sanitizes all comment bodies and PR metadata. `buildMentionPrompt` sanitizes the user question. Diff hunks and custom instructions are NOT sanitized (by design).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate sanitization into review-prompt.ts and prompt.ts</name>
  <files>src/execution/review-prompt.ts, src/execution/prompt.ts</files>
  <action>
**In `src/execution/review-prompt.ts`:**

1. Add import: `import { sanitizeContent } from "../lib/sanitizer.ts";`

2. Sanitize `context.prTitle` where it is used in the prompt (line 26):
   ```typescript
   `Title: ${sanitizeContent(context.prTitle)}`,
   ```

3. Sanitize `context.prBody` where it is used in the prompt (line 33):
   ```typescript
   lines.push("", "PR description:", "---", sanitizeContent(context.prBody.trim()), "---");
   ```

4. Do NOT sanitize `context.changedFiles` -- these are file paths from the diff, not user-editable content.

5. Do NOT sanitize `context.customInstructions` -- controlled by repo owner via `.kodiai.yml`.

**In `src/execution/prompt.ts`:**

6. Add import: `import { sanitizeContent } from "../lib/sanitizer.ts";`

7. Sanitize `context.triggerBody` where it is used in the prompt (line 21):
   ```typescript
   lines.push("", `User message:\n\n${sanitizeContent(context.triggerBody)}`);
   ```
  </action>
  <verify>
`bun build --no-bundle src/execution/review-prompt.ts` and `bun build --no-bundle src/execution/prompt.ts` both compile without errors. Verify `sanitizeContent` is imported and applied to `prTitle`, `prBody`, and `triggerBody`.
  </verify>
  <done>
`buildReviewPrompt` sanitizes PR title and body. `buildPrompt` sanitizes triggerBody. All user-generated content entering any prompt is sanitized. Changed files and custom instructions are intentionally not sanitized.
  </done>
</task>

</tasks>

<verification>
1. `bun build --no-bundle src/execution/mention-prompt.ts` compiles
2. `bun build --no-bundle src/execution/review-prompt.ts` compiles
3. `bun build --no-bundle src/execution/prompt.ts` compiles
4. `bun build --no-bundle src/index.ts` compiles (full project entrypoint)
5. `bun test` passes all existing tests (no regressions)
6. Every user-generated string entering a prompt passes through `sanitizeContent()`:
   - mention-prompt.ts: comment.body, pr.title, pr.body, userQuestion
   - review-prompt.ts: prTitle, prBody
   - prompt.ts: triggerBody
7. `filterCommentsToTriggerTime` is applied in `buildConversationContext` using `mention.commentCreatedAt`
8. diffHunk, changedFiles, and customInstructions are NOT sanitized (by design)
</verification>

<success_criteria>
- All user-generated content is sanitized before entering any prompt
- TOCTOU filtering excludes comments created/edited at or after the trigger timestamp
- No regressions in existing tests
- Full project compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-safety/06-02-SUMMARY.md`
</output>
