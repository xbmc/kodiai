---
phase: 06-content-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/sanitizer.ts
  - src/lib/sanitizer.test.ts
autonomous: true

must_haves:
  truths:
    - "sanitizeContent strips HTML comments from input"
    - "sanitizeContent strips invisible Unicode characters (zero-width, control chars, soft hyphens, bidi overrides)"
    - "sanitizeContent strips hidden content from markdown image alt text and link titles"
    - "sanitizeContent strips hidden HTML attributes (alt, title, aria-label, data-*, placeholder)"
    - "sanitizeContent normalizes HTML entities (decode printable ASCII, remove non-printable)"
    - "sanitizeContent redacts GitHub tokens (ghp_, gho_, ghs_, ghr_, github_pat_)"
    - "filterCommentsToTriggerTime excludes comments created at or after trigger timestamp"
    - "filterCommentsToTriggerTime excludes comments updated at or after trigger timestamp"
  artifacts:
    - path: "src/lib/sanitizer.ts"
      provides: "Content sanitization pipeline and TOCTOU filter"
      exports: ["sanitizeContent", "filterCommentsToTriggerTime", "stripHtmlComments", "stripInvisibleCharacters", "stripMarkdownImageAltText", "stripMarkdownLinkTitles", "stripHiddenAttributes", "normalizeHtmlEntities", "redactGitHubTokens"]
    - path: "src/lib/sanitizer.test.ts"
      provides: "Unit tests for all sanitization and TOCTOU functions"
      min_lines: 80
  key_links: []
---

<objective>
Create the content sanitizer module and TOCTOU comment filter as a standalone library.

Purpose: Provides the security primitives that Phase 6 Plan 02 will wire into the prompt pipeline. Ported from the battle-tested reference implementation in `tmp/claude-code-action/src/github/utils/sanitizer.ts`.
Output: `src/lib/sanitizer.ts` (sanitization + TOCTOU filter) and `src/lib/sanitizer.test.ts` (comprehensive tests)
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-content-safety/06-RESEARCH.md
@tmp/claude-code-action/src/github/utils/sanitizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content sanitizer and TOCTOU filter module</name>
  <files>src/lib/sanitizer.ts</files>
  <action>
Create `src/lib/sanitizer.ts` with the following exports, ported from the reference implementation at `tmp/claude-code-action/src/github/utils/sanitizer.ts`:

**Sanitization functions (port directly from reference):**

1. `stripHtmlComments(content: string): string` -- `content.replace(/<!--[\s\S]*?-->/g, "")`
2. `stripInvisibleCharacters(content: string): string` -- 4 regex passes: zero-width chars (U+200B/C/D, FEFF), control chars (excluding tab/newline/CR), soft hyphens (U+00AD), bidi overrides (U+202A-202E, U+2066-2069)
3. `stripMarkdownImageAltText(content: string): string` -- `content.replace(/!\[[^\]]*\]\(/g, "![](")`
4. `stripMarkdownLinkTitles(content: string): string` -- strip double-quoted and single-quoted title attributes from markdown links
5. `stripHiddenAttributes(content: string): string` -- strip alt, title, aria-label, data-*, placeholder attributes (both quoted and unquoted values)
6. `normalizeHtmlEntities(content: string): string` -- decode decimal (&#NNN;) and hex (&#xHH;) entities in printable ASCII range (32-126), remove non-printable entity references
7. `redactGitHubTokens(content: string): string` -- replace ghp_, gho_, ghs_, ghr_ (36 alphanum chars after prefix) and github_pat_ (11-221 alphanum+underscore chars) with `[REDACTED_GITHUB_TOKEN]`
8. `sanitizeContent(content: string): string` -- pipeline calling all 7 functions in order: stripHtmlComments -> stripInvisibleCharacters -> stripMarkdownImageAltText -> stripMarkdownLinkTitles -> stripHiddenAttributes -> normalizeHtmlEntities -> redactGitHubTokens

**TOCTOU filter (adapted from reference `tmp/claude-code-action/src/github/data/fetcher.ts`):**

9. `filterCommentsToTriggerTime<T extends { created_at: string; updated_at?: string }>(comments: T[], triggerTime: string | undefined): T[]` -- Uses generic type so it works with Octokit REST response shapes. Returns all comments if triggerTime is undefined. Otherwise, excludes comments where `new Date(created_at).getTime() >= triggerTs` OR where `updated_at` exists and `new Date(updated_at).getTime() >= triggerTs`. Uses strict `>=` (not `>`) per research Pitfall 4 -- this intentionally excludes the trigger comment itself.

Note: REST API uses `created_at` / `updated_at` (snake_case), not the GraphQL camelCase fields. No `lastEditedAt` field in REST -- `updated_at` serves as the conservative alternative.
  </action>
  <verify>
`bun build --no-bundle src/lib/sanitizer.ts` compiles without errors.
  </verify>
  <done>
All 9 functions exported from `src/lib/sanitizer.ts`. `sanitizeContent` chains all 7 sanitization steps in the correct order. `filterCommentsToTriggerTime` filters by created_at and updated_at with >= comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive unit tests for sanitizer and TOCTOU filter</name>
  <files>src/lib/sanitizer.test.ts</files>
  <action>
Create `src/lib/sanitizer.test.ts` using `bun:test` (import { test, expect, describe } from "bun:test"). Test coverage for each function:

**stripHtmlComments:**
- Strips single-line comment: `"hello <!-- hidden --> world"` -> `"hello  world"`
- Strips multi-line comment: `"before <!--\nmultiline\n--> after"` -> `"before  after"`
- Handles multiple comments in one string
- Passes through text with no comments unchanged

**stripInvisibleCharacters:**
- Strips zero-width space (U+200B), zero-width joiner (U+200D), BOM (FEFF)
- Strips control chars (U+0000-U+0008, U+000B, U+000C, U+000E-U+001F)
- Preserves tab (\t), newline (\n), carriage return (\r)
- Strips soft hyphen (U+00AD)
- Strips bidi overrides (U+202A, U+202E, U+2066)

**stripMarkdownImageAltText:**
- `"![hidden text](https://example.com/img.png)"` -> `"![](https://example.com/img.png)"`
- Preserves non-image markdown links: `"[visible](url)"` unchanged

**stripMarkdownLinkTitles:**
- `'[text](url "hidden title")'` -> `"[text](url)"`
- `"[text](url 'hidden title')"` -> `"[text](url)"`

**stripHiddenAttributes:**
- Strips `alt="hidden"`, `title="hidden"`, `aria-label="hidden"`, `data-foo="hidden"`, `placeholder="hidden"`
- Strips unquoted attribute values

**normalizeHtmlEntities:**
- Decodes printable: `"&#72;&#101;&#108;&#108;&#111;"` -> `"Hello"`
- Decodes hex: `"&#x48;&#x65;&#x6C;&#x6C;&#x6F;"` -> `"Hello"`
- Removes non-printable: `"&#0;&#8;"` -> `""`

**redactGitHubTokens:**
- Redacts `ghp_` token (36 chars)
- Redacts `gho_`, `ghs_`, `ghr_` tokens
- Redacts `github_pat_` token
- Preserves non-token text

**sanitizeContent (integration):**
- Multi-vector attack: string with HTML comment + invisible chars + token -> all stripped/redacted

**filterCommentsToTriggerTime:**
- Returns all comments when triggerTime is undefined
- Excludes comments created at trigger time (>= comparison)
- Excludes comments created after trigger time
- Includes comments created before trigger time
- Excludes comments with updated_at >= trigger time (edited after trigger)
- Includes comments with updated_at before trigger time
- Handles comments without updated_at field
  </action>
  <verify>
`bun test src/lib/sanitizer.test.ts` -- all tests pass.
  </verify>
  <done>
All sanitizer functions and TOCTOU filter have test coverage. `bun test src/lib/sanitizer.test.ts` reports 0 failures.
  </done>
</task>

</tasks>

<verification>
1. `bun build --no-bundle src/lib/sanitizer.ts` compiles without errors
2. `bun test src/lib/sanitizer.test.ts` passes all tests
3. `sanitizeContent` chains all 7 steps in the correct order (HTML comments first, entities near last, tokens last)
4. `filterCommentsToTriggerTime` uses `>=` comparison (not `>`)
</verification>

<success_criteria>
- `src/lib/sanitizer.ts` exports all 9 functions
- `src/lib/sanitizer.test.ts` has tests for every function with 0 failures
- No external dependencies added (pure regex/string manipulation)
</success_criteria>

<output>
After completion, create `.planning/phases/06-content-safety/06-01-SUMMARY.md`
</output>
