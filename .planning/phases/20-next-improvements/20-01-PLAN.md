---
phase: 20-next-improvements
plan: 01
type: execute
wave: 1
depends_on:
  - 19-write-confirmation/19-01-SUMMARY.md
files_modified:
  - src/handlers/mention.ts
  - src/jobs/workspace.ts
  - src/execution/config.ts
  - src/execution/mcp/comment-server.ts
  - docs/runbooks/mentions.md
  - docs/runbooks/review-requested-debug.md
  - .github/workflows/ci.yml
autonomous: true

must_haves:
  truths:
    - "Write-mode updates the existing PR branch when possible; falls back to bot PR otherwise"
    - "Secret/policy guardrails block high-risk writes with clear refusal messages"
    - "Operators can tell exactly why output was skipped from one evidence line"
    - "PRs run CI (tests + typecheck)"
---

<objective>
Ship the next set of quality improvements: better write-mode UX (update PR when possible), stronger guardrails, clearer observability, optional delivery metadata, and basic CI.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Update existing PR branch when possible</name>
  <files>src/handlers/mention.ts src/jobs/workspace.ts</files>
  <action>
  For write-mode requests triggered from a PR:
  - If PR head repo is the base repo and app has permission to push to the head ref, push commits to the existing PR branch.
  - Otherwise fall back to creating a bot branch + bot PR (current behavior).
  - Always include evidence bundle fields for the chosen path.
  </action>
  <verify>
  - Unit tests cover: same-repo head => updates branch; fork head => bot PR fallback
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 2: Harden secret scanning + policy defaults</name>
  <files>src/execution/config.ts src/jobs/workspace.ts docs/runbooks/mentions.md</files>
  <action>
  - Add additional default deny patterns and file-type heuristics (e.g. .env, credentials-like files).
  - Add simple entropy/length heuristics for tokens to reduce obvious misses.
  - Ensure refusal messages are concise and actionable.
  </action>
  <verify>
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 3: Observability: standardize skip reasons + evidence bundles</name>
  <files>src/handlers/mention.ts src/handlers/review.ts docs/runbooks/mentions.md docs/runbooks/review-requested-debug.md</files>
  <action>
  - Emit one structured evidence line for: published, skipped-by-policy, skipped-by-idempotency, tool failure.
  - Ensure evidence includes deliveryId + a stable executionId.
  - Update runbooks to list the keys and common outcomes.
  </action>
  <verify>
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 4: Optional GitHub delivery metadata capture (best-effort)</name>
  <files>src/routes/webhooks.ts src/webhook/router.ts</files>
  <action>
  - When possible (and configured), fetch delivery metadata (status/timestamp) and attach to logs.
  - Keep it optional and never block processing.
  </action>
  <verify>
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 5: Add CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
  Add a GitHub Actions workflow that runs on PRs:
  - bun install
  - bun test
  - bunx tsc --noEmit (best-effort; can be allowed to fail if tsc isn't configured)
  </action>
  <verify>
  - CI runs on the PR
  </verify>
</task>

</tasks>

<verification>
- bun test
</verification>

<output>
Create `.planning/phases/20-next-improvements/20-01-SUMMARY.md`.
</output>
