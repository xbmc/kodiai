---
phase: 10-review-request-reliability
plan: 01
type: plan
wave: 1
depends_on:
  - 09-review-ux-improvements/09-05-PLAN.md
files_modified:
  - src/routes/webhooks.ts
  - src/webhook/router.ts
  - src/handlers/review.ts
  - src/jobs/queue.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/handlers/review.test.ts
  - docs/runbooks/review-requested-debug.md
autonomous: true
production_hardening: true

must_haves:
  truths:
    - "Every pull_request.review_requested webhook can be traced end-to-end by delivery ID"
    - "Router dispatch decisions are observable (matched handler keys, filtered vs dispatched)"
    - "Trigger gating clearly reports why review_requested ran or was skipped"
    - "Manual re-request of kodiai reliably enqueues and executes exactly one review job"
  artifacts:
    - path: "src/routes/webhooks.ts"
      provides: "Ingress observability for signature/duplicate/installation checks"
      contains: "deliveryId"
    - path: "src/webhook/router.ts"
      provides: "Dispatch observability and explicit no-handler/filtered reasons"
      contains: "specificKey"
    - path: "src/handlers/review.ts"
      provides: "Robust review_requested reviewer matching and gating logs"
      contains: "review_requested"
    - path: "docs/runbooks/review-requested-debug.md"
      provides: "Production debug checklist for webhook -> router -> trigger -> execution"
      contains: "X-GitHub-Delivery"
  key_links:
    - from: "src/routes/webhooks.ts"
      to: "src/webhook/router.ts"
      via: "Validated pull_request payload dispatch includes deliveryId/action metadata"
      pattern: "dispatchWebhook|deliveryId"
    - from: "src/webhook/router.ts"
      to: "src/handlers/review.ts"
      via: "specificKey/generalKey resolution routes review_requested to review handler"
      pattern: "pull_request\.review_requested|specificKey"
    - from: "src/handlers/review.ts"
      to: "src/jobs/queue.ts"
      via: "Accepted kodiai review_requested event enqueues exactly one review job"
      pattern: "enqueue|review_requested"
---

<objective>
Debug and harden production handling of `pull_request.review_requested` so manually re-requesting kodiai always triggers review. Validate the complete path: webhook delivery, router dispatch, trigger gating, and execution enqueue/run lifecycle.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/plan-phase.md
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@src/routes/webhooks.ts
@src/webhook/router.ts
@src/handlers/review.ts
@src/jobs/queue.ts
@src/execution/config.ts
@src/execution/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add end-to-end correlation logging for review_requested deliveries</name>
  <files>src/routes/webhooks.ts, src/webhook/router.ts, src/handlers/review.ts, src/jobs/queue.ts</files>
  <action>
  Introduce structured logs that preserve a single trace key (`deliveryId`) from webhook ingress through queue completion:

  1. At webhook ingress, log event metadata after signature verification and before async dispatch (`eventName`, `action`, `installationId`, `repository`, `sender`).
  2. In router dispatch, log which handler keys were considered (`specificKey`, `generalKey`) and how many handlers matched.
  3. In review handler, log explicit gates and outcomes for `review_requested`:
     - accepted reviewer match
     - skipped (non-kodiai reviewer, team-only request, trigger disabled, review disabled)
     - enqueue started/completed
  4. In queue execution, emit start/finish logs with installation + job identity so drops/stalls are visible.
  </action>
  <verify>
  - Grep shows `deliveryId` present in ingress, dispatch, and review execution logs.
  - A replayed `pull_request.review_requested` payload produces a contiguous log chain with no missing step.
  </verify>
  <done>
  Operators can answer "did webhook arrive, dispatch, pass gates, and execute" from logs alone.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden review_requested gating to match real GitHub payload variants</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
  Make reviewer-target gating resilient and deterministic:

  1. Normalize reviewer login comparisons case-insensitively and tolerate `[bot]` suffix variance.
  2. Prefer explicit reviewer matching from payload fields and add clear reasoned skips when only team review is requested.
  3. Guard against malformed/missing reviewer payloads with non-fatal skip + diagnostic logs.
  4. Add focused tests for accepted/denied reviewer combinations and malformed payload regressions.
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts` passes.
  - Tests include manual kodiai re-request positive case and non-kodiai reviewer negative case.
  </verify>
  <done>
  Manual re-request targeting kodiai consistently passes gates; unrelated requests do not trigger review.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify and harden trigger config behavior for review_requested</name>
  <files>src/execution/config.ts, src/execution/config.test.ts, src/handlers/review.ts</files>
  <action>
  Ensure config cannot silently disable expected re-request behavior:

  1. Confirm default trigger set keeps `onReviewRequested: true`.
  2. Add startup/runtime log surfacing effective trigger config when handling PR review events.
  3. Add regression tests proving missing trigger block still enables re-request and explicit disable works predictably.
  4. Keep strict schema rejection for unsupported trigger keys.
  </action>
  <verify>
  - `bun test src/execution/config.test.ts` passes with new trigger coverage.
  - Runtime log includes effective triggers for review handler decisions.
  </verify>
  <done>
  Trigger behavior is explicit, test-covered, and diagnosable in production.
  </done>
</task>

<task type="auto">
  <name>Task 4: Build production verification runbook for manual re-request flow</name>
  <files>docs/runbooks/review-requested-debug.md</files>
  <action>
  Document exact production debugging steps and expected signals:

  1. Verify webhook delivery in GitHub App delivery history for `pull_request` + `review_requested`.
  2. Correlate by `X-GitHub-Delivery` in application logs to confirm router and handler path.
  3. Validate gate decision and queue execution logs for the same delivery.
  4. Define fast triage matrix: webhook missing vs filtered vs trigger-disabled vs execution failure.
  5. Add one reproducible smoke procedure: remove kodiai reviewer then re-request manually, expect exactly one review run.
  </action>
  <verify>
  - Runbook includes concrete command examples (`gh`, Azure log query, local replay) and expected outputs.
  - On-call can complete triage without reading source code.
  </verify>
  <done>
  Production incidents around re-request flow become quickly diagnosable and recoverable.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts src/handlers/review.test.ts`
- `bunx tsc --noEmit`
- Replay fixture payload for `pull_request.review_requested` and confirm end-to-end correlated logs
- Live smoke in production test repo: manually re-request kodiai on an existing PR and verify exactly one review execution
</verification>

<success_criteria>
- Webhook ingress, router dispatch, review gating, and execution all emit correlated logs by delivery ID
- Manual `review_requested` targeting kodiai triggers review reliably in production
- Non-kodiai reviewer/team requests are skipped with explicit reason logging
- Trigger config defaults and overrides for `onReviewRequested` are test-covered
- A runbook exists for fast production triage
</success_criteria>

<output>
After execution, create `.planning/phases/10-review-request-reliability/10-01-SUMMARY.md` with results, decisions, and production verification evidence.
</output>
