---
phase: 10-review-request-reliability
plan: 03
type: execute
wave: 3
depends_on:
  - 10-review-request-reliability/10-02-PLAN.md
files_modified:
  - src/handlers/review.ts
  - src/handlers/review-idempotency.ts
  - src/execution/types.ts
  - src/execution/executor.ts
  - src/execution/mcp/index.ts
  - src/execution/mcp/inline-review-server.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "A single manual review_requested delivery publishes at most one review output batch"
    - "Retry/replay processing for the same delivery/output key is skipped safely without duplicate review output"
    - "Review trigger model remains opened, ready_for_review, and review_requested only (no synchronize trigger)"
  artifacts:
    - path: "src/handlers/review-idempotency.ts"
      provides: "Deterministic output key creation and downstream idempotency checks"
      contains: "buildReviewOutputKey"
    - path: "src/handlers/review.ts"
      provides: "Review handler wiring that computes key once and enforces idempotent publication"
      contains: "reviewOutputKey"
    - path: "src/execution/mcp/inline-review-server.ts"
      provides: "Inline review publication guard that skips duplicate output for existing key"
      contains: "outputKey"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/handlers/review-idempotency.ts"
      via: "deterministic key generation + publication guard"
      pattern: "buildReviewOutputKey|ensureReviewOutputNotPublished"
    - from: "src/handlers/review.ts"
      to: "src/execution/mcp/index.ts"
      via: "executor context carries reviewOutputKey"
      pattern: "reviewOutputKey"
    - from: "src/execution/mcp/inline-review-server.ts"
      to: "GitHub PR review comments/reviews"
      via: "marker check before createReviewComment/createReview"
      pattern: "kodiai:review-output-key"
---

<objective>
Close the primary reliability gap by adding deterministic downstream idempotency for review output publication, so one manual `pull_request.review_requested` delivery cannot fan out into multiple review batches.

Purpose: Enforce exactly-once output semantics even if ingress dedup is bypassed or retries/restarts re-enter the review path.
Output: Idempotency-keyed review publication guard wired through review handler and MCP output path.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-review-request-reliability/10-VERIFICATION.md
@src/handlers/review.ts
@src/execution/executor.ts
@src/execution/mcp/index.ts
@src/execution/mcp/inline-review-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic review output keying and downstream idempotency guard</name>
  <files>src/handlers/review-idempotency.ts, src/handlers/review.ts</files>
  <action>
  Create a dedicated idempotency helper for review publication:

  1. Add `buildReviewOutputKey(...)` that deterministically derives one key per review output batch using stable fields (`installationId`, owner/repo, PR number, event action, deliveryId, head SHA).
  2. Add `ensureReviewOutputNotPublished(...)` that checks for an existing idempotency marker on the PR and returns skip/allow before publishing.
  3. Wire this into `createReviewHandler` so the key is computed once per accepted event and carried through the review execution flow.
  4. Keep the trigger model unchanged: register only `pull_request.opened`, `pull_request.ready_for_review`, and `pull_request.review_requested` (do not add `synchronize`).
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts` passes.
  - `bunx tsc --noEmit` passes.
  - `src/handlers/review.ts` still registers exactly 3 review trigger events (opened/ready_for_review/review_requested).
  </verify>
  <done>
  A deterministic `reviewOutputKey` exists and is enforced at review handler level before output publication begins.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce output idempotency in MCP inline review publication path</name>
  <files>src/execution/types.ts, src/execution/executor.ts, src/execution/mcp/index.ts, src/execution/mcp/inline-review-server.ts, src/handlers/review.ts</files>
  <action>
  Extend execution plumbing so output idempotency is enforced where review artifacts are posted:

  1. Add `reviewOutputKey` to execution context and pass it from review handler through executor into MCP server construction.
  2. Update inline review publication to check for marker `<!-- kodiai:review-output-key:{key} -->` before creating new review output.
  3. When publishing succeeds, stamp the marker on created output so later retries/replays with the same key no-op.
  4. Log explicit idempotency outcomes (`published`, `already-published-skip`) with `deliveryId`/`reviewOutputKey` for production traceability.
  </action>
  <verify>
  - `bunx tsc --noEmit` passes with new context field wiring.
  - `bun test src/handlers/review.test.ts` passes after MCP/executor signature updates.
  - Search in updated files shows marker string `kodiai:review-output-key` in publication guard path.
  </verify>
  <done>
  Reprocessing the same delivery/output key cannot create a second review output batch because publication path detects prior output and skips.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts`
- `bunx tsc --noEmit`
- Replay one `pull_request.review_requested` payload twice with the same delivery ID and confirm the second run logs idempotent skip instead of publishing output
</verification>

<success_criteria>
- Review output key is deterministic and stable for a single delivery attempt
- Downstream review publication is idempotent and logs skip on duplicate/retry processing
- Trigger model remains constrained to opened/ready_for_review/review_requested
</success_criteria>

<output>
After completion, create `.planning/phases/10-review-request-reliability/10-03-SUMMARY.md` with idempotency key design, wiring evidence, and duplicate replay results.
</output>
