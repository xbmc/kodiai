---
phase: 10-review-request-reliability
plan: 04
type: execute
wave: 4
depends_on:
  - 10-review-request-reliability/10-03-PLAN.md
files_modified:
  - src/handlers/review.test.ts
  - src/execution/mcp/inline-review-server.test.ts
  - src/handlers/review-idempotency.test.ts
  - .planning/phases/10-review-request-reliability/10-04-SUMMARY.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Automated tests prove one manual review_requested trigger results in exactly one review submission/output batch"
    - "Automated tests prove duplicate delivery and retry scenarios do not create duplicate review output"
    - "Idempotency behavior remains reliable after process-level replay simulation (restart-safe by downstream marker check)"
  artifacts:
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for review_requested duplicate/retry behavior"
      contains: "review_requested"
    - path: "src/handlers/review-idempotency.test.ts"
      provides: "Unit tests for deterministic keying and already-published detection"
      contains: "buildReviewOutputKey"
    - path: "src/execution/mcp/inline-review-server.test.ts"
      provides: "Publication-path test that duplicate key skips new output"
      contains: "kodiai:review-output-key"
  key_links:
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/review.ts"
      via: "manual and duplicate delivery event replay"
      pattern: "pull_request.review_requested"
    - from: "src/execution/mcp/inline-review-server.test.ts"
      to: "src/execution/mcp/inline-review-server.ts"
      via: "marker-based duplicate publication assertions"
      pattern: "already-published-skip"
---

<objective>
Close the remaining verification gaps by adding explicit automated regression coverage for exactly-once review output and retry/duplicate idempotency behavior.

Purpose: Make reliability claims enforceable in CI so regressions are caught before deployment.
Output: New idempotency-focused tests and reproducible verification evidence.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/10-review-request-reliability/10-VERIFICATION.md
@.planning/phases/10-review-request-reliability/10-03-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review-idempotency.ts
@src/execution/mcp/inline-review-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic keying and duplicate-detection unit tests</name>
  <files>src/handlers/review-idempotency.test.ts</files>
  <action>
  Add focused unit tests for the new idempotency helper:

  1. Verify identical input fields produce identical `reviewOutputKey` values.
  2. Verify any key component change (deliveryId, head SHA, PR number) changes the derived key.
  3. Verify `ensureReviewOutputNotPublished(...)` returns skip when marker already exists and allow when absent.
  4. Include explicit fixture strings for marker parsing format `<!-- kodiai:review-output-key:{key} -->`.
  </action>
  <verify>
  - `bun test src/handlers/review-idempotency.test.ts` passes.
  </verify>
  <done>
  Deterministic key generation and duplicate marker detection are test-proven with stable fixtures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry and duplicate-delivery regression tests for review_requested flow</name>
  <files>src/handlers/review.test.ts, src/execution/mcp/inline-review-server.test.ts</files>
  <action>
  Add end-to-end style regression coverage at handler + publication layers:

  1. Extend `review.test.ts` with a scenario that replays the same manual `review_requested` delivery and asserts exactly one publish path execution.
  2. Add a retry scenario where ingress-level dedup is assumed missed and downstream idempotency still prevents duplicate output.
  3. Add `inline-review-server.test.ts` with mocked Octokit responses proving second publish attempt with same `reviewOutputKey` skips creation.
  4. Keep coverage scoped to `opened`, `ready_for_review`, and `review_requested` behavior; do not add synchronize-trigger cases.
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts src/execution/mcp/inline-review-server.test.ts` passes.
  - Replayed duplicate-delivery test shows exactly one create/publish call and one idempotent skip.
  </verify>
  <done>
  Automated tests demonstrate duplicate deliveries and retries cannot produce duplicate review output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Re-run Phase 10 reliability verification checks and capture closure evidence</name>
  <files>.planning/phases/10-review-request-reliability/10-04-SUMMARY.md</files>
  <action>
  Execute full gap-closure verification after tests are added:

  1. Run targeted tests and full test suite commands used by the phase.
  2. Re-run manual replay check (same delivery key) and record log evidence of one publish + duplicate skip.
  3. Update summary with explicit mapping from previous gap items to passing evidence.
  4. Record final pass/fail for both previously failing truths.
  </action>
  <verify>
  - `bun test src/handlers/review-idempotency.test.ts src/handlers/review.test.ts src/execution/mcp/inline-review-server.test.ts` passes.
  - Summary includes evidence for both closed gaps from `10-VERIFICATION.md`.
  </verify>
  <done>
  Gap evidence is captured and both failed truths have executable proof of closure.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review-idempotency.test.ts src/handlers/review.test.ts src/execution/mcp/inline-review-server.test.ts`
- `bunx tsc --noEmit`
- Manual duplicate replay verification demonstrates first publish and second idempotent skip for the same output key
</verification>

<success_criteria>
- Regression suite contains explicit tests for exactly-one manual re-request output behavior
- Regression suite contains explicit tests for duplicate delivery/retry idempotency
- Verification evidence links directly to previously failed truths in `10-VERIFICATION.md`
</success_criteria>

<output>
After completion, create `.planning/phases/10-review-request-reliability/10-04-SUMMARY.md` with test outputs and proof mapping for each closed gap.
</output>
