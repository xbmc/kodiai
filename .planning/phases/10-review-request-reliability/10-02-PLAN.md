---
phase: 10-review-request-reliability
plan: 02
type: execute
wave: 2
depends_on:
  - 10-review-request-reliability/10-01-PLAN.md
files_modified:
  - src/routes/webhooks.ts
  - src/webhook/router.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/jobs/queue.ts
  - src/jobs/types.ts
  - src/execution/config.test.ts
  - docs/runbooks/review-requested-debug.md
  - .planning/phases/10-review-request-reliability/10-02-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "A manual re-request of kodiai on kodiai/xbmc PR #8 produces exactly one review execution"
    - "The review_requested webhook path is reliably observable end-to-end from delivery receipt through queue completion"
    - "The deployed production revision remains healthy while serving the hardened review_requested flow"
    - "Replay evidence can be used to prove no silent drop between webhook ingress, routing, gating, and execution"
  artifacts:
    - path: "docs/runbooks/review-requested-debug.md"
      provides: "Operational correlation procedure used during validation"
      contains: "X-GitHub-Delivery"
    - path: ".planning/phases/10-review-request-reliability/10-02-SUMMARY.md"
      provides: "Deployment + validation evidence (commit SHA, revision IDs, delivery/log correlation)"
      contains: "delivery_id"
  key_links:
    - from: "GitHub webhook delivery (repos/kodiai/xbmc/hooks/*/deliveries)"
      to: "Azure Container App logs for ca-kodiai"
      via: "delivery GUID/ID correlation"
      pattern: "review_requested"
    - from: "src/handlers/review.ts"
      to: "src/jobs/queue.ts"
      via: "Review enqueue started/completed and job execution lifecycle logs"
      pattern: "Review enqueue"
---

<objective>
Ship the already-implemented review-request reliability hardening by committing current uncommitted changes, deploying the update to Azure Container Apps using `./deploy.sh`, and proving manual `pull_request.review_requested` behavior on `kodiai/xbmc` PR #8 with delivery-to-log correlation evidence.

Purpose: Convert completed hardening work into a deployed, verified production state with reproducible forensic evidence.
Output: One reliability-hardening commit on `test/phase9-ux-features`, one successful ACA rollout, and a summary containing commit/deployment/validation evidence.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/10-review-request-reliability/10-01-SUMMARY.md
@docs/runbooks/review-requested-debug.md
@deploy.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preflight and commit existing reliability hardening changes</name>
  <files>src/routes/webhooks.ts, src/webhook/router.ts, src/handlers/review.ts, src/handlers/review.test.ts, src/jobs/queue.ts, src/jobs/types.ts, src/execution/config.test.ts, docs/runbooks/review-requested-debug.md</files>
  <action>
  Run preflight checks, then commit only the known reliability-hardening files already present in the working tree.

  Exact commands:

  1. `git branch --show-current` and assert output equals `test/phase9-ux-features`.
  2. `git status --short` and confirm changed files are limited to reliability hardening + planning docs.
  3. `bun test src/execution/config.test.ts src/handlers/review.test.ts`.
  4. `git add src/routes/webhooks.ts src/webhook/router.ts src/handlers/review.ts src/handlers/review.test.ts src/jobs/queue.ts src/jobs/types.ts src/execution/config.test.ts docs/runbooks/review-requested-debug.md`.
  5. `git diff --cached --name-only` and verify no unrelated files are staged.
  6. `git commit -m "fix(review-requested): ship reliability hardening with delivery correlation"`.
  7. Capture `COMMIT_SHA=$(git rev-parse --short HEAD)` for summary evidence.

  Do not stage `.planning/**` in this commit.
  </action>
  <verify>
  - `git show --name-status --oneline -1` includes only the targeted reliability files.
  - `bun test src/execution/config.test.ts src/handlers/review.test.ts` passes.
  </verify>
  <done>
  A single commit exists on `test/phase9-ux-features` containing only reliability-hardening code/test/runbook changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy committed build to Azure Container Apps with preflight and revision tracking</name>
  <files>deploy.sh</files>
  <action>
  Perform deployment preflight, execute `./deploy.sh`, and capture before/after revision evidence.

  Exact commands:

  1. `test -x ./deploy.sh`.
  2. `az account show --output table`.
  3. `for v in GITHUB_APP_ID GITHUB_PRIVATE_KEY_BASE64 GITHUB_WEBHOOK_SECRET CLAUDE_CODE_OAUTH_TOKEN; do test -n "${!v:-}" || { echo "Missing $v"; exit 1; }; done`.
  4. `PREV_REVISION=$(az containerapp revision list --name ca-kodiai --resource-group rg-kodiai --query "[?properties.active].name | [0]" --output tsv)`.
  5. `./deploy.sh`.
  6. `NEW_REVISION=$(az containerapp revision list --name ca-kodiai --resource-group rg-kodiai --query "[?properties.active].name | [0]" --output tsv)`.
  7. `APP_FQDN=$(az containerapp show --name ca-kodiai --resource-group rg-kodiai --query properties.configuration.ingress.fqdn --output tsv)`.
  8. `curl -fsS "https://${APP_FQDN}/health"` and `curl -fsS "https://${APP_FQDN}/readiness"`.

  Record `PREV_REVISION`, `NEW_REVISION`, and `APP_FQDN` in the summary.
  </action>
  <verify>
  - `./deploy.sh` exits 0.
  - Health and readiness endpoints return success after deploy.
  - Active revision is recorded and app remains externally reachable.
  </verify>
  <done>
  Azure Container App `ca-kodiai` is running the newly committed reliability hardening revision.
  </done>
</task>

<task type="auto">
  <name>Task 3: Validate PR #8 review_requested flow and capture delivery/log correlation evidence</name>
  <files>.planning/phases/10-review-request-reliability/10-02-SUMMARY.md</files>
  <action>
  Trigger a manual reviewer request for PR #8 and collect GitHub delivery + Azure log correlation proving end-to-end execution.

  Exact commands:

  1. `HOOK_ID=$(gh api repos/kodiai/xbmc/hooks --jq '[.[] | select(.config.url | contains("/webhooks/github"))][0].id')`.
  2. `gh api -X DELETE repos/kodiai/xbmc/pulls/8/requested_reviewers -f reviewers[]=kodiai || true`.
  3. `gh api -X POST repos/kodiai/xbmc/pulls/8/requested_reviewers -f reviewers[]=kodiai`.
  4. `sleep 10`.
  5. `DELIVERY_ID=$(gh api repos/kodiai/xbmc/hooks/$HOOK_ID/deliveries --jq '[.[] | select(.event=="pull_request" and .action=="review_requested")][0].id')`.
  6. `gh api repos/kodiai/xbmc/hooks/$HOOK_ID/deliveries/$DELIVERY_ID --jq '{delivery_id:.id,guid:.guid,event,action,status_code,delivered_at}'`.
  7. `DELIVERY_GUID=$(gh api repos/kodiai/xbmc/hooks/$HOOK_ID/deliveries/$DELIVERY_ID --jq '.guid')`.
  8. `az containerapp logs show --name ca-kodiai --resource-group rg-kodiai --tail 500 --format text | rg -n "$DELIVERY_GUID|Webhook accepted and queued for dispatch|Router evaluated dispatch keys|Accepted review_requested event for kodiai reviewer|Review enqueue started|Job execution started|Job execution completed|Review enqueue completed"`.
  9. `gh pr view 8 --repo kodiai/xbmc --json reviews --jq '.reviews | length'` and confirm count increases by exactly 1 for this trigger.

  Save command outputs in `10-02-SUMMARY.md` under an Evidence section with timestamps.
  </action>
  <verify>
  - GitHub delivery evidence shows `event=pull_request`, `action=review_requested`, and successful delivery status.
  - Azure logs include contiguous correlation chain for same delivery GUID/ID.
  - PR #8 review count increases exactly once for this manual request.
  </verify>
  <done>
  Manual `review_requested` on PR #8 is proven reliable with auditable delivery/log correlation evidence.
  </done>
</task>

</tasks>

<verification>
- Commit evidence: `git show --name-status --oneline -1`
- Deployment evidence: previous vs new revision IDs, plus `/health` and `/readiness` responses
- Correlation evidence: GitHub delivery details + matched Azure log chain for the same delivery GUID/ID
- Functional evidence: PR #8 gains exactly one new review from the manual re-request
</verification>

<rollback_note>
If deployment or validation fails after rollout, reactivate the prior known-good revision and re-check health:

`az containerapp revision activate --name ca-kodiai --resource-group rg-kodiai --revision "$PREV_REVISION"`

Then verify:
`curl -fsS "https://${APP_FQDN}/health"` and `curl -fsS "https://${APP_FQDN}/readiness"`
</rollback_note>

<success_criteria>
- Reliability hardening changes are committed on `test/phase9-ux-features` in one focused commit with recorded SHA
- `./deploy.sh` completes successfully and `ca-kodiai` remains healthy on the active revision
- A fresh manual reviewer request on `kodiai/xbmc#8` emits a `pull_request.review_requested` delivery and is traceable end-to-end in logs
- Correlation evidence (delivery metadata + log chain + single review outcome) is captured in `10-02-SUMMARY.md`
- Rollback command and prior revision ID are documented for immediate recovery
</success_criteria>

<output>
After completion, create `.planning/phases/10-review-request-reliability/10-02-SUMMARY.md` with commit SHA, deployment revision transition, delivery payload metadata, correlated log excerpts, and final pass/fail verdict.
</output>
