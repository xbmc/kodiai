---
phase: 42-commit-message-keywords-pr-intent
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - src/handlers/review.ts
  - src/execution/review-prompt.ts
autonomous: true

must_haves:
  truths:
    - "[no-review] in PR title causes the bot to skip review entirely with an acknowledgment comment"
    - "Commit messages are fetched via GitHub API and passed to parsePRIntent"
    - "Keyword-based profile override applies after config profile (most strict wins)"
    - "[style-ok] adds 'style' to ignored areas additively"
    - "[security-review] adds 'security' to focus areas"
    - "Keyword parsing results appear in Review Details appendix"
    - "Unrecognized bracket tags are displayed in Review Details so users know which keywords were ignored"
    - "Parser failure is fail-open -- review proceeds without keywords"
    - "[no-review] fast check happens before workspace creation for performance"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Integrated keyword parsing pipeline with [no-review] fast check, commit fetching, profile/focus/style overrides, Review Details keyword section"
      contains: "parsePRIntent"
    - path: "src/execution/review-prompt.ts"
      provides: "Conventional commit type context in review prompt for focus guidance"
      contains: "conventionalType"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/pr-intent-parser.ts"
      via: "import { parsePRIntent, DEFAULT_EMPTY_INTENT, buildKeywordParsingSection }"
      pattern: "import.*pr-intent-parser"
    - from: "src/handlers/review.ts"
      to: "formatReviewDetailsSummary"
      via: "New keywordParsing parameter added to function"
      pattern: "keywordParsing"
    - from: "src/handlers/review.ts"
      to: "octokit.rest.pulls.listCommits"
      via: "fetchCommitMessages helper function"
      pattern: "listCommits"
---

<objective>
Wire the PR intent parser into the review handler pipeline, including commit message fetching, [no-review] skip logic, keyword-driven overrides, and Review Details transparency output.

Purpose: Connect the pure parser (Plan 01) to the live review pipeline so keyword signals actually influence review behavior. This is the integration glue that makes the parser useful.

Output: Modified `src/handlers/review.ts` (integration) and `src/execution/review-prompt.ts` (conventional commit context).
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-RESEARCH.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-CONTEXT.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add [no-review] fast check and commit fetching + full parser integration in review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
    Import from `src/lib/pr-intent-parser.ts`:
    ```typescript
    import { parsePRIntent, DEFAULT_EMPTY_INTENT, buildKeywordParsingSection, type ParsedPRIntent } from "../lib/pr-intent-parser.js";
    ```

    **Step 1: [no-review] fast check (BEFORE workspace creation, after draft PR skip at ~line 711)**

    Add a fast title-only check for `[no-review]` immediately after the draft PR skip block and before workspace creation (~line 922). This avoids cloning repos for PRs that will be skipped.

    ```typescript
    // Fast check: [no-review] in title skips review before workspace creation (KEY-06)
    if (/\[no-review\]/i.test(pr.title)) {
      logger.info(
        { ...baseLog, gate: "keyword-skip", gateResult: "skipped" },
        "Review skipped via [no-review] keyword in PR title",
      );
      // Post acknowledgment comment so user knows the keyword was recognized
      try {
        const skipOctokit = await githubApp.getInstallationOctokit(event.installationId);
        await skipOctokit.rest.issues.createComment({
          owner: apiOwner,
          repo: apiRepo,
          issue_number: pr.number,
          body: "Review skipped per `[no-review]` in PR title.",
        });
      } catch (commentErr) {
        logger.warn({ ...baseLog, err: commentErr }, "Failed to post [no-review] acknowledgment (non-fatal)");
      }
      return;
    }
    ```

    Place this after the draft PR skip block (after line 711) but before the `review_requested` action check (line 713). The exact position: after the draft skip `return;` and before the `if (action === "review_requested")` block.

    **Step 2: Create fetchCommitMessages helper function**

    Add a helper function near the top of the file (after imports, before `createReviewHandler`):

    ```typescript
    async function fetchCommitMessages(
      octokit: Awaited<ReturnType<GitHubApp["getInstallationOctokit"]>>,
      owner: string,
      repo: string,
      prNumber: number,
      commitCount: number,
    ): Promise<Array<{ sha: string; message: string }>> {
      if (commitCount === 0) return [];

      const perPage = Math.min(commitCount, 100);
      const { data } = await octokit.rest.pulls.listCommits({
        owner,
        repo,
        pull_number: prNumber,
        per_page: perPage,
      });

      return data.map(c => ({
        sha: c.sha.slice(0, 7),
        message: c.commit.message.split("\n")[0], // First line only per CONTEXT.md decision
      }));
    }
    ```

    **Step 3: Full parser integration (AFTER idempotencyOctokit creation, ~line 1012)**

    Place this block AFTER the `idempotencyOctokit` is created (~line 1012) but BEFORE the diff analysis. The `idempotencyOctokit` is reused for commit fetching (it requires an authenticated octokit instance).

    ```typescript
    // Parse PR intent keywords (KEY-01 through KEY-08)
    let parsedIntent: ParsedPRIntent = DEFAULT_EMPTY_INTENT;
    try {
      const commitMessages = await fetchCommitMessages(
        idempotencyOctokit,  // Reuse existing octokit instance
        apiOwner,
        apiRepo,
        pr.number,
        pr.commits,
      );
      parsedIntent = parsePRIntent(pr.title, pr.body ?? null, commitMessages);
      logger.info(
        {
          ...baseLog,
          gate: "keyword-parse",
          recognized: parsedIntent.recognized,
          unrecognized: parsedIntent.unrecognized,
          noReview: parsedIntent.noReview,
          isWIP: parsedIntent.isWIP,
          profileOverride: parsedIntent.profileOverride,
          breakingChange: parsedIntent.breakingChangeDetected,
          conventionalType: parsedIntent.conventionalType?.type ?? null,
        },
        "PR intent keywords parsed",
      );
    } catch (err) {
      logger.warn({ ...baseLog, err }, "PR intent parsing failed (fail-open, proceeding without keywords)");
    }
    ```

    **Step 4: Apply keyword-driven overrides (after profile preset resolution, ~line 1262)**

    After the existing profile preset block that resolves `resolvedSeverityMinLevel`, `resolvedMaxComments`, `resolvedFocusAreas`, `resolvedIgnoredAreas`, add keyword overrides:

    ```typescript
    // Apply keyword-driven overrides (KEY-04, KEY-05, KEY-07)
    if (parsedIntent.profileOverride) {
      const keywordPreset = PROFILE_PRESETS[parsedIntent.profileOverride];
      if (keywordPreset) {
        // Keyword profile override takes precedence over config profile (most strict wins already resolved by parser)
        resolvedSeverityMinLevel = keywordPreset.severityMinLevel;
        resolvedMaxComments = keywordPreset.maxComments;
        if (keywordPreset.focusAreas.length > 0) {
          resolvedFocusAreas = [...keywordPreset.focusAreas];
        }
        if (keywordPreset.ignoredAreas.length > 0) {
          resolvedIgnoredAreas = [...keywordPreset.ignoredAreas];
        }
        logger.info(
          { ...baseLog, gate: "keyword-profile-override", profile: parsedIntent.profileOverride },
          "Keyword profile override applied",
        );
      }
    }

    // [style-ok] adds "style" to ignored areas additively (KEY-07)
    if (parsedIntent.styleOk && !resolvedIgnoredAreas.includes("style")) {
      resolvedIgnoredAreas.push("style");
    }

    // [security-review] adds "security" to focus areas (KEY-05)
    if (parsedIntent.focusAreas.length > 0) {
      for (const area of parsedIntent.focusAreas) {
        if (!resolvedFocusAreas.includes(area)) {
          resolvedFocusAreas.push(area);
        }
      }
    }
    ```

    **Step 5: Extend formatReviewDetailsSummary to include keyword section**

    Modify the `formatReviewDetailsSummary` function signature to accept an optional `keywordParsing` parameter:

    ```typescript
    function formatReviewDetailsSummary(params: {
      // ...existing params...
      keywordParsing?: ParsedPRIntent;
    }): string {
    ```

    Add destructuring: `keywordParsing` from params.

    After the feedback suppression section (around line 176) and before the closing `</details>`, insert:

    ```typescript
    // Keyword parsing transparency (KEY-08)
    const keywordSection = buildKeywordParsingSection(keywordParsing ?? DEFAULT_EMPTY_INTENT);
    sections.push(keywordSection);
    ```

    **Step 6: Pass parsedIntent to formatReviewDetailsSummary call site**

    At the call site (~line 1578), add `keywordParsing: parsedIntent` to the params object:

    ```typescript
    const reviewDetailsBody = formatReviewDetailsSummary({
      // ...existing params...
      feedbackSuppressionCount: feedbackSuppression.suppressedPatternCount,
      keywordParsing: parsedIntent,  // Add this line
    });
    ```
  </action>
  <verify>
    `npx tsc --noEmit` compiles without errors. Review handler imports resolve correctly. The `[no-review]` fast check is positioned before workspace creation. The keyword overrides are applied after config profile resolution.
  </verify>
  <done>
    [no-review] in PR title skips review before workspace creation with acknowledgment comment. Commit messages fetched via API. Parser results drive profile/focus/style overrides. Review Details includes keyword section. All fail-open on parser errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add conventional commit context to review prompt</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
    Import the type from pr-intent-parser:
    ```typescript
    import type { ConventionalCommitType } from "../lib/pr-intent-parser.js";
    ```

    **Step 1: Extend buildReviewPrompt signature**

    Add a new optional parameter to the `buildReviewPrompt` context object:
    ```typescript
    conventionalType?: ConventionalCommitType | null;
    ```

    **Step 2: Add conventional commit focus guidance in the prompt**

    Inside `buildReviewPrompt`, after the PR intent scoping section is built (after the `buildPrIntentScopingSection` call), add conditional guidance based on the conventional commit type:

    ```typescript
    if (context.conventionalType) {
      const typeGuidance: Record<string, string> = {
        feat: "This is a feature PR. Pay extra attention to: breaking changes in public APIs, missing test coverage for new behavior, documentation for new functionality.",
        fix: "This is a bug fix PR. Pay extra attention to: whether the fix addresses the root cause, test coverage for the fixed scenario, potential regression in related code paths.",
        docs: "This is a documentation PR. Apply lighter review: focus on accuracy of technical content, broken links, and code example correctness. Minimize style findings.",
        refactor: "This is a refactoring PR. Pay extra attention to: behavior preservation (no functional changes), test coverage continuity, and import/export consistency.",
        perf: "This is a performance PR. Pay extra attention to: benchmark methodology, potential correctness trade-offs, and algorithmic complexity changes.",
        test: "This is a test PR. Focus on: test reliability, assertion specificity, edge case coverage. Minimize style findings on production code.",
        ci: "This is a CI/build PR. Focus on: pipeline correctness, security of new dependencies or scripts, and configuration accuracy. Minimize code style findings.",
        chore: "This is a maintenance PR. Apply lighter review: focus on correctness and potential breakage. Minimize style findings.",
      };

      const guidance = typeGuidance[context.conventionalType.type];
      if (guidance) {
        lines.push("");
        lines.push("## Conventional Commit Context");
        lines.push("");
        lines.push(guidance);
      }

      if (context.conventionalType.isBreaking) {
        lines.push("");
        lines.push("**BREAKING CHANGE indicated.** Verify: backward compatibility impact is documented, migration path exists if applicable, and all affected consumers are addressed.");
      }
    }
    ```

    **Step 3: Pass conventionalType from review handler**

    Back in `src/handlers/review.ts`, at the `buildReviewPrompt` call site (~line 1285), add:
    ```typescript
    conventionalType: parsedIntent.conventionalType,
    ```
    alongside the other parameters.
  </action>
  <verify>
    `npx tsc --noEmit` compiles without errors. The conventional commit type guidance appears in the review prompt when a conventional commit prefix is detected in the PR title.
  </verify>
  <done>
    Conventional commit type influences the review prompt with type-specific focus guidance. Breaking change indicator triggers explicit verification instructions. `feat:` PRs get breaking change attention, `fix:` PRs get test coverage attention, `docs:` PRs get lighter review.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- full project compiles without type errors
- `bun test src/lib/pr-intent-parser.test.ts` -- all parser tests pass
- Code review: `[no-review]` check is positioned BEFORE workspace creation (~line 711-712 area)
- Code review: `parsePRIntent` call is wrapped in try/catch with fail-open
- Code review: Profile overrides use `PROFILE_PRESETS` consistently
- Code review: `buildKeywordParsingSection` output appears in Review Details
- Code review: Conventional commit guidance appears in prompt only when type detected
- No new npm dependencies added
</verification>

<success_criteria>
- [no-review] in PR title prevents workspace creation and posts acknowledgment
- Commit messages are fetched from GitHub API with first-line-only extraction
- Keyword profile override replaces config profile settings
- [style-ok] adds "style" to ignored areas
- [security-review] adds "security" to focus areas
- Review Details appendix shows keyword parsing results (or "No keywords detected")
- Conventional commit type adds focus guidance to review prompt
- Parser failure does not crash the review -- fail-open with logging
</success_criteria>

<output>
After completion, create `.planning/phases/42-commit-message-keywords-pr-intent/42-02-SUMMARY.md`
</output>
