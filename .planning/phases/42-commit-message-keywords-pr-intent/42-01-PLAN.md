---
phase: 42-commit-message-keywords-pr-intent
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/pr-intent-parser.ts
  - src/lib/pr-intent-parser.test.ts
autonomous: true

must_haves:
  truths:
    - "Bracket tags like [WIP], [no-review], [security-review], [style-ok] are extracted from PR title (case-insensitive, any position)"
    - "Unrecognized bracket tags are detected and separated from recognized ones"
    - "Conventional commit prefixes (feat:, fix:, docs:, etc.) are parsed from PR title"
    - "Breaking change keywords are detected in PR body (outside code blocks) and commit messages"
    - "When multiple profile tags conflict, the most strict wins (strict > balanced > minimal)"
    - "For 50+ commits, strategic sampling selects first 10, last 10, and every 5th in between"
    - "[no-review] sets noReview: true, [style-ok] sets styleOk: true, [WIP] sets isWIP: true"
  artifacts:
    - path: "src/lib/pr-intent-parser.ts"
      provides: "parsePRIntent pure function, types (ParsedPRIntent, BracketTag, ConventionalCommitType), buildKeywordParsingSection"
      exports: ["parsePRIntent", "ParsedPRIntent", "BracketTag", "ConventionalCommitType", "buildKeywordParsingSection", "DEFAULT_EMPTY_INTENT"]
    - path: "src/lib/pr-intent-parser.test.ts"
      provides: "Unit tests covering all parsing scenarios"
      min_lines: 80
  key_links:
    - from: "src/lib/pr-intent-parser.ts"
      to: "parsePRIntent function"
      via: "Pure function: (title, body, commits?) => ParsedPRIntent"
      pattern: "parsePRIntent\\("
---

<objective>
Implement the PR intent parser as a pure function with comprehensive test coverage using TDD.

Purpose: Create the core parsing engine that extracts structured review intent signals from PR metadata (title bracket tags, conventional commit prefixes, breaking change keywords, commit message scanning). This is a pure function with zero side effects -- no API calls, no I/O.

Output: `src/lib/pr-intent-parser.ts` (parser + types + section builder) and `src/lib/pr-intent-parser.test.ts` (tests).
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-RESEARCH.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-CONTEXT.md
</context>

<tasks>

<task type="tdd">
  <name>Task 1: RED -- Write failing tests for PR intent parser</name>
  <files>src/lib/pr-intent-parser.test.ts, src/lib/pr-intent-parser.ts</files>
  <action>
    Create `src/lib/pr-intent-parser.ts` with ONLY the type definitions and stub exports (all functions throw "not implemented"). This lets tests import and compile but fail on assertions.

    **Types to export:**

    ```typescript
    export type BracketTag = {
      tag: string;           // normalized lowercase, e.g., "wip", "no-review"
      recognized: boolean;
      source: "title" | "body" | "commit";
      commitSha?: string;
    };

    export type ConventionalCommitType = {
      type: string;          // e.g., "feat", "fix", "docs"
      isBreaking: boolean;   // feat!: prefix
      source: "title" | "commit";
    };

    export type ParsedPRIntent = {
      bracketTags: BracketTag[];
      conventionalType: ConventionalCommitType | null;
      breakingChangeDetected: boolean;
      breakingChangeSources: Array<{ source: "title" | "body" | "commit"; excerpt: string; commitSha?: string }>;
      noReview: boolean;
      isWIP: boolean;
      profileOverride: "strict" | "balanced" | "minimal" | null;
      focusAreas: string[];
      styleOk: boolean;
      recognized: string[];
      unrecognized: string[];
    };
    ```

    **Recognized bracket tags (case-insensitive):**
    `wip`, `draft`, `no-review`, `strict-review`, `balanced-review`, `minimal-review`, `security-review`, `style-ok`

    Create `src/lib/pr-intent-parser.test.ts` with `bun:test`. Write the following test groups using `describe`/`it`:

    **describe("extractBracketTags / bracket tag parsing"):**
    - `"[WIP] Fix login bug"` -> `isWIP: true`, bracketTags has `{tag: "wip", recognized: true, source: "title"}`
    - `"Fix bug [security-review]"` -> `focusAreas: ["security"]`
    - `"[no-review] Docs update"` -> `noReview: true`
    - `"[style-ok] Refactor utils"` -> `styleOk: true`
    - `"[strict-review] Critical fix"` -> `profileOverride: "strict"`
    - `"[foobar] Random PR"` -> `unrecognized: ["foobar"]`, `recognized: []`
    - `"[WIP] [security-review] Fix"` -> `isWIP: true`, `focusAreas: ["security"]`, `recognized: ["wip", "security-review"]`
    - `"[STRICT-REVIEW] [minimal-review]"` -> `profileOverride: "strict"` (most strict wins)
    - `"[wip] [Wip] [WIP]"` -> deduplicates to one entry, `isWIP: true`
    - `"No tags here"` -> all empty/false/null

    **describe("conventional commit parsing"):**
    - `"feat: add user login"` -> `conventionalType: {type: "feat", isBreaking: false, source: "title"}`
    - `"fix!: resolve crash"` -> `conventionalType: {type: "fix", isBreaking: true, source: "title"}`, `breakingChangeDetected: true`
    - `"docs(readme): update"` -> `conventionalType: {type: "docs", isBreaking: false, source: "title"}`
    - `"Fix: a bug"` -> `conventionalType: {type: "fix", isBreaking: false, source: "title"}` (case-insensitive)
    - `"Not a conventional: commit"` -> `conventionalType: null`

    **describe("breaking change detection"):**
    - title `"feat!: new API"`, body `null` -> `breakingChangeDetected: true`
    - title `"Update API"`, body `"This is a breaking change to the REST API"` -> `breakingChangeDetected: true`, source: "body"
    - title `"Update API"`, body `"This breaks backward compatibility"` -> `breakingChangeDetected: true`
    - title `"Update API"`, body `"Breaking API response format"` -> `breakingChangeDetected: true`
    - title `"Update API"`, body `` "```\nbreaking change\n```" `` -> `breakingChangeDetected: false` (inside code block)
    - title `"Update API"`, body `` "`breaking change`" `` -> `breakingChangeDetected: false` (inline code)
    - commits `[{sha: "abc1234", message: "breaking change: remove old API"}]` -> `breakingChangeDetected: true`, source: "commit"

    **describe("commit message scanning"):**
    - commits with `[WIP]` in message -> `isWIP: true` (union strategy)
    - commits with `[security-review]` -> `focusAreas: ["security"]`
    - empty commits array -> no effect
    - undefined commits -> no effect

    **describe("sampleCommitMessages"):**
    - 60 commits -> returns first 10 + every 5th from middle + last 10
    - 30 commits -> returns all 30 (under threshold)
    - 50 commits -> returns all 50 (threshold is >50)

    **describe("buildKeywordParsingSection"):**
    - `buildKeywordParsingSection(emptyIntent)` -> `"- Keyword parsing: No keywords detected"`
    - `buildKeywordParsingSection(intentWithTags)` -> includes recognized tags, unrecognized tags, conventional type, breaking change sources
    - Source locations shown: "[WIP] in title", "breaking change in commit abc1234"

    **WIP resolution (Claude's discretion):**
    `[WIP]` sets `isWIP: true` but does NOT set `noReview: true`. WIP PRs still get reviewed (lighter treatment is handled downstream by Phase 43). Rationale: users who tag `[WIP]` on a non-draft PR want early feedback.
  </action>
  <verify>
    Run `bun test src/lib/pr-intent-parser.test.ts` -- tests MUST fail (RED phase). All test files compile and import correctly. Stub exports exist in the source file.
  </verify>
  <done>
    Test file exists with all test cases listed above. Source file has type exports and stub functions. Running tests produces failures on assertions (not import errors).
  </done>
</task>

<task type="tdd">
  <name>Task 2: GREEN -- Implement PR intent parser to pass all tests</name>
  <files>src/lib/pr-intent-parser.ts</files>
  <action>
    Replace the stubs in `src/lib/pr-intent-parser.ts` with real implementations. Pure TypeScript, zero dependencies beyond built-in. The parser file should be under 250 lines. Follow existing patterns in `src/lib/` (see `delta-classifier.ts`, `file-risk-scorer.ts` for structure examples).

    **Implementation approach -- internal helper functions:**

    1. `extractBracketTags(text, source, commitSha?)` -- regex `/\[([^\]]+)\]/g`, normalize lowercase, classify recognized vs unrecognized, deduplicate by tag name
    2. `extractConventionalType(title)` -- regex `/^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(!)?(\([^)]+\))?\s*:/i`
    3. `detectBreakingChange(title, body, commits?)` -- strip code blocks from body first (fenced ``` and inline `), scan with patterns: `/\bbreaking\s+change[s]?\b/i`, `/\bthis\s+breaks\b/i`, `/\bbreaking\s+api\b/i`, `/\bBREAKING[- ]CHANGE\b/`
    4. `resolveProfileOverride(tags)` -- extract profile tags, apply strictness ordering (strict=3 > balanced=2 > minimal=1), most strict wins
    5. `sampleCommitMessages(commits)` -- for arrays >50, return first 10 + every 5th in middle + last 10; <=50 returns all

    **Exported functions:**
    6. `parsePRIntent(title, body, commitMessages?)` -- orchestrate all helpers, return `ParsedPRIntent`
    7. `buildKeywordParsingSection(intent)` -- render parsed intent to markdown for Review Details appendix
    8. `DEFAULT_EMPTY_INTENT` constant -- all fields empty/false/null for fail-open use

    After implementing, run tests. If any fail, fix implementation until all pass. Do NOT modify tests.
  </action>
  <verify>
    Run `bun test src/lib/pr-intent-parser.test.ts` -- ALL tests MUST pass (GREEN phase). Run `npx tsc --noEmit` to verify type correctness.
  </verify>
  <done>
    All tests pass. `parsePRIntent` returns correct `ParsedPRIntent` for every test case. No external dependencies added. Types exported for use in Plan 02. `DEFAULT_EMPTY_INTENT` exported. `buildKeywordParsingSection` renders correct markdown. Parser file is under 250 lines.
  </done>
</task>

</tasks>

<verification>
- `bun test src/lib/pr-intent-parser.test.ts` passes all tests
- All recognized tags are correctly classified
- Unrecognized tags are captured for display
- Breaking change detection ignores content inside code blocks
- Profile override resolves to most strict when multiple present
- Strategic sampling works correctly for various commit counts
- `buildKeywordParsingSection` produces readable markdown
</verification>

<success_criteria>
- `parsePRIntent` returns correct ParsedPRIntent for all test cases
- No external dependencies added
- Types exported for use in Plan 02
- DEFAULT_EMPTY_INTENT exported for fail-open pattern
- buildKeywordParsingSection renders correct markdown
- All tests pass with `bun test`
</success_criteria>

<output>
After completion, create `.planning/phases/42-commit-message-keywords-pr-intent/42-01-SUMMARY.md`
</output>
