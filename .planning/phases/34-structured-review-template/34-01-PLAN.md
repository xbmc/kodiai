---
phase: 34-structured-review-template
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Standard-mode review prompt instructs Claude to produce five ordered sections: What Changed, Strengths, Observations, Suggestions, Verdict"
    - "Prompt includes a dynamically-built 'Reviewed: ...' checklist line derived from DiffAnalysis.filesByCategory"
    - "Prompt instructs Strengths items to use :white_check_mark: prefix for verified positives"
    - "Enhanced mode prompt is unchanged (no summary comment, no new sections)"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "buildReviewedCategoriesLine() helper and five-section summary template"
      exports: ["buildReviewedCategoriesLine"]
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for new template structure and categories helper"
      contains: "buildReviewedCategoriesLine"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "DiffAnalysis.filesByCategory"
      via: "buildReviewedCategoriesLine() reads category keys"
      pattern: "filesByCategory"
---

<objective>
Rewrite the standard-mode summary comment prompt and add a reviewed-categories helper

Purpose: Instruct Claude to produce the five-section structured template (What Changed, Strengths, Observations, Suggestions, Verdict) instead of the current issues-only format, and dynamically generate the FORMAT-02 "Reviewed: ..." checklist from diff analysis data.

Output: Updated review-prompt.ts with new template instructions and buildReviewedCategoriesLine() export; updated review-prompt.test.ts with tests for both.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-structured-review-template/34-RESEARCH.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/execution/diff-analysis.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildReviewedCategoriesLine helper and rewrite standard-mode summary prompt</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
1. Add a new exported function `buildReviewedCategoriesLine(filesByCategory: Record<string, string[]>): string` near the other helper functions. It maps file category keys to human-readable labels:
   - source -> "core logic"
   - test -> "tests"
   - config -> "config"
   - docs -> "docs"
   - infra -> "infrastructure"
   Filter out categories with 0 files. Return empty string if no categories have files. Otherwise return `"Reviewed: core logic, tests, config"` (comma-separated labels for non-empty categories).

2. In `buildReviewPrompt()`, locate the standard-mode summary comment section (the `else` branch around line 842). Replace the entire standard-mode summary comment instructions with the new five-section template. The new prompt section should:

   a. Keep the guard: "ONLY post a summary comment if you found actionable issues to report as inline comments."
   b. Keep the `<details><summary>Kodiai Review Summary</summary>` wrapper.
   c. Replace the issues-only template with five sections in order:
      - `## What Changed` - Brief 1-2 sentence summary of PR intent from title/description, followed by the reviewed categories line (call `buildReviewedCategoriesLine(context.diffAnalysis?.filesByCategory ?? {})`)
      - `## Strengths` - Each item prefixed with `:white_check_mark:`. Instruction: "List 1-3 specific verified positives about the code changes. Each item must cite a concrete observation."
      - `## Observations` - Group issues under severity sub-headings (`### Critical`, `### Major`, `### Medium`, `### Minor`). Keep the existing issue format: `path/to/file.ts (123, 456): <issue title>` followed by 1-3 sentence explanation. This is the same format as the current Observations section, just nested under `## Observations`.
      - `## Suggestions` - Optional non-blocking improvements. Each is a bullet point. Instruction: "List optional improvements that do not block merging. Omit this section if you have no suggestions."
      - `## Verdict` - One of four verdicts with emoji:
        - `:green_circle: **Looks good** -- <explanation>` (only minor suggestions, nothing blocking)
        - `:yellow_circle: **Needs changes** -- <count and summary of issues>` (has major/medium issues)
        - `:red_circle: **Blocker** -- <count and summary of critical issues>` (has critical issues)
      - Note: The `:green_circle:` verdict should NOT appear in a summary comment since summaries are only posted when issues exist. Include it in the template for completeness but add: "Since this summary is only posted when issues exist, the verdict will typically be :yellow_circle: or :red_circle:."

   d. Add hard requirements:
      - "## What Changed and ## Observations and ## Verdict are REQUIRED sections"
      - "## Strengths and ## Suggestions are OPTIONAL -- omit if nothing meaningful to say"
      - "Section order MUST be: What Changed, Strengths, Observations, Suggestions, Verdict"
      - "Do NOT add any other ## headings"
      - "Under ## Observations, use ### severity sub-headings (Critical, Major, Medium, Minor)"
      - "Under ## Strengths, prefix each item with :white_check_mark:"
      - "Under ## Verdict, use exactly one verdict line with emoji"
   e. Keep the existing "If NO issues found: do NOT post any comment." instruction at the end.
   f. Keep "Then post your inline comments on the specific lines." instruction.

3. Do NOT modify the enhanced-mode branch -- it stays as-is.
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts` -- existing tests should still pass (the enhanced-mode test is unchanged; the standard-mode test will need updating in Task 2). Also verify no TypeScript errors: `bunx tsc --noEmit --pretty 2>&1 | head -20`.
  </verify>
  <done>
buildReviewedCategoriesLine() is exported and returns correct category labels. Standard-mode prompt contains five-section template with ## What Changed, ## Strengths, ## Observations, ## Suggestions, ## Verdict. Enhanced mode is unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update review-prompt tests for new template and categories helper</name>
  <files>src/execution/review-prompt.test.ts</files>
  <action>
1. Import `buildReviewedCategoriesLine` from `review-prompt.ts`.

2. Add a new `describe("buildReviewedCategoriesLine")` block with tests:
   - Returns `"Reviewed: core logic, tests"` when filesByCategory has source and test with files, others empty
   - Returns `"Reviewed: core logic, tests, config, docs, infrastructure"` when all categories have files
   - Returns `""` (empty string) when all categories are empty arrays
   - Returns `"Reviewed: tests"` when only test has files
   - Handles unknown category keys gracefully (uses key as label)

3. Update the existing test `"default config preserves summary comment section"` -- it currently checks for `"Kodiai Review Summary"` and `"summary comment"`. Update it to also verify:
   - Prompt contains `"## What Changed"`
   - Prompt contains `"## Observations"`
   - Prompt contains `"## Verdict"`
   - Prompt contains `:white_check_mark:` (strengths format instruction)
   - Prompt does NOT contain the old hard requirement `"MUST be issues-only"` (which is being replaced)

4. Add a new test: `"standard mode includes reviewed categories line when diffAnalysis provided"` -- build a prompt with a `diffAnalysis` that has `filesByCategory: { source: ["a.ts"], test: ["a.test.ts"], config: [], docs: [], infra: [] }`. Verify the prompt contains `"Reviewed: core logic, tests"`.

5. Add a new test: `"standard mode omits reviewed categories when no diffAnalysis"` -- build a prompt without diffAnalysis. Verify the prompt does NOT contain the literal `"Reviewed:"` line.

6. Verify the existing enhanced-mode test still passes unchanged.
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all tests pass including new ones.</verify>
  <done>
All review-prompt tests pass. New tests verify five-section template presence, categories line behavior, and enhanced-mode isolation.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/execution/review-prompt.test.ts` -- all tests pass
2. `bunx tsc --noEmit` -- no type errors
3. Standard-mode prompt contains all five section headings in order
4. Enhanced-mode prompt is unchanged
5. buildReviewedCategoriesLine correctly maps all 5 category names to labels
</verification>

<success_criteria>
- buildReviewedCategoriesLine() exported and tested with 5+ test cases
- Standard-mode summary prompt uses five-section template (What Changed, Strengths, Observations, Suggestions, Verdict)
- Strengths section uses :white_check_mark: prefix
- Reviewed categories line appears when diffAnalysis is provided
- Enhanced mode is completely unaffected
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-structured-review-template/34-01-SUMMARY.md`
</output>
