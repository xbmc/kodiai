---
phase: 34-structured-review-template
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true

must_haves:
  truths:
    - "sanitizeKodiaiReviewSummary() validates the five-section template with required sections (What Changed, Observations, Verdict) and optional sections (Strengths, Suggestions)"
    - "Sanitizer enforces section ordering -- sections must appear in the canonical order when present"
    - "Sanitizer validates verdict line format uses one of the three verdict emojis with bold label and explanation"
    - "Valid reviews with all five sections pass sanitization without modification"
    - "Valid reviews with only required sections (no Strengths, no Suggestions) pass sanitization"
    - "Old issues-only format no longer passes validation (severity heading without ## prefix is rejected)"
  artifacts:
    - path: "src/execution/mcp/comment-server.ts"
      provides: "Updated sanitizeKodiaiReviewSummary() with five-section validation"
      contains: "## What Changed"
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Tests for new sanitizer validation logic"
      contains: "sanitizeKodiaiReviewSummary"
  key_links:
    - from: "src/execution/mcp/comment-server.ts"
      to: "sanitizeKodiaiReviewSummary"
      via: "called on every create_comment and update_comment for review summaries"
      pattern: "sanitizeKodiaiReviewSummary"
---

<objective>
Rewrite sanitizeKodiaiReviewSummary() to validate the new five-section template

Purpose: Enforce the structured review template server-side so that malformed or hallucinated section orderings are caught before posting to GitHub. The sanitizer is the safety net that ensures consistent output regardless of prompt compliance.

Output: Updated comment-server.ts with five-section validation logic; comprehensive sanitizer tests in comment-server.test.ts.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-structured-review-template/34-RESEARCH.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/comment-server.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite sanitizeKodiaiReviewSummary for five-section template</name>
  <files>src/execution/mcp/comment-server.ts</files>
  <action>
Replace the body of `sanitizeKodiaiReviewSummary()` (lines ~100-222) with new validation logic. Keep the function signature and the early-return guard for non-review comments (`if (!body.includes("<summary>Kodiai Review Summary</summary>")) return body;`).

New validation logic:

1. **Strip forbidden content** (update the filter):
   - Remove old stripped patterns: `**What changed:**`, `What changed:`, `**Issues found:**`, `**Note:**` -- these are legacy and should still be stripped for safety.
   - Keep the line-by-line filter approach.

2. **Section presence validation:**
   - Define required sections: `["## What Changed", "## Observations", "## Verdict"]`
   - Define optional sections: `["## Strengths", "## Suggestions"]`
   - Define canonical order: `["## What Changed", "## Strengths", "## Observations", "## Suggestions", "## Verdict"]`
   - Check each required section exists in the stripped content. If missing, throw: `"Invalid Kodiai review summary: missing required section '## What Changed'"` (etc).

3. **Section order validation:**
   - Collect all present sections (required + optional that exist) in their appearance order (by indexOf).
   - Compare against the canonical order (filtered to present sections only).
   - If any section appears before a section that should precede it, throw: `"Invalid Kodiai review summary: sections must appear in order (What Changed -> Strengths -> Observations -> Suggestions -> Verdict)"`.

4. **Verdict format validation:**
   - Extract the content after `## Verdict`.
   - Look for a verdict line matching the regex: `/^:(green_circle|yellow_circle|red_circle): \*\*[^*]+\*\* -- .+$/m`
   - If no verdict line found, throw: `"Invalid Kodiai review summary: Verdict must use format ':emoji: **Label** -- explanation'"`.

5. **Observations section validation:**
   - Extract content between `## Observations` and the next `##` section (or end).
   - Check for at least one severity sub-heading: `### Critical`, `### Major`, `### Medium`, or `### Minor`.
   - If no severity sub-heading found, throw: `"Invalid Kodiai review summary: Observations must contain at least one severity sub-heading (### Critical, ### Major, ### Medium, ### Minor)"`.
   - Under each severity sub-heading, validate at least one issue line exists using the existing `issueLineRe` pattern (path + lines + title). Keep the existing regex: `/^(.+?) \((?:\d+(?:-\d+)?(?:,\s*\d+(?:-\d+)?)*)\): (.+)$/`
   - After each issue line, require at least one explanation line (non-empty, non-heading).

6. **No extra top-level headings:**
   - Scan for any `## ` headings that are not in the canonical set. If found, throw: `"Invalid Kodiai review summary: unexpected section '## Foo'. Only use: What Changed, Strengths, Observations, Suggestions, Verdict"`.

7. **Return** the stripped content (same as current behavior -- strip forbidden lines, return the rest).

Important: The sanitizer must be tolerant of blank lines, varying whitespace, and content within sections (the prompt controls what Claude writes; the sanitizer only enforces structure). Do NOT validate Strengths content format (the :white_check_mark: prefix is a prompt instruction, not a sanitizer concern).
  </action>
  <verify>
Run `bunx tsc --noEmit --pretty 2>&1 | head -20` -- no type errors. Then run `bun test src/execution/mcp/comment-server.test.ts` -- existing tests should still pass (the existing test for non-review comments passthrough is unaffected).
  </verify>
  <done>
sanitizeKodiaiReviewSummary() validates five required/optional sections in order, validates verdict format, validates observations have severity sub-headings with issue lines, and rejects extra headings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive sanitizer tests for five-section template</name>
  <files>src/execution/mcp/comment-server.test.ts</files>
  <action>
Add a new `describe("sanitizeKodiaiReviewSummary")` block in the test file. Since the sanitizer is a private function inside `createCommentServer`, the tests should exercise it through the `create_comment` tool handler (which calls sanitizeKodiaiReviewSummary internally). Use the existing `getToolHandlers` helper to access the handler.

Create a mock octokit that captures the body passed to `issues.createComment`. Set up the comment server with `issue_number` matching the test PR number and appropriate owner/repo/marker.

Test cases (each calls `create.handler({ body: ... })` and checks the result):

**Passing cases:**
1. "accepts valid five-section summary with all sections" -- body with `<details>`, all 5 sections in order, valid verdict, valid observations with severity sub-heading and issue line + explanation. Assert: no error, createComment called with the body.

2. "accepts summary with only required sections (no Strengths, no Suggestions)" -- body with What Changed, Observations, Verdict only. Assert: passes.

3. "accepts summary with Strengths but no Suggestions" -- three required + Strengths. Assert: passes.

4. "accepts summary with multiple severity sub-headings in Observations" -- ### Critical + ### Medium each with issues. Assert: passes.

**Rejection cases:**
5. "rejects summary missing ## What Changed" -- has Observations and Verdict but no What Changed. Assert: error mentioning "## What Changed".

6. "rejects summary missing ## Observations" -- has What Changed and Verdict but no Observations. Assert: error mentioning "## Observations".

7. "rejects summary missing ## Verdict" -- has What Changed and Observations but no Verdict. Assert: error mentioning "## Verdict".

8. "rejects summary with sections out of order" -- Verdict before Observations. Assert: error mentioning "order".

9. "rejects verdict without correct format" -- verdict section has text but no `:emoji: **Label** -- explanation` line. Assert: error mentioning "Verdict must use format".

10. "rejects observations without severity sub-heading" -- ## Observations has content but no ### heading. Assert: error mentioning "severity sub-heading".

11. "rejects extra top-level heading" -- has `## Notes` in addition to valid sections. Assert: error mentioning "unexpected section".

**Passthrough case:**
12. "passes through non-review comments unchanged" -- body without `<summary>Kodiai Review Summary</summary>`. Assert: body unchanged. (This may already exist -- if so, keep it and add the new tests alongside.)

For building test bodies, create a helper function `buildTestSummary(sections: Record<string, string>)` that constructs a `<details><summary>Kodiai Review Summary</summary>...sections...</details>` string from section name/content pairs.
  </action>
  <verify>Run `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass including the new sanitizer tests.</verify>
  <done>
12+ sanitizer test cases covering valid five-section reviews, missing required sections, out-of-order sections, invalid verdict format, missing severity sub-headings, extra headings, and non-review passthrough. All pass.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass
2. `bunx tsc --noEmit` -- no type errors
3. Valid five-section summaries pass through sanitizer
4. Summaries missing required sections are rejected with clear error messages
5. Out-of-order sections are rejected
6. Invalid verdict format is rejected
7. Non-review comments are unaffected
</verification>

<success_criteria>
- sanitizeKodiaiReviewSummary() enforces five-section structure
- Required sections (What Changed, Observations, Verdict) must be present
- Optional sections (Strengths, Suggestions) validated when present
- Section order enforced
- Verdict format validated (emoji + bold label + explanation)
- Observations require severity sub-headings with issue lines
- 12+ test cases covering happy and error paths
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/34-structured-review-template/34-02-SUMMARY.md`
</output>
