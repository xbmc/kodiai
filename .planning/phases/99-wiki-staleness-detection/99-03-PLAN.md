---
title: "99-03: Wire Staleness Detector into index.ts + wiki-check trigger"
phase: 99
plan: 3
wave: 3
depends_on:
  - 99-01
  - 99-02
files_modified:
  - src/index.ts
autonomous: true
requirements:
  - WIKI-01
  - WIKI-03
  - WIKI-04
  - WIKI-05
---

# Plan 99-03: Wiring — index.ts Integration + @kodiai wiki-check Trigger

## Goal

Wire the `WikiStalenessDetector` into `src/index.ts`:
1. Instantiate `createWikiStalenessDetector` with all required dependencies from the existing wired objects
2. Start the scheduler (parallel to `wikiSyncScheduler`)
3. Stop the detector on shutdown (alongside `_wikiSyncSchedulerRef`)
4. Intercept `@kodiai wiki-check` mentions in `onAllowedBootstrap` and route to `wikiStalenessDetector.runScan()` instead of the LLM agent

## Context

From `src/index.ts` inspection:
- `githubApp` is available (created at startup)
- `sql` is available as a `Sql` instance
- `slackClient` is available (created as `createSlackClient`)
- `wikiPageStore` is available
- Config values `slackWikiChannelId`, `wikiStalenessThresholdDays`, `wikiGithubOwner`, `wikiGithubRepo` are added to `config` in plan 99-01-B
- `_wikiSyncSchedulerRef` is the mutable ref pattern for shutdown; we need a similar ref for the staleness detector
- `onAllowedBootstrap` callback in `createSlackEventRoutes` receives the `SlackV1BootstrapPayload` with `.text`
- The `requestTracker.trackJob()` pattern wraps on-demand async operations for clean shutdown (see RESEARCH.md Pitfall 5)
- Task router is created in `executor.ts` — need to create one for the staleness detector too (use `createTaskRouter` from `src/llm/task-router.ts` with an empty `models: {}` to use category defaults)

## Tasks

<task id="99-03-A" wave="1">
### Wire createWikiStalenessDetector in src/index.ts

**File:** `src/index.ts`

#### Step 1: Add import

Add import after the `createWikiSyncScheduler` import line:

```typescript
import { createWikiStalenessDetector } from "./knowledge/wiki-staleness-detector.ts";
import { createTaskRouter } from "./llm/task-router.ts";
```

Note: `createTaskRouter` may already be imported if executor uses it — check first. If so, only add the `createWikiStalenessDetector` import.

#### Step 2: Add mutable ref for staleness detector

After the existing `let _wikiSyncSchedulerRef: { stop: () => void } | null = null;` line, add:

```typescript
let _wikiStalenessDetectorRef: { stop: () => void } | null = null;
```

#### Step 3: Update shutdown manager closeDb callback

The `shutdownManager` `closeDb` callback currently stops `_wikiSyncSchedulerRef`. Add staleness detector stop:

```typescript
closeDb: async () => {
  _wikiSyncSchedulerRef?.stop();
  _wikiStalenessDetectorRef?.stop();  // ADD THIS LINE
  await closeDb();
},
```

#### Step 4: Instantiate and start the staleness detector

After the existing `wikiSyncScheduler` block (after `logger.info("Wiki sync scheduler started...")`), add:

```typescript
// Wiki staleness detector (Phase 99: weekly scheduled scan)
const stalenessTaskRouter = createTaskRouter({ models: {} }, logger);
const wikiStalenessDetector = config.slackWikiChannelId
  ? createWikiStalenessDetector({
      sql,
      wikiPageStore,
      githubApp,
      slackClient,
      taskRouter: stalenessTaskRouter,
      logger,
      githubOwner: config.wikiGithubOwner,
      githubRepo: config.wikiGithubRepo,
      wikiChannelId: config.slackWikiChannelId,
      stalenessThresholdDays: config.wikiStalenessThresholdDays,
    })
  : null;
if (wikiStalenessDetector) {
  wikiStalenessDetector.start();
  _wikiStalenessDetectorRef = wikiStalenessDetector;
  logger.info(
    {
      intervalDays: 7,
      startupDelayMs: 90_000,
      channelId: config.slackWikiChannelId,
      owner: config.wikiGithubOwner,
      repo: config.wikiGithubRepo,
    },
    "Wiki staleness detector started (7-day interval, 90s startup delay)",
  );
} else {
  logger.info("Wiki staleness detector disabled: SLACK_WIKI_CHANNEL_ID not configured");
}
```

**Guard condition:** Only instantiate if `slackWikiChannelId` is configured. This is safe because all other config fields have defaults (`wikiGithubOwner` defaults to "xbmc", etc.).

#### Step 5: Add wiki-check trigger in onAllowedBootstrap

The current `onAllowedBootstrap` callback is:

```typescript
onAllowedBootstrap: async (payload) => {
  await slackAssistantHandler.handle(payload);
},
```

Replace with:

```typescript
onAllowedBootstrap: async (payload) => {
  // On-demand wiki staleness check trigger: @kodiai wiki-check
  if (/wiki[-\s]?check/i.test(payload.text) && wikiStalenessDetector) {
    const untrackJob = requestTracker?.trackJob();
    Promise.resolve()
      .then(async () => {
        logger.info({ channel: payload.channel, user: payload.user }, "On-demand wiki-check triggered");
        await wikiStalenessDetector.runScan();
      })
      .catch((err) => {
        logger.error({ err }, "On-demand wiki-check scan failed");
      })
      .finally(() => {
        untrackJob?.();
      });
    return; // Don't route to slackAssistantHandler
  }

  await slackAssistantHandler.handle(payload);
},
```

**Why fire-and-forget with trackJob:** The wiki-check scan can take 30+ seconds. We return immediately from the Slack event handler (Slack 3s ack window) and track the job for clean shutdown. The result is posted directly to Slack by the detector's `deliverStalenessReport` — no need to reply in the original thread.

**Why `requestTracker?.trackJob()` (optional chain):** `requestTracker` is already in scope from earlier in `index.ts`; it's non-null in production. Use optional chain to match the existing pattern in `slack-events.ts`.
</task>

## Verification

```
must_haves:
  - import createWikiStalenessDetector in index.ts
  - _wikiStalenessDetectorRef declared and used in shutdownManager closeDb callback
  - wikiStalenessDetector instantiated only when config.slackWikiChannelId is truthy
  - wikiStalenessDetector.start() called when detector is instantiated
  - /wiki[-\s]?check/i regex intercepts @kodiai wiki-check messages before slackAssistantHandler
  - On-demand trigger uses requestTracker.trackJob() pattern for clean shutdown
  - On-demand trigger fires runScan() fire-and-forget (does NOT await before returning)
  - If wikiStalenessDetector is null (channel not configured), wiki-check falls through to slackAssistantHandler
  - bun run typecheck passes
```
