---
phase: 63-intent-gate-idempotency-foundations
plan: 02
type: tdd
wave: 2
depends_on: ["01"]
files_modified:
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Replaying the same issue apply:/change: trigger reuses the existing PR and replies with Existing PR link instead of creating a duplicate"
    - "Concurrent in-flight duplicate issue write requests receive a single clear 'already in progress' reply instead of duplicate work"
    - "Rate-limited issue write requests receive a single clear retry-later message without thrashing"
  artifacts:
    - path: "src/handlers/mention.test.ts"
      provides: "Issue-surface idempotency, in-flight de-dupe, and rate limit regression tests"
      contains: "issue.*idempoten"
  key_links:
    - from: "src/handlers/mention.test.ts"
      to: "src/handlers/mention.ts"
      via: "Issue-surface write request fixtures exercising idempotency and de-dupe paths"
      pattern: "issue.*apply.*existing|in.flight|rate.limit"
---

<objective>
Lock issue-surface idempotency, in-flight de-dupe, and rate limiting with focused regression tests.

Purpose: The idempotency (existing PR reuse), in-flight de-dupe (process-local lock), and rate limiting mechanisms exist in the handler but only have PR-surface test coverage. Phase 63 requires these to be verified for issue-surface write requests specifically. Adding issue-surface regression tests closes IWR-02 and SAFE-02 gaps.

Output: Three focused issue-surface regression tests validating replay idempotency, concurrent de-dupe, and rate limiting.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue-surface idempotency regression test</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add a new test case:

**"issue apply: replay reuses existing PR and replies with Existing PR link"**

Setup:
- Create an `issue_comment.created` event with body `@kodiai apply: fix the login bug` (explicit prefix)
- Configure `write.enabled: true`
- Mock `octokit.rest.pulls.list` to return `[{ html_url: "https://example.com/pr/42" }]` (simulating an existing PR for the deterministic branch)
- Track whether the executor is called and whether pulls.create is called

Assertions:
- The executor is NOT called (early return on existing PR reuse)
- `pulls.create` is NOT called
- A reply is posted containing `Existing PR: https://example.com/pr/42`

This proves that replaying the same issue write trigger reuses the existing PR branch.

Use the issue_comment event shape from existing issue write-mode tests (the production-like fixture pattern from phase 62).

Run `bun test src/handlers/mention.test.ts --timeout 30000` — should pass immediately since the idempotency code path already exists.
  </action>
  <verify>`bun test src/handlers/mention.test.ts --timeout 30000` passes. The new test asserts issue-surface idempotency behavior.</verify>
  <done>Issue-surface replay idempotency is locked by a deterministic regression test.</done>
</task>

<task type="auto">
  <name>Task 2: Add issue-surface in-flight de-dupe and rate limit regression tests</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add two new test cases:

1. **"concurrent issue apply: requests are de-duped with in-flight lock"**

Setup:
- Create an `issue_comment.created` event with body `@kodiai apply: fix the login bug`
- Configure `write.enabled: true`
- Mock `octokit.rest.pulls.list` to return empty (no existing PR) so the code proceeds past idempotency check
- Make the executor return a slow promise (e.g., use a deferred promise that resolves after the second call)
- Fire the handler TWICE concurrently with the same event (same commentId)

Assertions:
- The executor is called exactly ONCE (not twice)
- The second invocation posts a reply containing "already in progress"
- Only one PR is created

2. **"issue apply: rate limiting returns retry-later message"**

Setup:
- Create two `issue_comment.created` events from the same repo with body `@kodiai apply: fix A` and `@kodiai apply: fix B` (different comment IDs)
- Configure `write.enabled: true` and `write.minIntervalSeconds: 60`
- Mock `octokit.rest.pulls.list` to return empty
- Fire first handler to completion (creates PR successfully)
- Fire second handler immediately after

Assertions:
- First request succeeds (PR created)
- Second request receives a reply containing "rate-limited" with a retry time
- Only one PR is created total

Use existing test patterns for concurrent handler invocation and rate limiting from the file.

Run `bun test src/handlers/mention.test.ts --timeout 30000` — both should pass since the in-flight lock and rate limiter already exist.
  </action>
  <verify>`bun test src/handlers/mention.test.ts --timeout 30000` passes. `bun test` passes. `bunx tsc --noEmit` passes.</verify>
  <done>Issue-surface in-flight de-dupe and rate limiting are locked by focused regression tests. SAFE-02 is satisfied.</done>
</task>

</tasks>

<verification>
1. `bun test src/handlers/mention.test.ts --timeout 30000` — all tests pass including three new issue-surface regression tests
2. `bun test` — full suite passes
3. `bunx tsc --noEmit` — no type errors
4. Issue-surface idempotency test proves replay reuses existing PR (no executor call, no pulls.create, Existing PR reply)
5. Issue-surface de-dupe test proves concurrent requests are handled without duplicate work
6. Issue-surface rate limit test proves rapid requests get a single clear retry-later message
</verification>

<success_criteria>
- Replaying the same issue apply:/change: trigger results in deterministic branch reuse and existing-PR reuse
- Concurrent in-flight issue write requests are de-duped with a clear single response
- Rate-limited issue write requests get a clear retry-later message without thrashing
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/63-intent-gate-idempotency-foundations/63-02-SUMMARY.md`
</output>
