---
phase: 57-analysis-layer
plan: "02"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/learning/retrieval-recency.ts
  - src/learning/retrieval-recency.test.ts
autonomous: true

must_haves:
  truths:
    - "Results from the last 30 days score higher (lower adjustedDistance) than equivalent results from 6+ months ago"
    - "CRITICAL/MAJOR findings have a severity-aware decay floor of 0.3 minimum multiplier"
    - "Non-critical findings have a lower floor (0.15) allowing more aggressive decay"
    - "Unknown-age results (missing createdAt) are treated as recent, not penalized"
    - "Output is re-sorted by adjustedDistance after weighting"
  artifacts:
    - path: "src/learning/retrieval-recency.ts"
      provides: "Post-rerank recency weighting for retrieval results"
      exports: ["applyRecencyWeighting", "RecencyConfig", "DEFAULT_RECENCY_CONFIG"]
    - path: "src/learning/retrieval-recency.test.ts"
      provides: "Unit tests for recency weighting"
      contains: "applyRecencyWeighting"
  key_links:
    - from: "src/learning/retrieval-recency.ts"
      to: "src/learning/retrieval-rerank.ts"
      via: "imports RerankedResult type"
      pattern: "import.*RerankedResult.*retrieval-rerank"
---

<objective>
Create the retrieval recency weighting module that chains after language-aware reranking.

Purpose: Implements RET-04 -- recent learning memories score higher than stale ones, with a severity-aware decay floor that prevents CRITICAL/MAJOR findings from being forgotten. This is a pure function that takes RerankedResult[] (from rerankByLanguage) and returns RerankedResult[] with adjusted distances.

Output: New module with tests in src/learning/
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/57-analysis-layer/57-RESEARCH.md
@src/learning/retrieval-rerank.ts
@src/learning/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create retrieval recency weighting module</name>
  <files>src/learning/retrieval-recency.ts, src/learning/retrieval-recency.test.ts</files>
  <action>
Create `src/learning/retrieval-recency.ts` with:

1. Types:
   - `RecencyConfig`: `halfLifeDays: number`, `floorMultiplier: number`, `floorSeverities: string[]`
   - Export `DEFAULT_RECENCY_CONFIG`: halfLifeDays=90, floorMultiplier=0.3, floorSeverities=["critical", "major"]

2. Export `applyRecencyWeighting(params)` accepting: `results: RerankedResult[]`, `now?: Date`, `config?: RecencyConfig`.

3. Logic:
   - Compute lambda = ln(2) / halfLifeDays.
   - For each result, compute ageDays from `r.record.createdAt` (string ISO date in the learning_memories table). If createdAt is missing/null, treat as age=0 (recent, no penalty).
   - Raw multiplier = exp(-lambda * ageDays). This gives ~1.0 for 0 days, ~0.79 for 30 days, ~0.5 for 90 days, ~0.25 for 180 days.
   - Apply severity-aware floor: if severity is in floorSeverities, floor = floorMultiplier (0.3). Otherwise, floor = floorMultiplier * 0.5 (0.15). Clamp multiplier to floor.
   - Adjust distance: `adjustedDistance = r.adjustedDistance * (2 - multiplier)`. This inverts the multiplier for distance space: multiplier=1.0 -> factor=1.0 (no change), multiplier=0.3 -> factor=1.7 (70% distance penalty for old results).
   - Re-sort by adjustedDistance ascending.
   - Return new array (do not mutate input).

4. Tests in `retrieval-recency.test.ts`:
   - Import `RerankedResult` from `./retrieval-rerank.ts` and `LearningMemoryRecord` from `./types.ts`.
   - Create helper to build mock RerankedResult with given createdAt, severity, adjustedDistance.
   - **Test: recent results score better than old results** -- Two results with same adjustedDistance (0.2), one created 7 days ago, one 200 days ago. After weighting, the recent one should have lower adjustedDistance.
   - **Test: CRITICAL floor at 0.3** -- A CRITICAL result from 365 days ago should have multiplier floored at 0.3, giving adjustedDistance = original * (2 - 0.3) = original * 1.7.
   - **Test: non-critical results have lower floor (0.15)** -- A "suggestion" result from 365 days ago should decay more aggressively (floor 0.15, factor 1.85).
   - **Test: missing createdAt treated as recent** -- Result with no createdAt should get multiplier ~1.0.
   - **Test: output is re-sorted by adjustedDistance** -- Feed results out of order after weighting, verify sorted output.
   - **Test: input array not mutated** -- Verify original array unchanged after call.
  </action>
  <verify>`bun test src/learning/retrieval-recency.test.ts` passes with all tests green</verify>
  <done>applyRecencyWeighting correctly adjusts distances based on memory age, respects severity-aware floors, treats missing createdAt as recent, and re-sorts output</done>
</task>

</tasks>

<verification>
```bash
bun test src/learning/retrieval-recency.test.ts
```
Test suite passes. No regressions:
```bash
bun test
```
</verification>

<success_criteria>
- retrieval-recency.ts exports applyRecencyWeighting with configurable half-life and floor
- 30-day-old results score higher than 180-day-old equivalent results
- CRITICAL/MAJOR findings never decay below 0.3 multiplier
- Missing createdAt is treated as recent (no penalty)
- Chains after rerankByLanguage without modifying that module
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/57-analysis-layer/57-02-SUMMARY.md`
</output>
