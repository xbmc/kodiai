---
phase: 106-historical-corpus-population
plan: 02
type: execute
wave: 2
depends_on: ["106-01"]
files_modified:
  - scripts/backfill-issues.ts
  - .github/workflows/nightly-issue-sync.yml
autonomous: true
requirements:
  - INGEST-06
  - INGEST-07

must_haves:
  truths:
    - "Running `bun scripts/backfill-issues.ts` populates the issue corpus with historical issues and comments"
    - "Running `bun scripts/backfill-issues.ts --sync` fetches only issues updated since last sync"
    - "The --repo flag allows testing on smaller repos before xbmc/xbmc"
    - "Nightly GitHub Action triggers the sync on a cron schedule"
    - "Script prints summary report at end with total issues, comments, failures, duration, API calls"
  artifacts:
    - path: "scripts/backfill-issues.ts"
      provides: "CLI entry point for backfill and nightly sync"
      min_lines: 80
    - path: ".github/workflows/nightly-issue-sync.yml"
      provides: "GitHub Action cron trigger for nightly sync"
      contains: "cron.*3.*\\*.*\\*.*\\*"
  key_links:
    - from: "scripts/backfill-issues.ts"
      to: "src/knowledge/issue-backfill.ts"
      via: "imports backfillIssues and backfillIssueComments"
      pattern: "import.*backfillIssues|import.*backfillIssueComments"
    - from: "scripts/backfill-issues.ts"
      to: "src/knowledge/issue-store.ts"
      via: "createIssueStore for dependency injection"
      pattern: "createIssueStore"
    - from: ".github/workflows/nightly-issue-sync.yml"
      to: "scripts/backfill-issues.ts"
      via: "bun scripts/backfill-issues.ts --sync"
      pattern: "backfill-issues.*--sync"
---

<objective>
Create the CLI script entry point and GitHub Actions nightly sync workflow. The script supports dual-mode: full backfill (default) and incremental sync (--sync flag).

Purpose: Makes the backfill engine from Plan 01 runnable as a CLI script and automatable via GitHub Actions.
Output: scripts/backfill-issues.ts and .github/workflows/nightly-issue-sync.yml.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/106-historical-corpus-population/106-CONTEXT.md
@.planning/phases/106-historical-corpus-population/106-RESEARCH.md
@.planning/phases/106-historical-corpus-population/106-01-SUMMARY.md

@scripts/backfill-review-comments.ts
@src/knowledge/issue-backfill.ts
@src/auth/github-app.ts
@.github/workflows/ci.yml

<interfaces>
<!-- From Plan 01 output (issue-backfill.ts) -->
```typescript
// src/knowledge/issue-backfill.ts
export type IssueBackfillOptions = {
  octokit: Octokit;
  store: IssueStore;
  sql: Sql;
  embeddingProvider: EmbeddingProvider;
  repo: string;  // "owner/repo"
  dryRun?: boolean;
  logger: Logger;
};

export type IssueBackfillResult = {
  totalIssues: number;
  totalComments: number;
  totalEmbeddings: number;
  pagesProcessed: number;
  failedEmbeddings: number;
  durationMs: number;
  resumed: boolean;
};

export function backfillIssues(opts: IssueBackfillOptions): Promise<IssueBackfillResult>;
export function backfillIssueComments(opts: IssueBackfillOptions): Promise<{ totalComments: number; totalChunks: number; failedEmbeddings: number }>;
```

<!-- From existing codebase -->
```typescript
// src/knowledge/issue-store.ts
export function createIssueStore(opts: { sql: Sql; logger: Logger }): IssueStore;

// src/knowledge/embeddings.ts
export function createEmbeddingProvider(opts: { apiKey: string; logger: Logger; model?: string }): EmbeddingProvider;
export function createNoOpEmbeddingProvider(logger: Logger): EmbeddingProvider;

// src/auth/github-app.ts
export function createGitHubApp(...): ...;  // Returns authenticated Octokit
```

<!-- Existing CLI script pattern (backfill-review-comments.ts) -->
```typescript
// Pattern: parseArgs -> validate env -> create deps -> run -> print summary
import { parseArgs } from "node:util";
import pino from "pino";
import { createDbClient } from "../src/db/client.ts";
import { runMigrations } from "../src/db/migrate.ts";
// ... create store, embedding provider, octokit from GitHub App
// ... call backfill function, log result
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: CLI script with dual-mode backfill/sync</name>
  <files>scripts/backfill-issues.ts</files>
  <action>
Follow the `scripts/backfill-review-comments.ts` pattern exactly. Create `scripts/backfill-issues.ts`:

**CLI arguments (via `parseArgs`):**
- `--repo <owner/repo>` -- default "xbmc/xbmc" (per locked decision)
- `--sync` -- boolean, triggers incremental mode instead of full backfill (per locked decision: same script with --sync flag)
- `--dry-run` -- boolean, fetch and log but don't store
- `--help` -- print usage and exit

**Script flow:**
1. Parse args, print help if requested.
2. Validate env vars: DATABASE_URL (required), GITHUB_APP_ID (required), GITHUB_PRIVATE_KEY (required), VOYAGE_API_KEY (optional -- use NoOp embedding provider if missing).
3. Create dependencies:
   - `createDbClient()` from `../src/db/client.ts`
   - `runMigrations(sql)` from `../src/db/migrate.ts` -- ensures migration 015 is applied
   - `createIssueStore({ sql, logger })` from `../src/knowledge/issue-store.ts`
   - `createEmbeddingProvider()` or `createNoOpEmbeddingProvider()` based on VOYAGE_API_KEY
   - `createGitHubApp()` from `../src/auth/github-app.ts` -- get authenticated Octokit
4. If `--sync` mode:
   - Call `backfillIssues({ ...opts })` -- the engine function already uses sync state (`since` parameter) so incremental mode is achieved by having a prior sync state with `lastSyncedAt` set. The engine handles this transparently.
   - Call `backfillIssueComments({ ...opts })` -- same: uses `since` from sync state.
5. If full backfill mode:
   - Same calls as sync, but fresh run (no prior sync state) processes all issues.
6. Print summary report (per locked decision): total issues, total comments embedded, failures skipped, duration, API calls used. Use `logger.info()` with structured JSON.
7. Close DB connection (`sql.end()`).
8. Exit with code 0 on success, 1 on fatal error.

**Important:** The `--sync` flag vs full backfill distinction is primarily about expectation and logging. The engine itself always resumes from sync state if one exists. For `--sync`, log "Starting incremental sync..." and if no sync state exists, warn that no prior backfill was done. For full backfill, log "Starting full backfill..." and if sync state exists with backfillComplete, log "Resuming from previous state...".

Wrap the main flow in try/catch. On error: log the error, close DB, exit(1).
  </action>
  <verify>bun scripts/backfill-issues.ts --help</verify>
  <done>Script prints usage help. Accepts --repo, --sync, --dry-run flags. Imports from issue-backfill.ts and wires all dependencies. Summary report logged at end.</done>
</task>

<task type="auto">
  <name>Task 2: GitHub Actions nightly sync workflow</name>
  <files>.github/workflows/nightly-issue-sync.yml</files>
  <action>
Create `.github/workflows/nightly-issue-sync.yml` following the pattern from 106-RESEARCH.md code example.

```yaml
name: nightly-issue-sync

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:       # Manual trigger for testing

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - name: Run issue sync
        run: bun scripts/backfill-issues.ts --sync
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GITHUB_APP_ID: ${{ secrets.GITHUB_APP_ID }}
          GITHUB_PRIVATE_KEY: ${{ secrets.GITHUB_PRIVATE_KEY }}
          VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
```

Key details:
- `timeout-minutes: 30` -- prevent runaway sync from burning Actions minutes
- `workflow_dispatch` -- allows manual trigger for testing
- `--frozen-lockfile` on bun install for CI reproducibility
- All secrets reference existing GitHub repo secrets (DATABASE_URL, GITHUB_APP_ID, GITHUB_PRIVATE_KEY, VOYAGE_API_KEY)
- Uses `--sync` flag for incremental mode (per locked decision)
  </action>
  <verify>cat .github/workflows/nightly-issue-sync.yml | head -5</verify>
  <done>Workflow file exists with cron schedule at 3 AM UTC, workflow_dispatch trigger, correct env secrets, and --sync flag.</done>
</task>

</tasks>

<verification>
1. `bun scripts/backfill-issues.ts --help` prints usage without errors
2. `.github/workflows/nightly-issue-sync.yml` is valid YAML with cron schedule and --sync flag
3. Script imports backfillIssues and backfillIssueComments from issue-backfill.ts
4. Script validates required env vars before proceeding
</verification>

<success_criteria>
- `bun scripts/backfill-issues.ts --help` runs and prints usage
- Script supports --repo, --sync, --dry-run flags
- Full backfill mode: processes all issues from scratch or resumes from sync state
- Sync mode (--sync): processes only issues updated since last sync
- Summary report printed at end with totals
- GitHub Actions workflow triggers nightly at 3 AM UTC and on manual dispatch
- Workflow passes all required secrets as env vars
</success_criteria>

<output>
After completion, create `.planning/phases/106-historical-corpus-population/106-02-SUMMARY.md`
</output>
