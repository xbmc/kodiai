---
phase: 32-multi-language-context-and-localized-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/diff-analysis.ts
  - src/execution/diff-analysis.test.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
autonomous: true

must_haves:
  truths:
    - "Each changed file in a PR is classified by programming language via extension lookup"
    - "DiffAnalysis result contains a filesByLanguage record grouping files by detected language"
    - "The config schema accepts review.outputLanguage with default 'en'"
    - "Unknown or extensionless files are classified as 'Unknown' and do not break analysis"
  artifacts:
    - path: "src/execution/diff-analysis.ts"
      provides: "EXTENSION_LANGUAGE_MAP, classifyFileLanguage(), classifyLanguages(), filesByLanguage on DiffAnalysis"
      exports: ["classifyFileLanguage", "classifyLanguages"]
      contains: "EXTENSION_LANGUAGE_MAP"
    - path: "src/execution/config.ts"
      provides: "review.outputLanguage field in reviewSchema"
      contains: "outputLanguage"
    - path: "src/execution/diff-analysis.test.ts"
      provides: "Tests for language classification and filesByLanguage in DiffAnalysis"
      contains: "filesByLanguage"
    - path: "src/execution/config.test.ts"
      provides: "Tests for outputLanguage config parsing"
      contains: "outputLanguage"
  key_links:
    - from: "src/execution/diff-analysis.ts"
      to: "DiffAnalysis interface"
      via: "filesByLanguage field populated during analyzeDiff file iteration"
      pattern: "filesByLanguage"
    - from: "src/execution/config.ts"
      to: "reviewSchema"
      via: "outputLanguage z.string().default('en')"
      pattern: "outputLanguage.*default.*en"
---

<objective>
Add programming language classification to diff analysis and outputLanguage to the config schema.

Purpose: Provide the data layer that language-aware prompt guidance (Plan 02) and handler wiring (Plan 03) will consume. Files are classified by extension during the existing `analyzeDiff()` loop, adding zero extra I/O. The config field enables user-controlled prose localization.

Output: Extended `DiffAnalysis` interface with `filesByLanguage`, exported `classifyFileLanguage()` and `classifyLanguages()` utilities, `review.outputLanguage` config field, and tests for all.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-language-context-and-localized-output/32-RESEARCH.md
@src/execution/diff-analysis.ts
@src/execution/diff-analysis.test.ts
@src/execution/config.ts
@src/execution/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extension-to-language map and classify functions to diff-analysis.ts</name>
  <files>src/execution/diff-analysis.ts, src/execution/diff-analysis.test.ts</files>
  <action>
1. Add a `const EXTENSION_LANGUAGE_MAP: Record<string, string>` near the top of `src/execution/diff-analysis.ts` (after the existing constants). Map ~30 extensions to canonical language names:
   - TypeScript: ts, tsx, mts, cts
   - JavaScript: js, jsx, mjs, cjs
   - Python: py, pyw
   - Go: go
   - Rust: rs
   - Java: java
   - Kotlin: kt, kts
   - Swift: swift
   - C#: cs
   - C++: cpp, cc, cxx, hpp, hxx
   - C: c, h (h defaults to C per research decision -- C++ guidance also covers C headers)
   - Ruby: rb
   - PHP: php
   - Scala: scala
   - Shell: sh, bash, zsh
   - SQL: sql
   - Dart: dart
   - Lua: lua
   - Elixir: ex, exs
   - Zig: zig

2. Add and export `classifyFileLanguage(filePath: string): string` -- extracts extension via `filePath.split(".").pop()?.toLowerCase()`, returns `EXTENSION_LANGUAGE_MAP[ext] ?? "Unknown"`.

3. Add and export `classifyLanguages(files: string[]): Record<string, string[]>` -- iterates files, groups by language using `classifyFileLanguage`. Omit `"Unknown"` entries from the returned record (they provide no guidance value).

4. Extend the `DiffAnalysis` interface with `filesByLanguage: Record<string, string[]>`.

5. In the `analyzeDiff()` function, after the existing file classification loop (lines 202-224), call `classifyLanguages(analyzedFiles)` and assign to the result. This runs on the same `analyzedFiles` array -- no extra I/O. Place the call AFTER the category loop so it doesn't interfere with the time budget check. The language classification is a simple map lookup per file (~microseconds for 200 files) so no time budget guard needed.

6. Add tests in `src/execution/diff-analysis.test.ts`:
   - `classifyFileLanguage` returns correct language for known extensions (ts, py, go, rs, java, rb, cpp, c, h, php)
   - `classifyFileLanguage` returns "Unknown" for unrecognized extension
   - `classifyFileLanguage` returns "Unknown" for extensionless file
   - `classifyLanguages` groups files correctly and omits "Unknown"
   - `analyzeDiff` result includes `filesByLanguage` with correct grouping for mixed-language input
   - Empty input returns empty `filesByLanguage: {}`
  </action>
  <verify>
Run `bun test src/execution/diff-analysis.test.ts` -- all tests pass including new language classification tests.
  </verify>
  <done>
`DiffAnalysis` interface has `filesByLanguage: Record<string, string[]>`. `classifyFileLanguage()` and `classifyLanguages()` are exported. `analyzeDiff()` populates `filesByLanguage` from analyzed files. All existing tests still pass. New tests cover known extensions, unknown extensions, extensionless files, grouping, and end-to-end via analyzeDiff.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add review.outputLanguage to config schema with section-fallback support</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
1. In `src/execution/config.ts`, add `outputLanguage: z.string().default("en")` to the `reviewSchema` object definition (after `profile` and before `fileCategories`). This is a free-form string -- no enum validation per research recommendation. LLMs understand both ISO codes ("ja") and full names ("Japanese").

2. Update the `reviewSchema` `.default({...})` call to include `outputLanguage: "en"` in the defaults object.

3. Verify the section-fallback parsing in Pass 2 handles this automatically -- since `outputLanguage` is inside `reviewSchema` and the entire review section is parsed as a unit (line ~391: `reviewSchema.safeParse(obj.review)`), no additional fallback code is needed.

4. Add tests in `src/execution/config.test.ts`:
   - Default config has `review.outputLanguage === "en"`
   - Explicit `review.outputLanguage: "ja"` is preserved after parsing
   - Explicit `review.outputLanguage: "Spanish"` (full name) is preserved
   - Invalid review section falls back to defaults including `outputLanguage: "en"` (existing section-fallback test pattern)
  </action>
  <verify>
Run `bun test src/execution/config.test.ts` -- all tests pass including new outputLanguage tests.
  </verify>
  <done>
`review.outputLanguage` is in the Zod schema with default `"en"`. It appears on the `RepoConfig` type. Section-fallback parsing handles it. Tests confirm default, explicit values, and fallback behavior.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/execution/diff-analysis.test.ts` -- all pass
2. `bun test src/execution/config.test.ts` -- all pass
3. `bun test` (full suite) -- no regressions
4. TypeScript compiles without errors: `bunx tsc --noEmit`
5. `DiffAnalysis` type includes `filesByLanguage` (visible in type output)
6. `RepoConfig` type includes `review.outputLanguage` (visible in type output)
</verification>

<success_criteria>
- `classifyFileLanguage("src/main.py")` returns `"Python"`
- `classifyFileLanguage("README")` returns `"Unknown"`
- `analyzeDiff({changedFiles: ["a.ts", "b.py", "c.go"]}).filesByLanguage` contains TypeScript, Python, Go keys
- Default config has `review.outputLanguage === "en"`
- Setting `review: { outputLanguage: "ja" }` in YAML produces `config.review.outputLanguage === "ja"`
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-language-context-and-localized-output/32-01-SUMMARY.md`
</output>
