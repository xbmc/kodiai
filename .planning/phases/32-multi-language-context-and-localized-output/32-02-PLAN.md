---
phase: 32-multi-language-context-and-localized-output
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Language-specific guidance sections appear in the review prompt for detected programming languages"
    - "Guidance sections preserve the canonical severity/category taxonomy in English"
    - "When outputLanguage is non-English, the prompt instructs the LLM to localize prose while keeping severity labels, category labels, code identifiers, and snippets in English"
    - "When outputLanguage is 'en' or absent, no output language section appears in the prompt"
    - "Language guidance is capped to top 5 languages by file count to prevent prompt bloat"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "buildLanguageGuidanceSection(), buildOutputLanguageSection(), updated buildReviewPrompt context type"
      exports: ["buildLanguageGuidanceSection", "buildOutputLanguageSection"]
      contains: "LANGUAGE_GUIDANCE"
    - path: "src/execution/mention-prompt.ts"
      provides: "outputLanguage parameter on buildMentionPrompt, output language instruction"
      contains: "outputLanguage"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for language guidance and output language prompt sections"
      contains: "buildLanguageGuidanceSection"
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Tests for outputLanguage in mention prompt"
      contains: "outputLanguage"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "buildReviewPrompt context"
      via: "filesByLanguage and outputLanguage optional params"
      pattern: "filesByLanguage.*Record<string.*string\\[\\]>"
    - from: "src/execution/review-prompt.ts"
      to: "LANGUAGE_GUIDANCE data map"
      via: "buildLanguageGuidanceSection reads guidance rules"
      pattern: "LANGUAGE_GUIDANCE\\[lang\\]"
    - from: "src/execution/mention-prompt.ts"
      to: "buildMentionPrompt params"
      via: "outputLanguage optional param"
      pattern: "outputLanguage.*string"
---

<objective>
Add language-specific review guidance and output language localization to the prompt builders.

Purpose: CTX-06 requires the review prompt to inject language-specific coding guidance (Python, Go, Rust, Java, C/C++, Ruby, PHP, Swift) while preserving the canonical severity/category taxonomy. LANG-01 requires a prompt instruction that localizes explanatory prose to the configured language. Both are prompt-level features that do not change control flow.

Output: `buildLanguageGuidanceSection()` and `buildOutputLanguageSection()` helpers in review-prompt.ts, updated `buildReviewPrompt()` context type, outputLanguage support in mention-prompt.ts, and tests for all.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-language-context-and-localized-output/32-RESEARCH.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/execution/mention-prompt.ts
@src/execution/mention-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language guidance and output language section builders to review-prompt.ts</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
1. Add a `const LANGUAGE_GUIDANCE: Record<string, string[]>` data map near the top of `src/execution/review-prompt.ts` (after the existing helper constant definitions). Include guidance for 8 languages:

   - **Python:** (a) mutable default arguments in function signatures, (b) context managers (with statements) for resource handling, (c) bare except clauses -- prefer specific exceptions, (d) type hint consistency when annotations are present.
   - **Go:** (a) unchecked error returns (no `_` discards without justification), (b) goroutine leak risk -- ensure channels closed or contexts cancelled, (c) `sync.Mutex` without corresponding `defer Unlock()`, (d) nil pointer dereference on interface assertions without ok check.
   - **Rust:** (a) unnecessary `.unwrap()` on Result/Option, (b) unsafe blocks without safety comments, (c) overly restrictive lifetimes.
   - **Java:** (a) unclosed resources -- verify try-with-resources or explicit close, (b) checked exceptions swallowed silently, (c) mutable shared state without synchronization.
   - **C++:** (a) raw pointer ownership without RAII or smart pointers, (b) missing virtual destructor on base classes, (c) buffer overflow risk in array/pointer arithmetic.
   - **C:** (a) buffer overflow risk from unchecked array indexing or string operations, (b) memory leaks -- malloc without matching free, (c) null pointer dereference before use.
   - **Ruby:** (a) missing safe navigation (`&.`) for nil-prone method chains, (b) open rescue clauses -- prefer specific exception types.
   - **PHP:** (a) SQL injection via string concatenation instead of prepared statements, (b) missing type declarations in function signatures (PHP 8+), (c) unchecked return values from file/network operations.
   - **Swift:** (a) force unwrapping (`!`) without guard/if-let, (b) retain cycles in closures -- missing `[weak self]`.

   Do NOT include TypeScript/JavaScript -- they are already covered by the base review rules.

2. Add and export `buildLanguageGuidanceSection(filesByLanguage: Record<string, string[]>): string`:
   - Filter to languages that have entries in `LANGUAGE_GUIDANCE`.
   - Sort by file count descending (most files first).
   - Cap at top 5 languages to prevent prompt bloat (per research Pitfall 3).
   - Build a section with header `## Language-Specific Guidance`, then for each language: `### {Language} ({N} file(s))` followed by bulleted rules.
   - End with a taxonomy preservation note: "These language-specific rules supplement the severity classification. Use the same CRITICAL/MAJOR/MEDIUM/MINOR severity scale and the same category taxonomy (security, correctness, performance, error-handling, resource-management, concurrency) for all findings regardless of language."
   - Return empty string if no languages have guidance.

3. Add and export `buildOutputLanguageSection(outputLanguage: string): string`:
   - Return empty string if `outputLanguage` is falsy or equals `"en"` (case-insensitive).
   - Otherwise build a section with header `## Output Language` containing:
     - `Write all explanatory prose, finding descriptions, and summary text in {outputLanguage}.`
     - An explicit "MUST remain in English" list: severity labels (CRITICAL/MAJOR/MEDIUM/MINOR), category labels (security, correctness, performance, error-handling, resource-management, concurrency), code identifiers/variable/function/type names, code snippets inside suggestion blocks, file paths, YAML metadata blocks (in enhanced mode).
     - Closing: "Only the human-readable explanation text should be localized."

4. Update the `buildReviewPrompt()` context type to add two optional fields:
   - `filesByLanguage?: Record<string, string[]>`
   - `outputLanguage?: string`

5. In `buildReviewPrompt()`, insert the language guidance section AFTER the retrieval context section and BEFORE the "Reading the code" section (between current lines ~611 and ~614). Call:
   ```
   if (context.filesByLanguage) {
     const langSection = buildLanguageGuidanceSection(context.filesByLanguage);
     if (langSection) lines.push("", langSection);
   }
   ```

6. Insert the output language section AFTER custom instructions at the end (just before the final return). Call:
   ```
   const outputLangSection = buildOutputLanguageSection(context.outputLanguage ?? "en");
   if (outputLangSection) lines.push("", outputLangSection);
   ```
   Place it at the end so it is the last instruction the LLM sees -- recency bias helps compliance.

7. Add tests in `src/execution/review-prompt.test.ts`:
   - `buildLanguageGuidanceSection` returns empty string for empty input
   - `buildLanguageGuidanceSection` returns empty string for languages without guidance (e.g., `{ Unknown: ["file"] }`)
   - `buildLanguageGuidanceSection` includes Python guidance when Python files present
   - `buildLanguageGuidanceSection` caps at 5 languages (provide 6+ languages, verify only 5 appear)
   - `buildLanguageGuidanceSection` sorts by file count (language with most files appears first)
   - `buildLanguageGuidanceSection` includes taxonomy preservation note
   - `buildOutputLanguageSection` returns empty for "en"
   - `buildOutputLanguageSection` returns empty for "EN" (case insensitive)
   - `buildOutputLanguageSection` returns section for "ja" containing "Japanese" is NOT required -- it contains the literal value "ja"
   - `buildOutputLanguageSection` includes severity/category English preservation list
   - `buildReviewPrompt` includes language guidance section when `filesByLanguage` provided
   - `buildReviewPrompt` includes output language section when `outputLanguage` is non-English
   - `buildReviewPrompt` omits both sections when not provided (backward compatible)
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts` -- all tests pass including new language guidance and output language tests.
  </verify>
  <done>
`LANGUAGE_GUIDANCE` data map covers 8+ languages. `buildLanguageGuidanceSection()` and `buildOutputLanguageSection()` are exported and tested. `buildReviewPrompt()` accepts optional `filesByLanguage` and `outputLanguage` and injects the sections at the correct positions. Taxonomy preservation note is present. Language cap at 5 is enforced. All existing tests pass without modification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add outputLanguage support to mention-prompt.ts</name>
  <files>src/execution/mention-prompt.ts, src/execution/mention-prompt.test.ts</files>
  <action>
1. Add an optional `outputLanguage?: string` parameter to `buildMentionPrompt()` params.

2. At the end of the function (before the final `return lines.join("\n")`), add:
   ```
   if (outputLanguage && outputLanguage.toLowerCase() !== "en") {
     lines.push(
       "",
       `Write your response in ${outputLanguage}. Keep code identifiers, snippets, file paths, and technical terms in their original form.`
     );
   }
   ```
   This is simpler than the review version because mentions don't have severity/category taxonomy concerns. Only prose localization matters.

3. Add tests in `src/execution/mention-prompt.test.ts`:
   - Default (no `outputLanguage`) does NOT include language instruction
   - `outputLanguage: "en"` does NOT include language instruction
   - `outputLanguage: "ja"` includes "Write your response in ja" instruction
   - `outputLanguage: "Spanish"` includes "Write your response in Spanish" instruction
  </action>
  <verify>
Run `bun test src/execution/mention-prompt.test.ts` -- all tests pass including new outputLanguage tests.
  </verify>
  <done>
`buildMentionPrompt()` accepts optional `outputLanguage`. When non-English, it appends a localization instruction. When "en" or absent, no instruction is added. Tests confirm all cases.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/execution/review-prompt.test.ts` -- all pass
2. `bun test src/execution/mention-prompt.test.ts` -- all pass
3. `bun test` (full suite) -- no regressions
4. TypeScript compiles without errors: `bunx tsc --noEmit`
5. Verify `LANGUAGE_GUIDANCE` covers: Python, Go, Rust, Java, C++, C, Ruby, PHP, Swift
6. Verify `buildLanguageGuidanceSection` caps at 5 languages
7. Verify `buildOutputLanguageSection("en")` returns empty string
8. Verify `buildOutputLanguageSection("ja")` returns non-empty string with English preservation list
</verification>

<success_criteria>
- `buildLanguageGuidanceSection({ Python: ["a.py", "b.py"], Go: ["c.go"] })` returns a string containing "### Python (2 file(s))" before "### Go (1 file(s))"
- `buildLanguageGuidanceSection({})` returns ""
- `buildOutputLanguageSection("en")` returns ""
- `buildOutputLanguageSection("ja")` contains "CRITICAL" and "MAJOR" in the English preservation list
- `buildMentionPrompt({ ..., outputLanguage: "ja" })` contains "Write your response in ja"
- All existing tests pass without modification
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-language-context-and-localized-output/32-02-SUMMARY.md`
</output>
