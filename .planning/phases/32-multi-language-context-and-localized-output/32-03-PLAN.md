---
phase: 32-multi-language-context-and-localized-output
plan: 03
type: execute
wave: 2
depends_on: ["32-01", "32-02"]
files_modified:
  - src/handlers/review.ts
  - src/handlers/mention.ts
autonomous: true

must_haves:
  truths:
    - "The review handler passes filesByLanguage from DiffAnalysis to buildReviewPrompt"
    - "The review handler passes config.review.outputLanguage to buildReviewPrompt"
    - "The mention handler passes config.review.outputLanguage to buildMentionPrompt"
    - "Existing review and mention flows work unchanged when outputLanguage is default 'en'"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Wiring of filesByLanguage and outputLanguage into buildReviewPrompt call"
      contains: "filesByLanguage"
    - path: "src/handlers/mention.ts"
      provides: "Wiring of outputLanguage into buildMentionPrompt call"
      contains: "outputLanguage"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "buildReviewPrompt({ filesByLanguage: diffAnalysis.filesByLanguage, outputLanguage: config.review.outputLanguage })"
      pattern: "filesByLanguage.*diffAnalysis"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "buildMentionPrompt({ outputLanguage: config.review.outputLanguage })"
      pattern: "outputLanguage.*config\\.review"
---

<objective>
Wire language classification data and output language config into the review and mention handlers.

Purpose: Plan 01 produces `filesByLanguage` on `DiffAnalysis` and `outputLanguage` on config. Plan 02 produces the prompt builders that consume them. This plan connects the data to the builders in the handler layer, completing the end-to-end feature.

Output: Updated `buildReviewPrompt()` call in review.ts with two new fields. Updated `buildMentionPrompt()` call in mention.ts with one new field.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-multi-language-context-and-localized-output/32-RESEARCH.md
@.planning/phases/32-multi-language-context-and-localized-output/32-01-SUMMARY.md
@.planning/phases/32-multi-language-context-and-localized-output/32-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire filesByLanguage and outputLanguage into review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
1. In `src/handlers/review.ts`, locate the `buildReviewPrompt()` call (~line 1185). It currently passes `diffAnalysis` as a single object. The `DiffAnalysis` result already contains `filesByLanguage` (added in Plan 01), and `buildReviewPrompt` now accepts it as an optional field (Plan 02).

2. Add two new fields to the `buildReviewPrompt()` call:
   ```
   filesByLanguage: diffAnalysis?.filesByLanguage,
   outputLanguage: config.review.outputLanguage,
   ```
   Place them after the existing `retrievalContext` field for logical grouping with other enrichment data.

3. This is a two-line addition. No structural changes. `filesByLanguage` comes from `diffAnalysis` which is already computed and in scope. `outputLanguage` comes from `config.review.outputLanguage` which defaults to `"en"` (no-op in the prompt builder).

4. Add a log field to the existing diff-analysis gate log entry (~line 1170) to record the detected language distribution:
   ```
   detectedLanguages: Object.keys(diffAnalysis.filesByLanguage ?? {}).length,
   ```
   This gives operators visibility into language classification without logging the full map.
  </action>
  <verify>
Run `bun test` -- all tests pass. TypeScript compiles: `bunx tsc --noEmit`. Manually verify the wiring by reading the modified call site.
  </verify>
  <done>
`buildReviewPrompt()` call in review.ts passes `filesByLanguage` from `diffAnalysis` and `outputLanguage` from config. Log entry includes `detectedLanguages` count. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire outputLanguage into mention handler</name>
  <files>src/handlers/mention.ts</files>
  <action>
1. In `src/handlers/mention.ts`, locate the `buildMentionPrompt()` call (~line 656). It currently passes `mention`, `mentionContext`, `userQuestion`, and `customInstructions`.

2. Add one new field:
   ```
   outputLanguage: config.review.outputLanguage,
   ```
   Note: `outputLanguage` lives under `review` in the config schema (not under `mention`) because it controls LLM prose output globally. The mention handler already loads the full config via `loadRepoConfig()` at line ~323, so `config.review.outputLanguage` is accessible.

3. This is a one-line addition. When `outputLanguage` is `"en"` (default), the mention prompt builder produces no additional instruction -- fully backward compatible.
  </action>
  <verify>
Run `bun test` -- all tests pass. TypeScript compiles: `bunx tsc --noEmit`. Manually verify the wiring by reading the modified call site.
  </verify>
  <done>
`buildMentionPrompt()` call in mention.ts passes `outputLanguage` from `config.review.outputLanguage`. Default "en" produces no change in output. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `bun test` (full suite) -- no regressions
2. `bunx tsc --noEmit` -- TypeScript compiles cleanly
3. Review handler passes `filesByLanguage` and `outputLanguage` to prompt builder
4. Mention handler passes `outputLanguage` to prompt builder
5. Both handlers are backward compatible (defaults produce no change in output)
6. Log entry includes `detectedLanguages` count
</verification>

<success_criteria>
- `buildReviewPrompt()` call includes `filesByLanguage: diffAnalysis?.filesByLanguage`
- `buildReviewPrompt()` call includes `outputLanguage: config.review.outputLanguage`
- `buildMentionPrompt()` call includes `outputLanguage: config.review.outputLanguage`
- All existing tests pass without modification
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/32-multi-language-context-and-localized-output/32-03-SUMMARY.md`
</output>
