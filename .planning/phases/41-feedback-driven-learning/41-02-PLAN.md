---
phase: 41-feedback-driven-learning
plan: 02
type: tdd
wave: 2
depends_on: ["41-01"]
files_modified:
  - src/feedback/aggregator.ts
  - src/feedback/aggregator.test.ts
  - src/feedback/safety-guard.ts
  - src/feedback/safety-guard.test.ts
  - src/feedback/confidence-adjuster.ts
  - src/feedback/confidence-adjuster.test.ts
  - src/feedback/index.ts
autonomous: true

must_haves:
  truths:
    - "evaluateFeedbackSuppressions returns fingerprints exceeding threshold (3+ thumbsDown, 3+ distinctReactors, 2+ distinctPRs)"
    - "Patterns with insufficient thumbsDown, insufficient distinct reactors, or insufficient distinct PRs are NOT in the suppression set"
    - "CRITICAL-severity patterns are never included in suppression set regardless of feedback volume"
    - "MAJOR security/correctness patterns are never included in suppression set regardless of feedback volume"
    - "MAJOR style/performance/documentation patterns CAN be suppressed (not safety-protected)"
    - "Confidence adjustment adds +10 per thumbs-up and subtracts -20 per thumbs-down, clamped to [0, 100]"
    - "evaluateFeedbackSuppressions early-returns empty result when config.enabled is false"
  artifacts:
    - path: "src/feedback/aggregator.ts"
      provides: "aggregateSuppressiblePatterns() filtering by thresholds"
      exports: ["aggregateSuppressiblePatterns"]
    - path: "src/feedback/safety-guard.ts"
      provides: "isFeedbackSuppressionProtected() safety floor check"
      exports: ["isFeedbackSuppressionProtected"]
    - path: "src/feedback/confidence-adjuster.ts"
      provides: "adjustConfidenceForFeedback() score modifier"
      exports: ["adjustConfidenceForFeedback"]
    - path: "src/feedback/index.ts"
      provides: "evaluateFeedbackSuppressions() orchestrator and barrel exports"
      exports: ["evaluateFeedbackSuppressions"]
  key_links:
    - from: "src/feedback/aggregator.ts"
      to: "src/knowledge/types.ts"
      via: "KnowledgeStore.aggregateFeedbackPatterns() call"
      pattern: "aggregateFeedbackPatterns"
    - from: "src/feedback/safety-guard.ts"
      to: "src/knowledge/types.ts"
      via: "Uses FindingSeverity and FindingCategory type unions"
      pattern: "FindingSeverity.*FindingCategory"
    - from: "src/feedback/index.ts"
      to: "src/feedback/aggregator.ts"
      via: "Calls aggregateSuppressiblePatterns then filters by safety guard"
      pattern: "aggregateSuppressiblePatterns.*isFeedbackSuppressionProtected"
---

<objective>
Build the feedback aggregator, safety guard, confidence adjuster, and barrel export using TDD.

Purpose: Create the core business logic that decides which finding patterns to auto-suppress based on feedback, with safety floors preventing suppression of critical/security findings.
Output: Tested pure-function modules in `src/feedback/` with a public `evaluateFeedbackSuppressions()` orchestrator.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-feedback-driven-learning/41-RESEARCH.md
@.planning/phases/41-feedback-driven-learning/41-01-SUMMARY.md

@src/feedback/types.ts
@src/knowledge/types.ts
@src/knowledge/confidence.ts
@src/enforcement/severity-floors.ts (for severityRank pattern reference)
</context>

<feature>
  <name>Feedback suppression evaluation (aggregator + safety guard + confidence adjuster + barrel)</name>
  <files>src/feedback/aggregator.ts, src/feedback/aggregator.test.ts, src/feedback/safety-guard.ts, src/feedback/safety-guard.test.ts, src/feedback/confidence-adjuster.ts, src/feedback/confidence-adjuster.test.ts, src/feedback/index.ts</files>
  <behavior>
**aggregateSuppressiblePatterns(store, repo, thresholds) -> FeedbackPattern[]**
- Calls store.aggregateFeedbackPatterns(repo) to get all patterns with any thumbs-down
- Filters to only patterns meeting ALL threshold criteria:
  - thumbsDownCount >= thresholds.minThumbsDown (default 3)
  - distinctReactors >= thresholds.minDistinctReactors (default 3)
  - distinctPRs >= thresholds.minDistinctPRs (default 2)
- Returns filtered FeedbackPattern[] (suppression candidates before safety guard)

Test cases:
- Pattern with 5 thumbsDown, 4 reactors, 3 PRs -> included
- Pattern with 2 thumbsDown (below threshold) -> excluded
- Pattern with 3 thumbsDown but only 1 reactor -> excluded
- Pattern with 3 thumbsDown, 3 reactors, but only 1 PR -> excluded
- Pattern exactly at thresholds (3, 3, 2) -> included
- Empty store returns empty array
- Custom thresholds respected (e.g., minThumbsDown=5)

**isFeedbackSuppressionProtected(finding: { severity, category }) -> boolean**
- Returns true (protected from suppression) if:
  - severity === "critical" (FEED-04: CRITICAL never auto-suppressed)
  - severity === "major" AND (category === "security" OR category === "correctness") (FEED-05)
- Returns false for all other combinations (major+style, major+performance, major+documentation, medium/minor anything)

Test cases:
- { severity: "critical", category: "security" } -> true
- { severity: "critical", category: "style" } -> true (all critical protected)
- { severity: "major", category: "security" } -> true
- { severity: "major", category: "correctness" } -> true
- { severity: "major", category: "style" } -> false (major non-safety is NOT protected)
- { severity: "major", category: "performance" } -> false
- { severity: "major", category: "documentation" } -> false
- { severity: "medium", category: "security" } -> false (only critical/major protected)
- { severity: "minor", category: "correctness" } -> false

**adjustConfidenceForFeedback(baseConfidence, { thumbsUp, thumbsDown }) -> number**
- Formula: baseConfidence + (thumbsUp * 10) - (thumbsDown * 20)
- Clamped to [0, 100]

Test cases:
- (50, { thumbsUp: 0, thumbsDown: 0 }) -> 50 (no change)
- (50, { thumbsUp: 3, thumbsDown: 0 }) -> 80 (+30)
- (50, { thumbsUp: 0, thumbsDown: 3 }) -> 0 (clamped, 50-60=-10->0)
- (80, { thumbsUp: 0, thumbsDown: 1 }) -> 60 (-20)
- (90, { thumbsUp: 2, thumbsDown: 0 }) -> 100 (clamped at 100)
- (30, { thumbsUp: 1, thumbsDown: 1 }) -> 20 (+10-20=-10, 30-10=20)
- (5, { thumbsUp: 0, thumbsDown: 1 }) -> 0 (clamped at 0)

**evaluateFeedbackSuppressions(params: { store, repo, config }) -> FeedbackSuppressionResult**
- If config.enabled is false, return { suppressedFingerprints: new Set(), suppressedPatternCount: 0, patterns: [] }
- Call aggregateSuppressiblePatterns to get candidates
- Filter out patterns where isFeedbackSuppressionProtected returns true
- Return FeedbackSuppressionResult with suppressedFingerprints set, count, and patterns
- Wrap in try/catch: on error, log warning and return empty result (fail-open)
  </behavior>
  <implementation>
**src/feedback/aggregator.ts**: Pure function. Takes KnowledgeStore and thresholds, calls store.aggregateFeedbackPatterns, filters by threshold. Import FeedbackPattern and FeedbackThresholds from types.ts. Import KnowledgeStore from knowledge/types.ts.

**src/feedback/safety-guard.ts**: Pure function. Takes { severity, category }, returns boolean. Import FindingSeverity, FindingCategory from knowledge/types.ts. No external dependencies.

**src/feedback/confidence-adjuster.ts**: Pure function. Takes baseConfidence number and { thumbsUp, thumbsDown }, returns clamped number. No imports needed beyond basic types.

**src/feedback/index.ts**: Barrel export. Re-exports all types from types.ts. Re-exports aggregateSuppressiblePatterns, isFeedbackSuppressionProtected, adjustConfidenceForFeedback. Exports evaluateFeedbackSuppressions orchestrator function that:
1. Early returns empty result if !config.enabled
2. Calls aggregateSuppressiblePatterns
3. Filters by !isFeedbackSuppressionProtected for each pattern
4. Builds Set of fingerprints
5. Returns FeedbackSuppressionResult
6. Catch block returns empty result + logs warning (requires logger param)

Import pino Logger type for the logger parameter.
  </implementation>
</feature>

<verification>
- `bun test src/feedback/` runs all feedback tests and passes
- `bun test` all existing tests still pass (578+)
- `bun run --bun tsc --noEmit` compiles without errors
- Tests cover: threshold inclusion/exclusion, safety guard for all severity/category combos, confidence clamping, orchestrator early-return when disabled
</verification>

<success_criteria>
All feedback business logic is implemented and tested. evaluateFeedbackSuppressions correctly aggregates patterns, applies safety guard, and returns suppression set. Safety floors prevent CRITICAL and MAJOR security/correctness from being suppressed. Confidence adjustment follows +10/-20 formula with [0,100] clamping.
</success_criteria>

<output>
After completion, create `.planning/phases/41-feedback-driven-learning/41-02-SUMMARY.md`
</output>
