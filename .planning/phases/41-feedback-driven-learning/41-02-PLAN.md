---
phase: 41-feedback-driven-learning
plan: 02
type: tdd
wave: 2
depends_on: ["41-01"]
files_modified:
  - src/feedback/aggregator.ts
  - src/feedback/aggregator.test.ts
  - src/feedback/safety-guard.ts
  - src/feedback/safety-guard.test.ts
  - src/feedback/confidence-adjuster.ts
  - src/feedback/confidence-adjuster.test.ts
  - src/feedback/index.ts
autonomous: true

must_haves:
  truths:
    - "evaluateFeedbackSuppressions returns fingerprints exceeding threshold (3+ thumbsDown, 3+ distinctReactors, 2+ distinctPRs)"
    - "Patterns with insufficient thumbsDown, insufficient distinct reactors, or insufficient distinct PRs are NOT in the suppression set"
    - "CRITICAL-severity patterns are never included in suppression set regardless of feedback volume"
    - "MAJOR security/correctness patterns are never included in suppression set regardless of feedback volume"
    - "MAJOR style/performance/documentation patterns CAN be suppressed (not safety-protected)"
    - "Confidence adjustment adds +10 per thumbs-up and subtracts -20 per thumbs-down, clamped to [0, 100]"
    - "evaluateFeedbackSuppressions early-returns empty result when config.enabled is false"
  artifacts:
    - path: "src/feedback/aggregator.ts"
      provides: "aggregateSuppressiblePatterns() filtering by thresholds"
      exports: ["aggregateSuppressiblePatterns"]
    - path: "src/feedback/safety-guard.ts"
      provides: "isFeedbackSuppressionProtected() safety floor check"
      exports: ["isFeedbackSuppressionProtected"]
    - path: "src/feedback/confidence-adjuster.ts"
      provides: "adjustConfidenceForFeedback() score modifier"
      exports: ["adjustConfidenceForFeedback"]
    - path: "src/feedback/index.ts"
      provides: "evaluateFeedbackSuppressions() orchestrator and barrel exports"
      exports: ["evaluateFeedbackSuppressions"]
  key_links:
    - from: "src/feedback/aggregator.ts"
      to: "src/knowledge/types.ts"
      via: "KnowledgeStore.aggregateFeedbackPatterns() call"
      pattern: "aggregateFeedbackPatterns"
    - from: "src/feedback/safety-guard.ts"
      to: "src/knowledge/types.ts"
      via: "Uses FindingSeverity and FindingCategory type unions"
      pattern: "FindingSeverity.*FindingCategory"
    - from: "src/feedback/index.ts"
      to: "src/feedback/aggregator.ts"
      via: "Calls aggregateSuppressiblePatterns then filters by safety guard"
      pattern: "aggregateSuppressiblePatterns.*isFeedbackSuppressionProtected"
---

<objective>
Build the feedback aggregator, safety guard, confidence adjuster, and barrel export using TDD.

Purpose: Create the core business logic that decides which finding patterns to auto-suppress based on feedback, with safety floors preventing suppression of critical/security findings.
Output: Tested pure-function modules in `src/feedback/` with a public `evaluateFeedbackSuppressions()` orchestrator.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-feedback-driven-learning/41-RESEARCH.md
@.planning/phases/41-feedback-driven-learning/41-01-SUMMARY.md

@src/feedback/types.ts
@src/knowledge/types.ts
@src/knowledge/confidence.ts
@src/enforcement/severity-floors.ts (for severityRank pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD aggregator and safety guard</name>
  <files>src/feedback/aggregator.ts, src/feedback/aggregator.test.ts, src/feedback/safety-guard.ts, src/feedback/safety-guard.test.ts</files>
  <action>
**RED phase -- write failing tests first:**

Create `src/feedback/aggregator.test.ts` with tests for `aggregateSuppressiblePatterns(store, repo, thresholds) -> FeedbackPattern[]`:
- Calls store.aggregateFeedbackPatterns(repo) to get all patterns with any thumbs-down
- Filters to only patterns meeting ALL threshold criteria:
  - thumbsDownCount >= thresholds.minThumbsDown (default 3)
  - distinctReactors >= thresholds.minDistinctReactors (default 3)
  - distinctPRs >= thresholds.minDistinctPRs (default 2)
- Returns filtered FeedbackPattern[] (suppression candidates before safety guard)

Test cases:
- Pattern with 5 thumbsDown, 4 reactors, 3 PRs -> included
- Pattern with 2 thumbsDown (below threshold) -> excluded
- Pattern with 3 thumbsDown but only 1 reactor -> excluded
- Pattern with 3 thumbsDown, 3 reactors, but only 1 PR -> excluded
- Pattern exactly at thresholds (3, 3, 2) -> included
- Empty store returns empty array
- Custom thresholds respected (e.g., minThumbsDown=5)

Mock the KnowledgeStore with a stub aggregateFeedbackPatterns that returns controlled FeedbackPattern[] arrays. Import FeedbackPattern and FeedbackThresholds from `../feedback/types.ts`.

Create `src/feedback/safety-guard.test.ts` with tests for `isFeedbackSuppressionProtected(finding: { severity, category }) -> boolean`:
- Returns true (protected from suppression) if:
  - severity === "critical" (FEED-04: CRITICAL never auto-suppressed)
  - severity === "major" AND (category === "security" OR category === "correctness") (FEED-05)
- Returns false for all other combinations

Test cases:
- { severity: "critical", category: "security" } -> true
- { severity: "critical", category: "style" } -> true (all critical protected)
- { severity: "major", category: "security" } -> true
- { severity: "major", category: "correctness" } -> true
- { severity: "major", category: "style" } -> false (major non-safety is NOT protected)
- { severity: "major", category: "performance" } -> false
- { severity: "major", category: "documentation" } -> false
- { severity: "medium", category: "security" } -> false (only critical/major protected)
- { severity: "minor", category: "correctness" } -> false

Run tests -- they MUST fail (RED). Commit: `test(41-02): add failing tests for aggregator and safety guard`

**GREEN phase -- implement to pass tests:**

Create `src/feedback/aggregator.ts`: Pure function. Takes KnowledgeStore and thresholds, calls store.aggregateFeedbackPatterns, filters by threshold. Import FeedbackPattern and FeedbackThresholds from types.ts. Import KnowledgeStore from knowledge/types.ts.

Create `src/feedback/safety-guard.ts`: Pure function. Takes { severity, category }, returns boolean. Import FindingSeverity, FindingCategory from knowledge/types.ts. No external dependencies.

Run tests -- they MUST pass (GREEN). Commit: `feat(41-02): implement aggregator and safety guard`

**REFACTOR phase (if needed):** Clean up, run tests, confirm still green.
  </action>
  <verify>
`bun test src/feedback/aggregator.test.ts` passes all 7+ test cases.
`bun test src/feedback/safety-guard.test.ts` passes all 9+ test cases.
`bun run --bun tsc --noEmit` compiles without errors.
  </verify>
  <done>
aggregateSuppressiblePatterns filters patterns by all three thresholds (minThumbsDown, minDistinctReactors, minDistinctPRs). isFeedbackSuppressionProtected returns true for CRITICAL (any category) and MAJOR security/correctness, false for everything else. All test cases green.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD confidence adjuster and barrel orchestrator</name>
  <files>src/feedback/confidence-adjuster.ts, src/feedback/confidence-adjuster.test.ts, src/feedback/index.ts</files>
  <action>
**RED phase -- write failing tests first:**

Create `src/feedback/confidence-adjuster.test.ts` with tests for `adjustConfidenceForFeedback(baseConfidence, { thumbsUp, thumbsDown }) -> number`:
- Formula: baseConfidence + (thumbsUp * 10) - (thumbsDown * 20)
- Clamped to [0, 100]

Test cases:
- (50, { thumbsUp: 0, thumbsDown: 0 }) -> 50 (no change)
- (50, { thumbsUp: 3, thumbsDown: 0 }) -> 80 (+30)
- (50, { thumbsUp: 0, thumbsDown: 3 }) -> 0 (clamped, 50-60=-10->0)
- (80, { thumbsUp: 0, thumbsDown: 1 }) -> 60 (-20)
- (90, { thumbsUp: 2, thumbsDown: 0 }) -> 100 (clamped at 100)
- (30, { thumbsUp: 1, thumbsDown: 1 }) -> 20 (+10-20=-10, 30-10=20)
- (5, { thumbsUp: 0, thumbsDown: 1 }) -> 0 (clamped at 0)

Add tests for `evaluateFeedbackSuppressions` to the confidence-adjuster test file (or a separate index test). These verify the orchestrator in `src/feedback/index.ts`:
- If config.enabled is false, returns empty result (suppressedFingerprints empty Set, suppressedPatternCount 0, patterns []) -- no store calls made
- Calls aggregateSuppressiblePatterns, then filters out patterns where isFeedbackSuppressionProtected returns true
- Returns FeedbackSuppressionResult with suppressedFingerprints set, count, and filtered patterns
- On error (store throws), logs warning and returns empty result (fail-open)

Mock the store and use test patterns that include a mix of protected (CRITICAL) and non-protected (MEDIUM/style) patterns to verify the safety guard filter.

Run tests -- they MUST fail (RED). Commit: `test(41-02): add failing tests for confidence adjuster and orchestrator`

**GREEN phase -- implement to pass tests:**

Create `src/feedback/confidence-adjuster.ts`: Pure function. Takes baseConfidence number and { thumbsUp, thumbsDown }, returns `Math.max(0, Math.min(100, baseConfidence + (thumbsUp * 10) - (thumbsDown * 20)))`. No imports needed beyond basic types.

Create `src/feedback/index.ts`: Barrel export that:
1. Re-exports all types from types.ts
2. Re-exports aggregateSuppressiblePatterns, isFeedbackSuppressionProtected, adjustConfidenceForFeedback
3. Exports evaluateFeedbackSuppressions orchestrator function that:
   - Early returns empty result if !config.enabled
   - Calls aggregateSuppressiblePatterns to get candidates
   - Filters candidates by !isFeedbackSuppressionProtected for each pattern
   - Builds Set of fingerprints from remaining patterns
   - Returns FeedbackSuppressionResult
   - Wraps in try/catch: on error, logs warning via logger param and returns empty result (fail-open)
   - Import pino Logger type for the logger parameter

Run tests -- they MUST pass (GREEN). Commit: `feat(41-02): implement confidence adjuster and orchestrator`

**REFACTOR phase (if needed):** Clean up, run tests, confirm still green.
  </action>
  <verify>
`bun test src/feedback/confidence-adjuster.test.ts` passes all 7+ test cases.
`bun test src/feedback/` runs all feedback tests and passes.
`bun run --bun tsc --noEmit` compiles without errors.
`bun test` all existing tests still pass (578+).
  </verify>
  <done>
adjustConfidenceForFeedback applies +10/-20 formula with [0,100] clamping. evaluateFeedbackSuppressions early-returns empty when config.enabled is false, aggregates + safety-filters patterns, returns suppression set, and is fail-open on errors. All feedback module exports available from src/feedback/index.ts.
  </done>
</task>

</tasks>

<verification>
- `bun test src/feedback/` runs all feedback tests and passes
- `bun test` all existing tests still pass (578+)
- `bun run --bun tsc --noEmit` compiles without errors
- Tests cover: threshold inclusion/exclusion, safety guard for all severity/category combos, confidence clamping, orchestrator early-return when disabled
</verification>

<success_criteria>
All feedback business logic is implemented and tested. evaluateFeedbackSuppressions correctly aggregates patterns, applies safety guard, and returns suppression set. Safety floors prevent CRITICAL and MAJOR security/correctness from being suppressed. Confidence adjustment follows +10/-20 formula with [0,100] clamping.
</success_criteria>

<output>
After completion, create `.planning/phases/41-feedback-driven-learning/41-02-SUMMARY.md`
</output>
