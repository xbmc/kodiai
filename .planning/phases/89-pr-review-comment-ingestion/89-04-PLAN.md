---
phase: 89-pr-review-comment-ingestion
plan: 04
type: execute
wave: 3
depends_on: [89-01, 89-02, 89-03]
files_modified:
  - src/knowledge/retrieval.ts
  - src/knowledge/retrieval.test.ts
  - src/knowledge/review-comment-retrieval.ts
  - src/knowledge/review-comment-retrieval.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/knowledge/index.ts
  - src/index.ts
  - src/handlers/review.ts
autonomous: true
requirements: [KI-05, KI-06]

must_haves:
  truths:
    - "Review comment corpus is searchable via the existing createRetriever() pipeline"
    - "Retrieval results from review comments include source attribution metadata (PR number, author, file)"
    - "Bot cites human review precedents inline with format: reviewers have previously flagged this pattern (PR #1234, @author)"
    - "Only strong matches are cited — low-similarity results are silently dropped"
    - "Review comment retrieval is fail-open: errors degrade gracefully without blocking review"
  artifacts:
    - path: "src/knowledge/review-comment-retrieval.ts"
      provides: "Review comment search function that integrates with existing retrieval pipeline"
      contains: "searchReviewComments"
    - path: "src/knowledge/retrieval.ts"
      provides: "Updated retriever that fans out to review comment corpus alongside learning memories"
      contains: "reviewCommentStore"
    - path: "src/execution/review-prompt.ts"
      provides: "Updated prompt builder that formats review comment citations as inline precedents"
      contains: "Review Precedents"
    - path: "src/knowledge/index.ts"
      provides: "Updated barrel exports with review comment retrieval"
      contains: "searchReviewComments"
  key_links:
    - from: "src/knowledge/retrieval.ts"
      to: "src/knowledge/review-comment-retrieval.ts"
      via: "Retriever calls searchReviewComments() in parallel with learning memory retrieval"
      pattern: "searchReviewComments|reviewComment"
    - from: "src/execution/review-prompt.ts"
      to: "src/knowledge/retrieval.ts"
      via: "Prompt builder receives review comment results and formats as inline citations"
      pattern: "reviewPrecedents|Review Precedents"
    - from: "src/knowledge/review-comment-retrieval.ts"
      to: "src/knowledge/review-comment-store.ts"
      via: "Search function uses store's searchByEmbedding method"
      pattern: "searchByEmbedding|ReviewCommentStore"
---

<objective>
Wire the review comment corpus into the existing retrieval pipeline and add inline citation formatting so the bot can cite human review precedents in its responses.

Purpose: Make 18 months of human review patterns actionable — the bot should surface "reviewers have historically flagged this pattern" evidence when reviewing new PRs.
Output: Updated retrieval pipeline with review comment fan-out, and prompt builder with citation formatting.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/89-pr-review-comment-ingestion/89-01-SUMMARY.md
@.planning/phases/89-pr-review-comment-ingestion/89-02-SUMMARY.md
@.planning/phases/89-pr-review-comment-ingestion/89-03-SUMMARY.md
@src/knowledge/retrieval.ts
@src/knowledge/retrieval.test.ts
@src/knowledge/isolation.ts
@src/knowledge/multi-query-retrieval.ts
@src/knowledge/types.ts
@src/knowledge/review-comment-store.ts
@src/knowledge/review-comment-types.ts
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review comment retrieval module and integrate into retriever pipeline</name>
  <files>src/knowledge/review-comment-retrieval.ts, src/knowledge/review-comment-retrieval.test.ts, src/knowledge/retrieval.ts, src/knowledge/retrieval.test.ts, src/knowledge/index.ts</files>
  <action>
**Review comment retrieval module (`review-comment-retrieval.ts`):**

Create a focused search function that queries the review comment vector store:

```typescript
export type ReviewCommentMatch = {
  chunkText: string;
  distance: number;
  repo: string;
  prNumber: number;
  prTitle: string | null;
  filePath: string | null;
  authorLogin: string;
  authorAssociation: string | null;
  githubCreatedAt: string;
  startLine: number | null;
  endLine: number | null;
  source: "review_comment";   // Source attribution tag
};

export async function searchReviewComments(opts: {
  store: ReviewCommentStore;
  embeddingProvider: EmbeddingProvider;
  query: string;
  repo: string;
  topK: number;
  distanceThreshold?: number;
  logger: Logger;
}): Promise<ReviewCommentMatch[]>
```

Implementation:
1. Generate embedding for query via `embeddingProvider.generate(query, "query")`
2. If embedding is null (fail-open), return empty array
3. Call `store.searchByEmbedding({ queryEmbedding, repo, topK })`
4. Filter results by distance threshold (use Claude's discretion for default — suggest 0.7 cosine distance as initial threshold, can be tuned in Phase 91)
5. Map results to `ReviewCommentMatch` with source attribution

**Integrate into `createRetriever()` in `retrieval.ts`:**

Update the `createRetriever` factory to optionally accept a `reviewCommentStore`:

```typescript
export function createRetriever(deps: {
  embeddingProvider: EmbeddingProvider;
  isolationLayer: IsolationLayer;
  config: RetrieverConfig;
  reviewCommentStore?: ReviewCommentStore;  // NEW optional dep
}): { retrieve: (opts: RetrieveOptions) => Promise<RetrieveResult | null> }
```

Update `RetrieveResult` to include review comment matches:

```typescript
export type RetrieveResult = {
  findings: MergedRetrievalResult[];
  snippetAnchors: SnippetAnchor[];
  reviewPrecedents: ReviewCommentMatch[];  // NEW
  provenance: {
    queryCount: number;
    candidateCount: number;
    sharedPoolUsed: boolean;
    thresholdMethod: string;
    thresholdValue: number;
    reviewCommentCount: number;  // NEW
  };
};
```

In the `retrieve()` function, after the existing variant execution (Step 2), add a parallel fan-out to review comments:

```typescript
// Step 2b: Fan out to review comment corpus (parallel with variant execution)
let reviewPrecedents: ReviewCommentMatch[] = [];
if (deps.reviewCommentStore) {
  try {
    // Use first query (intent variant) for review comment search
    reviewPrecedents = await searchReviewComments({
      store: deps.reviewCommentStore,
      embeddingProvider: deps.embeddingProvider,
      query: opts.queries[0],
      repo: opts.repo,
      topK: 5,  // Separate budget from learning memory topK
      logger: opts.logger,
    });
  } catch (err) {
    opts.logger.warn({ err }, "Review comment retrieval failed (fail-open)");
  }
}
```

This runs alongside the existing learning memory retrieval. Results are independent — they appear in `RetrieveResult.reviewPrecedents` rather than mixed into `findings`. Phase 91 will implement cross-corpus ranking.

Initial weighting: review comment results are independent of learning memory results (per Claude's discretion, with Phase 91 tuning later).

**Update `src/index.ts`** to pass `reviewCommentStore` to `createRetriever()`:

```typescript
const retriever = isolationLayer && embeddingProvider
  ? createRetriever({
      embeddingProvider,
      isolationLayer,
      config: { ... },
      reviewCommentStore,  // NEW
    })
  : undefined;
```

**Update barrel exports** in `src/knowledge/index.ts`:
```typescript
export { searchReviewComments, type ReviewCommentMatch } from "./review-comment-retrieval.ts";
```

**Tests:**

For `review-comment-retrieval.test.ts`:
- Returns matches sorted by distance
- Filters by distance threshold
- Returns empty array when embedding fails (fail-open)
- Returns empty array when store has no results
- Source attribution is always "review_comment"

For `retrieval.test.ts` updates:
- Existing tests continue to pass with `reviewCommentStore` undefined
- New test: when reviewCommentStore provided, results include reviewPrecedents
- New test: review comment search failure does not block learning memory results
  </action>
  <verify>
- `bun test src/knowledge/review-comment-retrieval.test.ts` passes
- `bun test src/knowledge/retrieval.test.ts` passes (existing + new tests)
- `bun test` all tests pass
  </verify>
  <done>
- Review comment corpus is searchable via the retrieval pipeline
- Results include source attribution metadata
- Fail-open: review comment search failures don't block the pipeline
- Existing retrieval behavior unchanged when review comment store is absent
  </done>
</task>

<task type="auto">
  <name>Task 2: Add inline citation formatting to review prompt builder</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
Update the review prompt builder to format review comment matches as inline precedents that the LLM can cite.

**Add a new prompt section: `## Human Review Precedents`**

Place it after the existing `## Similar Prior Findings (Learning Context)` section. Format:

```
## Human Review Precedents

The following are relevant comments from past human code reviews. Reference them when
the current change exhibits a similar pattern. Cite with:
`(reviewers have previously flagged this pattern — PR #1234, @author)`

Only cite when there is a strong match. Do not force citations.

---
- **PR #5678** (@contributor, 2025-08-15) on `src/video/VideoPlayer.cpp:120-145`:
  "This lock ordering can cause deadlocks when called from the rendering thread..."

- **PR #4321** (@maintainer, 2025-06-22) on `xbmc/cores/AudioEngine.cpp`:
  "Prefer RAII wrappers for resource cleanup in this module..."
---
```

**Implementation:**

Add a function `formatReviewPrecedents(matches: ReviewCommentMatch[]): string`:
1. If matches is empty, return empty string (no section at all)
2. Sort by distance (best match first)
3. Limit to top 5 matches
4. For each match, format as a bullet with:
   - PR number and author attribution
   - Date (formatted as YYYY-MM-DD)
   - File path and line range (if available)
   - Truncated chunk text (first 200 chars, ending at word boundary)
5. Wrap in the section header with citation instructions

**Integration point:**

Find where `## Similar Prior Findings (Learning Context)` is assembled in the prompt builder. Add the review precedents section immediately after it. The prompt builder should accept `reviewPrecedents?: ReviewCommentMatch[]` as an optional parameter.

**Update `src/handlers/review.ts`:** Trace the call chain from the review handler to the prompt builder. The review handler already calls `retriever.retrieve()` and passes the result to the prompt builder (e.g., `buildReviewPrompt()`). Update the call site in `src/handlers/review.ts` to pass `result.reviewPrecedents` to `buildReviewPrompt()` so the precedents flow through to the prompt output.

**CRITICAL: Citation quality gate (locked decision: only cite strong matches)**

The distance threshold in `searchReviewComments` already filters weak matches. The prompt instructions reinforce this: "Only cite when there is a strong match. Do not force citations." This is a two-layer guard:
1. Vector search distance threshold filters at retrieval time
2. Prompt instructions tell the LLM to exercise judgment on relevance

**Tests:**

For `review-prompt.test.ts`:
- Empty reviewPrecedents produces no section
- Single match formats correctly with PR number, author, date, file path
- Multiple matches sorted by distance (best first)
- Long chunk text truncated to 200 chars at word boundary
- Matches without file_path show "general review" instead
- Section appears after Learning Context section
- Existing prompt tests continue to pass unchanged
  </action>
  <verify>
- `bun test src/execution/review-prompt.test.ts` passes
- `bun test` all existing tests pass
- No TypeScript compilation errors
  </verify>
  <done>
- Review precedents section appears in prompt when matches exist
- Citation format includes PR number, author, date, file path, and excerpt
- Empty matches produce no section (no noise)
- Prompt instructs LLM to only cite strong matches
- Existing prompt behavior unchanged
  </done>
</task>

</tasks>

<verification>
- Review comment corpus is accessible via `createRetriever().retrieve()` pipeline
- Results include `reviewPrecedents` array with source attribution
- Prompt includes `## Human Review Precedents` section when matches exist
- Citation format: "reviewers have previously flagged this pattern (PR #1234, @author)"
- Fail-open: review comment errors don't block reviews
- All existing tests pass unchanged
</verification>

<success_criteria>
- Bot can cite human review precedents in its review output
- Only strong matches are cited
- Review comment retrieval is fully integrated into the existing pipeline
- Existing retrieval and prompt behavior unchanged when no review comments exist
</success_criteria>

<output>
After completion, create `.planning/phases/89-pr-review-comment-ingestion/89-04-SUMMARY.md`
</output>
