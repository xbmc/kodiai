---
phase: 69-snippet-anchors-prompt-budgeting
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/learning/retrieval-snippets.ts
  - src/learning/retrieval-snippets.test.ts
autonomous: true

must_haves:
  truths:
    - "Retrieved findings can be rendered with concise snippet evidence and `path:line` anchors when matching evidence is found"
    - "Snippet extraction enforces strict per-item and total-size caps so utility output stays prompt-safe"
    - "Snippet extraction failures never throw into callers; utility degrades to path-only anchors"
  artifacts:
    - path: "src/learning/retrieval-snippets.ts"
      provides: "Deterministic snippet-anchor extraction and retrieval-context budget trimming utilities"
      exports: ["buildSnippetAnchors", "trimSnippetAnchorsToBudget", "SnippetAnchor"]
    - path: "src/learning/retrieval-snippets.test.ts"
      provides: "RED->GREEN regression suite for anchor formatting, budget trimming order, and fail-open fallback"
      min_lines: 120
  key_links:
    - from: "src/learning/retrieval-snippets.test.ts"
      to: "src/learning/retrieval-snippets.ts"
      via: "tests import and validate snippet extraction + budget trimming behavior"
      pattern: "buildSnippetAnchors|trimSnippetAnchorsToBudget"
---

<objective>
Build the RET-08 utility core with TDD: snippet-anchor extraction plus deterministic budget trimming.

Purpose: Phase 69 needs reusable logic that can run in both review and mention flows to produce actionable evidence (`path:line` + snippet) without overflowing prompt budgets.
Output: `src/learning/retrieval-snippets.ts` and `src/learning/retrieval-snippets.test.ts` with RED->GREEN coverage for anchor extraction, budget enforcement, and fail-open behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-multi-query-retrieval-core/68-01-SUMMARY.md
@.planning/phases/68-multi-query-retrieval-core/68-02-SUMMARY.md
@src/learning/multi-query-retrieval.ts
@src/execution/review-prompt.ts
@src/execution/issue-code-context.ts
</context>

<feature>
  <name>Retrieval Snippet Anchors and Budget Trimming</name>
  <files>src/learning/retrieval-snippets.ts, src/learning/retrieval-snippets.test.ts</files>
  <behavior>
    Add reusable utilities with deterministic behavior and adapter-friendly IO:

    1) `buildSnippetAnchors({ workspaceDir, findings, readFile? }) -> SnippetAnchor[]`
       - For each retrieval finding, attempt to locate a matching line in `finding.filePath` using normalized token matching from `finding.findingText`.
       - When a match is found, return anchor as `path:line` with a bounded snippet excerpt from that line.
       - When no match or file read fails, return path-only evidence (`path` with no line/snippet) and continue (fail-open).
       - Never throw from per-finding extraction failures.

    2) `trimSnippetAnchorsToBudget({ anchors, maxChars, maxItems }) -> SnippetAnchor[]`
       - Enforce strict caps for total output size and item count.
       - If over budget, drop lowest-value items first (highest `distance` first, deterministic tie-break by path + line).
       - Preserve stable ordering of kept items by relevance (lowest `distance` first).

    Cases to lock in tests:
    - Matching evidence creates `path:line` anchors with concise snippet excerpts.
    - Missing files/unreadable files return path-only anchors without throwing.
    - Budget overflow removes high-distance items first.
    - Equivalent inputs produce deterministic output ordering.
    - Empty findings input returns empty output.
  </behavior>
  <implementation>
    Keep the module independent from handlers and prompt builders:
    - Accept injected `readFile` adapter for deterministic tests.
    - Reuse existing normalization conventions (lowercase/collapsed whitespace) from retrieval modules where appropriate.
    - Keep snippet text single-line and bounded (strip backticks/newlines to avoid prompt formatting breakage).
    - Do not add external dependencies.
  </implementation>
</feature>

<verification>
- `bun test src/learning/retrieval-snippets.test.ts --timeout 30000` passes.
- `bunx tsc --noEmit` passes.
- Tests prove deterministic budget trimming by asserting identical output for semantically equivalent inputs.
</verification>

<success_criteria>
- RET-08 utility primitives exist and are test-covered: snippet anchors with graceful fallback and deterministic budget trimming.
- Module is integration-ready for review/mention prompt wiring in Plan 69-02.
</success_criteria>

<output>
After completion, create `.planning/phases/69-snippet-anchors-prompt-budgeting/69-01-SUMMARY.md`
</output>
