---
phase: 69-snippet-anchors-prompt-budgeting
plan: 02
type: execute
wave: 2
depends_on: [69-01]
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Review and mention prompts include retrieval evidence with `path:line` anchors and concise snippets when extraction succeeds"
    - "Retrieval evidence always respects strict prompt budgets and drops lowest-value context first when overflowing"
    - "If snippet extraction fails, both surfaces still respond using path-only retrieval evidence instead of failing"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Review retrieval wiring that enriches merged findings with snippet anchors before prompt construction"
      contains: "buildSnippetAnchors"
    - path: "src/handlers/mention.ts"
      provides: "Mention retrieval wiring that reuses snippet-anchor extraction and fail-open fallback"
      contains: "trimSnippetAnchorsToBudget"
    - path: "src/execution/review-prompt.ts"
      provides: "Retrieval section rendering with anchor-first evidence formatting and bounded section size"
      contains: "buildRetrievalContextSection"
    - path: "src/execution/mention-prompt.ts"
      provides: "Mention retrieval rendering that supports snippet/anchor evidence and path-only fallback"
      contains: "## Retrieval"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "snippet-enriched retrieval context passed into buildReviewPrompt"
      pattern: "retrievalContext"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "snippet-enriched retrieval context passed into buildMentionPrompt"
      pattern: "buildMentionPrompt"
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/mention.test.ts"
      via: "regressions assert fail-open path-only fallback when snippet extraction errors"
      pattern: "path-only|fail-open|snippet"
---

<objective>
Integrate RET-08 snippet anchors and strict prompt budgeting into live review and mention pipelines.

Purpose: Complete Phase 69 outcome by making retrieval context more actionable (`path:line` + concise snippet evidence) while guaranteeing prompt-size safety and fail-open behavior across both user-facing surfaces.
Output: Handlers enrich retrieval findings with snippet anchors, prompt builders render anchor-aware context, and regressions lock overflow/fallback behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-snippet-anchors-prompt-budgeting/69-01-PLAN.md
@.planning/phases/68-multi-query-retrieval-core/68-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/mention.ts
@src/execution/review-prompt.ts
@src/execution/mention-prompt.ts
@src/execution/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich review and mention retrieval context with snippet anchors</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts, src/handlers/mention.ts, src/handlers/mention.test.ts</files>
  <action>
Integrate Plan 69-01 utilities into both retrieval pipelines:

1) After retrieval merge/rerank, build snippet anchors against workspace files and attach anchor fields (`path`, optional `line`, optional `snippet`) to prompt-facing retrieval context.
2) Preserve current fail-open guarantees: if extraction fails for a finding or whole batch, continue with path-only evidence and do not block review/mention completion.
3) Keep mention bounded behavior (`topK <= 3`) and review retrieval limits unchanged except for snippet enrichment.
4) Add regressions that assert:
   - anchor fields are present when file evidence exists,
   - path-only fallback is used on extraction/read failures,
   - existing retrieval flow still publishes responses.

Do not alter Search API retry/degrade behavior from Phase 67.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Review and mention handlers pass snippet-anchor evidence into prompts with deterministic fail-open fallback to path-only context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce strict retrieval prompt budgets with lowest-value overflow trimming</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts, src/execution/mention-prompt.ts, src/execution/mention-prompt.test.ts</files>
  <action>
Update retrieval section rendering to consume anchor-aware findings and enforce prompt budgets:

- Render retrieval bullets using anchor-first format:
  - with evidence: `` `path:line` -- `snippet` `` plus severity/category context
  - fallback: `` `path` `` plus finding text when snippet/line missing
- Apply strict budget controls (chars/items) using configured retrieval limits (`knowledge.retrieval.maxContextChars` for review; bounded equivalent cap for mention) and trim overflow by dropping lowest-value findings first (highest distance first).
- Add regression coverage for:
  1) `path:line` rendering when snippet evidence is available,
  2) overflow trimming order correctness,
  3) fallback formatting when snippets are unavailable,
  4) no retrieval section when no findings remain after trimming.

Avoid changing unrelated prompt-contract sections (degradation disclaimer, output language rules, write/read-only policy instructions).
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts --timeout 30000`.
Run `bun test src/execution/mention-prompt.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Prompt builders render actionable snippet anchors while guaranteed to stay within retrieval context budgets and degrade gracefully when over budget or missing evidence.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts --timeout 30000` passes with snippet-anchor and path-only fallback assertions.
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with snippet enrichment and fail-open mention assertions.
- `bun test src/execution/review-prompt.test.ts --timeout 30000` passes with overflow trimming and anchor-format assertions.
- `bun test src/execution/mention-prompt.test.ts --timeout 30000` passes with retrieval budget/fallback formatting assertions.
- `bunx tsc --noEmit` passes.
</verification>

<success_criteria>
RET-08 is satisfied in production paths: retrieval context includes concise anchored snippets when available, remains within strict prompt budgets, and fails open to path-only evidence when extraction is unavailable.
</success_criteria>

<output>
After completion, create `.planning/phases/69-snippet-anchors-prompt-budgeting/69-02-SUMMARY.md`
</output>
