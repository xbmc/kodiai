---
phase: 74-reliability-regression-gate
plan: 02
type: execute
wave: 2
depends_on: [74-01]
files_modified:
  - scripts/phase74-reliability-regression-gate.ts
  - scripts/phase74-reliability-regression-gate.test.ts
  - package.json
  - docs/smoke/phase74-reliability-regression-gate.md
  - docs/runbooks/xbmc-ops.md
autonomous: true

must_haves:
  truths:
    - "Maintainers can run one deterministic automated regression scenario for issue write-mode reliability that fails non-zero on regressions"
    - "The deterministic scenario combines degraded-path execution and retrieval-behavior assertions with issue write-mode publish checks in the same run"
    - "Pre-release verification path includes deterministic Azure runtime capability checks for branch creation, push strategy, and PR creation permissions on xbmc/xbmc"
    - "Gate output provides clear actionable failure signals tied to failed step/status rather than ambiguous environment phrasing"
    - "Release gate blocks when machine-checkable write-mode reliability checks or retrieval-behavior checks fail"
  artifacts:
    - path: "scripts/phase74-reliability-regression-gate.ts"
      provides: "Deterministic regression gate CLI for issue write-mode reliability and Azure runtime capability prerequisites"
      contains: "pr_creation_failed"
    - path: "scripts/phase74-reliability-regression-gate.test.ts"
      provides: "Deterministic tests for combined degraded+retrieval+issue-write scenario, pass/fail gating logic, status parsing, and capability preflight checks"
      contains: "overallPassed"
    - path: "docs/smoke/phase74-reliability-regression-gate.md"
      provides: "Exact pre-release run procedure and interpretation rules for blocking/non-blocking outcomes"
      contains: "verify:phase74"
  key_links:
    - from: "scripts/phase74-reliability-regression-gate.ts"
      to: "src/handlers/mention.ts"
      via: "gate assertions consume machine-checkable issue write-mode statuses and required artifact evidence"
      pattern: "pr_creation_failed|branch push|PR URL|issue linkback"
    - from: "scripts/phase74-reliability-regression-gate.ts"
      to: "src/execution/mention-prompt.ts"
      via: "combined degraded scenario asserts retrieval context stays bounded and markdown-safe while reliability checks run"
      pattern: "degraded|retrieval|maxChars|fallback"
    - from: "package.json"
      to: "scripts/phase74-reliability-regression-gate.ts"
      via: "single deterministic pre-release command for maintainers"
      pattern: "verify:phase74"
    - from: "docs/smoke/phase74-reliability-regression-gate.md"
      to: "scripts/phase74-reliability-regression-gate.ts"
      via: "release checklist requires script output and non-zero exit enforcement"
      pattern: "bun scripts/phase74-reliability-regression-gate"
---

<objective>
Ship a deterministic release gate that verifies issue write-mode PR-creation reliability and combined degraded retrieval behavior, and fails pre-release checks when runtime prerequisites or contracts regress.

Purpose: Phase 74 completes when maintainers can run one repeatable path that proves write-mode reliability plus degraded retrieval behavior in Azure runtime context and blocks release on regressions.
Output: New Phase 74 verification CLI, package command wiring, and runbook/smoke documentation with explicit blocking criteria for both reliability and retrieval-behavior checks.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-reliability-regression-gate/74-CONTEXT.md
@.planning/phases/72-telemetry-follow-through/72-02-SUMMARY.md
@.planning/phases/73-degraded-retrieval-contract/73-02-SUMMARY.md
@scripts/phase72-telemetry-follow-through.ts
@src/execution/mention-prompt.ts
@docs/smoke/xbmc-xbmc-write-flow.md
@docs/runbooks/xbmc-ops.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build deterministic Phase 74 reliability gate CLI with runtime capability preflight</name>
  <files>scripts/phase74-reliability-regression-gate.ts, scripts/phase74-reliability-regression-gate.test.ts</files>
  <action>
Implement a dedicated phase-locked verification script for issue write-mode reliability:

- Validate runtime prerequisites in Azure container context using deterministic non-destructive probes for `xbmc/xbmc`: branch creation capability, push capability to bot-branch strategy, and PR creation permission availability.
- Encode automated regression checks that fail when issue write-mode outcomes violate 74-01 contracts (`pr_creation_failed` semantics, failed-step diagnostics, required success artifact triad).
- Add one combined degraded + retrieval + issue-write regression scenario in the gate runner; in the same scenario assert both (a) RET-07 retrieval behavior invariants (bounded retrieval section behavior and markdown-safe fallback output) and (b) Phase 74 write-mode reliability invariants.
- Emit machine-checkable check IDs and a concise operator summary; exit non-zero when any locked check fails.
- Keep capability probes and status assertions deterministic and idempotent; no destructive repository mutations.
- Add unit tests covering pass/fail matrix, missing-capability failures, combined degraded+retrieval assertions, unknown-cause diagnostic fallback, and non-zero exit behavior.
  </action>
  <verify>
Run `bun test scripts/phase74-reliability-regression-gate.test.ts --timeout 30000`.
Run `bun scripts/phase74-reliability-regression-gate.ts --help`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Maintainers have one deterministic CLI that validates runtime prerequisites plus issue write-mode reliability invariants and blocks on regressions with explicit machine-checkable signals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire release command and publish Phase 74 pre-release verification procedure</name>
  <files>package.json, docs/smoke/phase74-reliability-regression-gate.md, docs/runbooks/xbmc-ops.md</files>
  <action>
Turn the gate into a repeatable pre-release workflow:

- Add a package script alias (for example `verify:phase74`) that runs the new deterministic gate CLI.
- Publish a dedicated Phase 74 smoke doc with exact command sequence, required inputs, pass/fail interpretation, and release-blocking rule.
- Update xbmc ops runbook with direct troubleshooting paths for capability preflight failures and `pr_creation_failed` outcomes, including failed-step lookup guidance.
- Require explicit evidence capture (check IDs and script output) so maintainers do not improvise release criteria.
- Document that `verify:phase74` is blocking when either reliability checks or combined degraded-retrieval behavior checks fail.
  </action>
  <verify>
Run `bun run verify:phase74 --help`.
Manually read `docs/smoke/phase74-reliability-regression-gate.md` and confirm it defines blocking criteria tied to check IDs for both reliability and retrieval-behavior assertions.
  </verify>
  <done>
Release verification for Phase 74 is one deterministic command plus documented blocking criteria that fail closed on write-mode reliability regressions and combined degraded-retrieval behavior regressions.
  </done>
</task>

</tasks>

<verification>
- `bun test scripts/phase74-reliability-regression-gate.test.ts --timeout 30000` passes.
- `bun scripts/phase74-reliability-regression-gate.ts --help` and `bun run verify:phase74 --help` succeed.
- `bunx tsc --noEmit` passes.
- Docs describe release-blocking outcomes keyed to script check IDs, including combined degraded-retrieval assertions.
</verification>

<success_criteria>
REG-01 and REG-02 are met for Phase 74 scope: maintainers run one deterministic combined degraded+retrieval+issue-write regression scenario plus Azure capability preflight, and release is blocked with actionable failed-step/check-ID output whenever PR-creation reliability or retrieval-behavior contracts regress.
</success_criteria>

<output>
After completion, create `.planning/phases/74-reliability-regression-gate/74-02-SUMMARY.md`
</output>
