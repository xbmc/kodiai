---
phase: 74-reliability-regression-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue write-intent requests (explicit and implicit) never report success when branch push or PR creation fails"
    - "If PR creation flow fails, runtime retries exactly once, then returns machine-checkable failure status `pr_creation_failed`"
    - "Failure replies include exact failed step and actionable diagnostics instead of vague environment-limit phrasing"
    - "Gate pass evidence requires all three artifacts: successful branch push, posted PR URL, and posted issue linkback comment"
    - "Combined degraded + issue-write scenarios preserve retrieval-behavior safety (bounded/markdown-safe retrieval context) while enforcing the same write-mode failure contract"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Write-mode publish flow with one-retry failure policy, explicit status signaling, and artifact evidence checks"
      contains: "pr_creation_failed"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for explicit/implicit issue write-intent paths, one-retry behavior, artifact triad enforcement, and combined degraded+retrieval behavior assertions"
      contains: "issue_comment"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "tests assert retry-once and failed-step diagnostics for push/PR failures"
      pattern: "retry|pr_creation_failed|failed step"
    - from: "src/handlers/mention.ts"
      to: "GitHub issue reply output"
      via: "success reply is emitted only when branch push + PR URL + issue linkback all succeed"
      pattern: "Opened PR|Evidence bundle"
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "combined degraded-retrieval + write-mode regressions assert retrieval-safe output is preserved alongside retry/failure semantics"
      pattern: "degraded|retrieval|pr_creation_failed"
---

<objective>
Lock issue write-mode PR creation failure semantics so maintainers get deterministic, machine-checkable reliability signals instead of false success.

Purpose: Phase 74 requires release gating that catches write-mode publish regressions before ship, including implicit issue write-intent paths.
Output: Hardened mention write-mode publish contract and regression tests covering retry-once failure handling, diagnostics quality, required success artifacts, and combined degraded+retrieval behavior safety.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/74-reliability-regression-gate/74-CONTEXT.md
@.planning/phases/73-degraded-retrieval-contract/73-02-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce retry-once + explicit failure status contract in issue write-mode PR publish path</name>
  <files>src/handlers/mention.ts</files>
  <action>
Implement the locked failure policy for issue write-intent publish flows (explicit `apply:`/`change:` and implicit write intent):

- Add deterministic retry-once behavior for PR creation path failures; after one failed retry, terminate with machine-checkable status `pr_creation_failed` (or stricter equivalent that preserves this semantic).
- Ensure write-mode success responses are emitted only when all required artifacts exist: branch push succeeded, PR URL exists, and issue linkback comment post succeeded.
- If any required artifact is missing, treat as gate failure and return explicit failed-step diagnostics.
- Replace vague generic wording with step-level failure details when available (for example: branch-push, create-pr, or issue-linkback).
- Keep existing user policy behavior unchanged: no unsolicited responses and no auto re-review-on-push side effects.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Issue write-mode publish flow has deterministic retry-once semantics and machine-checkable `pr_creation_failed` failure signaling, with no false-success reply when required artifacts are missing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression coverage for explicit+implicit issue write intents, diagnostics, and evidence triad</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add focused regression tests that prove locked Phase 74 behavior:

- Cover explicit and implicit issue write-intent trigger paths (not only prefixed commands).
- Assert PR creation failures retry exactly once, then surface machine-checkable failure status and failed-step diagnostics.
- Assert success path requires and emits proof of all three artifacts (branch push success, PR URL in output, issue linkback comment creation).
- Assert failures do not emit success wording such as "Opened PR" when push/PR/linkback steps did not complete.
- Include a regression assertion that unknown-root-cause failures may stay generic but still include actionable next-step diagnostics plus failed-step identity.
- Add one combined degraded + issue-write scenario that validates retrieval behavior remains RET-07-safe (bounded section behavior and markdown-safe fallback text) while write-mode publish failure semantics still enforce retry-once and `pr_creation_failed`.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bun test`.
  </verify>
  <done>
Regression suite fails on any reintroduction of false-success write replies, missing retry-once policy, missing `pr_creation_failed` semantics, vague non-actionable failure disclosure, or combined degraded+retrieval contract regressions.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with retry-once + artifact-triad assertions.
- `bun test` passes with no write-mode contract regressions.
- `bunx tsc --noEmit` passes.
</verification>

<success_criteria>
Locked issue write-mode reliability policy is enforceable in code: one retry max on PR publish failures, explicit machine-checkable failure status, actionable failed-step diagnostics, and no success output unless branch push + PR URL + issue linkback comment all complete.
</success_criteria>

<output>
After completion, create `.planning/phases/74-reliability-regression-gate/74-01-SUMMARY.md`
</output>
