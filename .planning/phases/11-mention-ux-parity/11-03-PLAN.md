---
phase: 11-mention-ux-parity
plan: 03
type: execute
wave: 3
depends_on:
  - 11-mention-ux-parity/11-02-PLAN.md
files_modified:
  - src/execution/mcp/review-comment-thread-server.ts
  - src/execution/mcp/index.ts
  - src/execution/mention-prompt.ts
  - src/handlers/mention.ts
  - src/execution/mcp/review-comment-thread-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Inline PR review comment mentions produce a reply in the same thread"
    - "Non-inline mentions remain top-level issue/PR comment replies"
    - "The mention prompt instructs the correct tool for inline thread replies"
  artifacts:
    - path: "src/execution/mcp/review-comment-thread-server.ts"
      provides: "MCP tool for replying to PR review comment threads"
      exports: ["createReviewCommentThreadServer"]
    - path: "src/execution/mcp/index.ts"
      provides: "MCP server registry includes thread reply tool"
      contains: "reviewCommentThread"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mcp/review-comment-thread-server.ts"
      via: "Executor prompt selects reply tool for pr_review_comment surface"
      pattern: "pr_review_comment"
---

<objective>
Add inline thread replies for PR review comment mentions so responses show up in the exact review comment thread (parity with xbmc/xbmc @claude UX).

Purpose: Developers expect replies to inline comments to stay in-thread.
Output: New MCP tool + routing + tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/execution/mcp/index.ts
@src/execution/mcp/comment-server.ts
@src/execution/mcp/inline-review-server.ts
@src/handlers/mention.ts
@src/execution/mention-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MCP tool to reply to a PR review comment thread</name>
  <files>src/execution/mcp/review-comment-thread-server.ts, src/execution/mcp/review-comment-thread-server.test.ts</files>
  <action>
  Create a new MCP server exposing a single tool for inline thread replies.

  Required tool shape:
  - Name: `reply_to_pr_review_comment`
  - Input: `{ pullRequestNumber: number, commentId: number, body: string }`
  - Behavior: post a reply in the thread of the existing PR review comment.

  Implementation notes:
  - Use Octokit REST endpoint for PR review comment replies.
  - Wrap long bodies with existing formatting rules if those apply to bot comments.
  - Return a tool result that includes created comment id/url (when available).

  Add tests using an Octokit stub to assert the expected REST call is made.
  </action>
  <verify>
  - `bun test src/execution/mcp/review-comment-thread-server.test.ts`
  </verify>
  <done>
  An MCP tool exists that can publish replies into inline review comment threads.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire thread reply tool into MCP registry and mention prompt routing</name>
  <files>src/execution/mcp/index.ts, src/execution/mention-prompt.ts, src/handlers/mention.ts</files>
  <action>
  1) Add the new server to `buildMcpServers()` so it is available during mention execution.

  2) Update mention handler to pass enough identifiers into the executor context for inline replies:
     - PR number
     - triggering review comment id

  3) Update the mention prompt to:
     - for `pr_review_comment` surface: instruct the model to call the new reply tool
     - for other surfaces: instruct to create a normal issue comment reply

  Ensure:
  - no tracking comments
  - no ack-only comments
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  Inline mentions reply in-thread; other mentions reply at top-level.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<success_criteria>
- Inline thread replies work via MCP tool
- Prompt routing selects correct publishing tool per surface
</success_criteria>

<output>
After execution, create `.planning/phases/11-mention-ux-parity/11-03-SUMMARY.md`
</output>
