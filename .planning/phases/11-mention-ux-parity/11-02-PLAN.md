---
phase: 11-mention-ux-parity
plan: 02
type: execute
wave: 2
depends_on:
  - 11-mention-ux-parity/11-01-PLAN.md
files_modified:
  - src/handlers/mention.ts
  - src/execution/mention-prompt.ts
  - src/lib/sanitize.ts
  - src/lib/toctou.ts
  - src/execution/mention-context.ts
  - src/execution/mention-context.test.ts
autonomous: true

must_haves:
  truths:
    - "Mention replies use surrounding conversation context filtered to trigger timestamp"
    - "Inline PR review comment mentions include file/line/diff hunk context"
    - "Eyes reaction remains the only tracking signal (no tracking comment)"
    - "The model is instructed to not post ack/tracking comments and to always reply to a mention (or ask clarifying questions)"
  artifacts:
    - path: "src/execution/mention-context.ts"
      provides: "Context builder for mention replies (conversation + PR context)"
      contains: "buildMentionContext"
    - path: "src/execution/mention-prompt.ts"
      provides: "Prompt includes context and response rules"
      contains: "Only post a reply"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-context.ts"
      via: "Mention handler builds context before executor"
      pattern: "buildMentionContext"
---

<objective>
Restore contextual mention replies (conversation + PR context) while keeping tracking as eyes-only. Improve answer quality compared to the current minimal-context mention prompt.

Purpose: Match @claude mention UX (contextual answers) without relying on GitHub Actions sandboxed posting.
Output: Context builder + prompt updates + tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/handlers/mention.ts
@src/execution/mention-prompt.ts
@src/lib/sanitize.ts
@src/lib/toctou.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create a mention context builder with TOCTOU + sanitization</name>
  <files>src/execution/mention-context.ts, src/execution/mention-context.test.ts</files>
  <action>
  Create `buildMentionContext()` that returns a structured context string for mention replies.

  Requirements:
  - Fetch the relevant issue/PR comment history using Octokit.
  - Apply the existing sanitization pipeline to user-provided text.
  - Apply TOCTOU filtering: include only comments with created_at <= the trigger timestamp.
  - Keep context bounded:
    - limit to the most recent N comments (pick a small default, e.g. 20)
    - omit large bodies or truncate to avoid prompt blowup
  - For PR mentions, fetch PR metadata (title/body, head/base refs) and include a compact header.
  - For inline review comment surface, include `diffHunk` + file path/line metadata if available.

  Add tests that validate:
  - comments newer than trigger timestamp are excluded
  - sanitizer runs (invisible unicode / HTML comments removed)
  - truncation/limits behavior is deterministic
  </action>
  <verify>
  - `bun test src/execution/mention-context.test.ts`
  </verify>
  <done>
  Mention context is deterministic, bounded, and safe against TOCTOU/prompt injection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire context into mention handler and tighten prompt rules</name>
  <files>src/handlers/mention.ts, src/execution/mention-prompt.ts</files>
  <action>
  1) Update the mention handler to build context via `buildMentionContext()` and pass it into `buildMentionPrompt()`.

  2) Update `buildMentionPrompt()` to:
     - include the context section (conversation + PR metadata)
     - explicitly state:
       - eyes reaction is already used for tracking
       - do not post ack/tracking comments
       - only post a reply if useful; otherwise do nothing

  Keep existing behavior:
  - Reply via a new comment (not update)
  - No tracking comment creation
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  Mention replies are contextual and non-noisy, matching the desired dev UX.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<success_criteria>
- Mention prompt includes safe, bounded context
- Inline review comment mentions include diff-hunk/file context
- No tracking comments are used; eyes reaction remains tracking
</success_criteria>

<output>
After execution, create `.planning/phases/11-mention-ux-parity/11-02-SUMMARY.md`
</output>
