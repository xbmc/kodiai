---
phase: 04-pr-auto-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/execution/review-prompt.ts
autonomous: true

must_haves:
  truths:
    - "Review prompt instructs Claude to use inline comments with suggestion blocks for issues"
    - "Review prompt instructs Claude to NOT post summary comments or positive feedback"
    - "Review prompt instructs Claude to use git diff for reviewing changes"
    - "Config schema supports review.skipAuthors, review.skipPaths, and review.prompt fields"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Review-specific prompt builder"
      exports: ["buildReviewPrompt"]
    - path: "src/execution/config.ts"
      provides: "Extended repo config schema with review fields"
      exports: ["loadRepoConfig", "RepoConfig"]
      contains: "skipAuthors"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "src/execution/types.ts"
      via: "imports ExecutionContext or similar PR data type"
      pattern: "import.*types"
    - from: "src/execution/config.ts"
      to: "zod"
      via: "schema validation for new review fields"
      pattern: "skipAuthors.*z\\.array"
---

<objective>
Extend the repo config schema with review-specific fields and create the review prompt builder that instructs Claude how to review PRs.

Purpose: The config extension allows per-repo customization of review behavior (skip certain authors like dependabot, skip certain file paths, inject custom review instructions). The review prompt builder produces the exact prompt that tells Claude to use inline comments with suggestion blocks, avoid noise, and use git diff for reviewing changes.

Output: `src/execution/review-prompt.ts` (new), updated `src/execution/config.ts` and `src/execution/config.test.ts`
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pr-auto-review/04-RESEARCH.md
@src/execution/config.ts
@src/execution/config.test.ts
@src/execution/types.ts
@src/execution/prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend repo config schema with review fields</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
Extend the `review` object in `repoConfigSchema` in `src/execution/config.ts` to add three new fields:

1. `skipAuthors: z.array(z.string()).default([])` -- array of GitHub usernames to skip review for (e.g., "dependabot[bot]", "renovate[bot]")
2. `skipPaths: z.array(z.string()).default([])` -- array of glob patterns for files to exclude from review focus (e.g., "*.lock", "package-lock.json")
3. `prompt: z.string().optional()` -- custom review instructions appended to the review prompt

Update the `.default()` call on the `review` object to include the full default value with all fields (Zod v4 requires this -- see 03-01 decision).

The updated review schema should be:
```typescript
review: z.object({
  enabled: z.boolean().default(true),
  autoApprove: z.boolean().default(false),
  skipAuthors: z.array(z.string()).default([]),
  skipPaths: z.array(z.string()).default([]),
  prompt: z.string().optional(),
}).default({
  enabled: true,
  autoApprove: false,
  skipAuthors: [],
  skipPaths: [],
}),
```

Update `src/execution/config.test.ts` to add a test that validates the new defaults:
- Test that `review.skipAuthors` defaults to `[]`
- Test that `review.skipPaths` defaults to `[]`
- Test that `review.prompt` defaults to `undefined`
- Test that a YAML file with `review: { skipAuthors: ["dependabot[bot]"] }` correctly parses
  </action>
  <verify>Run `bun test src/execution/config.test.ts` -- all tests pass including the new ones</verify>
  <done>Config schema accepts skipAuthors, skipPaths, and prompt fields with correct defaults. All existing and new tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create review prompt builder</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
Create `src/execution/review-prompt.ts` with a `buildReviewPrompt()` function that generates the review-specific prompt for Claude.

The function signature:
```typescript
export function buildReviewPrompt(context: {
  owner: string;
  repo: string;
  prNumber: number;
  prTitle: string;
  prBody: string;
  prAuthor: string;
  baseBranch: string;
  headBranch: string;
  changedFiles: string[];
  customInstructions?: string;
}): string
```

The prompt must follow the pattern from the research (Pattern 3: Review Prompt Construction). Key elements:

1. Identify the PR being reviewed (number, repo, title, author, branches)
2. Include PR description if present (sanitize later in Phase 6)
3. List changed files
4. Instruct Claude to check for: bugs, crashes, undefined behavior, memory leaks, resource management, thread safety, security vulnerabilities, performance issues, logic errors
5. For each issue found: use `mcp__github_inline_comment__create_inline_comment` MCP tool with suggestion blocks where a concrete fix exists
6. Rules section: NO positive feedback, NO "looks good", NO summary comments, ONLY actionable issues. Use (1), (2), (3) numbering format -- NEVER #1, #2 (GitHub treats those as issue links)
7. Instruct Claude to use `Bash(git diff origin/${baseBranch}...HEAD)` to see the full diff and `Bash(git log origin/${baseBranch}..HEAD --stat)` for changed files overview
8. After review: if issues found, post inline comments only. If NO issues found, do nothing (system handles silent approval)
9. If `customInstructions` is provided (from `.kodiai.yml` review.prompt), append at the end

Do NOT export or import ExecutionContext -- this function takes its own context object to keep the review prompt decoupled from the general execution types. The review handler will map from PR payload data to this context shape.
  </action>
  <verify>
Create a temporary test file `src/execution/review-prompt.test.ts` with the following checks:

```typescript
import { test, expect } from "bun:test";
import { buildReviewPrompt } from "./review-prompt";

test("buildReviewPrompt returns string containing required elements", () => {
  const prompt = buildReviewPrompt({
    owner: "test-org", repo: "test-repo", prNumber: 42,
    prTitle: "Fix null pointer", prBody: "Fixes crash on login",
    prAuthor: "contributor", baseBranch: "main", headBranch: "fix/null",
    changedFiles: ["src/index.ts"],
  });
  expect(typeof prompt).toBe("string");
  expect(prompt).toContain("mcp__github_inline_comment__create_inline_comment");
  expect(prompt).toContain("git diff origin/main");
  expect(prompt).toContain("test-org/test-repo");
  expect(prompt).toContain("#42");
  expect(prompt).not.toContain("looks good");
});

test("buildReviewPrompt includes custom instructions when provided", () => {
  const prompt = buildReviewPrompt({
    owner: "o", repo: "r", prNumber: 1, prTitle: "t", prBody: "",
    prAuthor: "a", baseBranch: "main", headBranch: "b",
    changedFiles: [], customInstructions: "Focus on SQL injection risks",
  });
  expect(prompt).toContain("Focus on SQL injection risks");
});
```

Run `bun test src/execution/review-prompt.test.ts` -- both tests must pass.
  </verify>
  <done>`buildReviewPrompt()` returns a well-structured prompt string that includes all required elements: PR identification, check categories, MCP tool usage instructions, suggestion block format, no-noise rules, git diff instructions, and custom instructions support. Tests confirm the prompt contains critical substrings.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes all tests (existing + new)
- `bun test src/execution/review-prompt.test.ts` passes all tests
- `src/execution/review-prompt.ts` compiles cleanly
- `buildReviewPrompt()` produces a prompt containing: MCP tool name, suggestion block format, git diff command, no-noise rules
</verification>

<success_criteria>
- Config schema accepts review.skipAuthors (string[]), review.skipPaths (string[]), review.prompt (optional string) with correct defaults
- buildReviewPrompt() generates a prompt that instructs Claude to use inline comments with suggestion blocks, avoid summary comments, and use git diff for reviewing
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-auto-review/04-01-SUMMARY.md`
</output>
