---
phase: 04-pr-auto-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/execution/review-prompt.ts
autonomous: true

must_haves:
  truths:
    - "Review config schema accepts skipAuthors, skipPaths, and prompt fields with sensible defaults"
    - "Review prompt instructs Claude to use inline comments with suggestion blocks for issues"
    - "Review prompt instructs Claude to do nothing if no issues found (silent approval handled by handler)"
    - "Review prompt includes PR metadata (title, author, branches, changed files, custom instructions)"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Extended review config schema with skipAuthors, skipPaths, prompt"
      contains: "skipAuthors"
    - path: "src/execution/review-prompt.ts"
      provides: "buildReviewPrompt function for PR auto-review"
      exports: ["buildReviewPrompt"]
    - path: "src/execution/config.test.ts"
      provides: "Tests for extended review config"
      contains: "skipAuthors"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "src/execution/types.ts"
      via: "import types"
      pattern: "import.*types"
---

<objective>
Extend the repo config schema with review-specific fields (skipAuthors, skipPaths, custom prompt) and create a dedicated review prompt builder that instructs Claude to post inline comments with suggestion blocks for issues and do nothing for clean PRs.

Purpose: The review prompt is the core of the review quality -- it tells Claude exactly what to look for, how to report findings (inline comments with suggestion blocks), and to stay silent on clean PRs. The config extensions let repo owners customize review behavior (skip bot authors, ignore certain paths, add custom instructions).

Output: Extended `RepoConfig` type with review fields, `buildReviewPrompt()` function, updated tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/execution/config.ts
@src/execution/config.test.ts
@src/execution/types.ts
@src/execution/prompt.ts
@src/execution/mcp/inline-review-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend review config schema</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
Extend the `review` object in `repoConfigSchema` (src/execution/config.ts) to add three new fields:

```typescript
review: z.object({
  enabled: z.boolean().default(true),
  autoApprove: z.boolean().default(false),
  prompt: z.string().optional(),        // Custom review instructions appended to prompt
  skipAuthors: z.array(z.string()).default([]),  // Authors to skip (e.g., "dependabot[bot]", "renovate[bot]")
  skipPaths: z.array(z.string()).default([]),    // Glob patterns for files to ignore (e.g., "*.lock", "package-lock.json")
}).default({
  enabled: true,
  autoApprove: false,
  skipAuthors: [],
  skipPaths: [],
})
```

Note: With Zod v4, `.default({})` on nested objects with inner defaults requires specifying the full default object (per decision [03-01]).

Update the existing tests in config.test.ts to verify:
- Default config has `review.skipAuthors` as empty array
- Default config has `review.skipPaths` as empty array
- Default config has `review.prompt` as undefined
- A YAML with `review.skipAuthors: ["dependabot[bot]"]` parses correctly
- A YAML with `review.prompt: "Focus on security issues"` parses correctly
  </action>
  <verify>`bun test src/execution/config.test.ts` passes with all new tests green</verify>
  <done>RepoConfig type includes review.skipAuthors (string[]), review.skipPaths (string[]), and review.prompt (string | undefined) with correct defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create review prompt builder</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
Create `src/execution/review-prompt.ts` with a `buildReviewPrompt()` function.

The function signature:

```typescript
export function buildReviewPrompt(context: {
  owner: string;
  repo: string;
  prNumber: number;
  prTitle: string;
  prBody: string;
  prAuthor: string;
  baseBranch: string;
  headBranch: string;
  changedFiles: string[];
  customInstructions?: string;
}): string
```

The prompt MUST include these sections:

1. **Context header**: "You are reviewing pull request #N in owner/repo" with title, author, branches
2. **PR body**: Include the PR description if non-empty (label it clearly)
3. **Changed files list**: Bulleted list of changed file paths
4. **Review instructions**: Tell Claude to check for bugs, crashes, security vulnerabilities, performance issues, logic errors, resource management issues, thread safety
5. **How to report**: Use `mcp__github_inline_comment__create_inline_comment` tool to post inline comments on specific files and lines. Include GitHub suggestion blocks (triple backtick `suggestion` blocks) when Claude has a concrete fix
6. **Rules**:
   - NO positive feedback, NO "looks good", NO summary sections
   - ONLY report actionable issues that need to be fixed
   - Use inline comments for ALL code-specific issues
   - When listing items, use (1), (2), (3) format -- NEVER #1, #2, #3 (avoids GitHub treating them as issue links)
   - To see the full diff: `Bash(git diff origin/BASE_BRANCH...HEAD)` (substitute actual base branch)
   - To see changed files: `Bash(git log origin/BASE_BRANCH..HEAD --stat)`
7. **After review**: "If you found issues: post inline comments using the MCP tool. Do NOT post a summary comment. If NO issues found: do nothing. Do NOT post any comment or approval -- the system handles silent approval automatically."
8. **Custom instructions**: If `customInstructions` is provided, append under a "Custom instructions:" section

Keep the prompt concise but complete. Use the proven xbmc review workflow pattern from research as the template (documented in 04-RESEARCH.md Pattern 3).
  </action>
  <verify>`bun run --bun -e "import { buildReviewPrompt } from './src/execution/review-prompt.ts'; const p = buildReviewPrompt({ owner: 'test', repo: 'repo', prNumber: 1, prTitle: 'Fix bug', prBody: 'Fixes crash', prAuthor: 'alice', baseBranch: 'main', headBranch: 'fix-bug', changedFiles: ['src/index.ts'] }); console.log(p);"` prints a well-formed review prompt containing all required sections</verify>
  <done>buildReviewPrompt returns a complete prompt with PR metadata, review instructions, MCP tool usage guidance, suggestion block format, and silent-approval-if-clean instruction</done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes (all existing + new tests)
- `buildReviewPrompt()` output includes: MCP tool name, suggestion block syntax, "do nothing" instruction for clean PRs, git diff command with base branch, changed files list
- `RepoConfig` type exports correctly with new review fields
- No regressions in existing config parsing (empty config still works with defaults)
</verification>

<success_criteria>
1. `review.skipAuthors`, `review.skipPaths`, and `review.prompt` fields exist in RepoConfig with correct defaults
2. `buildReviewPrompt()` produces a prompt that Claude can follow to post inline review comments with suggestion blocks
3. The prompt explicitly instructs Claude to do nothing on clean PRs (handler manages approval)
4. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-auto-review/04-01-SUMMARY.md`
</output>
