---
phase: 04-pr-auto-review
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/handlers/review.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "pull_request.opened event (non-draft) triggers a review execution"
    - "pull_request.ready_for_review event triggers a review execution"
    - "Draft PRs on opened event are silently skipped"
    - "Fork PRs clone from head.repo for code, post comments to base repo"
    - "Base branch is fetched after clone so git diff origin/base...HEAD works"
    - "After successful execution with no inline comments, a silent APPROVE review is submitted"
    - "After successful execution with inline comments, no approval is submitted"
    - "skipAuthors in config causes matching PR authors to be skipped"
    - "review.enabled=false in config causes the review to be skipped"
    - "Deleted fork repos (head.repo null) fall back to git fetch origin pull/N/head"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "createReviewHandler factory with event registration, review orchestration, silent approval"
      exports: ["createReviewHandler"]
    - path: "src/index.ts"
      provides: "Server wiring that imports and calls createReviewHandler with all dependencies"
      contains: "createReviewHandler"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/webhook/router.ts"
      via: "eventRouter.register()"
      pattern: "register.*pull_request"
    - from: "src/handlers/review.ts"
      to: "src/execution/executor.ts"
      via: "executor.execute()"
      pattern: "executor\\.execute"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "buildReviewPrompt()"
      pattern: "buildReviewPrompt"
    - from: "src/handlers/review.ts"
      to: "src/jobs/workspace.ts"
      via: "workspaceManager.create()"
      pattern: "workspaceManager\\.create"
    - from: "src/handlers/review.ts"
      to: "octokit.rest.pulls.createReview"
      via: "silent APPROVE submission"
      pattern: "createReview.*APPROVE"
    - from: "src/handlers/review.ts"
      to: "octokit.rest.pulls.listReviewComments"
      via: "check for bot comments before approval"
      pattern: "listReviewComments"
    - from: "src/index.ts"
      to: "src/handlers/review.ts"
      via: "import and call createReviewHandler"
      pattern: "createReviewHandler"
---

<objective>
Create the review handler that wires `pull_request.opened` and `pull_request.ready_for_review` events to the execution engine, with fork PR support, base branch fetching, silent approval logic, and server wiring.

Purpose: This is the core feature of Phase 4. When a PR is opened (or a draft becomes ready), the handler clones the repo, builds a review-specific prompt, runs Claude via the executor, and submits a silent approval if Claude found no issues. Fork PRs are handled natively by cloning from head.repo.

Output: `src/handlers/review.ts` (review handler factory), updated `src/index.ts` (wiring).
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pr-auto-review/04-01-SUMMARY.md

@src/index.ts
@src/webhook/types.ts
@src/webhook/router.ts
@src/execution/executor.ts
@src/execution/types.ts
@src/execution/config.ts
@src/execution/review-prompt.ts
@src/jobs/types.ts
@src/jobs/workspace.ts
@src/auth/github-app.ts
@.planning/phases/04-pr-auto-review/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
Create `src/handlers/review.ts` exporting `createReviewHandler()` following the factory function pattern established across the codebase.

**Function signature:**
```typescript
export function createReviewHandler(deps: {
  eventRouter: EventRouter;
  jobQueue: JobQueue;
  workspaceManager: WorkspaceManager;
  githubApp: GitHubApp;
  executor: ReturnType<typeof createExecutor>;
  logger: Logger;
}): void
```

The function registers two event handlers via `eventRouter.register()`:
- `"pull_request.opened"` -> `handleReview`
- `"pull_request.ready_for_review"` -> `handleReview`

**handleReview implementation:**

1. **Type the payload**: Cast `event.payload` to access `pull_request`, `repository`, and `action` fields. Import webhook types from `@octokit/webhooks-types` (`PullRequestOpenedEvent`, `PullRequestReadyForReviewEvent`).

2. **Skip draft PRs**: If `pr.draft === true`, log debug and return. (The `opened` event fires for drafts too.)

3. **Load config early via workspace**: The review handler needs config to check `review.enabled` and `review.skipAuthors`, but config lives in the repo. To avoid cloning just to check config, proceed with the clone and check config after. If review is disabled, clean up and return.

4. **Check skipAuthors**: After loading config from the workspace, check if `pr.user.login` matches any entry in `config.review.skipAuthors`. If so, log and return (after workspace cleanup).

5. **Fork PR support**: Extract clone target from `pr.head.repo` (the fork) vs `payload.repository` (the base). Handle null `head.repo` (deleted fork) by falling back to fetching the PR ref from the base repo.

   ```typescript
   const headRepo = pr.head.repo;
   const apiOwner = payload.repository.owner.login;
   const apiRepo = payload.repository.name;
   const isFork = headRepo?.full_name !== payload.repository.full_name;

   let cloneOwner: string;
   let cloneRepo: string;
   let cloneRef: string;
   let usesPrRef = false;

   if (headRepo) {
     cloneOwner = headRepo.owner.login;
     cloneRepo = headRepo.name;
     cloneRef = pr.head.ref;
   } else {
     // Deleted fork -- fall back to PR ref from base repo
     cloneOwner = apiOwner;
     cloneRepo = apiRepo;
     cloneRef = pr.base.ref; // Clone base branch, then fetch PR ref
     usesPrRef = true;
   }
   ```

6. **Enqueue job**: Use `jobQueue.enqueue(event.installationId, async () => { ... })`.

7. **Create workspace**: `workspaceManager.create(event.installationId, { owner: cloneOwner, repo: cloneRepo, ref: cloneRef, depth: 50 })`. Use depth 50 for diff context.

8. **Handle deleted fork**: If `usesPrRef`, after workspace creation run:
   ```typescript
   await $`git -C ${workspace.dir} fetch origin pull/${pr.number}/head:pr-review`.quiet();
   await $`git -C ${workspace.dir} checkout pr-review`.quiet();
   ```

9. **Fetch base branch**: After workspace creation, always run:
   ```typescript
   await $`git -C ${workspace.dir} fetch origin ${pr.base.ref} --depth=1`.quiet();
   ```
   This ensures `git diff origin/BASE...HEAD` works in the review prompt.

10. **Load repo config**: `loadRepoConfig(workspace.dir)`. Check `config.review.enabled` -- if false, log and return. Check `config.review.skipAuthors` -- if PR author matches, log and return.

11. **Build changed files list**: Run `git diff origin/${pr.base.ref}...HEAD --name-only` to get the list of changed files. Filter out files matching `config.review.skipPaths` patterns (use simple glob matching -- a file matches if any skipPaths pattern is a suffix match or the file starts with the pattern when pattern ends with `/`). For v1, use basic string matching: a skipPath pattern matches if the file path ends with the pattern (for extensions like "*.lock") or the file path starts with the pattern (for directories like "vendor/"). If skipPaths filters out ALL files, skip the review.

12. **Build review prompt**: Call `buildReviewPrompt()` from `src/execution/review-prompt.ts` with all the extracted PR metadata and `config.review.prompt` as `customInstructions`.

13. **Execute**: Call `executor.execute()` with an `ExecutionContext` built from workspace, installation ID, owner/repo (API target, NOT clone target), prNumber, eventType, and the review prompt as `triggerBody`. IMPORTANT: Override the prompt -- the executor currently calls `buildPrompt(context)` internally. The review handler should set `triggerBody` to the full review prompt so the generic `buildPrompt` wraps it. Actually, re-reading executor.ts, `buildPrompt(context)` uses `context.triggerBody` as the "User message". Set `triggerBody` to the review prompt content.

    Wait -- re-examining this: the executor calls `buildPrompt(context)` which wraps `context.triggerBody` inside a generic scaffold. For review, we need the FULL review prompt to be used as the prompt, not wrapped in the generic scaffold. Two options:
    - (A) Add a `prompt` field to `ExecutionContext` that overrides `buildPrompt()` when set
    - (B) Put the review prompt content in `triggerBody` and accept the generic wrapper

    Option (A) is cleaner. Add an optional `prompt?: string` field to `ExecutionContext` in `src/execution/types.ts`. In `executor.ts`, use `context.prompt ?? buildPrompt(context)` as the prompt passed to `query()`. This is a minimal change (1 line in types, 1 line in executor).

14. **Post-execution silent approval**: After `executor.execute()` returns, if `result.conclusion === "success"`:
    - Get an Octokit for the installation
    - List recent review comments on the PR, filter for bot comments (`user.login === "${appSlug}[bot]"`)
    - If zero bot comments found, submit a silent approval: `octokit.rest.pulls.createReview({ owner: apiOwner, repo: apiRepo, pull_number: pr.number, event: "APPROVE" })`
    - If bot comments exist, log "Issues found, skipping approval"
    - Only do this if `config.review.autoApprove` is true (per the config field). If autoApprove is false, skip the approval step entirely.

    Wait -- re-reading the requirements: "A PR with no issues receives a silent approval (no comment posted, no noise)". The `autoApprove` config field defaults to `false`. This means by default, the bot does NOT approve. The user must opt in with `review.autoApprove: true` in `.kodiai.yml`. This is the safe default. When autoApprove is false and no issues found, the bot simply does nothing (truly silent).

15. **Workspace cleanup**: Always in a `finally` block.

16. **Error logging**: Log errors but don't throw (the executor already catches errors and returns conclusion "error"). Log the result conclusion, cost, turns, duration.

**Types to import:**
- `PullRequestOpenedEvent`, `PullRequestReadyForReviewEvent` from `@octokit/webhooks-types`
- `EventRouter`, `WebhookEvent` from `../webhook/types.ts`
- `JobQueue`, `WorkspaceManager` from `../jobs/types.ts`
- `GitHubApp` from `../auth/github-app.ts`
- `createExecutor` from `../execution/executor.ts` (for ReturnType)
- `loadRepoConfig` from `../execution/config.ts`
- `buildReviewPrompt` from `../execution/review-prompt.ts`
- `Logger` from `pino`
- `$` from `bun` (for git commands)
  </action>
  <verify>File compiles: `bun build --no-bundle src/handlers/review.ts` succeeds. Verify the file exports `createReviewHandler` and imports all required dependencies.</verify>
  <done>createReviewHandler registers for pull_request.opened and pull_request.ready_for_review, handles draft skipping, fork PR cloning, base branch fetching, config-based skip logic, review prompt building, executor invocation, and conditional silent approval</done>
</task>

<task type="auto">
  <name>Task 2: Add prompt override to ExecutionContext and wire review handler into server</name>
  <files>src/execution/types.ts, src/execution/executor.ts, src/index.ts</files>
  <action>
**Part A: ExecutionContext prompt override**

In `src/execution/types.ts`, add an optional `prompt` field to `ExecutionContext`:
```typescript
/** Optional pre-built prompt. When set, overrides the default buildPrompt() output. */
prompt?: string;
```

In `src/execution/executor.ts`, change the prompt line from:
```typescript
const prompt = buildPrompt(context);
```
to:
```typescript
const prompt = context.prompt ?? buildPrompt(context);
```

This is a minimal, backward-compatible change. Existing callers that don't set `prompt` get the same behavior.

**Part B: Wire review handler into server**

In `src/index.ts`:

1. Add imports:
```typescript
import { createExecutor } from "./execution/executor.ts";
import { createReviewHandler } from "./handlers/review.ts";
```

2. After the `eventRouter` creation and before `const app = new Hono()`, create the executor and register the review handler:
```typescript
// Execution engine
const executor = createExecutor({ githubApp, logger });

// Register event handlers
createReviewHandler({
  eventRouter,
  jobQueue,
  workspaceManager,
  githubApp,
  executor,
  logger,
});
```

3. Remove the Phase 3 placeholder comments about registering handlers (lines ~37-43 that show example handler registration).
  </action>
  <verify>`bun build --no-bundle src/index.ts` compiles without errors. The server entrypoint now imports executor and review handler and wires them together.</verify>
  <done>ExecutionContext supports optional prompt override, executor uses it when set, index.ts creates executor and registers review handler with all dependencies, placeholder comments removed</done>
</task>

</tasks>

<verification>
- `bun build --no-bundle src/index.ts` compiles (full dependency chain)
- `bun build --no-bundle src/handlers/review.ts` compiles
- `bun test src/execution/config.test.ts` passes (from Plan 01)
- Review handler registers for exactly two events: `pull_request.opened` and `pull_request.ready_for_review`
- Review handler imports and calls `buildReviewPrompt` from Plan 01
- Review handler uses `workspaceManager.create()` with `depth: 50`
- Review handler fetches base branch with `git fetch origin BASE --depth=1`
- Review handler checks `config.review.enabled`, `config.review.skipAuthors`, `pr.draft`
- Silent approval only submitted when `config.review.autoApprove === true` AND no bot comments found
- `src/index.ts` creates executor and review handler (no more placeholder comments)
</verification>

<success_criteria>
1. `pull_request.opened` and `pull_request.ready_for_review` events are handled by the review handler
2. Draft PRs are skipped on `opened` events
3. Fork PRs clone from head.repo, post comments to base repo
4. Deleted fork repos fall back to fetching PR ref
5. Base branch is fetched for diff context
6. Review prompt from Plan 01 is used via the prompt override in ExecutionContext
7. Silent approval is submitted only when autoApprove is enabled and no inline comments were posted
8. skipAuthors and review.enabled config are checked before execution
9. Server wiring in index.ts connects all components
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-auto-review/04-02-SUMMARY.md`
</output>
