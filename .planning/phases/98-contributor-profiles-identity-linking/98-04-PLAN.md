---
phase: 98-contributor-profiles-identity-linking
plan: 04
type: execute
wave: 3
depends_on: ["98-01", "98-02", "98-03"]
files_modified:
  - src/execution/review-prompt.ts
  - src/handlers/review.ts
  - src/lib/author-classifier.ts
  - src/index.ts
  - src/contributor/index.ts
autonomous: true
requirements:
  - PROF-04
  - PROF-02

must_haves:
  truths:
    - "High-expertise contributors in their strong areas get terse, direct reviews focused on architecture"
    - "Newcomers get explanatory reviews with WHY reasoning, doc links, and encouraging tone"
    - "Adaptation is invisible -- no badges or indicators, reviews just naturally read differently"
    - "Contributors without profiles fall back to existing classifyAuthor behavior"
    - "Expertise is incrementally updated after each PR review (fire-and-forget)"
    - "Slash command route is mounted and accessible at /webhooks/slack/commands"
    - "Identity suggestions are sent as DMs when unlinked GitHub users appear in PRs"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Enhanced buildAuthorExperienceSection with 4-tier support and area-aware prompts"
      exports: ["buildAuthorExperienceSection"]
    - path: "src/handlers/review.ts"
      provides: "Profile-aware resolveAuthorTier with fallback to legacy classifier"
      contains: "contributorProfileStore"
    - path: "src/index.ts"
      provides: "Slash command route mounted, profile store created and injected"
      contains: "createSlackCommandRoutes"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/contributor/profile-store.ts"
      via: "lookup contributor profile for author tier resolution"
      pattern: "getByGithubUsername|getExpertise"
    - from: "src/handlers/review.ts"
      to: "src/contributor/expertise-scorer.ts"
      via: "fire-and-forget incremental expertise update after review"
      pattern: "updateExpertiseIncremental"
    - from: "src/execution/review-prompt.ts"
      to: "src/contributor/types.ts"
      via: "uses ContributorTier type for 4-tier prompt adaptation"
      pattern: "ContributorTier"
    - from: "src/index.ts"
      to: "src/routes/slack-commands.ts"
      via: "mounts slash command route on /webhooks/slack/commands"
      pattern: "createSlackCommandRoutes"
---

<objective>
Wire contributor profiles into the review pipeline and mount the slash command route -- the integration plan that makes profiles actually affect behavior.

Purpose: This plan connects all the pieces: profile lookup in review flow, 4-tier prompt adaptation, incremental expertise updates, identity suggestion DMs, and slash command route mounting.
Output: Working end-to-end flow from profile lookup through adapted review prompts.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/98-contributor-profiles-identity-linking/98-CONTEXT.md
@.planning/phases/98-contributor-profiles-identity-linking/98-RESEARCH.md
@.planning/phases/98-contributor-profiles-identity-linking/98-01-SUMMARY.md
@.planning/phases/98-contributor-profiles-identity-linking/98-02-SUMMARY.md
@.planning/phases/98-contributor-profiles-identity-linking/98-03-SUMMARY.md

@src/execution/review-prompt.ts (buildAuthorExperienceSection to enhance)
@src/handlers/review.ts (resolveAuthorTier to enhance, review handler to wire)
@src/lib/author-classifier.ts (legacy classifier — becomes fallback)
@src/index.ts (route mounting)
@src/slack/client.ts (Slack client for DM suggestions)

<interfaces>
<!-- Key types and contracts from prior plans -->

From src/lib/author-classifier.ts:
```typescript
export type AuthorTier = "first-time" | "regular" | "core";
export function classifyAuthor(params: {
  authorAssociation: string;
  prCount?: number | null;
}): AuthorClassification;
```

From src/execution/review-prompt.ts (lines 262-301):
```typescript
export function buildAuthorExperienceSection(params: {
  tier: AuthorTier;
  authorLogin: string;
}): string {
  // Currently handles "first-time", "core", "regular" (empty string)
}
```

From src/handlers/review.ts (line 585):
```typescript
async function resolveAuthorTier(params: {
  authorLogin: string;
  authorAssociation: string;
  repo: string;
  owner: string;
  repoSlug: string;
  octokit: ...;
  knowledgeStore: KnowledgeStore;
  searchCache?: SearchCache<number>;
  logger: Logger;
}): Promise<{ tier: AuthorTier; prCount: number | null; ... }>
```

From src/contributor/types.ts (Plan 01):
```typescript
export type ContributorTier = "newcomer" | "developing" | "established" | "senior";
export interface ContributorProfileStore { ... }
```

From src/contributor/expertise-scorer.ts (Plan 03):
```typescript
export function updateExpertiseIncremental(params: {
  githubUsername: string;
  filesChanged: string[];
  type: "commit" | "pr_review" | "pr_authored";
  profileStore: ContributorProfileStore;
  logger: Logger;
}): Promise<void>;
```

From src/contributor/identity-matcher.ts (Plan 03):
```typescript
export function findPotentialMatches(params: {
  githubUsername: string;
  githubDisplayName: string | null;
  slackMembers: { userId: string; displayName: string; realName: string }[];
}): { slackUserId: string; displayName: string; confidence: "high" | "medium" }[];
```

From src/routes/slack-commands.ts (Plan 02):
```typescript
export function createSlackCommandRoutes(deps: SlackCommandRouteDeps): Hono;
```

From src/index.ts (line 460-471):
```typescript
app.route("/webhooks", createWebhookRoutes({ ... }));
app.route("/webhooks/slack", createSlackEventRoutes({ ... }));
app.route("/", createHealthRoutes({ ... }));
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance review prompt and author tier resolution with 4-tier profile-aware behavior</name>
  <files>
    src/execution/review-prompt.ts
    src/lib/author-classifier.ts
    src/handlers/review.ts
  </files>
  <action>
    **1. Update `src/lib/author-classifier.ts`:**

    Add `ContributorTier` to the `AuthorTier` type union to support the new tiers while keeping backward compat:
    ```typescript
    export type AuthorTier = "first-time" | "regular" | "core" | "newcomer" | "developing" | "established" | "senior";
    ```
    The legacy `classifyAuthor()` function is unchanged — it still returns the 3 original tiers. The new tiers come from the contributor profile system.

    **2. Update `src/execution/review-prompt.ts` — enhance `buildAuthorExperienceSection`:**

    The function signature changes to accept optional expertise data:
    ```typescript
    export function buildAuthorExperienceSection(params: {
      tier: AuthorTier;
      authorLogin: string;
      areaExpertise?: { dimension: string; topic: string; score: number }[];
    }): string {
    ```

    Add handling for the 4 new tiers. Map legacy tiers to new behavior as fallback:
    - `"first-time"` and `"newcomer"` -> newcomer prompt
    - `"regular"` and `"developing"` -> developing prompt (new)
    - `"established"` -> established prompt (new)
    - `"core"` and `"senior"` -> senior prompt

    **Newcomer prompt** (enhanced from existing first-time):
    Same as current first-time block but add: "When suggesting fixes, include a brief code example if the pattern might be unfamiliar."

    **Developing prompt** (new):
    ```
    ## Author Experience Context

    The PR author ({authorLogin}) is a developing contributor with growing familiarity in this area.

    - Provide moderate explanation — mention WHY for non-obvious issues, skip for basic ones
    - Include doc links for project-specific patterns but not general language features
    - Use a balanced, collaborative tone
    - Comment on both style concerns and substantive issues
    ```

    **Established prompt** (new):
    ```
    ## Author Experience Context

    The PR author ({authorLogin}) is an established contributor.

    - Keep explanations brief — one sentence on WHY, then the suggestion
    - Skip style-only nitpicks unless they violate project conventions
    - Focus on correctness and maintainability over pedagogy
    ```

    **Senior prompt** (enhanced from existing core):
    Same as current core block but add:
    - "Focus on architecture and design, not syntax or style"
    - "Use peer-to-peer tone: direct, brief, no hedging"
    - If areaExpertise is provided and author has score >= 0.7 in a relevant area, add: "The author has deep expertise in {topics}. Only flag issues you're highly confident about."

    **3. Update `src/handlers/review.ts` — enhance `resolveAuthorTier`:**

    Add `contributorProfileStore?: ContributorProfileStore` to the params. The flow becomes:

    1. **Try profile store first** (if provided):
       ```typescript
       if (contributorProfileStore) {
         try {
           const profile = await contributorProfileStore.getByGithubUsername(authorLogin);
           if (profile) {
             const expertise = await contributorProfileStore.getExpertise(profile.id);
             return {
               tier: profile.overallTier as AuthorTier,
               prCount: null,
               fromCache: false,
               searchCacheHit: false,
               searchEnrichment: { degraded: false, retryAttempts: 0, skippedQueries: 0, degradationPath: "none" },
               expertise, // NEW field added to return type
             };
           }
         } catch (err) {
           logger.warn({ err, authorLogin }, "Contributor profile lookup failed (fail-open)");
         }
       }
       ```
    2. **Fall through to existing logic** (author_cache + GitHub search + classifyAuthor) — completely unchanged
    3. Add `expertise?: ContributorExpertise[]` to the return type (optional, only present when profile found)

    Where `resolveAuthorTier` is called (~line 1799), pass the new `contributorProfileStore` parameter.

    Where `buildAuthorExperienceSection` is called (~line 1667), pass the expertise data:
    ```typescript
    const authorExpSection = buildAuthorExperienceSection({
      tier: authorClassification.tier,
      authorLogin: pr.user.login,
      areaExpertise: authorClassification.expertise?.map(e => ({
        dimension: e.dimension,
        topic: e.topic,
        score: e.score,
      })),
    });
    ```

    **4. Add fire-and-forget incremental expertise update in review handler:**

    After review completes successfully (near the telemetry section), add:
    ```typescript
    if (contributorProfileStore) {
      updateExpertiseIncremental({
        githubUsername: pr.user.login,
        filesChanged: reviewFiles,
        type: "pr_authored",
        profileStore: contributorProfileStore,
        logger,
      }).catch((err) => logger.warn({ err }, "Contributor expertise update failed (non-blocking)"));
    }
    ```

    Import `updateExpertiseIncremental` from `../contributor/expertise-scorer.ts`.

    **All profile store usage MUST be fail-open:** wrapped in try/catch, logging warnings, falling through to legacy behavior. This is consistent with the project's fail-open philosophy.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bunx tsc --noEmit src/execution/review-prompt.ts src/handlers/review.ts src/lib/author-classifier.ts</automated>
  </verify>
  <done>Review prompts adapt to 4 tiers with area-aware expertise. Profile store is checked first with fail-open fallback to legacy classifyAuthor. Incremental expertise update fires after each review.</done>
</task>

<task type="auto">
  <name>Task 2: Mount slash command route and wire profile store into app entry</name>
  <files>
    src/index.ts
    src/contributor/index.ts
  </files>
  <action>
    **1. Update `src/index.ts`:**

    Add imports:
    ```typescript
    import { createContributorProfileStore } from "./contributor/index.ts";
    import { createSlackCommandRoutes } from "./routes/slack-commands.ts";
    ```

    After the database client and store creation section (near where `knowledgeStore` is created), create the contributor profile store:
    ```typescript
    const contributorProfileStore = createContributorProfileStore({ sql, logger });
    ```

    Mount the slash command route after the existing Slack events route:
    ```typescript
    app.route("/webhooks/slack/commands", createSlackCommandRoutes({
      config,
      logger,
      profileStore: contributorProfileStore,
    }));
    ```

    Pass `contributorProfileStore` to the review handler. Find where `handlePullRequestReview` (or the review executor/handler) is instantiated and add `contributorProfileStore` to its dependencies. This follows the existing dependency injection pattern — the review handler already receives `knowledgeStore`, `octokit`, etc.

    **2. Update `src/contributor/index.ts`:**

    Ensure barrel exports include all modules from Plans 01-03:
    ```typescript
    export * from "./types.ts";
    export * from "./profile-store.ts";
    export * from "./expertise-scorer.ts";
    export * from "./tier-calculator.ts";
    export * from "./identity-matcher.ts";
    ```

    **3. Identity suggestion DMs (PROF-02 heuristic suggestions):**

    In the review handler, after `resolveAuthorTier` falls through to legacy classification (meaning no profile exists), add an optional identity suggestion check:
    ```typescript
    // If contributor has no profile and Slack is configured, check for potential matches
    if (!authorClassification.expertise && config.slack?.botToken) {
      // Fire-and-forget: suggest identity linking via DM
      suggestIdentityLink({
        githubUsername: pr.user.login,
        githubDisplayName: pr.user.name ?? null,
        slackBotToken: config.slack.botToken,
        profileStore: contributorProfileStore,
        logger,
      }).catch((err) => logger.warn({ err }, "Identity suggestion check failed (non-blocking)"));
    }
    ```

    Create a private `suggestIdentityLink` function in the review handler (or in a separate file imported into the handler):
    1. Fetch Slack workspace members: `fetch("https://slack.com/api/users.list", { headers: { authorization: "Bearer " + token } })` — cache the member list for 1 hour in a module-level Map to avoid hammering Slack
    2. Call `findPotentialMatches()` from identity-matcher
    3. If matches found (confidence "high" only), open a DM: `fetch("https://slack.com/api/conversations.open", ...)` then `fetch("https://slack.com/api/chat.postMessage", ...)`
    4. DM text: "I noticed GitHub user `{username}` submitted a PR. Their profile looks similar to yours. You can link your accounts with `/kodiai link {username}` to get personalized code reviews."
    5. Only suggest once per GitHub username (track in a module-level Set to avoid repeated DMs). Reset set on app restart (acceptable for v1).

    This is fail-open and fire-and-forget — any Slack API error is logged and ignored. If `im:write` or `users:read` scopes are missing, the Slack API will return an error and the suggestion silently fails.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bunx tsc --noEmit src/index.ts</automated>
  </verify>
  <done>Slash command route mounted at /webhooks/slack/commands. Profile store injected into review handler. Identity suggestion DMs fire for unlinked contributors. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes for entire project
- Slash command route responds at /webhooks/slack/commands
- Review handler uses profile-based tier when available, falls back to legacy
- Author experience prompt sections adapt for all 4 tiers
- Incremental expertise updates fire after review completion
- Identity suggestion DMs are fire-and-forget with fail-open error handling
</verification>

<success_criteria>
- Senior contributors get terse, architecture-focused reviews (PROF-04)
- Newcomers get explanatory reviews with WHY reasoning (PROF-04)
- Developing and established tiers have distinct prompt behavior (PROF-04)
- Contributors without profiles get legacy behavior (backward compat)
- All profile interactions are fail-open (never block review)
- Slash command route is accessible (PROF-02)
- Identity suggestions sent as DMs for high-confidence matches (PROF-02)
</success_criteria>

<output>
After completion, create `.planning/phases/98-contributor-profiles-identity-linking/98-04-SUMMARY.md`
</output>
