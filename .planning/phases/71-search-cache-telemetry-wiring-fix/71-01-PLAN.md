---
phase: 71-search-cache-telemetry-wiring-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Rate-limit telemetry cacheHitRate reflects Search API cache hit/miss outcomes from author-tier enrichment, not author classification cache state"
    - "Phase 66 Search cache signals are propagated into Phase 67 telemetry writes with deterministic semantics across miss, hit, and fail-open fallback paths"
    - "Regression tests fail if telemetry wiring is reverted to non-Search cache signals"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Author-tier enrichment result includes deterministic Search cache-hit signal and telemetry emits cacheHitRate from that signal"
      contains: "cacheHitRate"
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for telemetry cacheHitRate on Search cache miss/hit and author-cache-hit non-signal paths"
      contains: "recordRateLimitEvent"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/search-cache.ts"
      via: "resolveAuthorTier derives Search cache-hit signal from getOrLoad execution path"
      pattern: "getOrLoad"
    - from: "src/handlers/review.ts"
      to: "telemetryStore.recordRateLimitEvent"
      via: "cacheHitRate assignment uses Search cache-hit signal, not author classification cache flag"
      pattern: "recordRateLimitEvent\(|cacheHitRate"
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/review.ts"
      via: "tests assert telemetry payload values for miss, hit, and fail-open scenarios"
      pattern: "cacheHitRate"
---

<objective>
Close OPS-03 blocker gaps by rewiring cache-hit telemetry to the actual Search API cache behavior from author-tier enrichment.

Purpose: The v0.12 audit found Phase 67 telemetry using author classification cache flags instead of Phase 66 Search cache outcomes, making operator cache metrics incorrect for rate-limit tuning.
Output: Deterministic telemetry wiring where cacheHitRate is produced from Search cache hit/miss outcomes, plus regression tests that lock the wiring against future drift.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/v0.12-MILESTONE-AUDIT.md
@.planning/phases/66-search-cache-foundation/66-02-SUMMARY.md
@.planning/phases/67-rate-limit-resilience-telemetry/67-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Propagate deterministic Search cache-hit signal through author-tier enrichment</name>
  <files>src/handlers/review.ts</files>
  <action>
Update the `resolveAuthorTier` enrichment contract so Search cache behavior is tracked explicitly and independently from author classification cache state:

- Keep existing author-classification cache behavior (`knowledgeStore.getAuthorCache`) intact for classification performance, but do not use it as the Search cache signal.
- In the Search path (`issuesAndPullRequests` lookup), derive a deterministic per-execution `searchCacheHit` signal from actual cache outcome semantics (hit when the invocation is served from existing cache/in-flight de-duplication without executing a fresh loader call; miss when loader executes).
- Ensure fail-open paths remain unchanged: cache integration faults still fall back to direct Search lookup, and `searchCacheHit` is recorded as miss in fallback/direct paths.
- Preserve carry-forward behavior constraints: deterministic telemetry behavior and fail-open resilience must remain intact.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000` after wiring changes.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
`resolveAuthorTier` returns a Search-specific cache-hit signal with deterministic miss/hit semantics, while author classification cache behavior and fail-open fallback continue to work as before.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire OPS-03 telemetry cacheHitRate to Search cache signal</name>
  <files>src/handlers/review.ts</files>
  <action>
Change rate-limit telemetry emission to use the Search cache signal propagated from Task 1:

- Replace `cacheHitRate` derivation from `authorClassification.fromCache` with the new Search cache-hit field.
- Keep existing `retryAttempts`, `skippedQueries`, and `degradationPath` wiring unchanged unless required for consistency with the new signal.
- Maintain non-blocking telemetry semantics: telemetry write failures must remain fail-open and must not block review execution.
- Do not modify unrelated review policies (no unsolicited responses, no auto re-review on push).
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Telemetry `recordRateLimitEvent` writes `cacheHitRate` from Search cache outcomes only, with deterministic values and unchanged fail-open write behavior.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests that fail on non-Search telemetry wiring</name>
  <files>src/handlers/review.test.ts</files>
  <action>
Extend review-handler telemetry regressions to explicitly guard this integration boundary:

- Add/adjust a test where author classification cache is hit (`fromCache: true`) but no Search cache hit occurs, and assert `cacheHitRate` remains miss (proves telemetry is not keyed to author cache).
- Add/adjust a Search cache reuse scenario (two equivalent events) that captures telemetry for each event and asserts first event miss then subsequent event hit based on Search cache behavior.
- Keep or extend fail-open regression to confirm cache integration faults/direct lookup paths still produce deterministic miss telemetry and continue execution.
- Keep assertions deterministic and local (no network dependence), matching the repo's current test style.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bun test`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Regression suite fails if cacheHitRate wiring is switched back to author-classification cache flags and passes when Search cache telemetry propagation is correct.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts --timeout 30000` passes with explicit Search cache miss/hit telemetry assertions.
- `bun test` passes without regressions.
- `bunx tsc --noEmit` passes.
- Test suite demonstrates that author cache hits do not drive telemetry cacheHitRate and Search cache hits do.
</verification>

<success_criteria>
OPS-03 is satisfied for phase 71: cacheHitRate is derived from Search cache outcomes in enrichment flows, the phase 66 signal is propagated into phase 67 telemetry writes deterministically, and tests prevent regression to non-Search cache signals.
</success_criteria>

<output>
After completion, create `.planning/phases/71-search-cache-telemetry-wiring-fix/71-01-SUMMARY.md`
</output>
