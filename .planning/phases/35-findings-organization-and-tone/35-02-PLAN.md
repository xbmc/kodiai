---
phase: 35-findings-organization-and-tone
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Sanitizer validates ### Impact and ### Preference subsections under ## Observations instead of ### Critical/Major/Medium/Minor"
    - "Sanitizer validates severity-tagged finding lines: [SEVERITY] path (lines): title format"
    - "### Impact is required in Observations; ### Preference is optional"
    - "CRITICAL or MAJOR findings in Preference trigger a warning log but do not reject the review"
    - "Finding lines without a severity tag prefix are rejected by the sanitizer"
  artifacts:
    - path: "src/execution/mcp/comment-server.ts"
      provides: "Updated sanitizeKodiaiReviewSummary with Impact/Preference validation and severity-tagged issue lines"
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Comprehensive tests for Impact/Preference sanitizer validation"
  key_links:
    - from: "src/execution/mcp/comment-server.ts"
      to: "sanitizeKodiaiReviewSummary"
      via: "Impact/Preference subsection detection and severity-tagged issue line regex"
      pattern: "### Impact|### Preference|\\[CRITICAL\\]"
---

<objective>
Update sanitizeKodiaiReviewSummary() to validate the new Impact/Preference Observations structure with inline severity tags, replacing the Phase 34 severity sub-heading validation.

Purpose: Server-side validation ensures Claude's output follows the Impact/Preference structure with proper severity tags (FORMAT-06, FORMAT-18).
Output: Updated sanitizer and comprehensive tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-findings-organization-and-tone/35-RESEARCH.md
@.planning/phases/34-structured-review-template/34-02-SUMMARY.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/comment-server.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update sanitizeKodiaiReviewSummary for Impact/Preference validation with severity-tagged finding lines</name>
  <files>src/execution/mcp/comment-server.ts</files>
  <action>
In `sanitizeKodiaiReviewSummary()` inside `src/execution/mcp/comment-server.ts`, update the Observations validation section (~lines 177-263):

1. **Replace the validSeverities set** (~line 188):
   - OLD: `const validSeverities = new Set(["### Critical", "### Major", "### Medium", "### Minor"]);`
   - NEW: `const validSubsections = new Set(["### Impact", "### Preference"]);`

2. **Update the issue line regex** (~line 193) to require a severity tag prefix:
   - OLD: `const issueLineRe = new RegExp(\`^(.+?) \\\\((?:${lineSpec})\\\\): (.+)$\`);`
   - NEW: `const issueLineRe = new RegExp(\`^\\\\[(CRITICAL|MAJOR|MEDIUM|MINOR)\\\\] (.+?) \\\\((?:${lineSpec})\\\\): (.+)$\`);`
   - Also add a flexible variant that strips bold markers before matching: before testing with `issueLineRe`, strip `**` from the line. This handles Claude formatting `**[CRITICAL]**` with bold.

3. **Rewrite the Observations line-by-line validation loop** to use the new subsection headings:
   - Track `currentSubsection` (string | undefined) instead of `currentSeverity`.
   - When a line matches a `validSubsections` entry, set `currentSubsection` and mark `foundSubsection = true`.
   - Track validation state as a state machine with these states and transitions:
     **INTRO** (initial state after subsection heading) -> allow any non-heading, non-severity-tagged lines as introductory/descriptive text.
     **ISSUE** -> entered when the first severity-tagged line (`[SEVERITY] path (lines): title`) is detected. After each ISSUE line, transition to EXPLANATION.
     **EXPLANATION** (required after each ISSUE) -> the next non-empty, non-heading line is the explanation. After EXPLANATION, transition back to ISSUE (expecting next finding) or END (next subsection heading or end of Observations).
     Transition from INTRO to ISSUE occurs on the first line matching the severity tag regex. Once in ISSUE/EXPLANATION alternation, non-conforming lines (not a severity-tagged issue, not an explanation, not a blank separator) should trigger a validation error.
   - After each issue line, expect an explanation line (any non-empty, non-heading text). Blank lines between finding pairs (issue+explanation) are allowed as separators.
   - If the line is under `### Preference` and the severity tag is `CRITICAL` or `MAJOR`, log a warning: `console.warn("Preference finding with ${severity} severity -- expected MEDIUM or MINOR")`. Do NOT throw an error (soft check per research recommendation).

4. **Update the "no severity found" error** (~line 258):
   - OLD: `"Invalid Kodiai review summary: Observations must contain at least one severity sub-heading (### Critical, ### Major, ### Medium, ### Minor)"`
   - NEW: `"Invalid Kodiai review summary: Observations must contain ### Impact subsection with at least one severity-tagged finding"`

5. **Update all error messages** that reference `currentSeverity` to reference `currentSubsection` instead.

6. **Handle introductory text** between a subsection heading and the first issue line gracefully -- allow non-issue, non-heading lines as descriptive text before the first finding. This accommodates Claude potentially adding a brief description like "Findings about correctness and security:" before listing issues.

IMPORTANT: The five-section validation (section presence, ordering, verdict format) is UNCHANGED. Only the Observations content validation changes.
  </action>
  <verify>
    Run `bun test src/execution/mcp/comment-server.test.ts` -- existing tests will need format updates (issue lines need `[SEVERITY]` prefix, `### Critical` headings become `### Impact`). Update existing tests as needed.
    Run `bun typecheck` -- no TypeScript errors.
  </verify>
  <done>
    - sanitizeKodiaiReviewSummary validates ### Impact (required) and ### Preference (optional) subsections
    - Issue lines require [SEVERITY] prefix in the format: [CRITICAL] path (lines): title
    - CRITICAL/MAJOR in Preference logs a warning but does not throw
    - All existing sanitizer tests updated and passing with new format
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive sanitizer tests for Impact/Preference validation</name>
  <files>src/execution/mcp/comment-server.test.ts</files>
  <action>
Update the existing `buildTestSummary()` helper and add new test cases in `src/execution/mcp/comment-server.test.ts`:

1. **Update `buildTestSummary()` helper** to generate the new format:
   - Replace `### Critical` / `### Major` etc. with `### Impact` / `### Preference`
   - Update issue lines to include severity tags: `[CRITICAL] path/to/file.ts (123, 456): issue title`
   - The helper should accept parameters for Impact findings and optionally Preference findings

2. **Update existing tests** that reference the old severity sub-heading format to use the new Impact/Preference + severity tag format.

3. **Add new test cases** in the sanitizer describe block:

   a. **Valid: Impact-only (no Preference)** -- summary with ### Impact containing [MAJOR] finding, no ### Preference section. Should pass.

   b. **Valid: Impact + Preference** -- summary with ### Impact containing [CRITICAL] finding and ### Preference containing [MINOR] finding. Should pass.

   c. **Valid: Multiple findings under Impact** -- two [MAJOR] and one [MEDIUM] finding under ### Impact. Should pass.

   d. **Rejects missing Impact subsection** -- summary with ### Preference but no ### Impact under Observations. Should throw "must contain ### Impact".

   e. **Rejects finding without severity tag** -- issue line `path/to/file.ts (123): title` without `[SEVERITY]` prefix. Should throw error.

   f. **Rejects invalid severity tag** -- `[HIGH] path/to/file.ts (123): title` should be rejected (HIGH is not a valid severity).

   g. **Rejects old severity sub-headings** -- `### Critical` under Observations should not be treated as a valid subsection. Should throw error about missing Impact.

   h. **Allows intro text before first finding** -- text between `### Impact` and first `[SEVERITY] ...` line should be tolerated.

   i. **Missing explanation after finding** -- a severity-tagged issue line with no following explanation should throw error.

   j. **Severity cap warning (soft check)** -- `### Preference` with a `[MAJOR]` finding should pass without throwing (soft warning only). Verify no error is thrown.

   k. **Valid with bold-stripped severity tag** -- `**[CRITICAL]** path/to/file.ts (123): title` should be accepted (bold stripping).

   l. **Verdict, section order, and other validations unchanged** -- verify that section ordering, verdict format, and extra heading rejection still work as before (these should already be covered by existing tests but run them to confirm).

Use the existing `buildTestSummary()` helper pattern for constructing test bodies. Add at least 10 new test cases.
  </action>
  <verify>
    Run `bun test src/execution/mcp/comment-server.test.ts` -- all tests pass.
    Count new test cases: at least 10 new tests in the sanitizer describe block.
  </verify>
  <done>
    - 10+ new test cases covering Impact/Preference validation, severity-tagged finding lines, missing subsections, invalid tags, intro text tolerance, severity cap soft check, bold-stripping
    - All existing tests updated and passing
    - buildTestSummary() helper generates new format
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/mcp/comment-server.test.ts` passes with all tests
- `bun typecheck` has no errors in modified files
- Sanitizer accepts the new Impact/Preference + severity tag format
- Sanitizer rejects the old severity sub-heading format (### Critical, ### Major, etc.)
- Sanitizer rejects finding lines missing severity tag prefix
- CRITICAL/MAJOR in Preference is a soft warning, not a hard error
- Five-section template validation (section presence, ordering, verdict) is unchanged
</verification>

<success_criteria>
All sanitizer tests pass. The sanitizer validates: (1) ### Impact required, ### Preference optional under Observations, (2) finding lines use [SEVERITY] prefix format, (3) explanation lines follow each finding, (4) severity caps are soft-checked. Phase 34 section validation (presence, ordering, verdict) remains intact.
</success_criteria>

<output>
After completion, create `.planning/phases/35-findings-organization-and-tone/35-02-SUMMARY.md`
</output>
