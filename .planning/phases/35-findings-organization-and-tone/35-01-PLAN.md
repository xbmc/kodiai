---
phase: 35-findings-organization-and-tone
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Observations section template instructs Claude to split findings into ### Impact and ### Preference subsections"
    - "Each finding in the template uses inline severity tags: [CRITICAL], [MAJOR], [MEDIUM], [MINOR]"
    - "PR intent scoping instructions tell Claude to scope findings to the PR's stated intent from title, description, labels, and branch"
    - "Tone guidelines instruct Claude to use concrete language (causes X when Y) and avoid hedged possibilities"
    - "Stabilizing language guidelines instruct Claude to call out low-risk changes with preserves existing behavior, backward compatible, minimal impact"
    - "PR labels are threaded from the handler through to the prompt builder when available"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Impact/Preference Observations template, PR intent scoping, tone guidelines, stabilizing language, prLabels support"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for Impact/Preference template, PR intent scoping, tone guidelines, prLabels"
    - path: "src/handlers/review.ts"
      provides: "PR labels extraction and threading to buildReviewPrompt"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "prLabels parameter in buildReviewPrompt() call"
      pattern: "prLabels"
    - from: "src/execution/review-prompt.ts"
      to: "prompt output"
      via: "Impact/Preference subsections in Observations template"
      pattern: "### Impact|### Preference"
---

<objective>
Rewrite the standard-mode Observations section prompt from severity-only grouping to Impact/Preference subsections with inline severity tags. Add PR intent scoping instructions, tone/language guidelines, and stabilizing language rules. Thread PR labels from the handler to the prompt builder.

Purpose: Findings are categorized by real impact vs preference, scoped to PR intent, and expressed with specific low-drama language (FORMAT-06, FORMAT-07, FORMAT-08, FORMAT-17, FORMAT-18).
Output: Updated prompt template, handler threading, and comprehensive tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-findings-organization-and-tone/35-RESEARCH.md
@.planning/phases/34-structured-review-template/34-01-SUMMARY.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Observations template, add PR intent scoping and tone guidelines, thread PR labels</name>
  <files>src/execution/review-prompt.ts, src/handlers/review.ts</files>
  <action>
In `src/execution/review-prompt.ts`:

1. **Add `prLabels?: string[]` to the `buildReviewPrompt()` context interface** (the parameter object type at ~line 637).

2. **Add PR labels to the context header** (after the `Branches:` line, ~line 706):
   - If `context.prLabels` is defined and has length > 0, push `Labels: ${context.prLabels.join(", ")}`.
   - If labels are empty or undefined, do NOT add a `Labels:` line (avoid `Labels: (none)`).

3. **Replace the Observations section template** in the standard-mode summary comment section (~lines 890-907). The canonical finding format uses INLINE severity tags on the same line as the file path (see RESEARCH.md lines 66-71): `[SEVERITY] path/to/file.ts (lines): <issue title>`. Severity is NOT a separate heading or its own line -- it is a prefix on the finding line itself. Replace:
   ```
   "## Observations",
   "",
   "### Critical",
   "path/to/file.ts (123, 456): <issue title>",
   ...
   "### Minor",
   ...
   ```
   With the new Impact/Preference template:
   ```
   "## Observations",
   "",
   "### Impact",
   "<findings about correctness, security, performance, error handling, resource management, concurrency>",
   "",
   "[CRITICAL] path/to/file.ts (123, 456): <issue title>",
   "<concrete condition and consequence: 'causes X when Y'>",
   "",
   "[MAJOR] path/to/file.ts (789): <issue title>",
   "<concrete condition and consequence>",
   "",
   "### Preference",
   "<optional findings about style, naming, code organization>",
   "",
   "[MINOR] path/to/file.ts (101): <issue title>",
   "Optional: <specific suggestion with actionable language>",
   ```
   Each finding line MUST follow this exact inline format: `[SEVERITY] path (lines): title` -- the severity tag is the first token on the line, followed by space, then path, then parenthesized line numbers, then colon, then title. Do NOT use severity as a heading level or standalone line.

4. **Update the hard requirements section** (~lines 919-929). Replace the Observations hard requirement:
   - OLD: `"- Under ## Observations, use ### severity sub-headings (Critical, Major, Medium, Minor) -- only include sub-headings for severities that have findings"`
   - NEW: `"- Under ## Observations, use ### Impact and ### Preference subsections. ### Impact is REQUIRED; ### Preference is optional (omit if no preference findings). Each finding line starts with a severity tag: [CRITICAL], [MAJOR], [MEDIUM], or [MINOR]"`
   - ADD: `"- CRITICAL and MAJOR findings MUST go under ### Impact. Preference findings are capped at MEDIUM severity"`
   - ADD: `"- Prefix Preference findings with 'Optional:' to signal they are non-blocking"`

5. **Add a PR Intent Scoping section** as a new prompt section. Insert it after the noise suppression section (~line 819) and before the path instructions section. Create a helper function `buildPrIntentScopingSection(prTitle: string, prLabels: string[], headBranch: string): string` that returns:
   ```
   ## PR Intent Scoping

   Before classifying findings, identify this PR's primary intent from:
   - Title and description
   - Labels (if present): <labels>
   - Branch: <headBranch>

   Scope findings to the PR's stated intent:
   - CI/test fix: Focus on test reliability and correctness. Style issues go to Preference only.
   - Performance: Focus on resource usage, complexity. Documentation issues go to Preference only.
   - Refactor: Focus on behavior preservation. Note "preserves existing behavior" for safe changes.
   - Bug fix: Focus on fix correctness, edge cases. Unrelated style goes to Preference only.
   - Feature: Full review scope -- all categories apply.

   Findings outside the PR's intent belong in Preference unless CRITICAL severity.
   Do NOT judge a narrowly-scoped PR against an imagined ideal version of the code.
   ```
   Include the Labels line ONLY if prLabels has entries. Omit it entirely otherwise.
   Call this function in the prompt builder and push the result to lines (only if non-empty, which it always will be since title/branch are always present).

6. **Add a Tone and Language Guidelines section** as a new prompt section. Insert after PR Intent Scoping. Create a helper function `buildToneGuidelinesSection(): string` that returns:
   ```
   ## Finding Language Guidelines

   Every finding must be specific about WHAT happens, WHEN it happens, and WHY it matters.

   Use concrete language:
   - "causes [specific issue] when [specific condition]"
   - "[CRITICAL] Null pointer dereference when `user` is undefined"
   - "Optional: Extract `retryWithBackoff()` to reduce duplication"

   Do NOT use hedged or vague language:
   - "could potentially cause issues"
   - "consider refactoring"
   - "this might have problems"
   - "there may be an issue here"

   For low-risk changes, use stabilizing language:
   - "preserves existing behavior" -- for refactors that don't change output
   - "backward compatible" -- for API changes that don't break callers
   - "minimal impact" -- for changes with small blast radius

   Prefix Preference findings with "Optional:" to signal they are non-blocking.
   ```
   Call this function in the prompt builder and push the result to lines.

7. **In `src/handlers/review.ts`**, extract PR labels from the payload and pass to `buildReviewPrompt()`:
   - At the call site (~line 1270), add label extraction: `const prLabels = (pr.labels as Array<{ name: string }> | undefined)?.map((l) => l.name) ?? [];`
   - Add `prLabels` to the `buildReviewPrompt()` call object (after `outputLanguage`).

IMPORTANT: Do NOT modify the existing inline comment format instructions (buildModeInstructions). Phase 35 only changes the SUMMARY comment Observations section and adds prompt sections. The enhanced-mode summary comment section (which says "do NOT post a top-level summary comment") is also unchanged.
  </action>
  <verify>
    Run `bun test src/execution/review-prompt.test.ts` -- all existing tests pass (they may need updates if they assert on the old Observations format; update them to match the new Impact/Preference format).
    Run `bun typecheck` or `bunx tsc --noEmit` -- no TypeScript errors.
    Grep for `### Impact` and `### Preference` in the prompt output.
    Grep for `prLabels` in review.ts to confirm threading.
  </verify>
  <done>
    - buildReviewPrompt() generates Observations section with ### Impact and ### Preference subsections and inline severity tags
    - PR intent scoping section appears in the prompt with title, labels (when present), and branch
    - Tone guidelines section appears in the prompt with concrete language examples and stabilizing language
    - PR labels are extracted in review.ts handler and passed to buildReviewPrompt()
    - All existing tests pass (updated if needed for new format)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for Impact/Preference template, PR intent scoping, tone guidelines, and PR labels</name>
  <files>src/execution/review-prompt.test.ts</files>
  <action>
Add a new describe block in `src/execution/review-prompt.test.ts` for Phase 35 changes. Tests to add:

1. **Impact/Preference template presence:** Call `buildReviewPrompt()` with standard mode. Assert the output contains `### Impact` and `### Preference` in that order. Assert it does NOT contain `### Critical` or `### Major` or `### Medium` or `### Minor` as standalone subsection headings.

2. **Severity tags in template:** Assert the prompt output contains `[CRITICAL]`, `[MAJOR]`, `[MEDIUM]`, `[MINOR]` as severity tag examples within the Observations section.

3. **Impact required, Preference optional rule:** Assert the hard requirements section contains text about `### Impact` being required and `### Preference` being optional.

4. **Severity cap rule:** Assert the hard requirements section contains text about CRITICAL/MAJOR findings belonging under Impact, and Preference capped at MEDIUM.

5. **PR intent scoping section present:** Call `buildReviewPrompt()` with standard mode. Assert the output contains `## PR Intent Scoping`.

6. **PR labels in prompt when provided:** Call `buildReviewPrompt()` with `prLabels: ["bug", "ci-fix"]`. Assert the output contains `Labels: bug, ci-fix`.

7. **PR labels omitted when empty:** Call `buildReviewPrompt()` with `prLabels: []`. Assert the output does NOT contain `Labels:`.

8. **PR labels omitted when undefined:** Call `buildReviewPrompt()` without `prLabels`. Assert the output does NOT contain `Labels:`.

9. **Tone guidelines section present:** Assert the output contains `## Finding Language Guidelines`.

10. **Tone guidelines contain stabilizing language:** Assert the output contains `preserves existing behavior`, `backward compatible`, and `minimal impact`.

11. **Tone guidelines contain anti-patterns:** Assert the output contains `could potentially` (as a DO NOT example).

12. **buildPrIntentScopingSection helper:** Test the exported helper directly if possible, or test via buildReviewPrompt output: verify it includes branch name and scoping rules.

Use the existing test patterns in the file (the `buildReviewPrompt({...defaultContext})` pattern) for consistency. The default context should use `mode: "standard"` (which is the default).
  </action>
  <verify>
    Run `bun test src/execution/review-prompt.test.ts` -- all tests pass including new ones.
    Verify at least 10 new test cases were added.
  </verify>
  <done>
    - 10+ new test cases covering Impact/Preference template, severity tags, PR intent scoping, PR labels threading, tone guidelines, and stabilizing language
    - All existing and new tests pass
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/review-prompt.test.ts` passes with all tests
- `bun typecheck` has no errors in modified files
- Standard-mode prompt contains `### Impact` and `### Preference` subsections under `## Observations`
- Standard-mode prompt contains `## PR Intent Scoping` section
- Standard-mode prompt contains `## Finding Language Guidelines` section
- PR labels appear in the prompt when provided, are omitted when empty/undefined
- Enhanced-mode prompt is NOT changed (still says "Do NOT post a top-level summary comment")
- The old severity sub-heading format (`### Critical`, `### Major`, etc.) no longer appears in the standard-mode template
</verification>

<success_criteria>
All tests pass. The prompt instructs Claude to: (1) split Observations into Impact/Preference, (2) use inline severity tags, (3) scope findings to PR intent, (4) use concrete low-drama language, (5) use stabilizing language for low-risk changes. PR labels flow from the handler to the prompt.
</success_criteria>

<output>
After completion, create `.planning/phases/35-findings-organization-and-tone/35-01-SUMMARY.md`
</output>
