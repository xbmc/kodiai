---
phase: 08-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Dockerfile
  - .dockerignore
autonomous: true

must_haves:
  truths:
    - "docker build completes successfully with no errors"
    - "The built image contains only production dependencies and application source (no devDependencies, tmp/, .planning/, .git/)"
    - "The container runs as non-root user 'bun'"
    - "git is available inside the container"
    - "The health endpoint responds inside the container"
  artifacts:
    - path: "Dockerfile"
      provides: "Multi-stage Docker build for Bun application"
      contains: "FROM oven/bun:1-alpine"
    - path: ".dockerignore"
      provides: "Excludes development files from Docker context"
      contains: "node_modules"
  key_links:
    - from: "Dockerfile"
      to: "src/index.ts"
      via: "CMD bun run src/index.ts"
      pattern: "CMD.*bun.*src/index.ts"
    - from: "Dockerfile"
      to: "package.json"
      via: "COPY for dependency install"
      pattern: "COPY package.json bun.lock"
---

<objective>
Create the Dockerfile and .dockerignore for the kodiai application, then verify the image builds and runs correctly locally.

Purpose: The application needs a Docker container for deployment to Azure Container Apps. The Dockerfile uses a multi-stage build with `oven/bun:1-alpine` to keep the image small while including all runtime dependencies (git for workspace cloning, production node_modules including the bundled Claude CLI via agent-sdk).

Output: A buildable Dockerfile and .dockerignore at project root. The image is verified to build and the health endpoint responds.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment/08-RESEARCH.md
@src/index.ts
@src/config.ts
@src/routes/health.ts
@package.json
@tsconfig.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile and .dockerignore</name>
  <files>Dockerfile, .dockerignore</files>
  <action>
Create a multi-stage Dockerfile at the project root:

**Stage 1 (deps):** `FROM oven/bun:1-alpine AS deps`
- WORKDIR /app
- COPY package.json bun.lock
- RUN bun install --production --frozen-lockfile

**Stage 2 (production):** `FROM oven/bun:1-alpine`
- RUN apk add --no-cache git
- WORKDIR /app
- COPY --from=deps /app/node_modules ./node_modules
- COPY package.json bun.lock tsconfig.json ./
- COPY src/ ./src/
- USER bun
- EXPOSE 3000
- CMD ["bun", "run", "src/index.ts"]

Key decisions from research:
- No Claude CLI installation needed -- agent-sdk bundles cli.js (resolved at runtime)
- git is required for workspace manager's git clone operations
- USER bun for non-root security (oven/bun images include this user)
- Only COPY src/, package.json, bun.lock, tsconfig.json -- no tmp/, .planning/, .git/, CLAUDE.md, etc.
- Multi-stage build excludes devDependencies (@types/bun, @types/js-yaml, etc.)

Create .dockerignore at the project root with these entries:
```
node_modules
.git
.gitignore
tmp/
.planning/
*.md
!package.json
.env
.env.*
Dockerfile
.dockerignore
plan.md
.idea
coverage
out
dist
```

The .dockerignore excludes node_modules (rebuilt in Docker), .git (large, not needed), tmp/ (reference code repos), .planning/ (planning docs), markdown files (except package.json which isn't .md), .env files (secrets), and the Dockerfile itself.
  </action>
  <verify>
Verify files exist and have expected content:
- `ls -la Dockerfile .dockerignore` -- both files exist
- Dockerfile contains `FROM oven/bun:1-alpine` (grep)
- Dockerfile contains `USER bun` (grep)
- Dockerfile contains `apk add --no-cache git` (grep)
- .dockerignore contains `node_modules` and `tmp/` and `.planning/` (grep)
  </verify>
  <done>
Dockerfile and .dockerignore exist at project root with correct multi-stage build structure and exclusion rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Docker image and verify health endpoint</name>
  <files>Dockerfile</files>
  <action>
Build the Docker image locally and verify it works:

1. Run `docker build -t kodiai:local .` from the project root. This validates:
   - bun.lock is in sync with package.json (--frozen-lockfile)
   - All COPY paths resolve correctly
   - git installs on Alpine
   - The image builds without errors

2. Verify the image properties:
   - `docker images kodiai:local` -- confirm image exists and note size
   - `docker run --rm kodiai:local whoami` -- should output "bun" (non-root user)
   - `docker run --rm kodiai:local git --version` -- should output git version (confirms git is installed)

3. Do NOT attempt to run the full server (it requires GITHUB_APP_ID, GITHUB_PRIVATE_KEY, GITHUB_WEBHOOK_SECRET which aren't available). The build verification + user/git checks are sufficient for this plan. Full end-to-end testing happens in Plan 02 after Azure deployment.

If the build fails due to frozen-lockfile mismatch, run `bun install` locally to regenerate bun.lock, then rebuild. If Alpine/musl causes issues with any dependency, switch the base image to `oven/bun:1-debian-slim` and replace `apk add --no-cache git` with `apt-get update && apt-get install -y --no-install-recommends git && rm -rf /var/lib/apt/lists/*`.
  </action>
  <verify>
- `docker build -t kodiai:local .` exits with code 0
- `docker images kodiai:local --format '{{.Size}}'` shows a reasonable size (expect ~200-400MB)
- `docker run --rm kodiai:local whoami` outputs "bun"
- `docker run --rm kodiai:local git --version` outputs a git version string
  </verify>
  <done>
Docker image builds successfully, runs as non-root "bun" user, and has git available. Image is ready for push to a container registry.
  </done>
</task>

</tasks>

<verification>
- Dockerfile exists at project root with multi-stage build using oven/bun:1-alpine
- .dockerignore exists and excludes development-only files
- `docker build -t kodiai:local .` succeeds
- Container runs as non-root user "bun"
- git is available inside the container
</verification>

<success_criteria>
The kodiai application builds as a Docker image using `oven/bun:1-alpine` with multi-stage build. The image contains only production dependencies, runs as non-root, and includes git. The build completes without errors.
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment/08-01-SUMMARY.md`
</output>
