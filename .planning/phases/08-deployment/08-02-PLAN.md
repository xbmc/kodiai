---
phase: 08-deployment
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - deploy.sh
autonomous: false
user_setup:
  - service: azure
    why: "Container hosting and secrets management"
    env_vars:
      - name: GITHUB_APP_ID
        source: "GitHub App settings page -> App ID"
      - name: GITHUB_PRIVATE_KEY
        source: "GitHub App settings -> Generate a private key -> base64-encode the .pem file"
      - name: GITHUB_WEBHOOK_SECRET
        source: "GitHub App settings -> Webhook secret (you chose this during app creation)"
      - name: CLAUDE_CODE_OAUTH_TOKEN
        source: "Run `claude setup-token` locally, complete OAuth flow, copy the sk-ant-oat01-... token"
    dashboard_config:
      - task: "Log in to Azure CLI: az login"
        location: "Terminal"
      - task: "Register GitHub App with required permissions"
        location: "GitHub Settings -> Developer settings -> GitHub Apps -> New GitHub App"
  - service: github
    why: "GitHub App registration for webhook events"
    env_vars: []
    dashboard_config:
      - task: "Create GitHub App with: name 'kodiai', webhook URL = Container App FQDN + /webhooks/github, permissions (contents:write, issues:write, pull_requests:write, actions:read, metadata:read, checks:read), events (issue_comment, issues, pull_request, pull_request_review, pull_request_review_comment)"
        location: "GitHub Settings -> Developer settings -> GitHub Apps -> New GitHub App"

must_haves:
  truths:
    - "A deployment script exists that provisions all Azure resources and deploys the container"
    - "The script creates ACR, managed identity, Container Apps environment, and the container app with secrets"
    - "Health probes are configured for /health (liveness) and /readiness (readiness)"
    - "The container runs with min-replicas 1 to avoid webhook timeouts from cold starts"
    - "All 4 required secrets are injected as environment variables via Azure secretref"
  artifacts:
    - path: "deploy.sh"
      provides: "Azure Container Apps provisioning and deployment script"
      contains: "az containerapp create"
  key_links:
    - from: "deploy.sh"
      to: "Dockerfile"
      via: "az acr build uses Dockerfile to build image"
      pattern: "az acr build"
    - from: "deploy.sh"
      to: "src/routes/health.ts"
      via: "Health probe paths /health and /readiness"
      pattern: "/health.*Liveness"
---

<objective>
Create a deployment script for Azure Container Apps and guide the user through provisioning, GitHub App registration, and end-to-end verification.

Purpose: The application needs to run in production on Azure Container Apps with proper secrets management, health probes, and external ingress so GitHub can deliver webhooks.

Output: A `deploy.sh` script at project root, Azure resources provisioned, and the application running and receiving webhooks.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-deployment/08-RESEARCH.md
@.planning/phases/08-deployment/08-01-SUMMARY.md
@src/config.ts
@src/routes/health.ts
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Azure deployment script</name>
  <files>deploy.sh</files>
  <action>
Create `deploy.sh` at the project root. The script provisions all Azure resources and deploys the container. It should be idempotent (safe to re-run) and use `set -euo pipefail` for safety.

The script must:

1. **Configuration variables** at the top (user can customize):
   - RESOURCE_GROUP="rg-kodiai"
   - LOCATION="eastus"
   - ENVIRONMENT="cae-kodiai"
   - APP_NAME="ca-kodiai"
   - ACR_NAME="kodiairegistry" (must be globally unique, alphanumeric only)
   - IDENTITY_NAME="id-kodiai"

2. **Require 4 environment variables** (fail with clear message if missing):
   - GITHUB_APP_ID
   - GITHUB_PRIVATE_KEY_BASE64 (base64-encoded PEM -- NOT raw PEM, because az CLI mangles newlines)
   - GITHUB_WEBHOOK_SECRET
   - CLAUDE_CODE_OAUTH_TOKEN

3. **Azure resource provisioning:**
   - az extension add --name containerapp --upgrade -y
   - az provider register --namespace Microsoft.App --wait
   - az provider register --namespace Microsoft.OperationalInsights --wait
   - az group create --name $RESOURCE_GROUP --location "$LOCATION"
   - az acr create --resource-group $RESOURCE_GROUP --name $ACR_NAME --sku Basic --location "$LOCATION"
   - az identity create --name $IDENTITY_NAME --resource-group $RESOURCE_GROUP
   - Grant AcrPull role to the managed identity on the ACR

4. **Build and push image:**
   - az acr build --registry $ACR_NAME --image kodiai:latest .
   (Uses remote build on ACR -- no local Docker needed for this step)

5. **Create Container Apps environment:**
   - az containerapp env create --name $ENVIRONMENT --resource-group $RESOURCE_GROUP --location "$LOCATION"

6. **Deploy container app:**
   - az containerapp create with:
     - --image "$ACR_NAME.azurecr.io/kodiai:latest"
     - --user-assigned managed identity
     - --registry-server and --registry-identity for ACR auth
     - --target-port 3000 --ingress external
     - --min-replicas 1 --max-replicas 1
     - --secrets for all 4 sensitive values (GITHUB_PRIVATE_KEY uses the base64-encoded value)
     - --env-vars mapping each secret via secretref:, plus PORT=3000 and LOG_LEVEL=info
     - --query properties.configuration.ingress.fqdn to output the URL

7. **Configure health probes** using `az containerapp update --yaml` with a YAML snippet:
   - Liveness: GET /health port 3000, initialDelay 5s, period 30s, failureThreshold 3
   - Readiness: GET /readiness port 3000, initialDelay 10s, period 10s, failureThreshold 3
   - Startup: GET /health port 3000, initialDelay 3s, period 3s, failureThreshold 30

8. **Print the FQDN** at the end with a message like:
   "Deployment complete! Your webhook URL is: https://{FQDN}/webhooks/github"
   "Configure this URL in your GitHub App settings."

Make the script executable: `chmod +x deploy.sh`.

Important notes in script comments:
- GITHUB_PRIVATE_KEY_BASE64: "Base64-encode your PEM: base64 -w0 < private-key.pem"
- The app's loadPrivateKey() handles base64 decoding automatically
- min-replicas 1 prevents webhook timeouts from cold starts
- ACR_NAME must be globally unique and alphanumeric
  </action>
  <verify>
- `ls -la deploy.sh` -- file exists and is executable
- `grep 'set -euo pipefail' deploy.sh` -- safety flags present
- `grep 'az containerapp create' deploy.sh` -- creates container app
- `grep 'secretref:' deploy.sh` -- secrets are referenced correctly
- `grep '/health' deploy.sh` -- health probes configured
- `grep 'min-replicas 1' deploy.sh` -- always-on for webhooks
- `grep 'GITHUB_PRIVATE_KEY_BASE64' deploy.sh` -- requires base64 key
- `bash -n deploy.sh` -- script has valid syntax
  </verify>
  <done>
deploy.sh exists at project root, is executable, has valid bash syntax, and contains all Azure provisioning commands with secrets management and health probes.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>Deployment script (deploy.sh) that provisions Azure Container Apps with secrets, health probes, and external ingress.</what-built>
  <action>
The following steps require your manual intervention because they involve authentication and account-level actions that cannot be automated:

**Step 1: Azure CLI Login**
```bash
az login
```
Follow the browser prompt to authenticate.

**Step 2: Register GitHub App** (if not already done)
Go to: GitHub Settings -> Developer settings -> GitHub Apps -> New GitHub App

Configure:
- **App name:** kodiai
- **Homepage URL:** https://github.com/your-org/kodiai
- **Webhook URL:** Leave blank for now (you'll update after deployment)
- **Webhook secret:** Generate a strong secret, save it
- **Permissions:**
  - Repository: Contents (Read & Write), Issues (Read & Write), Pull requests (Read & Write), Actions (Read), Metadata (Read), Checks (Read)
- **Events:** issue_comment, issues, pull_request, pull_request_review, pull_request_review_comment
- Generate a private key (downloads .pem file)
- Note the App ID from the settings page

**Step 3: Get Claude OAuth Token**
```bash
claude setup-token
```
Complete the OAuth flow in your browser. Copy the `sk-ant-oat01-...` token.

**Step 4: Set environment variables and run deploy.sh**
```bash
export GITHUB_APP_ID="your-app-id"
export GITHUB_PRIVATE_KEY_BASE64="$(base64 -w0 < /path/to/private-key.pem)"
export GITHUB_WEBHOOK_SECRET="your-webhook-secret"
export CLAUDE_CODE_OAUTH_TOKEN="sk-ant-oat01-..."
./deploy.sh
```

**Step 5: Update GitHub App webhook URL**
The deploy script prints the FQDN. Go back to the GitHub App settings and set the webhook URL to:
`https://{FQDN}/webhooks/github`

**Step 6: Install the GitHub App** on a test repository
Go to the GitHub App settings -> Install App -> Select a repository

  </action>
  <resume-signal>Type "deployed" with the Container App FQDN, or describe any issues encountered</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete kodiai deployment on Azure Container Apps with GitHub App integration.</what-built>
  <how-to-verify>
1. **Health check:** Visit `https://{FQDN}/health` in browser -- should return `{"status":"ok"}`
2. **Readiness check:** Visit `https://{FQDN}/readiness` -- should return `{"status":"ready"}`
3. **End-to-end test:** Open a PR on the installed test repository. Within 2 minutes, kodiai should post inline review comments (or silently approve if the PR is clean).
4. **Mention test:** Comment `@kodiai what does this file do?` on the PR. The bot should reply with a tracking comment that updates with the response.
5. Check Azure Container Apps logs for any errors: `az containerapp logs show --name ca-kodiai --resource-group rg-kodiai --follow`
  </how-to-verify>
  <resume-signal>Type "approved" if the end-to-end flow works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- deploy.sh exists, is executable, and has valid bash syntax
- Script provisions: resource group, ACR, managed identity, Container Apps environment, container app
- Container app has 4 secrets injected via secretref
- Health probes configured for /health and /readiness
- min-replicas 1 ensures always-on for webhook reception
- Ingress is external on port 3000
- End-to-end: PR opens -> review comments appear
</verification>

<success_criteria>
The application is deployed to Azure Container Apps. Health endpoints respond. A real PR opened on an installed repository triggers a review and inline comments appear. The deployment is reproducible via deploy.sh.
</success_criteria>

<output>
After completion, create `.planning/phases/08-deployment/08-02-SUMMARY.md`
</output>
