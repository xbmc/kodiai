---
phase: 15-write-pipeline
plan: 01
type: execute
wave: 1
depends_on:
  - 14-write-mode-foundations/14-01-SUMMARY.md
files_modified:
  - src/execution/executor.ts
  - src/execution/types.ts
  - src/execution/mcp/index.ts
  - src/jobs/workspace.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Writes still require explicit write intent and write.enabled=true"
    - "Write-mode can modify files in the workspace without granting the model git push privileges"
    - "When changes are produced, Kodiai opens a PR on the base repo and replies with the PR link"
    - "No token leaks to logs/errors during push failures"
  artifacts:
    - path: src/execution/executor.ts
      provides: "write-mode allows edit tools; non-write mode remains read-only"
    - path: src/jobs/workspace.ts
      provides: "helper to create branch/commit/push with token-redacted errors"
    - path: src/handlers/mention.ts
      provides: "write intent + enabled => run edit-only execution then publish PR link"
---

<objective>
Enable mention-driven changes end-to-end by letting the model edit files, while keeping branch/commit/push/PR creation in trusted code.

This phase does NOT add broad policy guardrails (path allow/deny, secret scanning) beyond existing safety primitives; those are Phase 16.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Add write-mode execution flag + tool gating</name>
  <files>src/execution/types.ts src/execution/executor.ts src/execution/mcp/index.ts</files>
  <action>
  - Extend ExecutionContext with a write-mode flag.
  - When write-mode is enabled, allow file edit tools (Edit/Write/MultiEdit).
  - In write-mode, disable GitHub publish tools (comment/review tools) so the model edits only.
  - Non-write-mode behavior remains unchanged.
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  Write-mode sessions can edit files but cannot publish directly to GitHub.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workspace helper to branch/commit/push safely</name>
  <files>src/jobs/workspace.ts</files>
  <action>
  Add a helper that:
  - creates a deterministic branch name (validated)
  - stages changes, commits, and pushes to origin
  - redacts installation tokens from any thrown errors (origin URL contains token)
  </action>
  <verify>
  - Unit tests via mention handler pipeline tests (no network)
  </verify>
  <done>
  Trusted code can publish a branch without token leakage.
  </done>
</task>

<task type="auto">
  <name>Task 3: Mention-driven PR creation pipeline</name>
  <files>src/handlers/mention.ts src/handlers/mention.test.ts</files>
  <action>
  For write-intent mentions when config.write.enabled=true:
  - run executor in write-mode (edit-only)
  - if changes exist, commit/push a branch and open a PR via Octokit
  - reply to the triggering surface with the PR URL

  If no PR context (issue-only mention), refuse with a concise message.
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  A write-intent mention results in a PR link (or a clear refusal) with no model-side GitHub publishing.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<output>
After completion, create `.planning/phases/15-write-pipeline/15-01-SUMMARY.md`
</output>
