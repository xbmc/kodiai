---
phase: 27-context-aware-reviews
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/execution/diff-analysis.ts
  - src/execution/diff-analysis.test.ts
autonomous: true

must_haves:
  truths:
    - "pathInstructions field accepts array of {path, instructions} objects with string or string[] path and defaults to empty array"
    - "profile field accepts 'strict', 'balanced', or 'minimal' and is optional"
    - "fileCategories field accepts optional category override maps (source, test, config, docs, infra)"
    - "Invalid pathInstructions/profile/fileCategories values fall back to defaults via section-level fallback"
    - "analyzeDiff classifies files into source/test/config/docs/infra categories using default patterns"
    - "analyzeDiff detects path-based risk signals (auth, dependencies, infra, schema)"
    - "analyzeDiff computes metrics (totalFiles, linesAdded, linesRemoved, hunksCount)"
    - "analyzeDiff respects file count cap and marks large PRs"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Extended reviewSchema with pathInstructions, profile, fileCategories"
      contains: "pathInstructions"
    - path: "src/execution/config.test.ts"
      provides: "Tests for new config fields"
      contains: "pathInstructions"
    - path: "src/execution/diff-analysis.ts"
      provides: "Deterministic diff analysis pure functions"
      exports: ["analyzeDiff", "DiffAnalysis", "DiffAnalysisInput"]
    - path: "src/execution/diff-analysis.test.ts"
      provides: "Tests for diff analysis module"
      contains: "analyzeDiff"
  key_links:
    - from: "src/execution/config.ts"
      to: "src/execution/diff-analysis.ts"
      via: "fileCategories config type used as override input"
      pattern: "fileCategories"
---

<objective>
Add config schema fields for path-scoped instructions, profile presets, and file category overrides. Create deterministic diff analysis module as a pure function.

Purpose: Establish the data model and analysis engine that Plan 02 will wire into the review prompt and handler.
Output: Extended config schema with tests, new diff-analysis.ts module with tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-context-aware-reviews/27-RESEARCH.md
@.planning/phases/26-review-mode-severity-control/26-01-SUMMARY.md
@src/execution/config.ts
@src/execution/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pathInstructions, profile, and fileCategories to config schema</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
Extend reviewSchema in `src/execution/config.ts` with three new fields. Follow the exact pattern used by the Phase 26 fields (additive, with defaults, section-level fallback).

**pathInstructions field:**
```typescript
const pathInstructionSchema = z.object({
  path: z.union([z.string(), z.array(z.string())]),
  instructions: z.string(),
});
```
Add to reviewSchema: `pathInstructions: z.array(pathInstructionSchema).default([])`.

**profile field:**
Add to reviewSchema: `profile: z.enum(["strict", "balanced", "minimal"]).optional()`.

**fileCategories field:**
```typescript
fileCategories: z.object({
  source: z.array(z.string()).optional(),
  test: z.array(z.string()).optional(),
  config: z.array(z.string()).optional(),
  docs: z.array(z.string()).optional(),
  infra: z.array(z.string()).optional(),
}).optional(),
```

Update the reviewSchema default object to include `pathInstructions: []` (profile and fileCategories are optional so they do not need defaults in the explicit defaults block).

**Tests** (in config.test.ts): Add tests for:
1. pathInstructions with single string path parses correctly
2. pathInstructions with array of string paths parses correctly
3. pathInstructions defaults to empty array when omitted
4. profile accepts "strict", "balanced", "minimal"
5. profile is optional (omitting it produces undefined)
6. fileCategories with custom patterns parses correctly
7. fileCategories is optional (omitting it produces undefined)
8. Invalid pathInstructions (e.g., missing instructions field) falls back to defaults via section-level fallback
9. All three new fields coexist with existing Phase 26 review fields
  </action>
  <verify>Run `bun test src/execution/config.test.ts` -- all existing tests pass plus 9+ new tests pass.</verify>
  <done>reviewSchema exports pathInstructions (array, default []), profile (optional enum), fileCategories (optional object). All config tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create deterministic diff analysis module</name>
  <files>src/execution/diff-analysis.ts, src/execution/diff-analysis.test.ts</files>
  <action>
Create `src/execution/diff-analysis.ts` as a pure function module with NO side effects and NO git commands. The caller provides raw data, the module returns structured analysis.

**Types to export:**
```typescript
export interface DiffAnalysisInput {
  changedFiles: string[];
  numstatLines: string[];       // Output of `git diff --numstat`
  diffContent?: string;         // Full diff text (optional, for content-based risk signals)
  fileCategories?: Record<string, string[]>;  // User overrides from config
}

export interface DiffAnalysis {
  filesByCategory: Record<string, string[]>;
  riskSignals: string[];
  metrics: {
    totalFiles: number;
    totalLinesAdded: number;
    totalLinesRemoved: number;
    hunksCount: number;
  };
  isLargePR: boolean;
}
```

**Default file category patterns** (use picomatch for matching):
- `test`: `["**/*.test.*", "**/*.spec.*", "**/__tests__/**", "**/test/**", "**/tests/**"]`
- `config`: `["**/*.json", "**/*.yml", "**/*.yaml", "**/*.toml", "**/tsconfig*", "**/.eslintrc*", "**/.prettierrc*", "**/jest.config*", "**/vite.config*", "**/webpack.config*"]`
- `docs`: `["**/*.md", "**/*.txt", "**/*.rst", "**/LICENSE*", "**/CHANGELOG*"]`
- `infra`: `["**/Dockerfile*", "**/.github/**", "**/terraform/**", "**/pulumi/**", "**/.gitlab-ci*", "**/Jenkinsfile*", "**/deploy*"]`
- `source`: everything else (default/catch-all -- files not matching any above category)

User `fileCategories` overrides are **additive** -- user patterns are added to defaults for that category.

**Path-based risk signal patterns** (always run):
- Auth/security: `["**/auth*", "**/login*", "**/session*", "**/token*", "**/jwt*", "**/oauth*"]` -> "Modifies authentication/authorization code"
- Credentials: `["**/password*", "**/secret*", "**/credential*", "**/api?key*", "**/*.pem", "**/*.key"]` -> "Touches credential/secret-related files"
- Dependencies: `["package.json", "package-lock.json", "yarn.lock", "pnpm-lock.yaml", "go.mod", "go.sum", "Cargo.toml", "Cargo.lock", "requirements.txt", "Pipfile.lock", "Gemfile.lock"]` -> "Modifies dependency manifest"
- CI/CD: `["**/Dockerfile*", "**/.github/**", "**/terraform/**", "**/deploy*"]` -> "Changes CI/CD or infrastructure configuration"
- Schema: `["**/*migration*", "**/*schema*"]` -> "Modifies database schema or migrations"

**Content-based risk signals** (only when `diffContent` is provided and total content < 50KB):
- Error handling: `/(?:try\s*\{|catch\s*\(|\.catch\(|panic\(|recover\()/i` -> "Modifies error handling logic"
- Crypto: `/(?:crypto|encrypt|decrypt|hash|sign|verify|bcrypt|argon)/i` -> "Touches cryptographic code"

**numstat parsing:** Parse tab-delimited lines (`added\tremoved\tpath`). Binary files show `-` for counts, treat as 0.

**Hunk count:** If `diffContent` is provided, count `@@` markers (`/^@@/gm`). Otherwise report 0.

**Performance boundaries:**
- File count cap: 200 files (constant `MAX_ANALYSIS_FILES`). If exceeded, only analyze first 200 files for categories and risk signals. Set `isLargePR = true`.
- Skip content-based risk scanning if diffContent length > 50KB.
- `isLargePR` is true when changedFiles.length > 200 OR totalLinesAdded + totalLinesRemoved > 5000.

Export `analyzeDiff(input: DiffAnalysisInput): DiffAnalysis` and the `DEFAULT_FILE_CATEGORIES` constant (so Plan 02 can reference it if needed).

**Tests** (in diff-analysis.test.ts): Write tests for:
1. Empty input returns empty categories, no risk signals, zero metrics
2. Source files categorized correctly (e.g., `src/app.ts` -> source)
3. Test files categorized correctly (e.g., `src/app.test.ts` -> test)
4. Config files categorized correctly (e.g., `package.json` -> config)
5. Docs files categorized correctly (e.g., `README.md` -> docs)
6. Infra files categorized correctly (e.g., `Dockerfile` -> infra)
7. User fileCategory overrides are additive (custom pattern added to defaults)
8. Path-based risk signal detection (auth file triggers auth signal)
9. Dependency risk signal (package.json change detected)
10. numstat parsing produces correct metrics
11. Hunk count from diffContent `@@` markers
12. Content-based risk signals detected when diffContent provided
13. Content-based risk signals skipped when diffContent > 50KB
14. Large PR detection (>200 files or >5000 lines)
15. Files beyond cap are still counted in metrics but not classified
  </action>
  <verify>Run `bun test src/execution/diff-analysis.test.ts` -- all 15+ tests pass. Run `bun test` -- all project tests pass.</verify>
  <done>diff-analysis.ts exports analyzeDiff() pure function and DiffAnalysis/DiffAnalysisInput types. All tests pass including full project suite.</done>
</task>

</tasks>

<verification>
1. `bun test src/execution/config.test.ts` -- all tests pass including new pathInstructions/profile/fileCategories tests
2. `bun test src/execution/diff-analysis.test.ts` -- all tests pass
3. `bun test` -- full project test suite passes (no regressions)
4. `grep -c "pathInstructions" src/execution/config.ts` -- field exists in schema
5. `grep -c "analyzeDiff" src/execution/diff-analysis.ts` -- function exists
</verification>

<success_criteria>
- reviewSchema has pathInstructions, profile, fileCategories fields with correct types and defaults
- diff-analysis.ts is a pure function module with zero side effects
- File categorization works with defaults and user overrides
- Risk signals detected from path patterns and diff content
- Metrics computed from numstat output
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-context-aware-reviews/27-01-SUMMARY.md`
</output>
