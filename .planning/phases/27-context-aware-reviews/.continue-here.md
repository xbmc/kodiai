---
phase: 27-context-aware-reviews
plan: 0
total_plans: 2
status: planning_complete
last_updated: 2026-02-12T01:47:17.664Z
---

<current_state>
Phase 27 (Context-Aware Reviews) planning is complete with verification passed. Ready to execute 2 plans across 2 waves.

Session completed the full /gsd:plan-phase workflow:
1. Research phase completed (27-RESEARCH.md written by researcher agent)
2. Planning phase completed (27-01-PLAN.md and 27-02-PLAN.md written by planner agent)
3. Verification phase completed (plan-checker agent verified all plans - VERIFICATION PASSED)

No execution has started yet. All plans are ready to run via /gsd:execute-phase.
</current_state>

<completed_work>

**Research (Wave 0):**
- ✓ Spawned gsd-phase-researcher agent (Opus model)
- ✓ Research complete with HIGH confidence
- ✓ Key findings documented:
  - picomatch negation verified locally (`!` prefix with scan().negated pattern)
  - No new dependencies required (picomatch, zod, js-yaml already installed)
  - Profile presets are thin layer over Phase 26 config fields
  - Diff analysis is pure function pattern
  - Config schema follows CodeRabbit's cumulative matching pattern

**Planning (Wave 1):**
- ✓ Spawned gsd-planner agent (Opus model)
- ✓ Planning complete with 2 plans in 2 waves
- ✓ Plan 27-01: Config schema + diff analysis module (Wave 1, autonomous)
- ✓ Plan 27-02: Prompt enrichment + handler wiring (Wave 2, depends on 27-01, autonomous)

**Verification (Wave 2):**
- ✓ Spawned gsd-plan-checker agent (Sonnet model)
- ✓ Verification PASSED - all checks passed
- ✓ Coverage verified: All 4 requirements (CTX-01 through CTX-04) covered
- ✓ Context compliance verified: All locked decisions honored
- ✓ Scope sanity verified: 2 tasks/plan, 3-4 files/plan, ~75% total context budget

</completed_work>

<remaining_work>

**Execution (next step):**
- [ ] Execute Plan 27-01 (Wave 1): Config schema extension + diff analysis module
  - Task 1: Add pathInstructions, profile, fileCategories to config schema
  - Task 2: Create deterministic diff analysis module
- [ ] Execute Plan 27-02 (Wave 2): Prompt enrichment + handler wiring
  - Task 1: Add path instruction matching and prompt enrichment sections
  - Task 2: Wire diff analysis, path matching, and profile resolution in handler

**Post-execution:**
- [ ] Verify phase goal achievement via /gsd:verify-work
- [ ] Move to Phase 28 or mark v0.4 milestone progress

</remaining_work>

<decisions_made>

**From Phase Context (27-CONTEXT.md):**
1. **Path instruction matching**: Support `!` prefix for exclusions, cumulative matching (all matching entries apply)
2. **Config structure**: Array of `{path, instructions}` objects (per CodeRabbit pattern)
3. **File categorization**: Hybrid with sensible defaults + user overrides (additive)
4. **Risk signals**: Auth/security, dependencies, error handling (plus extras: credentials, CI/CD, schema, crypto)
5. **Performance boundaries**: 200 file cap + 50KB content limit + 5000 line large PR threshold
6. **Prompt formatting**: Group by pattern with inline file list (3000-char budget), structured summary for diff analysis
7. **Analysis metadata**: Implicit context only - NO meta-commentary about what analysis was performed

**From Research (27-RESEARCH.md):**
- Confirmed picomatch negation pattern: Use `scan().negated` to separate include/exclude, compile separately, AND logic
- Confirmed no new dependencies needed
- Confirmed profile preset implementation: thin mapping layer to existing Phase 26 fields

**From Planning (27-01-PLAN.md, 27-02-PLAN.md):**
- Wave structure: 27-01 (foundation) → 27-02 (wiring)
- Profile resolution order: defaults → profile preset → explicit config
- Profile definitions: strict (minor/15/[]/[]), balanced (medium/7/[]/[style]), minimal (major/3/[]/[style,docs])

</decisions_made>

<blockers>
None. All verification passed, plans ready to execute.
</blockers>

<context>

**What we're building:**
Phase 27 enables context-aware reviews through three mechanisms:
1. **Path-scoped instructions**: Different review rules per directory (e.g., stricter security checks for `src/api/**`)
2. **Profile presets**: Named bundles (strict/balanced/minimal) that configure severity/comment limits/focus areas
3. **Deterministic diff analysis**: Pre-LLM file classification + risk signal detection to enrich review prompt

**The approach:**
- Plan 27-01 (Wave 1): Extend config schema + create pure function diff analyzer
- Plan 27-02 (Wave 2): Build prompt enrichment functions + wire everything in handler

**Why this matters:**
- Reviews will adapt to repo-specific conventions without manual configuration
- Risk signals (auth changes, new dependencies) trigger focused attention
- Profile presets make it easy to choose strictness level
- Diff analysis is deterministic (no extra LLM cost) and fast (200 file cap, 50KB content limit)

**The mental model:**
Think of Phase 27 as "prompt enrichment pipeline":
1. Handler runs diff analysis (deterministic, pre-LLM)
2. Handler matches path instructions against changed files (picomatch with negation)
3. Handler resolves profile preset to config defaults
4. Handler passes enriched context to buildReviewPrompt
5. Prompt builder inserts two new sections: "Change Context" (diff analysis) and "Path-Specific Review Instructions"
6. Claude gets smarter context, produces more targeted findings

**Phase dependencies:**
- Builds on Phase 26 config schema (review.mode, review.severity, review.focusAreas)
- Consumed by Phase 28 (knowledge store will use diff analysis categories)
- No changes to existing review behavior unless user opts in via new config fields

</context>

<next_action>
Start execution with:

```
/gsd:execute-phase 27
```

This will:
1. Execute Plan 27-01 in Wave 1 (config schema + diff analysis module)
2. Wait for 27-01 completion
3. Execute Plan 27-02 in Wave 2 (prompt enrichment + handler wiring)
4. Run full test suite verification
5. Create phase completion summary

Alternative: Review plans first with `cat .planning/phases/27-context-aware-reviews/*-PLAN.md`

Recommended: Run `/clear` first to start with fresh context window (planning consumed ~50K tokens).
</next_action>
