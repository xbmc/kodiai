---
phase: 27-context-aware-reviews
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Live PR review no longer fails with git exit 128 when shallow clone history lacks a merge base"
    - "Changed-file extraction for path instruction matching still runs and produces a deterministic file list"
    - "Diff analysis context (numstat/full diff) remains available or degrades gracefully with explicit logs"
    - "Path-scoped instructions can be applied on the same PR shape that previously failed (#38-like shallow ancestry)"
    - "Backward compatibility remains: repositories without Phase 27 config still complete review flow"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Resilient diff collection that handles shallow clone ancestry before triple-dot usage"
      contains: "git diff origin/${pr.base.ref}...HEAD"
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for shallow-history/no-merge-base diff handling"
      contains: "no merge base"
  key_links:
    - from: "src/handlers/review.ts"
      to: "git fetch origin"
      via: "adaptive deepen or base-history fetch before diff"
      pattern: "--deepen|--unshallow|merge-base"
    - from: "src/handlers/review.ts"
      to: "matchPathInstructions"
      via: "changedFiles list still produced after resilient diff strategy"
      pattern: "matchPathInstructions"
    - from: "src/handlers/review.ts"
      to: "analyzeDiff"
      via: "numstat/full diff collection uses same resilient base strategy"
      pattern: "analyzeDiff"
---

<objective>
Close the Phase 27 UAT blocker by making review diff collection resilient in shallow workspaces where `origin/base...HEAD` has no merge base.

Purpose: Restore live review execution so path instructions and diff context can run on real PRs instead of failing early with exit code 128.
Output: Hardened review handler diff strategy with regression tests proving no-merge-base scenarios still reach prompt enrichment.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-context-aware-reviews/27-UAT.md
@.planning/debug/pr38-exit-128-path-instruct.md
@.planning/phases/27-context-aware-reviews/27-01-SUMMARY.md
@.planning/phases/27-context-aware-reviews/27-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden review diff collection for shallow clone merge-base gaps</name>
  <files>src/handlers/review.ts</files>
  <action>
  Replace direct triple-dot diff usage with a resilient diff collection path that preserves Phase 27 behavior while preventing exit 128 failures.

  Implementation requirements:
  1. Add a focused helper in `review.ts` (or a tightly scoped local function) that gathers `{ changedFiles, numstatLines, diffContent }` for review processing.
  2. Before running `git diff origin/${pr.base.ref}...HEAD`, verify merge-base availability using `git merge-base origin/${pr.base.ref} HEAD`.
  3. If merge-base is missing, fetch additional base history adaptively (for example progressive `--deepen` attempts, then `--unshallow` as final recovery) and re-check merge-base.
  4. If merge-base remains unavailable after bounded retries, switch to a deterministic fallback for changed-file extraction that does not require merge-base (for example two-dot diff against fetched base tip) and continue review flow.
  5. Use the same resolved diff strategy for `--name-only`, `--numstat`, and full diff content so `matchPathInstructions` and `analyzeDiff` remain aligned to the same file set.
  6. Add structured logs capturing strategy outcome (`triple-dot`, `deepened-triple-dot`, or fallback), attempt counts, and whether merge-base was recovered.

  Constraints:
  - Keep path instruction matching semantics unchanged (ordered cumulative matches with include/exclude behavior from 27-02).
  - Keep profile resolution and prompt enrichment wiring unchanged.
  - Do not remove existing skipPaths filtering; apply it after resilient changed-file collection as today.
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts` passes with new resilience coverage.
  - `bunx tsc --noEmit` passes.
  - Code search in `src/handlers/review.ts` shows direct single-shot `diff origin/${pr.base.ref}...HEAD` calls replaced by shared resilient strategy.
  </verify>
  <done>
  Review handler no longer fails early on no-merge-base shallow clones; it either restores merge-base and uses triple-dot or falls back to a bounded deterministic strategy while still producing changed files and diff context.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for no-merge-base shallow ancestry flow</name>
  <files>src/handlers/review.test.ts</files>
  <action>
  Add targeted tests that reproduce and lock the UAT failure mode described in `.planning/debug/pr38-exit-128-path-instruct.md`.

  Required test scenarios:
  1. Build a fixture where shallow history causes `origin/main...HEAD` merge-base failure (or mock command failure equivalently at handler boundary) and assert the handler still reaches executor invocation instead of posting a generic exit-128 failure.
  2. Assert changed files are still computed and passed into prompt construction path so path-instruction matching can execute.
  3. Assert fallback/deepen decision logging is emitted with a stable gate key (for operator diagnosis).
  4. Add a backward-compat test proving review execution still works when no Phase 27 config fields are present in `.kodiai.yml`.

  Keep tests focused on behavior (flow continues, files collected, no crash), not exact git stderr text.
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts` passes.
  - `bun test` passes (no regressions across existing review handler suites).
  </verify>
  <done>
  Automated tests prove the shallow no-merge-base case no longer blocks review execution and that backward compatibility remains intact.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts`
- `bun test`
- `bunx tsc --noEmit`
- Re-run UAT scenario on xbmc/kodiai equivalent PR shape: review completes without `Failed with exit code 128` and path-instruction gating logic executes
</verification>

<success_criteria>
- Exit-128 no-merge-base failures are eliminated from the review path for shallow workspaces
- Path-scoped instruction matching receives a real changed-file set in previously failing PR topology
- Diff analysis still contributes context (or bounded graceful fallback) without aborting review execution
- Backward compatibility is preserved when new Phase 27 config fields are absent
</success_criteria>

<output>
After completion, create `.planning/phases/27-context-aware-reviews/27-03-SUMMARY.md`
</output>
