---
phase: 27-context-aware-reviews
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/diff-analysis.ts
  - src/execution/diff-analysis.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Diff analysis enforces an explicit elapsed-time budget during category and risk scanning"
    - "When time budget is exceeded, analysis degrades gracefully and returns a deterministic truncation signal"
    - "Complexity metrics shape remains stable (files touched, lines added/removed, hunk count) regardless of truncation"
    - "Regression tests cover both within-budget and exceeded-budget analyzer paths"
  artifacts:
    - path: "src/execution/diff-analysis.ts"
      provides: "Elapsed-time budget checks and graceful truncation behavior in deterministic diff analysis"
      contains: "MAX_ANALYSIS_TIME_MS"
    - path: "src/execution/diff-analysis.test.ts"
      provides: "Regression coverage for time-budget exceeded and non-exceeded analysis paths"
      contains: "time budget"
  key_links:
    - from: "src/execution/diff-analysis.ts"
      to: "analysis category/risk scanning loops"
      via: "elapsed-time guard checks before and during loop work"
      pattern: "Date\.now\(|MAX_ANALYSIS_TIME_MS"
    - from: "src/execution/diff-analysis.ts"
      to: "analyzeDiff return payload"
      via: "graceful truncation signal while preserving metrics contract"
      pattern: "truncated|time budget"
    - from: "src/execution/diff-analysis.test.ts"
      to: "src/execution/diff-analysis.ts"
      via: "deterministic tests for exceeded and non-exceeded timing paths"
      pattern: "analyzeDiff"
---

<objective>
Close the remaining Phase 27 verification gap by adding explicit elapsed-time guardrails to deterministic diff analysis.

Purpose: Enforce the locked performance boundary (time budget + file cap) so large or expensive analyses degrade predictably instead of running unbounded.
Output: Diff analysis now enforces elapsed-time limits with deterministic truncation signaling and regression tests that lock behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-context-aware-reviews/27-CONTEXT.md
@.planning/phases/27-context-aware-reviews/27-RESEARCH.md
@.planning/phases/27-context-aware-reviews/27-VERIFICATION.md
@.planning/phases/27-context-aware-reviews/27-01-SUMMARY.md
@.planning/phases/27-context-aware-reviews/27-02-SUMMARY.md
@src/execution/diff-analysis.ts
@src/execution/diff-analysis.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add elapsed-time budget enforcement and graceful truncation in diff analysis</name>
  <files>src/execution/diff-analysis.ts</files>
  <action>
  Implement explicit elapsed-time guardrails in `analyzeDiff` using a dedicated constant (for example `MAX_ANALYSIS_TIME_MS`) and consistent checks in category classification and risk scanning loops.

  Required behavior:
  1. Start timing at analysis entry and check elapsed time before and during looped work that can scale with PR size.
  2. If budget is exceeded, stop additional category/risk scanning work and return a graceful degradation signal in the analysis output.
  3. Preserve deterministic output shape and existing metric contracts (files touched, lines added/removed, hunk count) even when truncated.
  4. Keep existing locked risk signals intact (auth/security, dependency changes, error handling) when budget allows.
  5. Keep file-count and content-size caps in place; elapsed-time budget is additive, not a replacement.

  Constraints:
  - Keep the module pure (no git/shell I/O).
  - Keep prompt enrichment compatibility by emitting implicit factual context (no meta-commentary).
  </action>
  <verify>
  - `bun test src/execution/diff-analysis.test.ts` passes.
  - `bunx tsc --noEmit` passes.
  - `src/execution/diff-analysis.ts` contains explicit time budget constant and elapsed-time checks in category/risk loops.
  </verify>
  <done>
  Diff analysis enforces elapsed-time budget deterministically and degrades gracefully with a stable truncation signal while preserving metrics shape.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression coverage for time-budget exceeded and within-budget paths</name>
  <files>src/execution/diff-analysis.test.ts</files>
  <action>
  Add targeted regression tests that validate both elapsed-time code paths without flakiness.

  Required tests:
  1. A within-budget test proving normal category/risk analysis behavior remains unchanged.
  2. An exceeded-budget test proving analysis exits scanning early and returns the graceful truncation signal.
  3. Assertions that deterministic metrics shape remains present and stable in both paths.

  Use deterministic timing control (mocked clock/spies or equivalent stable harness) so tests do not depend on wall-clock variability.
  </action>
  <verify>
  - `bun test src/execution/diff-analysis.test.ts` passes with new time-budget cases.
  - `bun test` passes (no regressions).
  </verify>
  <done>
  Test suite fails if elapsed-time guardrails regress, and proves both non-exceeded and exceeded-budget paths behave as intended.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/diff-analysis.test.ts`
- `bun test`
- `bunx tsc --noEmit`
- Confirm `27-VERIFICATION` failed truth now passes by re-running verification after execution
</verification>

<success_criteria>
- Diff analyzer has explicit elapsed-time budget enforcement in addition to file/content caps
- Budget exceedance produces graceful deterministic truncation signal rather than unbounded scanning
- Metrics and return structure remain stable for downstream prompt enrichment
- Regression tests lock both within-budget and exceeded-budget behavior
</success_criteria>

<output>
After completion, create `.planning/phases/27-context-aware-reviews/27-04-SUMMARY.md`
</output>
