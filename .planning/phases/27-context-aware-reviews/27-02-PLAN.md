---
phase: 27-context-aware-reviews
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Path instructions from config are matched against changed files using picomatch with negation support and cumulative matching"
    - "Profile preset resolves to severity/maxComments/focusAreas/ignoredAreas defaults that explicit config overrides"
    - "Diff analysis runs deterministically in handler before prompt building using git diff --numstat output"
    - "Review prompt contains Change Context section with file breakdown, metrics, and risk signals"
    - "Review prompt contains Path-Specific Review Instructions section with matched instructions grouped by pattern"
    - "Path instructions section respects 3000-char budget with priority-based truncation"
    - "Unmatched files receive standard review without extra instructions"
    - "Analysis metadata is implicit only -- no meta-commentary about what analysis was performed"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "buildPathInstructionsSection, buildDiffAnalysisSection functions and extended buildReviewPrompt context"
      contains: "buildPathInstructionsSection"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for path instructions and diff analysis prompt sections"
      contains: "Path-Specific Review Instructions"
    - path: "src/handlers/review.ts"
      provides: "Diff analysis execution, path instruction matching, profile resolution, and prompt enrichment wiring"
      contains: "analyzeDiff"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/diff-analysis.ts"
      via: "import and call analyzeDiff()"
      pattern: "analyzeDiff"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "passes diffAnalysis and matchedPathInstructions to buildReviewPrompt()"
      pattern: "buildReviewPrompt"
    - from: "src/execution/review-prompt.ts"
      to: "src/execution/review-prompt.ts"
      via: "buildPathInstructionsSection and buildDiffAnalysisSection called within buildReviewPrompt"
      pattern: "buildPathInstructionsSection"
---

<objective>
Wire path instruction matching, profile preset resolution, and diff analysis into the review prompt builder and handler. Enrich the review prompt with contextual intelligence.

Purpose: Complete the context-aware review pipeline so reviews adapt to repo-specific conventions and risk patterns.
Output: Enriched review prompt with diff analysis context and path-scoped instructions, handler wiring for the complete pipeline.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-context-aware-reviews/27-RESEARCH.md
@.planning/phases/27-context-aware-reviews/27-01-SUMMARY.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/execution/diff-analysis.ts
@src/execution/config.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add path instruction matching and prompt enrichment sections to review-prompt.ts</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
Add three capabilities to `src/execution/review-prompt.ts`:

**1. Path instruction matching function** (exported for handler use):

```typescript
export interface PathInstruction {
  path: string | string[];
  instructions: string;
}

export interface MatchedInstruction {
  pattern: string | string[];
  instructions: string;
  matchedFiles: string[];
}

export function matchPathInstructions(
  pathInstructions: PathInstruction[],
  changedFiles: string[],
): MatchedInstruction[]
```

Implementation per research:
- For each pathInstruction entry, separate patterns into include/exclude using `picomatch.scan(pattern).negated`
- Include matchers: patterns without `!` prefix
- Exclude matchers: patterns with `!` prefix (strip prefix via scan().glob)
- If no include patterns (only excludes), treat as match-all
- A file matches when: ANY include matcher matches AND NO exclude matchers match
- Collect all matching instructions cumulatively (all matching entries apply, in config order)
- Only include entries with at least one matching file in results

Import picomatch (already a dependency, used in review.ts).

**2. Path instructions prompt section:**

```typescript
function buildPathInstructionsSection(
  matched: MatchedInstruction[],
  maxChars: number = 3000,
): string
```

Format:
```
## Path-Specific Review Instructions

**src/api/** (applies to: src/api/auth.ts, src/api/users.ts)
Check for security issues...

**src/db/** (applies to: src/db/queries.ts)
Check transaction handling...
```

- Group by instruction entry, list up to 5 matching files inline
- If more than 5 files match, show "(and N more)"
- Enforce `maxChars` budget: stop adding entries when limit would be exceeded
- Add truncation note: "_Note: Additional path instructions were truncated due to prompt size limits._"
- Return empty string if no matched instructions

**3. Diff analysis prompt section:**

```typescript
import type { DiffAnalysis } from "./diff-analysis.ts";

function buildDiffAnalysisSection(analysis: DiffAnalysis): string
```

Format (implicit context only -- NO meta-commentary per locked decision):
```
## Change Context

This PR modifies 12 files (+340 / -120 lines).

File breakdown:
- source: 8 file(s)
- test: 3 file(s)
- config: 1 file(s)

Pay special attention to these areas:
- Modifies authentication/authorization code
- Modifies dependency manifest
```

- Include hunk count in metrics line if > 0: "across N hunks"
- If `isLargePR`: add "This is a large PR. Focus on the most critical changes."
- Only include "File breakdown" if there are categorized files
- Only include "Pay special attention" if there are risk signals
- Return empty string if analysis has zero files

**4. Extend buildReviewPrompt context interface:**

Add optional fields to the context parameter:
```typescript
diffAnalysis?: DiffAnalysis;
matchedPathInstructions?: MatchedInstruction[];
```

Insert diff analysis section AFTER the "Changed files" list and BEFORE "Reading the code" section.
Insert path instructions section AFTER "Noise Suppression" and BEFORE "Comment Limit" section.

**Tests** (in review-prompt.test.ts): Add tests for:
1. matchPathInstructions with single glob pattern matches correct files
2. matchPathInstructions with array of patterns matches union of patterns
3. matchPathInstructions with negation pattern excludes matching files
4. matchPathInstructions with only negation patterns matches all except excluded
5. matchPathInstructions returns empty array when no files match
6. matchPathInstructions cumulative matching (file matches multiple entries)
7. buildPathInstructionsSection formats matched instructions correctly
8. buildPathInstructionsSection truncates at maxChars budget
9. buildPathInstructionsSection returns empty string for no matches
10. buildPathInstructionsSection caps file list at 5 with "(and N more)"
11. buildDiffAnalysisSection formats metrics and categories correctly
12. buildDiffAnalysisSection includes risk signals
13. buildDiffAnalysisSection adds large PR note
14. buildDiffAnalysisSection returns empty string for zero files
15. buildReviewPrompt includes diff analysis section when provided
16. buildReviewPrompt includes path instructions section when provided
17. buildReviewPrompt works without new optional fields (backward compatible)
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all existing tests pass plus 17+ new tests pass.</verify>
  <done>matchPathInstructions, buildPathInstructionsSection, buildDiffAnalysisSection are implemented and tested. buildReviewPrompt accepts optional diffAnalysis and matchedPathInstructions context.</done>
</task>

<task type="auto">
  <name>Task 2: Wire diff analysis, path matching, and profile resolution in review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
Update `src/handlers/review.ts` to run diff analysis, match path instructions, resolve profile presets, and pass everything to `buildReviewPrompt()`.

**1. Profile preset resolution** (add at top of file or as local const):

```typescript
const PROFILE_PRESETS: Record<string, {
  severityMinLevel: "critical" | "major" | "medium" | "minor";
  maxComments: number;
  ignoredAreas: string[];
  focusAreas: string[];
}> = {
  strict: {
    severityMinLevel: "minor",
    maxComments: 15,
    ignoredAreas: [],
    focusAreas: [],
  },
  balanced: {
    severityMinLevel: "medium",
    maxComments: 7,
    ignoredAreas: ["style"],
    focusAreas: [],
  },
  minimal: {
    severityMinLevel: "major",
    maxComments: 3,
    ignoredAreas: ["style", "documentation"],
    focusAreas: ["security", "correctness"],
  },
};
```

Resolution order: defaults -> profile preset -> explicit config. Explicit config values always win over profile defaults. Only apply profile defaults for fields where the user has NOT explicitly set a value (i.e., where the config value equals the schema default).

Implementation: After loading config, if `config.review.profile` is set:
- Look up the preset
- For each preset field, check if the user explicitly set it in their config. Since Zod applies defaults, we cannot distinguish "user set minor" from "default minor". Use this heuristic: if the config value matches the Zod schema default AND a profile is set, apply the profile value. If the config value differs from the schema default, keep the config value (user explicitly set it).
- Schema defaults to compare against: `severityMinLevel: "minor"`, `maxComments: 7`, `focusAreas: []`, `ignoredAreas: []`

**2. Run diff analysis** (AFTER the git diff --name-only for changed files, BEFORE buildReviewPrompt):

Add a second git command to get numstat output:
```typescript
const numstatOutput = await $`git -C ${workspace.dir} diff origin/${pr.base.ref}...HEAD --numstat`.quiet();
const numstatLines = numstatOutput.text().trim().split("\n").filter(Boolean);
```

Optionally get full diff for content-based risk signals and hunk count (only when file count <= 200):
```typescript
let diffContent: string | undefined;
if (changedFiles.length <= 200) {
  const fullDiff = await $`git -C ${workspace.dir} diff origin/${pr.base.ref}...HEAD`.quiet();
  diffContent = fullDiff.text();
}
```

Import and call `analyzeDiff`:
```typescript
import { analyzeDiff } from "../execution/diff-analysis.ts";
```

```typescript
const diffAnalysis = analyzeDiff({
  changedFiles,
  numstatLines,
  diffContent,
  fileCategories: config.review.fileCategories as Record<string, string[]> | undefined,
});
```

**3. Match path instructions** (AFTER diff analysis):

```typescript
import { matchPathInstructions } from "../execution/review-prompt.ts";
```

```typescript
const matchedPathInstructions = config.review.pathInstructions.length > 0
  ? matchPathInstructions(config.review.pathInstructions, changedFiles)
  : [];
```

**4. Update buildReviewPrompt call** to pass resolved values:

Apply profile resolution to the config values BEFORE passing to buildReviewPrompt:
```typescript
// Resolve profile defaults
let resolvedSeverityMinLevel = config.review.severity.minLevel;
let resolvedMaxComments = config.review.maxComments;
let resolvedFocusAreas = config.review.focusAreas;
let resolvedIgnoredAreas = config.review.ignoredAreas;

if (config.review.profile) {
  const preset = PROFILE_PRESETS[config.review.profile];
  if (preset) {
    // Apply preset values only where config has schema defaults
    if (resolvedSeverityMinLevel === "minor") resolvedSeverityMinLevel = preset.severityMinLevel;
    if (resolvedMaxComments === 7) resolvedMaxComments = preset.maxComments;
    if (resolvedFocusAreas.length === 0) resolvedFocusAreas = preset.focusAreas;
    if (resolvedIgnoredAreas.length === 0) resolvedIgnoredAreas = preset.ignoredAreas;
  }
}
```

Update the buildReviewPrompt call to use resolved values and add new fields:
```typescript
const reviewPrompt = buildReviewPrompt({
  // ... existing fields ...
  mode: config.review.mode,
  severityMinLevel: resolvedSeverityMinLevel,
  focusAreas: resolvedFocusAreas,
  ignoredAreas: resolvedIgnoredAreas,
  maxComments: resolvedMaxComments,
  // New Phase 27 fields
  diffAnalysis,
  matchedPathInstructions,
});
```

**5. Add logging** for the new pipeline steps:
```typescript
logger.info(
  {
    ...baseLog,
    gate: "diff-analysis",
    totalFiles: diffAnalysis.metrics.totalFiles,
    isLargePR: diffAnalysis.isLargePR,
    riskSignals: diffAnalysis.riskSignals.length,
    matchedInstructions: matchedPathInstructions.length,
    profile: config.review.profile ?? null,
  },
  "Diff analysis and context enrichment complete",
);
```
  </action>
  <verify>Run `bun test` -- full project test suite passes (no regressions). Verify handler imports compile: `bun build src/handlers/review.ts --target=bun --outdir=/tmp/verify-27`.</verify>
  <done>Handler runs diff analysis, matches path instructions, resolves profile defaults, and passes enriched context to buildReviewPrompt. All tests pass.</done>
</task>

</tasks>

<verification>
1. `bun test` -- full project test suite passes
2. `grep "analyzeDiff" src/handlers/review.ts` -- diff analysis wired in handler
3. `grep "matchPathInstructions" src/handlers/review.ts` -- path matching wired in handler
4. `grep "PROFILE_PRESETS" src/handlers/review.ts` -- profile resolution in handler
5. `grep "buildPathInstructionsSection" src/execution/review-prompt.ts` -- path section in prompt builder
6. `grep "buildDiffAnalysisSection" src/execution/review-prompt.ts` -- diff section in prompt builder
7. `grep "Change Context" src/execution/review-prompt.ts` -- diff analysis prompt section exists
8. `grep "Path-Specific Review Instructions" src/execution/review-prompt.ts` -- path instructions prompt section exists
</verification>

<success_criteria>
- Review handler runs deterministic diff analysis before LLM call
- Path instructions matched against changed files with picomatch (including negation support)
- Profile presets resolve to config field defaults (explicit config overrides profile)
- Review prompt includes Change Context section with file breakdown and risk signals
- Review prompt includes Path-Specific Review Instructions for matched patterns
- All context enrichment is implicit -- no meta-commentary in prompt
- Backward compatible -- omitting new config fields preserves existing behavior
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-context-aware-reviews/27-02-SUMMARY.md`
</output>
