---
phase: 52-intelligent-retrieval
plan: 02
type: execute
wave: 2
depends_on: ["52-01"]
files_modified:
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Retrieval queries incorporate PR intent, detected languages, diff risk signals, and author tier instead of just title and file paths"
    - "Same-language historical findings rank higher than cross-language results in retrieval output"
    - "A TypeScript PR retrieves TypeScript-specific historical findings preferentially over Python findings at similar distance"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Wired multi-signal query + language-aware re-ranking in retrieval path"
      contains: "buildRetrievalQuery"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/learning/retrieval-query.ts"
      via: "import buildRetrievalQuery"
      pattern: "buildRetrievalQuery"
    - from: "src/handlers/review.ts"
      to: "src/learning/retrieval-rerank.ts"
      via: "import rerankByLanguage"
      pattern: "rerankByLanguage"
---

<objective>
Wire `buildRetrievalQuery()` and `rerankByLanguage()` into the review handler's retrieval path, replacing the simple title+files query with multi-signal construction and adding post-retrieval language-aware re-ranking.

Purpose: This connects the pure functions from 52-01 to the live review pipeline, completing RET-01 and RET-02. The integration must preserve fail-open semantics — if the new code encounters any issue, the review proceeds without retrieval context.

Output: Updated `review.ts` with enriched retrieval queries and language-aware result ordering.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-intelligent-retrieval/52-RESEARCH.md
@.planning/phases/52-intelligent-retrieval/52-01-SUMMARY.md
@src/handlers/review.ts
@src/learning/retrieval-query.ts
@src/learning/retrieval-rerank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire multi-signal query and language re-ranking into review.ts</name>
  <files>src/handlers/review.ts</files>
  <action>
**Add imports** at the top of `src/handlers/review.ts`:
```typescript
import { buildRetrievalQuery } from "../learning/retrieval-query.ts";
import { rerankByLanguage } from "../learning/retrieval-rerank.ts";
```

**Replace the retrieval query construction** at ~line 1432. The current code:
```typescript
const queryText = `${pr.title}\n${reviewFiles.slice(0, 20).join("\n")}`;
```

Replace with:
```typescript
const queryText = buildRetrievalQuery({
  prTitle: pr.title,
  prBody: pr.body ?? undefined,
  conventionalType: parsedIntent.conventionalType?.type ?? null,
  detectedLanguages: Object.keys(diffAnalysis.filesByLanguage ?? {}),
  riskSignals: diffAnalysis.riskSignals ?? [],
  authorTier: authorClassification.tier,
  topFilePaths: reviewFiles.slice(0, 15),
});
```

All these variables are already in scope at this location:
- `pr.title`, `pr.body` — PR payload
- `parsedIntent.conventionalType` — from `parsePRIntent()` at line ~1211
- `diffAnalysis.filesByLanguage` — from `analyzeDiff()` at line ~1357
- `diffAnalysis.riskSignals` — from `analyzeDiff()` at line ~1357
- `authorClassification.tier` — from `resolveAuthorTier()` at line ~1267
- `reviewFiles` — file list at line ~1344

**Add language-aware re-ranking** after the `retrieveWithIsolation` call, inside the existing `if (retrieval.results.length > 0)` block at ~line 1444. Replace the current mapping:

```typescript
if (retrieval.results.length > 0) {
  retrievalCtx = {
    findings: retrieval.results.map(r => ({
      findingText: r.record.findingText,
      ...
    })),
  };
}
```

With:
```typescript
if (retrieval.results.length > 0) {
  const reranked = rerankByLanguage({
    results: retrieval.results,
    prLanguages: Object.keys(diffAnalysis.filesByLanguage ?? {}),
  });
  retrievalCtx = {
    findings: reranked.map(r => ({
      findingText: r.record.findingText,
      severity: r.record.severity,
      category: r.record.category,
      filePath: r.record.filePath,
      outcome: r.record.outcome,
      distance: r.adjustedDistance,
      sourceRepo: r.sourceRepo,
    })),
  };
}
```

**CRITICAL: Preserve fail-open semantics.** All new code MUST remain inside the existing `try/catch` block at lines 1430-1461. The `buildRetrievalQuery()` and `rerankByLanguage()` functions are pure and should never throw, but the enclosing try/catch provides defense-in-depth. Do NOT move code outside this block.

**CRITICAL: distanceThreshold still applies to original distance.** The `distanceThreshold` config in `retrieveWithIsolation()` filters on raw vector distance BEFORE re-ranking. Re-ranking only reorders the already-filtered results. Do NOT apply threshold to `adjustedDistance`.

Add a debug log after query construction (inside the try block):
```typescript
logger.debug({ ...baseLog, queryLength: queryText.length }, "Retrieval query constructed");
```
  </action>
  <verify>
1. `bun run build` (or TypeScript type-check) — no type errors in review.ts
2. `bun test src/handlers/` — existing handler tests pass (no regression)
3. `bun test src/learning/` — all learning tests pass
4. Manual code review: confirm `buildRetrievalQuery` and `rerankByLanguage` calls are inside the existing try/catch block at lines 1430-1461
  </verify>
  <done>
    - `review.ts` imports and calls `buildRetrievalQuery()` with all 7 signal fields
    - `review.ts` imports and calls `rerankByLanguage()` on retrieval results
    - Retrieval context uses `adjustedDistance` (re-ranked) for prompt injection
    - All code inside existing try/catch — fail-open preserved
    - distanceThreshold applied to original distance, not adjusted
    - Existing tests pass without regression
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds with no errors
2. `bun test` — full test suite passes
3. Code inspection: both new imports present in review.ts
4. Code inspection: `buildRetrievalQuery` called with all signal fields
5. Code inspection: `rerankByLanguage` called after retrieval, before prompt injection
6. Code inspection: all new code inside existing try/catch block
</verification>

<success_criteria>
- The retrieval path in review.ts uses enriched multi-signal queries instead of title+files
- Retrieved findings are re-ranked by language affinity before prompt injection
- No regression in existing handler or learning tests
- Fail-open behavior preserved
</success_criteria>

<output>
After completion, create `.planning/phases/52-intelligent-retrieval/52-02-SUMMARY.md`
</output>
