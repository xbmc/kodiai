---
phase: 62-issue-write-mode-pr-creation
plan: 03
type: execute
wave: 3
depends_on: [62-02]
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Production-shape issue_comment `@kodiai apply:`/`@kodiai change:` is accepted as write-mode when write.enabled is true"
    - "Accepted issue write-mode flow reaches branch push plus `pulls.create` against repository default branch"
    - "Issue thread receives `Opened PR: <url>` and live validation captures trigger, reply, and PR URL evidence"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Correct issue-comment surface/write-intent classification and reachable issue write-mode publish path"
      contains: "I can only apply changes in a PR context"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression fixture and assertions that mirror the failing live issue_comment payload shape"
      contains: "issue_comment.created"
  key_links:
    - from: "src/handlers/mention.test.ts"
      to: "src/handlers/mention.ts"
      via: "Production-like issue_comment payload fixture exercising write-intent gating"
      pattern: "issue_comment"
    - from: "src/handlers/mention.ts"
      to: "octokit.rest.pulls.create"
      via: "Issue write-mode publish path with default-branch base"
      pattern: "pulls\.create"
    - from: "src/handlers/mention.ts"
      to: "octokit.rest.issues.createComment"
      via: "Issue success reply body contains Opened PR URL"
      pattern: "Opened PR"
---

<objective>
Close the Phase 62 production gaps by fixing real issue-comment write-intent classification and proving that accepted issue requests create a default-branch PR with an in-thread `Opened PR` response.

Purpose: Verification found code-level coverage but failed live behavior, so this plan restores production truth for IWR-01 with fixture parity and live-evidence validation.
Output: Mention handler/runtime tests updated to match real webhook payload shape, plus validated live issue evidence showing trigger comment, bot PR-link reply, and created PR URL.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-issue-write-mode-pr-creation/62-01-SUMMARY.md
@.planning/phases/62-issue-write-mode-pr-creation/62-02-SUMMARY.md
@.planning/phases/62-issue-write-mode-pr-creation/62-issue-write-mode-pr-creation-VERIFICATION.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix issue-comment write-context classification for production payloads</name>
  <files>src/handlers/mention.ts</files>
  <action>
Trace the mention event classification and write-intent gate that currently falls into the PR-context-only refusal branch for a live issue comment:
- Reproduce classification using the failing live payload shape from verification evidence and identify why the issue comment path is treated as invalid PR-only context.
- Update the surface/write-intent eligibility checks so explicit `@kodiai apply:`/`@kodiai change:` on issue comments are recognized as valid write context in production payloads.
- Ensure the accepted issue path continues into existing branch push + `pulls.create` + issue reply flow, while preserving Phase 61 behavior for non-prefixed issue asks and existing policy/secret refusal guards.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000` after the handler change.</verify>
  <done>Live-shape issue comments no longer hit the PR-only refusal gate when explicit write intent is present and write-mode is enabled.</done>
</task>

<task type="auto">
  <name>Task 2: Add regression fixture parity and assertions for the failing live webhook shape</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add a regression test case that mirrors the failing GitHub issue-comment payload shape observed in production:
- Build/update fixture data to match the live `issue_comment` event fields that previously triggered `I can only apply changes in a PR context.`.
- Assert explicit issue `apply:`/`change:` enters write-mode, reaches PR creation with default branch as base, and posts an issue-thread comment containing `Opened PR: <url>`.
- Add a paired assertion that non-prefixed issue implementation asks remain read-only guidance (no write execution), so the fix does not regress Phase 61 intent gating.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`, `bun test`, and `bunx tsc --noEmit`.</verify>
  <done>Test coverage fails before the fix and passes after it, specifically guarding against the live payload mismatch regression.</done>
</task>

<task type="auto">
  <name>Task 3: Re-run live GitHub issue apply validation and capture PR evidence</name>
  <files>src/handlers/mention.ts, src/handlers/mention.test.ts</files>
  <action>
After tests pass, execute a live issue-comment validation in the target repository to close the remaining production truth gap:
- Post a fresh issue comment trigger using `@kodiai apply:` or `@kodiai change:` in write-enabled mode.
- Capture and record three concrete evidence URLs in the phase summary: trigger comment URL, bot reply URL containing `Opened PR:`, and the opened PR URL.
- If the run fails, capture the exact refusal/error reply URL and stop with explicit diagnosis instead of marking the gap closed.
  </action>
  <verify>Use `gh issue comment` / `gh api` checks to collect URLs, then confirm bot reply text includes `Opened PR:` and linked PR targets repository default branch.</verify>
  <done>Phase summary contains direct live evidence that issue write intent now creates a default-branch PR and responds in-thread with the PR link.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test`
- `bunx tsc --noEmit`
- Live validation evidence captured in summary with all three URLs: issue trigger comment, bot reply comment, and created PR
- Confirm created PR base branch equals repository default branch (from PR metadata/API output)
</verification>

<success_criteria>
The same production-style issue apply/change flow that previously failed now enters write-mode, opens a PR against the default branch, and returns an issue-thread `Opened PR: <url>` reply with URL evidence recorded in the summary.
</success_criteria>

<output>
After completion, create `.planning/phases/62-issue-write-mode-pr-creation/62-03-SUMMARY.md`
</output>
