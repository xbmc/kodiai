---
phase: 62-issue-write-mode-pr-creation
plan: 02
type: execute
wave: 2
depends_on: [62-01]
files_modified:
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue `@kodiai apply:` / `@kodiai change:` with write enabled produces an issue-thread PR link reply"
    - "Created issue write-mode PR targets the repository default branch"
    - "When issue write-mode cannot safely produce changes, the issue reply is a clear refusal instead of silent success"
  artifacts:
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for issue-surface write-mode PR creation and refusal behavior"
      contains: "write intent enabled creates a PR and replies with the link"
  key_links:
    - from: "src/handlers/mention.test.ts"
      to: "src/handlers/mention.ts"
      via: "Issue comment fixtures asserting pulls.create base branch and issue reply content"
      pattern: "issue_comment.created"
---

<objective>
Lock IWR-01 behavior with deterministic tests so issue write-mode PR creation and issue-thread PR-link replies remain stable across future handler changes.

Purpose: Phase 62 success depends on runtime behavior under issue_comment events; dedicated tests prevent regressions back to PR-context-only write handling.
Output: Mention handler tests that prove issue write-mode opens PRs against default branch, includes commits when changes exist, and posts clear refusal replies when changes are absent.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-issue-write-mode-pr-creation/62-01-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue write-mode success-path tests for PR creation and issue-thread link reply</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add focused unit/integration-style mention handler tests for pure issue comments (no PR context):
- Simulate `issue_comment.created` with `@kodiai apply: ...` and config `write.enabled: true`.
- Assert executor runs with `writeMode: true`, workspace edits are committed/pushed, and `octokit.rest.pulls.create` is called once.
- Assert created PR base is the repository default branch from issue payload clone context.
- Assert issue reply body contains `Opened PR: <url>` and is posted through issue comments.

Keep existing PR-comment write-mode tests unchanged and deterministic.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`.</verify>
  <done>Test suite proves issue-surface apply/change can publish a default-branch PR and return link reply in issue thread.</done>
</task>

<task type="auto">
  <name>Task 2: Add issue write-mode refusal-path tests for no-change and safe-failure messaging</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add issue-surface refusal coverage so Phase 62's "PR or clear refusal" contract is explicit:
- Simulate issue `@kodiai apply:` with write enabled where executor makes no file edits; assert no PR is created and issue reply contains clear next-step refusal wording.
- Add one issue write-mode policy-failure scenario (denied path or secret detection) and assert issue reply uses existing refusal contract details.
- Verify non-prefixed issue change ask behavior from Phase 61 remains unchanged (deterministic opt-in command guidance, no write execution).
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`, `bun test`, and `bunx tsc --noEmit`.</verify>
  <done>Tests enforce that issue write-mode always ends with either a created PR link reply or a clear refusal message, with Phase 61 intent gating preserved.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test`
- `bunx tsc --noEmit`
- Confirm new issue tests assert PR base branch equals repository default branch and reply includes `Opened PR:` URL
</verification>

<success_criteria>
Automated coverage proves IWR-01 end-to-end on issue comments: write-enabled explicit apply/change creates a default-branch PR with issue-thread PR-link reply, and non-success write outcomes are explicit refusals.
</success_criteria>

<output>
After completion, create `.planning/phases/62-issue-write-mode-pr-creation/62-02-SUMMARY.md`
</output>
