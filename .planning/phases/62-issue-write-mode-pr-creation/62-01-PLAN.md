---
phase: 62-issue-write-mode-pr-creation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
autonomous: true

must_haves:
  truths:
    - "Issue comments with explicit apply/change intent enter write-mode when write.enabled is true"
    - "A write-mode issue request creates a PR that targets the repository default branch"
    - "After PR creation, Kodiai posts a single issue-thread reply with the created PR link"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Issue-surface write-mode PR creation flow and issue-safe write-output identity"
      contains: "I can only apply changes in a PR context"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "octokit.rest.pulls.create"
      via: "Issue write-mode publish path using repo default branch as PR base"
      pattern: "pulls\.create"
    - from: "src/handlers/mention.ts"
      to: "octokit.rest.issues.createComment"
      via: "Issue-thread confirmation reply with Opened PR link"
      pattern: "Opened PR"
---

<objective>
Enable issue-surface write-mode so explicit `@kodiai apply:` / `@kodiai change:` requests can publish changes and open a PR against the default branch when write-mode is enabled.

Purpose: IWR-01 requires issue comment write intent to produce a real PR flow (not PR-context-only refusal) while preserving Phase 61 read-only safeguards for non-prefixed issue comments.
Output: Mention handler logic that supports issue write-output keys/branches, creates issue-triggered PRs against the default branch, and replies in-thread with the resulting PR URL.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-read-only-intent-gating/61-03-SUMMARY.md
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend write-mode identity and branch naming to support issue-surface triggers</name>
  <files>src/handlers/mention.ts</files>
  <action>
Refactor the write-output identity helpers so issue and PR write-intent requests can both produce deterministic output keys and branch names:
- Update write-output key construction to encode source surface (`issue` vs `pr`) and source number (`issueNumber` or `prNumber`) instead of assuming PR-only identifiers.
- Update deterministic branch naming to include source type/number while preserving existing PR replay/idempotency behavior.
- Keep Phase 61 guardrails unchanged: only explicit `apply:`/`change:` enters write-mode; non-prefixed issue implementation asks still short-circuit into deterministic read-only guidance.

Do not change allow/deny path policy checks or secret-scan enforcement in this task.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`.</verify>
  <done>Write-mode metadata and deterministic branch naming now work for both issue and PR write requests without regressing Phase 61 issue intent gating.</done>
</task>

<task type="auto">
  <name>Task 2: Implement issue write-mode PR publish path targeting default branch</name>
  <files>src/handlers/mention.ts</files>
  <action>
Replace the PR-context-only refusal path for explicit write intent so pure issue comments can publish when `config.write.enabled` is true:
- For `mention.surface === "issue_comment"` write-intent requests, allow executor write-mode to run and then evaluate workspace changes.
- If no file changes exist, post a clear refusal/next-step reply (no empty PR).
- If changes exist, create/push a deterministic bot branch, open a PR whose base is the repo default branch used for workspace clone, and include issue-trigger metadata in PR title/body (issue number, request text, delivery id, commit SHA).
- Post a single issue-thread confirmation reply containing `Opened PR: <url>`.
- Preserve existing non-issue write behavior and existing failure handling (policy refusal, error comment fallback, rate-limit bookkeeping).
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`, `bun test`, and `bunx tsc --noEmit`.</verify>
  <done>Issue `apply:`/`change:` with write enabled can create a PR to default branch and always reply in issue thread with either PR link or clear refusal.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test`
- `bunx tsc --noEmit`
- Confirm issue write-mode path no longer returns PR-context-only refusal for valid issue `apply:`/`change:` requests
</verification>

<success_criteria>
Explicit issue write-intent comments in write-enabled repos now execute write-mode, open a PR against the default branch, and produce a deterministic issue-thread reply with the PR link (or a clear refusal when no safe change can be produced).
</success_criteria>

<output>
After completion, create `.planning/phases/62-issue-write-mode-pr-creation/62-01-SUMMARY.md`
</output>
