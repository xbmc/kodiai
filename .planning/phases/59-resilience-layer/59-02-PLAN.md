---
phase: 59-resilience-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/partial-review-formatter.ts
  - src/lib/partial-review-formatter.test.ts
  - src/lib/retry-scope-reducer.ts
  - src/lib/retry-scope-reducer.test.ts
  - src/telemetry/types.ts
  - src/telemetry/store.ts
autonomous: true

must_haves:
  truths:
    - "Partial review formatter produces a disclaimer header with coverage ratio and optional retry-skip reason"
    - "Retry scope reducer excludes already-reviewed files and applies adaptive scope formula"
    - "Telemetry store can count recent timeouts per repo+author in the last 7 days"
  artifacts:
    - path: "src/lib/partial-review-formatter.ts"
      provides: "formatPartialReviewComment function for partial review disclaimers"
      exports: ["formatPartialReviewComment"]
    - path: "src/lib/retry-scope-reducer.ts"
      provides: "computeRetryScope function for adaptive scope reduction"
      exports: ["computeRetryScope"]
    - path: "src/telemetry/store.ts"
      provides: "countRecentTimeouts query method and pr_author column"
      contains: "countRecentTimeouts"
  key_links:
    - from: "src/lib/retry-scope-reducer.ts"
      to: "src/lib/file-risk-scorer.ts"
      via: "FileRiskScore type import"
      pattern: "FileRiskScore"
---

<objective>
Build the pure-function modules for partial review formatting and retry scope reduction, plus add chronic timeout detection to the telemetry store.

Purpose: These are the building blocks the review handler needs to publish partial reviews with appropriate disclaimers, compute which files to retry, and decide whether retry should be skipped for chronically timing-out repo+author pairs.
Output: `formatPartialReviewComment`, `computeRetryScope` functions with full test coverage, `countRecentTimeouts` telemetry method with `pr_author` column migration.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/59-resilience-layer/59-RESEARCH.md
@src/lib/file-risk-scorer.ts
@src/telemetry/types.ts
@src/telemetry/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create partial review formatter and retry scope reducer with tests</name>
  <files>src/lib/partial-review-formatter.ts, src/lib/partial-review-formatter.test.ts, src/lib/retry-scope-reducer.ts, src/lib/retry-scope-reducer.test.ts</files>
  <action>
**Partial review formatter** (`src/lib/partial-review-formatter.ts`):
- Export `PartialReviewParams` type:
  ```typescript
  export type PartialReviewParams = {
    summaryDraft: string;
    filesReviewed: number;
    totalFiles: number;
    timedOutAfterSeconds: number;
    isRetrySkipped?: boolean;
    retrySkipReason?: string;
    isRetryResult?: boolean;
    retryFilesReviewed?: number;
  };
  ```
- Export `formatPartialReviewComment(params: PartialReviewParams): string`:
  - When `isRetryResult` is true: header is `> **Partial review** -- Analyzed {totalReviewed} of {totalFiles} files. Reviewed top {retryFilesReviewed} files by risk in retry.` (where totalReviewed = filesReviewed + retryFilesReviewed)
  - When NOT retry result: header is `> **Partial review** -- timed out after analyzing {filesReviewed} of {totalFiles} files ({timedOutAfterSeconds}s).`
  - When `isRetrySkipped` and `retrySkipReason`: add blockquote lines with the reason and guidance: `> Consider splitting large PRs to stay within the review timeout budget.`
  - After the disclaimer header, add a blank line then the `summaryDraft` body.
  - Follow the exact format from the research code example.

**Retry scope reducer** (`src/lib/retry-scope-reducer.ts`):
- Import `FileRiskScore` from `./file-risk-scorer.ts`.
- Export `RetryScopeParams` and `RetryScopeResult` types.
- Export `computeRetryScope(params: RetryScopeParams): RetryScopeResult`:
  - Exclude files from `filesAlreadyReviewed` (use Set for O(1) lookup).
  - Sort remaining by `score` descending (highest risk first -- primary signal is linesChanged per user decision).
  - Compute adaptive scope: `scopeRatio = Math.min(1.0, 0.5 + reviewedFraction * 0.5)` where `reviewedFraction = filesAlreadyReviewed.length / totalFiles`.
  - `targetCount = Math.max(1, Math.ceil(remaining.length * scopeRatio))`.
  - Return `{ filesToReview: remaining.slice(0, targetCount), scopeRatio }`.
  - Edge case: if remaining is empty, return `{ filesToReview: [], scopeRatio: 0 }`.

**Tests** for both modules:
- Partial review formatter tests:
  - Standard timeout disclaimer shows correct file counts and duration
  - Retry result disclaimer shows merged file count and "by risk" label
  - Retry-skipped disclaimer includes reason and splitting guidance
  - Empty summaryDraft still produces valid output
- Retry scope reducer tests:
  - Excludes already-reviewed files
  - Sorts remaining by risk score descending
  - At 0% reviewed: scope = 50% of remaining
  - At 50% reviewed: scope = 75% of remaining
  - At 80% reviewed: scope = ~90% of remaining
  - Empty remaining returns empty array with scopeRatio 0
  - Single remaining file always included (Math.max(1, ...))
  </action>
  <verify>Run `bun test src/lib/partial-review-formatter.test.ts src/lib/retry-scope-reducer.test.ts` -- all tests pass. Run `bunx tsc --noEmit` -- no type errors.</verify>
  <done>Both pure-function modules have full test coverage, correct adaptive scope formula, and proper partial review disclaimer formatting per user decisions.</done>
</task>

<task type="auto">
  <name>Task 2: Add pr_author column and countRecentTimeouts to telemetry store</name>
  <files>src/telemetry/types.ts, src/telemetry/store.ts</files>
  <action>
In `src/telemetry/types.ts`:
- Add `prAuthor?: string` field to `TelemetryRecord` type (optional, nullable).
- Add `countRecentTimeouts?(repo: string, author: string): number` method to `TelemetryStore` type (optional `?` for backward compat with test mocks).

In `src/telemetry/store.ts`:
- After the `CREATE TABLE IF NOT EXISTS executions` block, add an additive migration using the `ensureTableColumn` pattern or a direct `ALTER TABLE` wrapped in try/catch (since SQLite `ALTER TABLE ADD COLUMN` is a no-op if column exists when using IF NOT EXISTS... but SQLite doesn't support IF NOT EXISTS for columns, so use try/catch to silently catch "duplicate column name" error):
  ```typescript
  try {
    db.run(`ALTER TABLE executions ADD COLUMN pr_author TEXT`);
  } catch {
    // Column already exists -- safe to ignore
  }
  ```
- In the `record()` method's INSERT statement, add `pr_author` to both column list and values, binding `entry.prAuthor ?? null`.
- Add `countRecentTimeouts` method:
  ```typescript
  function countRecentTimeouts(repo: string, author: string): number {
    const row = db
      .prepare(
        `SELECT COUNT(*) as cnt FROM executions
         WHERE repo = ? AND pr_author = ?
         AND conclusion IN ('timeout', 'timeout_partial')
         AND created_at > datetime('now', '-7 days')`
      )
      .get(repo, author) as { cnt: number } | null;
    return row?.cnt ?? 0;
  }
  ```
- Return `countRecentTimeouts` in the store's public interface.
  </action>
  <verify>Run `bun test src/telemetry/ --timeout 10000` -- existing telemetry tests still pass. Grep store.ts for `pr_author` and `countRecentTimeouts` to confirm both exist.</verify>
  <done>Telemetry store has pr_author column on executions table (additive migration), TelemetryRecord includes prAuthor field, and countRecentTimeouts method queries for chronic timeout detection per repo+author in the last 7 days.</done>
</task>

</tasks>

<verification>
- `bun test` -- all existing tests plus new partial-review-formatter and retry-scope-reducer tests pass
- `bunx tsc --noEmit` -- no type errors
- `formatPartialReviewComment` produces correctly formatted disclaimers for all three cases (standard, retry result, retry skipped)
- `computeRetryScope` applies adaptive formula and excludes reviewed files
- `countRecentTimeouts` queries executions table with repo+author+7-day window
</verification>

<success_criteria>
Pure-function building blocks are complete and tested: partial review disclaimers respect all user decisions (coverage ratio, retry skip reason, splitting guidance), retry scope reduction is adaptive based on reviewed fraction, and chronic timeout detection queries the telemetry store per repo+author.
</success_criteria>

<output>
After completion, create `.planning/phases/59-resilience-layer/59-02-SUMMARY.md`
</output>
