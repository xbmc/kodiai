---
phase: 61-read-only-intent-gating
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "A non-prefixed issue implementation request never reaches executor and always gets exact @kodiai apply/change opt-in commands"
    - "Issue read-only replies cannot claim completed repository edits when explicit apply/change intent is absent"
    - "Issue informational questions still run through normal issue Q&A execution"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Fail-closed issue intent gate that recognizes broader implementation asks before executor invocation"
      contains: "isImplementationRequestWithoutPrefix"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression tests reproducing live non-prefixed failure phrasing and ensuring deterministic opt-in reply"
      contains: "can you fix the issue intent gating copy"
    - path: "src/execution/mention-prompt.ts"
      provides: "Issue read-only prompt guardrails that explicitly forbid done/updated/implemented completion claims"
      exports: ["buildMentionPrompt"]
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Prompt contract tests for issue-only anti-completion wording"
      contains: "Issue Q&A Requirements"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "Issue-surface custom instructions and write-intent parsing"
      pattern: "buildMentionPrompt"
    - from: "src/handlers/mention.ts"
      to: "executor.execute"
      via: "Issue implementation gate early-return before executor call"
      pattern: "isImplementationRequestWithoutPrefix"
---

<objective>
Close the Phase 61 live-verification gap where a non-prefixed issue change request produced an "Updated ..." style completion response instead of deterministic read-only opt-in guidance.

Purpose: ISSUE-02 and SAFE-01 require fail-closed behavior on issue comments; live Trigger A showed the current gate can miss a real implementation ask shape.
Output: Hardened issue intent gate + stronger issue prompt guardrails + regression tests that reproduce the failing request text and prevent future regressions.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/61-read-only-intent-gating/61-read-only-intent-gating-VERIFICATION.md
@.planning/phases/61-read-only-intent-gating/61-02-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
@src/execution/mention-prompt.ts
@src/execution/mention-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden issue implementation-intent detection and keep the gate fail-closed</name>
  <files>src/handlers/mention.ts</files>
  <action>
Strengthen `isImplementationRequestWithoutPrefix()` so real implementation asks are not missed due to punctuation or conversational framing:
- Normalize leading wrappers before matching (for example markdown quote/list prefixes, punctuation, or short preambles like "hey,"/"quick question,"), then evaluate intent.
- Expand implementation-intent patterns beyond bare verbs to include common rewrite/copy-edit asks that still imply code changes (for example "make ... clearer", "improve", "tweak", "clean up" when directed at repository behavior/text).
- Keep detector conservative for informational questions; do not gate purely explanatory asks.
- Preserve early-return behavior on `mention.surface === "issue_comment"` so matching requests post deterministic read-only guidance with both exact commands:
  - `@kodiai apply: &lt;same request&gt;`
  - `@kodiai change: &lt;same request&gt;`

Do not alter Phase 61 behavior for explicit `apply:`/`change:` issue requests.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`.</verify>
  <done>The live-failure phrasing and close variants are gated before executor invocation, and informational issue questions remain ungated.</done>
</task>

<task type="auto">
  <name>Task 2: Add defense-in-depth prompt guardrails and regression tests for non-prefixed issue edits</name>
  <files>src/execution/mention-prompt.ts, src/execution/mention-prompt.test.ts, src/handlers/mention.test.ts</files>
  <action>
Add explicit issue-only anti-completion language to `buildMentionPrompt()` for non-prefixed issue comments:
- For read-only issue responses, forbid completion/status claims such as "updated", "implemented", "fixed", or statements implying files were modified.
- Require read-only wording to remain guidance-focused unless user message starts with `apply:` or `change:`.

Add regression coverage:
- Reproduce Trigger A wording exactly: `@kodiai can you fix the issue intent gating copy so it is clearer for users?` and assert deterministic opt-in reply with both exact commands and no executor call.
- Add one formatted variant (for example quoted or prefixed punctuation) to prove normalization closes the gap.
- Assert issue informational questions (non-implementation asks) still call executor.
- Assert prompt tests fail if issue-only anti-completion wording or exact opt-in command requirements are removed.
  </action>
  <verify>Run `bun test src/execution/mention-prompt.test.ts`, `bun test src/handlers/mention.test.ts --timeout 30000`, `bun test`, and `bunx tsc --noEmit`.</verify>
  <done>Both runtime and prompt-level safeguards enforce read-only issue behavior for non-prefixed change asks, with deterministic command guidance and no regressions in normal issue Q&A.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test src/execution/mention-prompt.test.ts`
- `bun test`
- `bunx tsc --noEmit`
- Confirm deterministic reply for Trigger A wording includes exact `@kodiai apply:` and `@kodiai change:` lines and executor is not invoked
</verification>

<success_criteria>
The observed live failure cannot recur: non-prefixed issue implementation asks are fail-closed into deterministic read-only opt-in command guidance, and issue read-only outputs no longer claim completed edits.
</success_criteria>

<output>
After completion, create `.planning/phases/61-read-only-intent-gating/61-03-SUMMARY.md`
</output>
