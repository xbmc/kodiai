---
phase: 61-read-only-intent-gating
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue-thread writes are never executed unless explicit apply/change intent is present"
    - "Issue comments that request code changes without apply/change receive an explicit prefix command to opt in"
    - "Regular issue Q&A remains read-only and continues to produce one in-thread reply"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Runtime intent gating for issue change requests and deterministic write opt-in response"
      contains: "parseWriteIntent"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression tests proving non-prefixed issue change requests stay read-only and return exact opt-in command"
      contains: "issue_comment.created"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "issue read-only instruction threading to prompt"
      pattern: "customInstructions"
    - from: "src/handlers/mention.ts"
      to: "git/PR write helpers"
      via: "writeEnabled gate and issue-surface short-circuit"
      pattern: "writeEnabled"
---

<objective>
Enforce read-only intent gating in the mention handler so issue-thread change requests do not enter write execution without explicit prefix intent and users get deterministic opt-in commands.

Purpose: SAFE-01 and ISSUE-02 require runtime guarantees, not prompt-only behavior, for issue surfaces.
Output: Mention handler gating updates plus tests proving issue write paths remain blocked without explicit `apply:`/`change:` and that users get exact opt-in commands.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-issue-q-a/60-03-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
@src/execution/mention-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue-surface runtime intent gate and deterministic opt-in reply</name>
  <files>src/handlers/mention.ts</files>
  <action>
Strengthen issue-surface intent handling after `parseWriteIntent(userQuestion)`:
- Keep explicit-prefix detection strict (`apply:` / `change:` at the start of stripped user request) and ensure non-prefixed issue comments cannot enter any git/PR write path.
- Add a conservative detector for issue comments that ask for implementation without prefix (for example fix/update/change/refactor/add/remove/implement wording).
- For detected non-prefixed implementation asks on `mention.surface === "issue_comment"`, return a deterministic read-only guidance reply before execution that includes exact opt-in commands:
  - `@kodiai apply: &lt;same request&gt;`
  - `@kodiai change: &lt;same request&gt;`
- Keep existing issue behavior for non-change Q&amp;A (continue normal execution path), and preserve explicit user policies from STATE.md (no unsolicited responses, no auto re-review on push).

Do not enable issue PR creation in this phase; Phase 62 will own write-mode issue PR flow.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`.</verify>
  <done>Mention handler deterministically blocks non-prefixed issue change requests from write paths and posts exact apply/change opt-in commands while preserving normal issue Q&A flow.</done>
</task>

<task type="auto">
  <name>Task 2: Add handler tests for SAFE-01 and prefix command guidance</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add focused issue-comment regression tests:
- Non-prefixed issue change request (`@kodiai can you fix ...`) posts exactly one read-only reply containing both exact command forms (`@kodiai apply:` and `@kodiai change:`) and does not execute write flow.
- Non-prefixed issue informational question still runs normal executor path (no false-positive gating).
- Explicit `@kodiai apply:` on issue surface remains safely non-writing in Phase 61 (no PR creation or git write side effects from issue thread).

Mock octokit comment calls and executor interactions; keep tests deterministic and isolated from PR comment/thread behavior.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`, `bun test`, and `bunx tsc --noEmit`.</verify>
  <done>Test coverage proves SAFE-01 runtime gating and ISSUE-02 opt-in command UX on issue surfaces without regressions to existing mention behavior.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test`
- `bunx tsc --noEmit`
- Confirm new issue tests assert exact `@kodiai apply:` / `@kodiai change:` reply content for non-prefixed change asks
</verification>

<success_criteria>
Issue-thread write intent is runtime-gated by explicit prefixes and non-prefixed implementation asks receive deterministic read-only opt-in commands.
</success_criteria>

<output>
After completion, create `.planning/phases/61-read-only-intent-gating/61-02-SUMMARY.md`
</output>
