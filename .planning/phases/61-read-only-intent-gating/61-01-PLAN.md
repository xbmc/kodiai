---
phase: 61-read-only-intent-gating
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue Q&A replies without apply/change are explicitly framed as read-only guidance"
    - "When a change is requested without apply/change, the response contract includes exact opt-in commands"
    - "Read-only intent guidance is applied only on issue_comment surface"
  artifacts:
    - path: "src/execution/mention-prompt.ts"
      provides: "Issue read-only response contract with explicit apply/change opt-in wording"
      exports: ["buildMentionPrompt"]
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Regression tests for issue-only read-only framing and prefix command guidance"
      contains: "Issue Q&A Requirements"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "buildMentionPrompt custom instructions for issue replies"
      pattern: "buildMentionPrompt"
---

<objective>
Extend the issue mention prompt contract so non-prefixed issue replies are clearly read-only and include explicit apply/change opt-in commands when users ask for implementation.

Purpose: ISSUE-02 requires clear read-only framing in issue Q&A before write-mode is allowed; this plan locks that behavior with prompt-level contract tests.
Output: Updated `buildMentionPrompt()` issue instructions and tests that fail if read-only or opt-in command guidance regresses.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-issue-q-a/60-01-SUMMARY.md
@src/execution/mention-prompt.ts
@src/execution/mention-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add explicit issue read-only framing and opt-in command contract</name>
  <files>src/execution/mention-prompt.ts</files>
  <action>
Update the `mention.surface === "issue_comment"` instruction block in `buildMentionPrompt()` to enforce Phase 61 read-only intent gating:
- Add a read-only default rule: unless the user message starts with `apply:` or `change:`, the reply must be guidance-only and must not imply that files were edited, a branch was pushed, or a PR was opened.
- Add explicit write opt-in wording for change requests without prefix: require the response to include exact command forms the user can run, using both `@kodiai apply: &lt;same request&gt;` and `@kodiai change: &lt;same request&gt;`.
- Keep existing direct-answer/path-evidence/clarification guarantees from Phase 60 unchanged.

Do not add new MCP tools or modify write execution behavior in this task.
  </action>
  <verify>Run `bun test src/execution/mention-prompt.test.ts`.</verify>
  <done>Issue prompt instructions now explicitly encode read-only default behavior plus exact apply/change opt-in command guidance for implementation requests.</done>
</task>

<task type="auto">
  <name>Task 2: Add prompt regression tests for read-only and exact opt-in command wording</name>
  <files>src/execution/mention-prompt.test.ts</files>
  <action>
Extend mention prompt tests with issue-surface assertions:
- Assert issue prompts include read-only default wording tied to missing `apply:`/`change:` prefixes.
- Assert issue prompts include exact opt-in command examples for both `@kodiai apply:` and `@kodiai change:`.
- Assert non-issue surfaces do not include these issue-only read-only instructions.

Preserve existing Phase 60 tests and avoid rewriting unrelated prompt test scenarios.
  </action>
  <verify>Run `bun test src/execution/mention-prompt.test.ts` and `bunx tsc --noEmit`.</verify>
  <done>Prompt test suite fails if issue read-only framing or exact apply/change command guidance is removed or leaked across surfaces.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/mention-prompt.test.ts`
- `bunx tsc --noEmit`
- Confirm issue-only prompt block includes explicit read-only and `@kodiai apply:`/`@kodiai change:` command text
</verification>

<success_criteria>
Issue Q&A prompt contract guarantees read-only framing by default and explicit prefix-based write opt-in guidance without altering non-issue mention behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/61-read-only-intent-gating/61-01-SUMMARY.md`
</output>
