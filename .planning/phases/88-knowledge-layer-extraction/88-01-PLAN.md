---
phase: 88-knowledge-layer-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge/retrieval.ts
  - src/knowledge/embeddings.ts
  - src/knowledge/index.ts
  - src/knowledge/isolation.ts
  - src/knowledge/memory-store.ts
  - src/knowledge/adaptive-threshold.ts
  - src/knowledge/retrieval-rerank.ts
  - src/knowledge/retrieval-recency.ts
  - src/knowledge/retrieval-snippets.ts
  - src/knowledge/multi-query-retrieval.ts
  - src/knowledge/retrieval-query.ts
autonomous: true
requirements:
  - KNW-01
  - KNW-02
  - KNW-04

must_haves:
  truths:
    - "src/knowledge/retrieval.ts exports a retrieve() function that accepts text queries and returns ranked results"
    - "src/knowledge/embeddings.ts exports embedding creation and provider initialization"
    - "Multi-query is first-class: retrieve() accepts string[] queries and handles variant execution internally"
    - "All reranking, recency weighting, and adaptive threshold logic runs inside retrieve(), not in callers"
  artifacts:
    - path: "src/knowledge/retrieval.ts"
      provides: "Unified retrieval facade with multi-query support"
      exports: ["retrieve", "RetrieveOptions", "RetrieveResult"]
    - path: "src/knowledge/embeddings.ts"
      provides: "Embedding provider creation and types"
      exports: ["createEmbeddingProvider", "createNoOpEmbeddingProvider", "EmbeddingProvider"]
    - path: "src/knowledge/index.ts"
      provides: "Barrel exports for knowledge module"
  key_links:
    - from: "src/knowledge/retrieval.ts"
      to: "src/knowledge/embeddings.ts"
      via: "EmbeddingProvider passed to retrieve()"
      pattern: "EmbeddingProvider"
    - from: "src/knowledge/retrieval.ts"
      to: "src/knowledge/isolation.ts"
      via: "IsolationLayer used internally"
      pattern: "retrieveWithIsolation"
---

<objective>
Create the unified `src/knowledge/` module with `retrieval.ts` and `embeddings.ts` as the sole entry points for retrieval and embedding operations.

Purpose: Consolidate all retrieval pipeline logic (variant building, embedding, isolation, reranking, recency weighting, adaptive thresholds, snippet anchoring) into a single `retrieve()` function so callers pass text queries in and get ranked results out.

Output: `src/knowledge/retrieval.ts`, `src/knowledge/embeddings.ts`, `src/knowledge/index.ts`, and all supporting files moved from `src/learning/` to `src/knowledge/`.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/learning/multi-query-retrieval.ts
@src/learning/embedding-provider.ts
@src/learning/memory-store.ts
@src/learning/isolation.ts
@src/learning/retrieval-rerank.ts
@src/learning/retrieval-recency.ts
@src/learning/retrieval-snippets.ts
@src/learning/adaptive-threshold.ts
@src/learning/retrieval-query.ts
@src/learning/types.ts
@src/knowledge/store.ts
@src/knowledge/types.ts
@src/knowledge/confidence.ts
@src/handlers/review.ts (lines 2013-2210 for retrieval pipeline usage)
@src/handlers/mention.ts (lines 1152-1330 for retrieval pipeline usage)
@src/execution/config.ts (lines 255-295 for retrieval config schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move learning module files to knowledge and create embeddings.ts facade</name>
  <files>
    src/knowledge/embeddings.ts
    src/knowledge/memory-store.ts
    src/knowledge/isolation.ts
    src/knowledge/adaptive-threshold.ts
    src/knowledge/retrieval-rerank.ts
    src/knowledge/retrieval-recency.ts
    src/knowledge/retrieval-snippets.ts
    src/knowledge/multi-query-retrieval.ts
    src/knowledge/retrieval-query.ts
  </files>
  <action>
    Move all files from `src/learning/` into `src/knowledge/`. For each file:
    1. Copy the file content to `src/knowledge/{filename}`
    2. Update internal import paths: change `"./types.ts"` references to point to the correct types (learning types are in `src/learning/types.ts`, now will be `./types.ts` — but the learning types need to be merged or re-exported from knowledge types)
    3. Update cross-references between moved files (e.g., retrieval-recency imports from retrieval-rerank)

    Specific file handling:
    - `embedding-provider.ts` → create `src/knowledge/embeddings.ts` that contains the same code from `src/learning/embedding-provider.ts` plus re-exports the `EmbeddingProvider` and `EmbeddingResult` types from types.
    - `memory-store.ts` → `src/knowledge/memory-store.ts` — update import of `Sql` to `"../db/client.ts"` (stays the same), update `LearningMemoryRecord`/`LearningMemoryStore` type imports to reference knowledge types.
    - `isolation.ts` → `src/knowledge/isolation.ts` — update type imports.
    - `adaptive-threshold.ts` → `src/knowledge/adaptive-threshold.ts` (no external imports to update).
    - `retrieval-rerank.ts` → `src/knowledge/retrieval-rerank.ts` — update import of `classifyFileLanguage` to `"../execution/diff-analysis.ts"` (stays the same), update `RetrievalResult` type import.
    - `retrieval-recency.ts` → `src/knowledge/retrieval-recency.ts` — update `RerankedResult` import to `"./retrieval-rerank.ts"`.
    - `retrieval-snippets.ts` → `src/knowledge/retrieval-snippets.ts` — update `RetrievalResult` type import.
    - `multi-query-retrieval.ts` → `src/knowledge/multi-query-retrieval.ts` — update `RetrievalResult` type import.
    - `retrieval-query.ts` → `src/knowledge/retrieval-query.ts` (no external imports to update, self-contained).

    Merge learning types into knowledge types: Add the following types to `src/knowledge/types.ts` (they currently live in `src/learning/types.ts`):
    - `MemoryOutcome`, `LearningMemoryRecord`, `EmbeddingResult`, `RetrievalResult`, `RetrievalWithProvenance`, `EmbeddingConfig`, `SharingConfig`, `LearningMemoryStore`, `EmbeddingProvider`

    These types import `FindingSeverity` and `FindingCategory` from `"../knowledge/types.ts"` — since they're now IN knowledge/types.ts, make them reference the same file's types directly (just use the types defined above in the same file).

    Also move all test files: for each `*.test.ts` in `src/learning/`, copy to `src/knowledge/` with updated imports. The tests are: `adaptive-threshold.test.ts`, `memory-store.test.ts`, `multi-query-retrieval.test.ts`, `retrieval-query.test.ts`, `retrieval-recency.test.ts`, `retrieval-rerank.test.ts`, `retrieval-snippets.test.ts`.

    Do NOT delete `src/learning/` yet — that happens in plan 02.
    Do NOT update handler imports yet — that happens in plan 02.

    Temporarily create re-export shims in `src/learning/` that re-export from `src/knowledge/` so existing handler imports don't break during the transition:
    - `src/learning/types.ts` → re-exports everything from `../knowledge/types.ts`
    - `src/learning/embedding-provider.ts` → re-exports from `../knowledge/embeddings.ts`
    - `src/learning/memory-store.ts` → re-exports from `../knowledge/memory-store.ts`
    - `src/learning/isolation.ts` → re-exports from `../knowledge/isolation.ts`
    - `src/learning/multi-query-retrieval.ts` → re-exports from `../knowledge/multi-query-retrieval.ts`
    - `src/learning/retrieval-rerank.ts` → re-exports from `../knowledge/retrieval-rerank.ts`
    - `src/learning/retrieval-recency.ts` → re-exports from `../knowledge/retrieval-recency.ts`
    - `src/learning/retrieval-snippets.ts` → re-exports from `../knowledge/retrieval-snippets.ts`
    - `src/learning/adaptive-threshold.ts` → re-exports from `../knowledge/adaptive-threshold.ts`
    - `src/learning/retrieval-query.ts` → re-exports from `../knowledge/retrieval-query.ts`
  </action>
  <verify>
    Run `bun test src/knowledge/` — all moved tests pass.
    Run `bun test src/learning/` — existing tests still pass via re-export shims.
    Run `bun test` — full test suite passes (no import breakage).
  </verify>
  <done>All learning module code lives in src/knowledge/ with working re-export shims in src/learning/. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create unified retrieve() facade in src/knowledge/retrieval.ts and barrel index</name>
  <files>
    src/knowledge/retrieval.ts
    src/knowledge/index.ts
  </files>
  <action>
    Create `src/knowledge/retrieval.ts` — the unified retrieval facade. This is the key deliverable of the knowledge layer extraction.

    **API contract** (text in, results out):

    ```typescript
    export type RetrieveOptions = {
      repo: string;
      owner: string;
      /** Raw text queries — multi-query is first-class. Single query: pass ['query']. */
      queries: string[];
      /** Workspace dir for snippet anchoring. If omitted, skip snippet building. */
      workspaceDir?: string;
      /** PR languages for language-based reranking. Default: [] */
      prLanguages?: string[];
      /** Override topK from config. */
      topK?: number;
      /** Override distance threshold from config. */
      distanceThreshold?: number;
      /** Override adaptive threshold from config. */
      adaptive?: boolean;
      /** Override maxContextChars from config. */
      maxContextChars?: number;
      /** Logger instance for request-scoped logging. */
      logger: Logger;
    };

    export type RetrieveResult = {
      findings: MergedRetrievalResult[];
      snippetAnchors: SnippetAnchor[];
      provenance: {
        queryCount: number;
        candidateCount: number;
        sharedPoolUsed: boolean;
        thresholdMethod: string;
        thresholdValue: number;
      };
    };
    ```

    **Implementation:**

    `retrieve()` function encapsulates the ENTIRE pipeline that currently lives in review.ts lines 2013-2210:
    1. For each query string, generate embedding via EmbeddingProvider
    2. Execute retrieval variants using `executeRetrievalVariants()` with the isolation layer
    3. Merge variant results using `mergeVariantResults()`
    4. Apply language reranking via `rerankByLanguage()`
    5. Apply recency weighting via `applyRecencyWeighting()`
    6. If adaptive enabled, compute adaptive threshold and filter
    7. If workspaceDir provided, build snippet anchors and trim to budget
    8. Return final RetrieveResult

    The function needs these dependencies injected (factory pattern):

    ```typescript
    export function createRetriever(deps: {
      embeddingProvider: EmbeddingProvider;
      isolationLayer: IsolationLayer;
      config: {
        retrieval: { enabled: boolean; topK: number; distanceThreshold: number; adaptive: boolean; maxContextChars: number };
        sharing: { enabled: boolean };
      };
    }): { retrieve: (opts: RetrieveOptions) => Promise<RetrieveResult | null> }
    ```

    The `retrieve()` returns `null` when retrieval is disabled in config or when no queries are provided.

    For multi-query: when `queries` has multiple entries, each becomes a separate variant with types assigned as: first = "intent", second = "file-path", third = "code-shape" (matching the existing buildRetrievalVariants pattern). When `queries` has a single entry, execute it as a single "intent" variant (the Slack simple-query path).

    **Important:** The existing `buildRetrievalVariants()` function (which takes PR metadata and builds variant queries) should NOT be moved into this module — it's context-specific to PR review. Instead, callers that need multi-variant can call `buildRetrievalVariants()` themselves and pass the resulting query strings to `retrieve()`. But `retrieve()` handles variant execution, merging, reranking, thresholding internally.

    Actually, looking at the decision: "Multi-query is a first-class feature: `retrieve(['query1', 'query2', ...], opts)`" — the queries array IS the variants. Each query string becomes a variant. The variant type assignment is: index 0 = "intent", index 1 = "file-path", index 2 = "code-shape". For arrays longer than 3, additional queries get type "intent" (lowest priority). For single-element arrays (Slack), it's just one "intent" variant.

    **Create `src/knowledge/index.ts`** — barrel exports:
    ```typescript
    // Retrieval (primary API)
    export { createRetriever, type RetrieveOptions, type RetrieveResult } from "./retrieval.ts";

    // Embeddings
    export { createEmbeddingProvider, createNoOpEmbeddingProvider } from "./embeddings.ts";

    // Memory store
    export { createLearningMemoryStore } from "./memory-store.ts";

    // Isolation
    export { createIsolationLayer, type IsolationLayer } from "./isolation.ts";

    // Knowledge store (reviews, findings, etc.)
    export { createKnowledgeStore } from "./store.ts";

    // Types (re-export all)
    export type {
      EmbeddingProvider, EmbeddingResult, EmbeddingConfig,
      LearningMemoryRecord, LearningMemoryStore, MemoryOutcome,
      RetrievalResult, RetrievalWithProvenance,
      SharingConfig,
      KnowledgeStore, ReviewRecord, FindingRecord,
      FindingSeverity, FindingCategory,
    } from "./types.ts";

    // Confidence
    export { computeConfidence, matchesSuppression } from "./confidence.ts";
    ```

    Fail-open: `retrieve()` wraps the entire pipeline in try/catch. On any error, log a warning and return `null`. This matches the existing fail-open pattern in handlers.
  </action>
  <verify>
    Create a basic test in `src/knowledge/retrieval.test.ts` that:
    1. Creates a retriever with mock embedding provider and isolation layer
    2. Calls `retrieve()` with a single query and verifies it returns results
    3. Calls `retrieve()` with multiple queries and verifies variant execution
    4. Verifies `retrieve()` returns null when config.retrieval.enabled is false
    5. Verifies fail-open: when embedding provider throws, returns null

    Run `bun test src/knowledge/retrieval.test.ts` — all tests pass.
    Run `bun test` — full test suite passes.
  </verify>
  <done>
    src/knowledge/retrieval.ts exports createRetriever() with a retrieve() function that accepts text queries and returns ranked, reranked, threshold-filtered results with snippet anchors. src/knowledge/index.ts provides barrel exports for the entire knowledge module. Tests verify single-query, multi-query, disabled, and fail-open scenarios.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes with zero failures
- `src/knowledge/retrieval.ts` exists and exports `createRetriever` and `retrieve` types
- `src/knowledge/embeddings.ts` exists and exports embedding provider factories
- `src/knowledge/index.ts` provides barrel exports for the entire module
- All learning module code has canonical home in `src/knowledge/` with shims in `src/learning/`
- Existing handler imports work unchanged via re-export shims
</verification>

<success_criteria>
- All code from src/learning/ has been moved to src/knowledge/ with re-export shims
- retrieval.ts provides a text-in, results-out API with multi-query as first-class
- All reranking, recency, adaptive threshold logic encapsulated inside retrieve()
- Full test suite passes including new retrieval.test.ts
</success_criteria>

<output>
After completion, create `.planning/phases/88-knowledge-layer-extraction/88-01-SUMMARY.md`
</output>
