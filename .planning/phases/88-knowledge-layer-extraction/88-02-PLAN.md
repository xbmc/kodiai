---
phase: 88-knowledge-layer-extraction
plan: 02
type: execute
wave: 2
depends_on:
  - 88-01
files_modified:
  - src/handlers/review.ts
  - src/handlers/mention.ts
  - src/slack/assistant-handler.ts
  - src/index.ts
  - src/learning/
autonomous: true
requirements:
  - KNW-03
  - KNW-05
  - KNW-06

must_haves:
  truths:
    - "Handlers call retrieve() from src/knowledge/ and get back final ranked results without orchestrating reranking/thresholds"
    - "Slack assistant handler retrieves context from the same knowledge module as GitHub review"
    - "No import from src/learning/ exists anywhere in the codebase"
    - "E2E test proves Slack and PR review use the same retrieve() code path"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "PR review handler using knowledge/retrieval"
      contains: "from.*knowledge"
    - path: "src/handlers/mention.ts"
      provides: "Mention handler using knowledge/retrieval"
      contains: "from.*knowledge"
    - path: "src/slack/assistant-handler.ts"
      provides: "Slack assistant with knowledge retrieval"
      contains: "from.*knowledge"
    - path: "src/knowledge/retrieval.e2e.test.ts"
      provides: "E2E test proving shared retrieval path"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/knowledge/retrieval.ts"
      via: "createRetriever().retrieve()"
      pattern: "retrieve\\("
    - from: "src/slack/assistant-handler.ts"
      to: "src/knowledge/retrieval.ts"
      via: "createRetriever().retrieve()"
      pattern: "retrieve\\("
---

<objective>
Wire all handlers (review, mention, Slack assistant) to use the unified `src/knowledge/` module, add Slack retrieval support, write the E2E test, and delete `src/learning/` entirely.

Purpose: Complete the knowledge layer extraction by making all consumers use the unified module, proving shared code path with an E2E test, and removing the old `src/learning/` directory.

Output: Refactored handlers, Slack retrieval, E2E test, deleted `src/learning/`.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/88-knowledge-layer-extraction/88-01-SUMMARY.md
@src/handlers/review.ts
@src/handlers/mention.ts
@src/slack/assistant-handler.ts
@src/index.ts
@src/knowledge/retrieval.ts
@src/knowledge/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor review and mention handlers to use knowledge/retrieval, add Slack retrieval</name>
  <files>
    src/handlers/review.ts
    src/handlers/mention.ts
    src/slack/assistant-handler.ts
    src/index.ts
  </files>
  <action>
    **Review handler refactor** (`src/handlers/review.ts`):

    Replace the ~200 lines of retrieval orchestration (lines ~2013-2210) with a single call to `retrieve()`:

    1. Remove these imports from `src/learning/`:
       - `rerankByLanguage` from `retrieval-rerank`
       - `applyRecencyWeighting` from `retrieval-recency`
       - `computeAdaptiveThreshold` from `adaptive-threshold`
       - `buildRetrievalVariants`, `executeRetrievalVariants`, `mergeVariantResults` from `multi-query-retrieval`
       - `buildSnippetAnchors` from `retrieval-snippets`
       - `IsolationLayer` from `isolation`
       - `EmbeddingProvider` from `types`

    2. Add import: `import { createRetriever, type RetrieveResult } from "../knowledge/retrieval.ts";`
       Keep importing `LearningMemoryStore` and `LearningMemoryRecord` from `"../knowledge/types.ts"` (still needed for write path).
       Keep importing `buildRetrievalVariants` from `"../knowledge/multi-query-retrieval.ts"` (needed to build variant queries from PR metadata).

    3. In the handler factory, accept a `retriever` (return type of `createRetriever()`) instead of separate `embeddingProvider`, `isolationLayer`, `retrievalReranker`, `retrievalRecency`, `adaptiveThreshold` dependencies.
       Keep `embeddingProvider` and `learningMemoryStore` — still needed for the WRITE path (storing new memories after review).

    4. Replace the retrieval block with:
       ```typescript
       let retrievalCtx: RetrievalContextForPrompt | null = null;
       if (retriever) {
         const variants = buildRetrievalVariants({ title, body, conventionalType, prLanguages, riskSignals, filePaths, authorTier });
         const result = await retriever.retrieve({
           repo,
           owner,
           queries: variants.map(v => v.query),
           workspaceDir: workspace.dir,
           prLanguages,
           logger,
         });
         if (result) {
           retrievalCtx = {
             maxChars: config.knowledge.retrieval.maxContextChars,
             findings: result.findings,
             snippetAnchors: result.snippetAnchors,
           };
         }
       }
       ```

    **Mention handler refactor** (`src/handlers/mention.ts`):

    Apply the same pattern. The mention handler has a simpler retrieval block (lines ~1152-1330). Replace with:

    1. Remove learning/ imports, add knowledge/ imports (same as review).
    2. Keep `buildRetrievalVariants` import for building variant queries from mention context.
    3. Replace retrieval block with `retriever.retrieve()` call.
    4. The mention handler uses `topK: Math.max(1, Math.min(config.knowledge.retrieval.topK, 3))` — pass this as `topK` override to `retrieve()`.

    **Slack assistant handler** (`src/slack/assistant-handler.ts`):

    Add retrieval to the Slack assistant. Per user decisions:
    - Slack uses a simpler single-query approach (user's message as the query)
    - Retrieved context is woven into the system prompt inline
    - Slack gets broader isolation: can retrieve across all repos the owner has
    - When no repo context is available, skip retrieval entirely

    Implementation:
    1. Add `retriever` to `SlackAssistantHandlerDeps` (optional, for backward compat in tests).
    2. In the read-only execution path (after resolving repo context, before calling `execute()`):
       - If `retriever` is available and repo context is resolved:
         - Call `retriever.retrieve({ repo: fullRepo, owner, queries: [messageText], logger, topK: 3 })`
         - If results returned with findings, weave into the prompt naturally:
           - Append to `buildSlackAssistantPrompt` output a section like:
             ```
             Related context from past reviews (use naturally, do not cite directly):
             - [finding text summary] (file: path, severity)
             ```
         - Keep it to max 3 findings to avoid prompt bloat
       - If no repo context or retriever unavailable, skip (no retrieval)

    **Index.ts update** (`src/index.ts`):

    1. Replace learning/ imports with knowledge/ imports:
       - `createLearningMemoryStore` from `"./knowledge/memory-store.ts"`
       - `createEmbeddingProvider`, `createNoOpEmbeddingProvider` from `"./knowledge/embeddings.ts"`
       - Types from `"./knowledge/types.ts"`
       - `createIsolationLayer` from `"./knowledge/isolation.ts"`

    2. After creating `isolationLayer`, create the retriever:
       ```typescript
       import { createRetriever } from "./knowledge/retrieval.ts";
       const retriever = isolationLayer && embeddingProvider
         ? createRetriever({ embeddingProvider, isolationLayer, config: { retrieval: { enabled: true, topK: 5, distanceThreshold: 0.3, adaptive: true, maxContextChars: 2000 }, sharing: { enabled: false } } })
         : undefined;
       ```
       Note: the actual config values come from the resolved app config. Read the config defaults from the config schema or pass a sensible default matching the current production values.

    3. Pass `retriever` to handler factories instead of separate `embeddingProvider` + `isolationLayer` (for retrieval — keep embeddingProvider for write path).

    4. Pass `retriever` to Slack assistant handler deps.
  </action>
  <verify>
    Run `bun test src/handlers/review.test.ts` — all review handler tests pass.
    Run `bun test src/handlers/mention.test.ts` — all mention handler tests pass.
    Run `bun test src/slack/assistant-handler.test.ts` — all Slack tests pass.
    Run `bun test` — full test suite passes.

    Verify no imports from `src/learning/` remain:
    `grep -r "from.*['\"].*learning/" src/ --include="*.ts" | grep -v "src/learning/" | grep -v node_modules` returns empty.
  </verify>
  <done>
    All handlers import from src/knowledge/ exclusively. Review and mention handlers use retrieve() instead of orchestrating the pipeline. Slack assistant handler retrieves context using the same retrieve() function. src/index.ts creates and wires the retriever.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add E2E test and delete src/learning/</name>
  <files>
    src/knowledge/retrieval.e2e.test.ts
    src/learning/ (delete entire directory)
  </files>
  <action>
    **E2E test** (`src/knowledge/retrieval.e2e.test.ts`):

    Create an integration test that proves Slack and PR review retrieve from the same corpus using the same code path. This is a mock-based integration test (not hitting real DB) that verifies the CONTRACT: both code paths call the same `retrieve()` function.

    Test structure:
    ```typescript
    import { describe, it, expect, vi } from "vitest";
    import { createRetriever } from "./retrieval.ts";
    // ... other imports

    describe("Knowledge Layer E2E: shared retrieval path", () => {
      // Setup: create a retriever with mock embedding provider and isolation layer
      // The mock isolation layer returns consistent results for any query

      it("PR review and Slack assistant use the same retrieve() function", async () => {
        // Create ONE retriever instance (same as production wiring)
        const retriever = createRetriever({ ... });

        // Simulate PR review retrieval: multiple queries (intent, file-path, code-shape)
        const prResult = await retriever.retrieve({
          repo: "owner/repo",
          owner: "owner",
          queries: ["fix auth bug in login flow", "src/auth/login.ts src/middleware/auth.ts", "typescript security authentication"],
          prLanguages: ["TypeScript"],
          logger: mockLogger,
        });

        // Simulate Slack retrieval: single query (user message)
        const slackResult = await retriever.retrieve({
          repo: "owner/repo",
          owner: "owner",
          queries: ["how does the auth login work?"],
          logger: mockLogger,
        });

        // Both return results from the same retriever
        expect(prResult).not.toBeNull();
        expect(slackResult).not.toBeNull();

        // Both used the same isolation layer (mock was called for both)
        // Verify the mock was called with consistent parameters
        expect(mockIsolationLayer.retrieveWithIsolation).toHaveBeenCalledTimes(/* 3 for PR + 1 for Slack = 4 */);

        // Both results have the same shape
        expect(prResult!.findings).toBeDefined();
        expect(slackResult!.findings).toBeDefined();
        expect(prResult!.provenance).toBeDefined();
        expect(slackResult!.provenance).toBeDefined();
      });

      it("Slack retrieval with no repo context returns null", async () => {
        const retriever = createRetriever({ ... });
        // Empty queries = no retrieval
        const result = await retriever.retrieve({
          repo: "owner/repo",
          owner: "owner",
          queries: [],
          logger: mockLogger,
        });
        expect(result).toBeNull();
      });

      it("both paths share reranking and threshold pipeline", async () => {
        // Setup mock that returns known distances
        // Verify that both PR and Slack results are reranked and threshold-filtered identically
        // (same distances in → same ordering out)
      });
    });
    ```

    **Delete src/learning/**:

    Remove the entire `src/learning/` directory. This is a clean break — no backward-compat re-exports.

    Verify NO file in the codebase imports from `src/learning/`:
    - Search for `from.*learning/` in all `.ts` files outside `src/learning/`
    - If any remain, update them to import from `src/knowledge/`

    Also clean up any references to `src/learning/` in:
    - `tsconfig.json` paths (if any)
    - Any build/lint config that references the directory
  </action>
  <verify>
    Run `bun test src/knowledge/retrieval.e2e.test.ts` — E2E test passes.
    Run `bun test` — full test suite passes with no failures.

    Verify deletion:
    `ls src/learning/` returns "No such file or directory".
    `grep -r "from.*['\"].*learning/" src/ --include="*.ts" | grep -v node_modules` returns empty.

    Verify success criteria:
    1. `src/knowledge/retrieval.ts` exists — YES
    2. `src/knowledge/embeddings.ts` exists — YES
    3. Slack handler imports from `src/knowledge/` — grep confirms
    4. E2E test proves shared path — test file exists and passes
    5. No duplicate DB query logic — src/learning/ deleted
  </verify>
  <done>
    E2E test proves Slack and PR review use the same retrieve() code path. src/learning/ is fully deleted with no remaining imports. All phase 88 success criteria met.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes with zero failures
- `ls src/learning/` returns "No such file or directory"
- `grep -r "from.*learning/" src/ --include="*.ts" | grep -v node_modules` returns empty
- `grep -r "from.*knowledge/retrieval" src/handlers/ src/slack/ --include="*.ts"` shows all handlers importing from knowledge
- E2E test in `src/knowledge/retrieval.e2e.test.ts` passes and proves shared code path
- Phase 88 success criteria 1-4 all met
</verification>

<success_criteria>
- All handlers use src/knowledge/ for retrieval — no src/learning/ imports anywhere
- Slack assistant handler retrieves context using the same retrieve() function as PR review
- E2E test proves shared retrieval path between Slack and GitHub
- src/learning/ directory completely removed
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/88-knowledge-layer-extraction/88-02-SUMMARY.md`
</output>
