---
phase: 65-permission-disabled-ux-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "When an issue `@kodiai apply:` or `@kodiai change:` request arrives while write mode is disabled, Kodiai replies in-thread with an actionable enablement message"
    - "The disabled-write reply includes the minimal `.kodiai.yml` snippet needed to enable write mode"
    - "The disabled-write reply tells the user they can retry the same apply/change command after enabling write mode"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Issue write-disabled refusal message with explicit `.kodiai.yml` guidance"
      contains: "Write mode is disabled for this repo"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for issue write-disabled guidance contract"
      contains: "write mode is disabled"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "issue_comment apply/change tests assert disabled-write reply content"
      pattern: "Write mode is disabled for this repo|Update `\\.kodiai\\.yml`"
---

<objective>
Harden disabled-write UX for issue apply/change requests so users receive deterministic, actionable remediation instead of a generic refusal.

Purpose: Satisfy PERM-02 by ensuring write-mode-disabled responses always tell users exactly what to change and how to retry without guesswork.
Output: Updated disabled-write refusal copy in `mention.ts` plus regression tests that lock `.kodiai.yml` guidance and retry instructions.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-policy-guardrails-completion/64-01-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add regression tests for disabled-write issue guidance</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add focused issue-surface tests around existing disabled-write coverage to lock the UX contract for explicit write requests:

1) `@kodiai apply:` in issue comment with `write.enabled: false` posts exactly one issue-thread refusal reply and does not run executor.
2) The reply contains:
   - `Write mode is disabled for this repo.`
   - `Update .kodiai.yml` guidance (explicit file mention)
   - minimal snippet:
     ```yml
     write:
       enabled: true
     ```
   - a retry cue telling the user to rerun the same apply/change command.

Keep fixture style aligned with existing issue write-intent tests: `createWorkspaceFixture`, `buildIssueCommentMentionEvent`, capture `issues.createComment`, and assert `pulls.create` remains zero.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000` and confirm new disabled-write guidance assertions pass.
  </verify>
  <done>
Issue apply/change disabled-write behavior is regression-locked with explicit config-file guidance, minimal enablement snippet, and retry instruction checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update disabled-write refusal message to match actionable contract</name>
  <files>src/handlers/mention.ts</files>
  <action>
In the existing `if (isWriteRequest && !isPlanOnly && !config.write.enabled)` branch, update the refusal body to be directly actionable:

- Keep the clear refusal header (`Write mode is disabled for this repo.`).
- Add explicit `Update .kodiai.yml:` instruction before the snippet.
- Keep snippet minimal (`write.enabled: true`) per PERM-02.
- Add retry guidance telling users to rerun the same `@kodiai apply:`/`@kodiai change:` request once config is updated.

Do not include tokens, secrets, or broad troubleshooting text; this message should be deterministic and concise.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Disabled-write issue replies consistently include minimal `.kodiai.yml` enablement instructions plus retry guidance, and all mention-handler tests remain passing.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with disabled-write guidance assertions.
- `bunx tsc --noEmit` passes.
- Disabled-write issue apply/change path posts exactly one refusal reply and opens zero PRs.
</verification>

<success_criteria>
PERM-02 is satisfied: disabled write-mode issue requests always return minimal, actionable `.kodiai.yml` guidance and clear retry instructions.
</success_criteria>

<output>
After completion, create `.planning/phases/65-permission-disabled-ux-completion/65-01-SUMMARY.md`
</output>
