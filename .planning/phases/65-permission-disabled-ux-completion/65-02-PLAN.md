---
phase: 65-permission-disabled-ux-completion
plan: 02
type: execute
wave: 2
depends_on: [65-01]
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "When issue write-mode PR creation fails due to missing GitHub App permissions, Kodiai replies in-thread with actionable remediation instead of a generic API error"
    - "Permission refusal guidance lists minimum required permission scopes for write-mode PR creation"
    - "Permission failure replies avoid leaking tokens, secret values, or raw sensitive payload fragments"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Permission-failure detection and issue-thread remediation message for write-mode"
      contains: "permission|permissions|Resource not accessible"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for issue write-mode permission failure UX"
      contains: "Resource not accessible by integration"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "issue apply tests simulate GitHub 403/permission errors and assert remediation reply"
      pattern: "missing GitHub App permissions|Resource not accessible by integration|Opened PR"
---

<objective>
Implement permission-failure UX for issue write-mode so push/PR-create authorization errors produce actionable, non-sensitive remediation guidance.

Purpose: Satisfy PERM-01 by replacing generic API-error fallbacks with deterministic permission guidance that users can act on to successfully retry.
Output: Permission-aware write failure handling in `mention.ts` and regression tests proving issue-thread replies include minimum permission requirements.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-issue-write-mode-pr-creation/62-03-SUMMARY.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
@src/lib/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add failing regression tests for issue write-mode permission failures</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add issue-surface regression tests that simulate permission failures during write-mode PR creation:

1) **PR create permission failure path**
   - Trigger: `@kodiai apply:` issue comment with `write.enabled: true`.
   - Mock `octokit.rest.pulls.create` to throw a 403-style error (`Resource not accessible by integration`).
   - Assert one issue reply and zero successful PR-open replies.
   - Assert reply contains:
     - explicit permission-failure reason,
     - minimum required permissions list (at least `Contents: Read and write`, `Pull requests: Read and write`, `Issues: Read and write`),
     - retry guidance after permissions are updated.
   - Assert reply does not include raw tokens/secrets.

2) **Push-permission classification contract**
   - Add one additional regression using a push/remote-auth style error message (for example, remote denied / not permitted text) on the write path before PR creation.
   - Assert the same permission remediation reply shape is used (not generic `api_error` fallback wording).

Keep test setup aligned with existing issue write-mode fixtures and idempotency tests.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000` and confirm both new permission-failure tests fail before implementation.
  </verify>
  <done>
Two failing tests capture the expected permission-remediation contract for both PR-create and push-related write failures.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement permission-aware refusal handling for write-mode failures</name>
  <files>src/handlers/mention.ts</files>
  <action>
Implement a permission-failure detection path in write-mode handling and route it to deterministic issue-thread guidance:

- Add a helper (local or exported) that classifies likely GitHub App permission failures from known signals (`status 403`, `Resource not accessible by integration`, permission denied push/auth text, GraphQL forbidden variants).
- Use this helper in both critical write-mode failure points:
  1) branch/commit/push path failures before PR creation,
  2) `octokit.rest.pulls.create` failure.
- When detected, post a dedicated refusal reply (via existing `postMentionReply`) that includes:
  - concise cause: missing GitHub App permissions,
  - minimum required permissions for write-mode PR creation,
  - actionable retry instruction after updating app/repo installation permissions.
- Preserve existing policy refusal handling and idempotency behavior; only permission-classified failures should use the new message.
- Keep message non-sensitive: do not echo token-like values or full raw stack traces.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bun test`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Issue write-mode permission failures now produce actionable, non-sensitive in-thread guidance with minimum permissions and retry steps, and all mention-handler regressions pass.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with permission-failure regressions.
- `bun test` full suite passes.
- `bunx tsc --noEmit` passes.
- Permission-classified write failures produce one actionable issue reply and no false `Opened PR:` success output.
</verification>

<success_criteria>
PERM-01 is satisfied: missing-permission push/PR-create failures in issue write-mode return explicit, actionable minimum-permission guidance without sensitive leakage.
</success_criteria>

<output>
After completion, create `.planning/phases/65-permission-disabled-ux-completion/65-02-SUMMARY.md`
</output>
