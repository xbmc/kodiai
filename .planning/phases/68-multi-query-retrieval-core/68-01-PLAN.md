---
phase: 68-multi-query-retrieval-core
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/learning/multi-query-retrieval.ts
  - src/learning/multi-query-retrieval.test.ts
autonomous: true

must_haves:
  truths:
    - "Given one request context, retrieval query expansion emits bounded intent, file-path, and code-shape variants"
    - "Deterministic merge/rerank returns stable ordering for equivalent inputs across runs"
    - "Variant-level failures are isolated so successful variants still produce merged output"
  artifacts:
    - path: "src/learning/multi-query-retrieval.ts"
      provides: "Pure utilities to build variant queries and deterministically merge/rerank variant results"
      exports: ["buildRetrievalVariants", "mergeVariantResults", "MultiQueryVariant", "MergedRetrievalResult"]
    - path: "src/learning/multi-query-retrieval.test.ts"
      provides: "Red-green regression suite for bounded variant generation, deterministic merge stability, and per-variant fail-open handling"
      min_lines: 110
  key_links:
    - from: "src/learning/multi-query-retrieval.test.ts"
      to: "src/learning/multi-query-retrieval.ts"
      via: "imports and validates both buildRetrievalVariants and mergeVariantResults"
      pattern: "import.*buildRetrievalVariants|mergeVariantResults"
---

<objective>
Build the RET-07 algorithmic core with TDD: deterministic multi-query expansion plus deterministic merged ranking behavior.

Purpose: Phase 68 depends on predictable retrieval behavior under retries, cache reuse, and fail-open error handling. A pure-function TDD module isolates that logic and locks correctness before pipeline wiring.
Output: `src/learning/multi-query-retrieval.ts` and `src/learning/multi-query-retrieval.test.ts` with RED->GREEN coverage for variant generation, stable ordering, and error isolation.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-intelligent-retrieval/52-01-SUMMARY.md
@.planning/phases/67-rate-limit-resilience-telemetry/67-01-SUMMARY.md
@src/learning/retrieval-query.ts
@src/learning/retrieval-rerank.ts
@src/learning/retrieval-recency.ts
</context>

<feature>
  <name>Deterministic Multi-Query Expansion and Merge</name>
  <files>src/learning/multi-query-retrieval.ts, src/learning/multi-query-retrieval.test.ts</files>
  <behavior>
    Add two pure functions and associated types:

    1) `buildRetrievalVariants(input) -> MultiQueryVariant[]`
       - Inputs include base signals already available in review retrieval (`title`, `body`, `conventionalType`, `prLanguages`, `riskSignals`, `filePaths`, `authorTier`).
       - Always produce bounded variants in fixed order: `intent`, `file-path`, `code-shape`.
       - Bound each variant string length (reuse existing query-length limit conventions) and keep variant count fixed at 3.

    2) `mergeVariantResults({ resultsByVariant, topK }) -> MergedRetrievalResult[]`
       - Accepts result sets from multiple variants, deduplicates by stable memory identity (`memory.id` fallback fingerprint), and combines scores deterministically.
       - Tie-breakers must be deterministic (variant priority then stable lexical/id ordering), never input-array order dependent.
       - Variant-level failures are excluded from ranking input but must not throw.

    Cases to lock in tests:
    - Same semantic input with different whitespace/casing yields equal variant output.
    - File-path variant emphasizes changed paths and trims to bounded count.
    - Code-shape variant includes language/risk/code tokens and remains bounded.
    - Merge de-duplicates overlapping hits across variants and produces stable topK ordering.
    - Empty/single-variant success still returns valid merged output.
    - One variant throws/fails -> merge still succeeds from remaining variants (fail-open).
  </behavior>
  <implementation>
    Follow existing retrieval-module conventions from `retrieval-query.ts`, `retrieval-rerank.ts`, and `retrieval-recency.ts`:
    - Keep this module pure (no network, no filesystem, no handler coupling).
    - Normalize text aggressively for deterministic equivalence (trim, collapse whitespace, lowercase where appropriate).
    - Use explicit variant weights/priorities that are easy to test and stable.
    - Export minimal types needed by handlers for integration in Plan 68-02.
  </implementation>
</feature>

<verification>
- `bun test src/learning/multi-query-retrieval.test.ts --timeout 30000` passes.
- `bunx tsc --noEmit` passes.
- Tests prove deterministic behavior by asserting equal outputs across reordered equivalent inputs.
</verification>

<success_criteria>
- RET-07 core behavior exists as pure, test-covered utilities for bounded variant generation and deterministic merge/rerank.
- Module is integration-ready for both review and mention pipelines without introducing side effects.
</success_criteria>

<output>
After completion, create `.planning/phases/68-multi-query-retrieval-core/68-01-SUMMARY.md`
</output>
