---
phase: 68-multi-query-retrieval-core
plan: 02
type: execute
wave: 2
depends_on: [68-01]
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
  - src/learning/multi-query-retrieval.ts
autonomous: true

must_haves:
  truths:
    - "Review and mention flows execute bounded intent/file-path/code-shape retrieval variants from one request context"
    - "Merged retrieval context ordering is deterministic and stable for equivalent inputs in both surfaces"
    - "If one retrieval variant errors, the flow fails open and still responds using successful variants"
    - "Multi-query integration stays within current operational latency guardrails"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Review pipeline wiring that executes variant retrieval, deterministic merge, and fail-open degradation"
      contains: "buildRetrievalVariants"
    - path: "src/handlers/mention.ts"
      provides: "Mention pipeline retrieval wiring using the same multi-query/merge contract as review"
      contains: "mergeVariantResults"
    - path: "src/execution/mention-prompt.ts"
      provides: "Prompt section to consume merged retrieval findings for mention replies"
      contains: "Retrieval"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for multi-query mention retrieval and per-variant fail-open behavior"
      contains: "multi-query"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/learning/multi-query-retrieval.ts"
      via: "review retrieval path uses buildRetrievalVariants and mergeVariantResults"
      pattern: "buildRetrievalVariants|mergeVariantResults"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "merged retrieval context passed into mention prompt builder"
      pattern: "buildMentionPrompt"
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "tests assert fail-open response when one variant fails"
      pattern: "fail-open|variant"
---

<objective>
Integrate Phase 68 multi-query retrieval into live review and mention execution paths with deterministic merged context and fail-open behavior.

Purpose: Deliver full RET-07 outcome across user-facing surfaces, not only pure functions, while preserving reliability and latency constraints established in Phases 66-67.
Output: Review and mention handlers use shared multi-query retrieval orchestration, prompt wiring is updated, and regressions lock deterministic/fail-open behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/68-multi-query-retrieval-core/68-01-PLAN.md
@.planning/phases/52-intelligent-retrieval/52-02-SUMMARY.md
@.planning/phases/67-rate-limit-resilience-telemetry/67-02-SUMMARY.md
@src/handlers/review.ts
@src/handlers/mention.ts
@src/execution/mention-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire multi-query retrieval orchestration into review pipeline</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts, src/learning/multi-query-retrieval.ts</files>
  <action>
Integrate Plan 68-01 utilities into the existing review retrieval path:

1) Replace single-query retrieval call path with bounded 3-variant execution (`intent`, `file-path`, `code-shape`) built from existing review signals.
2) Run variants with bounded concurrency and shared topK budget so latency remains within current operational expectations (do not serially chain all variants).
3) Merge/rerank variant outputs via `mergeVariantResults`, preserving deterministic order guarantees.
4) Keep fail-open behavior strict: if one variant errors, log and continue with successful variants; only drop retrieval context entirely if all variants fail.
5) Add review regressions for deterministic ordering, partial-variant failure, and bounded variant execution counts.

Do not change Phase 67 rate-limit retry policy (still exactly one bounded retry in Search enrichment paths).
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Review retrieval uses deterministic multi-query merge output with fail-open variant handling and no regression to existing reliability guarantees.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend mention flow to use multi-query retrieval context</name>
  <files>src/handlers/mention.ts, src/handlers/mention.test.ts, src/execution/mention-prompt.ts, src/execution/mention-prompt.test.ts</files>
  <action>
Add RET-07 parity for mention replies:

- Introduce retrieval context assembly in mention handling using the same variant-generation and merge contract as review.
- Feed merged retrieval findings into `buildMentionPrompt` with bounded context size so mention responses remain concise.
- Ensure mention retrieval integration is fail-open: any retrieval or variant error logs and falls back to normal mention response generation.
- Add regressions that verify:
  1) multi-query retrieval is invoked for mention surfaces,
  2) merged context is included when available,
  3) partial/all variant errors do not block mention reply publication.

Preserve existing no-unsolicited-response and write-mode gating behavior unchanged.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bun test src/execution/mention-prompt.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Mention replies gain deterministic multi-query retrieval context with fail-open safety and no behavior regressions outside retrieval enrichment.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts --timeout 30000` passes with multi-query deterministic merge and fail-open variant assertions.
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with mention retrieval parity assertions.
- `bun test src/execution/mention-prompt.test.ts --timeout 30000` passes with merged retrieval context rendering coverage.
- `bunx tsc --noEmit` passes.
</verification>

<success_criteria>
RET-07 is satisfied in production paths: review and mention flows both execute bounded multi-query retrieval, deterministically merge results, and fail open when variant-level errors occur.
</success_criteria>

<output>
After completion, create `.planning/phases/68-multi-query-retrieval-core/68-02-SUMMARY.md`
</output>
