---
phase: 17-write-mode-reliability
plan: 01
type: execute
wave: 1
depends_on:
  - 16-write-guardrails/16-01-SUMMARY.md
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - src/jobs/workspace.ts
autonomous: true

must_haves:
  truths:
    - "Write-mode is idempotent for a given trigger comment (redeliveries do not create extra PRs)"
    - "Concurrent or repeated write intents for the same comment are skipped with an existing PR link"
    - "Locking/idempotency does not affect non-write mention replies"
  artifacts:
    - path: src/handlers/mention.ts
      provides: "Write-mode idempotency key based on triggering comment + PR context"
    - path: src/handlers/mention.ts
      provides: "Existing PR discovery by deterministic branch name"
---

<objective>
Strengthen write-mode reliability by adding idempotency and lightweight in-process locking so redeliveries and retries do not create duplicate branches/PRs.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Deterministic write output key + branch name</name>
  <files>src/handlers/mention.ts src/jobs/workspace.ts</files>
  <action>
  Build a stable write output key for mention-driven writes using:
  - installationId
  - owner/repo
  - source prNumber
  - triggering commentId
  - keyword (apply/change)

  Derive a safe branch name from the key (hash/short form) and validate it.
  </action>
  <verify>
  - Unit test covers deterministic branch name generation
  </verify>
</task>

<task type="auto">
  <name>Task 2: Existing PR discovery and idempotent skip</name>
  <files>src/handlers/mention.ts src/handlers/mention.test.ts</files>
  <action>
  Before running write-mode executor, attempt to find an existing PR for the deterministic head branch:
  - If found, reply with the existing PR URL and exit without doing any work.

  Also handle the case where branch push fails because the branch already exists: fall back to PR discovery and reply.
  </action>
  <verify>
  - Unit test: existing PR found => executor not called and reply contains URL
  </verify>
</task>

<task type="auto">
  <name>Task 3: Lightweight in-process locking</name>
  <files>src/handlers/mention.ts</files>
  <action>
  Add a best-effort in-process lock keyed by the write output key to prevent duplicate work when the same trigger is handled twice concurrently.
  Ensure locks are released in finally.
  </action>
  <verify>
  - bun test
  </verify>
</task>

</tasks>

<verification>
- bun test
</verification>

<output>
Create `.planning/phases/17-durability-locking/17-01-SUMMARY.md`.
</output>
