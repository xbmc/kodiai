---
phase: 55-merge-confidence-scoring
plan: 02
type: execute
wave: 2
depends_on: ["55-01"]
files_modified:
  - src/lib/dep-bump-detector.ts
  - src/execution/review-prompt.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Dep bump PRs include merge confidence badge and rationale in the LLM review prompt"
    - "The Verdict section instructions tell the LLM to incorporate merge confidence for dep bump PRs"
    - "Merge confidence is computed after enrichment and before prompt construction in review.ts"
    - "Silent approval body includes confidence line for dep bump PRs"
    - "Non-dep-bump PRs are completely unaffected"
  artifacts:
    - path: "src/lib/dep-bump-detector.ts"
      provides: "DepBumpContext type extended with optional mergeConfidence field"
      contains: "mergeConfidence"
    - path: "src/execution/review-prompt.ts"
      provides: "Confidence badge rendering in buildDepBumpSection + verdict integration instructions"
      contains: "Merge Confidence"
    - path: "src/handlers/review.ts"
      provides: "computeMergeConfidence call wired after enrichment block"
      contains: "computeMergeConfidence"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/merge-confidence.ts"
      via: "imports and calls computeMergeConfidence"
      pattern: "import.*computeMergeConfidence.*merge-confidence"
    - from: "src/execution/review-prompt.ts"
      to: "src/lib/merge-confidence.ts"
      via: "imports MergeConfidenceLevel type for rendering"
      pattern: "import.*MergeConfidenceLevel.*merge-confidence"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "depBumpContext with mergeConfidence flows to buildReviewPrompt"
      pattern: "depBumpContext"
---

<objective>
Wire merge confidence scoring into the review pipeline: compute confidence after enrichment in `review.ts`, render it prominently in the dep bump prompt section, add verdict integration instructions, and append confidence to silent approval body for dep bump PRs.

Purpose: CONF-02 requires merge confidence displayed prominently in the review summary with supporting rationale. This plan connects the scoring function (plan 55-01) to the review output.
Output: Modified `dep-bump-detector.ts` (type), `review-prompt.ts` (rendering), `review.ts` (wiring + approval body).
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/55-merge-confidence-scoring/55-RESEARCH.md
@.planning/phases/55-merge-confidence-scoring/55-01-SUMMARY.md
@src/lib/dep-bump-detector.ts
@src/lib/merge-confidence.ts
@src/execution/review-prompt.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend DepBumpContext type and render confidence in review prompt</name>
  <files>src/lib/dep-bump-detector.ts, src/execution/review-prompt.ts</files>
  <action>
    **In `src/lib/dep-bump-detector.ts`:**
    Add an optional `mergeConfidence` field to the `DepBumpContext` type:
    ```typescript
    /** Phase 55: Merge confidence assessment (null when computation skipped) */
    mergeConfidence?: import("./merge-confidence.ts").MergeConfidence | null;
    ```

    **In `src/execution/review-prompt.ts`:**

    1. Import `MergeConfidenceLevel` type from `../lib/merge-confidence.ts`.

    2. In `buildDepBumpSection`, after the intro line (`"This PR is an automated dependency update..."`) and before the details bullets, add confidence badge rendering:

    ```typescript
    if (ctx.mergeConfidence) {
      const emojiMap: Record<MergeConfidenceLevel, string> = {
        high: ":green_circle:",
        medium: ":yellow_circle:",
        low: ":red_circle:",
      };
      const labelMap: Record<MergeConfidenceLevel, string> = {
        high: "High Confidence",
        medium: "Review Recommended",
        low: "Careful Review Required",
      };
      lines.push(
        `**Merge Confidence: ${emojiMap[ctx.mergeConfidence.level]} ${labelMap[ctx.mergeConfidence.level]}**`,
      );
      for (const r of ctx.mergeConfidence.rationale) {
        lines.push(`- ${r}`);
      }
      lines.push("");
    }
    ```

    3. After the enrichment sections (security + changelog) at the end of `buildDepBumpSection`, add verdict integration instructions when merge confidence is present:

    ```typescript
    if (ctx.mergeConfidence) {
      lines.push(
        "",
        "When writing your ## Verdict, include the merge confidence assessment.",
        "Merge confidence reflects dependency version change risk (semver, advisories, breaking changes).",
        "Your Verdict reflects code review findings. Both assessments are independent.",
        "If they conflict, explain why (e.g., 'dependency change is low-risk but code issues exist').",
      );
    }
    ```

    Keep the confidence badge to 3-5 lines max. Do not over-instruct the LLM -- brief rationale bullets are sufficient.
  </action>
  <verify>
    `bunx tsc --noEmit` succeeds. Grep for "Merge Confidence" in `review-prompt.ts` confirms rendering code exists. Grep for "mergeConfidence" in `dep-bump-detector.ts` confirms type extension.
  </verify>
  <done>
    DepBumpContext has optional mergeConfidence field. buildDepBumpSection renders confidence badge with emoji, label, and rationale bullets at the top of the section. Verdict integration instructions appear at the end of the section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire confidence computation into review handler and silent approval</name>
  <files>src/handlers/review.ts</files>
  <action>
    1. Add import at the top of `review.ts`:
    ```typescript
    import { computeMergeConfidence } from "../lib/merge-confidence.ts";
    ```

    2. After the dep bump enrichment block (the `if (depBumpContext && depBumpContext.details.packageName && !depBumpContext.details.isGroup)` block ending around line ~1465), add merge confidence computation for ALL dep bump contexts (including group bumps):

    ```typescript
    // ── Merge confidence scoring (CONF-01/02) ──
    if (depBumpContext) {
      depBumpContext.mergeConfidence = computeMergeConfidence(depBumpContext);
      logger.info({
        ...baseLog,
        gate: "merge-confidence",
        level: depBumpContext.mergeConfidence.level,
        rationale: depBumpContext.mergeConfidence.rationale,
      }, "Merge confidence computed");
    }
    ```

    3. In the silent approval path (around line ~2608-2614), modify the approval body to include confidence for dep bump PRs. The current code is:
    ```typescript
    body: sanitizeOutgoingMentions(idempotencyCheck.marker, [appSlug, "claude"]),
    ```

    Change it to append a confidence line when depBumpContext has mergeConfidence:
    ```typescript
    body: sanitizeOutgoingMentions(
      depBumpContext?.mergeConfidence
        ? `${idempotencyCheck.marker}\n\n${renderApprovalConfidence(depBumpContext.mergeConfidence)}`
        : idempotencyCheck.marker,
      [appSlug, "claude"],
    ),
    ```

    Add a small helper function near the dep bump detection block (not exported, local to the handler):
    ```typescript
    function renderApprovalConfidence(mc: MergeConfidence): string {
      const emoji = mc.level === "high" ? ":green_circle:" : mc.level === "medium" ? ":yellow_circle:" : ":red_circle:";
      const label = mc.level === "high" ? "High" : mc.level === "medium" ? "Review Recommended" : "Careful Review Required";
      return `${emoji} **Merge Confidence: ${label}** — ${mc.rationale[0] ?? ""}`;
    }
    ```

    Import `MergeConfidence` type from `../lib/merge-confidence.ts` (type-only import).

    Ensure `depBumpContext` is in scope at the silent approval point. It is declared in the outer scope of the handler (around line ~1390), so it should already be accessible. Verify this by checking the variable's scope.
  </action>
  <verify>
    `bunx tsc --noEmit` succeeds. `bun test` passes (existing tests still pass). Grep for "merge-confidence" in `review.ts` confirms import and call. Grep for "renderApprovalConfidence" confirms approval body helper exists.
  </verify>
  <done>
    computeMergeConfidence is called after enrichment for every dep bump PR (including group bumps). The mergeConfidence field is populated on depBumpContext before prompt construction. Silent approval body includes a confidence line for dep bump PRs. Non-dep-bump PRs are unaffected (depBumpContext is null).
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` succeeds across all modified files
- `bun test` passes (no regressions)
- `bun test src/lib/merge-confidence.test.ts` passes (scoring function from plan 55-01)
- Grep confirms: "computeMergeConfidence" appears in review.ts, "Merge Confidence" appears in review-prompt.ts, "mergeConfidence" appears in dep-bump-detector.ts types
</verification>

<success_criteria>
- Dep bump PRs get a merge confidence badge rendered at the top of the Dependency Bump Context section
- The LLM is instructed to incorporate merge confidence into the Verdict section
- Silent approvals for dep bump PRs include a one-line confidence summary
- Group bumps get confidence scoring (medium with limited-signal rationale)
- Non-dep-bump PRs have zero code path changes
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/55-merge-confidence-scoring/55-02-SUMMARY.md`
</output>
