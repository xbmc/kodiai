---
phase: 72-telemetry-follow-through
plan: 02
type: execute
wave: 2
depends_on: [72-01]
files_modified:
  - scripts/phase72-telemetry-follow-through.ts
  - scripts/phase72-telemetry-follow-through.test.ts
  - package.json
  - docs/smoke/phase72-telemetry-follow-through.md
  - docs/runbooks/review-requested-debug.md
autonomous: true

must_haves:
  truths:
    - "Operator can run one deterministic, scripted verification sequence that covers both review_requested and explicit @kodiai mention surfaces"
    - "Verification sequence includes prime -> hit -> changed-query miss and proves cache-hit telemetry reflects all three outcomes"
    - "Operator receives two-layer evidence: DB-level assertions for exactly-once/non-blocking guarantees and a human-readable milestone summary"
    - "Reliability wording stays subtle and evidence-bound: risk acknowledgement in analysis text, no certainty claims without proof"
  artifacts:
    - path: "scripts/phase72-telemetry-follow-through.ts"
      provides: "Executable deterministic telemetry verification flow and DB assertion/report generation"
      contains: "prime"
    - path: "docs/smoke/phase72-telemetry-follow-through.md"
      provides: "Fixed once-per-milestone live verification procedure across both trigger surfaces"
      contains: "review_requested"
    - path: "docs/runbooks/review-requested-debug.md"
      provides: "Operator troubleshooting pointers for Phase 72 verification evidence collection"
      contains: "rate_limit_events"
  key_links:
    - from: "scripts/phase72-telemetry-follow-through.ts"
      to: "rate_limit_events"
      via: "DB-level truth assertions for composite idempotency, cache-hit sequence, and duplicate detection"
      pattern: "rate_limit_events|delivery_id|event_type"
    - from: "scripts/phase72-telemetry-follow-through.ts"
      to: "executions"
      via: "non-blocking completion checks join telemetry outcomes with execution conclusions"
      pattern: "executions|conclusion"
    - from: "docs/smoke/phase72-telemetry-follow-through.md"
      to: "scripts/phase72-telemetry-follow-through.ts"
      via: "runbook procedure invokes the script with fixed inputs/checkpoints once per milestone"
      pattern: "bun .*phase72-telemetry-follow-through"
---

<objective>
Ship a deterministic live verification harness for OPS-04/OPS-05 with operator-readable evidence artifacts.

Purpose: Phase 72 is complete only when operators can repeatedly prove cache-hit telemetry correctness and exactly-once/non-blocking degraded telemetry behavior from live-triggered runs, including both required trigger surfaces.
Output: One executable verification script plus smoke/runbook instructions that produce DB assertions and a human-readable reliability summary once per milestone.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/72-telemetry-follow-through/72-CONTEXT.md
@.planning/phases/67-rate-limit-resilience-telemetry/67-02-SUMMARY.md
@.planning/phases/71-search-cache-telemetry-wiring-fix/71-01-SUMMARY.md
@scripts/usage-report.ts
@docs/runbooks/review-requested-debug.md
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build scripted deterministic Phase 72 verification CLI</name>
  <files>scripts/phase72-telemetry-follow-through.ts, scripts/phase72-telemetry-follow-through.test.ts, package.json</files>
  <action>
Create a dedicated CLI script that automates Phase 72 verification with fixed inputs/checkpoints and explicit milestone cadence support:

- Implement deterministic scenario orchestration that covers both required surfaces: PR `review_requested` trigger and explicit `@kodiai` mention trigger.
- Encode the locked three-run cache sequence as first-class steps: prime (populate), verify hit (same query), and force miss (changed query).
- Emit two evidence layers in one run:
  1) DB truth assertions (duplicate detection by `delivery_id + event_type`, once-per-run rate-limit events, cache hit/miss sequence checks, non-blocking completion checks).
  2) Human-readable operator summary with explicit evidence references.
- Add a package script alias (for example `verify:phase72`) and deterministic unit tests for scenario-step ordering, SQL assertion logic, and summary rendering.

If any assertion fails, exit non-zero with actionable failure output that identifies which locked verification rule failed.
  </action>
  <verify>
Run `bun test scripts/phase72-telemetry-follow-through.test.ts --timeout 30000`.
Run `bun scripts/phase72-telemetry-follow-through.ts --help`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Operators can execute one script that deterministically runs/checks the required Phase 72 scenario and produces both DB-level and human-readable verification artifacts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Encode subtle reliability/demurral language in operator output templates</name>
  <files>scripts/phase72-telemetry-follow-through.ts, scripts/phase72-telemetry-follow-through.test.ts</files>
  <action>
Implement locked output-language guardrails directly in script-generated summaries:

- Keep reliability phrasing understated and professional (no playful or exaggerated language), while preserving clear risk acknowledgment.
- Place demurral/risk framing in analysis sections, not in final verdict statements.
- Require evidence-backed wording: final verdict lines must not claim certainty unless corresponding DB checks passed and are cited.
- Add tests that fail if summary wording violates these rules (e.g., certainty language without evidence markers, demurral text in verdict line).

Use concise operator emphasis stronger than user-facing text, while keeping both explicit and testable.
  </action>
  <verify>
Run `bun test scripts/phase72-telemetry-follow-through.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Generated operator summaries consistently use subtle evidence-based reliability language and pass automated guardrail checks for tone placement and certainty discipline.
  </done>
</task>

<task type="auto">
  <name>Task 3: Publish once-per-milestone runbook and smoke procedure</name>
  <files>docs/smoke/phase72-telemetry-follow-through.md, docs/runbooks/review-requested-debug.md</files>
  <action>
Document the live verification process with fixed operational checkpoints:

- Add a dedicated Phase 72 smoke doc containing exact command sequence, expected outputs, and failure interpretation for prime/hit/changed-query miss across both trigger surfaces.
- Explicitly state cadence requirement: run this scenario once per milestone and attach script output to release evidence.
- Update the review-requested runbook with DB query snippets and pointers for diagnosing duplicate emission, cache-hit mismatch, and telemetry-write-failure non-blocking behavior.
- Keep documentation tied to script outputs and deterministic evidence keys so operators do not improvise verification criteria.
  </action>
  <verify>
Run `bun scripts/phase72-telemetry-follow-through.ts --help`.
Manually read `docs/smoke/phase72-telemetry-follow-through.md` and confirm it references both `review_requested` and `@kodiai` flows with the three-run sequence.
  </verify>
  <done>
Phase 72 has a stable operator playbook with exact commands/checkpoints and explicit once-per-milestone cadence, backed by script-generated evidence artifacts.
  </done>
</task>

</tasks>

<verification>
- `bun test scripts/phase72-telemetry-follow-through.test.ts --timeout 30000` passes.
- `bun scripts/phase72-telemetry-follow-through.ts --help` succeeds and documents deterministic scenario inputs.
- `bunx tsc --noEmit` passes.
- Smoke/runbook docs match script behavior and include both required trigger surfaces + three-run cache sequence.
</verification>

<success_criteria>
OPS-04 and OPS-05 are operator-verifiable in live runs: the scripted phase workflow proves cache hit/miss telemetry behavior, exactly-once rate-limit emission, and non-blocking completion under telemetry persistence failure with explicit DB truth assertions and human-readable summary evidence.
</success_criteria>

<output>
After completion, create `.planning/phases/72-telemetry-follow-through/72-02-SUMMARY.md`
</output>
