---
phase: 81-slack-write-mode-enablement
plan: 03
type: execute
wave: 3
depends_on: [81-02]
files_modified:
  - src/slack/write-confirmation-store.ts
  - src/slack/write-confirmation-store.test.ts
  - src/slack/assistant-handler.ts
  - src/slack/assistant-handler.test.ts
autonomous: true

must_haves:
  truths:
    - "High-impact Slack write requests pause for in-thread confirmation, while lower-impact requests run without confirmation"
    - "If confirmation is not received, the write request remains pending and is not auto-canceled"
    - "Slack write user experience provides balanced progress updates (start, key milestones, final)"
    - "Final Slack success output is concise with changed-where bullets and defaults to the primary PR link"
    - "Slack write refusal/failure responses include the reason and an exact retry/fix command"
  artifacts:
    - path: "src/slack/write-confirmation-store.ts"
      provides: "Thread-scoped pending confirmation state with deterministic timeout metadata and no auto-cancel execution"
      contains: "pending|expiresAt"
    - path: "src/slack/assistant-handler.ts"
      provides: "Slack write progress/final response contract enforcement for success, refusal, and failure"
      contains: "start|milestone|final|retry"
    - path: "src/slack/assistant-handler.test.ts"
      provides: "Deterministic contract tests for confirmation flow and write response messaging"
      contains: "confirmation|required|retry command"
  key_links:
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/write-confirmation-store.ts"
      via: "High-impact writes open pending confirmation records and resume only after thread confirmation"
      pattern: "confirmation_required|pending"
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/assistant-handler.test.ts"
      via: "Response-contract assertions lock deterministic progress/success/refusal message shape"
      pattern: "progress|primary PR|retry/fix command"
---

<objective>
Add high-impact confirmation gates and complete Slack write response UX so write workflows stay safe and deterministic.

Purpose: Phase 81 needs deterministic confirmation behavior and user-facing write response contracts before operator verification gates are layered on.
Output: Confirmation-state module plus Slack response-contract wiring and tests.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-slack-write-mode-enablement/81-CONTEXT.md
@.planning/phases/81-slack-write-mode-enablement/81-02-SUMMARY.md
@.planning/phases/79-slack-read-only-assistant-routing/79-02-SUMMARY.md
@src/slack/assistant-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement high-impact Slack write confirmation gate with pending-state semantics</name>
  <files>src/slack/write-confirmation-store.ts, src/slack/write-confirmation-store.test.ts, src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Implement confirmation behavior for high-impact writes exactly as decided:

- Use thread-scoped confirmation for runs flagged high-impact.
- Only high-impact requests require confirmation; low/medium-impact write requests should proceed directly.
- If confirmation is not received before timeout metadata expires, keep the request in pending state (no automatic cancellation fallback).
- Apply the default timeout duration selected in Plan 81-01 and expose it in confirmation prompts.
- Ensure confirmation prompts include exact next action command text to approve execution in-thread.
- Add tests for: requires-confirmation paths, direct-run paths, pending-without-confirmation behavior, and deterministic resume after confirmation.
  </action>
  <verify>
Run `bun test ./src/slack/write-confirmation-store.test.ts --timeout 30000`.
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
High-impact Slack write requests are safely gated by explicit thread confirmation, and non-confirmed runs remain pending without implicit cancellation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce Slack write progress and final response contracts</name>
  <files>src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Implement locked Slack response style for write runs:

- Publish balanced progress checkpoints: start, key milestones, final outcome.
- Final success message must include concise outcome text plus short bullets summarizing what changed and where.
- Final output defaults to primary PR link only; extra links appear only when required (for mirrored GitHub comment links) or explicitly requested.
- Failure/refusal responses must include both reason and exact retry/fix command.
- Keep output deterministic and concise; avoid verbose narration.
- Add tests asserting message shape, bullet presence, link policy, and retry-command determinism.
  </action>
  <verify>
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
Slack write thread messages follow a deterministic UX contract for progress, success, and refusal/failure responses.
  </done>
</task>

</tasks>

<verification>
- Confirmation gating behaves exactly per high-impact-only policy with pending state semantics.
- Slack write response contract tests pass for progress, final success bullets, and refusal/failure retry instructions.
</verification>

<success_criteria>
Slack write mode is safe and user-clear: high-impact confirmations are enforced and write-run communication is deterministic for progress, success, and refusal outcomes.
</success_criteria>

<output>
After completion, create `.planning/phases/81-slack-write-mode-enablement/81-03-SUMMARY.md`
</output>
