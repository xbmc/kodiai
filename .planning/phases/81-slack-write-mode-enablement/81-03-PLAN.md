---
phase: 81-slack-write-mode-enablement
plan: 03
type: execute
wave: 3
depends_on: [81-02]
files_modified:
  - src/slack/write-confirmation-store.ts
  - src/slack/write-confirmation-store.test.ts
  - src/slack/assistant-handler.ts
  - src/slack/assistant-handler.test.ts
  - scripts/phase81-slack-write-smoke.ts
  - scripts/phase81-slack-write-smoke.test.ts
  - scripts/phase81-slack-write-regression-gate.ts
  - scripts/phase81-slack-write-regression-gate.test.ts
  - docs/runbooks/slack-integration.md
  - package.json
autonomous: true

must_haves:
  truths:
    - "High-impact Slack write requests pause for in-thread confirmation, while lower-impact requests run without confirmation"
    - "If confirmation is not received, the write request remains pending and is not auto-canceled"
    - "Slack write user experience provides balanced progress updates (start, key milestones, final)"
    - "Final Slack success output is concise with changed-where bullets and defaults to the primary PR link"
    - "Slack write refusal/failure responses include the reason and an exact retry/fix command"
  artifacts:
    - path: "src/slack/write-confirmation-store.ts"
      provides: "Thread-scoped pending confirmation state with deterministic timeout metadata and no auto-cancel execution"
      contains: "pending|expiresAt"
    - path: "scripts/phase81-slack-write-smoke.ts"
      provides: "Deterministic verifier for write-intent routing, confirmation gates, and final Slack output contract"
      contains: "SLK81-SMOKE"
    - path: "docs/runbooks/slack-integration.md"
      provides: "Updated operator flow for Slack write-mode rollout, verification, and incident triage"
      contains: "Phase 81"
  key_links:
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/write-confirmation-store.ts"
      via: "High-impact writes open pending confirmation records and resume only after thread confirmation"
      pattern: "confirmation_required|pending"
    - from: "scripts/phase81-slack-write-regression-gate.ts"
      to: "src/slack/assistant-handler.test.ts"
      via: "Gate runs pinned write-mode contract suites with machine-checkable IDs"
      pattern: "SLK81-REG"
    - from: "docs/runbooks/slack-integration.md"
      to: "scripts/phase81-slack-write-smoke.ts"
      via: "Runbook documents mandatory Phase 81 verification commands and check-ID interpretation"
      pattern: "verify:phase81"
---

<objective>
Add high-impact confirmation gates and complete Slack write UX/operator verification so write workflows stay safe, deterministic, and operable.

Purpose: Phase 81 is not complete until confirmation behavior, progress/final response contracts, and operator gates are encoded and verifiable.
Output: Confirmation-state module, Slack response-contract wiring, Phase 81 smoke/regression verifiers, and runbook/script updates.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-slack-write-mode-enablement/81-CONTEXT.md
@.planning/phases/81-slack-write-mode-enablement/81-02-SUMMARY.md
@.planning/phases/80-slack-operator-hardening/80-01-SUMMARY.md
@.planning/phases/80-slack-operator-hardening/80-02-SUMMARY.md
@docs/runbooks/slack-integration.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement high-impact Slack write confirmation gate with pending-state semantics</name>
  <files>src/slack/write-confirmation-store.ts, src/slack/write-confirmation-store.test.ts, src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Implement confirmation behavior for high-impact writes exactly as decided:

- Use thread-scoped confirmation for runs flagged high-impact.
- Only high-impact requests require confirmation; low/medium-impact write requests should proceed directly.
- If confirmation is not received before timeout metadata expires, keep the request in pending state (no automatic cancellation fallback).
- Apply the default timeout duration selected in Plan 81-01 and expose it in confirmation prompts.
- Ensure confirmation prompts include exact next action command text to approve execution in-thread.
- Add tests for: requires-confirmation paths, direct-run paths, pending-without-confirmation behavior, and deterministic resume after confirmation.
  </action>
  <verify>
Run `bun test ./src/slack/write-confirmation-store.test.ts --timeout 30000`.
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
High-impact Slack write requests are safely gated by explicit thread confirmation, and non-confirmed runs remain pending without implicit cancellation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce Slack write progress and final response contracts</name>
  <files>src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Implement locked Slack response style for write runs:

- Publish balanced progress checkpoints: start, key milestones, final outcome.
- Final success message must include concise outcome text plus short bullets summarizing what changed and where.
- Final output defaults to primary PR link only; extra links appear only when required (for mirrored GitHub comment links) or explicitly requested.
- Failure/refusal responses must include both reason and exact retry/fix command.
- Keep output deterministic and concise; avoid verbose narration.
- Add tests asserting message shape, bullet presence, link policy, and retry-command determinism.
  </action>
  <verify>
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
Slack write thread messages follow a deterministic UX contract for progress, success, and refusal/failure responses.
  </done>
</task>

<task type="auto">
  <name>Task 3: Ship Phase 81 smoke/regression gates and update Slack operator runbook</name>
  <files>scripts/phase81-slack-write-smoke.ts, scripts/phase81-slack-write-smoke.test.ts, scripts/phase81-slack-write-regression-gate.ts, scripts/phase81-slack-write-regression-gate.test.ts, package.json, docs/runbooks/slack-integration.md</files>
  <action>
Add deterministic operator verification for Slack write mode:

- Create `phase81-slack-write-smoke` checks (for example `SLK81-SMOKE-*`) covering explicit write intent routing, ambiguous-intent read-only fallback, high-impact confirmation gate behavior, and success/refusal message contract basics.
- Create `phase81-slack-write-regression-gate` checks (for example `SLK81-REG-*`) that run pinned local suites and fail non-zero on contract drift.
- Add package aliases (for example `verify:phase81:smoke`, `verify:phase81:regression`) for stable operator usage.
- Update `docs/runbooks/slack-integration.md` with Phase 81 rollout checks, failure interpretation, and troubleshooting pointers for write mode.
- Keep verifiers deterministic/offline and machine-checkable (no live Slack dependency).
  </action>
  <verify>
Run `bun test ./scripts/phase81-slack-write-smoke.test.ts --timeout 30000`.
Run `bun test ./scripts/phase81-slack-write-regression-gate.test.ts --timeout 30000`.
Run `bun run verify:phase81:smoke`.
Run `bun run verify:phase81:regression`.
  </verify>
  <done>
Operators can deterministically validate Slack write-mode behavior and block rollouts when Phase 81 contracts regress.
  </done>
</task>

</tasks>

<verification>
- Confirmation gating behaves exactly per high-impact-only policy with pending state semantics.
- Slack write response contract tests pass for progress, final success bullets, and refusal/failure retry instructions.
- Phase 81 smoke and regression gate commands emit machine-checkable pass/fail IDs and non-zero exits on failures.
- Runbook documents Phase 81 verification and incident triage flow.
</verification>

<success_criteria>
Slack write mode is operationally safe and user-clear: high-impact confirmations are enforced, write-run communication is deterministic, and operators have release-blocking verification gates.
</success_criteria>

<output>
After completion, create `.planning/phases/81-slack-write-mode-enablement/81-03-SUMMARY.md`
</output>
