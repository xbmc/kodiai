---
phase: 81-slack-write-mode-enablement
plan: 02
type: execute
wave: 2
depends_on: [81-01]
files_modified:
  - src/slack/write-runner.ts
  - src/slack/write-runner.test.ts
  - src/slack/assistant-handler.ts
  - src/slack/assistant-handler.test.ts
  - src/index.ts
  - src/execution/executor.ts
  - src/execution/types.ts
autonomous: true

must_haves:
  truths:
    - "Slack write-capable runs can edit files, run relevant build/test commands, and publish PR-only outputs without pushing default/protected branches directly"
    - "Slack write runs enforce existing write-policy and permission gates with actionable refusal guidance"
    - "Slack write runs can target any app-accessible owner/repo when explicitly specified"
    - "When a write run posts a GitHub issue/PR comment, Slack mirrors the result in-thread with the GitHub link and comment content/excerpt"
  artifacts:
    - path: "src/slack/write-runner.ts"
      provides: "Write-mode Slack execution orchestration with policy checks, branch/PR publish, and refusal handling"
      contains: "createBranchCommitAndPush|write-policy|permission"
    - path: "src/index.ts"
      provides: "Runtime wiring from Slack assistant route into write runner with installation-context repo resolution"
      contains: "resolveSlackInstallationContext"
    - path: "src/execution/types.ts"
      provides: "Execution result metadata for write publish outcomes consumable by Slack"
      contains: "resultText|published"
  key_links:
    - from: "src/slack/write-runner.ts"
      to: "src/jobs/workspace.ts"
      via: "Trusted code performs branch commit/push with write-policy enforcement before PR create"
      pattern: "createBranchCommitAndPush|enforceWritePolicy"
    - from: "src/slack/write-runner.ts"
      to: "src/auth/github-app.ts"
      via: "Owner/repo installation context determines installation auth and default branch for PR base"
      pattern: "getRepoInstallationContext"
    - from: "src/slack/write-runner.ts"
      to: "src/slack/assistant-handler.ts"
      via: "Write-run result payload feeds final Slack in-thread output including PR link and mirrored comment links"
      pattern: "prUrl|commentUrl"
---

<objective>
Implement the Slack write execution pipeline so clear write intents can safely produce repository changes, PR outputs, and mirrored comment links while preserving policy and permission guardrails.

Purpose: Phase 81's core outcome is enabling Slack-triggered write workflows (including PR creation and comment publication) without weakening existing deterministic write safety.
Output: Dedicated Slack write runner, runtime wiring, and tests proving policy/permission/refusal contracts plus PR/comment reporting.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-slack-write-mode-enablement/81-CONTEXT.md
@.planning/phases/81-slack-write-mode-enablement/81-01-SUMMARY.md
@.planning/phases/62-issue-write-mode-pr-creation/62-01-SUMMARY.md
@.planning/phases/62-issue-write-mode-pr-creation/62-02-SUMMARY.md
@.planning/phases/65-permission-disabled-ux-completion/65-02-SUMMARY.md
@src/jobs/workspace.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Slack write runner with PR-only publish and existing policy/permission gates</name>
  <files>src/slack/write-runner.ts, src/slack/write-runner.test.ts, src/index.ts</files>
  <action>
Add a dedicated Slack write execution runner that uses trusted-code publish semantics (not direct default-branch pushes):

- Execute Slack write requests with `writeMode=true` so file edits and relevant test/build commands are allowed when the request requires them.
- Reuse existing write-policy and permission guardrails before publish (`allowPaths`, deny paths, secret scan, permission-classified refusals).
- Publish write output via deterministic bot branch + PR creation only; never push directly to default/protected branches.
- Keep repo targeting generic: if Slack message specifies `owner/repo`, resolve installation context dynamically and run against that repo when accessible.
- Return structured write outcomes (success/refusal/failure) with exact retry command guidance for non-success cases.
- Add regression tests for success path, policy refusal path, permission refusal path, and unsupported repo access path.
  </action>
  <verify>
Run `bun test ./src/slack/write-runner.test.ts --timeout 30000`.
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
Slack write runs can safely produce PRs through policy/permission-checked trusted publish paths and return deterministic refusal guidance when blocked.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire write publish metadata into Slack final reply with GitHub links and excerpts</name>
  <files>src/execution/types.ts, src/execution/executor.ts, src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Ensure Slack can mirror GitHub publication results in-thread:

- Extend write-run result plumbing so assistant flow receives PR URL and any created issue/PR comment URLs with short content excerpts.
- When a GitHub comment is posted during the run, include its link plus comment body or excerpt in the Slack thread reply (locked decision).
- Keep final default Slack success output focused on the primary PR link only; include additional links (for example extra comments) only when required by the mirror contract or explicitly requested.
- Preserve deterministic refusal/failure outputs with reason + exact next-action retry/fix command.
- Add tests proving: PR link presence on success, comment link+excerpt mirroring when comments are created, and failure/refusal retry-command formatting.
  </action>
  <verify>
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
Run `bun test ./src/execution/mcp/comment-server.test.ts --timeout 30000` if metadata plumbing touches comment publish internals.
  </verify>
  <done>
Slack write final messages deterministically report primary PR output and mirror GitHub comment publications with links plus content excerpts when those comments are created.
  </done>
</task>

</tasks>

<verification>
- Slack write success path yields deterministic PR URL reporting in-thread.
- Policy and permission denials produce actionable refusal replies with exact retry commands.
- GitHub comment publication from Slack runs is mirrored back to Slack with link + excerpt.
</verification>

<success_criteria>
Clear Slack write intents can execute end-to-end through guarded trusted publish flow, and thread replies provide deterministic PR/comment output visibility without bypassing policy or permission safety.
</success_criteria>

<output>
After completion, create `.planning/phases/81-slack-write-mode-enablement/81-02-SUMMARY.md`
</output>
