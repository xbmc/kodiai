---
phase: 12-fork-pr-robustness
plan: 03
type: execute
wave: 3
depends_on:
  - 12-fork-pr-robustness/12-02-PLAN.md
files_modified:
  - src/execution/mention-context.ts
  - src/execution/review-prompt.ts
  - src/handlers/review.ts
  - docs/runbooks/scale.md
autonomous: true

must_haves:
  truths:
    - "Large PRs and long threads do not cause unbounded prompt growth"
    - "When caps are hit, output degrades gracefully with an explicit note"
    - "Pagination is used where GitHub APIs are paginated"
  artifacts:
    - path: "docs/runbooks/scale.md"
      provides: "Operational guidance for scale-related failures"
      contains: "pagination"
  key_links:
    - from: "src/execution/mention-context.ts"
      to: "GitHub list APIs"
      via: "pagination + truncation"
      pattern: "per_page|page"
---

<objective>
Add scale guardrails so xbmc-sized PRs and long comment threads remain reliable: paginate list APIs, cap context size, and degrade gracefully.

Purpose: Prevent timeouts and noisy failures in production.
Output: Bounded context, pagination, and a scale runbook.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/execution/mention-context.ts
@src/execution/review-prompt.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pagination + caps to context collectors</name>
  <files>src/execution/mention-context.ts, src/execution/review-prompt.ts</files>
  <action>
  Implement guardrails:
  - Use paginated list calls for issue comments / review comments where applicable.
  - Cap comment count and total characters included.
  - Truncate large single comments.
  - Add a short note into the prompt when truncation occurs (so the model knows context is partial).
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  Context builders are bounded and deterministic under large inputs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add runbook for scale-related incidents</name>
  <files>docs/runbooks/scale.md</files>
  <action>
  Document:
  - Symptoms of scale issues (timeouts, partial context)
  - Where caps are configured
  - How to reproduce with a large PR
  - How to tune safely (maxTurns, timeoutSeconds, context caps)
  </action>
  <verify>
  - File exists and includes concrete checks/commands
  </verify>
  <done>
  Operators can diagnose and adjust scale behavior without code spelunking.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<success_criteria>
- Pagination/caps prevent unbounded context growth
- Degradation is explicit and operator-diagnosable
</success_criteria>

<output>
After execution, create `.planning/phases/12-fork-pr-robustness/12-03-SUMMARY.md`
</output>
