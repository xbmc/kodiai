---
phase: 12-fork-pr-robustness
plan: 02
type: execute
wave: 2
depends_on:
  - 12-fork-pr-robustness/12-01-PLAN.md
files_modified:
  - src/handlers/mention.ts
  - src/execution/mention-context.ts
  - src/jobs/workspace.ts
autonomous: true

must_haves:
  truths:
    - "Contextual mention replies work on fork PRs"
    - "Mention workspace checkout uses the same PR-ref strategy as reviews when needed"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Mention handler chooses PR-ref workspace strategy"
    - path: "src/execution/mention-context.ts"
      provides: "Mention context includes PR diff/file context when available"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/jobs/workspace.ts"
      via: "base clone + pull/<n>/head fetch for PR mention contexts"
      pattern: "pull/"
---

<objective>
Ensure mention flows that need workspace/diff context work reliably for fork PRs by using base-clone + refs/pull fetch strategy.

Purpose: Avoid fork access assumptions and keep contextual mention answers available in xbmc/xbmc.
Output: Mention flow workspace robustness.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/handlers/mention.ts
@src/execution/mention-context.ts
@src/jobs/workspace.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Use base-clone + PR-ref fetch strategy for PR mention contexts</name>
  <files>src/handlers/mention.ts, src/jobs/workspace.ts</files>
  <action>
  For mention surfaces that require repository checkout (e.g. inline review comment context, file/diff reads):
  - Clone the base repo at `baseRef`
  - Fetch `pull/<PR_NUMBER>/head` into a local branch
  - Checkout PR head

  Ensure this strategy is used for fork PRs (and optionally for all PRs for simplicity).
  </action>
  <verify>
  - `bun test`
  </verify>
  <done>
  Mention contextual flows do not rely on cloning the fork repo.
  </done>
</task>

<task type="auto">
  <name>Task 2: Confirm mention context builder still obeys TOCTOU and sanitization</name>
  <files>src/execution/mention-context.ts</files>
  <action>
  Audit the mention context builder after checkout changes:
  - It must still filter comments to the trigger timestamp
  - It must still sanitize user content
  - It must bound/truncate context
  Update tests if needed.
  </action>
  <verify>
  - `bun test src/execution/mention-context.test.ts`
  </verify>
  <done>
  Safety invariants remain intact.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<success_criteria>
- Fork PR mention contexts work via PR-ref strategy
- Context safety invariants remain test-covered
</success_criteria>

<output>
After execution, create `.planning/phases/12-fork-pr-robustness/12-02-SUMMARY.md`
</output>
