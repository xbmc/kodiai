---
phase: 12-fork-pr-robustness
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/jobs/workspace.ts
autonomous: true

must_haves:
  truths:
    - "Fork PR reviews do not rely on cloning the contributor's fork"
    - "Review workspace is built by cloning base repo and fetching pull/<n>/head"
    - "Inline review comments still anchor correctly"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Review handler uses PR-ref fetch strategy for fork PRs"
      contains: "pull/"
    - path: "src/jobs/workspace.ts"
      provides: "Workspace supports base clone and subsequent fetch/checkout"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/jobs/workspace.ts"
      via: "Workspace created on base repo, then fetch PR ref"
      pattern: "fetch origin pull/"
---

<objective>
Make fork PR reviews robust by cloning the base repo and fetching PR head refs, rather than cloning the fork directly.

Purpose: Ensure xbmc/xbmc external contributor PRs are reliably reviewable under GitHub App token constraints.
Output: Updated review workspace strategy + tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/handlers/review.ts
@src/jobs/workspace.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch fork PR checkout to base-clone + refs/pull fetch</name>
  <files>src/handlers/review.ts, src/jobs/workspace.ts</files>
  <action>
  Adjust review handler workspace creation logic:
  - Always treat the API target as base repo (already true).
  - For fork PRs, do NOT clone `pr.head.repo`.
  - Instead:
    1) Clone the base repo at `pr.base.ref`
    2) `git fetch origin pull/<PR_NUMBER>/head:pr-review`
    3) checkout `pr-review`
    4) ensure `origin/<baseRef>` exists for diff calculations

  Keep existing deleted-fork fallback consistent with this strategy.

  Emit logs showing which strategy was used for a PR.
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts`
  </verify>
  <done>
  Fork PR review path works without accessing fork repos.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression coverage for fork PR strategy selection</name>
  <files>src/handlers/review.test.ts</files>
  <action>
  Add tests that:
  - simulate a fork PR payload
  - assert workspace creation uses base repo and that fetch of `pull/<n>/head` is invoked
  - ensure non-fork PRs still work
  </action>
  <verify>
  - `bun test src/handlers/review.test.ts`
  </verify>
  <done>
  Fork PR behavior is test-covered to prevent regressions.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts`
</verification>

<success_criteria>
- Review handler does not depend on cloning contributor forks
- Tests cover fork and non-fork paths
</success_criteria>

<output>
After execution, create `.planning/phases/12-fork-pr-robustness/12-01-SUMMARY.md`
</output>
