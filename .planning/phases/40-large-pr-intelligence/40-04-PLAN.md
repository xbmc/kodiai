---
phase: 40-large-pr-intelligence
plan: 04
type: execute
wave: 3
depends_on: ["40-01", "40-03"]
files_modified:
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Large PRs trigger risk-based file triage before prompt building"
    - "Triage uses configurable thresholds from config.largePR"
    - "Only full+abbreviated tier files enter the LLM prompt"
    - "Post-LLM enforcement suppresses MEDIUM/MINOR findings on abbreviated-tier files"
    - "Triage data flows to formatReviewDetailsSummary for coverage disclosure"
    - "Below-threshold PRs follow existing behavior with no changes"
    - "Triage decision uses full PR file count, not incremental subset"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Complete pipeline integration of file risk triage"
      contains: "computeFileRiskScores"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/file-risk-scorer.ts"
      via: "imports computeFileRiskScores, triageFilesByRisk"
      pattern: "import.*computeFileRiskScores.*from.*file-risk-scorer"
    - from: "src/handlers/review.ts"
      to: "src/execution/diff-analysis.ts"
      via: "imports parseNumstatPerFile"
      pattern: "import.*parseNumstatPerFile.*from.*diff-analysis"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "passes largePRContext to buildReviewPrompt"
      pattern: "largePRContext"
---

<objective>
Pipeline integration: wire risk scoring and triage into the review handler.

Purpose: This is the final integration plan that connects all Phase 40 components into the live review pipeline. Risk scoring runs AFTER diff analysis and BEFORE prompt building, so the LLM only sees files selected for review. Post-LLM enforcement suppresses below-MAJOR findings on abbreviated-tier files as a safety net.

Output: Updated `src/handlers/review.ts` with full file triage pipeline integration.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-large-pr-intelligence/40-RESEARCH.md
@.planning/phases/40-large-pr-intelligence/40-01-SUMMARY.md
@.planning/phases/40-large-pr-intelligence/40-03-SUMMARY.md
@src/handlers/review.ts
@src/lib/file-risk-scorer.ts
@src/execution/diff-analysis.ts
@src/execution/review-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire file risk triage into review handler pipeline</name>
  <files>src/handlers/review.ts</files>
  <action>
1. Add imports at top of review.ts:
   - `import { parseNumstatPerFile } from "../execution/diff-analysis.ts";`
   - `import { computeFileRiskScores, triageFilesByRisk, type TieredFiles, type FileRiskScore } from "../lib/file-risk-scorer.ts";`

2. After `diffAnalysis = analyzeDiff(...)` (around line 1083) and BEFORE the `buildReviewPrompt()` call (around line 1193), add the file risk triage pipeline:

   ```typescript
   // --- Large PR file triage (LARGE-01 through LARGE-08) ---
   // Parse per-file numstat for risk scoring
   const perFileStats = parseNumstatPerFile(numstatLines);

   // Compute risk scores for files being reviewed
   const riskScores = computeFileRiskScores({
     files: reviewFiles,
     perFileStats,
     filesByCategory: diffAnalysis.filesByCategory,
     weights: config.largePR.riskWeights,
   });

   // Triage uses changedFiles.length (full PR size) for threshold check,
   // not reviewFiles.length (which may be filtered for incremental mode).
   // Per pitfall 3 in research: check full PR, triage review set.
   const tieredFiles = triageFilesByRisk({
     riskScores,
     fileThreshold: config.largePR.fileThreshold,
     fullReviewCount: config.largePR.fullReviewCount,
     abbreviatedCount: config.largePR.abbreviatedCount,
   });

   // Build the file list for the prompt: only full + abbreviated tier files
   const promptFiles = tieredFiles.isLargePR
     ? [...tieredFiles.full.map(f => f.filePath), ...tieredFiles.abbreviated.map(f => f.filePath)]
     : reviewFiles;
   ```

3. Modify the `buildReviewPrompt()` call:
   - Change `changedFiles: reviewFiles` to `changedFiles: promptFiles`
   - Add `largePRContext` parameter:
     ```typescript
     largePRContext: tieredFiles.isLargePR ? {
       fullReviewFiles: tieredFiles.full.map(f => f.filePath),
       abbreviatedFiles: tieredFiles.abbreviated.map(f => f.filePath),
       mentionOnlyCount: tieredFiles.mentionOnly.length,
       totalFiles: tieredFiles.totalFiles,
     } : null,
     ```

4. After the enforcement pipeline and during finding processing (around line 1316), add post-LLM abbreviated tier enforcement:
   - Build an abbreviated file set: `const abbreviatedFileSet = tieredFiles.isLargePR ? new Set(tieredFiles.abbreviated.map(f => f.filePath)) : new Set<string>();`
   - In the processedFindings mapping, after computing suppressed/confidence, add: if the finding's filePath is in abbreviatedFileSet AND the finding severity is "medium" or "minor", set `suppressed = true`. This enforces abbreviated tier depth deterministically (per open question 2 in research).

5. Modify the `formatReviewDetailsSummary()` call to pass triage data:
   ```typescript
   largePRTriage: tieredFiles.isLargePR ? {
     fullCount: tieredFiles.full.length,
     abbreviatedCount: tieredFiles.abbreviated.length,
     mentionOnlyFiles: tieredFiles.mentionOnly.map(f => ({ filePath: f.filePath, score: f.score })),
     totalFiles: tieredFiles.totalFiles,
   } : undefined,
   ```

6. Add structured logging after triage:
   ```typescript
   if (tieredFiles.isLargePR) {
     logger.info({
       ...baseLog,
       gate: "large-pr-triage",
       totalFiles: tieredFiles.totalFiles,
       fullReview: tieredFiles.full.length,
       abbreviated: tieredFiles.abbreviated.length,
       mentionOnly: tieredFiles.mentionOnly.length,
       threshold: config.largePR.fileThreshold,
     }, "Large PR file triage applied");
   }
   ```

7. Ensure below-threshold PRs have ZERO behavior change -- all existing code paths remain intact when `tieredFiles.isLargePR === false`.
  </action>
  <verify>
Run `bunx tsc --noEmit`. Run `bun test` to confirm all tests pass. Verify the review handler compiles and the pipeline order is correct: diff analysis -> risk triage -> prompt building -> LLM execution -> enforcement -> finding processing -> Review Details.
  </verify>
  <done>
File risk triage is wired into the review handler. Large PRs get risk-scored files with tiered review depth. Post-LLM enforcement suppresses below-MAJOR findings on abbreviated files. Review Details discloses coverage. Below-threshold PRs are unchanged. Triage uses full PR file count for threshold (not incremental subset).
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes
- `bun test` passes (all existing tests)
- Review handler integration order: analyzeDiff -> parseNumstatPerFile -> computeFileRiskScores -> triageFilesByRisk -> buildReviewPrompt (with largePRContext) -> executor -> applyEnforcement -> abbreviated tier enforcement -> processFindings -> formatReviewDetailsSummary (with largePRTriage)
- Below-threshold PRs: reviewFiles passed unchanged to buildReviewPrompt, no largePRContext, no triage disclosure
- Above-threshold PRs: only full+abbreviated files in prompt, abbreviated findings filtered post-LLM, Review Details shows coverage
</verification>

<success_criteria>
Complete pipeline integration. For PRs with 100+ files: risk scores computed, top 30 get full review, next 20 get abbreviated, rest disclosed in Review Details with scores. For PRs with <50 files: identical behavior to pre-Phase 40. Post-LLM enforcement suppresses medium/minor on abbreviated files. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/40-large-pr-intelligence/40-04-SUMMARY.md`
</output>
