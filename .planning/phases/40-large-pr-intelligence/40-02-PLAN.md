---
phase: 40-large-pr-intelligence
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/file-risk-scorer.test.ts
  - src/execution/diff-analysis.test.ts
autonomous: true

must_haves:
  truths:
    - "Risk scoring tests cover normalization, edge cases, and tier assignment"
    - "Per-file numstat parser tests cover normal lines, binary files, and empty input"
    - "Triage tests verify threshold boundary behavior"
  artifacts:
    - path: "src/lib/file-risk-scorer.test.ts"
      provides: "Test coverage for risk scoring and triage"
      min_lines: 80
    - path: "src/execution/diff-analysis.test.ts"
      provides: "Test coverage for parseNumstatPerFile"
      contains: "parseNumstatPerFile"
  key_links:
    - from: "src/lib/file-risk-scorer.test.ts"
      to: "src/lib/file-risk-scorer.ts"
      via: "imports scoring functions"
      pattern: "import.*computeFileRiskScores.*from"
---

<objective>
Tests for risk scoring engine and per-file numstat parser.

Purpose: Validates the scoring algorithm produces correct relative ordering (auth files > test files), log normalization works, triage respects threshold boundaries, and numstat parsing handles all line formats. TDD plan -- tests written first, then implementation verified.

Output: `src/lib/file-risk-scorer.test.ts` and additions to `src/execution/diff-analysis.test.ts`
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-large-pr-intelligence/40-RESEARCH.md
@src/lib/file-risk-scorer.ts
@src/execution/diff-analysis.ts
@src/execution/diff-analysis.test.ts
</context>

<feature>
  <name>Risk Scoring and Numstat Parsing Tests</name>
  <files>src/lib/file-risk-scorer.test.ts, src/execution/diff-analysis.test.ts</files>
  <behavior>
  Risk scorer tests:
  - computeFileRiskScores with auth file (src/auth/login.ts, 100 lines changed) scores higher than test file (src/utils.test.ts, 100 lines changed)
  - computeFileRiskScores with 0 lines changed file still gets non-zero score from path/category/language
  - computeFileRiskScores with single file returns score between 0-100
  - computeFileRiskScores results are sorted descending by score
  - Weights are normalized at runtime (weights summing to 2.0 still produce valid 0-100 scores)
  - triageFilesByRisk below threshold: all files in full tier, isLargePR=false
  - triageFilesByRisk above threshold: correct split into full(30)/abbreviated(20)/mentionOnly(rest)
  - triageFilesByRisk with exactly threshold+1 files: isLargePR=true
  - triageFilesByRisk with empty input: returns empty tiers

  Numstat tests:
  - parseNumstatPerFile with standard lines: "10\t5\tsrc/foo.ts" -> Map with {added:10, removed:5}
  - parseNumstatPerFile with binary files: "-\t-\tsrc/image.png" -> Map with {added:0, removed:0}
  - parseNumstatPerFile with empty input: returns empty Map
  - parseNumstatPerFile with malformed lines: skips them gracefully
  </behavior>
  <implementation>
  Write tests in RED phase using imports from the scorer module and diff-analysis module.
  Run tests to confirm they fail (RED).
  Verify implementation from plan 40-01 makes them pass (GREEN).
  No refactoring needed -- implementation is fresh.
  </implementation>
</feature>

<verification>
- `bun test src/lib/file-risk-scorer.test.ts` -- all tests pass
- `bun test src/execution/diff-analysis.test.ts` -- all tests pass (including existing ones)
- Auth path files score higher than test files for same line count
- Triage threshold boundary is correct (50 files -> not large, 51 -> large)
</verification>

<success_criteria>
All scoring and numstat tests pass. Tests verify relative ordering (high-risk > low-risk), boundary conditions (threshold edge), and graceful handling (empty input, malformed data, non-1.0 weight sums).
</success_criteria>

<output>
After completion, create `.planning/phases/40-large-pr-intelligence/40-02-SUMMARY.md`
</output>
