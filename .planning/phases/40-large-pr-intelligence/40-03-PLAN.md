---
phase: 40-large-pr-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/execution/review-prompt.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Review prompt includes tiered file sections when large PR context is provided"
    - "Abbreviated tier files are explicitly instructed for CRITICAL/MAJOR only in the prompt"
    - "Review Details discloses coverage (Reviewed X/Y files, prioritized by risk)"
    - "Skipped files are listed with risk scores in a collapsible details block"
    - "Mention-only file list is capped at 100 entries to avoid GitHub comment size limits"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Large PR triage prompt section builder and integration in buildReviewPrompt"
      exports: ["buildLargePRTriageSection"]
    - path: "src/handlers/review.ts"
      provides: "Extended formatReviewDetailsSummary with triage disclosure"
      contains: "largePRTriage"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "src/lib/file-risk-scorer.ts"
      via: "types for large PR context"
      pattern: "largePRContext"
    - from: "src/handlers/review.ts"
      to: "src/lib/file-risk-scorer.ts"
      via: "TieredFiles type for disclosure data"
      pattern: "mentionOnly.*score"
---

<objective>
Tiered prompt sections and Review Details disclosure for large PRs.

Purpose: When a large PR is detected, the review prompt must instruct the LLM differently for full-review vs abbreviated-review files. The Review Details summary must transparently disclose how many files were reviewed and list skipped files with their risk scores.

Output: Updated `src/execution/review-prompt.ts` with tiered prompt builder, updated `src/handlers/review.ts` formatReviewDetailsSummary with triage disclosure.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-large-pr-intelligence/40-RESEARCH.md
@.planning/phases/40-large-pr-intelligence/40-01-SUMMARY.md
@src/execution/review-prompt.ts
@src/handlers/review.ts
@src/lib/file-risk-scorer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tiered prompt section builder and buildReviewPrompt integration</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
1. Add a new exported function `buildLargePRTriageSection()` in review-prompt.ts:
   - Parameters: `{ fullReviewFiles: string[]; abbreviatedFiles: string[]; mentionOnlyCount: number; totalFiles: number; }`
   - Generates a "## Large PR Triage" prompt section:
     - States total file count and risk-based prioritization
     - Lists full review files with instruction: "Review these files thoroughly for all issue categories"
     - Lists abbreviated review files with instruction: "For these files, ONLY flag CRITICAL and MAJOR issues. Skip MEDIUM and MINOR findings."
     - States mentionOnlyCount additional files were not reviewed (lower risk score)
   - Do NOT include mention-only file names in the prompt (they go in Review Details, not in the LLM prompt) to avoid token waste per pitfall 4 in research

2. Add a new `largePRContext` optional parameter to `buildReviewPrompt()`:
   ```typescript
   largePRContext?: {
     fullReviewFiles: string[];
     abbreviatedFiles: string[];
     mentionOnlyCount: number;
     totalFiles: number;
   } | null;
   ```

3. Inside `buildReviewPrompt()`, when `largePRContext` is provided and truthy:
   - Replace the existing large PR handling (the `if (analysis.isLargePR)` block around line 505 that adds "This is a large PR. Focus on the most critical changes.") with the tiered section from `buildLargePRTriageSection()`
   - Insert the tiered section AFTER the diff analysis section and BEFORE the changed files list
   - When largePRContext is present, the `changedFiles` parameter already contains only files in full+abbreviated tiers (caller handles this), so the existing file list capping behavior is fine

4. When `largePRContext` is null/undefined, preserve all existing behavior unchanged.
  </action>
  <verify>
Run `bunx tsc --noEmit`. Run `bun test src/execution/review-prompt.test.ts` to ensure existing tests pass. Manually verify: `bun -e "import { buildLargePRTriageSection } from './src/execution/review-prompt.ts'; console.log(buildLargePRTriageSection({ fullReviewFiles: ['a.ts','b.ts'], abbreviatedFiles: ['c.ts'], mentionOnlyCount: 50, totalFiles: 53 }))"` outputs the tiered section.
  </verify>
  <done>
`buildLargePRTriageSection()` generates tiered prompt instructions. `buildReviewPrompt()` accepts optional `largePRContext` and includes tiered sections in the prompt when provided. Existing behavior unchanged when largePRContext is null.
  </done>
</task>

<task type="auto">
  <name>Task 2: Review Details coverage disclosure with skipped file listing</name>
  <files>src/handlers/review.ts</files>
  <action>
1. Import `FileRiskScore` type from `../lib/file-risk-scorer.ts` in review.ts.

2. Extend `formatReviewDetailsSummary()` parameters with an optional `largePRTriage` field:
   ```typescript
   largePRTriage?: {
     fullCount: number;
     abbreviatedCount: number;
     mentionOnlyFiles: Array<{ filePath: string; score: number }>;
     totalFiles: number;
   };
   ```

3. Inside `formatReviewDetailsSummary()`, after the existing 4 data lines and before the closing `</details>`, add a triage disclosure section when `largePRTriage` is provided:
   - Add a blank line separator
   - Add `- Review scope: Reviewed X/Y files, prioritized by risk` where X = fullCount + abbreviatedCount, Y = totalFiles
   - Add `- Full review: N files | Abbreviated review: M files | Not reviewed: K files`
   - If mentionOnlyFiles.length > 0, add a nested collapsible `<details>` block:
     - Summary: "Files not fully reviewed (sorted by risk score)"
     - List each file with its score: `- path/to/file.ts (risk: 42)`
     - Cap at 100 entries. If more, add: "...and N more files"
   - This is consistent with pitfall 7 in research (comment size limits)

4. Do NOT change the existing 4-line format when largePRTriage is not provided.
  </action>
  <verify>
Run `bunx tsc --noEmit`. Run `bun test src/handlers/review.test.ts` to ensure existing tests pass. The Review Details output for large PRs includes "Review scope: Reviewed X/Y files" and the skipped file listing.
  </verify>
  <done>
`formatReviewDetailsSummary()` includes triage disclosure when largePRTriage is provided. Skipped files listed with risk scores in collapsible block, capped at 100 entries. Existing Review Details format unchanged when no triage data.
  </done>
</task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes
- `bun test src/execution/review-prompt.test.ts` passes
- `bun test src/handlers/review.test.ts` passes
- buildLargePRTriageSection produces correct tier instructions
- Review Details includes "Reviewed X/Y files, prioritized by risk" when triage data present
- Mention-only files listed in Review Details but NOT in LLM prompt
</verification>

<success_criteria>
Prompt builder generates tiered review instructions for large PRs. Review Details transparently discloses coverage with skipped file risk scores. All existing tests pass. No token waste from including mention-only files in the prompt.
</success_criteria>

<output>
After completion, create `.planning/phases/40-large-pr-intelligence/40-03-SUMMARY.md`
</output>
