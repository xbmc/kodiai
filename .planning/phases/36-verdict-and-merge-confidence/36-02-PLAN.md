---
phase: 36-verdict-and-merge-confidence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true

must_haves:
  truths:
    - "Sanitizer rejects :red_circle: verdict when zero CRITICAL/MAJOR findings exist under ### Impact"
    - "Sanitizer logs warning when :green_circle: verdict used despite CRITICAL/MAJOR findings existing"
    - "All existing test data uses new verdict labels (Ready to merge, Ready to merge with minor items, Address before merging)"
    - "A PR with zero blockers never passes sanitizer with :red_circle: verdict"
  artifacts:
    - path: "src/execution/mcp/comment-server.ts"
      provides: "Verdict-observations cross-check with blocker counting"
      contains: "blockerCount"
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Tests for verdict-observations consistency and updated test data"
  key_links:
    - from: "src/execution/mcp/comment-server.ts"
      to: "sanitizeKodiaiReviewSummary observations parsing"
      via: "blockerCount accumulator during ISSUE state transitions"
      pattern: "blockerCount"
    - from: "src/execution/mcp/comment-server.ts"
      to: "sanitizeKodiaiReviewSummary verdict validation"
      via: "cross-check after verdict format validation"
      pattern: "red_circle.*blockerCount|blockerCount.*red_circle"
---

<objective>
Add a verdict-observations consistency cross-check to `sanitizeKodiaiReviewSummary()` and update all existing test data to use the new verdict labels from Phase 36.

Purpose: Enforce the core Phase 36 invariant -- a PR with zero CRITICAL/MAJOR findings under ### Impact must never show a :red_circle: verdict. This is the sanitizer-level gate that catches cases where the prompt instructions fail to guide Claude correctly.
Output: Updated sanitizer with cross-check and comprehensive tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-verdict-and-merge-confidence/36-RESEARCH.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/comment-server.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verdict-observations cross-check and update test data for new verdict labels</name>
  <files>src/execution/mcp/comment-server.ts, src/execution/mcp/comment-server.test.ts</files>
  <action>
**In `sanitizeKodiaiReviewSummary()` in comment-server.ts:**

1. **Add a `blockerCount` accumulator** initialized to 0 at the start of the Observations parsing section (near line 196, alongside the existing state machine variables).

2. **Increment `blockerCount`** in the ISSUE state transitions (both the INTRO->ISSUE transition around line 241 and the EXPLANATION->ISSUE transition around line 294). The increment condition: when `severityMatch` is present AND `severityMatch[1]` is `"CRITICAL"` or `"MAJOR"` AND `currentSubsection === "### Impact"`. Use the existing `severityMatch` variable that is already extracted on the stripped_line.

3. **After the existing verdict format validation** (after line 175 where verdictLineRe is tested), add the cross-check:
   - Extract the verdict emoji from the verdict section: `const verdictEmojiMatch = verdictSection.match(/^:(green_circle|yellow_circle|red_circle):/m);`
   - `const verdictEmoji = verdictEmojiMatch?.[1];`
   - Hard check: `if (blockerCount === 0 && verdictEmoji === "red_circle")` throw Error: `"Invalid Kodiai review summary: Verdict uses :red_circle: but no CRITICAL or MAJOR findings exist under ### Impact"`
   - Soft check: `if (blockerCount > 0 && verdictEmoji === "green_circle")` log `console.warn(...)`: "Verdict uses :green_circle: but N blocker(s) (CRITICAL/MAJOR) exist under ### Impact"

   IMPORTANT: The cross-check must run AFTER the Observations parsing loop (which computes `blockerCount`), not after the verdict format check at line 175. The code structure is: verdict format check (line 166-175), then Observations parsing (line 177-337). Move the cross-check to AFTER the Observations parsing completes (after line 337, before the `return stripped;` at line 338). Extract the verdict emoji at the same location.

**In comment-server.test.ts:**

4. **Update ALL existing test data** that references old verdict labels. Search for every occurrence of:
   - `"Looks good"` -- not present in test data based on grep
   - `"Needs changes"` -- replace with appropriate new label based on context:
     - Tests with CRITICAL findings: use `:red_circle: **Address before merging** -- N blocking issue(s) found`
     - Tests with only MAJOR findings: use `:red_circle: **Address before merging** -- N blocking issue(s) found`
     - Tests with only MEDIUM/MINOR findings: use `:yellow_circle: **Ready to merge with minor items** -- Optional cleanup suggestions below`
   - `"Block"` -- replace with `"Address before merging"` and use `:red_circle:`
   - `"Approve"` -- replace with `"Ready to merge"` and use `:green_circle:`

   Apply the correct verdict label based on the findings content in each test case:
   - If the test body has [CRITICAL] or [MAJOR] under ### Impact -> `:red_circle: **Address before merging** -- N blocking issue(s) found`
   - If the test body has only [MEDIUM] or [MINOR] under ### Impact -> `:yellow_circle: **Ready to merge with minor items** -- Optional cleanup suggestions below`
   - If the test body has no findings at all -> `:green_circle: **Ready to merge** -- No blocking issues found`

5. **Add new cross-check tests** in a `describe("Phase 36: Verdict-Observations cross-check", ...)` block:

   a. **"rejects red verdict when only MEDIUM findings exist"** -- build summary with [MEDIUM] finding under ### Impact and `:red_circle:` verdict. Expect rejection with "no CRITICAL or MAJOR findings exist".

   b. **"rejects red verdict when only MINOR findings exist"** -- build summary with [MINOR] finding under ### Impact and `:red_circle:` verdict. Expect rejection.

   c. **"accepts red verdict when CRITICAL finding exists"** -- build summary with [CRITICAL] finding and `:red_circle:` verdict. Expect acceptance.

   d. **"accepts red verdict when MAJOR finding exists"** -- build summary with [MAJOR] finding and `:red_circle:` verdict. Expect acceptance.

   e. **"accepts yellow verdict with only MEDIUM findings"** -- build summary with [MEDIUM] finding and `:yellow_circle:` verdict. Expect acceptance.

   f. **"warns when green verdict used despite CRITICAL findings"** -- build summary with [CRITICAL] finding and `:green_circle:` verdict. Spy on console.warn. Expect the call to go through (no throw) but console.warn to be called with blocker message.

   g. **"accepts green verdict when only Preference findings exist"** -- build summary with [MINOR] finding under ### Preference and `:green_circle:` verdict, with [MEDIUM] finding under ### Impact. Expect acceptance (green circle requires looking at actual blocker count -- zero CRITICAL/MAJOR = allowed).

   Use the same `buildTestSummary` helper and `callCreate` pattern from the existing tests.
  </action>
  <verify>Run `bun test src/execution/mcp/comment-server.test.ts` -- all existing tests pass with updated labels, all 7 new cross-check tests pass.</verify>
  <done>Sanitizer enforces verdict-observations consistency; red verdict rejected without CRITICAL/MAJOR blockers; green verdict with blockers triggers soft warning; all test data uses new verdict labels.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/mcp/comment-server.test.ts` passes with all existing + 7 new tests
- `bun test` full suite passes (no regressions)
- Grep for "Needs changes" and "Block" and "Approve" in comment-server.test.ts verdict lines returns zero matches (all updated to new labels)
- Summary with [MEDIUM]-only findings and :red_circle: verdict is rejected by sanitizer
- Summary with zero blockers and :green_circle: verdict is accepted by sanitizer
</verification>

<success_criteria>
- Verdict-observations cross-check prevents red verdict without CRITICAL/MAJOR blockers (FORMAT-04, success criteria #4)
- Soft warning for green verdict with blockers present (edge case coverage)
- All existing test data updated to new verdict labels
- All tests pass including 7 new cross-check tests
</success_criteria>

<output>
After completion, create `.planning/phases/36-verdict-and-merge-confidence/36-02-SUMMARY.md`
</output>
