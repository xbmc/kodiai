---
phase: 36-verdict-and-merge-confidence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Verdict template shows three merge-recommendation states: Ready to merge, Ready to merge with minor items, Address before merging"
    - "Verdict Logic section defines blocker as CRITICAL or MAJOR under Impact and provides deterministic counting rules"
    - "Suggestions template requires Optional: or Future consideration: prefix on every item"
    - "Hard requirements enforce blocker-driven verdict and non-blocking suggestions"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Updated verdict template, verdict logic section, suggestions template, hard requirements"
      contains: "Ready to merge"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Tests for verdict template, verdict logic, suggestions format, hard requirements"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "buildReviewPrompt output"
      via: "verdict template lines in summary comment section"
      pattern: "Ready to merge|Address before merging"
---

<objective>
Rewrite the Verdict section template, add a Verdict Logic prompt section, update the Suggestions section template, and update hard requirements in `buildReviewPrompt()` to deliver explicit merge recommendations driven by blocker counts.

Purpose: Replace subjective verdict labels ("Looks good", "Needs changes", "Blocker") with merge-actionable labels ("Ready to merge", "Ready to merge with minor items", "Address before merging") and give Claude deterministic rules for selecting the verdict based on CRITICAL/MAJOR finding counts under ### Impact.
Output: Updated prompt template and comprehensive tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-verdict-and-merge-confidence/36-RESEARCH.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Verdict template, add Verdict Logic section, update Suggestions template and hard requirements</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
In `buildReviewPrompt()`, in the standard-mode summary comment section:

1. **Replace the Verdict template lines** (around lines 994-997):
   OLD:
   ```
   "## Verdict",
   ":green_circle: **Looks good** -- <explanation> (only minor suggestions, nothing blocking)",
   ":yellow_circle: **Needs changes** -- <count and summary of issues> (has major/medium issues)",
   ":red_circle: **Blocker** -- <count and summary of critical issues> (has critical issues)",
   ```
   NEW:
   ```
   "## Verdict",
   ":green_circle: **Ready to merge** -- No blocking issues found",
   ":yellow_circle: **Ready to merge with minor items** -- Optional cleanup suggestions below (no blockers)",
   ":red_circle: **Address before merging** -- [N] blocking issue(s) found (CRITICAL/MAJOR)",
   ```

2. **Replace the Suggestions template lines** (around lines 990-992):
   OLD:
   ```
   "## Suggestions",
   "- <optional non-blocking improvement>",
   "- <optional non-blocking improvement>",
   ```
   NEW:
   ```
   "## Suggestions",
   "- Optional: <low-friction cleanup or improvement>",
   "- Future consideration: <larger improvement for a follow-up PR>",
   ```

3. **Add a Verdict Logic section** as a new exported helper function `buildVerdictLogicSection()` that returns:
   ```
   ## Verdict Logic

   A "blocker" is any finding with severity CRITICAL or MAJOR under ### Impact.

   Determining the verdict:
   1. Count the number of [CRITICAL] and [MAJOR] findings under ### Impact.
   2. If count > 0: use :red_circle: **Address before merging** -- [count] blocking issue(s) found
   3. If count == 0 AND there are non-blocking findings (MEDIUM, MINOR, Preference items, or Suggestions): use :yellow_circle: **Ready to merge with minor items** -- Optional cleanup suggestions below
   4. If count == 0 AND there are no findings at all: use :green_circle: **Ready to merge** -- No blocking issues found

   Suggestions (## Suggestions section) are NEVER counted as blockers.
   MEDIUM and MINOR findings are NOT blockers. They produce :yellow_circle: at most.
   ```
   Call this helper from `buildReviewPrompt()` -- insert it after the summary comment template `</details>` closing tag but BEFORE the hard requirements block (so Claude reads the logic before the rules).

4. **Update the hard requirements** (around lines 1001-1012):
   - Replace the Suggestions hard requirement line:
     OLD: `"- Under ## Suggestions, list optional improvements that do not block merging -- omit this section if you have no suggestions"`
     NEW: `"- Under ## Suggestions, every item MUST start with 'Optional:' or 'Future consideration:' -- suggestions are NEVER counted against merge readiness -- omit this section if you have no suggestions"`
   - Replace the Verdict hard requirement line:
     OLD: `"- Under ## Verdict, use exactly one verdict line with emoji -- pick the one that matches the review outcome"`
     NEW: `"- Under ## Verdict, use exactly one verdict line with emoji -- determine which one using the Verdict Logic rules above"`
   - Add a new hard requirement after the verdict line:
     `"- A blocker is any [CRITICAL] or [MAJOR] finding under ### Impact. Zero blockers = :green_circle: or :yellow_circle: verdict. Never :red_circle: without blockers"`
   - Update the "summary only posted when issues exist" line:
     OLD: `"- Since this summary is only posted when issues exist, the verdict will typically be :yellow_circle: or :red_circle:"`
     NEW: `"- Since this summary is only posted when issues exist, the verdict will typically be :yellow_circle: or :red_circle:. Use :green_circle: only when all findings are in ### Preference with no Impact findings"`
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- existing tests pass (old verdict label text not asserted in prompt builder tests). Grep for "Looks good" and "Needs changes" and "Blocker" in review-prompt.ts to confirm zero occurrences remain.</verify>
  <done>Verdict template uses three merge-recommendation labels; Verdict Logic section provides deterministic blocker-counting rules; Suggestions template requires Optional:/Future consideration: prefixes; hard requirements enforce all three changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for verdict template, verdict logic section, suggestions format, and hard requirements</name>
  <files>src/execution/review-prompt.test.ts</files>
  <action>
Add a new `describe("Phase 36: Verdict & Merge Confidence", ...)` block with these tests:

1. **"verdict template includes three merge-recommendation states"** -- call `buildReviewPrompt()` with standard mode, assert output contains "Ready to merge", "Ready to merge with minor items", "Address before merging".

2. **"verdict template uses correct emoji mapping"** -- assert `:green_circle:` paired with "Ready to merge", `:yellow_circle:` paired with "Ready to merge with minor items", `:red_circle:` paired with "Address before merging".

3. **"verdict logic section defines blocker as CRITICAL or MAJOR"** -- assert output contains "A \"blocker\" is any finding with severity CRITICAL or MAJOR under ### Impact".

4. **"verdict logic section provides deterministic counting rules"** -- assert output contains the four verdict determination steps (count > 0, count == 0 AND findings, count == 0 AND no findings).

5. **"suggestions template requires Optional or Future consideration prefix"** -- assert output contains "Optional: <low-friction cleanup" and "Future consideration: <larger improvement".

6. **"hard requirements enforce blocker-driven verdict"** -- assert output contains "determine which one using the Verdict Logic rules above" and "Zero blockers = :green_circle: or :yellow_circle: verdict. Never :red_circle: without blockers".

7. **"hard requirements enforce suggestion labeling"** -- assert output contains "every item MUST start with 'Optional:' or 'Future consideration:'" and "suggestions are NEVER counted against merge readiness".

8. **"verdict logic section not included in enhanced mode"** -- call buildReviewPrompt with mode "enhanced", assert output does NOT contain "Verdict Logic" (enhanced mode has no summary comment).

Use the same test helper patterns established in the Phase 35 test block.
  </action>
  <verify>Run `bun test src/execution/review-prompt.test.ts` -- all tests pass including the 8 new tests.</verify>
  <done>8 new tests verify verdict template labels, emoji mapping, verdict logic section content, suggestions prefixes, hard requirements, and enhanced mode exclusion.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/review-prompt.test.ts` passes with all existing + 8 new tests
- `bun test` full suite passes (no regressions)
- Grep for "Looks good", "Needs changes", "Blocker" in review-prompt.ts returns zero matches
- Output of `buildReviewPrompt()` with standard mode contains "Ready to merge", "Verdict Logic", "Optional:", "Future consideration:"
</verification>

<success_criteria>
- Verdict template replaced with merge-recommendation labels (FORMAT-03)
- Verdict Logic section provides deterministic blocker-counting instructions
- Suggestions template enforces Optional:/Future consideration: prefixes (FORMAT-09)
- Hard requirements link verdict to blocker count and exclude suggestions from merge readiness (FORMAT-10)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/36-verdict-and-merge-confidence/36-01-SUMMARY.md`
</output>
