---
phase: 43-auto-profile-selection
plan: 02
type: execute
wave: 2
depends_on: ["43-01"]
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "Small PRs (<=100 changed lines) run with strict profile defaults when no manual/keyword override is present"
    - "Large PRs (>500 changed lines) run with minimal profile defaults when no manual/keyword override is present"
    - "Manual config profile still overrides auto-profile"
    - "Keyword profile override still overrides both manual config and auto-profile"
    - "Review Details reports the applied profile and why it was selected"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Auto-profile integration, precedence wiring, and profile transparency output"
      contains: "resolveReviewProfile"
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for profile selection and precedence in live handler flow"
      min_lines: 40
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/auto-profile.ts"
      via: "resolveReviewProfile call with linesChanged + manual profile + parsed keyword override"
      pattern: "resolveReviewProfile"
    - from: "src/handlers/review.ts"
      to: "formatReviewDetailsSummary"
      via: "Passes selected profile metadata for transparency"
      pattern: "profileSelection"
---

<objective>
Integrate auto-profile resolution into the review handler so runtime profile selection adapts by PR size while preserving override precedence.

Purpose: The resolver from Plan 01 must drive real review behavior and be visible to users/operators. This closes the loop from pure logic to live profile selection and observability.

Output: Updated handler/profile wiring plus tests that prove thresholds and precedence under real review execution paths.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-02-SUMMARY.md
@.planning/phases/43-auto-profile-selection/43-01-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire auto-profile resolver into review pipeline with explicit precedence</name>
  <files>src/handlers/review.ts</files>
  <action>
    Import and use `resolveReviewProfile` from `src/lib/auto-profile.ts` after `parsedIntent` is available and before `PROFILE_PRESETS` are applied.

    Derive `linesChanged` from payload fields already available in `pr` (`pr.additions + pr.deletions`), then resolve profile with:
    - `keywordProfileOverride: parsedIntent.profileOverride`
    - `manualProfile: config.review.profile`
    - `linesChanged`

    Apply resolved profile preset to `resolvedSeverityMinLevel`, `resolvedMaxComments`, `resolvedFocusAreas`, and `resolvedIgnoredAreas` using existing preset behavior.

    Keep current additive keyword behavior from Phase 42 (`[style-ok]`, `[security-review]`) after profile selection.

    Add structured logging for profile selection with fields: `selectedProfile`, `source`, `linesChanged`, `autoBand`.

    Extend Review Details generation to include a line for profile transparency, for example:
    - `Profile: strict (auto, lines changed: 84)`
    - `Profile: minimal (manual config)`
    - `Profile: strict (keyword override)`
  </action>
  <verify>
    `bun test src/handlers/review.test.ts` passes with new profile behavior assertions and Review Details profile disclosure checks.
  </verify>
  <done>
    Live review pipeline selects profile deterministically by precedence: keyword > manual config > auto-threshold, and discloses applied profile reason in Review Details.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for auto thresholds and override precedence in handler flow</name>
  <files>src/handlers/review.test.ts</files>
  <action>
    Add handler integration tests (using existing test harness patterns) for:
    - small PR (`<=100` lines changed) defaults to strict profile behavior (e.g., higher comment cap / lower severity floor)
    - medium PR (`101-500`) defaults to balanced profile behavior
    - large PR (`>500`) defaults to minimal profile behavior
    - manual config profile overrides auto selection
    - keyword override supersedes manual config and auto selection
    - Review Details includes profile reason line with selected source

    Assert behavior via prompt payload outputs or emitted review details text, not private implementation details, to keep tests resilient.
  </action>
  <verify>`bun test src/handlers/review.test.ts`</verify>
  <done>Tests fail on precedence/threshold regressions and enforce profile transparency output contract.</done>
</task>

</tasks>

<verification>
- `bun test src/lib/auto-profile.test.ts`
- `bun test src/handlers/review.test.ts`
- Code review: no bypass path where auto-profile overrides explicit manual profile
- Code review: Review Details always includes applied profile source for executed reviews
</verification>

<success_criteria>
- PROF-01 through PROF-06 are satisfied in runtime review flow
- Profile selection is deterministic and observable in logs + Review Details
- Existing Phase 42 keyword additive behaviors remain intact
</success_criteria>

<output>
After completion, create `.planning/phases/43-auto-profile-selection/43-02-SUMMARY.md`
</output>
