---
phase: 43-auto-profile-selection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/auto-profile.ts
  - src/lib/auto-profile.test.ts
autonomous: true

must_haves:
  truths:
    - "PRs with <=100 changed lines resolve to strict profile"
    - "PRs with 101-500 changed lines resolve to balanced profile"
    - "PRs with >500 changed lines resolve to minimal profile"
    - "Manual config profile overrides auto-profile selection"
    - "Keyword profile override supersedes both manual config and auto-profile"
    - "Resolver emits a machine-readable reason for selected profile"
  artifacts:
    - path: "src/lib/auto-profile.ts"
      provides: "Pure profile resolver with deterministic precedence and threshold logic"
      exports: ["resolveReviewProfile", "AUTO_PROFILE_THRESHOLDS", "ResolvedReviewProfile"]
    - path: "src/lib/auto-profile.test.ts"
      provides: "Threshold and precedence regression tests"
      min_lines: 70
  key_links:
    - from: "src/lib/auto-profile.ts"
      to: "src/lib/pr-intent-parser.ts"
      via: "Accepts parsedIntent.profileOverride as highest-precedence input"
      pattern: "profileOverride"
---

<objective>
Create a deterministic auto-profile resolver with TDD so PR size-to-profile selection and precedence behavior are predictable and safe.

Purpose: Phase 43 must make review depth adaptive without breaking user intent. This requires one pure function that encodes threshold rules and precedence (keyword > manual config > auto).

Output: `src/lib/auto-profile.ts` with exported resolver and `src/lib/auto-profile.test.ts` with complete red/green coverage.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/42-commit-message-keywords-pr-intent/42-02-SUMMARY.md
@src/handlers/review.ts
</context>

<tasks>

<task type="tdd">
  <name>Task 1: RED -- Add failing tests for threshold and precedence resolution</name>
  <files>src/lib/auto-profile.test.ts, src/lib/auto-profile.ts</files>
  <action>
    Create `src/lib/auto-profile.test.ts` covering Phase 43 requirement behavior before implementation:
    - `linesChanged=100` -> `strict`
    - `linesChanged=101` -> `balanced`
    - `linesChanged=500` -> `balanced`
    - `linesChanged=501` -> `minimal`
    - manual config profile wins over auto (`manual=minimal`, `lines=40` => `minimal`)
    - keyword profile wins over manual and auto (`keyword=strict`, `manual=minimal`, `lines=900` => `strict`)
    - return payload includes reason field (`keyword`, `manual`, `auto`) and auto band (`small`, `medium`, `large`) for Review Details/logging transparency.

    Add a minimal stub in `src/lib/auto-profile.ts` exporting:
    - `AUTO_PROFILE_THRESHOLDS` with `strictMax=100`, `balancedMax=500`
    - `ResolvedReviewProfile` type
    - `resolveReviewProfile(...)` function throwing `Error("not implemented")`

    Ensure test run fails due to unimplemented logic (true RED state).
  </action>
  <verify>`bun test src/lib/auto-profile.test.ts` fails with expected assertion/implementation errors before GREEN.</verify>
  <done>Comprehensive failing tests exist for all PROF-02/03/04/05/06 behaviors and boundary values.</done>
</task>

<task type="tdd">
  <name>Task 2: GREEN -- Implement resolver to satisfy tests with deterministic precedence</name>
  <files>src/lib/auto-profile.ts, src/lib/auto-profile.test.ts</files>
  <action>
    Implement `resolveReviewProfile` as a pure function with this strict order:
    1. If `keywordProfileOverride` exists, return it with `source: "keyword"`
    2. Else if `manualProfile` exists, return it with `source: "manual"`
    3. Else compute auto profile from `linesChanged`:
       - `<=100`: strict (`band: "small"`)
       - `101-500`: balanced (`band: "medium"`)
       - `>500`: minimal (`band: "large"`)

    Include transparent metadata in return shape (`selectedProfile`, `source`, `autoBand`, `linesChanged`) for downstream logging and Review Details output.

    Keep module side-effect free; no handler access, no config parsing, no GitHub I/O.
  </action>
  <verify>`bun test src/lib/auto-profile.test.ts` passes all cases.</verify>
  <done>Resolver deterministically returns correct profile + reason metadata for all thresholds and precedence combinations.</done>
</task>

</tasks>

<verification>
- `bun test src/lib/auto-profile.test.ts`
- Code review: no side effects or external dependencies in `src/lib/auto-profile.ts`
- Boundary assertions prove no off-by-one errors at 100/101 and 500/501
</verification>

<success_criteria>
- Auto-profile thresholds satisfy PROF-02, PROF-03, and PROF-04
- Manual override behavior satisfies PROF-05
- Keyword override behavior satisfies PROF-06
- Resolver returns reason metadata for transparent integration in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/43-auto-profile-selection/43-01-SUMMARY.md`
</output>
