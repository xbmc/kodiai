---
phase: 73-degraded-retrieval-contract
plan: 02
type: execute
wave: 2
depends_on: [73-01]
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
  - src/handlers/review.test.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Degraded retrieval output stays within configured prompt budgets and never overflows section limits"
    - "When snippet anchors are unavailable, retrieval evidence degrades to deterministic path-only bullets instead of malformed output"
    - "Review and mention prompts omit retrieval sections cleanly when nothing fits budget (no dangling headers or broken formatting)"
    - "Degraded review paths still render well-formed retrieval context sections when retrieval context is present"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Budget-bounded review retrieval section rendering with deterministic path-only fallback"
      contains: "buildRetrievalContextSection"
    - path: "src/execution/mention-prompt.ts"
      provides: "Budget-bounded mention retrieval section rendering with deterministic ordering and fallback"
      contains: "## Retrieval"
    - path: "src/execution/review-prompt.test.ts"
      provides: "Regression checks for bounded retrieval rendering and malformed-section prevention"
      contains: "buildRetrievalContextSection"
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Regression checks for mention retrieval budgeting and fallback formatting"
      contains: "omits retrieval section"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "handler-provided retrievalContext and degraded flag render together without malformed prompt sections"
      pattern: "retrievalContext|searchRateLimitDegradation"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "mention retrieval findings map into bounded prompt section with deterministic path fallback"
      pattern: "retrievalContext|maxChars|maxItems"
    - from: "src/execution/review-prompt.test.ts"
      to: "src/execution/mention-prompt.test.ts"
      via: "cross-surface parity assertions for overflow trimming and empty-section omission"
      pattern: "drops|omits retrieval section"
---

<objective>
Deliver RET-07 by guaranteeing bounded, well-formed retrieval evidence rendering across degraded review and mention surfaces.

Purpose: Phase 73 requires degraded paths to preserve retrieval usefulness without risking prompt overflow or malformed context sections.
Output: Tightened retrieval rendering contract and regression coverage for review + mention prompt builders, including degraded-path combinations.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/69-snippet-anchors-prompt-budgeting/69-02-SUMMARY.md
@.planning/phases/72-telemetry-follow-through/72-02-SUMMARY.md
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/execution/mention-prompt.ts
@src/execution/mention-prompt.test.ts
@src/handlers/review.test.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden retrieval section rendering contract for bounded and well-formed output</name>
  <files>src/execution/review-prompt.ts, src/execution/mention-prompt.ts</files>
  <action>
Refine retrieval rendering logic so both prompt builders guarantee deterministic bounded output and no malformed retrieval sections under degraded conditions:

- Keep deterministic sorting and overflow trimming by relevance (`distance`, then stable path/line tie-breakers).
- Enforce max-char behavior against fully rendered section length, including headers and bullet lines, and omit the section entirely when nothing fits.
- Preserve evidence quality by preferring `path:line + snippet` and deterministically falling back to `path + findingText` when snippet data is unavailable.
- Ensure formatting remains valid markdown (no dangling blank headers, no partially rendered bullets, no broken code ticks) after trimming.
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts src/execution/mention-prompt.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Review and mention retrieval sections are consistently bounded and well-formed, including edge cases where budget trims all findings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add degraded-path regressions for retrieval rendering and budget safety</name>
  <files>src/execution/review-prompt.test.ts, src/execution/mention-prompt.test.ts, src/handlers/review.test.ts, src/handlers/mention.test.ts</files>
  <action>
Add focused regression coverage that proves RET-07 in real degraded-path combinations:

- Add prompt-level tests asserting degraded review contexts with retrieval findings produce a well-formed retrieval section that stays under configured budgets.
- Add tests for deterministic path-only fallback when anchor snippets are missing in degraded contexts.
- Add tests verifying retrieval section omission remains clean when budgets remove all entries (no malformed headers/leftover scaffolding).
- Add handler-level assertions that degraded execution paths pass bounded retrieval context into prompt builders without throwing or malformed output artifacts.
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts src/execution/mention-prompt.test.ts src/handlers/review.test.ts src/handlers/mention.test.ts --timeout 30000`.
Run `bun test`.
  </verify>
  <done>
RET-07 is regression-locked across review and mention surfaces with explicit degraded-path and overflow edge-case coverage.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/review-prompt.test.ts src/execution/mention-prompt.test.ts --timeout 30000` passes with bounded-section and malformed-output guardrails.
- `bun test src/handlers/review.test.ts src/handlers/mention.test.ts --timeout 30000` passes with degraded-path retrieval integration assertions.
- `bun test` and `bunx tsc --noEmit` pass.
</verification>

<success_criteria>
RET-07 is satisfied: degraded retrieval evidence is always budget-bounded and well-formed, and both review/mention surfaces deterministically fall back to path-only evidence or clean section omission without malformed formatting.
</success_criteria>

<output>
After completion, create `.planning/phases/73-degraded-retrieval-contract/73-02-SUMMARY.md`
</output>
