---
phase: 73-degraded-retrieval-contract
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Every Search-rate-limited degraded review path publishes user-visible output that contains the exact sentence 'Analysis is partial due to API limits.'"
    - "Disclosure text is deterministic on degraded runs even when model output omits or rewrites it"
    - "Non-degraded review outputs do not gain false partial-analysis disclosure"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Deterministic degraded-disclosure enforcement in published review summary output"
      contains: "Analysis is partial due to API limits."
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for degraded disclosure enforcement and non-degraded guardrail"
      contains: "Analysis is partial due to API limits."
    - path: "src/execution/review-prompt.ts"
      provides: "Prompt-level degraded instruction remains aligned to the exact required sentence"
      contains: "## Search API Degradation Context"
  key_links:
    - from: "src/handlers/review.ts"
      to: "published review summary comment"
      via: "post-execution degraded disclosure injection/check before final publish completion"
      pattern: "Analysis is partial due to API limits.|review-output-key"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "runtime degraded flag uses same exact sentence as prompt instructions"
      pattern: "searchRateLimitDegradation|degraded"
    - from: "src/handlers/review.test.ts"
      to: "src/handlers/review.ts"
      via: "tests assert exact-sentence presence on degraded path and absence on non-degraded path"
      pattern: "degraded|Analysis is partial due to API limits."
---

<objective>
Lock RET-06 as a runtime contract by making partial-analysis disclosure deterministic in user-visible degraded review outputs.

Purpose: Prompt-only instructions are not sufficient for reliability follow-through because model wording can drift; Phase 73 requires the exact sentence to appear on every degraded path.
Output: Review-handler disclosure enforcement plus tests proving exact-sentence presence on degraded executions and no leakage on non-degraded executions.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/67-rate-limit-resilience-telemetry/67-02-SUMMARY.md
@.planning/phases/72-telemetry-follow-through/72-01-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce exact degraded disclosure sentence in published review output</name>
  <files>src/handlers/review.ts</files>
  <action>
Implement a deterministic post-execution safeguard in the review publish flow so any run with `searchRateLimitDegradation.degraded === true` includes the exact sentence `Analysis is partial due to API limits.` in the user-visible summary output:

- Add one canonical sentence constant and reuse it for runtime enforcement (avoid duplicated literals).
- Detect degraded executions from the resolved author-tier enrichment outcome (not by parsing prompt text).
- If the summary already contains the exact sentence, keep output unchanged; if missing, inject one short disclosure line in the summary body without breaking existing `<details>` structure and marker tags.
- Keep behavior fail-open and non-blocking: disclosure enforcement must not prevent review completion if comment update fails.
  </action>
  <verify>
Run `bun test src/handlers/review.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Degraded review runs deterministically include the exact disclosure sentence in the published summary output, and enforcement does not block completion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Align prompt degradation contract and add exact-text regressions</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts, src/handlers/review.test.ts</files>
  <action>
Tighten degraded-disclosure contract tests so RET-06 is enforced at both prompt and publish layers:

- Keep `buildSearchRateLimitDegradationSection` anchored to the exact sentence and ensure tests fail on wording drift.
- Add handler-level regressions that validate: (a) degraded path has exactly one required disclosure sentence in user-visible summary output, (b) non-degraded path does not contain it.
- Preserve existing telemetry and retry assertions; only add deterministic disclosure assertions needed for Phase 73.
  </action>
  <verify>
Run `bun test src/execution/review-prompt.test.ts src/handlers/review.test.ts --timeout 30000`.
Run `bun test`.
  </verify>
  <done>
RET-06 fails fast on any disclosure wording drift or missing degraded-path disclosure, while non-degraded behavior remains unchanged.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/review.test.ts --timeout 30000` passes with deterministic degraded-disclosure assertions.
- `bun test src/execution/review-prompt.test.ts --timeout 30000` passes with exact-sentence guardrails.
- `bunx tsc --noEmit` and `bun test` pass.
</verification>

<success_criteria>
RET-06 is satisfied end-to-end: every Search-rate-limited degraded review response includes the exact partial-analysis disclosure sentence in user-visible output, and non-degraded runs remain unaffected.
</success_criteria>

<output>
After completion, create `.planning/phases/73-degraded-retrieval-contract/73-01-SUMMARY.md`
</output>
