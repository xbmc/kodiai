---
phase: 16-write-guardrails
plan: 01
type: execute
wave: 1
depends_on:
  - 15-write-pipeline/15-01-SUMMARY.md
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/jobs/workspace.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
  - docs/runbooks/mentions.md
autonomous: true

must_haves:
  truths:
    - "Write-mode remains opt-in and requires explicit write intent"
    - "Writes are blocked for denied paths and suspicious secrets"
    - "Write-mode has basic rate limiting to reduce accidental spam"
  artifacts:
    - path: src/execution/config.ts
      provides: "write-mode policy config (allow/deny paths, secret scan, rate limit)"
    - path: src/jobs/workspace.ts
      provides: "policy enforcement and secret scan before commit/push"
    - path: src/handlers/mention.ts
      provides: "write-mode uses policy and returns a clear refusal message"
---

<objective>
Add safety guardrails for mention-driven writes: path policy, secret detection blocks, and basic rate limiting.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Add write policy config to .kodiai.yml</name>
  <files>src/execution/config.ts src/execution/config.test.ts</files>
  <action>
  Extend the `write` config with:
  - allowPaths: string[] (default: [])
  - denyPaths: string[] (default: [".github/", ".git/", ".planning/", ".kodiai.yml"])
  - secretScan: { enabled: boolean } (default enabled)
  - minIntervalSeconds: number (default 0)
  Preserve strict schema validation.
  </action>
  <verify>
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 2: Enforce policy + secret scan before commit/push</name>
  <files>src/jobs/workspace.ts</files>
  <action>
  Before committing/pushing, inspect staged paths and staged diffs:
  - Block if any staged path matches denyPaths
  - If allowPaths is non-empty, block unless every staged path matches allowPaths
  - If secretScan enabled, block on common secret markers (private keys, token formats)
  Errors must redact any x-access-token URL patterns.
  </action>
  <verify>
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 3: Apply guardrails in mention write pipeline</name>
  <files>src/handlers/mention.ts src/handlers/mention.test.ts docs/runbooks/mentions.md</files>
  <action>
  - Add a basic in-memory rate limiter for write-mode per installation+repo.
  - When policy blocks, reply concisely explaining why and how to proceed.
  - Update mentions runbook with write policy and common refusal reasons.
  </action>
  <verify>
  - bun test
  </verify>
</task>

</tasks>

<output>
Create `.planning/phases/16-write-guardrails/16-01-SUMMARY.md`.
</output>
