---
phase: 44-smart-finding-prioritization
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/finding-prioritizer.ts
  - src/lib/finding-prioritizer.test.ts
autonomous: true

must_haves:
  truths:
    - "Findings receive a deterministic composite score using severity, file risk, category, and recurrence"
    - "When a cap is provided, prioritization returns exactly the highest-scoring findings up to that cap"
    - "Score ordering is stable and predictable when scores tie"
    - "Prioritization returns summary stats needed for Review Details transparency"
  artifacts:
    - path: "src/lib/finding-prioritizer.ts"
      provides: "Pure scoring and ranking utilities for review findings"
      exports: ["scoreFinding", "prioritizeFindings", "DEFAULT_FINDING_PRIORITY_WEIGHTS"]
    - path: "src/lib/finding-prioritizer.test.ts"
      provides: "Unit tests for weighting, ranking, cap behavior, and stats output"
      min_lines: 80
  key_links:
    - from: "src/lib/finding-prioritizer.ts"
      to: "prioritizeFindings output"
      via: "Returns ranked findings plus top score and threshold score"
      pattern: "thresholdScore"
---

<objective>
Build a pure, deterministic finding prioritization engine with TDD so Phase 44 can enforce multi-factor ranking independent of model output order.

Purpose: Requirement PRIOR-01/02 depends on reliable post-LLM prioritization logic that can be tested in isolation and reused by the review handler.

Output: `src/lib/finding-prioritizer.ts` and `src/lib/finding-prioritizer.test.ts` with RED-GREEN coverage for scoring, sorting, and capped selection behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/40-large-pr-intelligence/40-03-SUMMARY.md
@.planning/phases/43-auto-profile-selection/43-02-SUMMARY.md
@src/lib/file-risk-scorer.ts
@src/handlers/review.ts
</context>

<tasks>

<task type="tdd">
  <name>Task 1: RED -- Add failing unit tests for composite finding scoring and capped ranking</name>
  <files>src/lib/finding-prioritizer.test.ts, src/lib/finding-prioritizer.ts</files>
  <action>
    Create `src/lib/finding-prioritizer.ts` with type exports and stubbed functions that throw `not implemented` so tests compile but fail.

    In `src/lib/finding-prioritizer.test.ts`, add failing tests for:
    - composite scoring uses all four factors: severity, fileRiskScore (0-100), category, and recurrenceCount
    - higher file risk can outrank equal-severity lower-risk findings
    - recurrence raises rank for repeated patterns when other factors are close
    - configurable weights change ordering deterministically
    - `prioritizeFindings` returns only top `maxComments` items when count exceeds cap
    - ties keep stable ordering by original index to avoid non-deterministic churn
    - stats include `findingsScored`, `topScore`, and `thresholdScore` (score of last included finding)

    Use Bun test patterns already used in `src/lib/*.test.ts`. Do not import handler code; keep this as a pure library contract.
  </action>
  <verify>`bun test src/lib/finding-prioritizer.test.ts` fails in RED due to unimplemented stubs</verify>
  <done>Test file compiles and fails on assertions (not import/type errors), proving the desired contract is encoded before implementation.</done>
</task>

<task type="tdd">
  <name>Task 2: GREEN -- Implement pure prioritization engine to satisfy tests</name>
  <files>src/lib/finding-prioritizer.ts</files>
  <action>
    Implement `scoreFinding` and `prioritizeFindings` as pure functions with no I/O.

    Define explicit default weights in `DEFAULT_FINDING_PRIORITY_WEIGHTS` covering:
    - severity
    - fileRisk
    - category
    - recurrence

    Normalize factor scales so composite score stays in a consistent 0-100-like range, and ensure unknown inputs fail open (use safe defaults rather than throwing).

    `prioritizeFindings` must return:
    - ranked findings with computed score metadata
    - selected findings (capped)
    - summary stats needed by Review Details (`findingsScored`, `topScore`, `thresholdScore`)

    Keep implementation deterministic and side-effect free for handler integration in Plan 02.
  </action>
  <verify>
    `bun test src/lib/finding-prioritizer.test.ts`
  </verify>
  <done>
    All prioritizer tests pass, exports are ready for handler integration, and scoring behavior is deterministic across runs.
  </done>
</task>

</tasks>

<verification>
- `bun test src/lib/finding-prioritizer.test.ts`
- Code review: no non-deterministic sort path (stable tie-breaker enforced)
- Code review: ranking stats include fields required by PRIOR-04 transparency
</verification>

<success_criteria>
- PRIOR-01 core scoring engine exists and is fully test-covered
- PRIOR-02 capped top-N selection behavior is deterministic and test-proven
- Prioritization stats contract needed by Review Details is available for runtime wiring
</success_criteria>

<output>
After completion, create `.planning/phases/44-smart-finding-prioritization/44-01-SUMMARY.md`
</output>
