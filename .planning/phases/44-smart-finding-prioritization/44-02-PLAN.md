---
phase: 44-smart-finding-prioritization
plan: 02
type: execute
wave: 2
depends_on: ["44-01"]
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "When visible findings exceed maxComments, only the highest composite-scored findings remain published"
    - "Prioritization uses severity, file risk, category, and recurrence for runtime scoring"
    - "Scoring weights can be configured in .kodiai.yml and defaults are applied safely"
    - "Review Details includes prioritization stats: findings scored, top score, threshold score"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Review prioritization weight schema with defaults and validation"
      contains: "prioritization"
    - path: "src/handlers/review.ts"
      provides: "Runtime prioritization wiring and Review Details transparency output"
      contains: "prioritizeFindings"
    - path: "src/handlers/review.test.ts"
      provides: "Regression tests proving capped publication uses composite score"
      min_lines: 60
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/finding-prioritizer.ts"
      via: "Composite score + capped selection after suppression/confidence filtering"
      pattern: "prioritizeFindings"
    - from: "src/handlers/review.ts"
      to: "formatReviewDetailsSummary"
      via: "Passes prioritization stats for transparent appendix output"
      pattern: "prioritization"
---

<objective>
Wire the Phase 44 prioritization engine into live review execution so comment caps are enforced by composite score with configurable weights and transparent reporting.

Purpose: This closes PRIOR-01 through PRIOR-04 in runtime behavior, ensuring deterministic high-value comment selection when findings exceed profile caps.

Output: Config support for prioritization weights, handler-level prioritization enforcement, and regression coverage for scoring/cap/disclosure behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/44-smart-finding-prioritization/44-01-SUMMARY.md
@src/execution/config.ts
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add configurable prioritization weights to review config</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
    Extend `review` config schema with a `prioritization` object containing weight fields for `severity`, `fileRisk`, `category`, and `recurrence`.

    Use bounded numeric validation (min/max) plus defaults so repo configs can tune behavior safely without breaking load.

    Preserve section-level fallback behavior: invalid prioritization entries must degrade to defaults and emit warnings via existing config parsing flow.

    Add config tests for defaults, valid custom values, and invalid value fallback.
  </action>
  <verify>`bun test src/execution/config.test.ts`</verify>
  <done>`loadRepoConfig` returns deterministic prioritization weights from config with safe defaults/fallbacks.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce composite-scored top-N selection in review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
    Integrate `prioritizeFindings` after suppression and min-confidence filtering, before final inline comment deletion/persistence decisions.

    Build scoring inputs from runtime data:
    - severity/category from each processed finding
    - file risk from Phase 40 risk scores (`computeFileRiskScores` output), defaulting safely when a file has no score
    - recurrence count computed from repeated finding-title fingerprints within the current processed finding set

    Apply cap logic only when visible findings exceed `resolvedMaxComments`; when under cap, keep behavior unchanged.

    Update filtered/deleted inline set so non-selected low-priority findings are removed deterministically (same path as suppressed/low-confidence cleanup).

    Extend Review Details formatter and invocation to include prioritization stats (`findingsScored`, `topScore`, `thresholdScore`) whenever scoring runs.
  </action>
  <verify>
    `bun test src/handlers/review.test.ts`
  </verify>
  <done>
    Runtime review output keeps only top composite-scored findings when cap is exceeded, and Review Details discloses prioritization stats.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression coverage for prioritization cap and transparency behavior</name>
  <files>src/handlers/review.test.ts</files>
  <action>
    Add handler tests that prove:
    - cap overflow path selects findings by composite score, not raw severity order
    - changing prioritization weights changes selected findings predictably
    - under-cap runs do not drop findings due to prioritization
    - Review Details includes required stats fields when prioritization executes

    Reuse existing handler test harness and assert through observable outputs (published/deleted comments and Review Details body), not private local variables.
  </action>
  <verify>`bun test src/handlers/review.test.ts`</verify>
  <done>Phase 44 behavior is regression-guarded for cap selection correctness and PRIOR-04 transparency output.</done>
</task>

</tasks>

<verification>
- `bun test src/lib/finding-prioritizer.test.ts`
- `bun test src/execution/config.test.ts`
- `bun test src/handlers/review.test.ts`
- Code review: no path where cap overflow bypasses prioritization selection
</verification>

<success_criteria>
- PRIOR-01: Composite scoring uses severity + file risk + category + recurrence at runtime
- PRIOR-02: Cap overflow publishes top composite-scored findings (not severity-only)
- PRIOR-03: Weight tuning is available and validated in `.kodiai.yml`
- PRIOR-04: Review Details exposes findings scored, top score, and threshold score
</success_criteria>

<output>
After completion, create `.planning/phases/44-smart-finding-prioritization/44-02-SUMMARY.md`
</output>
