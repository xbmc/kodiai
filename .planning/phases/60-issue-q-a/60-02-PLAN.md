---
phase: 60-issue-q-a
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/issue-code-context.ts
  - src/execution/issue-code-context.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue Q&A can provide concrete repository pointers before generation when code context is relevant"
    - "Code-pointer extraction is deterministic and bounded so mentions remain reliable"
    - "Low-signal questions degrade safely without blocking issue replies"
  artifacts:
    - path: "src/execution/issue-code-context.ts"
      provides: "Bounded helper to derive likely file-path pointers from issue questions"
      exports: ["buildIssueCodeContext"]
    - path: "src/execution/issue-code-context.test.ts"
      provides: "Deterministic coverage for high-signal and low-signal context extraction"
      contains: "buildIssueCodeContext"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/issue-code-context.ts"
      via: "issue-only mention context enrichment"
      pattern: "buildIssueCodeContext"
---

<objective>
Create an issue-specific code-context helper that surfaces likely file pointers from the workspace so issue answers can include actionable file references.

Purpose: Prompt-only instructions are insufficient for consistent path-rich answers; this helper supplies concrete repository hints for ISSUE-01 when questions imply code-level guidance.
Output: New `buildIssueCodeContext()` module and tests covering bounded extraction and fail-open behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/execution/mention-context.ts
@src/execution/mention-prompt.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bounded issue code-context extractor</name>
  <files>src/execution/issue-code-context.ts</files>
  <action>
Create `buildIssueCodeContext(params)` as a pure helper over injected readers/searchers (no direct network calls):
- Input fields:
  - `workspaceDir: string`
  - `question: string`
  - optional `maxPaths` (default 5)
  - optional adapters for `glob`, `grep`, and file reads to keep tests deterministic
- Behavior:
  - Tokenize question into meaningful terms (ignore stopwords and 1-2 character tokens).
  - Search only local repo files and skip noisy paths (`.git`, `node_modules`, lockfiles, generated artifacts).
  - Rank candidate files by lightweight signals (path token match + content token match).
  - Return bounded, deduplicated path pointers with optional line anchors when content match is available.
  - Produce empty result when signal is weak; never throw (fail-open).
  - Keep deterministic ordering: sort by score desc, then path asc for ties.
- Output shape:
  - `paths: Array<{ path: string; line?: number; reason: string }>`
  - `contextBlock: string` suitable for prompt inclusion (empty string when no paths).

Keep implementation intentionally simple and deterministic (no embeddings, no external APIs, no new dependencies).
  </action>
  <verify>Run `bun test src/execution/issue-code-context.test.ts` after tests are added.</verify>
  <done>New module returns bounded path-pointer hints (or empty output) from issue questions without throwing on low-signal or empty repositories.</done>
</task>

<task type="auto">
  <name>Task 2: Add deterministic tests for code-pointer extraction quality</name>
  <files>src/execution/issue-code-context.test.ts</files>
  <action>
Add tests covering:
- Strong signal question yields ranked paths with at least one reasoned pointer.
- Content match adds line anchors when available.
- Weak/ambiguous question yields empty `paths` and empty `contextBlock`.
- Duplicate candidates collapse to unique paths and respect `maxPaths`.
- Tie scores produce stable ordering (score desc, then path asc).
- Internal adapter errors are caught and return safe empty output.

Use small fake repositories in temp dirs or fully mocked adapters; keep tests fast and deterministic.
  </action>
  <verify>Run `bun test src/execution/issue-code-context.test.ts` and `bunx tsc --noEmit`.</verify>
  <done>Test suite proves extraction is bounded, deterministic, and fail-open with no external dependencies.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/issue-code-context.test.ts`
- `bunx tsc --noEmit`
- Confirm module exports `buildIssueCodeContext` and returns stable output shape
</verification>

<success_criteria>
Issue Q&A has a concrete, test-backed mechanism to supply repository file-path pointers when a question needs code context.
</success_criteria>

<output>
After completion, create `.planning/phases/60-issue-q-a/60-02-SUMMARY.md`
</output>
