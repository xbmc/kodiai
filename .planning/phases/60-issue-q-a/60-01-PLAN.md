---
phase: 60-issue-q-a
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue mentions get one direct in-thread answer instead of a generic restatement"
    - "When code context matters, the response contract requires specific file-path pointers"
    - "When context is missing, the response contract requires targeted clarifying questions"
  artifacts:
    - path: "src/execution/mention-prompt.ts"
      provides: "Issue Q&A response contract embedded in mention prompt instructions"
      exports: ["buildMentionPrompt"]
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Prompt contract tests for issue answer quality requirements"
      contains: "issue_comment"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "buildMentionPrompt call"
      pattern: "buildMentionPrompt"
---

<objective>
Define and lock the Issue Q&A response contract in the mention prompt so issue replies are direct, actionable, and path-specific when code evidence is required.

Purpose: ISSUE-01 depends on consistent model behavior; this plan encodes non-negotiable response rules into prompt text and tests before handler wiring.
Output: Updated `buildMentionPrompt()` rules plus regression tests proving issue-surface requirements are present.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/execution/mention-prompt.ts
@src/execution/mention-prompt.test.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add issue-specific answer quality contract to mention prompt</name>
  <files>src/execution/mention-prompt.ts</files>
  <action>
Update `buildMentionPrompt()` with an explicit "Issue Q&amp;A Requirements" instruction block that applies to `mention.surface === "issue_comment"`.

Required instruction content:
- Direct answer first: require the first sentence to answer the question (no recap-first responses).
- File-path evidence rule: when the answer references repository code, include 1-5 concrete paths (optionally `:line`) and tie each path to a specific claim.
- No fabricated pointers: if no reliable path evidence exists, explicitly say path context is missing and ask targeted follow-up questions instead of inventing file names.
- Clarification rule: when the request is underspecified, ask 1-3 targeted questions that unblock implementation-level guidance (not generic "can you clarify?").
- Single-response rule: keep one final in-thread response and avoid extra acknowledgement comments.

Keep existing cross-surface constraints intact (details wrapper, no tracking comment, one publish action). Do not add new tools or change MCP server behavior in this task.
  </action>
  <verify>Run `bun test src/execution/mention-prompt.test.ts` and confirm tests pass with new issue contract assertions.</verify>
  <done>`mention-prompt.ts` contains explicit issue-surface rules for direct answers, path pointers, and targeted clarification behavior without regressing existing prompt instructions.</done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests for issue Q&A prompt guarantees</name>
  <files>src/execution/mention-prompt.test.ts</files>
  <action>
Extend prompt tests with issue-surface cases:
- Add an issue mention fixture (`surface: "issue_comment"`, `prNumber: undefined`) and assert the prompt includes issue-specific response requirements.
- Assert file-path pointer guidance is present and references concrete path formatting (e.g., `src/file.ts` or `src/file.ts:42`).
- Assert underspecified-path behavior requires targeted clarifying questions.

Preserve existing tests for PR comment/review surfaces; do not rewrite unrelated test sections.
  </action>
  <verify>Run `bun test src/execution/mention-prompt.test.ts` and `bunx tsc --noEmit`.</verify>
  <done>Prompt tests fail if issue Q&A instructions for direct answers, code-path pointers, or targeted clarifying questions are removed.</done>
</task>

</tasks>

<verification>
- `bun test src/execution/mention-prompt.test.ts`
- `bunx tsc --noEmit`
- Confirm issue-specific prompt section exists and is gated to issue surface
</verification>

<success_criteria>
The issue mention prompt contract explicitly encodes ISSUE-01 quality requirements, and regression tests enforce that contract.
</success_criteria>

<output>
After completion, create `.planning/phases/60-issue-q-a/60-01-SUMMARY.md`
</output>
