---
phase: 60-issue-q-a
plan: 03
type: execute
wave: 2
depends_on: ["60-01", "60-02"]
files_modified:
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "@kodiai mentions in issue comments produce a direct in-thread answer"
    - "Issue answers include concrete file-path pointers when code context matters"
    - "Underspecified issue asks get targeted clarifying questions instead of guesses"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Issue-surface wiring for code-context enrichment and fallback clarifying reply"
      contains: "issue_comment"
    - path: "src/handlers/mention.test.ts"
      provides: "Regression coverage for issue mention direct reply and clarifying fallback behavior"
      contains: "issue_comment.created"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/issue-code-context.ts"
      via: "buildIssueCodeContext()"
      pattern: "buildIssueCodeContext"
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "issue prompt enrichment with code pointer context"
      pattern: "buildMentionPrompt"
---

<objective>
Wire issue Q&A behavior end-to-end in the mention handler so issue mentions reliably produce actionable answers with path pointers or focused clarification.

Purpose: This integration step satisfies ISSUE-01 at runtime by combining prompt contract + code-pointer enrichment + deterministic fallback on silent/non-published runs.
Output: Mention handler updates for issue comments plus regression tests proving direct answer path and underspecified fallback path.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-issue-q-a/60-01-PLAN.md
@.planning/phases/60-issue-q-a/60-02-PLAN.md
@src/handlers/mention.ts
@src/handlers/mention.test.ts
@src/execution/mention-prompt.ts
@src/execution/issue-code-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate issue code-pointer context into mention handling</name>
  <files>src/handlers/mention.ts</files>
  <action>
Update mention handler execution flow for `mention.surface === "issue_comment"`:
- Before prompt construction, call `buildIssueCodeContext({ workspaceDir: workspace.dir, question: writeIntent.request })`.
- Feed `contextBlock` into prompt construction (either appended to `mentionContext` or included in `customInstructions`) so the model receives concrete path candidates.
- Keep fail-open behavior: if extraction fails or returns no pointers, continue normal mention processing.
- Preserve existing policy constraints from STATE.md:
  - No unsolicited responses (only mention-triggered execution)
  - No auto re-review behavior changes

Do not change PR mention flows, write-mode gates, or publication tool routing in this task.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000` and confirm issue mention scenarios still pass with new issue-context wiring.</verify>
  <done>Issue-comment mentions include optional code-pointer context in the prompt path while keeping existing mention behavior and fail-open resilience.</done>
</task>

<task type="auto">
  <name>Task 2: Add issue Q&A regression tests for direct answer and targeted clarification fallback</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add focused tests for `issue_comment.created` mentions:
- **Direct-answer path test:** capture prompt passed to executor for an issue mention and assert injected issue code-context block contains file-path pointers when helper returns matches.
- **Fallback clarifying test:** simulate successful execution with `published: false` on issue mention and verify handler posts one fallback reply containing 1-3 targeted clarifying questions (not generic "please clarify" only).
- **Single-reply behavior test:** verify issue mention path creates at most one fallback comment when non-published success occurs.

Use mocked Octokit issue comment methods and keep tests isolated from PR review-comment thread mechanics.
  </action>
  <verify>Run `bun test src/handlers/mention.test.ts --timeout 30000`, then `bun test`, then `bunx tsc --noEmit`.</verify>
  <done>Handler tests prove issue mentions produce actionable answer context and targeted clarification fallback while maintaining single in-thread response behavior.</done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000`
- `bun test`
- `bunx tsc --noEmit`
- Manual assertion in tests that issue path includes concrete file pointers when relevant
</verification>

<success_criteria>
Issue mentions are fully wired for ISSUE-01: direct in-thread answers, concrete file-path guidance when code context is relevant, and targeted clarifying questions when context is missing.
</success_criteria>

<output>
After completion, create `.planning/phases/60-issue-q-a/60-03-SUMMARY.md`
</output>
