---
phase: 70-cross-surface-conversational-ux
plan: 02
type: execute
wave: 2
depends_on: [70-01]
files_modified:
  - src/execution/mention-prompt.test.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Cross-surface mention prompts remain contract-consistent after future edits"
    - "Insufficient-context behavior is locked to one targeted clarifying question instead of speculative or generic output"
    - "Surface-specific safety/UX rules stay intact (no unsolicited responses, no implicit write-mode entry on PR/review surfaces)"
  artifacts:
    - path: "src/execution/mention-prompt.test.ts"
      provides: "Prompt-contract regression coverage for issue, PR comment, and review-thread surfaces"
      min_lines: 200
    - path: "src/handlers/mention.test.ts"
      provides: "Runtime regression suite for clarifying fallback shape and safety gate preservation"
      min_lines: 400
  key_links:
    - from: "src/execution/mention-prompt.test.ts"
      to: "src/execution/mention-prompt.ts"
      via: "surface-by-surface assertions on contract wording and one-question fallback instruction"
      pattern: "Conversational Response Contract|targeted clarifying question"
    - from: "src/handlers/mention.test.ts"
      to: "src/handlers/mention.ts"
      via: "execution-path assertions for non-published fallback, implicit intent gating, and mention-trigger requirements"
      pattern: "non-published|writeIntent|containsMention"
---

<objective>
Lock cross-surface conversational UX behavior with durable regression coverage.

Purpose: Prevent regressions after implementation by encoding CONV-01/CONV-02 and safety expectations directly in prompt and handler tests.
Output: A cross-surface clarification and safety regression suite covering issue, PR, and review-thread mention execution paths.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/70-cross-surface-conversational-ux/70-01-SUMMARY.md
@.planning/phases/60-issue-q-a/60-03-SUMMARY.md
@src/execution/mention-prompt.test.ts
@src/handlers/mention.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cross-surface prompt-contract regression matrix</name>
  <files>src/execution/mention-prompt.test.ts</files>
  <action>
Add a table-driven regression suite that renders mention prompts for each conversational surface (issue_comment, PR top-level comment, pr_review_comment) and asserts:

- The unified response contract is present with required sequence: direct answer, evidence pointers, next-step framing.
- Insufficient-context instruction requires exactly one targeted clarifying question and forbids generic clarification prompts.
- Surface-specific publish instructions remain correct for inline review-thread vs top-level issue/PR comment replies.

Keep assertions resilient to harmless wording tweaks by checking durable contract markers rather than exact full-paragraph snapshots.
  </action>
  <verify>
Run `bun test src/execution/mention-prompt.test.ts --timeout 30000`.
  </verify>
  <done>
Prompt tests fail if cross-surface contract consistency or one-question clarifying fallback behavior is removed or diverges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add handler safety + clarification regressions across mention surfaces</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Expand mention handler coverage to enforce runtime behavior end-to-end:

- For issue, PR, and inline review mention scenarios where execution returns success with `published: false`, verify exactly one targeted clarifying fallback reply is posted.
- Assert no unsolicited-response regressions by confirming non-mention content still short-circuits without posting any reply.
- Assert no implicit write-mode entry on PR/review surfaces even when implementation verbs are present (implicit auto-promotion remains issue-comment scoped only).
- Preserve existing fail-open and single-response behavior (at most one fallback comment).

Do not add brittle assertions that depend on external network responses or non-deterministic logs.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Handler regressions prove clarifying fallback shape and safety contracts stay stable across surfaces and future refactors.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/mention-prompt.test.ts --timeout 30000` passes with cross-surface contract matrix coverage.
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with one-question fallback and safety-gate assertions.
- `bunx tsc --noEmit` passes.
</verification>

<success_criteria>
CONV-01/CONV-02 and safety invariants are protected by deterministic automated tests across all conversational mention surfaces, preventing drift in future phases.
</success_criteria>

<output>
After completion, create `.planning/phases/70-cross-surface-conversational-ux/70-02-SUMMARY.md`
</output>
