---
phase: 70-cross-surface-conversational-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/mention-prompt.ts
  - src/execution/mention-prompt.test.ts
  - src/handlers/mention.ts
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue, PR, and review-thread mention prompts all instruct the same response contract: direct answer, evidence pointers, and next-step framing"
    - "When context is insufficient, the response contract asks exactly one targeted clarifying question instead of speculative guidance"
    - "Surface safety rules remain explicit: no unsolicited responses and no implicit write-mode entry outside issue-comment intent gates"
  artifacts:
    - path: "src/execution/mention-prompt.ts"
      provides: "Unified cross-surface conversational response contract instructions with one-question clarifying fallback"
      contains: "## Conversational Response Contract"
    - path: "src/handlers/mention.ts"
      provides: "Runtime fallback behavior aligned to one targeted clarifying question on non-published successful mention execution"
      contains: "Could you share"
    - path: "src/handlers/mention.test.ts"
      provides: "Cross-surface runtime regressions for clarifying fallback and safety invariants"
      min_lines: 300
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "buildMentionPrompt receives contract-aligned fallback guidance and surface metadata"
      pattern: "buildMentionPrompt\("
    - from: "src/handlers/mention.ts"
      to: "src/handlers/mention.test.ts"
      via: "tests validate one-question fallback and no implicit write-mode on non-issue surfaces"
      pattern: "targeted clarifying|write mode|issue_comment"
---

<objective>
Unify conversational response behavior across issue, PR, and review-thread mention surfaces.

Purpose: CONV-01 and CONV-02 require one consistent response contract and a deterministic clarifying fallback when context is missing, without weakening existing safety gates.
Output: Updated mention prompt/handler behavior where all mention surfaces follow one contract and ask one targeted clarifying question when insufficient context is available.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/60-issue-q-a/60-03-SUMMARY.md
@.planning/phases/61-read-only-intent-gating/61-01-SUMMARY.md
@.planning/phases/69-snippet-anchors-prompt-budgeting/69-02-SUMMARY.md
@src/execution/mention-prompt.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement a single conversational contract section for all mention surfaces</name>
  <files>src/execution/mention-prompt.ts, src/execution/mention-prompt.test.ts</files>
  <action>
Refactor mention prompt construction so issue_comment, PR top-level comments, and inline review-thread comments all share the same explicit response contract section:

- Contract must require three ordered behaviors in every response: direct answer first, concrete evidence pointers when claims reference repo code, and a brief next-step framing.
- Clarification fallback must be explicit and singular: when context is insufficient, ask exactly one targeted clarifying question (not 1-3, not generic "can you clarify?").
- Preserve existing surface-specific publishing instructions (inline thread tool for pr_review_comment and top-level comment tool fallback for other surfaces).
- Preserve existing issue-only policy language (write/read intent behavior) without leaking issue-specific wording into non-issue surfaces.

Do not change retrieval budgeting behavior from Phase 69.
  </action>
  <verify>
Run `bun test src/execution/mention-prompt.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
All mention surfaces receive the same conversational response contract with one targeted clarifying-question fallback while preserving surface-specific publish mechanics and issue-only policy gates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Align runtime fallback messaging and safety guards with the unified contract</name>
  <files>src/handlers/mention.ts, src/handlers/mention.test.ts</files>
  <action>
Update mention runtime behavior so the non-published-success fallback message follows the same one-question clarifying contract for issue, PR, and review-comment surfaces:

- Replace multi-question fallback copy with one targeted clarifying question that asks for the minimum missing context.
- Keep fail-open behavior unchanged (fallback still posts a single final reply when execution succeeds but publishes nothing).
- Keep safety invariants unchanged: no unsolicited responses, no implicit write-mode auto-entry outside issue_comment implementation-intent handling.
- Add/adjust focused regressions to prove fallback shape and safety gates remain intact across surfaces.

Do not alter write-mode branch/PR behavior from Phases 62-65.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Runtime mention fallback is contract-consistent (one targeted clarifying question), remains single-reply/fail-open, and preserves no-unsolicited/no-implicit-write safety behavior.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/mention-prompt.test.ts --timeout 30000` passes with cross-surface contract assertions.
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with one-question fallback and safety invariant assertions.
- `bunx tsc --noEmit` passes.
</verification>

<success_criteria>
CONV-01 and CONV-02 behavior is implemented in runtime paths: response contract is surface-consistent and insufficient-context handling asks one targeted clarifying question without relaxing existing safety rules.
</success_criteria>

<output>
After completion, create `.planning/phases/70-cross-surface-conversational-ux/70-01-SUMMARY.md`
</output>
