---
phase: 28-knowledge-store-explicit-learning
plan: 03
type: execute
wave: 2
depends_on: ["28-01", "28-02"]
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/handlers/review.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Review prompt contains suppression rules section instructing Claude not to flag suppressed patterns"
    - "Review prompt contains confidence display instructions for structured output"
    - "Review prompt contains metrics formatting instructions for the summary comment"
    - "Review handler initializes knowledge store and persists findings after execution"
    - "Review handler applies suppression matching against finding metadata post-execution"
    - "Review summary includes collapsible Review Details section with quantitative metrics"
    - "Low-confidence findings appear in a separate collapsible section"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "buildSuppressionRulesSection, buildConfidenceInstructions, buildMetricsInstructions prompt sections"
      contains: "buildSuppressionRulesSection"
    - path: "src/handlers/review.ts"
      provides: "Knowledge store integration, suppression matching, metrics collection in review pipeline"
      contains: "knowledgeStore"
    - path: "src/index.ts"
      provides: "Knowledge store initialization alongside telemetry store"
      contains: "createKnowledgeStore"
  key_links:
    - from: "src/index.ts"
      to: "src/knowledge/store.ts"
      via: "import and initialize createKnowledgeStore"
      pattern: "import.*createKnowledgeStore.*from.*knowledge/store"
    - from: "src/handlers/review.ts"
      to: "src/knowledge/types.ts"
      via: "KnowledgeStore type for dependency injection"
      pattern: "import.*KnowledgeStore.*from.*knowledge/types"
    - from: "src/handlers/review.ts"
      to: "src/knowledge/confidence.ts"
      via: "computeConfidence and matchesSuppression for post-execution processing"
      pattern: "import.*computeConfidence.*from.*knowledge/confidence"
    - from: "src/execution/review-prompt.ts"
      to: "suppression rules"
      via: "prompt section injected when suppressions configured"
      pattern: "buildSuppressionRulesSection"
---

<objective>
Wire the knowledge store, suppression matching, confidence scoring, and review metrics into the review pipeline. This is the integration plan that connects Plans 01 and 02 to the live review flow.

Purpose: The storage and computation primitives exist; now they need to flow through the prompt (so Claude respects suppressions and outputs structured data) and through the handler (so findings are persisted and metrics are collected). This delivers LEARN-01 through LEARN-04.

Output: Enriched review prompt with suppression/confidence/metrics sections, handler integration with knowledge store writes, and app-level initialization.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-knowledge-store-explicit-learning/28-RESEARCH.md
@.planning/phases/28-knowledge-store-explicit-learning/28-01-SUMMARY.md
@.planning/phases/28-knowledge-store-explicit-learning/28-02-SUMMARY.md
@src/execution/review-prompt.ts
@src/handlers/review.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add suppression rules, confidence display, and metrics formatting prompt sections</name>
  <files>src/execution/review-prompt.ts, src/execution/review-prompt.test.ts</files>
  <action>
    Add three new helper functions to review-prompt.ts following the existing helper function pattern (return empty string when not applicable):

    1. **buildSuppressionRulesSection(suppressions: Array<string | SuppressionPattern>): string**
       - Import or define SuppressionPattern type inline: `{ pattern: string; severity?: string[]; category?: string[]; paths?: string[] }`
       - When suppressions is empty, return ""
       - Build a "## Suppression Rules" section listing each pattern with its optional filters
       - Include instructions: "Do not flag findings matching these patterns. Still count suppressed findings mentally for the metrics section."
       - Add safety clause: "NEVER suppress findings at CRITICAL severity regardless of suppression patterns."

    2. **buildConfidenceInstructions(minConfidence: number): string**
       - Return "## Confidence Display" section
       - Instruct Claude to include severity and category in each finding's YAML metadata (enhanced mode already does this; standard mode gets the instruction to tag inline comments)
       - Explain that confidence scores will be computed post-execution from severity and category signals
       - If minConfidence > 0: "Findings below {minConfidence}% confidence will be shown in a separate collapsible section."

    3. **buildMetricsInstructions(): string**
       - Return "## Review Metrics" section
       - Instruct Claude to include at the END of inline comments (or as a final step) a structured metrics block that the handler can parse: total files reviewed, lines changed, issues found by severity level
       - Format: the handler will construct the metrics section from its own data (diff analysis metrics + finding counts), so the prompt instruction is light -- just tell Claude to categorize findings consistently so the handler can count them

    Update buildReviewPrompt() context type to accept:
    - `suppressions?: Array<string | { pattern: string; severity?: string[]; category?: string[]; paths?: string[] }>`
    - `minConfidence?: number`

    Insert new sections into the prompt assembly in this order (after focus areas, before summary comment):
    - Suppression rules (if suppressions non-empty)
    - Confidence display instructions (always, to ensure consistent output structure)
    - Metrics instructions (always in enhanced mode, optional in standard)

    Add tests in review-prompt.test.ts:
    - buildSuppressionRulesSection with string patterns, object patterns, mixed, empty array
    - buildSuppressionRulesSection includes CRITICAL safety clause
    - buildConfidenceInstructions with minConfidence=0 and minConfidence=40
    - buildMetricsInstructions returns non-empty section
    - buildReviewPrompt includes suppression section when suppressions provided
    - buildReviewPrompt omits suppression section when suppressions empty
  </action>
  <verify>
    ```bash
    bun test src/execution/review-prompt.test.ts
    bunx tsc --noEmit
    ```
  </verify>
  <done>
    Three new prompt section builders exist with tests. buildReviewPrompt accepts and uses suppressions and minConfidence. Suppression rules include CRITICAL safety clause.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire knowledge store initialization and handler integration</name>
  <files>src/handlers/review.ts, src/index.ts</files>
  <action>
    **src/index.ts changes:**
    - Import `createKnowledgeStore` from `./knowledge/store.ts`
    - After telemetry store initialization, add knowledge store initialization:
      ```
      const knowledgeDbPath = process.env.KNOWLEDGE_DB_PATH ?? "./data/kodiai-knowledge.db";
      const knowledgeStore = createKnowledgeStore({ dbPath: knowledgeDbPath, logger });
      ```
    - No startup purge (keep forever per locked decision). Do run checkpoint() after creation.
    - Pass `knowledgeStore` to both `createReviewHandler` and `createMentionHandler` deps objects

    **src/handlers/review.ts changes:**
    - Add `KnowledgeStore` to deps type (optional for backward compat: `knowledgeStore?: KnowledgeStore`)
    - Import `computeConfidence` and `matchesSuppression` from `../knowledge/confidence.ts`
    - Import `KnowledgeStore` type from `../knowledge/types.ts`

    **In the review execution flow (after executor.execute returns and before telemetry recording):**

    1. **Pass suppressions and minConfidence to buildReviewPrompt:**
       - Read `config.review.suppressions` and `config.review.minConfidence` from the loaded repo config
       - Pass them to buildReviewPrompt as `suppressions` and `minConfidence`

    2. **Collect review metrics from existing data:**
       - Files analyzed: from `diffAnalysis.metrics.totalFiles` (already computed)
       - Lines changed: from `diffAnalysis.metrics.totalLinesAdded + diffAnalysis.metrics.totalLinesRemoved`
       - Duration: from `result.durationMs` (already captured)
       - Finding counts: will be populated from structured output parsing (see below)

    3. **Knowledge store recording (fire-and-forget, mirrors telemetry pattern):**
       After telemetry recording block, add a knowledge store recording block wrapped in try/catch:
       ```
       if (deps.knowledgeStore) {
         try {
           const reviewId = deps.knowledgeStore.recordReview({
             repo: `${owner}/${repo}`,
             prNumber,
             headSha: headSha,
             deliveryId: event.deliveryId,
             filesAnalyzed: diffAnalysis?.metrics.totalFiles ?? 0,
             linesChanged: (diffAnalysis?.metrics.totalLinesAdded ?? 0) + (diffAnalysis?.metrics.totalLinesRemoved ?? 0),
             findingsCritical: 0,  // Placeholder for now -- Phase 28 does not parse Claude's output
             findingsMajor: 0,
             findingsMedium: 0,
             findingsMinor: 0,
             findingsTotal: 0,
             suppressionsApplied: 0,
             configSnapshot: JSON.stringify({
               mode: config.review.mode,
               severityMinLevel: config.review.severity.minLevel,
               focusAreas: config.review.focusAreas,
               maxComments: config.review.maxComments,
               suppressionCount: config.review.suppressions.length,
               minConfidence: config.review.minConfidence,
               profile: config.review.profile,
             }),
             durationMs: result.durationMs,
             model: config.model,
             conclusion: result.conclusion,
           });
           logger.debug({ reviewId, repo: `${owner}/${repo}`, prNumber }, "Knowledge store: review recorded");
         } catch (err) {
           logger.warn({ err, repo: `${owner}/${repo}`, prNumber }, "Knowledge store write failed (non-fatal)");
         }
       }
       ```

    IMPORTANT:
    - Knowledge store writes MUST be fire-and-forget (try/catch with warn log). Never fail the review job.
    - Finding-level recording (recordFindings, recordSuppressionLog) requires parsing Claude's structured output. For Phase 28, record the review-level metrics only. Finding parsing would need enhanced mode YAML block extraction which is out of scope for this plan -- the review record with metric placeholders (zeros) is sufficient for the store to be operational. The prompt instructions and schema are in place; future plans can add output parsing.
    - The knowledgeStore dep is optional (?) so existing tests and mention handler do not break.
  </action>
  <verify>
    ```bash
    bun test
    bunx tsc --noEmit
    ```
    All existing tests pass. No TypeScript errors. The review handler accepts and passes through the new config fields.
  </verify>
  <done>
    Knowledge store initialized at startup alongside telemetry. Review handler passes suppressions and minConfidence to prompt builder. Review handler records review-level data to knowledge store after each execution (fire-and-forget). Knowledge store failure never crashes the review job.
  </done>
</task>

</tasks>

<verification>
```bash
bun test
bunx tsc --noEmit
```
All tests pass (existing + new). TypeScript compiles cleanly.
</verification>

<success_criteria>
- Review prompt includes suppression rules section when suppressions are configured
- Review prompt includes confidence and metrics instructions
- Knowledge store is initialized at app startup with its own database file
- Each review execution writes a review record to the knowledge store
- Knowledge store write failures are caught and logged without affecting the review
- All existing behavior is preserved (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/28-knowledge-store-explicit-learning/28-03-SUMMARY.md`
</output>
