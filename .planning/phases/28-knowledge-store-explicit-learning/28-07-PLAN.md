---
phase: 28-knowledge-store-explicit-learning
plan: 07
type: execute
wave: 4
depends_on: ["28-03", "28-06"]
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Runtime extracts real findings from review execution and persists finding/suppression history per repo"
    - "Configured suppressions are applied deterministically to emitted findings, not only prompt instructions"
    - "minConfidence uses a soft filter: below-threshold findings move to a separate Low Confidence Findings section"
    - "Published review output always includes a collapsible Review Details section with files, lines, severity counts, and estimated time saved"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Finding extraction, suppression/minConfidence filtering, output enforcement, and knowledge-store persistence wiring"
      contains: "recordFindings"
    - path: "src/handlers/review.test.ts"
      provides: "Regression coverage for extraction/filtering/persistence and Review Details metrics enforcement"
      contains: "Low Confidence Findings"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/knowledge/confidence.ts"
      via: "matchesSuppression + computeConfidence over extracted findings"
      pattern: "computeConfidence|matchesSuppression"
    - from: "src/handlers/review.ts"
      to: "src/knowledge/store.ts"
      via: "recordReview + recordFindings + recordSuppressionLog"
      pattern: "recordFindings|recordSuppressionLog"
    - from: "src/handlers/review.ts"
      to: "published summary body"
      via: "deterministic Review Details and Low Confidence Findings section assembly"
      pattern: "Review Details|Low Confidence Findings|estimated review time saved"
---

<objective>
Close unresolved Phase 28 verification gaps by wiring runtime finding extraction, deterministic suppression/confidence behavior, and enforced quantitative review-details output.

Purpose: Phase 28 infrastructure exists, but LEARN-01..LEARN-04 remain blocked because runtime currently uses placeholder findings and model-only formatting compliance. This plan completes the runtime loop so learning behavior is deterministic and persistently queryable.

Output: Review-handler extraction/filtering/persistence pipeline plus tests that lock suppression, minConfidence soft filtering, and required Review Details metrics/time-saved output.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-knowledge-store-explicit-learning/28-VERIFICATION.md
@.planning/phases/28-knowledge-store-explicit-learning/28-UAT.md
@.planning/phases/28-knowledge-store-explicit-learning/28-03-SUMMARY.md
@.planning/phases/28-knowledge-store-explicit-learning/28-05-SUMMARY.md
@.planning/phases/28-knowledge-store-explicit-learning/28-06-SUMMARY.md
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace placeholder findings with deterministic runtime extraction</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
    Implement concrete finding extraction in the review handler so `extractedFindings` is derived from execution output (inline-comment tool payloads and/or review summary structure), not `[]`.

    Requirements:
    - Extract file path, title, severity, category, and line metadata where available.
    - Normalize severities to `critical|major|medium|minor` and categories to the project taxonomy.
    - Keep extraction deterministic and non-fatal: parsing failures must degrade to empty extraction with warning logs, never fail review delivery.
    - Add tests proving extraction returns non-empty structured findings for representative emitted output.
  </action>
  <verify>
    `bun test src/handlers/review.test.ts`
  </verify>
  <done>
    Review handler no longer uses hardcoded empty findings; extracted findings are structured and test-covered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply suppression and minConfidence soft-filtering before publish and persistence</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
    Use real extracted findings to run suppression and confidence logic before publishing/persisting results.

    Requirements (honor locked phase decisions exactly):
    - Keep suppression behavior on the existing hybrid pattern format with required syntax prefixes (`glob:` / `regex:`) plus metadata filters; use the configured matching utilities (no alternate suppression format).
    - Compute confidence as deterministic 0-100 scores from severity/category/pattern-strength signals (no model self-scoring).
    - Enforce soft threshold behavior: findings below `review.minConfidence` move into a separate collapsible `Low Confidence Findings` section instead of being dropped.
    - Exclude suppressed findings from normal published findings output deterministically, while still counting and persisting them.
    - Persist full finding history with `knowledgeStore.recordFindings(...)` including suppression/confidence fields, and persist suppression hit aggregates with `knowledgeStore.recordSuppressionLog(...)`.
    - Keep knowledge writes fire-and-forget and non-fatal, consistent with existing runtime write strategy.
  </action>
  <verify>
    `bun test src/handlers/review.test.ts`
  </verify>
  <done>
    Suppression and minConfidence logic affect emitted output and knowledge persistence deterministically, and suppression history is queryable through stored records.
  </done>
</task>

<task type="auto">
  <name>Task 3: Programmatically enforce Review Details metrics and estimated time-saved output</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
    Add handler-side output enforcement so Review Details metrics do not depend solely on prompt compliance.

    Requirements:
    - Ensure every published review summary includes a collapsible `Review Details` section with: files reviewed, lines analyzed/changed, and severity counts.
    - Compute and include an estimated review-time-saved metric from deterministic runtime inputs (for example findings reviewed/triaged and diff scale), and keep the formula explicit in code comments/tests.
    - Keep suppression counting visible in metrics output and persisted review rows so historical tracking remains complete.
    - Add regression tests asserting required Review Details fields and estimated time-saved wording are present in published output contract.
  </action>
  <verify>
    `bun test src/handlers/review.test.ts`
  </verify>
  <done>
    Quantitative Review Details and estimated time saved are guaranteed by runtime logic, not model variability, and regression tests fail on contract drift.
  </done>
</task>

</tasks>

<verification>
```bash
bun test src/handlers/review.test.ts
bunx tsc --noEmit src/handlers/review.ts
```
All gap assertions pass: extracted findings are non-empty when output exists, suppression/confidence filtering is deterministic, finding+suppression persistence is wired, and Review Details metrics/time-saved are enforced.
</verification>

<success_criteria>
- LEARN-01: runtime persists review + finding + suppression history per repo via knowledge store APIs
- LEARN-02: suppression config deterministically removes suppressed findings from normal output while recording suppression counts
- LEARN-03: minConfidence threshold applies a soft filter with a dedicated Low Confidence Findings section
- LEARN-04: every review summary includes enforced Review Details metrics and estimated review time saved
</success_criteria>

<output>
After completion, create `.planning/phases/28-knowledge-store-explicit-learning/28-07-SUMMARY.md`
</output>
