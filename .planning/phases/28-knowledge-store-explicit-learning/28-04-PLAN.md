---
phase: 28-knowledge-store-explicit-learning
plan: 04
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - scripts/kodiai-stats.ts
  - scripts/kodiai-trends.ts
autonomous: true

must_haves:
  truths:
    - "Operator can run kodiai-stats to see review statistics for a repo"
    - "Operator can run kodiai-trends to see daily trend data over time"
    - "Both scripts output human-readable tables by default and JSON with --json flag"
    - "Both scripts open the database in read-only mode"
    - "Both scripts work without importing from src/ (self-contained)"
  artifacts:
    - path: "scripts/kodiai-stats.ts"
      provides: "CLI for review statistics per repo"
      min_lines: 80
    - path: "scripts/kodiai-trends.ts"
      provides: "CLI for trend analysis per repo"
      min_lines: 60
  key_links:
    - from: "scripts/kodiai-stats.ts"
      to: "bun:sqlite"
      via: "direct database access in read-only mode"
      pattern: "new Database.*readonly.*true"
    - from: "scripts/kodiai-trends.ts"
      to: "bun:sqlite"
      via: "direct database access in read-only mode"
      pattern: "new Database.*readonly.*true"
---

<objective>
Create CLI query scripts for operators to inspect knowledge store data on demand. These mirror the existing `scripts/usage-report.ts` pattern.

Purpose: Users need to query review statistics and trends for their repos (LEARN-04 and locked decision about CLI query commands). The scripts are self-contained -- they open the SQLite database directly without importing from src/.

Output: Two standalone CLI scripts: `kodiai-stats.ts` and `kodiai-trends.ts`.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-knowledge-store-explicit-learning/28-RESEARCH.md
@.planning/phases/28-knowledge-store-explicit-learning/28-01-SUMMARY.md
@scripts/usage-report.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create kodiai-stats CLI script</name>
  <files>scripts/kodiai-stats.ts</files>
  <action>
    Create `scripts/kodiai-stats.ts` following the exact pattern of `scripts/usage-report.ts`:

    **Argument parsing** (using `util.parseArgs`):
    - `--repo <owner/name>` (required) -- repository to query
    - `--since <value>` (optional) -- time filter: "7d", "30d", "90d", or ISO date string. Parse "Nd" as N days ago.
    - `--json` (boolean, default false) -- output as JSON instead of table
    - `--db <path>` (optional, default `./data/kodiai-knowledge.db`) -- database path
    - `-h, --help` (boolean) -- show usage and exit

    **Database access:**
    - Open with `new Database(resolve(dbPath), { readonly: true })`
    - Set `PRAGMA busy_timeout = 5000`
    - Check if database file exists before opening; if not, print "No knowledge store found at {path}" and exit 1

    **Queries (parameterized with $-prefix):**
    - Total reviews for repo (with optional since filter)
    - Total findings by severity (JOIN reviews + findings)
    - Total suppressions applied (SUM from reviews table)
    - Average findings per review
    - Average confidence (from findings table)
    - Top 10 files by finding count

    **Output format (human-readable, similar to usage-report.ts):**
    ```
    Kodiai Review Stats: owner/repo
    ==========================================
    Period:           Last 30 days
    Reviews:          42
    Total Findings:   187 (31 suppressed)
    Avg Findings/PR:  4.5
    Avg Confidence:   72%

    By Severity:
      Critical:  8
      Major:    45
      Medium:   89
      Minor:    45

    Top Files:
      src/api/auth.ts        12 findings
      src/handlers/user.ts    8 findings
      src/lib/database.ts     7 findings
    ```

    **JSON output (--json):**
    Print the same data as a JSON object to stdout.

    **Edge cases:**
    - No reviews found for repo: print "No reviews found for {repo}" and exit 0
    - No findings table data (reviews exist but no findings): show review metrics, show "No finding details recorded yet" for severity and file sections
    - Database does not exist: print error and exit 1

    IMPORTANT: Do NOT import anything from `src/`. This script is self-contained. Open the database directly with `bun:sqlite`. Follow the usage-report.ts pattern exactly for structure and error handling.
  </action>
  <verify>
    ```bash
    bunx tsc --noEmit scripts/kodiai-stats.ts
    bun scripts/kodiai-stats.ts --help
    ```
    TypeScript compiles. Help text displays without errors.
  </verify>
  <done>
    `bun scripts/kodiai-stats.ts --repo=owner/name` outputs review statistics. `--json` flag outputs JSON. `--since` filters by time period. Script is self-contained with no src/ imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create kodiai-trends CLI script</name>
  <files>scripts/kodiai-trends.ts</files>
  <action>
    Create `scripts/kodiai-trends.ts` following the same pattern:

    **Argument parsing:**
    - `--repo <owner/name>` (required)
    - `--days <number>` (optional, default 30) -- number of days to show
    - `--json` (boolean, default false)
    - `--db <path>` (optional, default `./data/kodiai-knowledge.db`)
    - `-h, --help`

    **Database access:** Same as kodiai-stats.ts (read-only, busy_timeout, existence check).

    **Query:**
    Group reviews by date (strftime('%Y-%m-%d', created_at)) for the given repo over the last N days. For each date:
    - review count
    - total findings count (JOIN with findings table)
    - total suppressions applied (SUM from reviews table)
    - average confidence (from findings table)

    Use LEFT JOIN so dates with reviews but no findings still appear.

    **Output format (human-readable):**
    ```
    Kodiai Review Trends: owner/repo (last 30 days)
    ==========================================
    Date        Reviews  Findings  Suppressed  Avg Confidence
    2026-02-12       3        14          2         74%
    2026-02-11       2         8          1         71%
    2026-02-10       5        22          4         68%
    ...
    ```

    Right-align numeric columns. Pad columns for readability.

    **JSON output (--json):** Array of daily objects.

    **Edge cases:**
    - No reviews in period: print "No reviews found for {repo} in the last {days} days" and exit 0
    - Database does not exist: print error and exit 1

    IMPORTANT: Self-contained, no src/ imports.
  </action>
  <verify>
    ```bash
    bunx tsc --noEmit scripts/kodiai-trends.ts
    bun scripts/kodiai-trends.ts --help
    ```
    TypeScript compiles. Help text displays without errors.
  </verify>
  <done>
    `bun scripts/kodiai-trends.ts --repo=owner/name` outputs daily trend data. `--json` flag outputs JSON. `--days` controls window. Script is self-contained with no src/ imports.
  </done>
</task>

</tasks>

<verification>
```bash
bunx tsc --noEmit scripts/kodiai-stats.ts scripts/kodiai-trends.ts
bun scripts/kodiai-stats.ts --help
bun scripts/kodiai-trends.ts --help
```
Both scripts compile and display help without errors.
</verification>

<success_criteria>
- kodiai-stats.ts shows review statistics for a repo with severity breakdown and top files
- kodiai-trends.ts shows daily trend data with review counts, findings, suppressions, confidence
- Both scripts support --json, --repo, --db flags
- Both scripts open the database in read-only mode
- Both scripts handle missing database and empty results gracefully
- Neither script imports from src/ (self-contained)
</success_criteria>

<output>
After completion, create `.planning/phases/28-knowledge-store-explicit-learning/28-04-SUMMARY.md`
</output>
