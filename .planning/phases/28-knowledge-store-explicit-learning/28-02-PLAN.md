---
phase: 28-knowledge-store-explicit-learning
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/knowledge/confidence.ts
  - src/knowledge/confidence.test.ts
autonomous: true

must_haves:
  truths:
    - "User can define suppression patterns as simple strings, glob prefixed, or regex prefixed in .kodiai.yml"
    - "Suppression patterns support optional severity, category, and paths metadata"
    - "User can set minConfidence threshold (0-100) in .kodiai.yml review config"
    - "Confidence score is computed from deterministic heuristic signals, not Claude self-assessment"
    - "Invalid regex patterns in suppressions fail gracefully at config parse time"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Extended reviewSchema with suppressions array and minConfidence field"
      contains: "suppressions"
    - path: "src/knowledge/confidence.ts"
      provides: "computeConfidence pure function and matchesSuppression matching function"
      exports: ["computeConfidence", "matchesSuppression", "matchPattern"]
    - path: "src/knowledge/confidence.test.ts"
      provides: "Tests for confidence scoring and suppression matching"
      min_lines: 100
  key_links:
    - from: "src/knowledge/confidence.ts"
      to: "picomatch"
      via: "glob matching for suppression path filters"
      pattern: "import.*picomatch"
    - from: "src/execution/config.ts"
      to: "zod"
      via: "schema validation for suppressions and minConfidence"
      pattern: "suppressions.*z\\."
---

<objective>
Add suppression pattern config schema and confidence scoring engine. These are the two configuration and computation primitives that the handler and prompt will consume.

Purpose: Users need to configure what findings to suppress (LEARN-02) and what confidence threshold to apply (LEARN-03). The confidence engine computes scores from deterministic signals per the locked decision.

Output: Extended config schema with `review.suppressions` and `review.minConfidence`, plus `computeConfidence()` and `matchesSuppression()` pure functions with tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-knowledge-store-explicit-learning/28-RESEARCH.md
@src/execution/config.ts
@src/execution/config.test.ts
</context>

<feature>
  <name>Suppression Config and Confidence Scoring</name>
  <files>src/execution/config.ts, src/execution/config.test.ts, src/knowledge/confidence.ts, src/knowledge/confidence.test.ts</files>
  <behavior>
    **Config schema extension (config.ts):**
    Add to reviewSchema inside the z.object():

    ```
    suppressions: z.array(
      z.union([
        z.string().min(1),
        z.object({
          pattern: z.string().min(1),
          severity: z.array(z.enum(["critical", "major", "medium", "minor"])).optional(),
          category: z.array(z.enum(["security", "correctness", "performance", "style", "documentation"])).optional(),
          paths: z.array(z.string()).optional(),
        })
      ])
    ).default([]),
    minConfidence: z.number().min(0).max(100).default(0),
    ```

    Add to the reviewSchema .default() block: `suppressions: [], minConfidence: 0`
    Add to the section-level fallback config assembly in loadRepoConfig.

    Cases:
    - `suppressions: ["missing JSDoc"]` => parses as array of strings
    - `suppressions: [{pattern: "glob:*test*", severity: [minor]}]` => parses as object with metadata
    - `suppressions: [{pattern: "regex:missing.*handling", paths: ["**/*test*"]}]` => parses with paths
    - `minConfidence: 40` => parses as number
    - `minConfidence: 150` => rejected by schema (max 100)
    - Missing suppressions/minConfidence => defaults to []/0
    - Invalid review section with valid suppressions => section fallback applies, suppressions get defaults

    **Confidence scoring (confidence.ts):**
    Pure function `computeConfidence(input: ConfidenceInput): number`

    ConfidenceInput = { severity: "critical"|"major"|"medium"|"minor", category: "security"|"correctness"|"performance"|"style"|"documentation", matchesKnownPattern: boolean }

    Formula (from RESEARCH.md discretion recommendation):
    - base = 50
    - severity boost: critical +30, major +20, medium +10, minor +0
    - category boost: security +15, correctness +10, performance +5, style -5, documentation -10
    - pattern match boost: +10 if matchesKnownPattern
    - clamp to 0-100

    Cases:
    - computeConfidence({severity: "critical", category: "security", matchesKnownPattern: true}) => 100 (capped)
    - computeConfidence({severity: "major", category: "correctness", matchesKnownPattern: false}) => 80
    - computeConfidence({severity: "minor", category: "style", matchesKnownPattern: false}) => 45
    - computeConfidence({severity: "minor", category: "documentation", matchesKnownPattern: false}) => 40

    **Suppression matching (confidence.ts):**
    `matchPattern(pattern: string, text: string): boolean` -- three modes:
    - `glob:` prefix => picomatch match against text
    - `regex:` prefix => RegExp test (case-insensitive), invalid regex returns false
    - No prefix => case-insensitive substring match

    `matchesSuppression(finding, suppression): boolean` -- checks pattern match, then optional severity/category/path filters (all must pass if present). Uses picomatch for path matching with `{ dot: true }`.

    Cases:
    - matchPattern("missing error handling", "Missing Error Handling in auth") => true (substring, case-insensitive)
    - matchPattern("glob:*unused*", "unused import detected") => true
    - matchPattern("regex:missing.*handling", "missing null handling") => true
    - matchPattern("regex:[invalid", "anything") => false (bad regex)
    - matchesSuppression with severity filter that does not match => false
    - matchesSuppression with paths filter => only matches files in those paths
  </behavior>
  <implementation>
    Follow TDD RED-GREEN-REFACTOR.

    RED phase:
    1. Add failing config tests in config.test.ts for suppressions parsing (string array, object array, mixed, defaults, invalid fallback) and minConfidence (valid, out-of-range, default).
    2. Create confidence.test.ts with failing tests for computeConfidence (all severity/category combos, clamping, pattern boost) and matchPattern (substring, glob, regex, invalid regex) and matchesSuppression (full match, severity filter, category filter, path filter, combined filters).

    GREEN phase:
    1. Extend reviewSchema in config.ts with suppressions and minConfidence. Update the .default() block. Update the section-level fallback assembly (review section already has safeParse fallback, so new fields get defaults automatically).
    2. Create confidence.ts with computeConfidence, matchPattern, matchesSuppression. Import picomatch for glob/path matching.

    REFACTOR: Clean up type exports, ensure all tests pass.

    IMPORTANT:
    - Do NOT modify review-prompt.ts or review.ts in this plan (that is Plan 03).
    - Suppress ReDoS risk: in matchPattern regex mode, wrap new RegExp() in try/catch. For config-time validation, the Zod schema accepts any string (validation happens at match time). Keep it simple -- the RESEARCH.md suggests config-time validation but the locked decisions do not require it. Just fail gracefully at match time.
  </implementation>
</feature>

<verification>
```bash
bun test src/execution/config.test.ts
bun test src/knowledge/confidence.test.ts
bunx tsc --noEmit
```
All tests pass. No TypeScript errors.
</verification>

<success_criteria>
- `review.suppressions` accepts string[], object[], or mixed arrays in .kodiai.yml
- `review.minConfidence` accepts 0-100 with default 0
- Section-level fallback handles invalid review section gracefully
- computeConfidence returns deterministic scores matching the formula
- matchPattern handles all three syntax modes (substring, glob:, regex:)
- matchesSuppression applies optional filters correctly
- Invalid regex patterns fail silently (return false)
</success_criteria>

<output>
After completion, create `.planning/phases/28-knowledge-store-explicit-learning/28-02-SUMMARY.md`
</output>
