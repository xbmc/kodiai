---
phase: 29-feedback-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge/types.ts
  - src/knowledge/store.ts
  - src/knowledge/store.test.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "Each persisted finding from Kodiai PR review comments has deterministic comment linkage (comment id/surface/output key)"
    - "Thumbs-up and thumbs-down feedback can be stored per repo with finding context and without duplicates across retries"
    - "Feedback persistence remains additive and non-fatal, with no automatic changes to live review behavior"
  artifacts:
    - path: "src/knowledge/store.ts"
      provides: "Knowledge DB schema and write/query methods for finding comment linkage and append-only feedback reactions"
      contains: "feedback_reactions"
    - path: "src/knowledge/types.ts"
      provides: "Typed contracts for finding linkage and feedback reaction persistence"
      contains: "FeedbackReaction"
    - path: "src/handlers/review.ts"
      provides: "Review runtime persistence that writes deterministic linkage fields for each extracted finding"
      contains: "recordFindings"
    - path: "src/knowledge/store.test.ts"
      provides: "Schema/idempotency coverage for feedback reactions and linkage fields"
      contains: "UNIQUE"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/knowledge/store.ts"
      via: "recordFindings payload includes comment_id/comment_surface/review_output_key"
      pattern: "recordFindings"
    - from: "src/knowledge/store.ts"
      to: "SQLite findings and feedback_reactions tables"
      via: "INSERT/INSERT OR IGNORE with foreign-key-backed finding correlation"
      pattern: "feedback_reactions|INSERT OR IGNORE"
---

<objective>
Add the storage and correlation foundation for LEARN-05 so reaction feedback can be tied back to exact Kodiai findings deterministically.

Purpose: Phase 29 needs durable finding-to-comment linkage and append-only feedback storage before any sync job can capture thumbs reactions reliably.

Output: Knowledge store schema/types and review persistence wiring updated to support deterministic correlation and idempotent feedback writes.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-feedback-capture/29-RESEARCH.md
@.planning/phases/28-knowledge-store-explicit-learning/28-07-SUMMARY.md
@src/knowledge/types.ts
@src/knowledge/store.ts
@src/knowledge/store.test.ts
@src/handlers/review.ts
@src/handlers/review.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend knowledge store schema and contracts for feedback capture</name>
  <files>src/knowledge/types.ts, src/knowledge/store.ts</files>
  <action>
    Extend the existing knowledge-store model with deterministic finding-comment linkage and append-only feedback persistence.

    Requirements:
    - Add linkage fields to persisted findings: `commentId`, `commentSurface`, and `reviewOutputKey` (stored as columns in `findings`).
    - Add `feedback_reactions` table for captured reactions with required correlation/context fields: `repo`, `review_id`, `finding_id`, `comment_id`, `comment_surface`, `reaction_id`, `reaction_content`, `reactor_login`, `reacted_at`, and copied finding context (`severity`, `category`, `file_path`, `title`).
    - Enforce DB-level dedupe using `UNIQUE(repo, comment_id, reaction_id)` and `INSERT OR IGNORE` semantics to stay idempotent under retries/redelivery.
    - Add typed interfaces and store methods for: (1) recording feedback reactions, and (2) listing recently persisted finding-comment candidates for sync.
    - Keep all schema additions additive and backward-compatible; do not change existing review decision logic or suppression/confidence behavior.
  </action>
  <verify>`bun test src/knowledge/store.test.ts`</verify>
  <done>Knowledge store can persist linked findings and idempotent thumbs reaction events with deterministic FK-backed correlation data.</done>
</task>

<task type="auto">
  <name>Task 2: Persist deterministic finding-comment linkage in review flow</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
    Wire the new linkage fields into the existing extraction/persistence pipeline so every persisted finding has a durable pointer to its originating Kodiai review comment.

    Requirements:
    - Populate `commentId` from extracted inline review comment ids.
    - Persist `commentSurface` as a deterministic literal for this v0.4 scope (use PR review comment surface).
    - Persist `reviewOutputKey` for each finding to preserve marker-based traceability.
    - Keep writes non-fatal exactly as current phase decisions require (log and continue on knowledge-store failure).
    - Add targeted tests proving linkage fields are passed into `knowledgeStore.recordFindings(...)` for successful review runs.
  </action>
  <verify>`bun test src/handlers/review.test.ts`</verify>
  <done>Persisted findings now include deterministic comment linkage required for reaction-to-finding correlation.</done>
</task>

<task type="auto">
  <name>Task 3: Add store-level regression coverage for dedupe and linkage</name>
  <files>src/knowledge/store.test.ts</files>
  <action>
    Add regression tests covering the new schema and idempotency behavior.

    Requirements:
    - Verify new `findings` linkage columns are present and populated by `recordFindings` inserts.
    - Verify `feedback_reactions` accepts `+1`/`-1` events and stores copied finding context.
    - Verify duplicate inserts with the same `(repo, comment_id, reaction_id)` do not create extra rows.
    - Verify constraints still enforce correlation integrity (reaction rows reference valid finding/review rows).
  </action>
  <verify>`bun test src/knowledge/store.test.ts`</verify>
  <done>Tests lock in append-only, deduplicated feedback persistence and deterministic linkage guarantees.</done>
</task>

</tasks>

<verification>
```bash
bun test src/knowledge/store.test.ts src/handlers/review.test.ts
```

Validation target: findings rows include deterministic comment linkage and feedback reaction writes are idempotent and correlated to concrete finding rows.
</verification>

<success_criteria>
- LEARN-05 foundation exists: every review finding needed for correlation has durable comment identity data.
- Feedback schema supports per-repo append-only thumbs reaction capture with DB-level dedupe.
- New writes remain additive/non-fatal and do not alter review output behavior in v0.4.
</success_criteria>

<output>
After completion, create `.planning/phases/29-feedback-capture/29-01-SUMMARY.md`
</output>
