---
phase: 29-feedback-capture
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/handlers/feedback-sync.ts
  - src/handlers/feedback-sync.test.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "When users react with thumbs-up or thumbs-down on Kodiai review comments, those reactions are captured and linked to the originating finding"
    - "Feedback capture is per-repo, idempotent, and bounded so retries/webhook churn do not duplicate rows or block webhook handling"
    - "Captured feedback is stored for future analysis only and does not automatically change review behavior"
  artifacts:
    - path: "src/handlers/feedback-sync.ts"
      provides: "Idempotent reaction sync pipeline over known Kodiai review comment ids"
      contains: "listForPullRequestReviewComment"
    - path: "src/handlers/feedback-sync.test.ts"
      provides: "Coverage for thumbs filtering, dedupe-safe writes, and non-fatal failure behavior"
      contains: "+1"
    - path: "src/index.ts"
      provides: "Registration of feedback sync handler in existing router/job queue pipeline"
      contains: "createFeedbackSyncHandler"
  key_links:
    - from: "src/handlers/feedback-sync.ts"
      to: "octokit.rest.reactions.listForPullRequestReviewComment"
      via: "bounded sync of reactions for persisted comment-linked findings"
      pattern: "listForPullRequestReviewComment"
    - from: "src/handlers/feedback-sync.ts"
      to: "src/knowledge/store.ts"
      via: "recordFeedbackReactions with INSERT OR IGNORE dedupe contract"
      pattern: "recordFeedback"
---

<objective>
Implement LEARN-05 capture behavior by syncing thumbs reactions from Kodiai review comments into the knowledge store using the existing event/job pipeline.

Purpose: Reaction webhook events are not available in the current event model, so phase success requires an idempotent bounded sync strategy triggered from supported webhook traffic.

Output: Feedback sync handler, routing/wiring, and tests that capture thumbs reactions per-repo with deterministic finding correlation.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-feedback-capture/29-RESEARCH.md
@.planning/phases/29-feedback-capture/29-01-SUMMARY.md
@src/index.ts
@src/webhook/router.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build bounded idempotent feedback reaction sync handler</name>
  <files>src/handlers/feedback-sync.ts</files>
  <action>
    Create a dedicated feedback sync handler that reuses existing job queue + GitHub App auth patterns.

    Requirements:
    - Register handler against supported trigger events (no new webhook event types): use existing traffic as sync opportunities.
    - Query recent finding-comment candidates from knowledge store (from 29-01 method) and bound work per run (recency window and/or max candidates).
    - For each candidate review comment, call `octokit.rest.reactions.listForPullRequestReviewComment` and capture only `+1` and `-1` reactions.
    - Ignore bot/app self reactions so corpus reflects human feedback.
    - Persist reactions through knowledge store idempotent insert path; keep all API/store failures non-fatal with warn-level logs.
    - Do not modify review severity filtering, suppression behavior, or prompt/runtime decision logic.
  </action>
  <verify>`bun test src/handlers/feedback-sync.test.ts`</verify>
  <done>Feedback sync can repeatedly ingest thumbs reactions from Kodiai review comments without duplicate writes or review-flow breakage.</done>
</task>

<task type="auto">
  <name>Task 2: Wire feedback sync into application bootstrap and router lifecycle</name>
  <files>src/index.ts</files>
  <action>
    Register the new feedback sync handler during app initialization using the same dependency style as review/mention handlers.

    Requirements:
    - Wire `eventRouter`, `jobQueue`, `githubApp`, `knowledgeStore`, and `logger` into `createFeedbackSyncHandler(...)`.
    - Ensure handler safely no-ops when `knowledgeStore` is unavailable.
    - Keep webhook response behavior unchanged (fire-and-fork dispatch remains non-blocking).
  </action>
  <verify>`bun test src/handlers/feedback-sync.test.ts`</verify>
  <done>Feedback capture is live in normal runtime startup and participates in existing asynchronous dispatch patterns.</done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for thumbs capture, dedupe, and non-fatal failures</name>
  <files>src/handlers/feedback-sync.test.ts</files>
  <action>
    Add focused tests proving LEARN-05 behavior and critical safeguards.

    Requirements:
    - Assert `+1` and `-1` reactions produce store writes correlated to finding ids.
    - Assert non-thumb reactions are ignored.
    - Assert repeat sync passes do not create duplicates (idempotency preserved through store API contract).
    - Assert GitHub API errors and store write errors are logged and do not throw through webhook dispatch path.
    - Assert no code path mutates review mode/output behavior based on captured feedback.
  </action>
  <verify>`bun test src/handlers/feedback-sync.test.ts`</verify>
  <done>Automated tests prove feedback ingestion correctness, bounded resilience, and v0.4 non-adaptive behavior constraints.</done>
</task>

</tasks>

<verification>
```bash
bun test src/handlers/feedback-sync.test.ts src/knowledge/store.test.ts
```

Validation target: thumbs reactions on Kodiai review comments are captured per-repo, correlated to findings, deduplicated across reruns, and stored only for future analysis.
</verification>

<success_criteria>
- LEARN-05 is met in runtime behavior: thumbs-up/down reactions on Kodiai review comments are captured and linked to finding records.
- Feedback capture remains non-fatal, bounded, and idempotent under repeated event-driven sync.
- v0.4 contract is preserved: captured feedback does not automatically alter review output behavior.
</success_criteria>

<output>
After completion, create `.planning/phases/29-feedback-capture/29-02-SUMMARY.md`
</output>
