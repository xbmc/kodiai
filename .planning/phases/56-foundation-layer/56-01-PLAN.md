---
phase: 56-foundation-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge/types.ts
  - src/knowledge/store.ts
  - src/knowledge/store.test.ts
  - src/handlers/dep-bump-merge-history.ts
  - src/handlers/dep-bump-merge-history.test.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "When a dependency bump PR is merged, a merge-history row is recorded in the knowledge DB"
    - "Non-dependency PR merges do not create merge-history rows"
    - "Recording is fail-open: GitHub API/enrichment errors never block webhook processing"
    - "Schema migration is additive-only (new table + indexes only)"
  artifacts:
    - path: "src/knowledge/store.ts"
      provides: "SQLite schema + insert API for dependency bump merge history"
      contains: "dep_bump_merge_history"
    - path: "src/knowledge/types.ts"
      provides: "KnowledgeStore method + record type for dep bump merge history"
      contains: "recordDepBumpMergeHistory"
    - path: "src/handlers/dep-bump-merge-history.ts"
      provides: "pull_request.closed handler that records dep bump merge history (no comments, no executor)"
      contains: "pull_request.closed"
  key_links:
    - from: "src/handlers/dep-bump-merge-history.ts"
      to: "src/knowledge/store.ts"
      via: "knowledgeStore.recordDepBumpMergeHistory(...)"
      pattern: "recordDepBumpMergeHistory\("
    - from: "src/index.ts"
      to: "src/handlers/dep-bump-merge-history.ts"
      via: "handler registration"
      pattern: "createDepBumpMergeHistoryHandler\("
---

<objective>
Add an additive knowledge-store table and a dedicated merge event handler so Kodiai can record dependency bump merge history for later trend analysis (DEP-05).

Purpose: Phase 56 requires persistence of dependency bump outcomes after merge, without triggering reviews or posting any comments.
Output: A new `dep_bump_merge_history` table + insert API in the knowledge store, and a `pull_request.closed` handler that records merged dep bump PRs.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-foundation-layer/56-RESEARCH.md
@src/knowledge/store.ts
@src/knowledge/types.ts
@src/lib/dep-bump-detector.ts
@src/lib/dep-bump-enrichment.ts
@src/lib/merge-confidence.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dep bump merge history table + insert API</name>
  <files>src/knowledge/store.ts, src/knowledge/types.ts, src/knowledge/store.test.ts</files>
  <action>
Add a new additive-only table in the knowledge store and a typed insert method.

- In `src/knowledge/store.ts`, create the table using `CREATE TABLE IF NOT EXISTS dep_bump_merge_history (...)` (NO changes to existing tables/columns):
  - Required columns:
    - `id INTEGER PRIMARY KEY AUTOINCREMENT`
    - `created_at TEXT NOT NULL DEFAULT (datetime('now'))`
    - `repo TEXT NOT NULL`
    - `pr_number INTEGER NOT NULL`
    - `merged_at TEXT` (nullable; populate from GitHub payload when available)
    - `delivery_id TEXT` (nullable)
    - `source TEXT` (dependabot|renovate|unknown)
    - `signals_json TEXT` (JSON array string; nullable)
    - `package_name TEXT` (nullable)
    - `old_version TEXT` (nullable)
    - `new_version TEXT` (nullable)
    - `semver_bump_type TEXT` (major|minor|patch|unknown; nullable)
    - `merge_confidence_level TEXT` (high|medium|low; nullable)
    - `merge_confidence_rationale_json TEXT` (JSON array string; nullable)
    - `advisory_status TEXT` (none|present|unknown; nullable)
    - `advisory_max_severity TEXT` (critical|high|medium|low|unknown; nullable)
    - `is_security_bump INTEGER` (0/1; nullable)
  - Add idempotency guard: `UNIQUE(repo, pr_number)`.
  - Add lightweight indexes for later trend queries:
    - `CREATE INDEX IF NOT EXISTS idx_dep_bump_merge_repo_created ON dep_bump_merge_history(repo, created_at)`
    - `CREATE INDEX IF NOT EXISTS idx_dep_bump_merge_repo_pkg ON dep_bump_merge_history(repo, package_name)`

- Add a prepared insert statement using the existing `bun:sqlite` `$param` style.
  - Use `INSERT OR IGNORE` so webhook redeliveries do not duplicate rows.

- In `src/knowledge/types.ts`, add:
  - `DepBumpMergeHistoryRecord` type mirroring the insertable fields.
  - `KnowledgeStore.recordDepBumpMergeHistory(entry: DepBumpMergeHistoryRecord): void`.

- In `src/knowledge/store.test.ts`, add a test that:
  - Calls `recordDepBumpMergeHistory()` with a representative row.
  - Verifies it persisted via a readonly `Database` query.
  - Calls it a second time with the same `(repo, pr_number)` and verifies row count remains 1 (idempotent).

Keep schema additive-only: no ALTER/DROP/RENAME of existing tables.
  </action>
  <verify>bun test src/knowledge/store.test.ts</verify>
  <done>
`dep_bump_merge_history` exists in the knowledge DB, and `recordDepBumpMergeHistory()` inserts exactly one row per (repo, pr_number) even under redelivery.
  </done>
</task>

<task type="auto">
  <name>Task 2: Record merged dep bump PRs on pull_request.closed</name>
  <files>src/handlers/dep-bump-merge-history.ts, src/handlers/dep-bump-merge-history.test.ts, src/index.ts</files>
  <action>
Implement and register a dedicated handler for `pull_request.closed` that records merge history ONLY when the PR was merged.

- Create `src/handlers/dep-bump-merge-history.ts` exporting `createDepBumpMergeHistoryHandler({ eventRouter, jobQueue, githubApp, knowledgeStore, logger })`.
- Register `eventRouter.register("pull_request.closed", handler)`.
- In the handler:
  - Return early unless `pull_request.merged === true`.
  - Enqueue work via `jobQueue.enqueue(installationId, async () => { ... })` so webhook handling stays fast.
  - Inside the job, detect dep bump via `detectDepBump({ prTitle, prLabels, headBranch, senderLogin })`.
  - If not a dep bump, return (no DB writes).
  - Build details/classification using existing utilities:
    - Best-effort changed files for ecosystem resolution:
      - Try to fetch changed files list via GitHub API (e.g. `pulls.listFiles`) and pass the filenames into `extractDepBumpDetails({ ..., changedFiles })`.
      - Fail-open: if list-files fails, log warn and pass `changedFiles: []`.
    - `extractDepBumpDetails({ detection, prTitle, prBody, changedFiles, headBranch })`
    - `classifyDepBump({ oldVersion, newVersion })`
  - Best-effort enrichment (FAIL-OPEN, time-bounded):
    - If `details.packageName` and `details.ecosystem` exist, call `fetchSecurityAdvisories(...)` and `fetchChangelog(...)` with `Promise.allSettled`.
    - Compute `advisory_status` as:
      - `present` if securityContext?.advisories.length > 0
      - `none` if securityContext?.advisories.length === 0
      - `unknown` if securityContext is null/undefined
    - Compute merge confidence via `computeMergeConfidence(depBumpCtx)` and store `level` + `rationale` JSON.
  - Call `knowledgeStore.recordDepBumpMergeHistory({ ... })` with:
    - repo, pr_number, delivery_id (event.id), merged_at (pull_request.merged_at), detection source/signals
    - package/version fields, semver_bump_type
    - advisory + merge confidence fields

- Update `src/index.ts` to call `createDepBumpMergeHistoryHandler(...)` alongside other handler registrations.

 - Add `src/handlers/dep-bump-merge-history.test.ts` (minimal unit test; no network calls):
   - Create a fake `eventRouter` whose `register(name, handler)` captures the registered handler for `pull_request.closed`.
   - Create a fake `jobQueue.enqueue(installationId, fn)` that immediately executes `await fn()`.
   - Create a fake `knowledgeStore.recordDepBumpMergeHistory(entry)` that pushes entries to an array.
   - Case 1 (merged dep bump):
     - Invoke the registered handler with a `pull_request.closed` event where `pull_request.merged === true`.
     - Ensure the mocked payload provides at least TWO dep-bump detection signals (since `detectDepBump(...)` requires 2+), e.g.:
       - Title: `"Bump lodash from 4.17.21 to 4.17.22"` AND sender login: `"dependabot[bot]"`,
       - OR title + head branch prefix like `"dependabot/npm_and_yarn/lodash-4.17.22"`,
       - OR title + label like `"dependencies"`.
     - Assert exactly one call/row recorded with the expected `repo`, `pr_number`, and `delivery_id`.
   - Case 2 (merged non-dep PR):
     - Invoke with `pull_request.merged === true` and a non-dep PR title (e.g. `"Fix docs"`).
     - Assert no rows recorded.
  - Keep the test independent from `src/index.ts` wiring (index wiring is verified separately via the `grep` check in this task's `<verify>` command).

Hard rules:
- Do NOT invoke the executor.
- Do NOT create or update GitHub comments/reviews.
  - Any GitHub API/enrichment failure logs warn and still returns (DEP-05 is best-effort).
  </action>
  <verify>bun test src/handlers/dep-bump-merge-history.test.ts && grep -n "createDepBumpMergeHistoryHandler(" src/index.ts</verify>
  <done>
Merged dependency bump PR events enqueue a lightweight job that records a single merge-history row without posting anything to GitHub.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes
- Manual spot-check (optional): trigger a merged Dependabot PR in a test repo and confirm a `dep_bump_merge_history` row exists in `./data/kodiai-knowledge.db`
</verification>

<success_criteria>
- Knowledge DB contains a durable, idempotent record of merged dependency bumps with semver class, merge confidence, and advisory status.
</success_criteria>

<output>
After completion, create `.planning/phases/56-foundation-layer/56-01-SUMMARY.md`
</output>
