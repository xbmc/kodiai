---
phase: 56-foundation-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/telemetry/types.ts
  - src/telemetry/store.ts
  - src/telemetry/store.test.ts
  - src/handlers/review.ts
  - src/handlers/review.test.ts
autonomous: true

must_haves:
  truths:
    - "After reviews that attempt retrieval, a retrieval quality row is written to the telemetry DB"
    - "Retrieval quality logging is fail-open and never blocks reviews"
    - "Distance metrics reflect the reranked (adjusted) distances, not raw distances"
    - "Schema migration is additive-only (new table + indexes only)"
  artifacts:
    - path: "src/telemetry/store.ts"
      provides: "SQLite schema + insert API for retrieval quality telemetry"
      contains: "retrieval_quality"
    - path: "src/telemetry/types.ts"
      provides: "TelemetryStore extended with recordRetrievalQuality"
      contains: "recordRetrievalQuality"
    - path: "src/handlers/review.ts"
      provides: "Computes retrieval quality metrics from rerankByLanguage() output and records telemetry"
      contains: "languageMatchRatio"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/telemetry/store.ts"
      via: "telemetryStore.recordRetrievalQuality(...)"
      pattern: "recordRetrievalQuality\("
---

<objective>
Extend the telemetry SQLite store and wire retrieval-quality logging after retrieval context generation (RET-05).

Purpose: Phase 56 needs low-risk observability for retrieval behavior to support later adaptive thresholds and tuning.
Output: New telemetry table + insert API, and review handler wiring that records result count, avg adjusted distance, threshold used, and language match ratio.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/56-foundation-layer/56-RESEARCH.md
@src/telemetry/store.ts
@src/telemetry/types.ts
@src/handlers/review.ts
@src/learning/retrieval-rerank.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retrieval quality table + TelemetryStore write API</name>
  <files>src/telemetry/store.ts, src/telemetry/types.ts, src/telemetry/store.test.ts</files>
  <action>
Add a new additive-only telemetry table and a write method.

- In `src/telemetry/store.ts`:
  - Create a new table `retrieval_quality` (NO changes to existing tables/columns):
    - `id INTEGER PRIMARY KEY AUTOINCREMENT`
    - `created_at TEXT NOT NULL DEFAULT (datetime('now'))`
    - `delivery_id TEXT` (nullable)
    - `repo TEXT NOT NULL`
    - `pr_number INTEGER`
    - `event_type TEXT NOT NULL`
    - `top_k INTEGER` (nullable)
    - `distance_threshold REAL` (nullable)
    - `result_count INTEGER NOT NULL`
    - `avg_distance REAL` (nullable)  // store adjustedDistance mean
    - `language_match_ratio REAL` (nullable)
  - Add an index for joins/lookup:
    - Partial unique index to avoid duplicates on webhook redelivery:
      `CREATE UNIQUE INDEX IF NOT EXISTS idx_retrieval_quality_delivery ON retrieval_quality(delivery_id) WHERE delivery_id IS NOT NULL`
    - `CREATE INDEX IF NOT EXISTS idx_retrieval_quality_repo_created ON retrieval_quality(repo, created_at)`
  - Add a prepared insert statement and method `recordRetrievalQuality(entry)`.
    - Use `INSERT OR IGNORE` (or equivalent `ON CONFLICT DO NOTHING`) so webhook redeliveries with the same `delivery_id` do not throw and do not create duplicates.
  - Keep write behavior fail-open at call sites (store method stays synchronous like `record`).
  - Ensure WAL checkpointing still works for total write volume: increment the shared write counter for BOTH `record()` and `recordRetrievalQuality()` so checkpoint runs roughly every 1000 writes across all telemetry tables.

- In `src/telemetry/types.ts`:
  - Add `RetrievalQualityRecord` type with fields matching the insert.
  - Extend `TelemetryStore` with `recordRetrievalQuality(entry: RetrievalQualityRecord): void`.

- In `src/telemetry/store.test.ts`:
  - Add a test that inserts a retrieval quality row and verifies it via a readonly `Database` query.
  - Add a duplicate insert with same `delivery_id` and verify only one row exists (idempotent).

Schema must be additive-only: create new table + indexes only.
  </action>
  <verify>bun test src/telemetry/store.test.ts</verify>
  <done>
Telemetry DB supports `recordRetrievalQuality()` and persists one row per `delivery_id` with correct numeric fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire retrieval quality logging in review handler</name>
  <files>src/handlers/review.ts, src/handlers/review.test.ts</files>
  <action>
Record retrieval quality telemetry immediately after retrieval context generation.

- In `src/handlers/review.ts`, inside the existing "Retrieval context (LEARN-07)" block:
  - After `rerankByLanguage()` returns (or after deciding there are 0 results), compute:
    - `resultCount`
    - `avgDistance` computed from reranked `adjustedDistance` (null when resultCount=0)
    - `languageMatchRatio` (null when resultCount=0)
    - `thresholdUsed` from `config.knowledge.retrieval.distanceThreshold`
    - `topK` from `config.knowledge.retrieval.topK`
  - Write telemetry via `telemetryStore.recordRetrievalQuality({ deliveryId: event.id, repo, prNumber, eventType: event.name, topK, distanceThreshold: thresholdUsed, resultCount, avgDistance, languageMatchRatio })`.
  - Preserve telemetry opt-out: only attempt the write when `config.telemetry.enabled === true` (use the same gating behavior as existing `telemetryStore.record(...)` usage; do not introduce a new opt-out flag).
  - Guard it so it only runs when retrieval was attempted (i.e., retrieval feature enabled and embed generation succeeded), and it MUST be fail-open:
     - Wrap in try/catch; `logger.warn` on error; never throw.

- In `src/handlers/review.test.ts`:
  - Update `noopTelemetryStore` to include `recordRetrievalQuality: () => {}` so existing tests do not crash.
  - Add a focused test case that stubs `embeddingProvider.generate()` and `isolationLayer.retrieveWithIsolation()` to return two results, then asserts `recordRetrievalQuality` was called with:
     - `resultCount: 2`
     - `avgDistance` close to expected reranked adjusted mean
     - `languageMatchRatio` = matches/2
     - `distanceThreshold` equals config default (0.3 unless overridden in test)
  - Add a focused opt-out test case that sets `config.telemetry.enabled = false` while still exercising the retrieval path (stubs return results), and asserts `recordRetrievalQuality` was NOT called.

Use adjusted distances from reranked results (avoid the pitfall of using raw retrieval distances).
  </action>
  <verify>bun test src/handlers/review.test.ts</verify>
  <done>
When retrieval is attempted during a review, a retrieval quality telemetry row is recorded without affecting review correctness or latency-sensitive paths.
  </done>
</task>

</tasks>

<verification>
- `bun test` passes
- (Optional) run a retrieval-enabled review and confirm `retrieval_quality` rows in `./data/kodiai-telemetry.db`
</verification>

<success_criteria>
- Telemetry DB contains retrieval-quality rows joinable by `delivery_id` with correct metrics derived from reranked results.
</success_criteria>

<output>
After completion, create `.planning/phases/56-foundation-layer/56-02-SUMMARY.md`
</output>
