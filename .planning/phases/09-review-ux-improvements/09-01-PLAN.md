---
phase: 09-review-ux-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/execution/mention-prompt.ts
  - src/lib/formatting.ts
  - src/lib/formatting.test.ts
autonomous: true

must_haves:
  truths:
    - "When a user @mentions kodiai, the trigger comment receives an eyes emoji reaction within seconds"
    - "Bot responses longer than 500 characters are wrapped in <details> tags with a summary line"
    - "Short responses (under 500 characters) are NOT wrapped in <details> tags"
    - "Content already wrapped in <details> is not double-wrapped"
    - "A failed reaction API call does not block mention processing"
  artifacts:
    - path: "src/lib/formatting.ts"
      provides: "wrapInDetails() utility function"
      exports: ["wrapInDetails"]
    - path: "src/lib/formatting.test.ts"
      provides: "Unit tests for formatting utilities"
    - path: "src/handlers/mention.ts"
      provides: "Eyes reaction on trigger comment before tracking comment"
    - path: "src/execution/mention-prompt.ts"
      provides: "Prompt instruction telling Claude to wrap long responses in <details>"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "octokit.rest.reactions"
      via: "createForIssueComment or createForPullRequestReviewComment"
      pattern: "reactions\\.createFor"
    - from: "src/lib/formatting.ts"
      to: "src/handlers/mention.ts"
      via: "import for error comment wrapping"
      pattern: "wrapInDetails"
---

<objective>
Add eyes emoji reactions on mention trigger comments and automatic `<details>` collapsing for long responses.

Purpose: Provide immediate visual feedback when @kodiai is triggered (UX-02) and reduce noise from long responses by collapsing them (UX-03).
Output: Updated mention handler with reaction logic, formatting utility with wrapInDetails(), updated mention prompt with collapse instructions.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-review-ux-improvements/09-RESEARCH.md
@src/handlers/mention.ts
@src/handlers/mention-types.ts
@src/execution/mention-prompt.ts
@src/lib/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatting utility and add eyes reaction to mention handler</name>
  <files>
    src/lib/formatting.ts
    src/lib/formatting.test.ts
    src/handlers/mention.ts
  </files>
  <action>
**1. Create `src/lib/formatting.ts`:**

Export a `wrapInDetails()` function:

```typescript
const COLLAPSE_THRESHOLD = 500;

export function wrapInDetails(body: string, summaryText?: string): string {
  if (body.length <= COLLAPSE_THRESHOLD) return body;
  if (body.trimStart().startsWith("<details>")) return body; // Already wrapped

  const summary = summaryText ?? `Kodiai response (${body.length} characters)`;
  return `<details>\n<summary>${summary}</summary>\n\n${body}\n\n</details>`;
}
```

Key rules:
- Threshold is 500 characters (matching success criteria)
- Check for existing `<details>` to prevent double-wrapping
- Blank lines required after `<summary>` and before `</details>` for GitHub markdown rendering

**2. Create `src/lib/formatting.test.ts`:**

Test cases:
- Short body (under 500 chars) returns unchanged
- Long body (over 500 chars) gets wrapped in `<details>` tags
- Body already starting with `<details>` is NOT double-wrapped
- Custom summary text is used when provided
- Default summary includes character count
- Body of exactly 500 chars is NOT wrapped (threshold is "less than or equal")
- Body of 501 chars IS wrapped

**3. Add eyes emoji reaction to `src/handlers/mention.ts`:**

In the `handleMention` function, BEFORE the tracking comment is posted (before the existing `// Post tracking comment BEFORE enqueue` block), add:

```typescript
// Add eyes reaction to trigger comment for immediate visual acknowledgment
try {
  const reactionOctokit = await githubApp.getInstallationOctokit(event.installationId);
  if (mention.surface === "pr_review_comment") {
    await reactionOctokit.rest.reactions.createForPullRequestReviewComment({
      owner: mention.owner,
      repo: mention.repo,
      comment_id: mention.commentId,
      content: "eyes",
    });
  } else if (mention.surface === "pr_review_body") {
    // PR review bodies don't support reactions -- skip silently
    // (the review ID is not a comment ID, so the reaction endpoints would 404)
  } else {
    // issue_comment and pr_comment both use the issue comment reaction endpoint
    await reactionOctokit.rest.reactions.createForIssueComment({
      owner: mention.owner,
      repo: mention.repo,
      comment_id: mention.commentId,
      content: "eyes",
    });
  }
} catch (err) {
  // Non-fatal: don't block processing if reaction fails
  logger.warn({ err, surface: mention.surface }, "Failed to add eyes reaction");
}
```

Critical details:
- Place BEFORE tracking comment (lines 91-104 in current file) for maximum speed
- `pr_review_comment` uses `createForPullRequestReviewComment` (different endpoint than issue comments -- Pitfall 1 from research)
- `pr_review_body` is SKIPPED entirely because the review ID is not a comment ID (Pitfall 2 from research)
- `issue_comment` and `pr_comment` both use `createForIssueComment`
- Entire block wrapped in try/catch -- reaction failure must NEVER block processing
  </action>
  <verify>
Run `bun test src/lib/formatting.test.ts` -- all tests pass.
Verify `src/handlers/mention.ts` compiles: `bun build --no-bundle src/handlers/mention.ts --outdir /tmp/check`.
  </verify>
  <done>
wrapInDetails() correctly wraps long bodies, skips short ones, prevents double-wrapping. Eyes reaction code is in mention handler before tracking comment, with correct endpoint selection per surface and fire-and-forget error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add <details> wrapping instructions to mention prompt and error comments</name>
  <files>
    src/execution/mention-prompt.ts
    src/handlers/mention.ts
  </files>
  <action>
**1. Update `src/execution/mention-prompt.ts` -- add `<details>` wrapping instruction to `buildMentionPrompt()`:**

In the "How to respond" section (after the existing formatting guidelines around line 117-123), add these lines:

```typescript
lines.push(
  "- If your response is longer than 500 characters, wrap the ENTIRE response body in `<details>` tags:",
  "  ```",
  "  <details>",
  '  <summary>Click to expand response</summary>',
  "  ",
  "  Your response content here...",
  "  ",
  "  </details>",
  "  ```",
  "- Important: include a blank line after `<summary>` and before `</details>` for proper markdown rendering",
  "- Short responses (under 500 characters) should NOT be wrapped",
);
```

Place this AFTER the existing bullet points about response formatting (after the "When listing items" line) and BEFORE the custom instructions section.

**2. Update error comment wrapping in `src/handlers/mention.ts`:**

Import `wrapInDetails` from `../lib/formatting.ts` at the top of the file:
```typescript
import { wrapInDetails } from "../lib/formatting.ts";
```

In the two places where `formatErrorComment` is called (the execution error block around line 215 and the catch block around line 237), wrap the result in `wrapInDetails()`:

For both error paths, change:
```typescript
const errorBody = formatErrorComment(category, detail);
```
to:
```typescript
const errorBody = wrapInDetails(formatErrorComment(category, detail), "Kodiai encountered an error");
```

This ensures even error messages respect the collapse threshold (most error messages are short and won't be wrapped, but long stack traces or detailed API errors will be collapsed).
  </action>
  <verify>
Run `bun build --no-bundle src/execution/mention-prompt.ts --outdir /tmp/check` -- compiles without errors.
Run `bun build --no-bundle src/handlers/mention.ts --outdir /tmp/check` -- compiles without errors.
Grep for "wrapInDetails" in mention.ts to confirm integration.
Grep for "details" in mention-prompt.ts to confirm prompt instruction.
  </verify>
  <done>
Mention prompt instructs Claude to wrap long responses in `<details>` tags. Error comments in mention handler use wrapInDetails() for consistency. Both compile cleanly.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/lib/formatting.test.ts` -- all formatting utility tests pass
2. `bun build --no-bundle src/handlers/mention.ts --outdir /tmp/check` -- compiles
3. `bun build --no-bundle src/execution/mention-prompt.ts --outdir /tmp/check` -- compiles
4. Eyes reaction code is placed BEFORE tracking comment in mention handler
5. Reaction endpoint selection correctly differentiates pr_review_comment from issue/pr comments
6. pr_review_body surface is explicitly skipped for reactions
7. wrapInDetails() imported and used in mention handler error paths
8. `<details>` wrapping instruction present in mention prompt
</verification>

<success_criteria>
- formatting.test.ts has tests for: short body passthrough, long body wrapping, double-wrap prevention, custom summary, default summary with char count, threshold boundary (500 vs 501)
- mention.ts adds eyes reaction before tracking comment with surface-based endpoint selection
- mention.ts uses wrapInDetails() on error comments
- mention-prompt.ts includes `<details>` wrapping instructions for Claude
- All files compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-review-ux-improvements/09-01-SUMMARY.md`
</output>
