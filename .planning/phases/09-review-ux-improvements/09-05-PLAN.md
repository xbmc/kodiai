---
phase: 09-review-ux-improvements
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Auto-review trigger behavior is configurable for opened, ready_for_review, and review_requested events"
    - "Review re-runs are triggered by pull_request.review_requested only (no pull_request.synchronize handler)"
    - "review_requested only runs when kodiai itself is the requested reviewer"
    - "No attempt is made to self-request kodiai as reviewer via requestReviewers API"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Action filtering and reviewer-target gating for re-request flows"
      contains: "pull_request.review_requested"
    - path: "src/execution/config.ts"
      provides: "Explicit trigger schema for opened/ready/re-request only"
      contains: "onReviewRequested"
    - path: "src/execution/config.test.ts"
      provides: "Config defaults and trigger parsing tests"
      contains: "review.triggers"
  key_links:
    - from: "src/handlers/review.ts"
      to: "payload.requested_reviewer"
      via: "guard: only run review_requested when requested reviewer matches app bot"
      pattern: "requested_reviewer"
    - from: "src/handlers/review.ts"
      to: "eventRouter.register"
      via: "only opened, ready_for_review, review_requested registrations"
      pattern: "eventRouter\.register"
---

<objective>
Implement review trigger configurability that supports initial PR events and explicit re-request flow only: run on `pull_request.opened`, `pull_request.ready_for_review`, and `pull_request.review_requested`, while explicitly not supporting `pull_request.synchronize` as an auto-review trigger.

Purpose: Users want predictable review timing (initial review + manual re-request) without noisy re-reviews on every push.
Output: Updated review handler logic and config validation/tests enforcing the allowed trigger set and reviewer targeting semantics.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/handlers/review.ts
@src/execution/config.ts
@src/execution/config.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tighten review trigger semantics in review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
  Update review handler behavior so trigger scope is explicit and predictable:

  1. Keep registration limited to:
     - `pull_request.opened`
     - `pull_request.ready_for_review`
     - `pull_request.review_requested`
     and do NOT register `pull_request.synchronize`.

  2. For `pull_request.review_requested`, add a guard so the handler only proceeds when the requested reviewer is kodiai itself (the app bot identity). If another reviewer/team is requested, log and skip.

  3. Remove the non-working self-request reviewer call (`pulls.requestReviewers`) so the handler no longer attempts to request `appSlug[bot]` via API.

  4. Update review handler comments/docstring to reflect the supported trigger model: initial review events + explicit re-request only.
  </action>
  <verify>
  Grep `src/handlers/review.ts` for `eventRouter.register(` -- only opened, ready_for_review, review_requested are present.
  Grep `src/handlers/review.ts` for `requestReviewers` -- not found.
  Grep `src/handlers/review.ts` for `requested_reviewer` -- found in review_requested gate logic.
  </verify>
  <done>
  Review handler runs on initial PR events and explicit re-request only.
  No synchronize-based auto-review path exists.
  Re-request events for other reviewers no longer trigger kodiai reviews.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce allowed trigger config shape and add regression tests</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
  Keep configurability clear and constrained to the supported trigger set:

  1. Ensure `review.triggers` schema supports exactly:
     - `onOpened`
     - `onReadyForReview`
     - `onReviewRequested`
     with defaults all `true`.

  2. Make trigger validation strict so unsupported keys (for example `onSynchronize`) fail validation with a clear `.kodiai.yml` error.

  3. Add/adjust tests to cover:
     - default trigger values remain true
     - custom trigger toggles parse correctly
     - unsupported trigger key (`onSynchronize`) is rejected
  </action>
  <verify>
  Run `bun test src/execution/config.test.ts` -- all tests pass.
  Test includes assertion that `onSynchronize` in `.kodiai.yml` throws `Invalid .kodiai.yml`.
  </verify>
  <done>
  Trigger config remains configurable for supported events only.
  Unsupported synchronize-style keys are rejected instead of silently ignored.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes
- `grep -n "eventRouter.register" src/handlers/review.ts` shows only opened, ready_for_review, review_requested
- `grep -n "requestReviewers" src/handlers/review.ts` returns no matches
- `grep -n "requested_reviewer" src/handlers/review.ts` shows re-request gate logic
- `bunx tsc --noEmit src/handlers/review.ts src/execution/config.ts src/execution/config.test.ts`
</verification>

<success_criteria>
- Auto-review triggers are configurable for initial PR events and explicit re-request only
- `pull_request.synchronize` is not wired as a review trigger
- `pull_request.review_requested` only triggers kodiai when kodiai is the requested reviewer
- Unsupported synchronize trigger config is rejected with a clear validation error
- Tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-review-ux-improvements/09-05-SUMMARY.md`
</output>
