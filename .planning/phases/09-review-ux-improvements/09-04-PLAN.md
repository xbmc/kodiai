---
phase: 09-review-ux-improvements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/review-prompt.ts
  - src/lib/formatting.ts
  - src/execution/mention-prompt.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PR auto-review does NOT post a summary comment when there are no actionable issues"
    - "When there ARE actionable issues, the summary comment is posted first and is always collapsed in <details> tags"
    - "All bot comments (tracking, responses, errors, summaries) are collapsed in <details> tags regardless of length"
    - "The tracking comment in mention handler is collapsed in <details> tags"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Conditional summary: only when issues found, always collapsed"
      contains: "ONLY post a summary comment if you found actionable issues"
    - path: "src/lib/formatting.ts"
      provides: "wrapInDetails always wraps (no threshold check)"
      contains: "export function wrapInDetails"
    - path: "src/execution/mention-prompt.ts"
      provides: "Updated prompt: always wrap responses in <details>, no length check"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "mcp__github_comment__create_comment"
      via: "prompt instruction for conditional summary"
      pattern: "create_comment"
    - from: "src/lib/formatting.ts"
      to: "src/handlers/mention.ts"
      via: "wrapInDetails import (no threshold)"
      pattern: "wrapInDetails"
---

<objective>
Close two UAT gaps: (1) the review prompt should only post a summary comment when there are actionable issues to report (no summary = no noise on clean PRs), and (2) ALL bot comments should be collapsed in `<details>` tags regardless of length for reduced noise.

Purpose: User reported that summary comments on clean PRs are just noise, and that ALL bot comments should be collapsed, not just long ones.
Output: Updated review-prompt.ts (conditional summary), updated formatting.ts (always wrap), updated mention-prompt.ts (always wrap instructions).
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-review-ux-improvements/09-01-SUMMARY.md
@.planning/phases/09-review-ux-improvements/09-02-SUMMARY.md
@src/execution/review-prompt.ts
@src/lib/formatting.ts
@src/lib/formatting.test.ts
@src/execution/mention-prompt.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove length threshold from wrapInDetails and update mention prompt</name>
  <files>src/lib/formatting.ts, src/lib/formatting.test.ts, src/execution/mention-prompt.ts, src/handlers/mention.ts</files>
  <action>
  Three changes to make ALL bot comments collapsed:

  1. **src/lib/formatting.ts** -- Remove the length threshold check. The function should ALWAYS wrap in `<details>` (except when already wrapped). Change wrapInDetails to:
     - Remove `const COLLAPSE_THRESHOLD = 500;`
     - Remove the `if (body.length <= COLLAPSE_THRESHOLD) return body;` line
     - Keep the double-wrap prevention: `if (body.trimStart().startsWith("<details>")) return body;`
     - Update the JSDoc comment to reflect "always wraps" behavior

  2. **src/lib/formatting.test.ts** -- Update tests to reflect new behavior:
     - The "returns body unchanged when under threshold" test should now expect the body to be WRAPPED (since threshold is removed)
     - The "returns body unchanged when exactly 500 chars" test should now expect the body to be WRAPPED
     - Keep the double-wrap prevention test as-is
     - Keep the custom summary test as-is
     - Add a test: empty string returns wrapped (or update to show wrapping)

  3. **src/execution/mention-prompt.ts** -- Update the response instructions (around lines 124-136) to tell Claude to ALWAYS wrap responses in `<details>` tags, not just when over 500 characters. Change the instruction from "If your response is longer than 500 characters" to "ALWAYS wrap your ENTIRE response body in `<details>` tags". Remove the "Short responses (under 500 characters) should NOT be wrapped" instruction.

  4. **src/handlers/mention.ts** -- Update the tracking comment (the `TRACKING_INITIAL` constant around line 27) to be wrapped in `<details>` tags:
     ```typescript
     const TRACKING_INITIAL = [
       "<details>",
       "<summary>Kodiai is thinking...</summary>",
       "",
       "_Working on your request. This comment will be updated with the response._",
       "",
       "</details>",
     ].join("\n");
     ```
  </action>
  <verify>
  Run `bun test src/lib/formatting.test.ts` -- all tests pass.
  Grep for `COLLAPSE_THRESHOLD` in formatting.ts -- NOT found (removed).
  Grep for "ALWAYS wrap" in mention-prompt.ts -- found.
  Grep for `<details>` in mention.ts tracking comment -- found.
  </verify>
  <done>
  wrapInDetails() always wraps content in `<details>` tags (no length threshold).
  Mention prompt instructs Claude to always wrap responses.
  Tracking comment is collapsed by default.
  All formatting tests pass with updated expectations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Change review prompt to only post summary when issues found</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
  Rewrite the "Summary comment" section (lines 99-130) and the "After review" section (lines 132-139) in review-prompt.ts:

  Replace the current "Summary comment" section with instructions that make the summary CONDITIONAL on finding issues:

  ```
  ## Summary comment

  ONLY post a summary comment if you found actionable issues to report as inline comments.

  If you found issues, FIRST post ONE summary comment using the `mcp__github_comment__create_comment` tool with issue number {prNumber}. ALWAYS wrap the summary in `<details>` tags:

  <details>
  <summary>Kodiai Review Summary</summary>

  **What changed:** [1-3 sentence description]

  **Issues found:** [count] issues
  - Brief list of each issue category

  </details>

  Then post your inline comments on the specific lines.

  If NO issues found: do NOT post any comment. The system handles approval automatically.
  ```

  Also update the "After review" section to match:

  ```
  ## After review

  If you found issues: post the summary comment (wrapped in <details>) first, then post inline comments.
  If NO issues found: do nothing -- no summary, no comments. The calling code handles silent approval.
  ```

  Remove the trivial PR detection instructions (fewer than 3 files, under 50 lines) -- they are no longer needed since the summary is only posted when issues exist.

  Remove the old 500-character threshold wrapping instruction for summaries -- ALL summaries are now wrapped unconditionally.

  Also update the Rules section: remove the line about "DO post exactly one summary comment" and replace with "ONLY post a summary comment when you have actionable inline issues to report".
  </action>
  <verify>
  Grep for "ONLY post a summary comment if" in review-prompt.ts -- found.
  Grep for "trivial" in review-prompt.ts -- NOT found (removed).
  Grep for "500 characters" in review-prompt.ts -- NOT found (removed).
  Grep for "do nothing" or "do NOT post" in review-prompt.ts -- found (for clean PRs).
  TypeScript compiles: `bunx tsc --noEmit src/execution/review-prompt.ts`
  </verify>
  <done>
  Review prompt only instructs Claude to post summary when actionable issues are found.
  Clean PRs produce zero bot comments (just APPROVE review from handler).
  Summary comments are always wrapped in `<details>` tags.
  Trivial PR detection removed (unnecessary when summary is conditional).
  </done>
</task>

</tasks>

<verification>
- `bun test src/lib/formatting.test.ts` passes
- `grep -rn "COLLAPSE_THRESHOLD" src/lib/formatting.ts` returns nothing
- `grep -n "ONLY post a summary" src/execution/review-prompt.ts` returns match
- `grep -n "ALWAYS wrap" src/execution/mention-prompt.ts` returns match
- `grep -n "<details>" src/handlers/mention.ts` returns match (tracking comment)
- All modified files compile without errors
</verification>

<success_criteria>
- Clean PRs produce NO summary comment (silence + APPROVE from handler)
- PRs with issues get a collapsed summary comment BEFORE inline comments
- All bot comments (tracking, response, error, summary) are wrapped in `<details>` tags
- No 500-character threshold logic remains in formatting.ts or prompts
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-review-ux-improvements/09-04-SUMMARY.md`
</output>
