---
phase: 09-review-ux-improvements
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When a PR is opened for review, the PR description receives an eyes emoji reaction within seconds"
    - "When no inline review issues are found, the bot submits an APPROVE review via the GitHub review API"
    - "autoApprove defaults to true so clean PRs are approved without config"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Eyes reaction on PR open + APPROVE review on clean PRs"
      contains: "reactions.createForIssue"
    - path: "src/execution/config.ts"
      provides: "autoApprove defaults to true"
      contains: "autoApprove: z.boolean().default(true)"
    - path: "src/execution/config.test.ts"
      provides: "Updated test for autoApprove default"
      contains: "expect(config.review.autoApprove).toBe(true)"
  key_links:
    - from: "src/handlers/review.ts"
      to: "octokit.rest.reactions.createForIssue"
      via: "fire-and-forget call before job enqueue"
      pattern: "reactions\\.createForIssue"
    - from: "src/handlers/review.ts"
      to: "octokit.rest.pulls.createReview"
      via: "APPROVE event after execution with no bot comments"
      pattern: 'event: "APPROVE"'
---

<objective>
Close two UAT gaps in the review handler: (1) add eyes emoji reaction to the PR description body when a PR is opened for review, and (2) change autoApprove to default to true so clean PRs receive an APPROVE review automatically.

Purpose: User reported that PRs should get eyes reaction like mentions do, and that the bot should approve clean PRs by default (not require explicit config).
Output: Updated review.ts with eyes reaction, updated config.ts with autoApprove defaulting to true.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-review-ux-improvements/09-01-SUMMARY.md
@.planning/phases/09-review-ux-improvements/09-02-SUMMARY.md
@src/handlers/review.ts
@src/execution/config.ts
@src/execution/config.test.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add eyes reaction on PR open and change autoApprove default to true</name>
  <files>src/handlers/review.ts, src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
  Three changes:

  1. **src/handlers/review.ts** -- Add eyes emoji reaction to the PR description (issue body) BEFORE the job is enqueued, using the same fire-and-forget pattern as mention.ts. Insert this block after the logging statement at line 86 ("Processing PR review") and before `await jobQueue.enqueue(...)`:

     ```typescript
     // Add eyes reaction to PR description for immediate acknowledgment
     try {
       const reactionOctokit = await githubApp.getInstallationOctokit(event.installationId);
       await reactionOctokit.rest.reactions.createForIssue({
         owner: apiOwner,
         repo: apiRepo,
         issue_number: pr.number,
         content: "eyes",
       });
     } catch (err) {
       // Non-fatal: don't block processing if reaction fails
       logger.warn({ err, prNumber: pr.number }, "Failed to add eyes reaction to PR");
     }
     ```

     Note: Use `reactions.createForIssue` (NOT `createForIssueComment`) because a PR description is an issue body, not a comment. The `issue_number` is the PR number.

  2. **src/execution/config.ts** -- Change the `autoApprove` default from `false` to `true` in two places:
     - Line 12: `autoApprove: z.boolean().default(true)`
     - Line 19 in the `.default({...})` object: `autoApprove: true`

  3. **src/execution/config.test.ts** -- Update the test expectations:
     - Line 14: Change `expect(config.review.autoApprove).toBe(false)` to `expect(config.review.autoApprove).toBe(true)`
     - Line 106: Change `expect(config.review.autoApprove).toBe(false)` to `expect(config.review.autoApprove).toBe(true)`
  </action>
  <verify>
  Run `bun test src/execution/config.test.ts` -- all tests pass.
  Grep for `createForIssue` in review.ts -- found.
  Grep for `autoApprove: z.boolean().default(true)` in config.ts -- found.
  </verify>
  <done>
  PR description gets eyes reaction on PR open/ready_for_review (fire-and-forget, non-blocking).
  autoApprove defaults to true so clean PRs get APPROVE review without requiring `.kodiai.yml` config.
  All existing config tests pass with updated expectations.
  </done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` passes (7 tests)
- `grep -n "createForIssue" src/handlers/review.ts` shows reaction call
- `grep -n "default(true)" src/execution/config.ts` shows autoApprove default
- TypeScript compiles: `bunx tsc --noEmit src/handlers/review.ts src/execution/config.ts`
</verification>

<success_criteria>
- Eyes emoji reaction fires on PR description before review job starts
- autoApprove defaults to true
- Clean PRs (no bot inline comments) receive APPROVE review
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09-review-ux-improvements/09-03-SUMMARY.md`
</output>
