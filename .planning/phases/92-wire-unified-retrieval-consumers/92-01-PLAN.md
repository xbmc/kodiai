---
phase: 92-wire-unified-retrieval-consumers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.ts
  - src/execution/mention-prompt.ts
autonomous: true
requirements: [KI-11, KI-12]

must_haves:
  truths:
    - "@mention responses include wiki citations with [wiki: Page Title] markers when wiki hits exist"
    - "@mention responses include review citations with [review: PR #123] markers when review hits exist"
    - "@mention responses silently fall back to code-only context when no wiki/review hits exist"
    - "Mention handler forwards unifiedResults and contextWindow from retriever to prompt builder"
  artifacts:
    - path: "src/handlers/mention.ts"
      provides: "Unified retrieval forwarding to mention prompt"
      contains: "unifiedResults"
    - path: "src/execution/mention-prompt.ts"
      provides: "Unified context formatting with source citations"
      contains: "formatUnifiedContext\\|unifiedResults\\|contextWindow"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/mention-prompt.ts"
      via: "unifiedResults and contextWindow params"
      pattern: "unifiedResults.*contextWindow"
    - from: "src/execution/mention-prompt.ts"
      to: "src/knowledge/cross-corpus-rrf.ts"
      via: "UnifiedRetrievalChunk type import"
      pattern: "UnifiedRetrievalChunk"
---

<objective>
Wire the mention handler to forward unified cross-corpus retrieval results to the mention prompt builder, and update mention-prompt.ts to format unified context with inline source citations.

Purpose: @mention responses currently only use legacy code findings. This plan wires the unified pipeline output (wiki + review + code) through to the mention prompt with [wiki: Name] and [review: PR #123] citation markers.
Output: mention.ts forwards unifiedResults/contextWindow; mention-prompt.ts renders attributed context.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/92-wire-unified-retrieval-consumers/92-CONTEXT.md
@.planning/phases/91-cross-corpus-retrieval-integration/91-04-SUMMARY.md
@src/handlers/mention.ts
@src/execution/mention-prompt.ts
@src/knowledge/retrieval.ts
@src/execution/review-prompt.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Forward unified retrieval results from mention handler to prompt builder</name>
  <files>src/handlers/mention.ts</files>
  <action>
In the mention handler's retrieval result processing block (around line 1194), after the existing `if (result && result.findings.length > 0)` block, add capture of unified cross-corpus results — mirroring the pattern already used in review.ts (lines 2023-2037):

1. After the retriever.retrieve() call (line 1183), declare variables for unified results:
   ```typescript
   let unifiedResultsForPrompt: import("../knowledge/cross-corpus-rrf.ts").UnifiedRetrievalChunk[] = [];
   let contextWindowForPrompt: string | undefined;
   let reviewPrecedentsForPrompt: import("../knowledge/review-comment-retrieval.ts").ReviewCommentMatch[] = [];
   let wikiKnowledgeForPrompt: import("../knowledge/wiki-retrieval.ts").WikiKnowledgeMatch[] = [];
   ```

2. After the retriever.retrieve() call, before the existing findings check, add:
   ```typescript
   if (result && result.unifiedResults && result.unifiedResults.length > 0) {
     unifiedResultsForPrompt = result.unifiedResults;
     contextWindowForPrompt = result.contextWindow;
   }
   if (result && result.reviewPrecedents.length > 0) {
     reviewPrecedentsForPrompt = result.reviewPrecedents;
   }
   if (result && result.wikiKnowledge.length > 0) {
     wikiKnowledgeForPrompt = result.wikiKnowledge;
   }
   ```

3. In the buildMentionPrompt() call further down, add the new parameters:
   ```typescript
   unifiedResults: unifiedResultsForPrompt.length > 0 ? unifiedResultsForPrompt : undefined,
   contextWindow: contextWindowForPrompt,
   reviewPrecedents: reviewPrecedentsForPrompt.length > 0 ? reviewPrecedentsForPrompt : undefined,
   wikiKnowledge: wikiKnowledgeForPrompt.length > 0 ? wikiKnowledgeForPrompt : undefined,
   ```

Per CONTEXT.md: silent fallback when retrieval returns no wiki/review hits — the conditional checks above handle this naturally.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify mention.ts now captures and forwards all unified retrieval fields</manual>
  </verify>
  <done>Mention handler captures unifiedResults, contextWindow, reviewPrecedents, and wikiKnowledge from retriever and passes them to buildMentionPrompt</done>
</task>

<task type="auto">
  <name>Task 2: Add unified context formatting to mention-prompt.ts with source citations</name>
  <files>src/execution/mention-prompt.ts</files>
  <action>
Update buildMentionPrompt to accept and render unified cross-corpus context with inline citations. Reference review-prompt.ts's formatUnifiedContext pattern.

1. Add new optional parameters to the buildMentionPrompt params type:
   ```typescript
   unifiedResults?: import("../knowledge/cross-corpus-rrf.ts").UnifiedRetrievalChunk[];
   contextWindow?: string;
   reviewPrecedents?: import("../knowledge/review-comment-retrieval.ts").ReviewCommentMatch[];
   wikiKnowledge?: import("../knowledge/wiki-retrieval.ts").WikiKnowledgeMatch[];
   ```

2. Import formatUnifiedContext from review-prompt.ts (or inline a mention-specific version). Check if review-prompt.ts exports formatUnifiedContext. If it does, import and reuse. If not, create a local version in mention-prompt.ts.

3. In the prompt assembly, AFTER any existing retrieval context section and BEFORE the response instructions:
   - If `contextWindow` is provided (unified pipeline active), render it as the primary context section. Use the pre-formatted contextWindow string which already contains source labels like `[code: file.ts]`, `[review: PR #123]`, `[wiki: Page Title]`.
   - If `contextWindow` is NOT provided but legacy `retrievalContext` is, fall back to existing behavior (backward compat).
   - Per CONTEXT.md decision: inject top-k relevant chunks into the mention prompt, not full context window or summaries. The contextWindow from the unified pipeline already handles this — it's token-budgeted.

4. Citation formatting per CONTEXT.md decisions:
   - Cite wiki as [wiki: Article Name]
   - Cite reviews as [review: PR #123]
   - These labels are already present in contextWindow from the unified pipeline's assembleContextWindow()

5. Add instruction to the LLM in the prompt: "When referencing information from the knowledge base, cite sources using the labels provided (e.g., [wiki: Page Title], [review: PR #123])."

6. Silent fallback: if no unified results AND no legacy findings, do NOT add an empty "Knowledge Base" section — answer from code context alone.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify mention-prompt.ts accepts unified params and renders context with citation instructions</manual>
  </verify>
  <done>buildMentionPrompt accepts unified context fields, renders contextWindow with source labels when available, falls back to legacy findings, and instructs LLM to cite sources</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors in mention.ts and mention-prompt.ts
- Existing mention tests pass: `bun test src/handlers/mention.test.ts`
- Grep confirms unifiedResults/contextWindow flow from mention.ts to mention-prompt.ts
</verification>

<success_criteria>
- mention.ts captures and forwards unifiedResults, contextWindow, reviewPrecedents, wikiKnowledge to prompt builder
- mention-prompt.ts renders unified context with source citation labels
- Silent fallback when no wiki/review hits — no empty sections in prompt
- Backward compatible with legacy retrieval context
- All existing mention tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/92-wire-unified-retrieval-consumers/92-01-SUMMARY.md`
</output>
