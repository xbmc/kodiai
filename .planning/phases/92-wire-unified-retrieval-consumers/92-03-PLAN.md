---
phase: 92-wire-unified-retrieval-consumers
plan: 03
type: execute
wave: 2
depends_on: [92-01, 92-02]
files_modified:
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [KI-11, KI-12, KI-13, KI-14]

must_haves:
  truths:
    - "KI-11 checkbox is checked after verifying wiki corpus is available via retrieval path"
    - "KI-12 checkbox is checked after verifying bot can answer with wiki citations"
    - "KI-13 checkbox is checked after verifying single retrieval call fans out to all corpora"
    - "KI-14 checkbox is checked after verifying hybrid search is operational with RRF"
    - "Success Criteria checkboxes for 'single retrieval call' and 'hybrid search' are checked"
    - "Each checkbox is verified against actual code before being checked"
  artifacts:
    - path: ".planning/REQUIREMENTS.md"
      provides: "Updated requirement checkboxes with all KI-11 through KI-14 checked"
      contains: "\\[x\\] \\*\\*KI-11\\*\\*"
  key_links:
    - from: ".planning/REQUIREMENTS.md"
      to: "src/knowledge/retrieval.ts"
      via: "verification that requirements are satisfied by code"
      pattern: "KI-1[1234]"
---

<objective>
Verify each pending requirement against actual code and update REQUIREMENTS.md checkboxes for KI-11 through KI-14 and the remaining success criteria.

Purpose: The audit found requirements KI-11 through KI-14 are satisfied by the Phase 91 + 92 work but checkboxes remain unchecked. Per CONTEXT.md, verify each requirement before checking — don't blindly trust the audit. Checkbox updates go in a separate commit from wiring code changes.
Output: REQUIREMENTS.md with all v0.18 checkboxes checked and a verification log.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/92-wire-unified-retrieval-consumers/92-CONTEXT.md
@.planning/phases/92-wire-unified-retrieval-consumers/92-01-SUMMARY.md
@.planning/phases/92-wire-unified-retrieval-consumers/92-02-SUMMARY.md
@src/knowledge/retrieval.ts
@src/handlers/mention.ts
@src/execution/mention-prompt.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and update REQUIREMENTS.md checkboxes</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
For each unchecked requirement, verify it is satisfied by examining actual code, then check the box.

**KI-11: Wiki corpus available via src/knowledge/retrieval.ts retrieval path**
- Verify: grep for wikiPageStore in retrieval.ts createRetriever deps and fan-out search
- Verify: wiki search results appear in RetrieveResult (wikiKnowledge field)
- If satisfied: change `- [ ] **KI-11**` to `- [x] **KI-11**`

**KI-12: Bot can answer architecture/feature questions with wiki citations and links**
- Verify: mention-prompt.ts accepts and renders wiki context with citations (from Plan 01)
- Verify: contextWindow includes [wiki: Page Title] labels from assembleContextWindow
- If satisfied: change `- [ ] **KI-12**` to `- [x] **KI-12**`

**KI-13: Single retrieval call fans out to code, review comments, and wiki simultaneously**
- Verify: retrieval.ts retrieve() function uses Promise.allSettled for parallel fan-out to all 3 corpora
- Verify: all three corpus results are combined into unifiedResults
- If satisfied: change `- [ ] **KI-13**` to `- [x] **KI-13**`

**KI-14: Hybrid search combining pgvector semantic similarity with PostgreSQL tsvector full-text search per corpus**
- Verify: retrieval.ts contains BM25 (searchByFullText) calls alongside vector searches
- Verify: memoryStore is wired in index.ts (from Plan 02) enabling code corpus BM25
- Verify: per-corpus hybrid merge happens via RRF before cross-corpus fusion
- If satisfied: change `- [ ] **KI-14**` to `- [x] **KI-14**`

**Success Criteria checkboxes:**
- "Single retrieval call fans out to all corpora with source attribution in responses" — verify and check
- "Hybrid search (BM25 + vector) operational with RRF merging across sources" — verify and check

**Traceability table:** Update KI-11 through KI-14 status from "Pending" to "Complete".

Per CONTEXT.md: If verification finds a requirement NOT satisfied, do NOT check the box — log the issue and leave unchecked. The plan will report GAPS FOUND.

Per CONTEXT.md: Include a verification summary documenting what was checked. Add a comment block at the bottom of REQUIREMENTS.md or in the commit message with the verification log.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && grep -c "\- \[ \]" .planning/REQUIREMENTS.md</automated>
    <manual>Verify zero unchecked boxes remain (count should be 0). All 19 requirements checked.</manual>
  </verify>
  <done>All KI-11 through KI-14 checkboxes checked after code-level verification. Success criteria checkboxes updated. Traceability table shows all Complete. Zero unchecked requirements remain.</done>
</task>

</tasks>

<verification>
- `grep -c "\- \[ \]" .planning/REQUIREMENTS.md` returns 0 (no unchecked boxes)
- All 19 KI requirements show [x] checked
- Both remaining success criteria show [x] checked
- Traceability table shows all "Complete"
</verification>

<success_criteria>
- Every unchecked checkbox verified against actual code before checking
- All v0.18 requirements (KI-01 through KI-19) are checked
- All success criteria are checked
- Traceability table fully updated
- Checkbox updates committed separately from code changes
</success_criteria>

<output>
After completion, create `.planning/phases/92-wire-unified-retrieval-consumers/92-03-SUMMARY.md`
</output>
