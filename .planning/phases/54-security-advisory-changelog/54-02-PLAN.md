---
phase: 54-security-advisory-changelog
plan: 02
type: execute
wave: 2
depends_on: ["54-01"]
files_modified:
  - src/handlers/review.ts
  - src/execution/review-prompt.ts
autonomous: true

must_haves:
  truths:
    - "Detected dep bumps trigger parallel advisory + changelog enrichment before prompt building"
    - "Enrichment results flow through DepBumpContext into the review prompt"
    - "Review prompt shows advisory severity and remediation info for vulnerable packages"
    - "Review prompt shows changelog/release notes between old and new versions"
    - "Review prompt shows breaking change warnings extracted from changelog"
    - "Enrichment failure does not block review (fail-open)"
    - "Group bumps skip enrichment entirely"
    - "Enrichment content is bounded by character budgets in the prompt"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Enrichment wiring after dep bump detection"
      contains: "fetchSecurityAdvisories"
    - path: "src/execution/review-prompt.ts"
      provides: "Extended buildDepBumpSection with security + changelog rendering"
      contains: "Security Advisories"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/lib/dep-bump-enrichment.ts"
      via: "import and call fetchSecurityAdvisories + fetchChangelog"
      pattern: "import.*dep-bump-enrichment"
    - from: "src/handlers/review.ts"
      to: "depBumpContext.security"
      via: "Promise.allSettled result assignment"
      pattern: "depBumpContext\\.security"
    - from: "src/execution/review-prompt.ts"
      to: "SecurityContext"
      via: "type import for rendering"
      pattern: "SecurityContext|ChangelogContext"
---

<objective>
Wire dep-bump enrichment into the review handler and extend the review prompt to render security advisory and changelog context.

Purpose: Connects the enrichment module (Plan 54-01) to the live review pipeline so users see CVE/advisory and changelog data in Kodiai reviews. Completes the end-to-end flow for all Phase 54 requirements.
Output: Updated review.ts with enrichment calls, updated review-prompt.ts with security + changelog prompt sections.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-security-advisory-changelog/54-RESEARCH.md
@.planning/phases/54-security-advisory-changelog/54-01-SUMMARY.md
@src/handlers/review.ts
@src/execution/review-prompt.ts
@src/lib/dep-bump-detector.ts
@src/lib/dep-bump-enrichment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire enrichment into review handler</name>
  <files>src/handlers/review.ts</files>
  <action>
    Add enrichment call after the existing dep bump detection block (around line 1409, after `depBumpContext = { detection, details, classification }`).

    Import `fetchSecurityAdvisories` and `fetchChangelog` from `../lib/dep-bump-enrichment.ts`.

    After `depBumpContext` is constructed, add enrichment block:
    ```
    // ── Dependency bump enrichment (SEC-01/02/03, CLOG-01/02/03) ──
    if (depBumpContext && depBumpContext.details.packageName && !depBumpContext.details.isGroup) {
      try {
        const [secResult, clogResult] = await Promise.allSettled([
          fetchSecurityAdvisories({
            packageName: depBumpContext.details.packageName,
            ecosystem: depBumpContext.details.ecosystem ?? "npm",
            oldVersion: depBumpContext.details.oldVersion,
            newVersion: depBumpContext.details.newVersion,
            octokit: octokit,  // use the existing octokit instance from the handler
            timeoutMs: 4000,
          }),
          fetchChangelog({
            packageName: depBumpContext.details.packageName,
            ecosystem: depBumpContext.details.ecosystem ?? "npm",
            oldVersion: depBumpContext.details.oldVersion,
            newVersion: depBumpContext.details.newVersion,
            octokit: octokit,
            timeoutMs: 4000,
          }),
        ]);
        depBumpContext.security = secResult.status === "fulfilled" ? secResult.value : null;
        depBumpContext.changelog = clogResult.status === "fulfilled" ? clogResult.value : null;

        logger.info({
          ...baseLog,
          gate: "dep-bump-enrich",
          hasAdvisories: (depBumpContext.security?.advisories?.length ?? 0) > 0,
          isSecurityBump: depBumpContext.security?.isSecurityBump ?? false,
          changelogSource: depBumpContext.changelog?.source ?? null,
          breakingChanges: depBumpContext.changelog?.breakingChanges?.length ?? 0,
        }, "Dep bump enrichment complete");
      } catch (err) {
        logger.warn({ ...baseLog, err, gate: "dep-bump-enrich" }, "Dep bump enrichment failed (fail-open)");
        // fail-open: depBumpContext.security and .changelog remain undefined
      }
    }
    ```

    **Verify the octokit variable name:** Check what variable name the existing handler uses for the octokit instance at that scope. The Phase 53 wiring used `octokit` from the handler's outer scope. Use the same instance -- no need to create a new one. Search for where `octokit` is defined/available in the review handler function scope.

    Place the enrichment AFTER detection but BEFORE `buildReviewPrompt` is called (the prompt builder already receives `depBumpContext` -- the new optional fields will flow through automatically).
  </action>
  <verify>
    `bun run typecheck` passes. The import resolves. The `depBumpContext.security` and `depBumpContext.changelog` fields are accepted by TypeScript (they are optional on the extended type from Plan 54-01).
  </verify>
  <done>
    Enrichment calls wired into review handler with parallel execution, fail-open error handling, and structured logging. Group bumps and non-dep-bump PRs are skipped.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend review prompt with security and changelog sections</name>
  <files>src/execution/review-prompt.ts</files>
  <action>
    Import `SecurityContext` and `ChangelogContext` types from `../lib/dep-bump-enrichment.ts`.

    Add two new helper functions and modify `buildDepBumpSection`:

    **1. Add character budget constants (near existing prompt constants):**
    ```
    const MAX_ADVISORY_SECTION_CHARS = 500;
    const MAX_CHANGELOG_SECTION_CHARS = 1500;
    ```

    **2. Add `truncateToCharBudget(text: string, maxChars: number): string` helper:**
    - If text.length <= maxChars, return as-is
    - Otherwise truncate at last newline before maxChars, append "\n...(truncated)"

    **3. Add `buildSecuritySection(security: SecurityContext): string`:**
    - If `security.isSecurityBump`:
      - Header: "### Security-Motivated Bump"
      - Note: "The old version has known advisories that the new version patches. This bump addresses security concerns."
    - Else if advisories.length > 0:
      - Header: "### Security Advisories (informational)"
      - Note: "The following advisories exist for this package. They may or may not affect your specific usage."
    - Else: return "" (no section if no advisories)
    - For each advisory (max 3):
      - `- **{ghsaId}** ({severity}): {summary}`
      - If cveId: `  CVE: {cveId}`
      - If firstPatchedVersion: `  Patched in: {firstPatchedVersion}`
      - `  Details: {url}`
    - Truncate total to MAX_ADVISORY_SECTION_CHARS
    - Frame as informational, NOT "vulnerability detected" (per project concerns in STATE.md)

    **4. Add `buildChangelogSection(changelog: ChangelogContext): string`:**
    - If source === "releases" and releaseNotes.length > 0:
      - Header: "### Release Notes"
      - For each release (truncate body to 500 chars): `**{tag}:**\n{body}`
    - If source === "changelog-file" and releaseNotes.length > 0:
      - Header: "### Changelog Excerpt"
      - Render releaseNotes bodies (truncated)
    - If breakingChanges.length > 0:
      - Subheader: "**Breaking Changes Detected:**"
      - Bullet list of breaking changes
    - If compareUrl:
      - `[View full diff](compareUrl)`
    - If source === "compare-url-only":
      - "No release notes or changelog found. [View full diff](compareUrl)"
    - Truncate total to MAX_CHANGELOG_SECTION_CHARS

    **5. Modify existing `buildDepBumpSection(ctx: DepBumpContext)` (around line 880):**
    - After the existing content (version info, bump type, review focus), append:
    - If `ctx.security`: append `buildSecuritySection(ctx.security)`
    - If `ctx.changelog`: append `buildChangelogSection(ctx.changelog)`
    - The existing section content remains unchanged -- security and changelog are additive

    **Important:** Do NOT change the function signature of `buildDepBumpSection` -- it already receives `DepBumpContext` which now includes the optional `security` and `changelog` fields from the type extension in Plan 54-01.
  </action>
  <verify>
    `bun run typecheck` passes. Manually inspect the output of `buildDepBumpSection` by adding a temporary test or logging. Verify:
    - With security context: advisory section renders with GHSA IDs, severity, and informational framing
    - With changelog context: release notes render with truncation
    - With breaking changes: breaking change markers surfaced
    - With neither: output matches existing Phase 53 behavior exactly (no regression)
    - Character budgets enforced (advisory section <= 500 chars, changelog section <= 1500 chars)
  </verify>
  <done>
    Review prompt includes security advisory section with severity/GHSA/CVE info and changelog section with release notes and breaking change warnings. Content is bounded by character budgets. Informational framing used for advisories. Existing dep bump section behavior preserved for PRs without enrichment data.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with no errors
- `bun test` passes all existing tests (no regressions)
- Review handler imports enrichment functions and calls them in parallel for non-group dep bumps
- Review prompt renders security section when advisories exist
- Review prompt renders changelog section when release notes exist
- Review prompt renders breaking change warnings when detected
- Character budgets prevent prompt bloat (advisory <= 500, changelog <= 1500 chars)
- Fail-open: enrichment errors logged but review proceeds with base dep bump context
- Group bumps: no enrichment attempted, existing behavior preserved
</verification>

<success_criteria>
- Enrichment wired into review.ts with Promise.allSettled parallel execution
- buildDepBumpSection renders security + changelog sections when enrichment data present
- Informational framing for advisories (not "vulnerability detected")
- Character budgets enforced on all enrichment content
- Zero regressions on existing dep bump or review functionality
- All type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/54-security-advisory-changelog/54-02-SUMMARY.md`
</output>
