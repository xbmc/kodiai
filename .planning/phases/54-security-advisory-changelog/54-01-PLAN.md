---
phase: 54-security-advisory-changelog
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/dep-bump-enrichment.ts
  - src/lib/dep-bump-enrichment.test.ts
  - src/lib/dep-bump-detector.ts
autonomous: true

must_haves:
  truths:
    - "Advisory lookup returns CVE/GHSA data for a known-vulnerable package+version"
    - "Security-motivated bumps are distinguished from routine bumps"
    - "Changelog fetches release notes between old and new versions"
    - "Breaking changes are extracted from release note content"
    - "Enrichment fails open -- null returned on any error"
    - "Group bumps are skipped (no enrichment attempted)"
    - "Changelog output is bounded to character budget"
  artifacts:
    - path: "src/lib/dep-bump-enrichment.ts"
      provides: "fetchSecurityAdvisories, fetchChangelog, resolveGitHubRepo, extractBreakingChanges"
      exports: ["fetchSecurityAdvisories", "fetchChangelog", "resolveGitHubRepo"]
    - path: "src/lib/dep-bump-enrichment.test.ts"
      provides: "Unit tests with mocked API responses for all enrichment functions"
      min_lines: 150
    - path: "src/lib/dep-bump-detector.ts"
      provides: "Extended DepBumpContext type with optional security and changelog fields"
      contains: "security?: SecurityContext"
  key_links:
    - from: "src/lib/dep-bump-enrichment.ts"
      to: "octokit.rest.securityAdvisories.listGlobalAdvisories"
      via: "advisory API call"
      pattern: "listGlobalAdvisories"
    - from: "src/lib/dep-bump-enrichment.ts"
      to: "octokit.rest.repos.listReleases"
      via: "releases API call"
      pattern: "listReleases"
    - from: "src/lib/dep-bump-enrichment.ts"
      to: "registry.npmjs.org"
      via: "fetch for repo resolution"
      pattern: "registry\\.npmjs\\.org"
---

<objective>
Create the dep-bump-enrichment module with security advisory lookup, changelog fetching, package-to-repo resolution, and breaking change detection using TDD.

Purpose: This module provides the core enrichment logic that Phase 54 success criteria depend on -- SEC-01/02/03 and CLOG-01/02/03. All functions are pure async with defined I/O, making them ideal TDD candidates.
Output: Fully tested `dep-bump-enrichment.ts` module plus extended `DepBumpContext` type.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/54-security-advisory-changelog/54-RESEARCH.md
@src/lib/dep-bump-detector.ts
</context>

<feature>
  <name>Dependency Bump Enrichment Module</name>
  <files>src/lib/dep-bump-enrichment.ts, src/lib/dep-bump-enrichment.test.ts, src/lib/dep-bump-detector.ts</files>
  <behavior>
    The enrichment module has four core capabilities:

    **1. Security Advisory Lookup (SEC-01, SEC-02, SEC-03)**

    `fetchSecurityAdvisories({ packageName, ecosystem, oldVersion, newVersion, octokit, timeoutMs })` returns `SecurityContext | null`:
    - Queries `octokit.rest.securityAdvisories.listGlobalAdvisories()` with `affects=packageName@version` and `ecosystem` filter
    - Queries BOTH old and new versions (two API calls in parallel via Promise.allSettled)
    - Maps ecosystem names from Phase 53 format to Advisory API format using explicit mapping:
      ```typescript
      const ECOSYSTEM_TO_ADVISORY: Record<string, string> = {
        npm: "npm", python: "pip", go: "go", rust: "rust",
        ruby: "rubygems", java: "maven", php: "composer",
        dotnet: "nuget", "github-actions": "actions",
      };
      ```
    - Returns `{ advisories: AdvisoryInfo[], isSecurityBump: boolean }`
    - `isSecurityBump = true` when old version has advisory(s) AND new version does NOT have the same advisory(s) (old GHSA IDs minus new GHSA IDs is non-empty)
    - Each advisory maps to: `{ ghsaId, cveId, severity, summary, vulnerableVersionRange, firstPatchedVersion, affectsOld, affectsNew, url }`
    - Filters to `type === "reviewed"` advisories only
    - Returns null on any error (fail-open)
    - Uses `AbortSignal.timeout(timeoutMs ?? 4000)` for timeout

    Cases:
    - lodash@4.17.20 (npm) with known CVE -> returns advisories with severity + isSecurityBump=true if upgrading past patch
    - unknown-package@1.0.0 -> returns { advisories: [], isSecurityBump: false }
    - API timeout -> returns null
    - Unknown ecosystem -> returns null (unmapped ecosystem)

    **2. Package-to-Repo Resolution (CLOG-01)**

    `resolveGitHubRepo({ packageName, ecosystem })` returns `RepoCoords | null`:
    - For npm: `GET https://registry.npmjs.org/{pkg}/latest` -> extract `repository.url` -> parse `github.com/owner/repo`
    - For python: `GET https://pypi.org/pypi/{pkg}/json` -> extract from `info.project_urls` (Source, Repository, Homepage) or `info.home_page`
    - For ruby: `GET https://rubygems.org/api/v1/gems/{pkg}.json` -> extract `source_code_uri`
    - Other ecosystems: return null (no resolution available in V1)
    - Handles scoped npm packages (e.g., `@scope/package`)
    - Uses `AbortSignal.timeout(3000)` per registry fetch
    - Returns null on any error

    Cases:
    - "express" (npm) -> { owner: "expressjs", repo: "express" }
    - "@octokit/rest" (npm) -> { owner: "octokit", repo: "rest.js" } (or similar)
    - "unknown-pkg" -> null (404 from registry)
    - "internal-pkg" (python, no GitHub URL in metadata) -> null

    **3. Changelog/Release Notes Fetching (CLOG-01, CLOG-02)**

    `fetchChangelog({ packageName, ecosystem, oldVersion, newVersion, octokit, timeoutMs })` returns `ChangelogContext | null`:
    - Step 1: Resolve package to GitHub repo via `resolveGitHubRepo`
    - Step 2 (Tier 1 - Releases): `octokit.rest.repos.listReleases()` up to 2 pages (60 releases), filter to releases where `oldVersion < tagVersion <= newVersion` using existing `parseSemver`. Try tag formats: `v{version}`, `{version}`, `{packageName}@{version}`
    - Step 3 (Tier 2 - CHANGELOG.md): If no releases found, try `octokit.rest.repos.getContent({ path: "CHANGELOG.md" })` and extract section between version headings using regex
    - Step 4 (Tier 3 - Compare URL): Always generate `github.com/owner/repo/compare/v{oldVersion}...v{newVersion}` as fallback
    - Extract breaking changes from release bodies using `extractBreakingChanges()`
    - Truncate individual release bodies to 500 chars
    - Total changelog section capped at 1500 chars
    - Returns `{ releaseNotes, breakingChanges, compareUrl, source }`
    - Returns null if repo resolution fails AND both versions are null

    Cases:
    - Package with GitHub Releases between versions -> source: "releases", releaseNotes populated, breakingChanges extracted
    - Package with no Releases but has CHANGELOG.md -> source: "changelog-file"
    - Package with neither -> source: "compare-url-only", compareUrl set
    - Repo resolution fails -> null (no repo to query)

    **4. Breaking Change Detection (CLOG-02)**

    `extractBreakingChanges(releaseNotes: Array<{ body: string }>)` returns `string[]`:
    - Scans release bodies for markers: `BREAKING CHANGE:`, `BREAKING CHANGES:`, `BREAKING`, `INCOMPATIBLE`, `## Breaking`, `**Breaking**`
    - Extracts the marker line + up to 2 following lines (max 200 chars per snippet)
    - Returns deduplicated breaking change snippets

    Cases:
    - Release body with "BREAKING CHANGE: removed X" -> ["BREAKING CHANGE: removed X"]
    - Release body with "## Breaking\n- Changed API" -> ["## Breaking\n- Changed API"]
    - Release body with no breaking markers -> []

    **5. Type Extension**

    Extend `DepBumpContext` in `dep-bump-detector.ts` with optional fields:
    ```typescript
    export type DepBumpContext = {
      detection: DepBumpDetection;
      details: DepBumpDetails;
      classification: DepBumpClassification;
      security?: SecurityContext | null;
      changelog?: ChangelogContext | null;
    };
    ```
    Export `SecurityContext`, `ChangelogContext`, `AdvisoryInfo`, `RepoCoords` from enrichment module.
  </behavior>
  <implementation>
    RED phase: Write tests with mocked octokit and fetch responses covering all cases above. Tests MUST fail initially.

    GREEN phase: Implement the module following the research patterns:
    - Use `@octokit/rest` for advisory and release APIs (already installed)
    - Use native `fetch` for registry metadata
    - Use `AbortSignal.timeout()` for all external calls
    - Use `parseSemver` from dep-bump-detector.ts for version comparison
    - Wrap every external call in try/catch returning null on failure
    - Add pino logger for structured logging of enrichment outcomes

    REFACTOR phase: Clean up, ensure consistent error handling, verify all exports.

    **Important implementation notes:**
    - Frame advisories as informational, NOT "vulnerability detected" (per project concerns)
    - Skip enrichment entirely for group bumps (isGroup: true) -- caller responsibility but document in JSDoc
    - Character budgets are constants: MAX_ADVISORY_CHARS = 500, MAX_CHANGELOG_CHARS = 1500, MAX_TOTAL_ENRICHMENT_CHARS = 2000
    - No caching in V1 (premature optimization per research recommendation)
    - For CHANGELOG.md parsing: split on version heading patterns (`## [version]`, `# version`, `## version`) and extract text between old and new version headings

    **Test mocking strategy:**
    - Mock octokit methods by passing a mock object with `.rest.securityAdvisories.listGlobalAdvisories()` and `.rest.repos.listReleases()` and `.rest.repos.getContent()`
    - Mock `fetch` globally for registry calls using `import { mock } from "bun:test"` or spyOn global fetch
    - Test timeout behavior with delayed promises
  </implementation>
</feature>

<verification>
- `bun test src/lib/dep-bump-enrichment.test.ts` passes all tests
- `bun run typecheck` passes (no type errors from DepBumpContext extension)
- Advisory function returns structured SecurityContext for mocked vulnerable package
- Changelog function returns ChangelogContext with release notes for mocked releases
- Breaking change extractor identifies BREAKING CHANGE markers correctly
- Repo resolution extracts owner/repo from mocked npm/pypi/rubygems responses
- All functions return null on simulated errors (fail-open verified)
- Ecosystem mapping converts Phase 53 names to Advisory API names correctly
</verification>

<success_criteria>
- fetchSecurityAdvisories returns advisories with severity, GHSA ID, CVE ID for vulnerable packages
- isSecurityBump correctly identifies when old version has advisory that new version patches
- fetchChangelog returns release notes with three-tier fallback (releases -> CHANGELOG.md -> compare URL)
- extractBreakingChanges finds BREAKING CHANGE markers in release bodies
- resolveGitHubRepo resolves npm, python, and ruby packages to GitHub owner/repo
- DepBumpContext type extended with optional security and changelog fields
- All enrichment functions fail open (return null on error)
- Character budgets enforced on changelog content
- All tests pass with mocked API responses
</success_criteria>

<output>
After completion, create `.planning/phases/54-security-advisory-changelog/54-01-SUMMARY.md`
</output>
