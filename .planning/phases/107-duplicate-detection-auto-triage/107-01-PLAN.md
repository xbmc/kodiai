---
phase: 107-duplicate-detection-auto-triage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/migrations/016-issue-triage-state.sql
  - src/execution/config.ts
  - src/triage/duplicate-detector.ts
  - src/triage/duplicate-detector.test.ts
  - src/triage/triage-comment.ts
  - src/triage/triage-comment.test.ts
autonomous: true
requirements:
  - DUPL-01
  - DUPL-02
  - DUPL-03
  - DUPL-04

must_haves:
  truths:
    - "Duplicate detection queries the issue corpus for vector-similar candidates above a configurable threshold"
    - "Top duplicate candidates are formatted as a compact markdown table with issue number, title, similarity percentage, and open/closed status"
    - "Duplicate detection never auto-closes issues -- it only produces a comment body and label name"
    - "If embedding generation or vector search fails, duplicate detection returns empty candidates (fail-open)"
    - "Closed candidates are sorted before open ones, and if all candidates are closed a note is appended"
    - "Config schema includes autoTriageOnOpen, duplicateThreshold, maxDuplicateCandidates, duplicateLabel, cooldownMinutes"
  artifacts:
    - path: "src/db/migrations/016-issue-triage-state.sql"
      provides: "Triage state table for idempotency tracking"
      contains: "issue_triage_state"
    - path: "src/execution/config.ts"
      provides: "Extended triageSchema with duplicate detection and auto-triage config fields"
      contains: "autoTriageOnOpen"
    - path: "src/triage/duplicate-detector.ts"
      provides: "findDuplicateCandidates function and DuplicateCandidate type"
      exports: ["findDuplicateCandidates", "DuplicateCandidate"]
    - path: "src/triage/triage-comment.ts"
      provides: "formatTriageComment and buildTriageMarker functions"
      exports: ["formatTriageComment", "buildTriageMarker", "TRIAGE_MARKER_PREFIX"]
  key_links:
    - from: "src/triage/duplicate-detector.ts"
      to: "src/knowledge/issue-store.ts"
      via: "IssueStore.searchByEmbedding()"
      pattern: "searchByEmbedding"
    - from: "src/triage/duplicate-detector.ts"
      to: "src/knowledge/embeddings.ts"
      via: "EmbeddingProvider.generate()"
      pattern: "embeddingProvider.generate"
    - from: "src/triage/duplicate-detector.ts"
      to: "src/knowledge/issue-comment-chunker.ts"
      via: "buildIssueEmbeddingText()"
      pattern: "buildIssueEmbeddingText"
---

<objective>
Create the duplicate detection foundation: DB migration for triage state tracking, config schema extension with new auto-triage fields, pure duplicate detection function, and triage comment formatter.

Purpose: Provide all the building blocks that the issue-opened handler (Plan 02) will wire together. By isolating pure logic here, Plan 02 focuses entirely on handler wiring and idempotency.

Output: Migration file, extended config schema, tested duplicate-detector module, tested triage-comment module.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/107-duplicate-detection-auto-triage/107-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/knowledge/issue-types.ts:
```typescript
export type IssueRecord = {
  id: number; createdAt: string; repo: string; owner: string;
  issueNumber: number; title: string; body: string | null; state: string;
  authorLogin: string; authorAssociation: string | null;
  labelNames: string[]; templateSlug: string | null; commentCount: number;
  assignees: Array<{ id: number; login: string }>; milestone: string | null;
  reactionCount: number; isPullRequest: boolean; locked: boolean;
  embedding: unknown; embeddingModel: string | null;
  githubCreatedAt: string; githubUpdatedAt: string | null; closedAt: string | null;
};

export type IssueSearchResult = {
  record: IssueRecord;
  distance: number;
};

export type IssueStore = {
  searchByEmbedding(params: {
    queryEmbedding: Float32Array; repo: string; topK: number;
  }): Promise<IssueSearchResult[]>;
  findSimilar(repo: string, issueNumber: number, threshold?: number): Promise<IssueSearchResult[]>;
  // ... other methods
};
```

From src/knowledge/types.ts:
```typescript
export type EmbeddingProvider = {
  generate(text: string, inputType: "document" | "query"): Promise<EmbeddingResult>;
  readonly model: string;
  readonly dimensions: number;
};
```

From src/knowledge/issue-comment-chunker.ts:
```typescript
export function buildIssueEmbeddingText(title: string, body: string | null): string;
```

From src/execution/config.ts (current triageSchema):
```typescript
const triageSchema = z.object({
  enabled: z.boolean().default(false),
  label: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
  comment: z.object({ enabled: z.boolean().default(true) }).default({ enabled: true }),
  labelAllowlist: z.array(z.string()).default([]),
  cooldownMinutes: z.number().min(0).max(1440).default(30),
}).default({ ... });
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DB migration and extend config schema</name>
  <files>src/db/migrations/016-issue-triage-state.sql, src/execution/config.ts</files>
  <action>
**Migration file** (`016-issue-triage-state.sql`):

Create the `issue_triage_state` table for atomic idempotency tracking:

```sql
CREATE TABLE IF NOT EXISTS issue_triage_state (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  repo TEXT NOT NULL,
  issue_number INTEGER NOT NULL,
  triaged_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  delivery_id TEXT NOT NULL,
  duplicate_count INTEGER NOT NULL DEFAULT 0,
  UNIQUE(repo, issue_number)
);

CREATE INDEX IF NOT EXISTS idx_issue_triage_state_repo
  ON issue_triage_state (repo, issue_number);
```

No down migration needed (additive only per project constraint).

**Config schema extension** (`src/execution/config.ts`):

Add three new fields to the existing `triageSchema`:

1. `autoTriageOnOpen: z.boolean().default(false)` -- gates auto-triage on `issues.opened` (TRIAGE-02). Default false = opt-in.
2. `duplicateThreshold: z.number().min(0).max(100).default(75)` -- similarity percentage cutoff. 75% = 0.25 cosine distance, the most permissive of the researched bands.
3. `maxDuplicateCandidates: z.number().min(1).max(10).default(3)` -- max candidates to show in comment.
4. `duplicateLabel: z.string().default("possible-duplicate")` -- label name to apply when candidates found. Lowercase, hyphenated per GitHub conventions.

Add these fields INSIDE the existing `triageSchema` z.object() -- do NOT create a new schema. Also update the `.default({})` block to include the new fields with their defaults.

Do NOT modify any other schema. Do NOT rename or restructure existing fields.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && cat src/db/migrations/016-issue-triage-state.sql | grep -q "issue_triage_state" && node -e "const z = require('zod'); console.log('schema ok')" 2>/dev/null; grep -q "autoTriageOnOpen" src/execution/config.ts && grep -q "duplicateThreshold" src/execution/config.ts && grep -q "duplicateLabel" src/execution/config.ts && echo "config fields present"</automated>
  </verify>
  <done>Migration file creates issue_triage_state table with UNIQUE(repo, issue_number) constraint. Config schema has autoTriageOnOpen (default false), duplicateThreshold (default 75), maxDuplicateCandidates (default 3), and duplicateLabel (default "possible-duplicate") fields. Existing config fields untouched.</done>
</task>

<task type="auto">
  <name>Task 2: Implement duplicate detector and triage comment formatter with tests</name>
  <files>src/triage/duplicate-detector.ts, src/triage/duplicate-detector.test.ts, src/triage/triage-comment.ts, src/triage/triage-comment.test.ts</files>
  <action>
**Duplicate detector** (`src/triage/duplicate-detector.ts`):

Create a pure async function `findDuplicateCandidates` and a `DuplicateCandidate` type:

```typescript
export type DuplicateCandidate = {
  issueNumber: number;
  title: string;
  state: string;
  similarityPct: number;
};
```

`findDuplicateCandidates` accepts:
- `issueStore: IssueStore`
- `embeddingProvider: EmbeddingProvider`
- `title: string`
- `body: string | null`
- `repo: string`
- `excludeIssueNumber: number` (the triggering issue, to filter from results)
- `threshold: number` (similarity percentage, e.g., 75)
- `maxCandidates: number` (e.g., 3)
- `logger: Logger`

Implementation:
1. Build embedding text using `buildIssueEmbeddingText(title, body)` from `src/knowledge/issue-comment-chunker.ts`
2. Call `embeddingProvider.generate(text, "query")` -- if result is null, log warning and return `[]` (fail-open, DUPL-04)
3. Call `issueStore.searchByEmbedding({ queryEmbedding, repo, topK: maxCandidates * 2 })` -- fetch extra to allow filtering
4. Filter out the triggering issue (`excludeIssueNumber`) from results (avoids self-matching per Pitfall 2/6 in RESEARCH.md)
5. Convert cosine distance to similarity percentage: `Math.round((1 - distance) * 100)`
6. Filter candidates where similarityPct >= threshold
7. Slice to maxCandidates
8. Map to `DuplicateCandidate` type
9. Wrap entire function in try/catch -- on any error, log warning and return `[]` (DUPL-04 fail-open)

This function NEVER calls any GitHub API. It NEVER closes issues (DUPL-03). It is pure detection logic.

**Triage comment formatter** (`src/triage/triage-comment.ts`):

Export three items:
1. `TRIAGE_MARKER_PREFIX = "kodiai:triage"` -- constant for the HTML comment marker
2. `buildTriageMarker(repo: string, issueNumber: number): string` -- returns `<!-- kodiai:triage:{repo}:{issueNumber} -->`
3. `formatTriageComment(candidates: DuplicateCandidate[], marker: string): string`

`formatTriageComment` implementation per locked CONTEXT.md decisions:
- Sort candidates: closed issues first, then by similarityPct descending
- Header line: `Possible duplicates detected:`
- Empty line
- Markdown table with columns: `| Issue | Title | Similarity | Status |`
- Each row: `| #N | title | NN% | open/closed |`
- If ALL candidates have state "closed", append a blank line then: `All matches are closed issues -- the problem may already be resolved.`
- Append blank line + the marker string (HTML comment for idempotency fallback)
- No branding, no footer (per locked decision)

**Tests** for duplicate detector (`src/triage/duplicate-detector.test.ts`):
- Returns empty array when embedding generation returns null (fail-open)
- Returns empty array when searchByEmbedding throws (fail-open)
- Filters out the triggering issue number from results
- Filters out candidates below threshold
- Respects maxCandidates limit
- Converts distance to similarity percentage correctly

**Tests** for triage comment (`src/triage/triage-comment.test.ts`):
- Formats table with mixed open/closed candidates, closed sorted first
- Appends "all closed" note when all candidates are closed
- Does not append note when mix of open and closed
- Includes marker in output
- buildTriageMarker produces correct HTML comment format
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/triage/duplicate-detector.test.ts src/triage/triage-comment.test.ts --timeout 30000</automated>
  </verify>
  <done>findDuplicateCandidates correctly embeds issue text, queries corpus, filters by threshold and excludes self, returns typed candidates. Fails open on embedding or search errors. formatTriageComment produces a compact markdown table with closed-first sorting, "all closed" note, and HTML marker. All tests pass.</done>
</task>

</tasks>

<verification>
1. Migration file exists at `src/db/migrations/016-issue-triage-state.sql` with `issue_triage_state` table and UNIQUE constraint
2. Config schema in `src/execution/config.ts` parses successfully with new fields and correct defaults
3. `findDuplicateCandidates` returns empty array on embedding failure (fail-open)
4. `findDuplicateCandidates` excludes the source issue from results
5. `formatTriageComment` produces locked-decision-compliant markdown table
6. All unit tests pass: `bun test src/triage/ --timeout 30000`
</verification>

<success_criteria>
- [ ] `016-issue-triage-state.sql` creates the table with UNIQUE(repo, issue_number)
- [ ] triageSchema includes autoTriageOnOpen, duplicateThreshold, maxDuplicateCandidates, duplicateLabel with correct defaults
- [ ] findDuplicateCandidates is fail-open (returns [] on any error)
- [ ] formatTriageComment matches locked comment format (compact table, closed-first, percentages only, no branding)
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/107-duplicate-detection-auto-triage/107-01-SUMMARY.md`
</output>
