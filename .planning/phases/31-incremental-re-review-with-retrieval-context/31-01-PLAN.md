---
phase: 31-incremental-re-review-with-retrieval-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/knowledge/types.ts
  - src/knowledge/store.ts
  - src/knowledge/store.test.ts
autonomous: true

must_haves:
  truths:
    - "Config schema accepts review.triggers.onSynchronize boolean (default false)"
    - "Config schema accepts knowledge.retrieval settings (enabled, topK, distanceThreshold, maxContextChars)"
    - "KnowledgeStore can return the head_sha of the most recent completed review for a given repo+PR"
    - "KnowledgeStore can return unsuppressed findings from the most recent completed review of a PR"
    - "Existing configs without new fields parse without errors (backward compatible)"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "onSynchronize trigger + retrieval sub-schema in knowledgeSchema"
      contains: "onSynchronize"
    - path: "src/knowledge/types.ts"
      provides: "getLastReviewedHeadSha and getPriorReviewFindings method signatures"
      contains: "getLastReviewedHeadSha"
    - path: "src/knowledge/store.ts"
      provides: "SQL queries and prepared statements for last reviewed SHA and prior findings"
      contains: "getLastReviewedHeadSha"
  key_links:
    - from: "src/knowledge/store.ts"
      to: "src/knowledge/types.ts"
      via: "KnowledgeStore type implements new methods"
      pattern: "getLastReviewedHeadSha|getPriorReviewFindings"
    - from: "src/execution/config.ts"
      to: "reviewTriggersSchema"
      via: "onSynchronize field in triggers"
      pattern: "onSynchronize.*default.*false"
---

<objective>
Add config schema extensions and KnowledgeStore query methods for incremental re-review.

Purpose: Phase 31 needs config support for the `pull_request.synchronize` trigger and retrieval tuning knobs, plus KnowledgeStore queries to look up the last reviewed head SHA and prior findings for a PR. These are the data-layer foundations that the review handler wiring (Plan 02/03) depends on.

Output: Extended config schema, two new KnowledgeStore methods with tests, all backward compatible.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-incremental-re-review-with-retrieval-context/31-RESEARCH.md
@src/execution/config.ts
@src/execution/config.test.ts
@src/knowledge/types.ts
@src/knowledge/store.ts
@src/knowledge/store.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config schema with onSynchronize trigger and retrieval settings</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
In `src/execution/config.ts`:

1. Add `onSynchronize: z.boolean().default(false)` to `reviewTriggersSchema`. Update the `.default({})` block to include `onSynchronize: false`. This is opt-in per research recommendation (frequent pushes could be expensive).

2. Add a `retrievalSchema` inside the knowledge section:
```
const retrievalSchema = z.object({
  enabled: z.boolean().default(true),
  topK: z.number().min(1).max(20).default(5),
  distanceThreshold: z.number().min(0).max(2).default(0.3),
  maxContextChars: z.number().min(0).max(5000).default(2000),
}).default({
  enabled: true,
  topK: 5,
  distanceThreshold: 0.3,
  maxContextChars: 2000,
});
```

3. Add `retrieval: retrievalSchema` to `knowledgeSchema` and update its `.default({})` block to include the retrieval defaults.

4. Update the section-fallback parsing in `loadRepoConfig` -- the knowledge section already falls back gracefully via `knowledgeSchema.safeParse`, so the new nested field is handled automatically.

In `src/execution/config.test.ts`:

Add 3 tests:
- "onSynchronize defaults to false and existing configs without it still parse"
- "retrieval section defaults are applied when omitted"
- "retrieval section custom values are honored"
  </action>
  <verify>Run `bun test src/execution/config.test.ts` -- all tests pass including the 3 new ones.</verify>
  <done>Config schema accepts `review.triggers.onSynchronize` (default false) and `knowledge.retrieval` (enabled, topK, distanceThreshold, maxContextChars with defaults). Existing .kodiai.yml files parse without changes.</done>
</task>

<task type="auto">
  <name>Task 2: Add getLastReviewedHeadSha and getPriorReviewFindings to KnowledgeStore</name>
  <files>src/knowledge/types.ts, src/knowledge/store.ts, src/knowledge/store.test.ts</files>
  <action>
In `src/knowledge/types.ts`:

1. Add a `PriorFinding` type:
```typescript
export type PriorFinding = {
  filePath: string;
  title: string;
  titleFingerprint: string;
  severity: FindingSeverity;
  category: FindingCategory;
  startLine: number | null;
  endLine: number | null;
  commentId: number | null;
};
```

2. Add two methods to the `KnowledgeStore` type:
```typescript
getLastReviewedHeadSha(params: { repo: string; prNumber: number }): string | null;
getPriorReviewFindings(params: { repo: string; prNumber: number; limit?: number }): PriorFinding[];
```

In `src/knowledge/store.ts`:

1. Add a prepared statement for `getLastReviewedHeadSha`:
```sql
SELECT head_sha
FROM run_state
WHERE repo = $repo
  AND pr_number = $prNumber
  AND status = 'completed'
ORDER BY created_at DESC
LIMIT 1
```

2. Add a prepared statement for `getPriorReviewFindings` -- joins findings -> reviews -> run_state to get findings from the most recent COMPLETED review of this PR. Only returns unsuppressed findings (suppressed = 0). Limit defaults to 100:
```sql
SELECT
  f.file_path, f.title, f.severity, f.category,
  f.start_line, f.end_line, f.comment_id
FROM findings f
INNER JOIN reviews r ON r.id = f.review_id
WHERE r.repo = $repo
  AND r.pr_number = $prNumber
  AND r.head_sha = (
    SELECT rs.head_sha FROM run_state rs
    WHERE rs.repo = $repo AND rs.pr_number = $prNumber AND rs.status = 'completed'
    ORDER BY rs.created_at DESC LIMIT 1
  )
  AND f.suppressed = 0
ORDER BY f.id ASC
LIMIT $limit
```

3. For each returned finding, compute `titleFingerprint` using the existing `fingerprintFindingTitle` function from `review.ts`. IMPORTANT: Do NOT import from review.ts (circular dependency risk). Instead, extract `fingerprintFindingTitle` into a new shared location OR duplicate the simple FNV-1a hash inline in store.ts as a private function. The function is 8 lines of pure computation with no dependencies -- duplication is cleaner than creating a shared module for this alone. Name it `_fingerprintTitle` to signal internal use.

4. Implement both methods on the store object, following the existing prepared-statement pattern.

In `src/knowledge/store.test.ts`:

Add 4 tests:
- "getLastReviewedHeadSha returns null when no completed review exists"
- "getLastReviewedHeadSha returns head_sha of most recent completed review"
- "getPriorReviewFindings returns unsuppressed findings from latest completed review"
- "getPriorReviewFindings returns empty array when no completed review exists"

Setup: Use the existing test pattern (`:memory:` DB). For SHA-related tests, record a review with a known head_sha, then call `checkAndClaimRun` + `completeRun` to set up the run_state, then record findings and verify retrieval.
  </action>
  <verify>Run `bun test src/knowledge/store.test.ts` -- all tests pass including the 4 new ones. Run `bun test` for full suite.</verify>
  <done>KnowledgeStore exposes `getLastReviewedHeadSha` returning the head SHA of the last completed review for a repo+PR (or null), and `getPriorReviewFindings` returning unsuppressed findings with title fingerprints from that review. All existing tests still pass.</done>
</task>

</tasks>

<verification>
- `bun test` passes with all existing + new tests
- `bun build src/index.ts --target=bun` compiles without type errors
- Config backward compatibility: existing .kodiai.yml without onSynchronize or retrieval parses cleanly
</verification>

<success_criteria>
- review.triggers.onSynchronize defaults to false, configurable to true
- knowledge.retrieval.enabled/topK/distanceThreshold/maxContextChars all have defaults and are configurable
- getLastReviewedHeadSha returns correct SHA or null based on run_state completion status
- getPriorReviewFindings returns findings from the latest completed review with title fingerprints
- All tests green, no type errors
</success_criteria>

<output>
After completion, create `.planning/phases/31-incremental-re-review-with-retrieval-context/31-01-SUMMARY.md`
</output>
