---
phase: 82-draft-pr-review-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/handlers/review.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/comment-server.test.ts
autonomous: true
requirements:
  - REV-01
  - REV-02

must_haves:
  truths:
    - "When a draft PR is opened, Kodiai posts a review instead of silently skipping"
    - "Draft PR reviews contain a visible 'Draft' indicator near the summary header"
    - "Draft PR review findings use suggestive language (Consider, You might want to) instead of firm language"
    - "When a draft PR is converted to ready_for_review, Kodiai re-reviews with full normal tone"
    - "Non-draft PR reviews are unchanged (no regressions)"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Draft PR review flow (skip removed, isDraft passed to prompt)"
      contains: "isDraft"
    - path: "src/execution/review-prompt.ts"
      provides: "Draft-aware prompt builder with tone adjustment"
      contains: "isDraft"
    - path: "src/execution/mcp/comment-server.ts"
      provides: "Comment validation accepting draft review summaries"
      contains: "Kodiai Draft Review Summary"
  key_links:
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "isDraft parameter in buildReviewPrompt call"
      pattern: "isDraft.*pr\\.draft"
    - from: "src/execution/review-prompt.ts"
      to: "src/execution/mcp/comment-server.ts"
      via: "Draft summary tag matching between prompt template and validation"
      pattern: "Kodiai Draft Review Summary"
---

<objective>
Enable Kodiai to review draft PRs with softer tone and visible draft indicator, and re-review with normal tone when converted to ready.

Purpose: Draft PRs currently get silently skipped, losing the opportunity for early feedback. This plan removes the skip, adds draft-aware tone adjustment to the review prompt, and ensures the comment-server validates draft review summaries.

Output: Draft PRs reviewed with "Draft" badge and suggestive language; ready_for_review triggers normal-tone re-review.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/handlers/review.ts
@src/execution/review-prompt.ts
@src/execution/mcp/comment-server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove draft skip, pass isDraft to prompt builder, add draft tone and badge</name>
  <files>
    src/handlers/review.ts
    src/execution/review-prompt.ts
    src/execution/mcp/comment-server.ts
  </files>
  <action>
**1. Remove the draft PR skip in `src/handlers/review.ts` (~line 1207-1214):**

Delete (or comment out) the block:
```typescript
// Skip draft PRs (the opened event fires for drafts too)
if (pr.draft) {
  logger.debug(baseLog, "Skipping draft PR");
  return;
}
```

Instead, determine `isDraft` from the payload and log it:
```typescript
const isDraft = Boolean(pr.draft);
if (isDraft) {
  logger.info({ ...baseLog, isDraft: true }, "Reviewing draft PR with draft tone");
}
```

**2. Pass `isDraft` to `buildReviewPrompt` (~line 2388):**

Add `isDraft` to the `buildReviewPrompt(...)` call alongside the existing parameters. Also pass it to the retry prompt call (~line 3364).

IMPORTANT: When `action === "ready_for_review"`, set `isDraft = false` regardless of `pr.draft` ‚Äî this event means the PR is no longer a draft, so the review should use full normal tone. Add a comment explaining this.

**3. Add `isDraft` parameter to `buildReviewPrompt` in `src/execution/review-prompt.ts`:**

Add `isDraft?: boolean;` to the context parameter type (~line 1165).

**4. Add draft framing to the standard summary template in `buildReviewPrompt`:**

In the standard (non-enhanced, non-delta) summary section (~line 1595-1667):

- When `context.isDraft` is true, change `<summary>Kodiai Review Summary</summary>` to `<summary>üìù Kodiai Draft Review Summary</summary>` (the üìù memo emoji serves as the draft badge per user decision for "Draft indicator near the summary header").

- After the `<summary>` line and before `## What Changed`, add a one-line draft framing:
  ```
  > **Draft** ‚Äî This PR is still in draft. Feedback is exploratory; findings use softer language.
  ```

- When `isDraft` is true, adjust the finding language instructions in the hard requirements section. Add these lines:
  ```
  "- This is a DRAFT review: use suggestive framing for all findings. Say 'Consider...' or 'You might want to...' instead of 'Should...' or 'Fix this' or 'Must...'",
  "- Prefix inline comment bodies with 'Consider: ' or 'You might want to: ' instead of imperative directives",
  ```

- When `isDraft` is false (or undefined), no changes ‚Äî the existing standard template is used as-is.

**5. Update comment-server validation in `src/execution/mcp/comment-server.ts`:**

In `sanitizeKodiaiReviewSummary` (~line 104-108), update the guard to also match the draft summary tag. Change:
```typescript
if (!body.includes("<summary>Kodiai Review Summary</summary>")) {
  return body;
}
```
to:
```typescript
const isReviewSummary = body.includes("<summary>Kodiai Review Summary</summary>");
const isDraftReviewSummary = body.includes("<summary>üìù Kodiai Draft Review Summary</summary>");
if (!isReviewSummary && !isDraftReviewSummary) {
  return body;
}
```

The rest of the validation (five-section template, section order) applies identically to both draft and non-draft reviews.

**6. Handle the `## What Changed` required-section check gracefully:**

The existing `requiredSections` array check in comment-server should work as-is since the draft review uses the same five-section template. No changes needed here ‚Äî just verify.
  </action>
  <verify>
    - `bun run build` compiles without errors
    - `grep -n "Skipping draft PR" src/handlers/review.ts` returns no matches (skip logic removed)
    - `grep -n "isDraft" src/handlers/review.ts src/execution/review-prompt.ts` shows the parameter threaded through
    - `grep -n "Draft Review Summary" src/execution/review-prompt.ts src/execution/mcp/comment-server.ts` shows draft tag in both files
  </verify>
  <done>
    Draft skip logic removed. isDraft flows from handler to prompt builder. Draft reviews get üìù badge, draft framing quote, and suggestive-language instructions. ready_for_review events force isDraft=false for normal tone. Comment-server validates both standard and draft summary tags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for draft PR review behavior</name>
  <files>
    src/handlers/review.test.ts
    src/execution/review-prompt.test.ts
    src/execution/mcp/comment-server.test.ts
  </files>
  <action>
**1. In `src/handlers/review.test.ts`, update or add tests:**

- Find existing tests that set `draft: false` in the PR payload. Add a new test (or test group) that sets `draft: true` and verifies:
  - The handler does NOT return early (i.e., the review proceeds ‚Äî the executor is called)
  - `isDraft: true` is passed through to the prompt builder

- Add a test for the `ready_for_review` action: when `action === "ready_for_review"`, verify `isDraft` is `false` even if `pr.draft` might still be truthy in the payload.

**2. In `src/execution/review-prompt.test.ts`, add tests:**

- Test: `buildReviewPrompt` with `isDraft: true` produces a prompt containing:
  - `"üìù Kodiai Draft Review Summary"` (the draft summary tag)
  - `"> **Draft**"` (the draft framing line)
  - `"suggestive framing"` or `"Consider..."` (the tone instruction)
  - Does NOT contain the standard `"Kodiai Review Summary"` tag (without Draft)

- Test: `buildReviewPrompt` with `isDraft: false` (or undefined) produces a prompt containing:
  - `"Kodiai Review Summary"` (standard tag)
  - Does NOT contain `"Draft Review Summary"`
  - Does NOT contain the suggestive framing instruction

- Test: `buildReviewPrompt` with `isDraft: true` AND `deltaContext` set ‚Äî the delta template should take precedence (draft framing is only for the standard template, not re-reviews). Verify no draft badge appears in delta mode.

**3. In `src/execution/mcp/comment-server.test.ts`, add tests:**

- Test: A review body with `<summary>üìù Kodiai Draft Review Summary</summary>` and valid five-section content passes validation (is NOT rejected and is NOT returned as-is unprocessed).

- Test: A review body with `<summary>üìù Kodiai Draft Review Summary</summary>` but missing `## What Changed` is still caught by the required-sections check.

Follow existing test patterns in each file. Use `describe` blocks to group draft-related tests. Keep test names descriptive (e.g., "reviews draft PRs instead of skipping", "draft prompt includes draft badge and suggestive tone").
  </action>
  <verify>
    - `bun test src/handlers/review.test.ts` passes
    - `bun test src/execution/review-prompt.test.ts` passes
    - `bun test src/execution/mcp/comment-server.test.ts` passes
    - `bun test` (full suite) passes with no regressions
  </verify>
  <done>
    Tests confirm: draft PRs are reviewed (not skipped), draft prompt includes badge + framing + suggestive tone, ready_for_review uses normal tone, comment-server validates draft summaries, and non-draft behavior is unchanged.
  </done>
</task>

</tasks>

<verification>
1. `bun run build` ‚Äî compiles cleanly
2. `bun test` ‚Äî full suite passes, no regressions
3. Manual grep checks:
   - No "Skipping draft PR" return-early path remains
   - `isDraft` parameter flows from review.ts through to review-prompt.ts
   - Draft summary tag appears in both prompt template and comment-server validation
4. Review the generated prompt for a mock draft PR and confirm it contains the draft badge, framing line, and suggestive language instructions
</verification>

<success_criteria>
- Draft PRs trigger reviews instead of being skipped (REV-01)
- Draft reviews show üìù badge and "Draft" framing with suggestive tone (REV-02)
- ready_for_review events produce normal-tone reviews (no draft framing)
- Non-draft PR reviews are completely unchanged
- All existing tests pass (no regressions)
- New tests cover draft behavior end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/82-draft-pr-review-coverage/82-01-SUMMARY.md`
</output>
