---
phase: 14-write-mode-foundations
plan: 01
type: execute
wave: 1
depends_on:
  - 13-xbmc-cutover/13-03-SUMMARY.md
files_modified:
  - src/execution/config.ts
  - src/handlers/mention.ts
  - src/execution/mention-prompt.ts
  - docs/runbooks/mentions.md
autonomous: true

must_haves:
  truths:
    - "Write operations remain deny-by-default; existing review + Q&A behavior is unchanged"
    - "There is a clear, explicit 'write request' intent path that can be enabled per repo"
    - "Write-mode executions are traceable (deliveryId + trigger comment + resulting branch/commit/PR links)"
  artifacts:
    - path: "src/execution/config.ts"
      provides: "Repo config supports a write-mode section with safe defaults"
    - path: "src/handlers/mention.ts"
      provides: "Mention handler can detect explicit write intent and route accordingly"
    - path: "docs/runbooks/mentions.md"
      provides: "Operators can diagnose write-mode skips vs failures"
---

<objective>
Lay the foundations for mention-driven code changes by introducing an explicit write-intent path with safe defaults and strong traceability.

Purpose: Enable v0.2 work without risking accidental writes.
Output: Config + routing + trace markers in place; still deny-by-default.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<tasks>

<task type="auto">
  <name>Task 1: Add write-mode config scaffolding (deny-by-default)</name>
  <files>src/execution/config.ts</files>
  <action>
  Extend `.kodiai.yml` schema with a `write` section, with defaults that preserve current behavior:
  - `write.enabled: false` by default
  - keep schema strict (unknown keys rejected, consistent with existing config philosophy)
  
  Include a short docstring in code for what `write.enabled` gates.
  </action>
  <verify>
  - Unit tests updated/added if needed
  - Existing tests pass: `bun test`
  </verify>
  <done>
  Repos can opt-in to write-mode explicitly without impacting default behavior.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add explicit write-intent routing path for mentions (no writes yet)</name>
  <files>src/handlers/mention.ts src/execution/mention-prompt.ts</files>
  <action>
  Introduce an explicit, low-ambiguity way to request changes via mention text (e.g. a leading keyword in the stripped question such as `apply:` / `change:`), and route to a distinct execution mode.

  Important: In this plan, the system should only:
  - detect intent
  - record trace metadata
  - respond explaining that write-mode is not enabled unless `write.enabled=true`

  Do NOT implement branch/commit/push yet.
  </action>
  <verify>
  - Mention behavior remains unchanged for normal questions
  - When write-intent is detected but disabled, reply is concise and explains how to enable it
  </verify>
  <done>
  There's a safe, explicit 'write request' path ready for Phase 15.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update runbook for write-intent triage</name>
  <files>docs/runbooks/mentions.md</files>
  <action>
  Add a short section describing:
  - how write-intent is detected
  - the expected skip reason when `write.enabled=false`
  - what evidence to capture (deliveryId, trigger comment URL)
  </action>
  <verify>
  - Runbook includes pointers to relevant log lines / gates
  </verify>
  <done>
  Operators can quickly tell 'disabled by policy' from 'failed to execute'.
  </done>
</task>

</tasks>

<verification>
- `bun test`
</verification>

<success_criteria>
- Default behavior unchanged (no writes unless explicitly enabled)
- Explicit write-intent detection exists and is testable
- Operators have a documented triage path
</success_criteria>

<output>
After completion, create `.planning/phases/14-write-mode-foundations/14-01-SUMMARY.md`
</output>
