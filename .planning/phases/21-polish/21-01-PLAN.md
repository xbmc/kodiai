---
phase: 21-polish
plan: 01
type: execute
wave: 1
depends_on:
  - 20-next-improvements/20-01-SUMMARY.md
files_modified:
  - .github/workflows/ci.yml
  - src/lib/sanitizer.test.ts
  - src/handlers/mention.ts
  - src/handlers/review.ts
  - docs/runbooks/mentions.md
autonomous: true
---

<objective>
Finish remaining polish items: make CI typecheck blocking, tighten guardrails refusal UX, add a non-chatty rereview trigger, and do a smoke test on xbmc repos.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Make CI typecheck blocking</name>
  <files>.github/workflows/ci.yml src/lib/sanitizer.test.ts</files>
  <action>
  Fix TypeScript strictness errors so `bunx tsc --noEmit` can be required in CI.
  Remove continue-on-error for the typecheck step.
  </action>
  <verify>
  - bunx tsc --noEmit
  - bun test
  </verify>
</task>

<task type="auto">
  <name>Task 2: Improve guardrail refusal UX</name>
  <files>src/handlers/mention.ts docs/runbooks/mentions.md</files>
  <action>
  When write-mode is blocked (denyPaths/allowPaths/secret scan), reply with a concise reason including:
  - policy code
  - path involved (when available)
  - next action (narrow allowPaths or adjust denyPaths)
  </action>
</task>

<task type="auto">
  <name>Task 3: Add non-chatty rereview trigger</name>
  <files>src/handlers/mention.ts src/handlers/review.ts</files>
  <action>
  Keep `@kodiai review` working, but reduce/no-op the bot reply text when the review output is posted in the PR timeline.
  </action>
</task>

<task type="auto">
  <name>Task 4: Smoke test write-mode paths</name>
  <files>docs/runbooks/mentions.md</files>
  <action>
  Run a smoke test on:
  - same-repo PR (updates branch)
  - fork PR (bot PR fallback)
  - guardrail block (denyPaths/secret scan)
  Document the steps.
  </action>
</task>

</tasks>

<verification>
- bun test
- bunx tsc --noEmit
</verification>

<output>
Create `.planning/phases/21-polish/21-01-SUMMARY.md`.
</output>
