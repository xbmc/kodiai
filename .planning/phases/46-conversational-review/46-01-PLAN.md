---
phase: 46-conversational-review
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention-types.ts
  - src/knowledge/types.ts
  - src/knowledge/store.ts
  - src/execution/mention-context.ts
  - src/execution/mention-prompt.ts
  - src/handlers/mention-types.test.ts
  - src/knowledge/store.test.ts
  - src/execution/mention-context.test.ts
autonomous: true

must_haves:
  truths:
    - "MentionEvent carries inReplyToId when a review comment is a reply"
    - "KnowledgeStore can look up a finding by repo + comment_id and return severity, category, filePath, startLine, title"
    - "buildMentionContext includes review comment thread history when inReplyToId is present"
    - "buildMentionContext includes finding metadata when parent comment is a kodiai finding"
    - "buildMentionPrompt includes finding-specific preamble when finding context is available"
  artifacts:
    - path: "src/handlers/mention-types.ts"
      provides: "inReplyToId field on MentionEvent + normalizeReviewComment extraction"
      contains: "inReplyToId"
    - path: "src/knowledge/types.ts"
      provides: "getFindingByCommentId method signature on KnowledgeStore"
      contains: "getFindingByCommentId"
    - path: "src/knowledge/store.ts"
      provides: "getFindingByCommentId SQLite query implementation"
      contains: "getFindingByCommentId"
    - path: "src/execution/mention-context.ts"
      provides: "Thread-aware context building with finding metadata"
      contains: "Review Comment Thread Context"
  key_links:
    - from: "src/handlers/mention-types.ts"
      to: "src/execution/mention-context.ts"
      via: "MentionEvent.inReplyToId consumed by buildMentionContext"
      pattern: "mention\\.inReplyToId"
    - from: "src/knowledge/store.ts"
      to: "src/execution/mention-context.ts"
      via: "getFindingByCommentId called during thread context building"
      pattern: "getFindingByCommentId"
---

<objective>
Add thread-aware context building and finding lookup for conversational review.

Purpose: When a user replies to a Kodiai review finding with @kodiai, the bot must detect the reply context, load the original finding metadata from the knowledge store, reconstruct the review comment thread history, and include all of this in the mention context so the LLM can provide a contextual follow-up response.

Output: inReplyToId on MentionEvent, getFindingByCommentId on KnowledgeStore, thread-aware buildMentionContext, finding-aware buildMentionPrompt. All with TDD coverage.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-conversational-review/46-RESEARCH.md

@src/handlers/mention-types.ts
@src/execution/mention-context.ts
@src/execution/mention-prompt.ts
@src/knowledge/types.ts
@src/knowledge/store.ts
@src/handlers/review-idempotency.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inReplyToId to MentionEvent and getFindingByCommentId to KnowledgeStore</name>
  <files>
    src/handlers/mention-types.ts
    src/handlers/mention-types.test.ts
    src/knowledge/types.ts
    src/knowledge/store.ts
    src/knowledge/store.test.ts
  </files>
  <action>
**MentionEvent (src/handlers/mention-types.ts):**
- Add `inReplyToId: number | undefined` field to the `MentionEvent` interface, with JSDoc: `/** For pr_review_comment: the comment ID this is replying to (thread parent) */`
- In `normalizeReviewComment()`, extract `payload.comment.in_reply_to_id ?? undefined` and assign to `inReplyToId`. The `in_reply_to_id` field is typed as `number | undefined` in `@octokit/webhooks-types` (schema.d.ts line 6751).
- In `normalizeIssueComment()` and `normalizeReviewBody()`, set `inReplyToId: undefined`.
- Write tests: `normalizeReviewComment` with `in_reply_to_id` set returns it; without it returns undefined; `normalizeIssueComment` and `normalizeReviewBody` always return undefined.

**KnowledgeStore (src/knowledge/types.ts + src/knowledge/store.ts):**
- Add to `KnowledgeStore` type: `getFindingByCommentId?(params: { repo: string; commentId: number }): { severity: FindingSeverity; category: FindingCategory; filePath: string; startLine: number | null; title: string } | null;`
- Use optional method (`?`) to match the pattern used by `getAuthorCache?` -- callers check availability before calling.
- In `store.ts`, add a prepared statement:
  ```sql
  SELECT f.severity, f.category, f.file_path, f.start_line, f.title
  FROM findings f
  INNER JOIN reviews r ON r.id = f.review_id
  WHERE r.repo = $repo AND f.comment_id = $commentId
  ORDER BY f.created_at DESC
  LIMIT 1
  ```
- Implement `getFindingByCommentId` on the returned store object. Return null if no row found, otherwise map to the return type.
- Write test: insert a review + finding with comment_id, then call getFindingByCommentId and assert it returns the correct metadata. Also test null return when comment_id does not exist.
  </action>
  <verify>
Run `bun test src/handlers/mention-types.test.ts src/knowledge/store.test.ts` -- all tests pass including new ones.
  </verify>
  <done>
MentionEvent has inReplyToId field. normalizeReviewComment extracts in_reply_to_id from webhook payload. KnowledgeStore has getFindingByCommentId that returns finding metadata by repo + comment_id, with null fallback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add thread-aware context building and finding-specific prompt preamble</name>
  <files>
    src/execution/mention-context.ts
    src/execution/mention-context.test.ts
    src/execution/mention-prompt.ts
  </files>
  <action>
**BuildMentionContextOptions (src/execution/mention-context.ts):**
- Add optional field to `BuildMentionContextOptions`: `findingLookup?: (repo: string, commentId: number) => { severity: string; category: string; filePath: string; startLine: number | null; title: string } | null`
- This is a callback so the context builder does not depend directly on KnowledgeStore. The caller (mention handler) will wire it.

**Thread context section in buildMentionContext:**
- After the existing "Inline Review Comment Context" section (line ~313), add a new section gated by `mention.surface === "pr_review_comment" && mention.inReplyToId && mention.prNumber`.
- When the gate is true:
  1. Add heading: `## Review Comment Thread Context`
  2. Fetch the parent comment: `octokit.rest.pulls.getReviewComment({ owner, repo, comment_id: mention.inReplyToId })`. Wrap in try/catch; on 404 (deleted parent), log warning and skip thread context (graceful fallback per research Pitfall 4).
  3. Check if parent is a kodiai finding: `const reviewOutputMarkerRe = /<!-- kodiai:review-output-key:[^>]+ -->/; const isKodiaiFinding = reviewOutputMarkerRe.test(parent.body ?? "");`
  4. If `isKodiaiFinding && options.findingLookup`, call `options.findingLookup(`${mention.owner}/${mention.repo}`, mention.inReplyToId)`. If finding returned, add lines: `Original finding: [SEVERITY] category`, `File: filePath`, `Line: startLine` (if non-null), `Title: title`.
  5. Fetch thread comments: `octokit.rest.pulls.listReviewComments({ owner, repo, pull_number: mention.prNumber, per_page: 100, sort: "created", direction: "asc" })`. Cap at 1 page (100 comments) per research anti-pattern guidance.
  6. Filter to thread: `const threadRoot = mention.inReplyToId; const threadComments = allReviewComments.filter(c => c.id === threadRoot || c.in_reply_to_id === threadRoot);`
  7. Walk up one level if parent itself has `in_reply_to_id` set (defensive per research Open Question 1): `if (parent.in_reply_to_id) { threadRoot = parent.in_reply_to_id; refilter; }`
  8. Include thread history with per-comment truncation using existing `truncateDeterministic` and `sanitizeContent`. Apply a separate thread character budget (use `maxConversationChars` as fallback for now; plan 03 will add a dedicated budget).
  9. Exclude the triggering comment itself from thread history (it's already in "User's Question" in the prompt).

**buildMentionPrompt (src/execution/mention-prompt.ts):**
- Add optional `findingContext?: { severity: string; category: string; filePath: string; startLine: number | null; title: string }` to the params.
- When `findingContext` is provided, add after the context header:
  ```
  This is a follow-up to a review finding:
  - Finding: [SEVERITY] category
  - File: filePath (line startLine)
  - Title: title
  Provide a focused response that addresses the user's question about this specific finding. Reference the finding's reasoning and suggest concrete code changes if applicable.
  ```

**Tests (src/execution/mention-context.test.ts):**
- Test: when `inReplyToId` is set, thread context section is included in output.
- Test: when `findingLookup` returns a finding, metadata appears in context.
- Test: when `findingLookup` returns null, thread context still includes thread comments but no finding metadata.
- Test: when parent comment fetch returns 404, thread context is skipped gracefully (no error thrown).
- Mock octokit using the same pattern as existing tests in the file.
  </action>
  <verify>
Run `bun test src/execution/mention-context.test.ts` -- all tests pass. Run `bun test` to confirm no regressions.
  </verify>
  <done>
buildMentionContext includes review comment thread history when inReplyToId is present. Finding metadata from knowledge store appears in context when available. Deleted parent comments are handled gracefully. buildMentionPrompt includes finding-specific preamble.
  </done>
</task>

</tasks>

<verification>
1. `bun test` -- all tests pass with no regressions
2. New tests cover: inReplyToId extraction, getFindingByCommentId query, thread context building, finding metadata inclusion, deleted parent graceful fallback, finding-specific prompt preamble
3. TypeScript compiles without errors: `bun build src/index.ts --target=bun --outdir=/dev/null` or equivalent type check
</verification>

<success_criteria>
- MentionEvent.inReplyToId is populated from webhook payload for review comment replies
- KnowledgeStore.getFindingByCommentId returns structured finding metadata by comment_id
- buildMentionContext produces thread context section with finding metadata when replying to a kodiai finding
- buildMentionPrompt includes finding-specific preamble for contextual follow-up
- All new behavior is covered by TDD tests
</success_criteria>

<output>
After completion, create `.planning/phases/46-conversational-review/46-01-SUMMARY.md`
</output>
