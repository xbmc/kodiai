---
phase: 46-conversational-review
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/sanitizer.ts
  - src/lib/sanitizer.test.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
autonomous: true

must_haves:
  truths:
    - "Outgoing bot replies have @kodiai and @claude mentions stripped to prevent self-trigger loops"
    - "Config schema includes mention.conversation.maxTurnsPerPr with sensible default"
    - "Config schema includes mention.conversation.contextBudgetChars with sensible default"
    - "sanitizeOutgoingMentions handles case-insensitive replacement and multiple handles"
  artifacts:
    - path: "src/lib/sanitizer.ts"
      provides: "sanitizeOutgoingMentions export"
      contains: "sanitizeOutgoingMentions"
    - path: "src/execution/config.ts"
      provides: "mention.conversation config schema with maxTurnsPerPr and contextBudgetChars"
      contains: "contextBudgetChars"
  key_links:
    - from: "src/lib/sanitizer.ts"
      to: "src/handlers/mention.ts"
      via: "sanitizeOutgoingMentions called before posting replies (wired in plan 03)"
      pattern: "sanitizeOutgoingMentions"
    - from: "src/execution/config.ts"
      to: "src/handlers/mention.ts"
      via: "config.mention.conversation read during rate limiting and context budgeting"
      pattern: "mention\\.conversation"
---

<objective>
Add outgoing mention sanitization and conversation config schema for rate limiting and context budgets.

Purpose: Defense-in-depth against self-trigger loops (P0 risk from research) via outgoing mention sanitization, plus configuration schema for conversation rate limiting and context budgets that plan 03 will wire into the handler.

Output: sanitizeOutgoingMentions utility, mention.conversation config section with maxTurnsPerPr and contextBudgetChars. All with TDD coverage.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-conversational-review/46-RESEARCH.md

@src/lib/sanitizer.ts
@src/execution/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sanitizeOutgoingMentions utility</name>
  <files>
    src/lib/sanitizer.ts
    src/lib/sanitizer.test.ts
  </files>
  <action>
**sanitizeOutgoingMentions (src/lib/sanitizer.ts):**
- Add a new exported function at the end of the file:
  ```typescript
  /**
   * Strip mention handles from outgoing bot replies to prevent self-trigger loops.
   * Replaces @handle with handle (removes the @ prefix) preserving readability.
   * Defense-in-depth alongside the bot filter in webhook processing.
   */
  export function sanitizeOutgoingMentions(
    body: string,
    handles: string[],
  ): string {
    let result = body;
    for (const handle of handles) {
      const clean = handle.startsWith("@") ? handle.slice(1) : handle;
      if (!clean) continue;
      const escaped = clean.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
      result = result.replace(new RegExp(`@${escaped}\\b`, "gi"), clean);
    }
    return result;
  }
  ```
- The function uses the same `escapeRegExp` pattern as `buildMentionRegex` in mention-types.ts but is self-contained to avoid circular imports.
- Case-insensitive replacement (`gi` flags) handles `@Kodiai`, `@KODIAI`, `@kodiai` etc.
- `\b` word boundary prevents partial matches (e.g., `@kodiaibot` should not be stripped by `kodiai` handle).

**Tests (src/lib/sanitizer.test.ts):**
- Test: strips `@kodiai` from body, leaving just `kodiai`
- Test: strips `@claude` from body
- Test: case-insensitive: `@Kodiai`, `@KODIAI`, `@Claude` all stripped
- Test: multiple handles stripped in a single pass
- Test: handles appearing multiple times in body are all stripped
- Test: empty handles array returns body unchanged
- Test: handles with special regex characters are properly escaped
- Test: word boundary prevents partial match (body containing `@kodiaibot` is not modified when handle is `kodiai`)
- Test: body with no mentions returns unchanged
  </action>
  <verify>
Run `bun test src/lib/sanitizer.test.ts` -- all tests pass including new ones.
  </verify>
  <done>
sanitizeOutgoingMentions strips @handle prefixes from outgoing bot replies, handles case-insensitive matching, multiple handles, and respects word boundaries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add mention.conversation config schema</name>
  <files>
    src/execution/config.ts
    src/execution/config.test.ts
  </files>
  <action>
**Config schema (src/execution/config.ts):**
- Add a new `conversationSchema` before the `mentionSchema`:
  ```typescript
  const conversationSchema = z
    .object({
      maxTurnsPerPr: z.number().min(1).max(50).default(10),
      contextBudgetChars: z.number().min(1000).max(50000).default(8000),
    })
    .default({ maxTurnsPerPr: 10, contextBudgetChars: 8000 });
  ```
- Add `conversation: conversationSchema` to the mentionSchema object. The updated mentionSchema becomes:
  ```typescript
  const mentionSchema = z
    .object({
      enabled: z.boolean().default(true),
      acceptClaudeAlias: z.boolean().default(true),
      allowedUsers: z.array(z.string()).default([]),
      prompt: z.string().optional(),
      conversation: conversationSchema,
    })
    .default({
      enabled: true,
      acceptClaudeAlias: true,
      allowedUsers: [],
      conversation: { maxTurnsPerPr: 10, contextBudgetChars: 8000 },
    });
  ```
- Update the section-level fallback parse for `mention` in the `loadRepoConfig` function (the fallback already calls `mentionSchema.parse({})` which will pick up defaults).
- Ensure the `RepoConfig` type inference includes the new `conversation` field.

**Tests (src/execution/config.test.ts):**
- Test: default config has `mention.conversation.maxTurnsPerPr === 10` and `mention.conversation.contextBudgetChars === 8000`
- Test: custom values are accepted: `{ mention: { conversation: { maxTurnsPerPr: 5, contextBudgetChars: 4000 } } }` parses correctly
- Test: out-of-range values fail validation: `maxTurnsPerPr: 0` and `maxTurnsPerPr: 51` and `contextBudgetChars: 999` and `contextBudgetChars: 50001`
- Test: partial conversation object uses defaults for missing fields
- Test: config with no `conversation` key under `mention` uses full defaults (backward compatibility)
  </action>
  <verify>
Run `bun test src/execution/config.test.ts` -- all tests pass including new ones. Run `bun test` to confirm no regressions.
  </verify>
  <done>
Config schema includes mention.conversation section with maxTurnsPerPr (default 10, range 1-50) and contextBudgetChars (default 8000, range 1000-50000). Backward compatible with existing configs that lack the conversation key.
  </done>
</task>

</tasks>

<verification>
1. `bun test` -- all tests pass with no regressions
2. New tests cover: sanitizeOutgoingMentions (case sensitivity, word boundary, multiple handles, special chars), conversation config schema (defaults, custom values, validation, backward compatibility)
3. TypeScript compiles without errors
</verification>

<success_criteria>
- sanitizeOutgoingMentions strips @kodiai and @claude from bot reply bodies
- mention.conversation.maxTurnsPerPr defaults to 10 with range 1-50
- mention.conversation.contextBudgetChars defaults to 8000 with range 1000-50000
- Backward compatible: existing .kodiai.yml files without conversation key parse correctly
- All new behavior covered by TDD tests
</success_criteria>

<output>
After completion, create `.planning/phases/46-conversational-review/46-02-SUMMARY.md`
</output>
