---
phase: 50-publish-path-mention-sanitization-completion
plan: 02
type: execute
wave: 2
depends_on: ["50-01"]
files_modified:
  - src/execution/mcp/comment-server.test.ts
  - src/execution/mcp/inline-review-server.test.ts
  - src/execution/mcp/review-comment-thread-server.test.ts
autonomous: true

must_haves:
  truths:
    - "MCP server publish paths are covered by regression tests verifying mention sanitization"
    - "Ancillary review handler publish paths are covered by regression tests verifying mention sanitization"
    - "Milestone audit no longer reports degraded flow for outbound mention sanitization"
  artifacts:
    - path: "src/execution/mcp/comment-server.test.ts"
      provides: "Tests verifying create_comment, update_comment, and approval review sanitize mentions"
      contains: "sanitize"
    - path: "src/execution/mcp/inline-review-server.test.ts"
      provides: "Test verifying create_inline_comment sanitizes mentions"
      contains: "sanitize"
    - path: "src/execution/mcp/review-comment-thread-server.test.ts"
      provides: "Test verifying reply_to_pr_review_comment sanitizes mentions"
      contains: "sanitize"
  key_links:
    - from: "src/execution/mcp/comment-server.test.ts"
      to: "src/execution/mcp/comment-server.ts"
      via: "tests call MCP tools with body containing @kodiai and verify Octokit receives sanitized body"
      pattern: "@kodiai.*kodiai"
---

<objective>
Add regression tests for mention sanitization across all ancillary MCP server publish paths and verify the milestone audit degraded flow is resolved.

Purpose: Lock the defense-in-depth guarantee with test coverage so future refactors cannot regress mention sanitization on any publish path. Close the CONV-05 audit gap.

Output: Regression tests for all 5 MCP publish points proving sanitization is applied, plus audit confirmation.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-publish-path-mention-sanitization-completion/50-RESEARCH.md
@.planning/phases/50-publish-path-mention-sanitization-completion/50-01-SUMMARY.md
@src/execution/mcp/comment-server.ts
@src/execution/mcp/comment-server.test.ts
@src/execution/mcp/inline-review-server.ts
@src/execution/mcp/inline-review-server.test.ts
@src/execution/mcp/review-comment-thread-server.ts
@src/execution/mcp/review-comment-thread-server.test.ts
@src/lib/sanitizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mention sanitization regression tests to all MCP server test files</name>
  <files>
    src/execution/mcp/comment-server.test.ts
    src/execution/mcp/inline-review-server.test.ts
    src/execution/mcp/review-comment-thread-server.test.ts
  </files>
  <action>
    Read each existing test file to understand the mock patterns (mock Octokit, mock getOctokit, etc.) and test structure.

    **comment-server.test.ts** — Add a `describe("mention sanitization")` block with tests:
    1. `create_comment strips @kodiai from body` — Create a server with `botHandles: ["kodiai", "claude"]`, call the `create_comment` tool with a body containing `@kodiai found an issue`, assert the Octokit `createComment` mock was called with body NOT containing `@kodiai` (should contain `kodiai found an issue` without the `@`).
    2. `update_comment strips @kodiai from body` — Same pattern for the `update_comment` tool.
    3. `approval review strips @kodiai from body` — Same pattern for the approval `create_review` path (if testable via tool invocation). If the approval path is triggered internally, test by calling the tool that produces an approval body.

    **inline-review-server.test.ts** — Add a test:
    4. `create_inline_comment strips @kodiai from body` — Create a server with `botHandles: ["kodiai", "claude"]`, call the tool with a body containing `@kodiai should fix this`, assert the Octokit call receives the sanitized body.

    **review-comment-thread-server.test.ts** — Add a test:
    5. `reply_to_pr_review_comment strips @kodiai from body` — Create a server with `botHandles: ["kodiai", "claude"]`, call the tool with a body containing `As @kodiai noted`, assert the Octokit call receives the sanitized body.

    Each test should follow the existing file's test patterns for mock setup. The key assertion pattern is:
    ```typescript
    expect(mockOctokit.rest.issues.createComment).toHaveBeenCalledWith(
      expect.objectContaining({
        body: expect.not.stringContaining("@kodiai"),
      })
    );
    ```
    Or equivalently, extract the `body` argument and assert it equals the expected sanitized string.

    Also verify the positive case: the mention content is still present (just without the `@` prefix), confirming sanitization rather than deletion.
  </action>
  <verify>
    Run `bun test src/execution/mcp/` to confirm all MCP server tests pass, including new sanitization tests. Verify test count increased:
    ```
    bun test src/execution/mcp/ 2>&1 | tail -5
    ```
  </verify>
  <done>
    All 5 MCP server publish points have dedicated regression tests verifying that bodies containing `@kodiai` are sanitized to `kodiai` (without `@`) before reaching Octokit. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify audit gap closure and update milestone audit status</name>
  <files>
    .planning/v0.8-MILESTONE-AUDIT.md
    .planning/v0.8-v0.8-MILESTONE-AUDIT.md
  </files>
  <action>
    1. Read `.planning/v0.8-MILESTONE-AUDIT.md` and `.planning/v0.8-v0.8-MILESTONE-AUDIT.md` (the canonical audit). Locate the CONV-05 / mention sanitization entry that reports a DEGRADED status.

    2. Update the status from DEGRADED to PASS (or equivalent passing status used in the audit format). Update the evidence to reference:
       - Phase 50 implementation: `sanitizeOutgoingMentions` applied at all 12 publish points (5 MCP + 7 review handler)
       - Regression test coverage in `comment-server.test.ts`, `inline-review-server.test.ts`, `review-comment-thread-server.test.ts`
       - Bot handles threaded through `ExecutionContext` -> `buildMcpServers` -> server constructors

    3. If there is a degraded flow summary or outstanding items section, remove the mention sanitization entry from it.

    4. Verify no other DEGRADED entries remain (or note them if they exist — do not modify entries unrelated to Phase 50).

    Note: If the audit files do not exist or do not contain the expected DEGRADED entry, skip this step and note the discrepancy in the SUMMARY.
  </action>
  <verify>
    Grep for DEGRADED in audit files:
    ```
    grep -i "degraded" .planning/v0.8-MILESTONE-AUDIT.md .planning/v0.8-v0.8-MILESTONE-AUDIT.md 2>/dev/null
    ```
    Should return zero matches for mention sanitization (other DEGRADED entries may exist for unrelated items).

    Run full test suite:
    ```
    bun test
    ```
    All tests pass.
  </verify>
  <done>
    Milestone audit no longer reports DEGRADED status for outbound mention sanitization. CONV-05 is marked as passing with evidence from Phase 50 implementation and test coverage. Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/execution/mcp/` passes with new sanitization regression tests
2. `bun test` full suite passes with all tests green
3. `grep -i "degraded.*mention\|mention.*degraded" .planning/v0.8-*AUDIT.md` returns no matches
4. At least 5 new test cases exist across the three MCP server test files covering mention sanitization
</verification>

<success_criteria>
All 5 MCP publish points have regression tests proving mention sanitization is applied. The milestone audit CONV-05 / mention sanitization entry is updated from DEGRADED to passing. Full test suite passes.
</success_criteria>

<output>
After completion, create `.planning/phases/50-publish-path-mention-sanitization-completion/50-02-SUMMARY.md`
</output>
