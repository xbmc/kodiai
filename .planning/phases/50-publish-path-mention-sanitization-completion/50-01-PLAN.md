---
phase: 50-publish-path-mention-sanitization-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/execution/types.ts
  - src/execution/executor.ts
  - src/execution/mcp/index.ts
  - src/execution/mcp/comment-server.ts
  - src/execution/mcp/inline-review-server.ts
  - src/execution/mcp/review-comment-thread-server.ts
  - src/handlers/mention.ts
  - src/handlers/review.ts
autonomous: true

must_haves:
  truths:
    - "Every MCP server publish call sanitizes outgoing mentions before posting to GitHub"
    - "Review handler direct Octokit publish calls sanitize outgoing mentions before posting"
    - "Bot handles are threaded from handlers through executor to MCP servers"
  artifacts:
    - path: "src/execution/types.ts"
      provides: "botHandles field on ExecutionContext"
      contains: "botHandles"
    - path: "src/execution/mcp/index.ts"
      provides: "botHandles parameter threaded to all MCP server constructors"
      contains: "botHandles"
    - path: "src/execution/mcp/comment-server.ts"
      provides: "sanitizeOutgoingMentions applied to create_comment, update_comment, and approval review body"
      contains: "sanitizeOutgoingMentions"
    - path: "src/execution/mcp/inline-review-server.ts"
      provides: "sanitizeOutgoingMentions applied to create_inline_comment body"
      contains: "sanitizeOutgoingMentions"
    - path: "src/execution/mcp/review-comment-thread-server.ts"
      provides: "sanitizeOutgoingMentions applied to reply_to_pr_review_comment body"
      contains: "sanitizeOutgoingMentions"
    - path: "src/handlers/review.ts"
      provides: "sanitizeOutgoingMentions applied to all direct Octokit publish calls"
      contains: "sanitizeOutgoingMentions"
  key_links:
    - from: "src/handlers/mention.ts"
      to: "src/execution/types.ts"
      via: "passes botHandles in ExecutionContext"
      pattern: "botHandles.*possibleHandles"
    - from: "src/handlers/review.ts"
      to: "src/execution/types.ts"
      via: "passes botHandles in ExecutionContext"
      pattern: "botHandles"
    - from: "src/execution/executor.ts"
      to: "src/execution/mcp/index.ts"
      via: "threads botHandles from context to buildMcpServers"
      pattern: "botHandles.*context\\.botHandles"
    - from: "src/execution/mcp/index.ts"
      to: "src/execution/mcp/comment-server.ts"
      via: "passes botHandles to createCommentServer"
      pattern: "deps\\.botHandles"
---

<objective>
Introduce `botHandles` field on `ExecutionContext`, thread it through `buildMcpServers` to all three MCP server constructors, and apply `sanitizeOutgoingMentions` at every outbound publish point in MCP servers and the review handler.

Purpose: Close the defense-in-depth gap where MCP tool publish paths and review handler direct Octokit calls bypass mention sanitization, eliminating the risk of self-trigger loops from any outbound comment path.

Output: All outbound GitHub comment/review publish paths route through `sanitizeOutgoingMentions` with bot handles available at call time.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-publish-path-mention-sanitization-completion/50-RESEARCH.md
@src/execution/types.ts
@src/execution/executor.ts
@src/execution/mcp/index.ts
@src/execution/mcp/comment-server.ts
@src/execution/mcp/inline-review-server.ts
@src/execution/mcp/review-comment-thread-server.ts
@src/handlers/mention.ts
@src/handlers/review.ts
@src/lib/sanitizer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Thread botHandles through ExecutionContext, executor, and buildMcpServers to all MCP server constructors</name>
  <files>
    src/execution/types.ts
    src/execution/executor.ts
    src/execution/mcp/index.ts
    src/execution/mcp/comment-server.ts
    src/execution/mcp/inline-review-server.ts
    src/execution/mcp/review-comment-thread-server.ts
    src/handlers/mention.ts
    src/handlers/review.ts
  </files>
  <action>
    1. **src/execution/types.ts** — Add optional `botHandles?: string[]` field to `ExecutionContext` type. Place it after `deliveryId` with a JSDoc comment: "Bot mention handles for outgoing sanitization (e.g. ['kodiai', 'claude'])."

    2. **src/handlers/mention.ts** — In the `executor.execute()` call (~L764), add `botHandles: possibleHandles` to the context object. `possibleHandles` is already defined as `[appSlug, "claude"]` at L168.

    3. **src/handlers/review.ts** — In the `executor.execute()` call (~L1609), add `botHandles: [appSlug, "claude"]`. The `appSlug` is obtained via `githubApp.getAppSlug()` which is already called earlier in the review handler (L885). Declare `const possibleHandles = [appSlug, "claude"]` near the top of the review job callback (after L885 where `appSlug` is first used), and pass it in the execute context. If `appSlug` is not in scope at the execute call site, resolve it from `githubApp.getAppSlug()` which is synchronous.

    4. **src/execution/mcp/index.ts** — Add `botHandles?: string[]` to the `buildMcpServers` deps parameter. Thread `deps.botHandles ?? []` to each server constructor call:
       - `createCommentServer(deps.getOctokit, deps.owner, deps.repo, deps.botHandles ?? [], deps.reviewOutputKey, deps.onPublish, deps.prNumber)`
       - `createReviewCommentThreadServer(deps.getOctokit, deps.owner, deps.repo, deps.botHandles ?? [], deps.onPublish)`
       - `createInlineReviewServer(deps.getOctokit, deps.owner, deps.repo, deps.prNumber, deps.botHandles ?? [], deps.reviewOutputKey, deps.deliveryId, deps.logger, deps.onPublish)`

    5. **src/execution/executor.ts** — In the `buildMcpServers({...})` call (~L62), add `botHandles: context.botHandles,` to the deps object.

    6. **src/execution/mcp/comment-server.ts** — Add `botHandles: string[]` parameter after `repo` in `createCommentServer` signature. Import `sanitizeOutgoingMentions` from `../../lib/sanitizer.ts`. Apply sanitization at each publish point:
       - `update_comment` tool (~L474): wrap body with `sanitizeOutgoingMentions(body, botHandles)` before the Octokit call
       - `create_comment` tool (~L540): wrap body with `sanitizeOutgoingMentions(body, botHandles)` before the Octokit call (apply after the existing sanitizer chain: `maybeStampMarker(sanitizeKodiaiReReviewSummary(sanitizeKodiaiReviewSummary(sanitizeKodiaiDecisionResponse(body))))`)
       - Approval `create_review` (~L522): wrap body with `sanitizeOutgoingMentions(body, botHandles)` before the Octokit call

    7. **src/execution/mcp/inline-review-server.ts** — Add `botHandles: string[]` parameter after `prNumber` in `createInlineReviewServer` signature. Import `sanitizeOutgoingMentions` from `../../lib/sanitizer.ts`. Apply `sanitizeOutgoingMentions(body, botHandles)` to the `create_inline_comment` tool body before the Octokit call (~L154).

    8. **src/execution/mcp/review-comment-thread-server.ts** — Add `botHandles: string[]` parameter after `repo` in `createReviewCommentThreadServer` signature. Import `sanitizeOutgoingMentions` from `../../lib/sanitizer.ts`. Apply `sanitizeOutgoingMentions(body, botHandles)` to the `reply_to_pr_review_comment` tool body before the Octokit call (~L53).

    Note: The mention handler already sanitizes in `postMentionReply`/`postMentionError` before MCP execution. Double-sanitization with MCP servers is safe because `sanitizeOutgoingMentions` is idempotent. Document this with a brief inline comment at one call site.
  </action>
  <verify>
    Run `bun run typecheck` (or `bunx tsc --noEmit`) to confirm no TypeScript compilation errors. Run `bun test` to confirm all existing tests pass. Verify with grep that `sanitizeOutgoingMentions` appears in all three MCP server files and in executor wiring:
    ```
    grep -r "sanitizeOutgoingMentions" src/execution/mcp/
    grep "botHandles" src/execution/types.ts src/execution/executor.ts src/execution/mcp/index.ts
    ```
  </verify>
  <done>
    All three MCP server constructors accept `botHandles`, all MCP publish points apply `sanitizeOutgoingMentions` before Octokit calls, and `botHandles` is threaded from handlers through `ExecutionContext` -> `executor` -> `buildMcpServers` -> server constructors. TypeScript compiles cleanly and all existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply sanitizeOutgoingMentions to all review handler direct Octokit publish paths</name>
  <files>
    src/handlers/review.ts
  </files>
  <action>
    Import `sanitizeOutgoingMentions` from `../lib/sanitizer.ts` at the top of `review.ts`.

    Apply `sanitizeOutgoingMentions(body, possibleHandles)` to every direct Octokit publish call in the review handler. The `possibleHandles` array (`[appSlug, "claude"]`) must be available at each call site. If `appSlug` is not in scope at a particular call site, use `githubApp.getAppSlug()` (synchronous) to obtain it.

    Specific publish points to sanitize:

    1. **[no-review] skip comment** (~L848): `skipOctokit.rest.issues.createComment` — wrap the body string with sanitization. Even though it is a static string, apply for uniformity.

    2. **Cost warning comment** (~L2020): `warnOctokit.rest.issues.createComment` — wrap the body with sanitization. Static template but apply for uniformity.

    3. **Error comment (result path)** (~L2280): The `formatErrorComment` output passed to `postOrUpdateErrorComment` — wrap with sanitization before passing. Note: `postOrUpdateErrorComment` is from `../lib/errors.ts` and posts the body as-is. Apply sanitization to the body argument.

    4. **Error comment (catch path)** (~L2381): Same pattern as above — wrap `formatErrorComment` output with sanitization.

    5. **Auto-approval review** (~L2335): `octokit.rest.pulls.createReview` — wrap the body with sanitization. Idempotency marker only, but apply for uniformity.

    6. **upsertReviewDetailsComment** (~L260-295): The `detailsBody` or comment body passed to `octokit.rest.issues.createComment` / `octokit.rest.issues.updateComment` — wrap with sanitization.

    7. **appendReviewDetailsToSummary** (~L297-332): The appended body passed to `octokit.rest.issues.updateComment` — wrap the updated body with sanitization before the Octokit call.

    For each, the pattern is: `sanitizeOutgoingMentions(bodyExpression, possibleHandles)` where `possibleHandles` is `[appSlug, "claude"]`.

    Add a brief comment at the first sanitization site: `// Defense-in-depth: sanitize outgoing mentions on all publish paths (Phase 50, CONV-05)`
  </action>
  <verify>
    Run `bun run typecheck` to confirm no TypeScript compilation errors. Run `bun test` to confirm all existing tests pass. Verify with grep:
    ```
    grep -c "sanitizeOutgoingMentions" src/handlers/review.ts
    ```
    Should return at least 7 (one per publish path).
  </verify>
  <done>
    All 7 direct Octokit publish paths in `review.ts` apply `sanitizeOutgoingMentions` before posting to GitHub. The review handler import is present, and all publish paths are uniformly protected. TypeScript compiles cleanly and all existing tests pass.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck` passes with zero errors
2. `bun test` passes with all tests green
3. `grep -r "sanitizeOutgoingMentions" src/execution/mcp/` shows matches in all 3 MCP server files
4. `grep -c "sanitizeOutgoingMentions" src/handlers/review.ts` returns >= 7
5. `grep "botHandles" src/execution/types.ts src/execution/executor.ts src/execution/mcp/index.ts` shows the threading chain
</verification>

<success_criteria>
Every outbound GitHub comment/review publish path in MCP servers (5 points) and review handler (7 points) applies `sanitizeOutgoingMentions` with bot handles. The `botHandles` field flows from handlers through `ExecutionContext` to MCP servers. All existing tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/50-publish-path-mention-sanitization-completion/50-01-SUMMARY.md`
</output>
