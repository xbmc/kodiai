---
phase: 64-policy-guardrails-completion
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/handlers/mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Issue-surface allowPaths violation triggers a refusal reply containing the violated rule, the blocked file, and a concrete config snippet to fix it"
    - "Issue-surface secretScan violation triggers a refusal reply containing the detector name and a safe remediation step without exposing secret content"
    - "All three issue-surface policy refusal paths (denyPaths, allowPaths, secretScan) post exactly one issue-thread reply and zero PRs"
  artifacts:
    - path: "src/handlers/mention.test.ts"
      provides: "Issue-surface policy guardrail regression tests for allowPaths and secretScan"
      contains: "issue apply.*allowPaths|issue apply.*secretScan"
  key_links:
    - from: "src/handlers/mention.test.ts"
      to: "src/handlers/mention.ts"
      via: "buildIssueCommentMentionEvent with write policy configs"
      pattern: "buildIssueCommentMentionEvent.*allowPaths|buildIssueCommentMentionEvent.*secretScan"
---

<objective>
Add issue-surface-specific regression tests for allowPaths and secretScan refusal paths, completing the trio of policy guardrail tests for issue write-mode. Currently only denyPaths has issue-surface coverage; PR-surface has all three.

Purpose: Close the IWR-03 gap where policy guardrail behavior exists in code but issue-surface regression coverage is incomplete, leaving the phase unverifiable.
Output: Two new regression tests in mention.test.ts proving issue-surface allowPaths and secretScan refusals are deterministic with actionable user messaging.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-issue-write-mode-pr-creation/62-02-SUMMARY.md

# Reference: existing issue denyPaths test at line ~2349 and PR-surface allowPaths/secretScan tests at lines ~3154 and ~3271
@src/handlers/mention.test.ts
@src/handlers/mention.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Add failing issue-surface allowPaths and secretScan refusal tests</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Add two new tests adjacent to the existing "issue apply intent policy failure posts refusal details in issue thread" test (line ~2349):

1. **"issue apply intent allowPaths violation posts refusal with config snippet in issue thread"**
   - Config: `mention:\n  enabled: true\nwrite:\n  enabled: true\n  allowPaths:\n    - 'src/'\n`
   - Executor writes to `README.md` (outside allowPaths)
   - Trigger: `buildIssueCommentMentionEvent` with `@kodiai apply: update the README`
   - Assert: zero `pulls.create` calls, exactly one issue reply
   - Assert reply contains: `write-policy-not-allowed`, `Rule: allowPaths`, `File: README.md`, `Smallest config change`, `allowPaths`, `- 'README.md'`
   - Mirror the structure of the existing PR-surface test at line ~3154 but use issue comment fixtures and capture via `issues.createComment`

2. **"issue apply intent secretScan violation posts refusal with detector in issue thread"**
   - Config: `mention:\n  enabled: true\nwrite:\n  enabled: true\n`
   - Executor writes a file containing a GitHub PAT pattern: `ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`
   - Trigger: `buildIssueCommentMentionEvent` with `@kodiai apply: add the config`
   - Assert: zero `pulls.create` calls, exactly one issue reply
   - Assert reply contains: `write-policy-secret-detected`, `Rule: secretScan`, `File:`, `Detector: regex:github-pat`
   - Assert reply does NOT contain the actual secret token string
   - Mirror the structure of the existing PR-surface test at line ~3271 but use issue comment fixtures

Both tests should follow the exact fixture pattern of the existing issue denyPaths test (line ~2349): `createWorkspaceFixture`, `buildIssueCommentMentionEvent`, `issues.createComment` capture, `pulls.list` returning `[]`.

Run tests expecting them to PASS (since the code already handles these paths -- this is gap closure, not new feature TDD). If they fail, that indicates a real bug to fix in plan 02.
  </action>
  <verify>
Run `bun test src/handlers/mention.test.ts --timeout 30000` -- new tests pass.
Run `bunx tsc --noEmit` -- no type errors.
  </verify>
  <done>
Two new issue-surface regression tests exist and pass: one for allowPaths refusal with config snippet, one for secretScan refusal with detector name. Combined with the existing denyPaths test, all three issue-surface policy guardrail refusal paths now have dedicated regression coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Verify full suite and lock the refusal message contract</name>
  <files>src/handlers/mention.test.ts</files>
  <action>
Run the full test suite (`bun test`) to confirm no regressions.

If any test from Task 1 failed (indicating a code gap), fix the minimal code in `src/handlers/mention.ts` to make it pass. The most likely issue would be the issue-surface write path not catching `WritePolicyError` for the secretScan case, but based on code review the catch block at line ~1131 already handles all `WritePolicyError` codes generically.

Add one additional assertion to each new test verifying the "next step" content:
- For allowPaths: assert reply contains text about updating `.kodiai.yml` (the config snippet)
- For secretScan: assert reply contains "Remove/redact the secret" guidance and does NOT suggest disabling the scan as primary advice

Commit with message: `test(64-01): add issue-surface allowPaths and secretScan refusal regressions`
  </action>
  <verify>
Run `bun test` -- all tests pass (full suite).
Run `bunx tsc --noEmit` -- no type errors.
  </verify>
  <done>
Full test suite passes. Issue-surface policy guardrail regressions are locked: denyPaths (existing), allowPaths (new), secretScan (new). Each asserts zero PRs, single refusal reply, correct reason code, rule name, file path, and actionable next-step content.
  </done>
</task>

</tasks>

<verification>
- `bun test src/handlers/mention.test.ts --timeout 30000` passes with new tests
- `bun test` full suite passes
- `bunx tsc --noEmit` passes
- Three distinct issue-surface policy tests exist: denyPaths, allowPaths, secretScan
- Each test asserts: 0 PRs created, 1 issue reply, correct reason/rule/file, actionable guidance
</verification>

<success_criteria>
Issue-surface write-mode policy guardrail refusals are regression-locked for all three policy types (denyPaths, allowPaths, secretScan) with deterministic assertions on refusal content and next-step guidance.
</success_criteria>

<output>
After completion, create `.planning/phases/64-policy-guardrails-completion/64-01-SUMMARY.md`
</output>
