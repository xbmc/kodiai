---
phase: 111-troubleshooting-agent
plan: 02
type: execute
wave: 2
depends_on: [111-01]
files_modified:
  - src/handlers/troubleshooting-agent.ts
  - src/handlers/troubleshooting-agent.test.ts
  - src/index.ts
autonomous: true
requirements: [TSHOOT-04, TSHOOT-05, TSHOOT-07, TSHOOT-08]

must_haves:
  truths:
    - "When @kodiai is mentioned on an open issue with troubleshooting intent and triage.troubleshooting.enabled is true, a comment with synthesized guidance is posted"
    - "Troubleshooting responses include a citations table with issue number, title, and match score in a collapsible details section"
    - "Troubleshooting responses include provenance disclosure: 'This guidance was synthesized from similar resolved issues'"
    - "When triage.troubleshooting.enabled is false, the handler silently bails (no comment, no error)"
    - "Comment-scoped marker dedup prevents duplicate responses for the same trigger comment ID"
    - "When retrieveTroubleshootingContext returns null (no matches), handler silently bails"
    - "Outgoing comment text is sanitized via sanitizeOutgoingMentions before posting"
    - "The handler is registered on issue_comment.created in src/index.ts"
  artifacts:
    - path: "src/handlers/troubleshooting-agent.ts"
      provides: "createTroubleshootingHandler factory with synthesis prompt builder and comment formatter"
      exports: ["createTroubleshootingHandler"]
    - path: "src/handlers/troubleshooting-agent.test.ts"
      provides: "Unit tests for synthesis prompt builder and comment formatter"
      contains: "formatTroubleshootingComment"
    - path: "src/index.ts"
      provides: "Handler wiring for troubleshooting agent"
      contains: "createTroubleshootingHandler"
  key_links:
    - from: "src/handlers/troubleshooting-agent.ts"
      to: "src/handlers/troubleshooting-intent.ts"
      via: "classifyTroubleshootingIntent, buildTroubleshootMarker, hasTroubleshootMarker"
      pattern: "classifyTroubleshootingIntent|buildTroubleshootMarker|hasTroubleshootMarker"
    - from: "src/handlers/troubleshooting-agent.ts"
      to: "src/knowledge/troubleshooting-retrieval.ts"
      via: "retrieveTroubleshootingContext for resolved issue retrieval"
      pattern: "retrieveTroubleshootingContext"
    - from: "src/handlers/troubleshooting-agent.ts"
      to: "src/llm/generate.ts"
      via: "generateWithFallback for synthesis"
      pattern: "generateWithFallback"
    - from: "src/handlers/troubleshooting-agent.ts"
      to: "src/lib/sanitizer.ts"
      via: "sanitizeOutgoingMentions before posting comment"
      pattern: "sanitizeOutgoingMentions"
    - from: "src/index.ts"
      to: "src/handlers/troubleshooting-agent.ts"
      via: "createTroubleshootingHandler called with deps"
      pattern: "createTroubleshootingHandler"
---

<objective>
Create the full troubleshooting handler with LLM synthesis, provenance citations, comment formatting, and wire it into src/index.ts. When @kodiai is mentioned on an open issue with troubleshooting intent, the handler retrieves similar resolved issues, synthesizes guidance via generateWithFallback, formats a comment with citations and provenance disclosure, and posts it.

Purpose: This is the user-facing feature -- the troubleshooting agent that responds to @kodiai mentions with actionable guidance grounded in resolved issues.

Output: `src/handlers/troubleshooting-agent.ts` (handler + helpers), tests, and wiring in `src/index.ts`.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.23-ROADMAP.md
@.planning/111-troubleshooting-agent/111-RESEARCH.md
@.planning/110-troubleshooting-retrieval-foundation/110-01-SUMMARY.md
@.planning/111-troubleshooting-agent/111-01-SUMMARY.md

@src/handlers/issue-opened.ts
@src/handlers/mention-types.ts
@src/handlers/troubleshooting-intent.ts
@src/knowledge/troubleshooting-retrieval.ts
@src/llm/generate.ts
@src/llm/task-types.ts
@src/llm/task-router.ts
@src/execution/config.ts
@src/lib/sanitizer.ts
@src/index.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/handlers/troubleshooting-intent.ts (created in 111-01):
```typescript
export function classifyTroubleshootingIntent(params: {
  mentionText: string;
  issueTitle: string;
  issueBody: string | null;
}): boolean;

export const TROUBLESHOOT_MARKER_PREFIX: string;  // "kodiai:troubleshoot"

export function buildTroubleshootMarker(repo: string, issueNumber: number, triggerCommentId: number): string;

export function hasTroubleshootMarker(
  comments: Array<{ body?: string | null }>,
  triggerCommentId: number,
): boolean;
```

From src/knowledge/troubleshooting-retrieval.ts (created in Phase 110):
```typescript
export type TroubleshootingConfig = {
  enabled: boolean;
  similarityThreshold: number;
  maxResults: number;
  totalBudgetChars: number;
};

export type TroubleshootingMatch = {
  issueNumber: number;
  title: string;
  body: string;
  tailComments: string[];
  semanticComments: string[];
  similarity: number;
  totalChars: number;
};

export type TroubleshootingResult = {
  matches: TroubleshootingMatch[];
  wikiResults: WikiKnowledgeMatch[];
  source: "issues" | "wiki" | "both";
};

export function retrieveTroubleshootingContext(params: {
  issueStore: IssueStore;
  wikiPageStore?: WikiPageStore;
  embeddingProvider: EmbeddingProvider;
  repo: string;
  queryTitle: string;
  queryBody: string | null;
  config: TroubleshootingConfig;
  logger: Logger;
}): Promise<TroubleshootingResult | null>;
```

From src/llm/generate.ts:
```typescript
export interface GenerateResult {
  text: string;
  usage: { inputTokens: number; outputTokens: number };
  model: string;
  provider: string;
  usedFallback: boolean;
  durationMs: number;
}

export async function generateWithFallback(opts: {
  taskType: string;
  resolved: ResolvedModel;
  prompt: string;
  system?: string;
  costTracker?: CostTracker;
  repo?: string;
  deliveryId?: string;
  logger: Logger;
}): Promise<GenerateResult>;
```

From src/llm/task-router.ts:
```typescript
export interface TaskRouter {
  resolve(taskType: string): ResolvedModel;
}
```

From src/handlers/issue-opened.ts (factory pattern to follow):
```typescript
export function createIssueOpenedHandler(deps: {
  eventRouter: EventRouter;
  jobQueue: JobQueue;
  githubApp: GitHubApp;
  workspaceManager: WorkspaceManager;
  issueStore: IssueStore;
  embeddingProvider: EmbeddingProvider;
  sql: Sql;
  logger: Logger;
}): void;
```

From src/handlers/mention-types.ts:
```typescript
export function containsMention(body: string | null | undefined, acceptedHandles: string[]): boolean;
export function stripMention(body: string, acceptedHandles: string[]): string;
export function normalizeIssueComment(payload: IssueCommentCreatedEvent): MentionEvent;
```

From src/lib/sanitizer.ts:
```typescript
export function sanitizeOutgoingMentions(body: string, handles: string[]): string;
```

From src/execution/config.ts:
```typescript
export function loadRepoConfig(params: {
  githubApp: GitHubApp;
  workspaceManager: WorkspaceManager;
  owner: string;
  repo: string;
  ref?: string;
  logger: Logger;
}): Promise<RepoConfig>;
// RepoConfig has .triage.troubleshooting: TroubleshootingConfig
```

From src/webhook/types.ts:
```typescript
export interface EventRouter {
  register(eventKey: string, handler: (event: WebhookEvent) => Promise<void>): void;
  dispatch(event: WebhookEvent): Promise<void>;
}

export interface WebhookEvent {
  id: string;
  name: string;
  payload: unknown;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create troubleshooting handler with synthesis, citations, and comment formatting</name>
  <files>src/handlers/troubleshooting-agent.ts, src/handlers/troubleshooting-agent.test.ts</files>
  <action>
**1a. Create `src/handlers/troubleshooting-agent.ts`**

Follow the `createIssueOpenedHandler` factory pattern from `src/handlers/issue-opened.ts`.

**Exports:**
- `createTroubleshootingHandler(deps)` — factory function (the only export the wiring needs)
- `buildTroubleshootingSynthesisPrompt(...)` — exported for testing
- `formatTroubleshootingComment(...)` — exported for testing

**Deps type (following issue-opened.ts pattern):**
```typescript
export function createTroubleshootingHandler(deps: {
  eventRouter: EventRouter;
  jobQueue: JobQueue;
  githubApp: GitHubApp;
  workspaceManager: WorkspaceManager;
  issueStore: IssueStore;
  wikiPageStore?: WikiPageStore;
  embeddingProvider: EmbeddingProvider;
  taskRouter: TaskRouter;
  costTracker?: CostTracker;
  sql: Sql;
  logger: Logger;
}): void
```

**Registration:**
```typescript
deps.eventRouter.register("issue_comment.created", handleTroubleshootingMention);
```

**`handleTroubleshootingMention(event: WebhookEvent)` flow** (async, inside factory closure):

1. **Extract payload** — cast `event.payload` as `IssueCommentCreatedEvent` (from `@octokit/webhooks-types`). Extract `issue`, `comment`, `repository`. Bail if missing.

2. **Skip PRs** — If `payload.issue.pull_request` is truthy, return (troubleshooting is issues only).

3. **Skip closed issues** — If `payload.issue.state !== "open"`, return.

4. **Check for @kodiai mention** — Use `containsMention(comment.body, [appSlug])` where `appSlug` is derived from `deps.githubApp.getSlug()` (same pattern as mention handler). If no mention, return.

5. **Skip bot self-mentions** — If `comment.user.type === "Bot"`, return.

6. **Strip mention and classify intent** — `const mentionText = stripMention(comment.body, [appSlug])`. Call `classifyTroubleshootingIntent({ mentionText, issueTitle: issue.title, issueBody: issue.body })`. If false, return (not troubleshooting intent, let mention handler handle it).

7. **Load repo config** — Use `loadRepoConfig({ githubApp, workspaceManager, owner, repo: repoName, logger })`. The config loading requires a workspace clone (same pattern as issue-opened.ts).

8. **Check config gate** (TSHOOT-07) — If `!config.triage.troubleshooting.enabled`, return silently.

9. **Get Octokit** — `const octokit = await deps.githubApp.getInstallationOctokit(owner, repoName)`.

10. **Marker dedup check** (TSHOOT-08) — List existing comments on the issue: `const { data: comments } = await octokit.rest.issues.listComments({ owner, repo: repoName, issue_number: issue.number })`. Call `hasTroubleshootMarker(comments, comment.id)`. If true, return (already handled this trigger comment).

11. **Retrieve troubleshooting context** — Call `retrieveTroubleshootingContext({ issueStore, wikiPageStore, embeddingProvider, repo: fullRepo, queryTitle: issue.title, queryBody: issue.body, config: config.triage.troubleshooting, logger })`. If null (no matches found), return silently (Pitfall 5 from research).

12. **Synthesize guidance** — Build prompt via `buildTroubleshootingSynthesisPrompt(result, issue.title, issue.body)`. Resolve model: `const resolved = deps.taskRouter.resolve(TASK_TYPES.TROUBLESHOOTING_SYNTHESIS)`. Call `generateWithFallback({ taskType: TASK_TYPES.TROUBLESHOOTING_SYNTHESIS, resolved, prompt, system: "You are a troubleshooting assistant for a software project. Synthesize actionable guidance from the provided resolved issues and wiki pages. Be concise and specific. Do not invent solutions not grounded in the sources.", costTracker: deps.costTracker, repo: fullRepo, deliveryId: event.id, logger })`.

13. **Format comment** — Call `formatTroubleshootingComment({ synthesizedGuidance: genResult.text, result, marker: buildTroubleshootMarker(fullRepo, issue.number, comment.id) })`.

14. **Sanitize outgoing mentions** — Apply `sanitizeOutgoingMentions(commentBody, [appSlug])` to prevent notification loops (Pitfall 4 from research).

15. **Post comment** — `await octokit.rest.issues.createComment({ owner, repo: repoName, issue_number: issue.number, body: sanitizedBody })`.

16. **Log success** — Log with `{ issueNumber, triggerCommentId: comment.id, matchCount: result.matches.length, wikiCount: result.wikiResults.length, model: genResult.model, durationMs: genResult.durationMs }`.

Wrap the entire handler in try/catch. On error, log at `error` level with context but do NOT throw (fail-open philosophy — do not break the event router).

**`buildTroubleshootingSynthesisPrompt(result, queryTitle, queryBody)` function:**

Follow the research code example exactly. Build a multi-section prompt:
- "## Current Issue" with title and truncated body (first 1000 chars)
- "## Similar Resolved Issues" — for each match: issue number, title, match percentage, truncated body, resolution comments (tailComments), relevant discussion (semanticComments)
- "## Related Wiki Pages" — for each wiki result: title, truncated content
- "## Instructions" — 6 numbered instructions per research example (synthesize 3-8 bullets, focus on actionable steps, reference issue numbers, mention wiki, do NOT invent, keep under 500 words)

Return joined lines.

**`formatTroubleshootingComment(params)` function** (TSHOOT-05):

```typescript
export function formatTroubleshootingComment(params: {
  synthesizedGuidance: string;
  result: TroubleshootingResult;
  marker: string;
}): string
```

Format:
1. `## Troubleshooting Guidance` header
2. Empty line + synthesized guidance text
3. Empty line
4. If matches exist: collapsible `<details><summary>Sources</summary>` with markdown table:
   `| Issue | Title | Match |` with rows `| #N | Title | XX% |`
5. If wiki results exist (inside or after the details block): bullet list `- Wiki: {title}`
6. Close `</details>` if opened
7. Empty line
8. Provenance footer: `> This guidance was synthesized from similar resolved issues. It may not directly apply to your situation.`
9. Empty line
10. HTML marker comment

**1b. Create `src/handlers/troubleshooting-agent.test.ts`** with tests:

Test `buildTroubleshootingSynthesisPrompt`:
- Includes issue title in "Current Issue" section
- Includes match issue numbers and similarity percentages
- Includes tail comments as "Resolution comments"
- Includes wiki page titles when present
- Includes instruction section

Test `formatTroubleshootingComment`:
- Includes "## Troubleshooting Guidance" header
- Includes citation table with issue numbers and match percentages
- Wraps citations in `<details>` tag
- Includes provenance disclosure quote
- Includes HTML marker at end
- Handles empty matches (wiki-only result)
- Handles empty wiki results (issues-only result)

Create mock `TroubleshootingResult` objects for tests with 2-3 matches and 1 wiki result.

Use `describe`/`it` with `expect` (bun:test). File should have ~100-150 lines.
  </action>
  <verify>
    bun test src/handlers/troubleshooting-agent.test.ts
    bun build src/handlers/troubleshooting-agent.ts --no-bundle 2>&1 | head -5
  </verify>
  <done>
    createTroubleshootingHandler factory function registers on issue_comment.created.
    Handler flow: skip PRs -> skip closed -> check mention -> classify intent -> config gate -> marker dedup -> retrieve context -> synthesize -> format -> sanitize -> post.
    formatTroubleshootingComment includes citations table in collapsible details and provenance disclosure.
    sanitizeOutgoingMentions applied before posting.
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire troubleshooting handler in src/index.ts</name>
  <files>src/index.ts</files>
  <action>
**2a. Add import** at the top of `src/index.ts` (near line 21, after the `createIssueOpenedHandler` import):

```typescript
import { createTroubleshootingHandler } from "./handlers/troubleshooting-agent.ts";
```

**2b. Add handler wiring** after the `createIssueOpenedHandler` block (after line ~491, inside the `if (issueStore && embeddingProvider)` block or as a separate block right after it):

```typescript
if (issueStore && embeddingProvider) {
  createTroubleshootingHandler({
    eventRouter,
    jobQueue,
    githubApp,
    workspaceManager,
    issueStore,
    wikiPageStore,
    embeddingProvider,
    taskRouter,
    costTracker,
    sql,
    logger,
  });
}
```

Note: `taskRouter` is the main one created at line ~256 (not the staleness-specific one). `costTracker` is at line ~98. `wikiPageStore` is at line ~196. All deps are available at the wiring point.

If the existing `createIssueOpenedHandler` block already has the `if (issueStore && embeddingProvider)` guard, add the troubleshooting handler inside the same block or immediately after it with the same guard. Do NOT nest it inside the issue-opened handler block — it should be a sibling call.
  </action>
  <verify>
    bun build src/index.ts --no-bundle 2>&1 | head -10
  </verify>
  <done>
    src/index.ts imports createTroubleshootingHandler.
    Handler is wired with all required deps (eventRouter, jobQueue, githubApp, workspaceManager, issueStore, wikiPageStore, embeddingProvider, taskRouter, costTracker, sql, logger).
    Guarded by issueStore && embeddingProvider check.
    Compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/handlers/troubleshooting-agent.test.ts` — all tests pass
2. `bun build src/handlers/troubleshooting-agent.ts --no-bundle` — compiles clean
3. `bun build src/index.ts --no-bundle` — compiles clean (handler wired correctly)
4. Grep confirms `createTroubleshootingHandler` in src/index.ts
5. Grep confirms `sanitizeOutgoingMentions` used in troubleshooting-agent.ts
6. Grep confirms `retrieveTroubleshootingContext` called in troubleshooting-agent.ts
7. Grep confirms provenance text "synthesized from similar resolved issues" in troubleshooting-agent.ts
8. Grep confirms `TROUBLESHOOT_MARKER_PREFIX` used for comment-scoped dedup
</verification>

<success_criteria>
- Handler registers on issue_comment.created alongside mention handler (independent parallel handler, Option A from research)
- Troubleshooting intent mentions produce synthesized guidance citing resolved issues with provenance
- Config gate triage.troubleshooting.enabled prevents responses when disabled
- Comment-scoped marker dedup prevents duplicate responses per trigger comment
- Outgoing mentions sanitized before posting
- No matches = silent bail (no comment posted)
- Handler wired in src/index.ts with all deps
</success_criteria>

<output>
After completion, create `.planning/111-troubleshooting-agent/111-02-SUMMARY.md`
</output>
