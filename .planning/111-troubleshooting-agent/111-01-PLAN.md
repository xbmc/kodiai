---
phase: 111-troubleshooting-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/troubleshooting-intent.ts
  - src/handlers/troubleshooting-intent.test.ts
  - src/llm/task-types.ts
autonomous: true
requirements: [TSHOOT-06, TSHOOT-07, TSHOOT-08]

must_haves:
  truths:
    - "classifyTroubleshootingIntent returns true only when both problem keywords appear in issue context AND help keywords appear in mention text"
    - "classifyTroubleshootingIntent returns false for general questions like 'help me understand this code'"
    - "buildTroubleshootMarker produces an HTML comment keyed by repo, issueNumber, and triggerCommentId"
    - "hasTroubleshootMarker correctly detects existing markers for a specific trigger comment ID"
    - "TASK_TYPES.TROUBLESHOOTING_SYNTHESIS is registered as a non-agentic task type"
  artifacts:
    - path: "src/handlers/troubleshooting-intent.ts"
      provides: "Intent classifier, marker builder, marker checker"
      exports: ["classifyTroubleshootingIntent", "TROUBLESHOOT_MARKER_PREFIX", "buildTroubleshootMarker", "hasTroubleshootMarker"]
    - path: "src/handlers/troubleshooting-intent.test.ts"
      provides: "Unit tests for intent classification and marker functions"
      contains: "classifyTroubleshootingIntent"
    - path: "src/llm/task-types.ts"
      provides: "troubleshooting.synthesis task type added to TASK_TYPES"
      contains: "TROUBLESHOOTING_SYNTHESIS"
  key_links:
    - from: "src/handlers/troubleshooting-intent.ts"
      to: "src/handlers/mention-types.ts"
      via: "Uses same mention text parsing conventions (stripMention output)"
      pattern: "mentionText"
    - from: "src/llm/task-types.ts"
      to: "src/llm/task-router.ts"
      via: "Task type resolved by TaskRouter for generateWithFallback"
      pattern: "troubleshooting.synthesis"
---

<objective>
Create the troubleshooting intent classifier (keyword heuristics), comment-scoped marker dedup functions, and register the troubleshooting.synthesis task type. This is the pure logic layer with no handler wiring or LLM calls.

Purpose: Phase 111's handler (plan 02) needs these building blocks to gate troubleshooting activation, prevent duplicate responses, and route LLM synthesis through the task router.

Output: `src/handlers/troubleshooting-intent.ts` with exported pure functions, unit tests, and updated task-types.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v0.23-ROADMAP.md
@.planning/111-troubleshooting-agent/111-RESEARCH.md
@.planning/110-troubleshooting-retrieval-foundation/110-01-SUMMARY.md

@src/handlers/mention-types.ts
@src/llm/task-types.ts
@src/triage/triage-comment.ts

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/handlers/mention-types.ts:
```typescript
export interface MentionEvent {
  surface: "issue_comment" | "pr_comment" | "pr_review_comment" | "pr_review_body";
  owner: string;
  repo: string;
  issueNumber: number;
  commentId: number;
  commentBody: string;
  commentAuthor: string;
  issueBody: string | null;
  // ... other fields
}

export function containsMention(body: string | null | undefined, acceptedHandles: string[]): boolean;
export function stripMention(body: string, acceptedHandles: string[]): string;
```

From src/llm/task-types.ts:
```typescript
export const TASK_TYPES = {
  REVIEW_FULL: "review.full",
  REVIEW_SUMMARY: "review.summary",
  MENTION_RESPONSE: "mention.response",
  SLACK_RESPONSE: "slack.response",
  CLUSTER_LABEL: "cluster.label",
  STALENESS_EVIDENCE: "staleness.evidence",
} as const;

export type TaskType = (typeof TASK_TYPES)[keyof typeof TASK_TYPES];

export const AGENTIC_TASK_TYPES: Set<string> = new Set([
  TASK_TYPES.REVIEW_FULL,
  TASK_TYPES.MENTION_RESPONSE,
  TASK_TYPES.SLACK_RESPONSE,
]);
```

From src/triage/triage-comment.ts (marker pattern to follow):
```typescript
export const TRIAGE_MARKER_PREFIX = "kodiai:triage";

export function buildTriageMarker(repo: string, issueNumber: number): string {
  return `<!-- ${TRIAGE_MARKER_PREFIX}:${repo}:${issueNumber} -->`;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create intent classifier and comment-scoped marker dedup</name>
  <files>src/handlers/troubleshooting-intent.ts, src/handlers/troubleshooting-intent.test.ts</files>
  <action>
**1a. Create `src/handlers/troubleshooting-intent.ts`** with the following exports:

**`classifyTroubleshootingIntent(params)`** — Pure function, no LLM call (TSHOOT-06).

```typescript
export function classifyTroubleshootingIntent(params: {
  mentionText: string;    // Comment body after stripping @kodiai mention
  issueTitle: string;
  issueBody: string | null;
}): boolean
```

Uses two keyword lists with compound heuristic (require signal from BOTH):

1. `PROBLEM_KEYWORDS` — checked against issue title + body (the "context"):
   `"crash", "error", "bug", "broken", "fail", "not working", "doesn't work", "does not work", "won't start", "will not", "exception", "segfault", "hang", "freeze", "timeout", "undefined", "null pointer", "stack trace", "panic"`

2. `HELP_KEYWORDS` — checked against mention text (the "request"):
   `"troubleshoot", "debug", "diagnose", "help", "how to fix", "any ideas", "suggestions", "workaround", "similar issue", "same problem", "has anyone", "known issue", "what could cause", "why is", "why does"`

Logic:
- `contextLower = (issueTitle + " " + (issueBody ?? "")).toLowerCase()`
- `mentionLower = mentionText.toLowerCase()`
- `hasProblemInContext = PROBLEM_KEYWORDS.some(k => contextLower.includes(k))`
- `hasHelpInMention = HELP_KEYWORDS.some(k => mentionLower.includes(k))`
- Return `hasProblemInContext && hasHelpInMention`

Export the keyword arrays as well (for testability): `export const PROBLEM_KEYWORDS` and `export const HELP_KEYWORDS`.

**`TROUBLESHOOT_MARKER_PREFIX`** — String constant: `"kodiai:troubleshoot"`

**`buildTroubleshootMarker(repo, issueNumber, triggerCommentId)`** — Returns HTML comment marker keyed by trigger comment ID (TSHOOT-08):
```typescript
export function buildTroubleshootMarker(repo: string, issueNumber: number, triggerCommentId: number): string {
  return `<!-- ${TROUBLESHOOT_MARKER_PREFIX}:${repo}:${issueNumber}:comment-${triggerCommentId} -->`;
}
```

**`hasTroubleshootMarker(comments, triggerCommentId)`** — Scans existing comments for a marker matching this specific trigger comment ID:
```typescript
export function hasTroubleshootMarker(
  comments: Array<{ body?: string | null }>,
  triggerCommentId: number,
): boolean {
  const needle = `comment-${triggerCommentId}`;
  return comments.some(
    (c) => c.body?.includes(needle) && c.body?.includes(TROUBLESHOOT_MARKER_PREFIX)
  );
}
```

**1b. Create `src/handlers/troubleshooting-intent.test.ts`** with tests:

Intent classifier tests:
- Returns true when issue title has "error" and mention has "help" -> true
- Returns true when issue body has "not working" and mention has "how to fix" -> true
- Returns false when mention has help keyword but issue context has no problem keyword -> false
- Returns false when issue has problem keyword but mention has no help keyword -> false
- Returns false for general question: issue title "Add dark mode", mention "help me understand this code" -> false
- Returns true for: issue title "App crash on startup", mention "any ideas what could cause this?" -> true
- Case insensitive: issue title "ERROR in build", mention "Help debug" -> true
- Null issue body handled: issue body null, title has "error", mention has "help" -> true

Marker tests:
- buildTroubleshootMarker produces correct format with comment ID
- hasTroubleshootMarker returns true when matching marker exists
- hasTroubleshootMarker returns false when no marker exists
- hasTroubleshootMarker returns false when marker exists for different comment ID
- hasTroubleshootMarker handles null/undefined body in comments

Use `describe`/`it` with `expect` (bun:test). File should have ~80-120 lines.
  </action>
  <verify>
    bun test src/handlers/troubleshooting-intent.test.ts
  </verify>
  <done>
    classifyTroubleshootingIntent returns true only for compound matches (problem in context + help in mention).
    Returns false for general questions lacking problem context.
    Marker functions produce comment-scoped HTML markers keyed by triggerCommentId.
    hasTroubleshootMarker correctly differentiates between comment IDs.
    All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add troubleshooting.synthesis task type</name>
  <files>src/llm/task-types.ts</files>
  <action>
Add `TROUBLESHOOTING_SYNTHESIS` to the `TASK_TYPES` object in `src/llm/task-types.ts`:

```typescript
export const TASK_TYPES = {
  REVIEW_FULL: "review.full",
  REVIEW_SUMMARY: "review.summary",
  MENTION_RESPONSE: "mention.response",
  SLACK_RESPONSE: "slack.response",
  CLUSTER_LABEL: "cluster.label",
  STALENESS_EVIDENCE: "staleness.evidence",
  /** Troubleshooting guidance synthesis (non-agentic, Phase 111). */
  TROUBLESHOOTING_SYNTHESIS: "troubleshooting.synthesis",
} as const;
```

Do NOT add `troubleshooting.synthesis` to `AGENTIC_TASK_TYPES`. It is non-agentic (stateless text generation via `generateWithFallback`, no MCP tools or workspace needed).
  </action>
  <verify>
    bun build src/llm/task-types.ts --no-bundle 2>&1 | head -5
  </verify>
  <done>
    TASK_TYPES.TROUBLESHOOTING_SYNTHESIS equals "troubleshooting.synthesis".
    Not in AGENTIC_TASK_TYPES set.
    isAgenticTaskType("troubleshooting.synthesis") returns false.
  </done>
</task>

</tasks>

<verification>
1. `bun test src/handlers/troubleshooting-intent.test.ts` — all tests pass
2. `bun build src/handlers/troubleshooting-intent.ts --no-bundle` — compiles clean
3. `bun build src/llm/task-types.ts --no-bundle` — compiles clean
4. Grep confirms `TROUBLESHOOT_MARKER_PREFIX` exported from troubleshooting-intent.ts
5. Grep confirms `troubleshooting.synthesis` NOT in AGENTIC_TASK_TYPES
</verification>

<success_criteria>
- classifyTroubleshootingIntent uses compound keyword heuristic (problem in context + help in mention)
- Marker functions use comment-scoped keys (triggerCommentId), not per-issue
- TROUBLESHOOTING_SYNTHESIS task type registered as non-agentic
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/111-troubleshooting-agent/111-01-SUMMARY.md`
</output>
