---
milestone: v0.18
audited: 2026-02-25
status: gaps_found
scores:
  requirements: 15/19
  phases: 3/3
  integration: 11/14
  flows: 4/6
gaps:
  requirements:
    - id: "KI-12"
      status: "partial"
      phase: "Phase 90"
      claimed_by_plans: ["90-03-PLAN.md"]
      completed_by_plans: ["90-03-SUMMARY.md"]
      verification_status: "missing"
      evidence: "Wiki retrieval wired in retrieval.ts and works for PR review + Slack. Mention handler (mention.ts:1194-1212) discards wikiKnowledge — bot cannot answer architecture questions with wiki citations via @mention flow."
    - id: "KI-14"
      status: "partial"
      phase: "Phase 91"
      claimed_by_plans: ["91-01-PLAN.md"]
      completed_by_plans: ["91-01-SUMMARY.md"]
      verification_status: "missing"
      evidence: "Hybrid search works for review_comments and wiki_pages corpora. Code/learning_memories corpus runs vector-only because memoryStore not passed to createRetriever() in index.ts:185-203. KI-14 says 'per corpus' — 2/3 satisfied."
    - id: "KI-11"
      status: "partial"
      phase: "Phase 90"
      claimed_by_plans: ["90-03-PLAN.md"]
      completed_by_plans: ["90-03-SUMMARY.md"]
      verification_status: "missing"
      evidence: "Wiki corpus IS available via retrieval.ts fan-out. But mention handler (primary question-answering surface) discards wiki results — functional only on PR review and Slack surfaces."
    - id: "KI-13"
      status: "partial"
      phase: "Phase 91"
      claimed_by_plans: ["91-03-PLAN.md"]
      completed_by_plans: ["91-03-SUMMARY.md"]
      verification_status: "missing"
      evidence: "Single retrieval call does fan out to all three corpora. Code BM25 degraded (vector-only). Mention handler discards unified output. PR review retry path drops unified context. Primary path works correctly."
  integration:
    - from: "mention.ts"
      to: "retrieval.ts unified output"
      issue: "Mention handler (lines 1194-1212) reads only result.findings (legacy code memories) and discards unifiedResults, contextWindow, wikiKnowledge, reviewPrecedents. mention-prompt.ts has no parameters for unified context."
      severity: "HIGH"
      affected_requirements: ["KI-11", "KI-12", "KI-13", "KI-16", "KI-17", "KI-18"]
    - from: "review.ts retry path"
      to: "buildReviewPrompt"
      issue: "Retry buildReviewPrompt call (line 3277) omits wikiKnowledge, unifiedResults, contextWindow. Only reviewPrecedents passed on retry."
      severity: "HIGH"
      affected_requirements: ["KI-12", "KI-13", "KI-17", "KI-18"]
    - from: "index.ts"
      to: "createRetriever"
      issue: "memoryStore (learningMemoryStore) not passed to createRetriever (line 185-203). Code corpus runs vector-only, no BM25 hybrid search."
      severity: "MEDIUM"
      affected_requirements: ["KI-13", "KI-14"]
  flows:
    - name: "@kodiai mention → wiki-boosted unified response"
      breaks_at: "mention.ts result consumption (lines 1194-1212)"
      severity: "HIGH"
    - name: "Large PR review retry → unified context preserved"
      breaks_at: "review.ts retry buildReviewPrompt call (line 3250)"
      severity: "HIGH"
tech_debt:
  - phase: 89-pr-review-comment-ingestion
    items:
      - "Backfill re-run required for existing rows with NULL embeddings (operational, not code gap)"
      - "KI-03 token window deviation: implementation uses 1024/256 vs REQUIREMENTS 512/128 (plan-locked decision)"
  - phase: 90-mediawiki-content-ingestion
    items:
      - "No VERIFICATION.md — phase was not verified during execution"
  - phase: 91-cross-corpus-retrieval-integration
    items:
      - "No VERIFICATION.md — phase was not verified during execution"
      - "No requirements-completed frontmatter in any SUMMARY.md"
      - "formatUnifiedContext edge case: returns empty string if first chunk exceeds maxContextChars"
---

# Milestone v0.18 Audit: Knowledge Ingestion

**Audited:** 2026-02-25
**Status:** gaps_found
**Milestone:** v0.18 Knowledge Ingestion (Phases 89-91)

## Requirements Coverage (3-Source Cross-Reference)

| REQ | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration | Final Status |
|-----|-------------|-----------------|---------------------|-----------------|-------------|--------------|
| KI-01 | 18mo review comments backfilled | passed (Phase 89) | listed (89-01-05) | [x] Complete | WIRED | **satisfied** |
| KI-02 | Review comment metadata | passed (Phase 89) | listed (89-01-02) | [x] Complete | WIRED | **satisfied** |
| KI-03 | Semantic chunking with windows | passed (Phase 89) | listed (89-01) | [x] Complete | WIRED | **satisfied** |
| KI-04 | Incremental sync via webhook | passed (Phase 89) | listed (89-03,05) | [x] Complete | WIRED | **satisfied** |
| KI-05 | Review corpus in retrieval.ts | passed (Phase 89) | listed (89-04,05) | [x] Complete | WIRED | **satisfied** |
| KI-06 | Bot cites review precedents | passed (Phase 89) | listed (89-04) | [x] Complete | WIRED | **satisfied** |
| KI-07 | kodi.wiki content exported | missing (no 90 VERIFICATION) | listed (90-01,02) | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-08 | HTML→markdown, section chunking | missing | listed (90-01,02) | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-09 | Wiki chunks with metadata | missing | listed (90-01,02) | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-10 | Wiki incremental sync | missing | listed (90-03) | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-11 | Wiki corpus in retrieval.ts | missing | listed (90-03) | [ ] Pending | PARTIAL | **partial** — mention discards |
| KI-12 | Bot answers with wiki citations | missing | listed (90-03) | [ ] Pending | PARTIAL | **partial** — mention discards |
| KI-13 | Single call fans out to all 3 | missing | not listed | [ ] Pending | PARTIAL | **partial** — code BM25 + mention |
| KI-14 | Hybrid BM25+vector per corpus | missing | not listed | [ ] Pending | PARTIAL | **partial** — code BM25 not wired |
| KI-15 | RRF merges ranked lists | missing | not listed | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-16 | Source-aware re-ranking | missing | not listed | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-17 | Every chunk has source label | missing | not listed | [ ] Pending | WIRED | **satisfied** (update checkbox) |
| KI-18 | Context assembly + token budget | missing | not listed | [ ] Pending | WIRED | **satisfied** (edge case noted) |
| KI-19 | Near-duplicate deduplication | missing | not listed | [ ] Pending | WIRED | **satisfied** (update checkbox) |

**Score:** 15/19 satisfied, 4/19 partial

## Phase Verification Status

| Phase | VERIFICATION.md | Status | Notes |
|-------|-----------------|--------|-------|
| 89 — PR Review Comment Ingestion | EXISTS | passed (10/10) | Re-verified after 89-05 gap closure |
| 90 — MediaWiki Content Ingestion | MISSING | unverified | All 3 plans have SUMMARY.md with requirements-completed frontmatter |
| 91 — Cross-Corpus Retrieval Integration | MISSING | unverified | All 4 plans have SUMMARY.md but no requirements-completed frontmatter |

## Integration Issues

### HIGH — Mention handler ignores unified retrieval results

**File:** `src/handlers/mention.ts` lines 1194-1212
**Affects:** KI-11, KI-12, KI-13, KI-16, KI-17, KI-18 (for mention flow)

The mention handler calls `retriever.retrieve()` with `triggerType: "question"` (correct) but reads only `result.findings` (legacy code memories) and discards `unifiedResults`, `contextWindow`, `wikiKnowledge`, and `reviewPrecedents`. The mention prompt builder also has no parameters for these fields.

**Impact:** `@kodiai` mentions asking architecture questions get code memories only — no wiki citations, no review precedents, no unified context.

### HIGH — PR review retry path drops unified context

**File:** `src/handlers/review.ts` line 3277
**Affects:** KI-12, KI-13, KI-17, KI-18 (for retry path)

The retry `buildReviewPrompt` call passes `reviewPrecedents` but omits `wikiKnowledge`, `unifiedResults`, and `contextWindow`. The primary path (lines 2298-2302) correctly passes all four.

**Impact:** Large PR reviews that trigger retry lose unified knowledge context.

### MEDIUM — Code corpus BM25 not wired

**File:** `src/index.ts` lines 185-203
**Affects:** KI-13, KI-14

`learningMemoryStore` is created (line 115) but not passed to `createRetriever()`. Code corpus runs vector-only while review and wiki get full hybrid search.

**Impact:** KI-14 "per corpus" hybrid search is 2/3 satisfied at runtime.

### LOW — formatUnifiedContext edge case

**File:** `src/execution/review-prompt.ts` line 988
**Affects:** KI-18 (edge case)

If every chunk in `unifiedResults` exceeds `maxContextChars`, `assembleContextWindow` returns `""` and `formatUnifiedContext` silently returns empty string despite non-empty results.

## Broken E2E Flows

### Flow: @kodiai mention → wiki-boosted response with citations

```
@mention received
  → mention.ts calls retriever.retrieve(triggerType: "question") ✓
  → retriever computes unifiedResults with wiki weight 1.2 ✓
  → BREAK: mention.ts reads only result.findings (code memories)
  → BREAK: unifiedResults, contextWindow, wikiKnowledge all discarded
  → Bot answers using code memories only; no wiki or review citations
```

### Flow: Large PR review retry → unified context preserved

```
PR opened (large)
  → primary path retrieves all three corpora ✓
  → primary buildReviewPrompt passes unifiedResults + contextWindow ✓
  → large PR triggers retry path
  → BREAK: retry buildReviewPrompt omits wiki + unified context
  → retry prompt loses cross-corpus knowledge
```

## Verified Complete Flows

1. **PR review primary path** — full pipeline works: 6 parallel searches → hybrid merge → RRF → dedup → context assembly → unified citations
2. **Slack flow** — `triggerType: "slack"` → retriever → contextWindow consumed correctly
3. **Review comment backfill CLI** — functional with embedding persistence (89-05 fix)
4. **Wiki backfill CLI** — functional with MediaWiki API pagination
5. **Review comment webhook sync** — registered for created/edited/deleted events
6. **Wiki scheduled sync** — 24h interval with graceful shutdown support

## Tech Debt

### Phase 89
- Backfill re-run required for rows with NULL embeddings (operational step)
- KI-03 window size: 1024/256 vs REQUIREMENTS 512/128 (plan-locked decision, documented)

### Phase 90
- No VERIFICATION.md generated during execution

### Phase 91
- No VERIFICATION.md generated during execution
- No requirements-completed frontmatter in SUMMARY.md files
- formatUnifiedContext edge case with oversized chunks

## Gap Closure Recommendations

To move from `gaps_found` to `passed`:

1. **Wire mention handler** — consume `unifiedResults`/`contextWindow` in mention.ts, update mention-prompt.ts (closes KI-11, KI-12, KI-13 mention gap)
2. **Fix review retry path** — pass `wikiKnowledge`, `unifiedResults`, `contextWindow` to retry `buildReviewPrompt` call (closes KI-12, KI-13 retry gap)
3. **Wire code BM25** — pass `memoryStore: learningMemoryStore` to `createRetriever()` in index.ts (closes KI-14)

---
_Audited: 2026-02-25_
_Auditor: Claude (gsd audit-milestone)_
