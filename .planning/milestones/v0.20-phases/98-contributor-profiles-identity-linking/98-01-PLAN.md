---
phase: 98-contributor-profiles-identity-linking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/migrations/011-contributor-profiles.sql
  - src/db/migrations/011-contributor-profiles.down.sql
  - src/contributor/types.ts
  - src/contributor/profile-store.ts
  - src/contributor/profile-store.test.ts
  - src/contributor/index.ts
autonomous: true
requirements:
  - PROF-01
  - PROF-05

must_haves:
  truths:
    - "Contributor profiles can be created with GitHub username and optional Slack user ID"
    - "Expertise entries can be stored and queried per contributor per dimension/topic"
    - "Contributors can opt out and opted-out profiles are excluded from expertise lookups"
    - "Unlinking nulls the Slack user ID but preserves expertise data"
  artifacts:
    - path: "src/db/migrations/011-contributor-profiles.sql"
      provides: "contributor_profiles and contributor_expertise tables"
      contains: "CREATE TABLE contributor_profiles"
    - path: "src/contributor/types.ts"
      provides: "ContributorProfile, ContributorExpertise, ContributorProfileStore types"
      exports: ["ContributorProfile", "ContributorExpertise", "ContributorProfileStore"]
    - path: "src/contributor/profile-store.ts"
      provides: "createContributorProfileStore factory with CRUD operations"
      exports: ["createContributorProfileStore"]
    - path: "src/contributor/profile-store.test.ts"
      provides: "Integration tests for profile store"
      min_lines: 80
  key_links:
    - from: "src/contributor/profile-store.ts"
      to: "src/db/migrations/011-contributor-profiles.sql"
      via: "SQL queries against contributor_profiles and contributor_expertise tables"
      pattern: "contributor_profiles|contributor_expertise"
    - from: "src/contributor/profile-store.ts"
      to: "src/contributor/types.ts"
      via: "implements ContributorProfileStore interface"
      pattern: "ContributorProfileStore"
---

<objective>
Create the contributor profiles schema, types, and data store -- the foundation for identity linking, expertise tracking, and privacy controls.

Purpose: All subsequent plans depend on the profile table and store for reading/writing contributor data.
Output: Migration 011, contributor types, profile store with tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/98-contributor-profiles-identity-linking/98-CONTEXT.md
@.planning/phases/98-contributor-profiles-identity-linking/98-RESEARCH.md

@src/knowledge/store.ts (store factory pattern reference)
@src/knowledge/types.ts (existing AuthorCacheEntry, KnowledgeStore interface)
@src/db/migrations/010-llm-cost-events.sql (migration numbering reference)

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/knowledge/types.ts:
```typescript
export type AuthorCacheEntry = {
  tier: string;
  authorAssociation: string;
  prCount: number | null;
};
```

From src/knowledge/store.ts (pattern to follow):
```typescript
export function createKnowledgeStore(opts: {
  sql: Sql;
  logger: Logger;
}): KnowledgeStore {
```

Store factory pattern: `createXxxStore({ sql, logger })` returning typed interface with async methods.

Migration convention: `src/db/migrations/NNN-name.sql` with paired `NNN-name.down.sql`.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration 011 and contributor types</name>
  <files>
    src/db/migrations/011-contributor-profiles.sql
    src/db/migrations/011-contributor-profiles.down.sql
    src/contributor/types.ts
  </files>
  <action>
    Create migration `011-contributor-profiles.sql` with two tables:

    **contributor_profiles:**
    - `id BIGSERIAL PRIMARY KEY`
    - `github_username TEXT NOT NULL UNIQUE` — primary identity anchor
    - `slack_user_id TEXT UNIQUE` — nullable, set on link, nulled on unlink
    - `display_name TEXT` — human-readable name
    - `overall_tier TEXT NOT NULL DEFAULT 'newcomer'` — computed from expertise percentile: newcomer|developing|established|senior
    - `overall_score REAL NOT NULL DEFAULT 0` — aggregate expertise score
    - `opted_out BOOLEAN NOT NULL DEFAULT false` — privacy flag
    - `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
    - `updated_at TIMESTAMPTZ NOT NULL DEFAULT now()`
    - `last_scored_at TIMESTAMPTZ` — when expertise was last recalculated

    Indexes:
    - `idx_contributor_profiles_github ON contributor_profiles (github_username)`
    - `idx_contributor_profiles_slack ON contributor_profiles (slack_user_id) WHERE slack_user_id IS NOT NULL`
    - `idx_contributor_profiles_tier ON contributor_profiles (overall_tier)`

    **contributor_expertise:**
    - `id BIGSERIAL PRIMARY KEY`
    - `profile_id BIGINT NOT NULL REFERENCES contributor_profiles(id) ON DELETE CASCADE`
    - `dimension TEXT NOT NULL` — 'language' or 'file_area'
    - `topic TEXT NOT NULL` — e.g., 'TypeScript', 'src/api/'
    - `score REAL NOT NULL DEFAULT 0` — 0.0 - 1.0 normalized
    - `raw_signals INTEGER NOT NULL DEFAULT 0` — total weighted signal count
    - `last_active TIMESTAMPTZ` — most recent activity in this area
    - `created_at TIMESTAMPTZ NOT NULL DEFAULT now()`
    - `updated_at TIMESTAMPTZ NOT NULL DEFAULT now()`
    - `UNIQUE(profile_id, dimension, topic)`

    Indexes:
    - `idx_contributor_expertise_profile ON contributor_expertise (profile_id)`
    - `idx_contributor_expertise_dimension ON contributor_expertise (dimension, topic)`

    Down migration: `DROP TABLE contributor_expertise; DROP TABLE contributor_profiles;`

    Create `src/contributor/types.ts` with:
    - `ContributorTier = "newcomer" | "developing" | "established" | "senior"` type
    - `ContributorProfile` type matching the table columns (camelCase)
    - `ContributorExpertise` type matching expertise table columns (camelCase)
    - `ExpertiseDimension = "language" | "file_area"` type
    - `ContributorProfileStore` interface with methods:
      - `getByGithubUsername(username: string): Promise<ContributorProfile | null>` — excludes opted-out
      - `getBySlackUserId(slackUserId: string): Promise<ContributorProfile | null>`
      - `linkIdentity(params: { slackUserId: string; githubUsername: string; displayName: string }): Promise<ContributorProfile>`
      - `unlinkSlack(githubUsername: string): Promise<void>` — nulls slack_user_id only
      - `setOptedOut(githubUsername: string, optedOut: boolean): Promise<void>`
      - `getExpertise(profileId: number): Promise<ContributorExpertise[]>`
      - `upsertExpertise(params: { profileId: number; dimension: ExpertiseDimension; topic: string; score: number; rawSignals: number; lastActive: Date }): Promise<void>`
      - `updateTier(profileId: number, tier: ContributorTier, overallScore: number): Promise<void>`
      - `getOrCreateByGithubUsername(username: string): Promise<ContributorProfile>` — creates profile if not exists, returns existing if it does
      - `getAllScores(): Promise<{ profileId: number; overallScore: number }[]>` — for percentile tier calculation
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun run src/db/migrations/011-contributor-profiles.sql 2>/dev/null; bunx tsc --noEmit src/contributor/types.ts</automated>
  </verify>
  <done>Migration 011 creates both tables with indexes, down migration drops them. Types file exports all contributor types and the ContributorProfileStore interface.</done>
</task>

<task type="auto">
  <name>Task 2: Implement profile store and tests</name>
  <files>
    src/contributor/profile-store.ts
    src/contributor/profile-store.test.ts
    src/contributor/index.ts
  </files>
  <action>
    Create `src/contributor/profile-store.ts` implementing `ContributorProfileStore` from types.ts:
    - Follow the `createXxxStore({ sql, logger })` factory pattern from `src/knowledge/store.ts`
    - `getByGithubUsername`: SELECT WHERE github_username = $1 AND opted_out = false
    - `getBySlackUserId`: SELECT WHERE slack_user_id = $1 (do NOT filter opted_out — needed for profile command)
    - `linkIdentity`: INSERT ... ON CONFLICT (github_username) DO UPDATE SET slack_user_id, display_name, updated_at. Return the profile row.
    - `unlinkSlack`: UPDATE SET slack_user_id = NULL, updated_at = now() WHERE github_username = $1
    - `setOptedOut`: UPDATE SET opted_out = $2, updated_at = now() WHERE github_username = $1
    - `getExpertise`: SELECT FROM contributor_expertise WHERE profile_id = $1 ORDER BY score DESC
    - `upsertExpertise`: INSERT INTO contributor_expertise ... ON CONFLICT (profile_id, dimension, topic) DO UPDATE SET score, raw_signals, last_active, updated_at
    - `updateTier`: UPDATE contributor_profiles SET overall_tier = $2, overall_score = $3, last_scored_at = now(), updated_at = now() WHERE id = $1
    - `getOrCreateByGithubUsername`: Try SELECT first, if null INSERT with defaults and return
    - `getAllScores`: SELECT id as profileId, overall_score WHERE opted_out = false
    - Map DB snake_case to TS camelCase in all return values

    Create `src/contributor/profile-store.test.ts`:
    - Use the same test pattern as existing store tests (TRUNCATE CASCADE before each, real DB connection via DATABASE_URL)
    - Test: create profile via linkIdentity, retrieve by github username
    - Test: retrieve by slack user ID
    - Test: unlink nulls slack_user_id but profile still exists
    - Test: re-link same github username with different slack user updates the slack_user_id
    - Test: opt-out hides profile from getByGithubUsername but not from getBySlackUserId
    - Test: upsertExpertise creates and updates entries
    - Test: getOrCreateByGithubUsername creates new and returns existing

    Create `src/contributor/index.ts` barrel export:
    - Re-export from `./types.ts` and `./profile-store.ts`
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && bun test src/contributor/profile-store.test.ts</automated>
  </verify>
  <done>Profile store implements all ContributorProfileStore methods. Tests pass against real PostgreSQL. Barrel export exposes all types and the factory.</done>
</task>

</tasks>

<verification>
- Migration 011 runs cleanly (up and down)
- `bunx tsc --noEmit` passes with no type errors in src/contributor/
- All profile store tests pass
- ContributorProfileStore interface covers all CRUD needed by later plans
</verification>

<success_criteria>
- contributor_profiles and contributor_expertise tables exist in migration 011
- Profile store factory follows project conventions (postgres.js tagged templates, { sql, logger } deps)
- Opt-out flag works: getByGithubUsername excludes opted-out, getBySlackUserId does not
- All 7+ integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/98-contributor-profiles-identity-linking/98-01-SUMMARY.md`
</output>
