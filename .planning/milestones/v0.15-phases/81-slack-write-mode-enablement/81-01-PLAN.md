---
phase: 81-slack-write-mode-enablement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/write-intent.ts
  - src/slack/write-intent.test.ts
  - src/slack/assistant-handler.ts
  - src/slack/assistant-handler.test.ts
autonomous: true

must_haves:
  truths:
    - "Slack messages with explicit write prefixes (apply:/change:/plan:) route deterministically into write-capable intent handling"
    - "Conversational Slack requests can route to write mode when medium-confidence thresholds are met, while ambiguous asks remain read-only"
    - "Ambiguous write intent always returns a read-only response with an exact quick-action rerun command"
    - "High-impact write asks are flagged for confirmation while lower-impact writes proceed without mandatory confirmation"
  artifacts:
    - path: "src/slack/write-intent.ts"
      provides: "Slack write-intent parsing, confidence scoring, high-impact classification, and rerun prompt builder"
      contains: "apply:|change:|plan:|medium|high-impact"
    - path: "src/slack/assistant-handler.ts"
      provides: "Slack routing branch that consumes write-intent decisions before execution"
      contains: "clarification_required|confirmation_required|write"
    - path: "src/slack/write-intent.test.ts"
      provides: "Deterministic regression coverage for explicit, conversational, and ambiguous intent cases"
      contains: "medium-confidence"
  key_links:
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/write-intent.ts"
      via: "Assistant flow resolves write intent before choosing read-only vs write-capable handling"
      pattern: "resolveSlackWriteIntent"
    - from: "src/slack/write-intent.ts"
      to: "src/slack/assistant-handler.ts"
      via: "Ambiguous intent path returns exact rerun command text for thread reply"
      pattern: "apply: <same request>|change: <same request>"
---

<objective>
Define and wire Slack write-intent routing so explicit prefixes and medium-confidence conversational asks can enter write mode safely, while ambiguous asks stay read-only with a deterministic retry affordance.

Purpose: Phase 81 requires write-capable Slack routing without sacrificing deterministic safety when user intent is unclear.
Output: Intent-classification module, assistant routing integration, and tests locking prefix/conversational/ambiguous behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/81-slack-write-mode-enablement/81-CONTEXT.md
@.planning/phases/79-slack-read-only-assistant-routing/79-01-SUMMARY.md
@.planning/phases/79-slack-read-only-assistant-routing/79-02-SUMMARY.md
@src/slack/assistant-handler.ts
@src/slack/repo-context.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Slack write-intent classifier with medium-confidence and high-impact heuristics</name>
  <files>src/slack/write-intent.ts, src/slack/write-intent.test.ts</files>
  <action>
Create a dedicated Slack write-intent module that honors locked Phase 81 decisions:

- Support explicit prefixes `apply:`, `change:`, and `plan:` as direct write-intent signals.
- Add conversational intent detection with a medium-confidence threshold (implement as deterministic scored heuristics, not model inference).
- Define high-impact criteria for confirmation-required runs (Claude discretion) and encode them as explicit, test-covered rules. Minimum criteria must include destructive scope signals (delete/rename/migration/security-sensitive) and broad blast-radius cues.
- Choose and codify a default confirmation timeout duration constant (Claude discretion) for later gate handling.
- Define exact ambiguous-intent quick-action wording (Claude discretion) that keeps execution read-only and gives a one-step rerun command.
- Keep detection deterministic and side-effect free; do not call external services.
  </action>
  <verify>
Run `bun test ./src/slack/write-intent.test.ts --timeout 30000`.
  </verify>
  <done>
Intent classification returns one deterministic outcome per Slack message (read-only, write, or ambiguous-read-only with rerun command) with explicit high-impact tagging for confirmation gates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire assistant routing to use write-intent outcomes before execution</name>
  <files>src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Integrate the new intent classifier into Slack assistant routing:

- Resolve write intent before workspace/executor invocation.
- Preserve prefix behavior exactly: `apply:`, `change:`, `plan:` must route to write-capable handling paths.
- For ambiguous conversational asks, do not execute writes; publish read-only guidance plus the exact quick-action rerun command in-thread.
- Keep repo targeting behavior compatible with any app-accessible `owner/repo` override when explicitly supplied.
- Extend tests to lock explicit-prefix, conversational-medium-confidence, ambiguous fallback, and no-regression read-only paths.
- Do not implement PR publish or confirmation execution in this task; this task is routing-only.
  </action>
  <verify>
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
Run `bun test ./src/slack/v1-safety-contract.test.ts --timeout 30000`.
  </verify>
  <done>
Slack assistant routing deterministically selects write-capable vs read-only behavior from intent outcomes, and ambiguous intent no longer risks accidental write execution.
  </done>
</task>

</tasks>

<verification>
- Prefix and conversational intent paths are test-covered with deterministic outcomes.
- Ambiguous intent path always replies read-only with exact rerun command text.
- Existing Slack v1 rails remain green after routing changes.
</verification>

<success_criteria>
Slack can recognize write intent from both explicit prefixes and medium-confidence conversational asks while refusing ambiguous writes safely with actionable rerun guidance.
</success_criteria>

<output>
After completion, create `.planning/phases/81-slack-write-mode-enablement/81-01-SUMMARY.md`
</output>
