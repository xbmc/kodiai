---
phase: 90-mediawiki-content-ingestion
plan: 03
type: execute
wave: 3
depends_on: [90-01, 90-02]
files_modified:
  - src/knowledge/wiki-sync.ts
  - src/knowledge/wiki-sync.test.ts
  - src/knowledge/wiki-retrieval.ts
  - src/knowledge/wiki-retrieval.test.ts
  - src/knowledge/retrieval.ts
  - src/knowledge/retrieval.test.ts
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/knowledge/index.ts
  - src/index.ts
autonomous: true
requirements: [KI-10, KI-11, KI-12]

must_haves:
  truths:
    - "Daily scheduled sync detects changed kodi.wiki pages via RecentChanges API and re-ingests them"
    - "Wiki corpus is searchable via the existing createRetriever() pipeline alongside learning memories and review comments"
    - "Wiki retrieval results include source attribution: page title, section heading, URL with anchor, last modified date"
    - "Bot can answer architecture/feature questions with wiki citations formatted as inline links"
    - "Citation format includes freshness indicator: [Wiki] Page Title > Section (updated YYYY-MM)"
    - "Wiki retrieval is fail-open: errors degrade gracefully without blocking review"
  artifacts:
    - path: "src/knowledge/wiki-sync.ts"
      provides: "Scheduled sync using MediaWiki RecentChanges API with setInterval-based scheduling"
      contains: "createWikiSyncScheduler"
    - path: "src/knowledge/wiki-retrieval.ts"
      provides: "Wiki search function that integrates with existing retrieval pipeline"
      contains: "searchWikiPages"
    - path: "src/knowledge/retrieval.ts"
      provides: "Updated retriever that fans out to wiki corpus alongside learning memories and review comments"
      contains: "wikiPageStore"
    - path: "src/execution/review-prompt.ts"
      provides: "Updated prompt builder that formats wiki citations with inline links and freshness indicator"
      contains: "Wiki Knowledge"
  key_links:
    - from: "src/knowledge/wiki-sync.ts"
      to: "src/knowledge/wiki-store.ts"
      via: "Sync uses store to write updated chunks and track sync state"
      pattern: "replacePageChunks|getSyncState|updateSyncState"
    - from: "src/knowledge/wiki-retrieval.ts"
      to: "src/knowledge/wiki-store.ts"
      via: "Search function uses store's searchByEmbedding method"
      pattern: "searchByEmbedding|WikiPageStore"
    - from: "src/knowledge/retrieval.ts"
      to: "src/knowledge/wiki-retrieval.ts"
      via: "Retriever calls searchWikiPages() in parallel with other corpus searches"
      pattern: "searchWikiPages|wikiPages"
    - from: "src/execution/review-prompt.ts"
      to: "src/knowledge/retrieval.ts"
      via: "Prompt builder receives wiki results and formats as inline citations"
      pattern: "wikiKnowledge|Wiki Knowledge"
    - from: "src/index.ts"
      to: "src/knowledge/wiki-sync.ts"
      via: "Scheduler started during application init"
      pattern: "createWikiSyncScheduler"
---

<objective>
Implement daily incremental sync for kodi.wiki changes and wire wiki corpus into the retrieval pipeline with citation formatting.

Purpose: Keep wiki content fresh and make it actionable -- the bot should surface wiki knowledge when answering architecture/feature questions about Kodi.
Output: Scheduled sync module, wiki retrieval search function, updated retriever pipeline, and citation formatting in review prompt.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/90-mediawiki-content-ingestion/90-01-SUMMARY.md
@.planning/phases/90-mediawiki-content-ingestion/90-02-SUMMARY.md
@src/knowledge/wiki-types.ts
@src/knowledge/wiki-store.ts
@src/knowledge/wiki-chunker.ts
@src/knowledge/wiki-backfill.ts
@src/knowledge/retrieval.ts
@src/knowledge/retrieval.test.ts
@src/knowledge/review-comment-retrieval.ts
@src/knowledge/types.ts
@src/execution/review-prompt.ts
@src/execution/review-prompt.test.ts
@src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement scheduled wiki sync and wiki retrieval search module</name>
  <files>src/knowledge/wiki-sync.ts, src/knowledge/wiki-sync.test.ts, src/knowledge/wiki-retrieval.ts, src/knowledge/wiki-retrieval.test.ts</files>
  <action>
**Scheduled sync (`wiki-sync.ts`):**

Create an in-process scheduled sync using `setInterval` (per user decision: daily sync frequency, no external scheduler needed).

```typescript
export type WikiSyncSchedulerOptions = {
  store: WikiPageStore;
  embeddingProvider: EmbeddingProvider;
  source: string;           // e.g. "kodi.wiki"
  baseUrl?: string;         // Default: "https://kodi.wiki"
  intervalMs?: number;      // Default: 24 * 60 * 60 * 1000 (24 hours)
  delayMs?: number;         // Default: 500ms between API requests
  logger: Logger;
};

export function createWikiSyncScheduler(opts: WikiSyncSchedulerOptions): {
  start: () => void;
  stop: () => void;
  syncNow: () => Promise<WikiSyncResult>;
};

export type WikiSyncResult = {
  pagesChecked: number;
  pagesUpdated: number;
  pagesDeleted: number;
  durationMs: number;
};
```

**Sync algorithm using MediaWiki RecentChanges API:**

1. Get last sync timestamp from `store.getSyncState(source)`
2. Query RecentChanges API:
   - URL: `${baseUrl}/w/api.php?action=query&list=recentchanges&rcprop=title|ids|timestamp|sizes&rclimit=500&rcend=${lastSyncedAt}&format=json`
   - This returns all changes since `lastSyncedAt` (or all if first sync)
   - Paginate using `rccontinue` token
3. For each changed page:
   a. Fetch current page content via `action=parse` (same as backfill)
   b. Build `WikiPageInput`
   c. Call `chunkWikiPage()` -- may return empty (page deleted or became redirect)
   d. If chunks empty AND page existed: `store.softDeletePage(pageId)` (per user decision: delete old chunks, re-chunk entirely)
   e. If chunks non-empty: embed each chunk, then `store.replacePageChunks(pageId, chunks)` (per user decision: no section-level diffing)
   f. Apply rate delay between requests
4. Update sync state with new timestamp
5. Return `WikiSyncResult`

The scheduler:
- `start()`: sets up `setInterval` with `intervalMs` delay, runs first sync immediately after a 60-second startup delay
- `stop()`: clears the interval (for graceful shutdown)
- `syncNow()`: triggers sync immediately (for testing/CLI)

**Wiki retrieval module (`wiki-retrieval.ts`):**

Create following the same pattern as `review-comment-retrieval.ts`:

```typescript
export type WikiKnowledgeMatch = {
  chunkText: string;
  rawText: string;
  distance: number;
  pageId: number;
  pageTitle: string;
  namespace: string;
  pageUrl: string;
  sectionHeading: string | null;
  sectionAnchor: string | null;
  lastModified: string | null;
  source: "wiki";           // Source attribution tag
};

export async function searchWikiPages(opts: {
  store: WikiPageStore;
  embeddingProvider: EmbeddingProvider;
  query: string;
  topK: number;
  namespace?: string;
  distanceThreshold?: number;
  logger: Logger;
}): Promise<WikiKnowledgeMatch[]>
```

Implementation:
1. Generate embedding for query via `embeddingProvider.generate(query, "query")`
2. If embedding is null (fail-open), return empty array
3. Call `store.searchByEmbedding({ queryEmbedding, topK, namespace })`
4. Filter results by distance threshold (default 0.7, same as review comments -- tunable in Phase 91)
5. Map results to `WikiKnowledgeMatch` with source attribution
6. Build full URL with section anchor: `${pageUrl}#${sectionAnchor}` for deep linking

**Tests:**

For wiki-sync:
- Fetches recent changes from API (mocked)
- Updates changed pages by re-chunking and replacing
- Soft-deletes pages that became redirects
- Respects rate delay between requests
- Updates sync state timestamp after sync
- start()/stop() manage interval correctly

For wiki-retrieval:
- Returns matches sorted by distance
- Filters by distance threshold
- Returns empty array when embedding fails (fail-open)
- Returns empty array when store has no results
- Filters by namespace when provided
- Source attribution is always "wiki"
- URL includes section anchor for deep linking
  </action>
  <verify>
- `bun test src/knowledge/wiki-sync.test.ts` passes
- `bun test src/knowledge/wiki-retrieval.test.ts` passes
- All existing tests still pass: `bun test`
  </verify>
  <done>
- Scheduled sync detects and re-ingests changed pages daily
- Wiki retrieval module provides typed search results with source attribution
- Fail-open behavior on sync and retrieval errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire wiki corpus into retrieval pipeline and add citation formatting</name>
  <files>src/knowledge/retrieval.ts, src/knowledge/retrieval.test.ts, src/execution/review-prompt.ts, src/execution/review-prompt.test.ts, src/knowledge/index.ts, src/index.ts</files>
  <action>
**Update `createRetriever()` in `retrieval.ts`:**

Add `wikiPageStore` as optional dependency:

```typescript
export function createRetriever(deps: {
  embeddingProvider: EmbeddingProvider;
  isolationLayer: IsolationLayer;
  config: RetrieverConfig;
  reviewCommentStore?: ReviewCommentStore;
  wikiPageStore?: WikiPageStore;         // NEW optional dep
}): { retrieve: (opts: RetrieveOptions) => Promise<RetrieveResult | null> }
```

Update `RetrieveResult` to include wiki matches:

```typescript
export type RetrieveResult = {
  findings: MergedRetrievalResult[];
  snippetAnchors: SnippetAnchor[];
  reviewPrecedents: ReviewCommentMatch[];
  wikiKnowledge: WikiKnowledgeMatch[];    // NEW
  provenance: {
    queryCount: number;
    candidateCount: number;
    sharedPoolUsed: boolean;
    thresholdMethod: string;
    thresholdValue: number;
    reviewCommentCount: number;
    wikiPageCount: number;                // NEW
  };
};
```

In the `retrieve()` function, after the review comment fan-out (Step 2b), add wiki fan-out:

```typescript
// Step 2c: Fan out to wiki corpus (parallel with other retrievals)
let wikiKnowledge: WikiKnowledgeMatch[] = [];
if (deps.wikiPageStore) {
  try {
    wikiKnowledge = await searchWikiPages({
      store: deps.wikiPageStore,
      embeddingProvider: deps.embeddingProvider,
      query: opts.queries[0]!,
      topK: 5,  // Separate budget from other corpora
      logger: opts.logger,
    });
  } catch (err) {
    opts.logger.warn({ err }, "Wiki retrieval failed (fail-open)");
  }
}
```

**Update citation formatting in `review-prompt.ts`:**

Add a new function `formatWikiKnowledge(matches: WikiKnowledgeMatch[]): string`:

1. If matches is empty, return empty string (no section at all)
2. Sort by distance (best match first)
3. Limit to top 5 matches
4. For each match, format as citation per user decision:
   - Source label prefix: `[Wiki]` to distinguish from other corpora
   - Inline link with section anchor: `[Kodi > {Section Heading}](${pageUrl}#${sectionAnchor})`
   - Freshness indicator: `(updated YYYY-MM)` from lastModified date
   - Brief quote: first 200 chars at word boundary from rawText

Format example:
```
## Wiki Knowledge

The following are relevant kodi.wiki articles. Reference them when the current change
relates to documented Kodi architecture, APIs, or features. Cite with:
`Per the wiki: "quote" ([source](url))`

Only cite when directly relevant. Do not force citations.

---
- **[Wiki] Kodi > Settings > Audio** ([source](https://kodi.wiki/view/Settings/Audio#Audio_output)) (updated 2024-03):
  "Audio passthrough requires the audio device to support the encoded format..."

- **[Wiki] Kodi > VideoPlayer** ([source](https://kodi.wiki/view/VideoPlayer)) (updated 2025-01):
  "The video player pipeline consists of demuxer, decoder, and renderer stages..."
---
```

Place the Wiki Knowledge section after the Human Review Precedents section in the prompt.

**Update prompt builder integration:**

Find where `formatReviewPrecedents` is called in the prompt builder. Add `formatWikiKnowledge` call after it. The prompt builder should accept `wikiKnowledge?: WikiKnowledgeMatch[]` as an optional parameter.

Update `src/handlers/review.ts` call chain: trace from the review handler through to the prompt builder. Pass `result.wikiKnowledge` alongside `result.reviewPrecedents`.

**Update `src/index.ts` wiring:**

1. Import `createWikiPageStore` from `./knowledge/wiki-store.ts`
2. Import `createWikiSyncScheduler` from `./knowledge/wiki-sync.ts`
3. Create wiki page store: `const wikiPageStore = createWikiPageStore({ sql, logger });`
4. Pass to `createRetriever()`:
   ```typescript
   const retriever = createRetriever({
     ...existingDeps,
     wikiPageStore,  // NEW
   });
   ```
5. Start wiki sync scheduler:
   ```typescript
   const wikiSync = createWikiSyncScheduler({
     store: wikiPageStore,
     embeddingProvider,
     source: "kodi.wiki",
     logger,
   });
   wikiSync.start();
   ```
6. Add to graceful shutdown: `wikiSync.stop()` in the shutdown handler

**Update barrel exports (`src/knowledge/index.ts`):**

Add:
```typescript
export { searchWikiPages, type WikiKnowledgeMatch } from "./wiki-retrieval.ts";
export { createWikiSyncScheduler } from "./wiki-sync.ts";
export type { WikiSyncSchedulerOptions, WikiSyncResult } from "./wiki-sync.ts";
```

**Tests:**

For `retrieval.test.ts` updates:
- Existing tests continue to pass with `wikiPageStore` undefined
- New test: when wikiPageStore provided, results include wikiKnowledge
- New test: wiki search failure does not block other retrieval results

For `review-prompt.test.ts` updates:
- Empty wikiKnowledge produces no section
- Single match formats correctly with page title, section, URL, freshness
- Multiple matches sorted by distance (best first)
- Long text truncated to 200 chars at word boundary
- Matches without section heading show page title only
- Section appears after Human Review Precedents section
- Existing prompt tests continue to pass unchanged
  </action>
  <verify>
- `bun test src/knowledge/retrieval.test.ts` passes (existing + new tests)
- `bun test src/execution/review-prompt.test.ts` passes (existing + new tests)
- `bun test` all tests pass
- No TypeScript compilation errors
  </verify>
  <done>
- Wiki corpus searchable via createRetriever() pipeline
- Citation format: "[Wiki] Page > Section (source) (updated YYYY-MM)"
- Daily sync scheduler running in-process
- Fail-open: wiki errors don't block reviews
- Existing retrieval and prompt behavior unchanged when wiki store absent
  </done>
</task>

</tasks>

<verification>
- Wiki sync scheduler starts on application init and runs daily
- RecentChanges API detects modified pages for incremental update
- Wiki corpus accessible via `createRetriever().retrieve()` pipeline
- Results include `wikiKnowledge` array with source attribution
- Prompt includes `## Wiki Knowledge` section when matches exist
- Citation format: inline link with section anchor and freshness indicator
- Fail-open: wiki errors don't block reviews
- All existing tests pass unchanged
</verification>

<success_criteria>
- Bot can answer architecture/feature questions with wiki citations
- Wiki content stays fresh via daily incremental sync
- Wiki retrieval fully integrated into existing pipeline
- Existing retrieval and prompt behavior unchanged when no wiki content exists
</success_criteria>

<output>
After completion, create `.planning/phases/90-mediawiki-content-ingestion/90-03-SUMMARY.md`
</output>
