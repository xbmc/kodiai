---
phase: 89-pr-review-comment-ingestion
plan: 03
type: execute
wave: 2
depends_on: [89-01]
files_modified:
  - src/handlers/review-comment-sync.ts
  - src/handlers/review-comment-sync.test.ts
  - src/index.ts
autonomous: true
requirements: [KI-04]

must_haves:
  truths:
    - "New review comments on any PR are ingested via webhook on pull_request_review_comment.created"
    - "Edited comments are re-embedded via pull_request_review_comment.edited webhook"
    - "Deleted comments are soft-deleted via pull_request_review_comment.deleted webhook"
    - "Webhook handler acknowledges immediately and processes embedding in background via job queue"
    - "Bot comments are filtered and not ingested"
    - "No auto re-review behavior is introduced (explicit user policy)"
  artifacts:
    - path: "src/handlers/review-comment-sync.ts"
      provides: "Webhook handler for pull_request_review_comment events with async embedding queue"
      contains: "createReviewCommentSyncHandler"
    - path: "src/handlers/review-comment-sync.test.ts"
      provides: "Test coverage for create/edit/delete webhook handling with bot filtering"
      contains: "review-comment-sync"
    - path: "src/index.ts"
      provides: "Handler registration wiring for review comment sync"
      contains: "createReviewCommentSyncHandler"
  key_links:
    - from: "src/handlers/review-comment-sync.ts"
      to: "src/knowledge/review-comment-store.ts"
      via: "Handler writes/updates/deletes chunks via ReviewCommentStore"
      pattern: "writeChunks|updateChunks|softDelete"
    - from: "src/handlers/review-comment-sync.ts"
      to: "src/knowledge/review-comment-chunker.ts"
      via: "New comments are chunked before embedding"
      pattern: "chunkReviewThread"
    - from: "src/index.ts"
      to: "src/handlers/review-comment-sync.ts"
      via: "Handler registered on eventRouter for pull_request_review_comment events"
      pattern: "createReviewCommentSyncHandler|eventRouter"
---

<objective>
Implement incremental sync of PR review comments via webhook handlers for create, edit, and delete events.

Purpose: Keep the review comment corpus up-to-date in real-time as new reviews happen, without requiring manual backfill re-runs.
Output: Webhook handler module registered on the event router, with background embedding via job queue.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/89-pr-review-comment-ingestion/89-01-SUMMARY.md
@src/handlers/dep-bump-merge-history.ts
@src/handlers/feedback-sync.ts
@src/webhook/router.ts
@src/webhook/types.ts
@src/index.ts
@src/jobs/queue.ts
@src/knowledge/review-comment-store.ts
@src/knowledge/review-comment-types.ts
@src/knowledge/review-comment-chunker.ts
@src/knowledge/embeddings.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement review comment sync webhook handler</name>
  <files>src/handlers/review-comment-sync.ts, src/handlers/review-comment-sync.test.ts</files>
  <action>
Create `src/handlers/review-comment-sync.ts` following the same pattern as `createDepBumpMergeHistoryHandler` and `createFeedbackSyncHandler` — a factory function that accepts deps and registers handlers on the event router.

**Factory function:**

```typescript
export function createReviewCommentSyncHandler(opts: {
  eventRouter: EventRouter;
  jobQueue: JobQueue;
  store: ReviewCommentStore;
  embeddingProvider: EmbeddingProvider;
  logger: Logger;
}): void
```

**Register three event handlers:**

1. `pull_request_review_comment.created` — Ingest new comment
2. `pull_request_review_comment.edited` — Re-embed edited comment
3. `pull_request_review_comment.deleted` — Soft-delete comment

**Created handler:**

1. Extract comment from `event.payload.comment`
2. Check bot filter: skip if `comment.user.type === 'Bot'` or `comment.user.login` matches bot patterns (dependabot, renovate, kodiai, github-actions, [bot] suffix)
3. Extract repo from `event.payload.repository.full_name`
4. Build a `ReviewCommentInput` from the webhook payload fields
5. Enqueue a background job (via `jobQueue.add()`) that:
   a. Creates a single-comment thread array and calls `chunkReviewThread()`
   b. For each chunk, calls `embeddingProvider.generate(chunk.chunk_text, "document")`
   c. Calls `store.writeChunks(chunks)` to persist
   d. Logs: `"Review comment ingested" { repo, prNumber, commentId, chunksWritten }`
6. The handler itself returns immediately after enqueueing (locked decision: acknowledge webhook immediately)

**Edited handler:**

1. Same bot filter
2. Enqueue background job that:
   a. Re-chunks the updated comment body
   b. Re-embeds each chunk
   c. Calls `store.updateChunks(chunks)` which deletes old chunks and inserts new
   d. Logs: `"Review comment re-embedded" { repo, commentId, chunksUpdated }`

**Deleted handler:**

1. Call `store.softDelete(repo, commentGithubId)` directly (lightweight, no embedding needed)
2. Log: `"Review comment soft-deleted" { repo, commentId }`

**Thread context for new comments:**

For the `created` event, the comment may be a reply (`in_reply_to_id` set). In this case, we should ideally re-chunk the entire thread. However, for the initial implementation, ingest the new comment as a standalone chunk. This is simpler and avoids re-embedding the entire thread on every reply. Phase 91 cross-corpus retrieval can handle thread coherence via proximity scoring.

**CRITICAL: No unsolicited responses.**
This handler ONLY writes to the database. It does NOT trigger any review, response, or comment on the PR. This is a pure ingestion handler — it observes and records, never acts.

**Tests:**

- Created event: processes comment, produces chunk, writes to store
- Created event: bot comment is skipped
- Created event: Bot type user (`user.type === 'Bot'`) is skipped
- Edited event: re-chunks and calls updateChunks
- Deleted event: calls softDelete
- Created event: job is enqueued (not processed synchronously)
- All three handlers registered on correct event keys
  </action>
  <verify>
- `bun test src/handlers/review-comment-sync.test.ts` passes
- `bun test` all existing tests pass
  </verify>
  <done>
- Three webhook handlers registered for create/edit/delete events
- Bot filtering prevents ingestion of bot comments
- Background job queue handles embedding asynchronously
- Soft-delete on comment deletion
- No unsolicited response behavior introduced
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire review comment sync handler into application startup</name>
  <files>src/index.ts</files>
  <action>
Add the review comment sync handler to the application wiring in `src/index.ts`.

1. Import `createReviewCommentSyncHandler` from `./handlers/review-comment-sync.ts`
2. Import `createReviewCommentStore` from `./knowledge/review-comment-store.ts`
3. After the existing store creation block (around line 100-120), create the review comment store:
   ```typescript
   const reviewCommentStore = sql ? createReviewCommentStore({ sql, logger }) : undefined;
   ```
4. After the existing handler registrations (around line 355-392), add:
   ```typescript
   if (reviewCommentStore && embeddingProvider) {
     createReviewCommentSyncHandler({
       eventRouter,
       jobQueue,
       store: reviewCommentStore,
       embeddingProvider,
       logger,
     });
   }
   ```

Guard with `if (reviewCommentStore && embeddingProvider)` so the handler is only registered when both database and embeddings are available — fail-open philosophy.

This wiring is minimal and follows the exact same pattern as the existing handler registrations. The review comment store is a peer of knowledgeStore and learningMemoryStore — created from the same sql connection pool.
  </action>
  <verify>
- `bun run src/index.ts` starts without errors (with valid env vars)
- `bun test` all tests pass
- No TypeScript compilation errors
  </verify>
  <done>
- Review comment sync handler registered on event router at startup
- Handler only active when database and embeddings are available
- Follows existing wiring patterns exactly
  </done>
</task>

</tasks>

<verification>
- Webhook events for pull_request_review_comment.created/edited/deleted are handled
- Bot comments are filtered
- New comments are chunked, embedded, and stored asynchronously
- Edited comments are re-embedded
- Deleted comments are soft-deleted
- Handler wired into application startup following existing patterns
- No unsolicited response behavior introduced
- All tests pass
</verification>

<success_criteria>
- New review comments from any repo are automatically ingested when the webhook fires
- Edits and deletes are tracked in real-time
- Background processing prevents webhook timeout
- Existing functionality is not affected
</success_criteria>

<output>
After completion, create `.planning/phases/89-pr-review-comment-ingestion/89-03-SUMMARY.md`
</output>
