---
phase: 89-pr-review-comment-ingestion
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/knowledge/review-comment-types.ts
  - src/knowledge/review-comment-store.ts
  - src/knowledge/review-comment-backfill.ts
  - src/handlers/review-comment-sync.ts
autonomous: true
requirements: [KI-01, KI-02, KI-03, KI-04, KI-05, KI-06]
gap_closure: true

must_haves:
  truths:
    - "ReviewCommentChunk type carries an optional embedding field (Float32Array | null)"
    - "writeChunks() INSERT includes the embedding column when chunk.embedding is present"
    - "updateChunks() INSERT includes the embedding column when chunk.embedding is present"
    - "embedChunks() in backfill assigns generated embedding to chunk.embedding instead of discarding it"
    - "embedChunks() in sync handler assigns generated embedding to chunk.embedding instead of discarding it"
    - "searchByEmbedding() filters out rows with NULL embedding to avoid NaN distances"
  artifacts:
    - path: "src/knowledge/review-comment-types.ts"
      provides: "ReviewCommentChunk with embedding field"
      contains: "embedding"
    - path: "src/knowledge/review-comment-store.ts"
      provides: "writeChunks and updateChunks that persist embedding column"
      contains: "embedding"
    - path: "src/knowledge/review-comment-backfill.ts"
      provides: "embedChunks that assigns embedding to chunk objects"
      contains: "chunk.embedding"
    - path: "src/handlers/review-comment-sync.ts"
      provides: "embedChunks that assigns embedding to chunk objects"
      contains: "chunk.embedding"
  key_links:
    - from: "src/knowledge/review-comment-backfill.ts"
      to: "src/knowledge/review-comment-store.ts"
      via: "embedChunks sets chunk.embedding, writeChunks persists it to DB"
      pattern: "chunk\\.embedding.*writeChunks"
    - from: "src/handlers/review-comment-sync.ts"
      to: "src/knowledge/review-comment-store.ts"
      via: "embedChunks sets chunk.embedding, writeChunks/updateChunks persist it"
      pattern: "chunk\\.embedding.*writeChunks|updateChunks"
    - from: "src/knowledge/review-comment-store.ts"
      to: "src/db/migrations/005-review-comments.sql"
      via: "INSERT includes embedding column, searchByEmbedding filters NULL embeddings"
      pattern: "embedding.*IS NOT NULL"
---

<objective>
Fix embedding persistence across the review comment pipeline so generated embeddings are stored in PostgreSQL instead of discarded.

Purpose: Close the critical gap where VoyageAI embeddings are computed (incurring API cost) but thrown away, leaving all review_comments rows with NULL embedding and making vector search non-functional.
Output: Four coordinated file changes that complete the embedding data flow from generation through storage to search.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/89-pr-review-comment-ingestion/89-VERIFICATION.md
@src/knowledge/review-comment-types.ts
@src/knowledge/review-comment-store.ts
@src/knowledge/review-comment-backfill.ts
@src/handlers/review-comment-sync.ts
@src/knowledge/embeddings.ts
@src/knowledge/memory-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add embedding field to ReviewCommentChunk and update store persistence</name>
  <files>src/knowledge/review-comment-types.ts, src/knowledge/review-comment-store.ts</files>
  <action>
**1. Add embedding field to ReviewCommentChunk in `review-comment-types.ts` (line 28-49):**

Add `embedding?: Float32Array | null;` after the `backfillBatch` field on the `ReviewCommentChunk` type. This allows the chunk to carry the generated embedding from `embedChunks()` through to `writeChunks()`/`updateChunks()`.

**2. Update `writeChunks()` in `review-comment-store.ts` (lines 93-123):**

Add `embedding` and `embedding_model` to the INSERT column list and VALUES. When `chunk.embedding` is present, serialize it using `float32ArrayToVectorString()` and pass as a parameter. When null/undefined, pass `null`. Use `'voyage-code-3'` as the embedding_model value when embedding is present, `null` when not.

The updated INSERT should include these two additional columns:
```
embedding, embedding_model
```

And the corresponding VALUES should be:
```
${chunk.embedding ? float32ArrayToVectorString(chunk.embedding) : null}::vector,
${chunk.embedding ? 'voyage-code-3' : null}
```

**3. Update `updateChunks()` in `review-comment-store.ts` (lines 133-165):**

Apply the same change to the INSERT inside the transaction in `updateChunks()` — add `embedding` and `embedding_model` columns with the same serialization logic.

**4. Add NULL embedding filter to `searchByEmbedding()` in `review-comment-store.ts` (lines 167-189):**

Add `AND embedding IS NOT NULL` to the WHERE clause in the search query, between the `AND deleted = false` line and the `ORDER BY` line. This prevents PostgreSQL from attempting cosine distance on NULL vectors, which produces undefined behavior.

Updated WHERE clause:
```sql
WHERE repo = ${params.repo}
  AND stale = false
  AND deleted = false
  AND embedding IS NOT NULL
```
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify that ReviewCommentChunk has embedding field, writeChunks/updateChunks include embedding column, and searchByEmbedding has IS NOT NULL filter</manual>
  </verify>
  <done>
- ReviewCommentChunk type has `embedding?: Float32Array | null` field
- writeChunks() INSERT includes embedding and embedding_model columns
- updateChunks() INSERT includes embedding and embedding_model columns
- searchByEmbedding() WHERE clause includes `AND embedding IS NOT NULL`
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix embedChunks in backfill and sync to assign embedding to chunk</name>
  <files>src/knowledge/review-comment-backfill.ts, src/handlers/review-comment-sync.ts</files>
  <action>
**1. Fix `embedChunks()` in `review-comment-backfill.ts` (lines 196-231):**

The current function calls `embeddingProvider.generate()` but discards the result. Replace the function body to assign the generated embedding to each chunk object. The function parameter type should change from `{ chunkText: string }[]` to `ReviewCommentChunk[]` since it now mutates the chunks.

Updated implementation:
```typescript
async function embedChunks(
  chunks: ReviewCommentChunk[],
  embeddingProvider: EmbeddingProvider,
  store: ReviewCommentStore,
  logger: Logger,
  dryRun: boolean,
): Promise<{ embeddingsGenerated: number; embeddingsFailed: number }> {
  let embeddingsGenerated = 0;
  let embeddingsFailed = 0;

  for (const chunk of chunks) {
    try {
      const result = await embeddingProvider.generate(chunk.chunkText, "document");
      if (result) {
        chunk.embedding = result;
        embeddingsGenerated++;
      } else {
        chunk.embedding = null;
        embeddingsFailed++;
      }
    } catch {
      chunk.embedding = null;
      embeddingsFailed++;
    }
  }

  return { embeddingsGenerated, embeddingsFailed };
}
```

Remove the block comments (lines 206-215) that explain the "store chunks without embeddings" workaround — those are now incorrect. The key change: `chunk.embedding = result;` assigns the Float32Array to the chunk so `writeChunks()` can persist it.

**2. Fix `embedChunks()` in `review-comment-sync.ts` (lines 72-86):**

The current function calls `embeddingProvider.generate()` but returns chunks unchanged. Replace the function body to assign embeddings to chunks.

Updated implementation:
```typescript
async function embedChunks(
  chunks: ReviewCommentChunk[],
  embeddingProvider: EmbeddingProvider,
): Promise<ReviewCommentChunk[]> {
  for (const chunk of chunks) {
    try {
      const result = await embeddingProvider.generate(chunk.chunkText, "document");
      chunk.embedding = result ?? null;
    } catch {
      chunk.embedding = null;
    }
  }
  return chunks;
}
```

Remove the comments (lines 76-81) that explain the "future phase" workaround — embedding persistence is now handled by the updated `writeChunks()` and `updateChunks()`.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30 && bun test 2>&1 | tail -20</automated>
    <manual>Verify embedChunks in both files assigns result to chunk.embedding instead of discarding it</manual>
  </verify>
  <done>
- Backfill embedChunks assigns `chunk.embedding = result` from embeddingProvider.generate()
- Sync embedChunks assigns `chunk.embedding = result ?? null` from embeddingProvider.generate()
- Stale "future phase" comments removed from both files
- TypeScript compiles without errors
- All existing tests pass
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles cleanly: `npx tsc --noEmit`
- All existing tests pass: `bun test`
- ReviewCommentChunk type includes `embedding?: Float32Array | null`
- writeChunks() and updateChunks() INSERT statements include embedding column
- searchByEmbedding() WHERE clause includes `AND embedding IS NOT NULL`
- embedChunks() in backfill assigns embedding to chunk (not discards)
- embedChunks() in sync assigns embedding to chunk (not discards)
- No "future phase" or "future update pass" comments remain in the embedding pipeline
</verification>

<success_criteria>
- The embedding data flow is complete: generate -> assign to chunk -> persist to DB -> search with NULL filter
- Vector search returns results for rows that have embeddings
- Fail-open behavior preserved: chunks without embeddings are stored with NULL embedding (no crash)
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/89-pr-review-comment-ingestion/89-05-SUMMARY.md`
</output>
