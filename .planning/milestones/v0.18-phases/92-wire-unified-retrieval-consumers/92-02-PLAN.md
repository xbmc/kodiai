---
phase: 92-wire-unified-retrieval-consumers
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/handlers/review.ts
  - src/index.ts
autonomous: true
requirements: [KI-13, KI-14]

must_haves:
  truths:
    - "Review retry path passes full unified context (unifiedResults, contextWindow, wikiKnowledge) to buildReviewPrompt"
    - "createRetriever() receives learningMemoryStore for hybrid BM25+vector search on code corpus"
    - "Code corpus BM25 search is active when learningMemoryStore is available"
    - "Retry gracefully degrades if unified context is unavailable — falls back to code diff only"
  artifacts:
    - path: "src/handlers/review.ts"
      provides: "Review retry path with full unified context"
      contains: "unifiedResults.*retryPrompt"
    - path: "src/index.ts"
      provides: "learningMemoryStore wired to createRetriever"
      contains: "memoryStore.*learningMemoryStore"
  key_links:
    - from: "src/index.ts"
      to: "src/knowledge/retrieval.ts"
      via: "memoryStore parameter in createRetriever"
      pattern: "memoryStore"
    - from: "src/handlers/review.ts"
      to: "src/execution/review-prompt.ts"
      via: "unifiedResults/contextWindow in retry buildReviewPrompt call"
      pattern: "unifiedResults.*contextWindow"
---

<objective>
Fix the review retry path to pass full unified context to buildReviewPrompt and wire learningMemoryStore into createRetriever() for hybrid BM25+vector search on the code corpus.

Purpose: The retry path currently drops wikiKnowledge, unifiedResults, and contextWindow. The code corpus currently gets vector-only search because learningMemoryStore is not passed to createRetriever. This plan closes both gaps.
Output: Review retry preserves unified context; code corpus gets hybrid search via BM25+vector.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/92-wire-unified-retrieval-consumers/92-CONTEXT.md
@.planning/phases/91-cross-corpus-retrieval-integration/91-03-SUMMARY.md
@.planning/phases/91-cross-corpus-retrieval-integration/91-04-SUMMARY.md
@src/handlers/review.ts
@src/index.ts
@src/knowledge/retrieval.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix review retry to pass full unified context to buildReviewPrompt</name>
  <files>src/handlers/review.ts</files>
  <action>
The primary review path (around line 2267) correctly passes wikiKnowledge, unifiedResults, and contextWindow to buildReviewPrompt. The retry path (around line 3250) is MISSING these fields. Fix it:

1. Find the retry buildReviewPrompt call (around line 3250).

2. Add the missing parameters to match the primary path. After the existing `reviewPrecedents` line (line 3277), add:
   ```typescript
   wikiKnowledge: wikiKnowledgeForPrompt.length > 0 ? wikiKnowledgeForPrompt : undefined,
   unifiedResults: unifiedResultsForPrompt.length > 0 ? unifiedResultsForPrompt : undefined,
   contextWindow: contextWindowForPrompt,
   ```

   These variables (wikiKnowledgeForPrompt, unifiedResultsForPrompt, contextWindowForPrompt) are already declared earlier in the same scope (around lines 1997-2000) and populated from the initial retrieval call — they're in scope for the retry block.

3. Per CONTEXT.md decision: reuse cached context from the first attempt on retry (don't rebuild fresh). The existing code already does this — the retrieval variables are populated once before the first review attempt and the retry reuses them. Just make sure they're forwarded correctly.

4. Per CONTEXT.md: Final fallback — if retry with unified context still fails, the existing timeout/error handling already attempts review with just the code diff. No additional code needed for this.

IMPORTANT: Do NOT modify the primary review path (around line 2267) — it already correctly passes all unified fields.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Grep both buildReviewPrompt calls and confirm they pass identical unified context fields</manual>
  </verify>
  <done>Retry buildReviewPrompt call passes wikiKnowledge, unifiedResults, and contextWindow matching the primary review path</done>
</task>

<task type="auto">
  <name>Task 2: Wire learningMemoryStore to createRetriever for hybrid BM25+vector search</name>
  <files>src/index.ts</files>
  <action>
In src/index.ts, the createRetriever() call (around line 186) passes reviewCommentStore and wikiPageStore but NOT memoryStore (learningMemoryStore). The createRetriever function signature accepts an optional `memoryStore?: LearningMemoryStore` parameter (retrieval.ts line 214) which enables BM25 full-text search on the code/learning memory corpus.

1. In the createRetriever() call (around line 186-203), add `memoryStore: learningMemoryStore` after `wikiPageStore`:
   ```typescript
   const retriever = isolationLayer && embeddingProvider
     ? createRetriever({
         embeddingProvider,
         isolationLayer,
         config: { ... },
         reviewCommentStore,
         wikiPageStore,
         memoryStore: learningMemoryStore,  // <-- ADD THIS
       })
     : undefined;
   ```

2. Verify `learningMemoryStore` is in scope — it's created earlier in the same file (around line 170-180) and is used to create the isolationLayer. It may be undefined if memoryStore initialization fails, but createRetriever's `memoryStore` parameter is optional so this is safe.

Per CONTEXT.md: learningMemoryStore parameter is optional in createRetriever() — enhances with hybrid when provided, vector-only when absent. The optional chaining in retrieval.ts (`deps.memoryStore?.searchByFullText`) handles the undefined case.

Per CONTEXT.md: Use RRF for merging BM25+vector results — this is already implemented in Phase 91's retrieval pipeline. Just need to pass the store.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
    <manual>Verify createRetriever call in index.ts includes memoryStore parameter</manual>
  </verify>
  <done>createRetriever() receives learningMemoryStore enabling hybrid BM25+vector search on code corpus via the existing RRF pipeline</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors in review.ts and index.ts
- Existing review tests pass: `bun test src/handlers/review.test.ts`
- Grep confirms both buildReviewPrompt calls (primary + retry) pass identical unified context fields
- Grep confirms memoryStore in createRetriever call in index.ts
</verification>

<success_criteria>
- Review retry buildReviewPrompt passes wikiKnowledge, unifiedResults, and contextWindow
- createRetriever in index.ts receives learningMemoryStore
- Code corpus now gets hybrid BM25+vector search via existing RRF pipeline
- All existing review tests pass
- Backward compatible — optional params don't break when stores are unavailable
</success_criteria>

<output>
After completion, create `.planning/phases/92-wire-unified-retrieval-consumers/92-02-SUMMARY.md`
</output>
