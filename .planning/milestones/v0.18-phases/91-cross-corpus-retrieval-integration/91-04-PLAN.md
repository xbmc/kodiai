---
phase: 91-cross-corpus-retrieval-integration
plan: 04
type: execute
wave: 3
depends_on: [91-03]
files_modified:
  - src/execution/review-prompt.ts
  - src/execution/review-prompt.test.ts
  - src/handlers/review.ts
  - src/handlers/mention.ts
  - src/slack/assistant-handler.ts
  - src/knowledge/retrieval.e2e.test.ts
autonomous: true
requirements: [KI-13, KI-17]

must_haves:
  truths:
    - "PR review responses cite code context, human review precedent, and wiki pages in one response"
    - "Every citation is a clickable markdown link to the source"
    - "No retrieval path bypasses the unified layer"
    - "End-to-end test validates cross-corpus retrieval with attribution"
  artifacts:
    - path: "src/execution/review-prompt.ts"
      provides: "Unified citation formatting using UnifiedRetrievalChunk"
      exports: ["formatUnifiedContext"]
    - path: "src/knowledge/retrieval.e2e.test.ts"
      provides: "E2E test proving cross-corpus retrieval with attributed citations"
  key_links:
    - from: "src/execution/review-prompt.ts"
      to: "src/knowledge/cross-corpus-rrf.ts"
      via: "imports UnifiedRetrievalChunk type for formatting"
      pattern: "UnifiedRetrievalChunk"
    - from: "src/handlers/review.ts"
      to: "src/knowledge/retrieval.ts"
      via: "passes triggerType to retriever"
      pattern: "triggerType.*pr_review"
    - from: "src/handlers/mention.ts"
      to: "src/knowledge/retrieval.ts"
      via: "passes triggerType to retriever"
      pattern: "triggerType.*question"
---

<objective>
Wire all retrieval consumers to use unified results with cross-corpus attribution formatting, and create the end-to-end validation test.

Purpose: Complete the consumer side of the unified retrieval layer. All handlers (review, mention, Slack) must use the new `unifiedResults` and `contextWindow` from the retriever. Citation formatting should use the inline source labels specified in CONTEXT.md. The E2E test validates that a single retrieval call returns results from all three corpora with proper attribution.

Output: All consumers use unified retrieval. End-to-end test proves the full pipeline.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/91-cross-corpus-retrieval-integration/91-CONTEXT.md
@.planning/phases/91-cross-corpus-retrieval-integration/91-03-SUMMARY.md
@src/execution/review-prompt.ts
@src/handlers/review.ts
@src/handlers/mention.ts
@src/slack/assistant-handler.ts
@src/knowledge/retrieval.e2e.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add unified citation formatting and update review prompt</name>
  <files>
    src/execution/review-prompt.ts
    src/execution/review-prompt.test.ts
  </files>
  <action>
Add a `formatUnifiedContext` function to `review-prompt.ts`:

```typescript
export function formatUnifiedContext(params: {
  unifiedResults: UnifiedRetrievalChunk[];
  contextWindow?: string;  // pre-assembled from retriever
  maxCitations?: number;   // default 8 (soft cap per CONTEXT.md: "5-8 citations per response")
}): string
```

Formatting rules (from CONTEXT.md decisions):
- Inline source labels woven into context: `[wiki: Page Title](url)`, `[review: PR #1234](url)`, `[code: file.ts]`
- Every citation is a clickable markdown link (if URL available)
- When multiple sources agree: cite strongest source, mention others parenthetically ("also referenced in [review: PR #456]")
- Use `alternateSources` from dedup to add the "also found in" annotations
- Soft cap at maxCitations (default 8) — after cap, only include if RRF score is significantly higher than threshold

Update `buildFullReviewPrompt` (or the equivalent prompt builder) to:
1. Accept `unifiedResults` and `contextWindow` in its context parameter
2. If `unifiedResults` is provided and non-empty, use `formatUnifiedContext` INSTEAD of the separate `formatReviewPrecedents` + `formatWikiKnowledge` sections
3. If `unifiedResults` is empty/undefined, fall back to legacy formatting (backward compat)
4. Include a note when a corpus returned no results: "Note: {corpus} corpus not yet available" (per CONTEXT.md)

Update `review-prompt.test.ts`:
- Test `formatUnifiedContext` with chunks from all three sources
- Test citation soft cap (9 chunks, only 8 citations)
- Test alternate source annotation ("also found in wiki")
- Test fallback to legacy formatting when unifiedResults empty
- Existing tests must continue passing
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx vitest run src/execution/review-prompt.test.ts 2>&1 | tail -30</automated>
  </verify>
  <done>Unified citation formatting produces clickable source labels with soft cap and alternate source annotations</done>
</task>

<task type="auto">
  <name>Task 2: Wire handlers to use unified retrieval and create E2E test</name>
  <files>
    src/handlers/review.ts
    src/handlers/mention.ts
    src/slack/assistant-handler.ts
    src/knowledge/retrieval.e2e.test.ts
  </files>
  <action>
**Update src/handlers/review.ts:**
- Pass `triggerType: "pr_review"` in the retriever call options
- Pass `unifiedResults` and `contextWindow` from RetrieveResult to the review prompt builder
- Keep passing legacy fields too for backward compat during transition

**Update src/handlers/mention.ts:**
- Pass `triggerType: "question"` in the retriever call options (mention handler is typically Q&A-style)
- Pass unified results to response builder

**Update src/slack/assistant-handler.ts:**
- Pass `triggerType: "slack"` in retriever call options
- Use `contextWindow` from retrieval for Slack response context

**Create/update src/knowledge/retrieval.e2e.test.ts:**

Add an E2E test that validates the full cross-corpus pipeline:

```typescript
test("cross-corpus retrieval returns attributed results from all three corpora", async () => {
  // Setup: mock all three stores with known test data
  // - Learning memory store: code finding about "buffer overflow in parser.cpp"
  // - Review comment store: review about "parser error handling" on PR #42
  // - Wiki store: wiki page "Parser Architecture" with section on error handling

  // Act: call retrieve() with query "parser error handling"

  // Assert:
  // 1. unifiedResults contains items with source "code", "review_comment", and "wiki"
  // 2. Each item has sourceLabel and sourceUrl
  // 3. contextWindow contains all three source labels
  // 4. RRF scores computed (all items have rrfScore > 0)
  // 5. provenance.hybridSearchUsed is true
  // 6. provenance.unifiedResultCount matches unifiedResults.length
});

test("PR review trigger boosts code and review sources", async () => {
  // Setup: same data, triggerType: "pr_review"
  // Assert: code/review chunks rank higher than wiki for same relevance
});

test("question trigger boosts wiki source", async () => {
  // Setup: same data, triggerType: "question"
  // Assert: wiki chunks rank higher for same relevance
});

test("fail-open: missing wiki store still returns code and review results", async () => {
  // Setup: no wikiPageStore in deps
  // Assert: unifiedResults contains code + review, no crash
});
```

Ensure the test validates the CONTEXT.md requirement: "No retrieval path bypasses the unified layer" by checking that all result types flow through the unified pipeline.
  </action>
  <verify>
    <automated>cd /home/keith/src/kodiai && npx vitest run src/knowledge/retrieval.e2e.test.ts 2>&1 | tail -30</automated>
  </verify>
  <done>All handlers use unified retrieval with triggerType. E2E test validates cross-corpus attribution.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx vitest run src/knowledge/` — all knowledge tests pass
- `npx vitest run src/execution/review-prompt.test.ts` passes
- `npx vitest run src/handlers/review.test.ts src/handlers/mention.test.ts` passes
- E2E test proves: single call returns code + review + wiki results with attribution
- All handlers pass triggerType for context-dependent weighting
</verification>

<success_criteria>
- KI-13 complete: single retrieval call fans out to all corpora in all handlers
- KI-17 complete: every retrieved chunk carries source label for attribution with clickable links
- End-to-end test proves: PR review response can cite code context + human review precedent + wiki page
- No retrieval path bypasses the unified layer
- Backward compatible: legacy fields still populated during transition
</success_criteria>

<output>
After completion, create `.planning/phases/91-cross-corpus-retrieval-integration/91-04-SUMMARY.md`
</output>
