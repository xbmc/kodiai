---
phase: 104-issue-mcp-tools
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/execution/mcp/issue-comment-server.ts
  - src/execution/mcp/issue-comment-server.test.ts
autonomous: true
requirements: [MCPT-02]

must_haves:
  truths:
    - "github_issue_comment tool creates comments on issues"
    - "github_issue_comment tool updates existing comments by ID"
    - "Supports both raw markdown and structured input (title/body/suggestions)"
    - "No bot branding or signature on comments"
    - "Truncates with note when comment exceeds max length"
    - "Closed issues get a warning but comment still posts"
  artifacts:
    - path: "src/execution/mcp/issue-comment-server.ts"
      provides: "github_issue_comment MCP server factory"
      exports: ["createIssueCommentServer"]
    - path: "src/execution/mcp/issue-comment-server.test.ts"
      provides: "Unit tests for issue comment tool"
      min_lines: 100
  key_links:
    - from: "src/execution/mcp/issue-comment-server.ts"
      to: "octokit.rest.issues.createComment"
      via: "GitHub API call"
      pattern: "createComment"
    - from: "src/execution/mcp/issue-comment-server.ts"
      to: "octokit.rest.issues.updateComment"
      via: "GitHub API call"
      pattern: "updateComment"
---

<objective>
Implement the `github_issue_comment` MCP tool using TDD.

Purpose: Give the triage agent the ability to post and update comments on GitHub issues, supporting both raw markdown and structured input.
Output: `issue-comment-server.ts` and `issue-comment-server.test.ts`
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
@/home/keith/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/104-issue-mcp-tools/104-CONTEXT.md
@.planning/phases/104-issue-mcp-tools/104-RESEARCH.md

<interfaces>
<!-- Existing MCP server pattern from the codebase -->

From src/execution/mcp/ci-status-server.ts (pattern reference):
```typescript
import { tool, createSdkMcpServer } from "@anthropic-ai/claude-agent-sdk";
import { z } from "zod";
import type { Octokit } from "@octokit/rest";

export function createCIStatusServer(
  getOctokit: () => Promise<Octokit>,
  owner: string,
  repo: string,
  prNumber: number,
) {
  return createSdkMcpServer({ name, version, tools: [...] });
}
```

From src/execution/mcp/comment-server.ts (AVOID this pattern for issue comments):
```typescript
// The existing comment-server.ts has heavy PR-specific validators:
// - sanitizeKodiaiDecisionResponse (APPROVE/NOT APPROVED format)
// - sanitizeKodiaiReviewSummary (5-section review template)
// - sanitizeKodiaiReReviewSummary (delta re-review template)
// The new issue comment tool must NOT include any of these validators.
// It should be a clean, simple comment tool without review-specific logic.
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write tests for github_issue_comment MCP tool</name>
  <files>src/execution/mcp/issue-comment-server.test.ts</files>
  <action>
Create test file using bun:test. Mock Octokit via manual mock objects.

Test cases:

**create_comment tool:**
1. **Raw markdown**: Post "## Missing Fields\nPlease fill in..." to issue #42. Expect: createComment called with body, returns { success, comment_id, comment_url }.
2. **Structured input**: Post { title: "Missing Fields", body: "Please fill in...", suggestions: ["Add reproduction steps"] }. Expect: formats as markdown (## title\nbody\n\n**Suggestions:**\n- suggestion), creates comment.
3. **No bot branding**: Comment body should NOT contain "Posted by Kodiai" or similar signatures.
4. **Max length truncation**: Body exceeds 60000 chars. Expect: truncated to limit with "\n\n---\n*Comment truncated due to length.*" appended.
5. **Closed issue warning**: Issue state is "closed". Expect: comment still posts, response includes `warning: "Issue is closed"`.
6. **Issue not found (404)**: Expect: ISSUE_NOT_FOUND error code.
7. **Permission denied (403)**: Expect: PERMISSION_DENIED error code.
8. **Rate limited (429)**: First call fails with 429, retry succeeds. Expect: success response.
9. **Config gating - disabled**: getTriageConfig().comment.enabled is false. Expect: TOOL_DISABLED error.
10. **Response includes metadata**: Success includes issue_number, repo, comment_id, comment_url, timestamp.

**update_comment tool:**
11. **Update by ID**: Update comment 12345 with new body. Expect: updateComment called, returns success.
12. **Comment not found (404)**: Expect: COMMENT_NOT_FOUND error code.
13. **Max length on update**: Body exceeds limit, truncated.

Factory signature:
```typescript
export function createIssueCommentServer(
  getOctokit: () => Promise<Octokit>,
  owner: string,
  repo: string,
  getTriageConfig: () => { enabled: boolean; comment: { enabled: boolean } },
)
```
  </action>
  <verify>
    <automated>bun test src/execution/mcp/issue-comment-server.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>All test cases written and failing (RED phase)</done>
</task>

<task type="auto">
  <name>Task 2: Implement github_issue_comment MCP server</name>
  <files>src/execution/mcp/issue-comment-server.ts</files>
  <action>
Create `createIssueCommentServer` factory function.

**Tool 1: `create_comment`**

Zod schema:
```typescript
{
  issue_number: z.number().describe("The issue number"),
  body: z.string().optional().describe("Raw markdown comment body"),
  structured: z.object({
    title: z.string().describe("Comment title (rendered as ## heading)"),
    body: z.string().describe("Comment body text"),
    suggestions: z.array(z.string()).optional().describe("Actionable suggestions as bullet list"),
  }).optional().describe("Structured comment input (alternative to body)"),
}
```
Add `.refine()` to ensure at least one of `body` or `structured` is provided.

Handler logic:
1. Check `getTriageConfig()` -- if disabled, return TOOL_DISABLED.
2. Resolve body:
   - If `body` provided, use as-is.
   - If `structured` provided, format:
     ```
     ## {title}

     {body}

     **Suggestions:**
     - {suggestion1}
     - {suggestion2}
     ```
     Omit Suggestions section if array empty or not provided.
3. Enforce max length (60000 chars). If exceeded, truncate and append "\n\n---\n*Comment truncated due to length.*"
4. Check issue state: fetch via `octokit.rest.issues.get()`. If closed, set warning.
5. Post comment via `octokit.rest.issues.createComment()`.
6. Return rich response:
   ```json
   {
     "success": true,
     "issue_number": 42,
     "repo": "owner/repo",
     "comment_id": 12345,
     "comment_url": "https://github.com/...",
     "warning": null,
     "timestamp": "2026-02-26T..."
   }
   ```

**Tool 2: `update_comment`**

Zod schema:
```typescript
{
  comment_id: z.number().describe("The comment ID to update"),
  body: z.string().optional().describe("Raw markdown comment body"),
  structured: z.object({
    title: z.string(),
    body: z.string(),
    suggestions: z.array(z.string()).optional(),
  }).optional(),
}
```

Handler: Same body resolution and truncation logic. Call `octokit.rest.issues.updateComment()`. Return `{ success, comment_id, timestamp }`.

**Error handling:**
Same as Plan 01: try/catch with HTTP status mapping (404 -> ISSUE_NOT_FOUND or COMMENT_NOT_FOUND, 403 -> PERMISSION_DENIED, 429 -> retry with exponential backoff).

Reuse the same `withRetry` helper pattern from Plan 01 (inline, not imported -- plans are independent).

**Critical: No bot branding.** Do NOT add any signature, footer, or "Posted by Kodiai" text to comments.
  </action>
  <verify>
    <automated>bun test src/execution/mcp/issue-comment-server.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>All 13 test cases pass (GREEN phase)</done>
</task>

</tasks>

<verification>
- `bun test src/execution/mcp/issue-comment-server.test.ts` -- all tests pass
- `bun build src/execution/mcp/issue-comment-server.ts --no-bundle` -- compiles without errors
</verification>

<success_criteria>
- createIssueCommentServer factory exported
- create_comment tool supports both raw markdown and structured input
- update_comment tool updates existing comments by ID
- No bot branding or signature on comments
- Max length enforcement with truncation note
- Closed issue warning in response
- Structured error codes: TOOL_DISABLED, ISSUE_NOT_FOUND, COMMENT_NOT_FOUND, PERMISSION_DENIED
- Rate limit retry with exponential backoff
- Config gating via getTriageConfig() (hot-reload)
- Response includes metadata (issue_number, repo, comment_id, comment_url, timestamp)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/104-issue-mcp-tools/104-02-SUMMARY.md`
</output>
