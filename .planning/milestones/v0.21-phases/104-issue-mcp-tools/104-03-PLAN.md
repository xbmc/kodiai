---
phase: 104-issue-mcp-tools
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - src/execution/mcp/index.ts
  - src/execution/config.ts
  - src/execution/config.test.ts
  - src/execution/mcp/index.test.ts
autonomous: true
requirements: [MCPT-03]

must_haves:
  truths:
    - "Both issue MCP tools are registered in the executor MCP server registry"
    - "Triage config section in .kodiai.yml controls tool availability"
    - "Config gating is per-repo via triage.label.enabled and triage.comment.enabled"
    - "Integration tests verify wiring from config to MCP server registration"
  artifacts:
    - path: "src/execution/mcp/index.ts"
      provides: "Updated MCP server registry with issue tools"
      exports: ["buildMcpServers", "createIssueLabelServer", "createIssueCommentServer"]
    - path: "src/execution/config.ts"
      provides: "triage config schema in repoConfigSchema"
      contains: "triageSchema"
    - path: "src/execution/mcp/index.test.ts"
      provides: "Integration tests for MCP server wiring"
  key_links:
    - from: "src/execution/mcp/index.ts"
      to: "src/execution/mcp/issue-label-server.ts"
      via: "import createIssueLabelServer"
      pattern: "createIssueLabelServer"
    - from: "src/execution/mcp/index.ts"
      to: "src/execution/mcp/issue-comment-server.ts"
      via: "import createIssueCommentServer"
      pattern: "createIssueCommentServer"
    - from: "src/execution/mcp/index.ts"
      to: "src/execution/config.ts"
      via: "triage config consumed by buildMcpServers"
      pattern: "triageConfig"
---

<objective>
Wire both issue MCP tools into the executor MCP server registry with config gating and integration tests.

Purpose: Make the issue label and comment tools available to the triage agent, controlled by per-repo `.kodiai.yml` configuration.
Output: Updated `index.ts` registry, `config.ts` schema, integration tests.
</objective>

<execution_context>
@/home/keith/.claude/get-shit-done/workflows/execute-plan.md
@/home/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/104-issue-mcp-tools/104-CONTEXT.md
@.planning/phases/104-issue-mcp-tools/104-01-SUMMARY.md
@.planning/phases/104-issue-mcp-tools/104-02-SUMMARY.md

<interfaces>
<!-- From Plans 01 and 02 -->
From src/execution/mcp/issue-label-server.ts:
```typescript
export function createIssueLabelServer(
  getOctokit: () => Promise<Octokit>,
  owner: string,
  repo: string,
  getTriageConfig: () => { enabled: boolean; label: { enabled: boolean } },
): McpServerConfig;
```

From src/execution/mcp/issue-comment-server.ts:
```typescript
export function createIssueCommentServer(
  getOctokit: () => Promise<Octokit>,
  owner: string,
  repo: string,
  getTriageConfig: () => { enabled: boolean; comment: { enabled: boolean } },
): McpServerConfig;
```

From src/execution/mcp/index.ts (current):
```typescript
export function buildMcpServers(deps: {
  getOctokit: () => Promise<Octokit>;
  owner: string;
  repo: string;
  prNumber?: number;
  commentId?: number;
  botHandles?: string[];
  // ...more deps
  enableInlineTools?: boolean;
  enableCommentTools?: boolean;
  // ...
}): Record<string, McpServerConfig>;
```

From src/execution/config.ts (current schema -- no triage section yet):
```typescript
const repoConfigSchema = z.object({
  model: z.string().default("claude-sonnet-4-5-20250929"),
  // ... existing sections ...
  review: reviewSchema,
  write: writeSchema,
  mention: mentionSchema,
  telemetry: telemetrySchema,
  knowledge: knowledgeSchema,
  // NO triage section yet
});
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add triage config schema to .kodiai.yml</name>
  <files>src/execution/config.ts, src/execution/config.test.ts</files>
  <action>
Add a `triage` section to the repo config schema in `config.ts`.

**Schema definition** (add before `repoConfigSchema`):
```typescript
const triageSchema = z
  .object({
    enabled: z.boolean().default(false),  // Default OFF -- opt-in only
    label: z
      .object({
        enabled: z.boolean().default(true),
      })
      .default({ enabled: true }),
    comment: z
      .object({
        enabled: z.boolean().default(true),
      })
      .default({ enabled: true }),
  })
  .default({
    enabled: false,
    label: { enabled: true },
    comment: { enabled: true },
  });
```

**Wire into repoConfigSchema:**
Add `triage: triageSchema` to the `repoConfigSchema` z.object definition.

**Section fallback parsing:**
Add triage section to the Pass 2 section fallback in `loadRepoConfig()`, following the exact same pattern as existing sections (review, write, mention, etc.):
```typescript
// triage
const triageResult = triageSchema.safeParse(obj.triage);
let triage: z.infer<typeof triageSchema>;
if (triageResult.success) {
  triage = triageResult.data;
} else {
  triage = triageSchema.parse({});
  warnings.push({
    section: "triage",
    issues: triageResult.error.issues.map(
      (i) => `${i.path.join(".")}: ${i.message}`,
    ),
  });
}
```

Add `triage` to the final config object construction.

**Test additions** (in config.test.ts):
- Defaults: missing triage section -> `{ enabled: false, label: { enabled: true }, comment: { enabled: true } }`
- Valid config: `triage: { enabled: true }` parses correctly
- Sub-tool override: `triage: { enabled: true, label: { enabled: false } }` disables label but keeps comment
- Invalid config: `triage: "bad"` falls back to defaults with warning

Example .kodiai.yml:
```yaml
triage:
  enabled: true
  label:
    enabled: true
  comment:
    enabled: true
```
  </action>
  <verify>
    <automated>bun test src/execution/config.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>Triage config section added to schema, section fallback parsing works, all config tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Wire issue MCP tools into buildMcpServers registry</name>
  <files>src/execution/mcp/index.ts, src/execution/mcp/index.test.ts</files>
  <action>
**Update `index.ts`:**

1. Add imports:
```typescript
import { createIssueLabelServer } from "./issue-label-server.ts";
import { createIssueCommentServer } from "./issue-comment-server.ts";
```

2. Add re-exports:
```typescript
export { createIssueLabelServer } from "./issue-label-server.ts";
export { createIssueCommentServer } from "./issue-comment-server.ts";
```

3. Add new deps to `buildMcpServers` function signature:
```typescript
enableIssueTools?: boolean;
triageConfig?: { enabled: boolean; label: { enabled: boolean }; comment: { enabled: boolean } };
```

4. Add server registration (after existing servers, before return):
```typescript
const enableIssueTools = deps.enableIssueTools ?? false;
if (enableIssueTools && deps.triageConfig) {
  const getTriageConfig = () => deps.triageConfig!;

  servers.github_issue_label = createIssueLabelServer(
    deps.getOctokit,
    deps.owner,
    deps.repo,
    () => ({ enabled: getTriageConfig().enabled, label: getTriageConfig().label }),
  );

  servers.github_issue_comment = createIssueCommentServer(
    deps.getOctokit,
    deps.owner,
    deps.repo,
    () => ({ enabled: getTriageConfig().enabled, comment: getTriageConfig().comment }),
  );
}
```

**Create `index.test.ts`:**

Integration tests verifying the wiring:
1. **Issue tools registered**: When `enableIssueTools: true` and triageConfig provided, both `github_issue_label` and `github_issue_comment` keys exist in returned servers.
2. **Issue tools not registered by default**: When `enableIssueTools` not provided, issue tool keys are absent.
3. **Existing tools unaffected**: Adding issue tools doesn't remove or alter existing server entries (github_comment, github_ci, etc.).
4. **AllowedMcpTools includes issue tools**: `buildAllowedMcpTools(["github_issue_label", "github_issue_comment"])` returns `["mcp__github_issue_label__*", "mcp__github_issue_comment__*"]`.

Use minimal mock deps (only what buildMcpServers requires).
  </action>
  <verify>
    <automated>bun test src/execution/mcp/index.test.ts 2>&1 | tail -5</automated>
  </verify>
  <done>Both issue MCP tools wired into registry, integration tests pass, existing tools unaffected</done>
</task>

</tasks>

<verification>
- `bun test src/execution/config.test.ts` -- config tests pass
- `bun test src/execution/mcp/index.test.ts` -- integration tests pass
- `bun test src/execution/mcp/` -- all MCP tests pass (including label and comment from Plans 01/02)
</verification>

<success_criteria>
- `triage` section in .kodiai.yml schema with `enabled`, `label.enabled`, `comment.enabled`
- Default triage.enabled = false (opt-in)
- Both MCP tools registered when enableIssueTools = true
- Existing MCP tools unaffected
- Config section fallback parsing handles invalid triage config gracefully
- Integration tests verify wiring
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/104-issue-mcp-tools/104-03-SUMMARY.md`
</output>
