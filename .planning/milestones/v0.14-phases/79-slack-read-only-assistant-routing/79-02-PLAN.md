---
phase: 79-slack-read-only-assistant-routing
plan: 02
type: execute
wave: 2
depends_on: [79-01]
files_modified:
  - src/config.ts
  - src/auth/github-app.ts
  - src/slack/client.ts
  - src/slack/client.test.ts
  - src/routes/slack-events.ts
  - src/routes/slack-events.test.ts
  - src/index.ts
autonomous: true
user_setup:
  - service: slack
    why: "Post assistant replies in Slack threads"
    env_vars:
      - name: SLACK_BOT_TOKEN
        source: "Slack App -> OAuth & Permissions -> Bot User OAuth Token"
    dashboard_config:
      - task: "Ensure bot token has chat:write scope for #kodiai thread replies"
        location: "Slack App -> OAuth & Permissions -> Bot Token Scopes"

must_haves:
  truths:
    - "Allowed Slack bootstrap and started-thread follow-up payloads are forwarded into assistant handling while ingress still acknowledges immediately"
    - "Assistant replies are posted to Slack thread targets only, never top-level channel posts"
    - "Slack assistant routing preserves read-only behavior and deterministic repo-context outcomes introduced in 79-01"
  artifacts:
    - path: "src/slack/client.ts"
      provides: "Thread-targeted Slack message publisher used by assistant routing"
      exports: ["createSlackClient"]
    - path: "src/routes/slack-events.ts"
      provides: "Ingress callback wiring from allowed Slack events into assistant handler"
      contains: "onAllowedBootstrap"
    - path: "src/index.ts"
      provides: "Application composition that binds Slack ingress, assistant handler, and publishing dependencies"
      contains: "createSlackAssistantHandler"
  key_links:
    - from: "src/routes/slack-events.ts"
      to: "src/slack/assistant-handler.ts"
      via: "Allowed event callback forwards normalized thread payload into assistant flow"
      pattern: "onAllowedBootstrap|createSlackAssistantHandler"
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/client.ts"
      via: "Resolved assistant response is published through thread-only Slack client"
      pattern: "post.*thread|thread_ts"
    - from: "src/index.ts"
      to: "src/auth/github-app.ts"
      via: "Runtime wiring resolves installation context for default/override repo workspace checkout"
      pattern: "installation|owner|repo"
---

<objective>
Wire Slack ingress and runtime dependencies into the Phase 79 assistant core so allowed Slack thread traffic reaches the read-only assistant end-to-end.

Purpose: This completes SLK-04 and SLK-05 by connecting route/index/runtime plumbing to the already-tested assistant core without regressing Phase 77/78 safety semantics.
Output: Slack client + runtime config wiring, repo installation lookup support, route/index integration, and regressions proving allowed forwarding and fail-open acknowledgments.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-slack-thread-session-semantics/78-01-SUMMARY.md
@.planning/phases/79-slack-read-only-assistant-routing/79-01-SUMMARY.md
@src/routes/slack-events.ts
@src/slack/safety-rails.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Slack publishing and repo-installation runtime adapters for assistant routing</name>
  <files>src/config.ts, src/auth/github-app.ts, src/slack/client.ts, src/slack/client.test.ts</files>
  <action>
Implement runtime adapters required by `createSlackAssistantHandler(...)` from Plan 79-01:

- Add `SLACK_BOT_TOKEN` fail-fast config parsing in `src/config.ts` (required, no fallback default).
- Extend GitHub app installation lookup helpers to resolve installation context for arbitrary `owner/repo` pairs used by Slack default/override repo selection.
- Implement `createSlackClient(...)` with the minimal thread-only publish surface (`channel`, `thread_ts`, `text`) and explicit guardrails against top-level posting.
- Add Slack client tests proving thread-targeted publish payload shape and rejection/guard behavior for missing thread targets.
  </action>
  <verify>
Run `bun test ./src/slack/client.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Runtime dependencies exist for Slack assistant execution: required token config, repo installation lookup by owner/repo, and thread-only Slack publishing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Slack events route and app index into assistant callback flow with regressions</name>
  <files>src/routes/slack-events.ts, src/routes/slack-events.test.ts, src/index.ts</files>
  <action>
Integrate assistant routing while preserving Phase 77/78 ingress guarantees:

- Instantiate assistant dependencies in `src/index.ts` (repo installation lookup, workspace creation, executor invocation, Slack thread publisher) and pass callback into `createSlackEventRoutes`.
- In `src/routes/slack-events.ts`, forward only allowed bootstrap/started-thread payloads to the assistant callback asynchronously; keep immediate `200 {ok:true}` acknowledgement semantics and fail-open logging on callback failure.
- Keep existing safety rails unchanged: verify-first ingress, channel/thread gating, and ignored-event no-op behavior.
- Extend route integration tests to prove allowed events invoke callback, ignored events do not invoke callback, and acknowledgements remain immediate even when callback rejects.
  </action>
  <verify>
Run `bun test ./src/routes/slack-events.test.ts --timeout 30000`.
Run `bun test ./src/slack/safety-rails.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Slack ingress is fully wired to assistant handling for allowed thread traffic with no regression to acknowledgment timing or safety-rail gating.
  </done>
</task>

</tasks>

<verification>
- Allowed Slack bootstrap and started-thread follow-up payloads are forwarded to assistant handling while ingress still returns immediate success acknowledgments.
- Slack publishing remains thread-only and cannot post top-level channel messages.
- End-to-end routing preserves read-only execution + deterministic repo-context behavior from Plan 79-01.
- `bun test ./src/slack/client.test.ts --timeout 30000`, `bun test ./src/routes/slack-events.test.ts --timeout 30000`, `bun test ./src/slack/safety-rails.test.ts --timeout 30000`, and `bunx tsc --noEmit` pass.
</verification>

<success_criteria>
SLK-04 and SLK-05 are fully satisfied end-to-end: allowed Slack thread events route into the read-only assistant path, deterministic repo-context behavior is preserved, and replies are thread-targeted only.
</success_criteria>

<output>
After completion, create `.planning/phases/79-slack-read-only-assistant-routing/79-02-SUMMARY.md`
</output>
