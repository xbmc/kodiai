---
phase: 79-slack-read-only-assistant-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/repo-context.ts
  - src/slack/repo-context.test.ts
  - src/slack/assistant-handler.ts
  - src/slack/assistant-handler.test.ts
autonomous: true

must_haves:
  truths:
    - "Slack assistant requests execute in read-only mode only (no write-mode edits, no branch/PR creation, no CI/build commands)"
    - "If a Slack message does not name a repo, assistant context defaults to xbmc/xbmc"
    - "If a Slack message names one explicit repo override, assistant replies acknowledge the override before answering"
    - "If repo context is ambiguous, assistant posts exactly one clarifying question in-thread and does not run execution"
  artifacts:
    - path: "src/slack/repo-context.ts"
      provides: "Deterministic Slack repo-context resolver with default, override, and ambiguity outcomes"
      exports: ["resolveSlackRepoContext"]
    - path: "src/slack/assistant-handler.ts"
      provides: "Slack read-only assistant execution flow and single-question ambiguity handling"
      exports: ["createSlackAssistantHandler"]
  key_links:
    - from: "src/slack/assistant-handler.ts"
      to: "src/slack/repo-context.ts"
      via: "Resolved repo decision determines default context, override ack, or ambiguity question"
      pattern: "resolveSlackRepoContext"
    - from: "src/slack/assistant-handler.ts"
      to: "src/execution/executor.ts"
      via: "Executor invocation remains read-only with writeMode=false and publish tools disabled"
      pattern: "writeMode:\s*false"
---

<objective>
Build the core Slack assistant domain logic: deterministic repo-context resolution and a read-only handler that executes only when context is unambiguous.

Purpose: This delivers the core SLK-04 and SLK-05 behavior before wiring so execution semantics are test-locked and reusable from route integration.
Output: Pure repo-context resolver + tests, assistant handler read-only execution flow + tests.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/78-slack-thread-session-semantics/78-01-SUMMARY.md
@src/slack/safety-rails.ts
@src/execution/executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deterministic Slack repo-context resolution for default, override, and ambiguity</name>
  <files>src/slack/repo-context.ts, src/slack/repo-context.test.ts</files>
  <action>
Create a pure repo-context resolver for Slack assistant requests:

- Parse addressed Slack text into normalized repo-context outcomes with an explicit default of `xbmc/xbmc` when no repo is named.
- Detect explicit overrides when exactly one unambiguous `owner/repo` appears and return acknowledgement text payload (for example, "Using repo context owner/repo.") that the assistant reply prepends before the answer.
- Treat multiple distinct repo references or malformed/incomplete repo references as ambiguity; return one deterministic clarifying question string and do not return an executable repo selection.
- Keep this module pure and dependency-free (no network calls, no Slack/GitHub I/O) so behavior is deterministic and unit-testable.
- Add a focused test matrix for default path, single override acknowledgement, and ambiguous inputs requiring exactly one clarifying question.
  </action>
  <verify>
Run `bun test ./src/slack/repo-context.test.ts --timeout 30000`.
  </verify>
  <done>
Slack text now deterministically resolves to one of: default `xbmc/xbmc`, explicit override with acknowledgement text, or ambiguity with exactly one clarifying question.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Slack read-only assistant handler core with ambiguity short-circuit</name>
  <files>src/slack/assistant-handler.ts, src/slack/assistant-handler.test.ts</files>
  <action>
Build the Slack assistant handler core that enforces SLK-04 and SLK-05:

- Implement `createSlackAssistantHandler(...)` as a dependency-injected core (publisher/workspace/executor seams passed in) that accepts normalized Slack payloads and performs: repo-context resolution, ambiguity early-return, workspace creation for resolved repo, prompt construction, and executor call.
- Enforce read-only execution explicitly: set `writeMode: false`, disable publish/comment tools, and include custom instructions that forbid edits, branch/PR operations, and CI/build command execution.
- Ensure override acknowledgements are prepended to assistant answer text only when non-default repo is resolved; default path must not add override text.
- For ambiguity outcomes, publish exactly one clarifying question and return without invoking workspace/executor.
- Add focused handler tests proving: read-only executor invocation contract, default `xbmc/xbmc` routing, explicit override acknowledgement, and ambiguity short-circuit without execution.
  </action>
  <verify>
Run `bun test ./src/slack/assistant-handler.test.ts --timeout 30000`.
  </verify>
  <done>
Slack assistant handler core deterministically handles default/override/ambiguity repo context and guarantees read-only execution semantics.
  </done>
</task>

</tasks>

<verification>
- Assistant execution path is read-only by construction (`writeMode=false`, no edit/PR/publish tool path).
- Repo context behavior is deterministic: default `xbmc/xbmc`, explicit single override acknowledgement, and exactly one in-thread clarifying question for ambiguous context.
- `bun test ./src/slack/repo-context.test.ts --timeout 30000` and `bun test ./src/slack/assistant-handler.test.ts --timeout 30000` pass.
</verification>

<success_criteria>
Core SLK-04/SLK-05 contracts are locked in tests: read-only execution semantics and deterministic repo-context behavior (default, explicit override acknowledgement, one-question ambiguity handling).
</success_criteria>

<output>
After completion, create `.planning/phases/79-slack-read-only-assistant-routing/79-01-SUMMARY.md`
</output>
