---
phase: 80-slack-operator-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/slack/v1-safety-contract.test.ts
  - scripts/phase80-slack-regression-gate.ts
  - scripts/phase80-slack-regression-gate.test.ts
autonomous: true

must_haves:
  truths:
    - "Regression checks fail when Slack v1 channel gating, mention bootstrap, thread-only targeting, or started-thread follow-up semantics drift"
    - "A single regression gate command runs Slack v1 contract tests and exits non-zero when any contract fails"
    - "Failure output identifies exactly which Slack v1 contract family regressed"
  artifacts:
    - path: "src/slack/v1-safety-contract.test.ts"
      provides: "Cross-module Slack v1 contract assertions locking allow/ignore rails and thread-only reply invariants"
      contains: "SLK80-REG"
    - path: "scripts/phase80-slack-regression-gate.ts"
      provides: "Deterministic regression gate runner with stable check families and blocking exit behavior"
      contains: "SLK80-REG"
    - path: "scripts/phase80-slack-regression-gate.test.ts"
      provides: "Unit coverage for regression gate pass/fail aggregation and command orchestration"
      contains: "phase80-slack-regression-gate"
  key_links:
    - from: "scripts/phase80-slack-regression-gate.ts"
      to: "src/slack/v1-safety-contract.test.ts"
      via: "Gate command includes the new contract suite and fails release checks on regressions"
      pattern: "v1-safety-contract.test.ts"
    - from: "src/slack/v1-safety-contract.test.ts"
      to: "src/slack/safety-rails.ts"
      via: "Contract assertions lock rail decisions and reason codes for bootstrap/follow-up/gating behavior"
      pattern: "evaluateSlackV1Rails"
    - from: "src/slack/v1-safety-contract.test.ts"
      to: "src/routes/slack-events.ts"
      via: "Route-level behavior remains aligned with rail decisions and thread-only payload shape"
      pattern: "replyTarget|threadTs|thread-only"
---

<objective>
Create a deterministic Slack v1 regression gate that blocks drift in the core safety contracts.

Purpose: SLK-06 requires regression safety, not just one-time validation; this plan makes contract drift immediately visible in CI and operator runs.
Output: A dedicated Slack v1 contract test suite plus a regression gate runner with machine-checkable pass/fail output.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/79-slack-read-only-assistant-routing/79-01-SUMMARY.md
@.planning/phases/79-slack-read-only-assistant-routing/79-02-SUMMARY.md
@src/slack/safety-rails.ts
@src/routes/slack-events.ts
@src/slack/safety-rails.test.ts
@src/routes/slack-events.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Slack v1 safety contract regression suite with explicit drift signals</name>
  <files>src/slack/v1-safety-contract.test.ts</files>
  <action>
Create a dedicated regression test suite that locks Slack v1 behavior across the must-not-drift contracts:

- Add `src/slack/v1-safety-contract.test.ts` with deterministic fixture-driven assertions for: channel gating (`outside_kodiai_channel`), mention bootstrap allow, thread follow-up deny before session start, and thread follow-up allow after session start.
- Assert that every allowed decision carries `replyTarget: "thread-only"` and valid `threadTs/messageTs` mapping so top-level reply drift fails tests.
- Include check-family labels in test names (for example `SLK80-REG-RAILS-*`) so failures are easy to map in operator and CI output.
- Reuse existing Slack rail helpers and avoid introducing flaky wall-clock or network behavior.
  </action>
  <verify>
Run `bun test ./src/slack/v1-safety-contract.test.ts --timeout 30000`.
  </verify>
  <done>
Slack v1 contract tests fail immediately if channel gating, bootstrap/follow-up semantics, or thread-only targeting behavior drifts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build deterministic regression gate runner for Slack v1 contract suites</name>
  <files>scripts/phase80-slack-regression-gate.ts, scripts/phase80-slack-regression-gate.test.ts</files>
  <action>
Add an operator- and CI-friendly regression gate command around Slack v1 contract suites:

- Implement `scripts/phase80-slack-regression-gate.ts` to run the pinned Slack suites (`v1-safety-contract`, `safety-rails`, route regression) via child-process test invocations and aggregate results into stable `SLK80-REG-*` check IDs.
- Emit a final PASS/FAIL verdict and exit non-zero on any failure; include failing check IDs in verdict output.
- Add unit tests for gate behavior (all pass, one failure, subprocess error path) in `scripts/phase80-slack-regression-gate.test.ts`.
- Keep the runner local and deterministic: no Slack API calls, no GitHub API calls, no dependency on live runtime state.
  </action>
  <verify>
Run `bun test ./scripts/phase80-slack-regression-gate.test.ts --timeout 30000`.
Run `bun scripts/phase80-slack-regression-gate.ts --help`.
  </verify>
  <done>
A single deterministic regression gate command now blocks Slack v1 drift and reports actionable check IDs when failures occur.
  </done>
</task>

</tasks>

<verification>
- `bun test ./src/slack/v1-safety-contract.test.ts --timeout 30000` passes.
- `bun test ./scripts/phase80-slack-regression-gate.test.ts --timeout 30000` passes.
- `bun scripts/phase80-slack-regression-gate.ts` exits non-zero when any pinned suite fails and includes failed `SLK80-REG-*` IDs.
</verification>

<success_criteria>
Slack v1 regression behavior is protected by deterministic tests and a single gate runner that fails loudly when channel/thread/bootstrap/session contracts drift.
</success_criteria>

<output>
After completion, create `.planning/phases/80-slack-operator-hardening/80-02-SUMMARY.md`
</output>
