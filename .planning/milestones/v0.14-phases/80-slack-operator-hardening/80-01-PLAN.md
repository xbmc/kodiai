---
phase: 80-slack-operator-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/phase80-slack-smoke.ts
  - scripts/phase80-slack-smoke.test.ts
  - docs/smoke/phase80-slack-operator-hardening.md
autonomous: true

must_haves:
  truths:
    - "Operators can run one deterministic smoke command that proves Slack channel gating, mention bootstrap, and started-thread follow-up behavior"
    - "Smoke output is machine-checkable and fails fast when Slack v1 rails do not match expected allow/ignore decisions"
    - "Smoke evidence explicitly confirms every allowed payload resolves to thread-only reply targeting"
  artifacts:
    - path: "scripts/phase80-slack-smoke.ts"
      provides: "Deterministic Slack v1 smoke verifier with explicit check IDs and non-zero exit on failure"
      contains: "SLK80-SMOKE"
    - path: "scripts/phase80-slack-smoke.test.ts"
      provides: "Regression coverage for smoke verifier parsing, check evaluation, and pass/fail behavior"
      contains: "phase80-slack-smoke"
    - path: "docs/smoke/phase80-slack-operator-hardening.md"
      provides: "Operator procedure to run smoke checks and interpret failures"
      contains: "SLK80-SMOKE"
  key_links:
    - from: "scripts/phase80-slack-smoke.ts"
      to: "src/slack/safety-rails.ts"
      via: "Smoke scenario evaluates fixed Slack payload matrix through evaluateSlackV1Rails"
      pattern: "evaluateSlackV1Rails"
    - from: "scripts/phase80-slack-smoke.ts"
      to: "src/slack/thread-session-store.ts"
      via: "Started-thread session state is marked before follow-up verification"
      pattern: "createSlackThreadSessionStore|markThreadStarted"
    - from: "docs/smoke/phase80-slack-operator-hardening.md"
      to: "scripts/phase80-slack-smoke.ts"
      via: "Documented command and expected check IDs match verifier output"
      pattern: "phase80-slack-smoke|SLK80-SMOKE"
---

<objective>
Ship a deterministic Slack v1 smoke verifier that operators can run to prove the core safety behavior in one repeatable command.

Purpose: SLK-06 requires an operator-safe proof for channel gating, thread-only semantics, mention bootstrap, and follow-up handling before release decisions.
Output: A phase-specific smoke verifier CLI with tests plus an operator smoke procedure document.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/79-slack-read-only-assistant-routing/79-02-SUMMARY.md
@src/slack/safety-rails.ts
@src/slack/safety-rails.test.ts
@src/slack/thread-session-store.ts
@docs/smoke/phase74-reliability-regression-gate.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build deterministic Slack v1 smoke verifier CLI with fixed scenario matrix</name>
  <files>scripts/phase80-slack-smoke.ts, scripts/phase80-slack-smoke.test.ts</files>
  <action>
Create a dedicated Phase 80 smoke verifier script that executes a fixed in-memory Slack event matrix and emits machine-checkable check IDs:

- Implement `scripts/phase80-slack-smoke.ts` as a pure deterministic verifier using canonical fixtures for: outside-channel gating, top-level mention bootstrap allow, in-thread follow-up ignore before session start, and follow-up allow after session start.
- Evaluate fixtures through `evaluateSlackV1Rails(...)` and explicit thread-session transitions via `createSlackThreadSessionStore()` so follow-up behavior is proven, not inferred.
- Emit stable check IDs (for example `SLK80-SMOKE-01..04`) with `PASS|FAIL` lines and a final verdict line; exit non-zero when any check fails.
- Ensure allowed cases assert `replyTarget === "thread-only"` so top-level response drift is detected.
- Add focused tests for parser/check evaluation and CLI exit behavior; avoid live Slack API calls and avoid introducing network dependencies.
  </action>
  <verify>
Run `bun test ./scripts/phase80-slack-smoke.test.ts --timeout 30000`.
Run `bun scripts/phase80-slack-smoke.ts --help`.
  </verify>
  <done>
Operators can execute one deterministic smoke verifier that returns pass/fail check IDs for channel gating, bootstrap allow, and follow-up session behavior with thread-only targeting assertions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Publish Phase 80 smoke procedure with check-ID based interpretation</name>
  <files>docs/smoke/phase80-slack-operator-hardening.md</files>
  <action>
Document the Phase 80 smoke workflow in the existing smoke docs area:

- Add `docs/smoke/phase80-slack-operator-hardening.md` with prerequisites, command examples, expected output, and failure interpretation keyed to `SLK80-SMOKE-*` checks.
- Include a release-blocking interpretation section that clearly states non-zero exit or any failed check ID blocks rollout.
- Cross-reference relevant incident triage runbook location for follow-up debugging.
- Keep scope strictly to deterministic operator smoke verification for Slack v1 behavior (no new feature work, no architecture changes).
  </action>
  <verify>
Run `bun scripts/phase80-slack-smoke.ts` and confirm documented check IDs appear.
Manually read `docs/smoke/phase80-slack-operator-hardening.md` to confirm command and failure mapping are explicit.
  </verify>
  <done>
Smoke documentation gives operators a deterministic, repeatable verification path with unambiguous pass/fail interpretation for Slack v1 safety behavior.
  </done>
</task>

</tasks>

<verification>
- `bun test ./scripts/phase80-slack-smoke.test.ts --timeout 30000` passes.
- `bun scripts/phase80-slack-smoke.ts` exits 0 with all `SLK80-SMOKE-*` checks passing on baseline fixtures.
- `docs/smoke/phase80-slack-operator-hardening.md` accurately maps each check ID to expected Slack v1 behavior and release-blocking interpretation.
</verification>

<success_criteria>
Operators have a deterministic smoke scenario proving Slack v1 channel gating, thread-only reply targeting, mention bootstrap, and follow-up session behavior with machine-checkable pass/fail output.
</success_criteria>

<output>
After completion, create `.planning/phases/80-slack-operator-hardening/80-01-SUMMARY.md`
</output>
