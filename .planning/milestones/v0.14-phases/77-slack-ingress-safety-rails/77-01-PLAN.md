---
phase: 77-slack-ingress-safety-rails
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.ts
  - src/slack/verify.ts
  - src/slack/verify.test.ts
  - src/routes/slack-events.ts
  - src/routes/slack-events.test.ts
  - src/index.ts
autonomous: true
user_setup:
  - service: slack
    why: "Validate inbound Slack requests and subscribe app events"
    env_vars:
      - name: SLACK_SIGNING_SECRET
        source: "Slack App Settings -> Basic Information -> Signing Secret"
      - name: SLACK_BOT_USER_ID
        source: "Slack App Home -> App ID / Bot User ID"
      - name: SLACK_KODIAI_CHANNEL_ID
        source: "Slack -> #kodiai channel details -> Channel ID"
    dashboard_config:
      - task: "Enable Events API and point Request URL to /webhooks/slack/events"
        location: "Slack App Settings -> Event Subscriptions"

must_haves:
  truths:
    - "Slack events are rejected with 401 unless signature and timestamp validation passes"
    - "Slack URL verification challenge returns only after request authenticity checks"
    - "Valid Slack event callback requests are acknowledged quickly without blocking webhook response"
  artifacts:
    - path: "src/slack/verify.ts"
      provides: "Slack v0 signature + replay-window verifier with timing-safe compare"
      contains: "v0:"
    - path: "src/routes/slack-events.ts"
      provides: "POST /webhooks/slack/events ingress route that verifies before processing"
      contains: "/events"
    - path: "src/config.ts"
      provides: "Fail-fast Slack env var parsing for signing secret and channel/bot identity"
      contains: "SLACK_SIGNING_SECRET"
  key_links:
    - from: "src/routes/slack-events.ts"
      to: "src/slack/verify.ts"
      via: "Route reads raw body and validates timestamp/signature before JSON.parse"
      pattern: "await c\.req\.text\(\).*verify"
    - from: "src/index.ts"
      to: "src/routes/slack-events.ts"
      via: "Server mounts Slack ingress endpoint under /webhooks/slack"
      pattern: "app\.route\(\"/webhooks/slack\""
    - from: "src/routes/slack-events.test.ts"
      to: "src/routes/slack-events.ts"
      via: "Regression tests prove invalid signatures/timestamps never reach event handling"
      pattern: "401|signature|timestamp"
---

<objective>
Add a secure Slack ingress endpoint that validates request signatures and timestamps before any event processing.

Purpose: SLK-01 is the hard security gate for Slack v1; without verified ingress, later thread and assistant behavior can be spoofed.
Output: Slack config/env support, signature verification module, mounted events route, and regression tests proving fail-closed behavior.
</objective>

<execution_context>
@/home/keith/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/keith/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/config.ts
@src/index.ts
@src/routes/webhooks.ts
@src/webhook/verify.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend runtime config for Slack ingress secrets and identities</name>
  <files>src/config.ts</files>
  <action>
Add Slack v1 ingress config to the fail-fast startup schema:

- Extend `AppConfig` parsing to include `SLACK_SIGNING_SECRET`, `SLACK_BOT_USER_ID`, and `SLACK_KODIAI_CHANNEL_ID` with non-empty validation.
- Keep existing GitHub config behavior unchanged; Slack fields are additive and explicitly validated at startup so misconfiguration fails before serving requests.
- Do not add optional fallback defaults for signing secret; this must fail closed.
  </action>
  <verify>
Run `bunx tsc --noEmit`.
Run `bun test ./src/routes/slack-events.test.ts --timeout 30000` after route tests are added.
  </verify>
  <done>
Server startup config includes required Slack ingress env fields and rejects invalid/missing values deterministically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Slack signature/timestamp verification primitive with replay-window checks</name>
  <files>src/slack/verify.ts, src/slack/verify.test.ts</files>
  <action>
Create a Slack verifier module and focused unit tests:

- Implement Slack signing verification using `v0:{timestamp}:{rawBody}` HMAC SHA256 with `SLACK_SIGNING_SECRET` and timing-safe comparison to `X-Slack-Signature`.
- Reject requests when headers are missing/malformed or timestamp skew exceeds 5 minutes (replay protection).
- Return structured verification outcome (`valid` + reason) so route logic can log actionable skip reasons without leaking secrets.
- Add deterministic tests for valid signature, invalid signature, missing headers, stale timestamp, and future timestamp beyond tolerance.
  </action>
  <verify>
Run `bun test ./src/slack/verify.test.ts --timeout 30000`.
  </verify>
  <done>
Slack verifier enforces signature and timestamp checks fail-closed, with test coverage for all core acceptance/rejection paths.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add `/webhooks/slack/events` route with verify-first request handling</name>
  <files>src/routes/slack-events.ts, src/routes/slack-events.test.ts, src/index.ts</files>
  <action>
Add Slack events ingress route wired into the Hono app:

- Create `POST /events` route under a new Slack route module and mount it as `/webhooks/slack/events` in `src/index.ts`.
- Read raw body first, run Slack verifier before any payload parsing, and return `401` for failed verification.
- Handle `url_verification` payloads by returning the `challenge` only after verification succeeds.
- For valid `event_callback` payloads, acknowledge immediately (`200`) and fire-and-fork downstream processing hook/log point; do not post any Slack reply in this plan.
- Keep no-unsolicited-response policy intact by ensuring this route only performs acceptance/ack now.
  </action>
  <verify>
Run `bun test ./src/routes/slack-events.test.ts --timeout 30000`.
Run `bunx tsc --noEmit`.
  </verify>
  <done>
Slack endpoint is mounted and secure: only authenticated requests are accepted, URL verification works, and valid callbacks are acknowledged without inline processing.
  </done>
</task>

</tasks>

<verification>
- Invalid/missing Slack signature or out-of-window timestamp returns `401` before payload parse/processing.
- `url_verification` challenge responses are emitted only for verified requests.
- `src/index.ts` mounts Slack route at `/webhooks/slack/events`.
- `bun test ./src/slack/verify.test.ts --timeout 30000`, `bun test ./src/routes/slack-events.test.ts --timeout 30000`, and `bunx tsc --noEmit` pass.
</verification>

<success_criteria>
SLK-01 is satisfied: Slack ingress is fail-closed and verified before processing, with deterministic tests proving signature and timestamp enforcement.
</success_criteria>

<output>
After completion, create `.planning/phases/77-slack-ingress-safety-rails/77-01-SUMMARY.md`
</output>
